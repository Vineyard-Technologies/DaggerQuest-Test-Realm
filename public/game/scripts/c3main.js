// Generated by Construct, the game and animation creation tool
// Visit: https://www.construct.net

var __create=Object.create,__defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__getProtoOf=Object.getPrototypeOf,__hasOwnProp=Object.prototype.hasOwnProperty,__require=(e=>"undefined"!=typeof require?require:"undefined"!=typeof Proxy?new Proxy(e,{get:(e,t)=>("undefined"!=typeof require?require:e)[t]}):e)(function(e){if("undefined"!=typeof require)return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')}),__commonJS=(e,t)=>function(){return t||(0,e[__getOwnPropNames(e)[0]])((t={exports:{}}).exports,t),t.exports},__copyProps=(e,t,s,i)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let r of __getOwnPropNames(t))__hasOwnProp.call(e,r)||r===s||__defProp(e,r,{get:()=>t[r],enumerable:!(i=__getOwnPropDesc(t,r))||i.enumerable});return e},__toESM=(e,t,s)=>(s=null!=e?__create(__getProtoOf(e)):{},__copyProps(!t&&e&&e.__esModule?s:__defProp(s,"default",{value:e,enumerable:!0}),e)),require_c3runtime=__commonJS({"file-map:scripts/c3runtime.js"(exports,module){{let e=function(e){ARRAY_TYPE=e},t=function(e){return e*degree},n=function(e,t){return Math.abs(e-t)<=EPSILON*Math.max(1,Math.abs(e),Math.abs(t))},h=function(){var e=new ARRAY_TYPE(4);return ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0),e[0]=1,e[3]=1,e},u=function(e){var t=new ARRAY_TYPE(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},p=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},_=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},m=function(e,t,s,i){var r=new ARRAY_TYPE(4);return r[0]=e,r[1]=t,r[2]=s,r[3]=i,r},g=function(e,t,s,i,r){return e[0]=t,e[1]=s,e[2]=i,e[3]=r,e},y=function(e,t){if(e===t){var s=t[1];e[1]=t[2],e[2]=s}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e},S=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=s*n-r*i;return a?(a=1/a,e[0]=n*a,e[1]=-i*a,e[2]=-r*a,e[3]=s*a,e):null},T=function(e,t){var s=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=s,e},x=function(e){return e[0]*e[3]-e[2]*e[1]},b=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=s[0],l=s[1],h=s[2],u=s[3];return e[0]=i*o+n*l,e[1]=r*o+a*l,e[2]=i*h+n*u,e[3]=r*h+a*u,e},G=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=Math.sin(s),l=Math.cos(s);return e[0]=i*l+n*o,e[1]=r*l+a*o,e[2]=i*-o+n*l,e[3]=r*-o+a*l,e},I=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=s[0],l=s[1];return e[0]=i*o,e[1]=r*o,e[2]=n*l,e[3]=a*l,e},v=function(e,t){var s=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=s,e[2]=-s,e[3]=i,e},C=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e},w=function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},A=function(e){return Math.hypot(e[0],e[1],e[2],e[3])},R=function(e,t,s,i){return e[2]=i[2]/i[0],s[0]=i[0],s[1]=i[1],s[3]=i[3]-e[2]*s[1],[e,t,s]},P=function(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e[2]=t[2]+s[2],e[3]=t[3]+s[3],e},M=function(e,t,s){return e[0]=t[0]-s[0],e[1]=t[1]-s[1],e[2]=t[2]-s[2],e[3]=t[3]-s[3],e},E=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},D=function(e,t){var s=e[0],i=e[1],r=e[2],n=e[3],a=t[0],o=t[1],l=t[2],h=t[3];return Math.abs(s-a)<=EPSILON*Math.max(1,Math.abs(s),Math.abs(a))&&Math.abs(i-o)<=EPSILON*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(r-l)<=EPSILON*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(n-h)<=EPSILON*Math.max(1,Math.abs(n),Math.abs(h))},N=function(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e[3]=t[3]*s,e},F=function(e,t,s,i){return e[0]=t[0]+s[0]*i,e[1]=t[1]+s[1]*i,e[2]=t[2]+s[2]*i,e[3]=t[3]+s[3]*i,e},O=function(){var e=new ARRAY_TYPE(6);return ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[4]=0,e[5]=0),e[0]=1,e[3]=1,e},B=function(e){var t=new ARRAY_TYPE(6);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},L=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},k=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},V=function(e,t,s,i,r,n){var a=new ARRAY_TYPE(6);return a[0]=e,a[1]=t,a[2]=s,a[3]=i,a[4]=r,a[5]=n,a},U=function(e,t,s,i,r,n,a){return e[0]=t,e[1]=s,e[2]=i,e[3]=r,e[4]=n,e[5]=a,e},W=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=t[4],o=t[5],l=s*n-i*r;return l?(l=1/l,e[0]=n*l,e[1]=-i*l,e[2]=-r*l,e[3]=s*l,e[4]=(r*o-n*a)*l,e[5]=(i*a-s*o)*l,e):null},H=function(e){return e[0]*e[3]-e[1]*e[2]},z=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],l=t[5],h=s[0],u=s[1],c=s[2],d=s[3],p=s[4],_=s[5];return e[0]=i*h+n*u,e[1]=r*h+a*u,e[2]=i*c+n*d,e[3]=r*c+a*d,e[4]=i*p+n*_+o,e[5]=r*p+a*_+l,e},j=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],l=t[5],h=Math.sin(s),u=Math.cos(s);return e[0]=i*u+n*h,e[1]=r*u+a*h,e[2]=i*-h+n*u,e[3]=r*-h+a*u,e[4]=o,e[5]=l,e},Y=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],l=t[5],h=s[0],u=s[1];return e[0]=i*h,e[1]=r*h,e[2]=n*u,e[3]=a*u,e[4]=o,e[5]=l,e},q=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],l=t[5],h=s[0],u=s[1];return e[0]=i,e[1]=r,e[2]=n,e[3]=a,e[4]=i*h+n*u+o,e[5]=r*h+a*u+l,e},X=function(e,t){var s=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=s,e[2]=-s,e[3]=i,e[4]=0,e[5]=0,e},$=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e[4]=0,e[5]=0,e},K=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=t[0],e[5]=t[1],e},J=function(e){return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"},Q=function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],1)},Z=function(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e[2]=t[2]+s[2],e[3]=t[3]+s[3],e[4]=t[4]+s[4],e[5]=t[5]+s[5],e},ee=function(e,t,s){return e[0]=t[0]-s[0],e[1]=t[1]-s[1],e[2]=t[2]-s[2],e[3]=t[3]-s[3],e[4]=t[4]-s[4],e[5]=t[5]-s[5],e},te=function(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e[3]=t[3]*s,e[4]=t[4]*s,e[5]=t[5]*s,e},se=function(e,t,s,i){return e[0]=t[0]+s[0]*i,e[1]=t[1]+s[1]*i,e[2]=t[2]+s[2]*i,e[3]=t[3]+s[3]*i,e[4]=t[4]+s[4]*i,e[5]=t[5]+s[5]*i,e},ie=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]},re=function(e,t){var s=e[0],i=e[1],r=e[2],n=e[3],a=e[4],o=e[5],l=t[0],h=t[1],u=t[2],c=t[3],d=t[4],p=t[5];return Math.abs(s-l)<=EPSILON*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(i-h)<=EPSILON*Math.max(1,Math.abs(i),Math.abs(h))&&Math.abs(r-u)<=EPSILON*Math.max(1,Math.abs(r),Math.abs(u))&&Math.abs(n-c)<=EPSILON*Math.max(1,Math.abs(n),Math.abs(c))&&Math.abs(a-d)<=EPSILON*Math.max(1,Math.abs(a),Math.abs(d))&&Math.abs(o-p)<=EPSILON*Math.max(1,Math.abs(o),Math.abs(p))},ne=function(){var e=new ARRAY_TYPE(9);return ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e},ae=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},oe=function(e){var t=new ARRAY_TYPE(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},le=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},he=function(e,t,s,i,r,n,a,o,l){var h=new ARRAY_TYPE(9);return h[0]=e,h[1]=t,h[2]=s,h[3]=i,h[4]=r,h[5]=n,h[6]=a,h[7]=o,h[8]=l,h},ue=function(e,t,s,i,r,n,a,o,l,h){return e[0]=t,e[1]=s,e[2]=i,e[3]=r,e[4]=n,e[5]=a,e[6]=o,e[7]=l,e[8]=h,e},ce=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},de=function(e,t){if(e===t){var s=t[1],i=t[2],r=t[5];e[1]=t[3],e[2]=t[6],e[3]=s,e[5]=t[7],e[6]=i,e[7]=r}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e},pe=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=t[4],o=t[5],l=t[6],h=t[7],u=t[8],c=u*a-o*h,d=-u*n+o*l,p=h*n-a*l,_=s*c+i*d+r*p;return _?(_=1/_,e[0]=c*_,e[1]=(-u*i+r*h)*_,e[2]=(o*i-r*a)*_,e[3]=d*_,e[4]=(u*s-r*l)*_,e[5]=(-o*s+r*n)*_,e[6]=p*_,e[7]=(-h*s+i*l)*_,e[8]=(a*s-i*n)*_,e):null},_e=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=t[4],o=t[5],l=t[6],h=t[7],u=t[8];return e[0]=a*u-o*h,e[1]=r*h-i*u,e[2]=i*o-r*a,e[3]=o*l-n*u,e[4]=s*u-r*l,e[5]=r*n-s*o,e[6]=n*h-a*l,e[7]=i*l-s*h,e[8]=s*a-i*n,e},me=function(e){var t=e[0],s=e[1],i=e[2],r=e[3],n=e[4],a=e[5],o=e[6],l=e[7],h=e[8];return t*(h*n-a*l)+s*(-h*r+a*o)+i*(l*r-n*o)},fe=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],l=t[5],h=t[6],u=t[7],c=t[8],d=s[0],p=s[1],_=s[2],m=s[3],f=s[4],g=s[5],y=s[6],S=s[7],T=s[8];return e[0]=d*i+p*a+_*h,e[1]=d*r+p*o+_*u,e[2]=d*n+p*l+_*c,e[3]=m*i+f*a+g*h,e[4]=m*r+f*o+g*u,e[5]=m*n+f*l+g*c,e[6]=y*i+S*a+T*h,e[7]=y*r+S*o+T*u,e[8]=y*n+S*l+T*c,e},ge=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],l=t[5],h=t[6],u=t[7],c=t[8],d=s[0],p=s[1];return e[0]=i,e[1]=r,e[2]=n,e[3]=a,e[4]=o,e[5]=l,e[6]=d*i+p*a+h,e[7]=d*r+p*o+u,e[8]=d*n+p*l+c,e},ye=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],l=t[5],h=t[6],u=t[7],c=t[8],d=Math.sin(s),p=Math.cos(s);return e[0]=p*i+d*a,e[1]=p*r+d*o,e[2]=p*n+d*l,e[3]=p*a-d*i,e[4]=p*o-d*r,e[5]=p*l-d*n,e[6]=h,e[7]=u,e[8]=c,e},Se=function(e,t,s){var i=s[0],r=s[1];return e[0]=i*t[0],e[1]=i*t[1],e[2]=i*t[2],e[3]=r*t[3],e[4]=r*t[4],e[5]=r*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},Te=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=t[0],e[7]=t[1],e[8]=1,e},xe=function(e,t){var s=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=s,e[2]=0,e[3]=-s,e[4]=i,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},be=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=t[1],e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},Ge=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e},Ie=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=s+s,o=i+i,l=r+r,h=s*a,u=i*a,c=i*o,d=r*a,p=r*o,_=r*l,m=n*a,f=n*o,g=n*l;return e[0]=1-c-_,e[3]=u-g,e[6]=d+f,e[1]=u+g,e[4]=1-h-_,e[7]=p-m,e[2]=d-f,e[5]=p+m,e[8]=1-h-c,e},ve=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=t[4],o=t[5],l=t[6],h=t[7],u=t[8],c=t[9],d=t[10],p=t[11],_=t[12],m=t[13],f=t[14],g=t[15],y=s*o-i*a,S=s*l-r*a,T=s*h-n*a,x=i*l-r*o,b=i*h-n*o,G=r*h-n*l,I=u*m-c*_,v=u*f-d*_,C=u*g-p*_,w=c*f-d*m,A=c*g-p*m,R=d*g-p*f,P=y*R-S*A+T*w+x*C-b*v+G*I;return P?(P=1/P,e[0]=(o*R-l*A+h*w)*P,e[1]=(l*C-a*R-h*v)*P,e[2]=(a*A-o*C+h*I)*P,e[3]=(r*A-i*R-n*w)*P,e[4]=(s*R-r*C+n*v)*P,e[5]=(i*C-s*A-n*I)*P,e[6]=(m*G-f*b+g*x)*P,e[7]=(f*T-_*G-g*S)*P,e[8]=(_*b-m*T+g*y)*P,e):null},Ce=function(e,t,s){return e[0]=2/t,e[1]=0,e[2]=0,e[3]=0,e[4]=-2/s,e[5]=0,e[6]=-1,e[7]=1,e[8]=1,e},we=function(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"},Ae=function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])},Re=function(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e[2]=t[2]+s[2],e[3]=t[3]+s[3],e[4]=t[4]+s[4],e[5]=t[5]+s[5],e[6]=t[6]+s[6],e[7]=t[7]+s[7],e[8]=t[8]+s[8],e},Pe=function(e,t,s){return e[0]=t[0]-s[0],e[1]=t[1]-s[1],e[2]=t[2]-s[2],e[3]=t[3]-s[3],e[4]=t[4]-s[4],e[5]=t[5]-s[5],e[6]=t[6]-s[6],e[7]=t[7]-s[7],e[8]=t[8]-s[8],e},Me=function(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e[3]=t[3]*s,e[4]=t[4]*s,e[5]=t[5]*s,e[6]=t[6]*s,e[7]=t[7]*s,e[8]=t[8]*s,e},Ee=function(e,t,s,i){return e[0]=t[0]+s[0]*i,e[1]=t[1]+s[1]*i,e[2]=t[2]+s[2]*i,e[3]=t[3]+s[3]*i,e[4]=t[4]+s[4]*i,e[5]=t[5]+s[5]*i,e[6]=t[6]+s[6]*i,e[7]=t[7]+s[7]*i,e[8]=t[8]+s[8]*i,e},De=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]},Ne=function(e,t){var s=e[0],i=e[1],r=e[2],n=e[3],a=e[4],o=e[5],l=e[6],h=e[7],u=e[8],c=t[0],d=t[1],p=t[2],_=t[3],m=t[4],f=t[5],g=t[6],y=t[7],S=t[8];return Math.abs(s-c)<=EPSILON*Math.max(1,Math.abs(s),Math.abs(c))&&Math.abs(i-d)<=EPSILON*Math.max(1,Math.abs(i),Math.abs(d))&&Math.abs(r-p)<=EPSILON*Math.max(1,Math.abs(r),Math.abs(p))&&Math.abs(n-_)<=EPSILON*Math.max(1,Math.abs(n),Math.abs(_))&&Math.abs(a-m)<=EPSILON*Math.max(1,Math.abs(a),Math.abs(m))&&Math.abs(o-f)<=EPSILON*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(l-g)<=EPSILON*Math.max(1,Math.abs(l),Math.abs(g))&&Math.abs(h-y)<=EPSILON*Math.max(1,Math.abs(h),Math.abs(y))&&Math.abs(u-S)<=EPSILON*Math.max(1,Math.abs(u),Math.abs(S))},Fe=function(){var e=new ARRAY_TYPE(16);return ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e},Oe=function(e){var t=new ARRAY_TYPE(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},Be=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},Le=function(e,t,s,i,r,n,a,o,l,h,u,c,d,p,_,m){var f=new ARRAY_TYPE(16);return f[0]=e,f[1]=t,f[2]=s,f[3]=i,f[4]=r,f[5]=n,f[6]=a,f[7]=o,f[8]=l,f[9]=h,f[10]=u,f[11]=c,f[12]=d,f[13]=p,f[14]=_,f[15]=m,f},ke=function(e,t,s,i,r,n,a,o,l,h,u,c,d,p,_,m,f){return e[0]=t,e[1]=s,e[2]=i,e[3]=r,e[4]=n,e[5]=a,e[6]=o,e[7]=l,e[8]=h,e[9]=u,e[10]=c,e[11]=d,e[12]=p,e[13]=_,e[14]=m,e[15]=f,e},Ve=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},Ue=function(e,t){if(e===t){var s=t[1],i=t[2],r=t[3],n=t[6],a=t[7],o=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=s,e[6]=t[9],e[7]=t[13],e[8]=i,e[9]=n,e[11]=t[14],e[12]=r,e[13]=a,e[14]=o}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e},We=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=t[4],o=t[5],l=t[6],h=t[7],u=t[8],c=t[9],d=t[10],p=t[11],_=t[12],m=t[13],f=t[14],g=t[15],y=s*o-i*a,S=s*l-r*a,T=s*h-n*a,x=i*l-r*o,b=i*h-n*o,G=r*h-n*l,I=u*m-c*_,v=u*f-d*_,C=u*g-p*_,w=c*f-d*m,A=c*g-p*m,R=d*g-p*f,P=y*R-S*A+T*w+x*C-b*v+G*I;return P?(P=1/P,e[0]=(o*R-l*A+h*w)*P,e[1]=(r*A-i*R-n*w)*P,e[2]=(m*G-f*b+g*x)*P,e[3]=(d*b-c*G-p*x)*P,e[4]=(l*C-a*R-h*v)*P,e[5]=(s*R-r*C+n*v)*P,e[6]=(f*T-_*G-g*S)*P,e[7]=(u*G-d*T+p*S)*P,e[8]=(a*A-o*C+h*I)*P,e[9]=(i*C-s*A-n*I)*P,e[10]=(_*b-m*T+g*y)*P,e[11]=(c*T-u*b-p*y)*P,e[12]=(o*v-a*w-l*I)*P,e[13]=(s*w-i*v+r*I)*P,e[14]=(m*S-_*x-f*y)*P,e[15]=(u*x-c*S+d*y)*P,e):null},He=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=t[4],o=t[5],l=t[6],h=t[7],u=t[8],c=t[9],d=t[10],p=t[11],_=t[12],m=t[13],f=t[14],g=t[15],y=s*o-i*a,S=s*l-r*a,T=s*h-n*a,x=i*l-r*o,b=i*h-n*o,G=r*h-n*l,I=u*m-c*_,v=u*f-d*_,C=u*g-p*_,w=c*f-d*m,A=c*g-p*m,R=d*g-p*f;return e[0]=o*R-l*A+h*w,e[1]=r*A-i*R-n*w,e[2]=m*G-f*b+g*x,e[3]=d*b-c*G-p*x,e[4]=l*C-a*R-h*v,e[5]=s*R-r*C+n*v,e[6]=f*T-_*G-g*S,e[7]=u*G-d*T+p*S,e[8]=a*A-o*C+h*I,e[9]=i*C-s*A-n*I,e[10]=_*b-m*T+g*y,e[11]=c*T-u*b-p*y,e[12]=o*v-a*w-l*I,e[13]=s*w-i*v+r*I,e[14]=m*S-_*x-f*y,e[15]=u*x-c*S+d*y,e},ze=function(e){var t=e[0],s=e[1],i=e[2],r=e[3],n=e[4],a=e[5],o=e[6],l=e[7],h=e[8],u=e[9],c=e[10],d=e[11],p=e[12],_=e[13],m=e[14],f=t*a-s*n,g=t*o-i*n,y=s*o-i*a,S=h*_-u*p,T=h*m-c*p,x=u*m-c*_;return l*(t*x-s*T+i*S)-r*(n*x-a*T+o*S)+e[15]*(h*y-u*g+c*f)-d*(p*y-_*g+m*f)},je=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],l=t[5],h=t[6],u=t[7],c=t[8],d=t[9],p=t[10],_=t[11],m=t[12],f=t[13],g=t[14],y=t[15],S=s[0],T=s[1],x=s[2],b=s[3];return e[0]=S*i+T*o+x*c+b*m,e[1]=S*r+T*l+x*d+b*f,e[2]=S*n+T*h+x*p+b*g,e[3]=S*a+T*u+x*_+b*y,S=s[4],T=s[5],x=s[6],b=s[7],e[4]=S*i+T*o+x*c+b*m,e[5]=S*r+T*l+x*d+b*f,e[6]=S*n+T*h+x*p+b*g,e[7]=S*a+T*u+x*_+b*y,S=s[8],T=s[9],x=s[10],b=s[11],e[8]=S*i+T*o+x*c+b*m,e[9]=S*r+T*l+x*d+b*f,e[10]=S*n+T*h+x*p+b*g,e[11]=S*a+T*u+x*_+b*y,S=s[12],T=s[13],x=s[14],b=s[15],e[12]=S*i+T*o+x*c+b*m,e[13]=S*r+T*l+x*d+b*f,e[14]=S*n+T*h+x*p+b*g,e[15]=S*a+T*u+x*_+b*y,e},Ye=function(e,t,s){var i,r,n,a,o,l,h,u,c,d,p,_,m=s[0],f=s[1],g=s[2];return t===e?(e[12]=t[0]*m+t[4]*f+t[8]*g+t[12],e[13]=t[1]*m+t[5]*f+t[9]*g+t[13],e[14]=t[2]*m+t[6]*f+t[10]*g+t[14],e[15]=t[3]*m+t[7]*f+t[11]*g+t[15]):(i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],l=t[5],h=t[6],u=t[7],c=t[8],d=t[9],p=t[10],_=t[11],e[0]=i,e[1]=r,e[2]=n,e[3]=a,e[4]=o,e[5]=l,e[6]=h,e[7]=u,e[8]=c,e[9]=d,e[10]=p,e[11]=_,e[12]=i*m+o*f+c*g+t[12],e[13]=r*m+l*f+d*g+t[13],e[14]=n*m+h*f+p*g+t[14],e[15]=a*m+u*f+_*g+t[15]),e},qe=function(e,t,s){var i=s[0],r=s[1],n=s[2];return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=t[11]*n,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},Xe=function(e,t,s,i){var r,n,a,o,l,h,u,c,d,p,_,m,f,g,y,S,T,x,b,G,I,v,C,w,A=i[0],R=i[1],P=i[2],M=Math.hypot(A,R,P);return M<EPSILON?null:(A*=M=1/M,R*=M,P*=M,r=Math.sin(s),a=1-(n=Math.cos(s)),o=t[0],l=t[1],h=t[2],u=t[3],c=t[4],d=t[5],p=t[6],_=t[7],m=t[8],f=t[9],g=t[10],y=t[11],S=A*A*a+n,T=R*A*a+P*r,x=P*A*a-R*r,b=A*R*a-P*r,G=R*R*a+n,I=P*R*a+A*r,v=A*P*a+R*r,C=R*P*a-A*r,w=P*P*a+n,e[0]=o*S+c*T+m*x,e[1]=l*S+d*T+f*x,e[2]=h*S+p*T+g*x,e[3]=u*S+_*T+y*x,e[4]=o*b+c*G+m*I,e[5]=l*b+d*G+f*I,e[6]=h*b+p*G+g*I,e[7]=u*b+_*G+y*I,e[8]=o*v+c*C+m*w,e[9]=l*v+d*C+f*w,e[10]=h*v+p*C+g*w,e[11]=u*v+_*C+y*w,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)},$e=function(e,t,s){var i=Math.sin(s),r=Math.cos(s),n=t[4],a=t[5],o=t[6],l=t[7],h=t[8],u=t[9],c=t[10],d=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=n*r+h*i,e[5]=a*r+u*i,e[6]=o*r+c*i,e[7]=l*r+d*i,e[8]=h*r-n*i,e[9]=u*r-a*i,e[10]=c*r-o*i,e[11]=d*r-l*i,e},Ke=function(e,t,s){var i=Math.sin(s),r=Math.cos(s),n=t[0],a=t[1],o=t[2],l=t[3],h=t[8],u=t[9],c=t[10],d=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=n*r-h*i,e[1]=a*r-u*i,e[2]=o*r-c*i,e[3]=l*r-d*i,e[8]=n*i+h*r,e[9]=a*i+u*r,e[10]=o*i+c*r,e[11]=l*i+d*r,e},Je=function(e,t,s){var i=Math.sin(s),r=Math.cos(s),n=t[0],a=t[1],o=t[2],l=t[3],h=t[4],u=t[5],c=t[6],d=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=n*r+h*i,e[1]=a*r+u*i,e[2]=o*r+c*i,e[3]=l*r+d*i,e[4]=h*r-n*i,e[5]=u*r-a*i,e[6]=c*r-o*i,e[7]=d*r-l*i,e},Qe=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e},Ze=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},et=function(e,t,s){var i,r,n,a=s[0],o=s[1],l=s[2],h=Math.hypot(a,o,l);return h<EPSILON?null:(a*=h=1/h,o*=h,l*=h,i=Math.sin(t),n=1-(r=Math.cos(t)),e[0]=a*a*n+r,e[1]=o*a*n+l*i,e[2]=l*a*n-o*i,e[3]=0,e[4]=a*o*n-l*i,e[5]=o*o*n+r,e[6]=l*o*n+a*i,e[7]=0,e[8]=a*l*n+o*i,e[9]=o*l*n-a*i,e[10]=l*l*n+r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)},tt=function(e,t){var s=Math.sin(t),i=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=i,e[6]=s,e[7]=0,e[8]=0,e[9]=-s,e[10]=i,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},st=function(e,t){var s=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=0,e[2]=-s,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=s,e[9]=0,e[10]=i,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},it=function(e,t){var s=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=s,e[2]=0,e[3]=0,e[4]=-s,e[5]=i,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},rt=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=i+i,l=r+r,h=n+n,u=i*o,c=i*l,d=i*h,p=r*l,_=r*h,m=n*h,f=a*o,g=a*l,y=a*h;return e[0]=1-(p+m),e[1]=c+y,e[2]=d-g,e[3]=0,e[4]=c-y,e[5]=1-(u+m),e[6]=_+f,e[7]=0,e[8]=d+g,e[9]=_-f,e[10]=1-(u+p),e[11]=0,e[12]=s[0],e[13]=s[1],e[14]=s[2],e[15]=1,e},nt=function(e,t){var s=new ARRAY_TYPE(3),i=-t[0],r=-t[1],n=-t[2],a=t[3],o=t[4],l=t[5],h=t[6],u=t[7],c=i*i+r*r+n*n+a*a;return c>0?(s[0]=2*(o*a+u*i+l*n-h*r)/c,s[1]=2*(l*a+u*r+h*i-o*n)/c,s[2]=2*(h*a+u*n+o*r-l*i)/c):(s[0]=2*(o*a+u*i+l*n-h*r),s[1]=2*(l*a+u*r+h*i-o*n),s[2]=2*(h*a+u*n+o*r-l*i)),rt(e,t,s),e},at=function(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e},ot=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[4],a=t[5],o=t[6],l=t[8],h=t[9],u=t[10];return e[0]=Math.hypot(s,i,r),e[1]=Math.hypot(n,a,o),e[2]=Math.hypot(l,h,u),e},lt=function(e,t){var s=new ARRAY_TYPE(3);ot(s,t);var i=1/s[0],r=1/s[1],n=1/s[2],a=t[0]*i,o=t[1]*r,l=t[2]*n,h=t[4]*i,u=t[5]*r,c=t[6]*n,d=t[8]*i,p=t[9]*r,_=t[10]*n,m=a+u+_,f=0;return m>0?(f=2*Math.sqrt(m+1),e[3]=.25*f,e[0]=(c-p)/f,e[1]=(d-l)/f,e[2]=(o-h)/f):a>u&&a>_?(f=2*Math.sqrt(1+a-u-_),e[3]=(c-p)/f,e[0]=.25*f,e[1]=(o+h)/f,e[2]=(d+l)/f):u>_?(f=2*Math.sqrt(1+u-a-_),e[3]=(d-l)/f,e[0]=(o+h)/f,e[1]=.25*f,e[2]=(c+p)/f):(f=2*Math.sqrt(1+_-a-u),e[3]=(o-h)/f,e[0]=(d+l)/f,e[1]=(c+p)/f,e[2]=.25*f),e},ht=function(e,t,s,i){t[0]=i[12],t[1]=i[13],t[2]=i[14];var r=i[0],n=i[1],a=i[2],o=i[4],l=i[5],h=i[6],u=i[8],c=i[9],d=i[10];s[0]=Math.hypot(r,n,a),s[1]=Math.hypot(o,l,h),s[2]=Math.hypot(u,c,d);var p=1/s[0],_=1/s[1],m=1/s[2],f=r*p,g=n*_,y=a*m,S=o*p,T=l*_,x=h*m,b=u*p,G=c*_,I=d*m,v=f+T+I,C=0;return v>0?(C=2*Math.sqrt(v+1),e[3]=.25*C,e[0]=(x-G)/C,e[1]=(b-y)/C,e[2]=(g-S)/C):f>T&&f>I?(C=2*Math.sqrt(1+f-T-I),e[3]=(x-G)/C,e[0]=.25*C,e[1]=(g+S)/C,e[2]=(b+y)/C):T>I?(C=2*Math.sqrt(1+T-f-I),e[3]=(b-y)/C,e[0]=(g+S)/C,e[1]=.25*C,e[2]=(x+G)/C):(C=2*Math.sqrt(1+I-f-T),e[3]=(g-S)/C,e[0]=(b+y)/C,e[1]=(x+G)/C,e[2]=.25*C),e},ut=function(e,t,s,i){var r=t[0],n=t[1],a=t[2],o=t[3],l=r+r,h=n+n,u=a+a,c=r*l,d=r*h,p=r*u,_=n*h,m=n*u,f=a*u,g=o*l,y=o*h,S=o*u,T=i[0],x=i[1],b=i[2];return e[0]=(1-(_+f))*T,e[1]=(d+S)*T,e[2]=(p-y)*T,e[3]=0,e[4]=(d-S)*x,e[5]=(1-(c+f))*x,e[6]=(m+g)*x,e[7]=0,e[8]=(p+y)*b,e[9]=(m-g)*b,e[10]=(1-(c+_))*b,e[11]=0,e[12]=s[0],e[13]=s[1],e[14]=s[2],e[15]=1,e},ct=function(e,t,s,i,r){var n=t[0],a=t[1],o=t[2],l=t[3],h=n+n,u=a+a,c=o+o,d=n*h,p=n*u,_=n*c,m=a*u,f=a*c,g=o*c,y=l*h,S=l*u,T=l*c,x=i[0],b=i[1],G=i[2],I=r[0],v=r[1],C=r[2],w=(1-(m+g))*x,A=(p+T)*x,R=(_-S)*x,P=(p-T)*b,M=(1-(d+g))*b,E=(f+y)*b,D=(_+S)*G,N=(f-y)*G,F=(1-(d+m))*G;return e[0]=w,e[1]=A,e[2]=R,e[3]=0,e[4]=P,e[5]=M,e[6]=E,e[7]=0,e[8]=D,e[9]=N,e[10]=F,e[11]=0,e[12]=s[0]+I-(w*I+P*v+D*C),e[13]=s[1]+v-(A*I+M*v+N*C),e[14]=s[2]+C-(R*I+E*v+F*C),e[15]=1,e},dt=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=s+s,o=i+i,l=r+r,h=s*a,u=i*a,c=i*o,d=r*a,p=r*o,_=r*l,m=n*a,f=n*o,g=n*l;return e[0]=1-c-_,e[1]=u+g,e[2]=d-f,e[3]=0,e[4]=u-g,e[5]=1-h-_,e[6]=p+m,e[7]=0,e[8]=d+f,e[9]=p-m,e[10]=1-h-c,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},pt=function(e,t,s,i,r,n,a){var o=1/(s-t),l=1/(r-i),h=1/(n-a);return e[0]=2*n*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*n*l,e[6]=0,e[7]=0,e[8]=(s+t)*o,e[9]=(r+i)*l,e[10]=(a+n)*h,e[11]=-1,e[12]=0,e[13]=0,e[14]=a*n*2*h,e[15]=0,e},_t=function(e,t,s,i,r){var n=1/Math.tan(t/2);if(e[0]=n/s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=r&&r!==1/0){var a=1/(i-r);e[10]=(r+i)*a,e[14]=2*r*i*a}else e[10]=-1,e[14]=-2*i;return e},mt=function(e,t,s,i,r){var n=1/Math.tan(t/2);if(e[0]=n/s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=r&&r!==1/0){var a=1/(i-r);e[10]=r*a,e[14]=r*i*a}else e[10]=-1,e[14]=-i;return e},ft=function(e,t,s,i){var r=Math.tan(t.upDegrees*Math.PI/180),n=Math.tan(t.downDegrees*Math.PI/180),a=Math.tan(t.leftDegrees*Math.PI/180),o=Math.tan(t.rightDegrees*Math.PI/180),l=2/(a+o),h=2/(r+n);return e[0]=l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=h,e[6]=0,e[7]=0,e[8]=-(a-o)*l*.5,e[9]=(r-n)*h*.5,e[10]=i/(s-i),e[11]=-1,e[12]=0,e[13]=0,e[14]=i*s/(s-i),e[15]=0,e},gt=function(e,t,s,i,r,n,a){var o=1/(t-s),l=1/(i-r),h=1/(n-a);return e[0]=-2*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*h,e[11]=0,e[12]=(t+s)*o,e[13]=(r+i)*l,e[14]=(a+n)*h,e[15]=1,e},yt=function(e,t,s,i,r,n,a){var o=1/(t-s),l=1/(i-r),h=1/(n-a);return e[0]=-2*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=h,e[11]=0,e[12]=(t+s)*o,e[13]=(r+i)*l,e[14]=n*h,e[15]=1,e},St=function(e,t,s,i){var r,n,a,o,l,h,u,c,d,p,_=t[0],m=t[1],f=t[2],g=i[0],y=i[1],S=i[2],T=s[0],x=s[1],b=s[2];return Math.abs(_-T)<EPSILON&&Math.abs(m-x)<EPSILON&&Math.abs(f-b)<EPSILON?Ve(e):(u=_-T,c=m-x,d=f-b,r=y*(d*=p=1/Math.hypot(u,c,d))-S*(c*=p),n=S*(u*=p)-g*d,a=g*c-y*u,(p=Math.hypot(r,n,a))?(r*=p=1/p,n*=p,a*=p):(r=0,n=0,a=0),o=c*a-d*n,l=d*r-u*a,h=u*n-c*r,(p=Math.hypot(o,l,h))?(o*=p=1/p,l*=p,h*=p):(o=0,l=0,h=0),e[0]=r,e[1]=o,e[2]=u,e[3]=0,e[4]=n,e[5]=l,e[6]=c,e[7]=0,e[8]=a,e[9]=h,e[10]=d,e[11]=0,e[12]=-(r*_+n*m+a*f),e[13]=-(o*_+l*m+h*f),e[14]=-(u*_+c*m+d*f),e[15]=1,e)},Tt=function(e,t,s,i){var r=t[0],n=t[1],a=t[2],o=i[0],l=i[1],h=i[2],u=r-s[0],c=n-s[1],d=a-s[2],p=u*u+c*c+d*d;p>0&&(u*=p=1/Math.sqrt(p),c*=p,d*=p);var _=l*d-h*c,m=h*u-o*d,f=o*c-l*u;return(p=_*_+m*m+f*f)>0&&(_*=p=1/Math.sqrt(p),m*=p,f*=p),e[0]=_,e[1]=m,e[2]=f,e[3]=0,e[4]=c*f-d*m,e[5]=d*_-u*f,e[6]=u*m-c*_,e[7]=0,e[8]=u,e[9]=c,e[10]=d,e[11]=0,e[12]=r,e[13]=n,e[14]=a,e[15]=1,e},xt=function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"},bt=function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])},Gt=function(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e[2]=t[2]+s[2],e[3]=t[3]+s[3],e[4]=t[4]+s[4],e[5]=t[5]+s[5],e[6]=t[6]+s[6],e[7]=t[7]+s[7],e[8]=t[8]+s[8],e[9]=t[9]+s[9],e[10]=t[10]+s[10],e[11]=t[11]+s[11],e[12]=t[12]+s[12],e[13]=t[13]+s[13],e[14]=t[14]+s[14],e[15]=t[15]+s[15],e},It=function(e,t,s){return e[0]=t[0]-s[0],e[1]=t[1]-s[1],e[2]=t[2]-s[2],e[3]=t[3]-s[3],e[4]=t[4]-s[4],e[5]=t[5]-s[5],e[6]=t[6]-s[6],e[7]=t[7]-s[7],e[8]=t[8]-s[8],e[9]=t[9]-s[9],e[10]=t[10]-s[10],e[11]=t[11]-s[11],e[12]=t[12]-s[12],e[13]=t[13]-s[13],e[14]=t[14]-s[14],e[15]=t[15]-s[15],e},vt=function(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e[3]=t[3]*s,e[4]=t[4]*s,e[5]=t[5]*s,e[6]=t[6]*s,e[7]=t[7]*s,e[8]=t[8]*s,e[9]=t[9]*s,e[10]=t[10]*s,e[11]=t[11]*s,e[12]=t[12]*s,e[13]=t[13]*s,e[14]=t[14]*s,e[15]=t[15]*s,e},Ct=function(e,t,s,i){return e[0]=t[0]+s[0]*i,e[1]=t[1]+s[1]*i,e[2]=t[2]+s[2]*i,e[3]=t[3]+s[3]*i,e[4]=t[4]+s[4]*i,e[5]=t[5]+s[5]*i,e[6]=t[6]+s[6]*i,e[7]=t[7]+s[7]*i,e[8]=t[8]+s[8]*i,e[9]=t[9]+s[9]*i,e[10]=t[10]+s[10]*i,e[11]=t[11]+s[11]*i,e[12]=t[12]+s[12]*i,e[13]=t[13]+s[13]*i,e[14]=t[14]+s[14]*i,e[15]=t[15]+s[15]*i,e},wt=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]},At=function(e,t){var s=e[0],i=e[1],r=e[2],n=e[3],a=e[4],o=e[5],l=e[6],h=e[7],u=e[8],c=e[9],d=e[10],p=e[11],_=e[12],m=e[13],f=e[14],g=e[15],y=t[0],S=t[1],T=t[2],x=t[3],b=t[4],G=t[5],I=t[6],v=t[7],C=t[8],w=t[9],A=t[10],R=t[11],P=t[12],M=t[13],E=t[14],D=t[15];return Math.abs(s-y)<=EPSILON*Math.max(1,Math.abs(s),Math.abs(y))&&Math.abs(i-S)<=EPSILON*Math.max(1,Math.abs(i),Math.abs(S))&&Math.abs(r-T)<=EPSILON*Math.max(1,Math.abs(r),Math.abs(T))&&Math.abs(n-x)<=EPSILON*Math.max(1,Math.abs(n),Math.abs(x))&&Math.abs(a-b)<=EPSILON*Math.max(1,Math.abs(a),Math.abs(b))&&Math.abs(o-G)<=EPSILON*Math.max(1,Math.abs(o),Math.abs(G))&&Math.abs(l-I)<=EPSILON*Math.max(1,Math.abs(l),Math.abs(I))&&Math.abs(h-v)<=EPSILON*Math.max(1,Math.abs(h),Math.abs(v))&&Math.abs(u-C)<=EPSILON*Math.max(1,Math.abs(u),Math.abs(C))&&Math.abs(c-w)<=EPSILON*Math.max(1,Math.abs(c),Math.abs(w))&&Math.abs(d-A)<=EPSILON*Math.max(1,Math.abs(d),Math.abs(A))&&Math.abs(p-R)<=EPSILON*Math.max(1,Math.abs(p),Math.abs(R))&&Math.abs(_-P)<=EPSILON*Math.max(1,Math.abs(_),Math.abs(P))&&Math.abs(m-M)<=EPSILON*Math.max(1,Math.abs(m),Math.abs(M))&&Math.abs(f-E)<=EPSILON*Math.max(1,Math.abs(f),Math.abs(E))&&Math.abs(g-D)<=EPSILON*Math.max(1,Math.abs(g),Math.abs(D))},Rt=function(){var e=new ARRAY_TYPE(3);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e},Pt=function(e){var t=new ARRAY_TYPE(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},Mt=function(e){var t=e[0],s=e[1],i=e[2];return Math.hypot(t,s,i)},Et=function(e,t,s){var i=new ARRAY_TYPE(3);return i[0]=e,i[1]=t,i[2]=s,i},Dt=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},Nt=function(e,t,s,i){return e[0]=t,e[1]=s,e[2]=i,e},Ft=function(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e[2]=t[2]+s[2],e},Ot=function(e,t,s){return e[0]=t[0]-s[0],e[1]=t[1]-s[1],e[2]=t[2]-s[2],e},Bt=function(e,t,s){return e[0]=t[0]*s[0],e[1]=t[1]*s[1],e[2]=t[2]*s[2],e},Lt=function(e,t,s){return e[0]=t[0]/s[0],e[1]=t[1]/s[1],e[2]=t[2]/s[2],e},kt=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e},Vt=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e},Ut=function(e,t,s){return e[0]=Math.min(t[0],s[0]),e[1]=Math.min(t[1],s[1]),e[2]=Math.min(t[2],s[2]),e},Wt=function(e,t,s){return e[0]=Math.max(t[0],s[0]),e[1]=Math.max(t[1],s[1]),e[2]=Math.max(t[2],s[2]),e},Ht=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e},zt=function(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e},jt=function(e,t,s,i){return e[0]=t[0]+s[0]*i,e[1]=t[1]+s[1]*i,e[2]=t[2]+s[2]*i,e},Yt=function(e,t){var s=t[0]-e[0],i=t[1]-e[1],r=t[2]-e[2];return Math.hypot(s,i,r)},qt=function(e,t){var s=t[0]-e[0],i=t[1]-e[1],r=t[2]-e[2];return s*s+i*i+r*r},Xt=function(e){var t=e[0],s=e[1],i=e[2];return t*t+s*s+i*i},$t=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},Kt=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e},Jt=function(e,t){var s=t[0],i=t[1],r=t[2],n=s*s+i*i+r*r;return n>0&&(n=1/Math.sqrt(n)),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e},Qt=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},Zt=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=s[0],o=s[1],l=s[2];return e[0]=r*l-n*o,e[1]=n*a-i*l,e[2]=i*o-r*a,e},es=function(e,t,s,i){var r=t[0],n=t[1],a=t[2];return e[0]=r+i*(s[0]-r),e[1]=n+i*(s[1]-n),e[2]=a+i*(s[2]-a),e},ts=function(e,t,s,i){var r=Math.acos(Math.min(Math.max(Qt(t,s),-1),1)),n=Math.sin(r),a=Math.sin((1-i)*r)/n,o=Math.sin(i*r)/n;return e[0]=a*t[0]+o*s[0],e[1]=a*t[1]+o*s[1],e[2]=a*t[2]+o*s[2],e},ss=function(e,t,s,i,r,n){var a=n*n,o=a*(2*n-3)+1,l=a*(n-2)+n,h=a*(n-1),u=a*(3-2*n);return e[0]=t[0]*o+s[0]*l+i[0]*h+r[0]*u,e[1]=t[1]*o+s[1]*l+i[1]*h+r[1]*u,e[2]=t[2]*o+s[2]*l+i[2]*h+r[2]*u,e},is=function(e,t,s,i,r,n){var a=1-n,o=a*a,l=n*n,h=o*a,u=3*n*o,c=3*l*a,d=l*n;return e[0]=t[0]*h+s[0]*u+i[0]*c+r[0]*d,e[1]=t[1]*h+s[1]*u+i[1]*c+r[1]*d,e[2]=t[2]*h+s[2]*u+i[2]*c+r[2]*d,e},rs=function(e,t){t=t||1;var s=2*RANDOM()*Math.PI,i=2*RANDOM()-1,r=Math.sqrt(1-i*i)*t;return e[0]=Math.cos(s)*r,e[1]=Math.sin(s)*r,e[2]=i*t,e},ns=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=s[3]*i+s[7]*r+s[11]*n+s[15];return a=a||1,e[0]=(s[0]*i+s[4]*r+s[8]*n+s[12])/a,e[1]=(s[1]*i+s[5]*r+s[9]*n+s[13])/a,e[2]=(s[2]*i+s[6]*r+s[10]*n+s[14])/a,e},as=function(e,t,s){var i=t[0],r=t[1],n=t[2];return e[0]=i*s[0]+r*s[3]+n*s[6],e[1]=i*s[1]+r*s[4]+n*s[7],e[2]=i*s[2]+r*s[5]+n*s[8],e},os=function(e,t,s){var i=s[0],r=s[1],n=s[2],a=s[3],o=t[0],l=t[1],h=t[2],u=r*h-n*l,c=n*o-i*h,d=i*l-r*o,p=r*d-n*c,_=n*u-i*d,m=i*c-r*u,f=2*a;return u*=f,c*=f,d*=f,p*=2,_*=2,m*=2,e[0]=o+u+p,e[1]=l+c+_,e[2]=h+d+m,e},ls=function(e,t,s,i){var r=[],n=[];return r[0]=t[0]-s[0],r[1]=t[1]-s[1],r[2]=t[2]-s[2],n[0]=r[0],n[1]=r[1]*Math.cos(i)-r[2]*Math.sin(i),n[2]=r[1]*Math.sin(i)+r[2]*Math.cos(i),e[0]=n[0]+s[0],e[1]=n[1]+s[1],e[2]=n[2]+s[2],e},hs=function(e,t,s,i){var r=[],n=[];return r[0]=t[0]-s[0],r[1]=t[1]-s[1],r[2]=t[2]-s[2],n[0]=r[2]*Math.sin(i)+r[0]*Math.cos(i),n[1]=r[1],n[2]=r[2]*Math.cos(i)-r[0]*Math.sin(i),e[0]=n[0]+s[0],e[1]=n[1]+s[1],e[2]=n[2]+s[2],e},us=function(e,t,s,i){var r=[],n=[];return r[0]=t[0]-s[0],r[1]=t[1]-s[1],r[2]=t[2]-s[2],n[0]=r[0]*Math.cos(i)-r[1]*Math.sin(i),n[1]=r[0]*Math.sin(i)+r[1]*Math.cos(i),n[2]=r[2],e[0]=n[0]+s[0],e[1]=n[1]+s[1],e[2]=n[2]+s[2],e},cs=function(e,t){var s=e[0],i=e[1],r=e[2],n=t[0],a=t[1],o=t[2],l=Math.sqrt((s*s+i*i+r*r)*(n*n+a*a+o*o)),h=l&&Qt(e,t)/l;return Math.acos(Math.min(Math.max(h,-1),1))},ds=function(e){return e[0]=0,e[1]=0,e[2]=0,e},ps=function(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"},_s=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]},ms=function(e,t){var s=e[0],i=e[1],r=e[2],n=t[0],a=t[1],o=t[2];return Math.abs(s-n)<=EPSILON*Math.max(1,Math.abs(s),Math.abs(n))&&Math.abs(i-a)<=EPSILON*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-o)<=EPSILON*Math.max(1,Math.abs(r),Math.abs(o))},fs=function(){var e=new ARRAY_TYPE(4);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e},gs=function(e){var t=new ARRAY_TYPE(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},ys=function(e,t,s,i){var r=new ARRAY_TYPE(4);return r[0]=e,r[1]=t,r[2]=s,r[3]=i,r},Ss=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},Ts=function(e,t,s,i,r){return e[0]=t,e[1]=s,e[2]=i,e[3]=r,e},xs=function(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e[2]=t[2]+s[2],e[3]=t[3]+s[3],e},bs=function(e,t,s){return e[0]=t[0]-s[0],e[1]=t[1]-s[1],e[2]=t[2]-s[2],e[3]=t[3]-s[3],e},Gs=function(e,t,s){return e[0]=t[0]*s[0],e[1]=t[1]*s[1],e[2]=t[2]*s[2],e[3]=t[3]*s[3],e},Is=function(e,t,s){return e[0]=t[0]/s[0],e[1]=t[1]/s[1],e[2]=t[2]/s[2],e[3]=t[3]/s[3],e},vs=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e},Cs=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e},ws=function(e,t,s){return e[0]=Math.min(t[0],s[0]),e[1]=Math.min(t[1],s[1]),e[2]=Math.min(t[2],s[2]),e[3]=Math.min(t[3],s[3]),e},As=function(e,t,s){return e[0]=Math.max(t[0],s[0]),e[1]=Math.max(t[1],s[1]),e[2]=Math.max(t[2],s[2]),e[3]=Math.max(t[3],s[3]),e},Rs=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e[3]=Math.round(t[3]),e},Ps=function(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e[3]=t[3]*s,e},Ms=function(e,t,s,i){return e[0]=t[0]+s[0]*i,e[1]=t[1]+s[1]*i,e[2]=t[2]+s[2]*i,e[3]=t[3]+s[3]*i,e},Es=function(e,t){var s=t[0]-e[0],i=t[1]-e[1],r=t[2]-e[2],n=t[3]-e[3];return Math.hypot(s,i,r,n)},Ds=function(e,t){var s=t[0]-e[0],i=t[1]-e[1],r=t[2]-e[2],n=t[3]-e[3];return s*s+i*i+r*r+n*n},Ns=function(e){var t=e[0],s=e[1],i=e[2],r=e[3];return Math.hypot(t,s,i,r)},Fs=function(e){var t=e[0],s=e[1],i=e[2],r=e[3];return t*t+s*s+i*i+r*r},Os=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},Bs=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e},Ls=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=s*s+i*i+r*r+n*n;return a>0&&(a=1/Math.sqrt(a)),e[0]=s*a,e[1]=i*a,e[2]=r*a,e[3]=n*a,e},ks=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},Vs=function(e,t,s,i){var r=s[0]*i[1]-s[1]*i[0],n=s[0]*i[2]-s[2]*i[0],a=s[0]*i[3]-s[3]*i[0],o=s[1]*i[2]-s[2]*i[1],l=s[1]*i[3]-s[3]*i[1],h=s[2]*i[3]-s[3]*i[2],u=t[0],c=t[1],d=t[2],p=t[3];return e[0]=c*h-d*l+p*o,e[1]=-u*h+d*a-p*n,e[2]=u*l-c*a+p*r,e[3]=-u*o+c*n-d*r,e},Us=function(e,t,s,i){var r=t[0],n=t[1],a=t[2],o=t[3];return e[0]=r+i*(s[0]-r),e[1]=n+i*(s[1]-n),e[2]=a+i*(s[2]-a),e[3]=o+i*(s[3]-o),e},Ws=function(e,t){var s,i,r,n,a,o;t=t||1;do{a=(s=2*RANDOM()-1)*s+(i=2*RANDOM()-1)*i}while(a>=1);do{o=(r=2*RANDOM()-1)*r+(n=2*RANDOM()-1)*n}while(o>=1);var l=Math.sqrt((1-a)/o);return e[0]=t*s,e[1]=t*i,e[2]=t*r*l,e[3]=t*n*l,e},Hs=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3];return e[0]=s[0]*i+s[4]*r+s[8]*n+s[12]*a,e[1]=s[1]*i+s[5]*r+s[9]*n+s[13]*a,e[2]=s[2]*i+s[6]*r+s[10]*n+s[14]*a,e[3]=s[3]*i+s[7]*r+s[11]*n+s[15]*a,e},zs=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=s[0],o=s[1],l=s[2],h=s[3],u=h*i+o*n-l*r,c=h*r+l*i-a*n,d=h*n+a*r-o*i,p=-a*i-o*r-l*n;return e[0]=u*h+p*-a+c*-l-d*-o,e[1]=c*h+p*-o+d*-a-u*-l,e[2]=d*h+p*-l+u*-o-c*-a,e[3]=t[3],e},js=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e},Ys=function(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},qs=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},Xs=function(e,t){var s=e[0],i=e[1],r=e[2],n=e[3],a=t[0],o=t[1],l=t[2],h=t[3];return Math.abs(s-a)<=EPSILON*Math.max(1,Math.abs(s),Math.abs(a))&&Math.abs(i-o)<=EPSILON*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(r-l)<=EPSILON*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(n-h)<=EPSILON*Math.max(1,Math.abs(n),Math.abs(h))},$s=function(){var e=new ARRAY_TYPE(4);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e},Ks=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},Js=function(e,t,s){s*=.5;var i=Math.sin(s);return e[0]=i*t[0],e[1]=i*t[1],e[2]=i*t[2],e[3]=Math.cos(s),e},Qs=function(e,t){var s=2*Math.acos(t[3]),i=Math.sin(s/2);return i>EPSILON?(e[0]=t[0]/i,e[1]=t[1]/i,e[2]=t[2]/i):(e[0]=1,e[1]=0,e[2]=0),s},Zs=function(e,t){var s=dot$2(e,t);return Math.acos(2*s*s-1)},ei=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=s[0],l=s[1],h=s[2],u=s[3];return e[0]=i*u+a*o+r*h-n*l,e[1]=r*u+a*l+n*o-i*h,e[2]=n*u+a*h+i*l-r*o,e[3]=a*u-i*o-r*l-n*h,e},ti=function(e,t,s){s*=.5;var i=t[0],r=t[1],n=t[2],a=t[3],o=Math.sin(s),l=Math.cos(s);return e[0]=i*l+a*o,e[1]=r*l+n*o,e[2]=n*l-r*o,e[3]=a*l-i*o,e},si=function(e,t,s){s*=.5;var i=t[0],r=t[1],n=t[2],a=t[3],o=Math.sin(s),l=Math.cos(s);return e[0]=i*l-n*o,e[1]=r*l+a*o,e[2]=n*l+i*o,e[3]=a*l-r*o,e},ii=function(e,t,s){s*=.5;var i=t[0],r=t[1],n=t[2],a=t[3],o=Math.sin(s),l=Math.cos(s);return e[0]=i*l+r*o,e[1]=r*l-i*o,e[2]=n*l+a*o,e[3]=a*l-n*o,e},ri=function(e,t){var s=t[0],i=t[1],r=t[2];return e[0]=s,e[1]=i,e[2]=r,e[3]=Math.sqrt(Math.abs(1-s*s-i*i-r*r)),e},ni=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=Math.sqrt(s*s+i*i+r*r),o=Math.exp(n),l=a>0?o*Math.sin(a)/a:0;return e[0]=s*l,e[1]=i*l,e[2]=r*l,e[3]=o*Math.cos(a),e},ai=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=Math.sqrt(s*s+i*i+r*r),o=a>0?Math.atan2(a,n)/a:0;return e[0]=s*o,e[1]=i*o,e[2]=r*o,e[3]=.5*Math.log(s*s+i*i+r*r+n*n),e},oi=function(e,t,s){return ai(e,t),scale$2(e,e,s),ni(e,e),e},li=function(e,t,s,i){var r,n,a,o,l,h=t[0],u=t[1],c=t[2],d=t[3],p=s[0],_=s[1],m=s[2],f=s[3];return(n=h*p+u*_+c*m+d*f)<0&&(n=-n,p=-p,_=-_,m=-m,f=-f),1-n>EPSILON?(r=Math.acos(n),a=Math.sin(r),o=Math.sin((1-i)*r)/a,l=Math.sin(i*r)/a):(o=1-i,l=i),e[0]=o*h+l*p,e[1]=o*u+l*_,e[2]=o*c+l*m,e[3]=o*d+l*f,e},hi=function(e){var t=RANDOM(),s=RANDOM(),i=RANDOM(),r=Math.sqrt(1-t),n=Math.sqrt(t);return e[0]=r*Math.sin(2*Math.PI*s),e[1]=r*Math.cos(2*Math.PI*s),e[2]=n*Math.sin(2*Math.PI*i),e[3]=n*Math.cos(2*Math.PI*i),e},ui=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=s*s+i*i+r*r+n*n,o=a?1/a:0;return e[0]=-s*o,e[1]=-i*o,e[2]=-r*o,e[3]=n*o,e},ci=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},di=function(e,t){var s,i=t[0]+t[4]+t[8];if(i>0)s=Math.sqrt(i+1),e[3]=.5*s,s=.5/s,e[0]=(t[5]-t[7])*s,e[1]=(t[6]-t[2])*s,e[2]=(t[1]-t[3])*s;else{var r=0;t[4]>t[0]&&(r=1),t[8]>t[3*r+r]&&(r=2);var n=(r+1)%3,a=(r+2)%3;s=Math.sqrt(t[3*r+r]-t[3*n+n]-t[3*a+a]+1),e[r]=.5*s,s=.5/s,e[3]=(t[3*n+a]-t[3*a+n])*s,e[n]=(t[3*n+r]+t[3*r+n])*s,e[a]=(t[3*a+r]+t[3*r+a])*s}return e},pi=function(e,t,s,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:ANGLE_ORDER,n=Math.PI/360;t*=n,i*=n,s*=n;var a=Math.sin(t),o=Math.cos(t),l=Math.sin(s),h=Math.cos(s),u=Math.sin(i),c=Math.cos(i);switch(r){case"xyz":e[0]=a*h*c+o*l*u,e[1]=o*l*c-a*h*u,e[2]=o*h*u+a*l*c,e[3]=o*h*c-a*l*u;break;case"xzy":e[0]=a*h*c-o*l*u,e[1]=o*l*c-a*h*u,e[2]=o*h*u+a*l*c,e[3]=o*h*c+a*l*u;break;case"yxz":e[0]=a*h*c+o*l*u,e[1]=o*l*c-a*h*u,e[2]=o*h*u-a*l*c,e[3]=o*h*c+a*l*u;break;case"yzx":e[0]=a*h*c+o*l*u,e[1]=o*l*c+a*h*u,e[2]=o*h*u-a*l*c,e[3]=o*h*c-a*l*u;break;case"zxy":e[0]=a*h*c-o*l*u,e[1]=o*l*c+a*h*u,e[2]=o*h*u+a*l*c,e[3]=o*h*c-a*l*u;break;case"zyx":e[0]=a*h*c-o*l*u,e[1]=o*l*c+a*h*u,e[2]=o*h*u-a*l*c,e[3]=o*h*c+a*l*u;break;default:throw new Error("Unknown angle order "+r)}return e},_i=function(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},mi=function(e,t){return Math.abs(ks(e,t))>=1-EPSILON},fi=function(){var e=new ARRAY_TYPE(8);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0),e[3]=1,e},gi=function(e){var t=new ARRAY_TYPE(8);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t},yi=function(e,t,s,i,r,n,a,o){var l=new ARRAY_TYPE(8);return l[0]=e,l[1]=t,l[2]=s,l[3]=i,l[4]=r,l[5]=n,l[6]=a,l[7]=o,l},Si=function(e,t,s,i,r,n,a){var o=new ARRAY_TYPE(8);o[0]=e,o[1]=t,o[2]=s,o[3]=i;var l=.5*r,h=.5*n,u=.5*a;return o[4]=l*i+h*s-u*t,o[5]=h*i+u*e-l*s,o[6]=u*i+l*t-h*e,o[7]=-l*e-h*t-u*s,o},Ti=function(e,t,s){var i=.5*s[0],r=.5*s[1],n=.5*s[2],a=t[0],o=t[1],l=t[2],h=t[3];return e[0]=a,e[1]=o,e[2]=l,e[3]=h,e[4]=i*h+r*l-n*o,e[5]=r*h+n*a-i*l,e[6]=n*h+i*o-r*a,e[7]=-i*a-r*o-n*l,e},xi=function(e,t){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e[4]=.5*t[0],e[5]=.5*t[1],e[6]=.5*t[2],e[7]=0,e},bi=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=0,e[5]=0,e[6]=0,e[7]=0,e},Gi=function(e,t){var s=$s();lt(s,t);var i=new ARRAY_TYPE(3);return at(i,t),Ti(e,s,i),e},Ii=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e},vi=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e},Ci=function(e,t,s,i,r,n,a,o,l){return e[0]=t,e[1]=s,e[2]=i,e[3]=r,e[4]=n,e[5]=a,e[6]=o,e[7]=l,e},wi=function(e,t){return e[0]=t[4],e[1]=t[5],e[2]=t[6],e[3]=t[7],e},Ai=function(e,t){return e[4]=t[0],e[5]=t[1],e[6]=t[2],e[7]=t[3],e},Ri=function(e,t){var s=t[4],i=t[5],r=t[6],n=t[7],a=-t[0],o=-t[1],l=-t[2],h=t[3];return e[0]=2*(s*h+n*a+i*l-r*o),e[1]=2*(i*h+n*o+r*a-s*l),e[2]=2*(r*h+n*l+s*o-i*a),e},Pi=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=.5*s[0],l=.5*s[1],h=.5*s[2],u=t[4],c=t[5],d=t[6],p=t[7];return e[0]=i,e[1]=r,e[2]=n,e[3]=a,e[4]=a*o+r*h-n*l+u,e[5]=a*l+n*o-i*h+c,e[6]=a*h+i*l-r*o+d,e[7]=-i*o-r*l-n*h+p,e},Mi=function(e,t,s){var i=-t[0],r=-t[1],n=-t[2],a=t[3],o=t[4],l=t[5],h=t[6],u=t[7],c=o*a+u*i+l*n-h*r,d=l*a+u*r+h*i-o*n,p=h*a+u*n+o*r-l*i,_=u*a-o*i-l*r-h*n;return ti(e,t,s),i=e[0],r=e[1],n=e[2],a=e[3],e[4]=c*a+_*i+d*n-p*r,e[5]=d*a+_*r+p*i-c*n,e[6]=p*a+_*n+c*r-d*i,e[7]=_*a-c*i-d*r-p*n,e},Ei=function(e,t,s){var i=-t[0],r=-t[1],n=-t[2],a=t[3],o=t[4],l=t[5],h=t[6],u=t[7],c=o*a+u*i+l*n-h*r,d=l*a+u*r+h*i-o*n,p=h*a+u*n+o*r-l*i,_=u*a-o*i-l*r-h*n;return si(e,t,s),i=e[0],r=e[1],n=e[2],a=e[3],e[4]=c*a+_*i+d*n-p*r,e[5]=d*a+_*r+p*i-c*n,e[6]=p*a+_*n+c*r-d*i,e[7]=_*a-c*i-d*r-p*n,e},Di=function(e,t,s){var i=-t[0],r=-t[1],n=-t[2],a=t[3],o=t[4],l=t[5],h=t[6],u=t[7],c=o*a+u*i+l*n-h*r,d=l*a+u*r+h*i-o*n,p=h*a+u*n+o*r-l*i,_=u*a-o*i-l*r-h*n;return ii(e,t,s),i=e[0],r=e[1],n=e[2],a=e[3],e[4]=c*a+_*i+d*n-p*r,e[5]=d*a+_*r+p*i-c*n,e[6]=p*a+_*n+c*r-d*i,e[7]=_*a-c*i-d*r-p*n,e},Ni=function(e,t,s){var i=s[0],r=s[1],n=s[2],a=s[3],o=t[0],l=t[1],h=t[2],u=t[3];return e[0]=o*a+u*i+l*n-h*r,e[1]=l*a+u*r+h*i-o*n,e[2]=h*a+u*n+o*r-l*i,e[3]=u*a-o*i-l*r-h*n,o=t[4],l=t[5],h=t[6],u=t[7],e[4]=o*a+u*i+l*n-h*r,e[5]=l*a+u*r+h*i-o*n,e[6]=h*a+u*n+o*r-l*i,e[7]=u*a-o*i-l*r-h*n,e},Fi=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=s[0],l=s[1],h=s[2],u=s[3];return e[0]=i*u+a*o+r*h-n*l,e[1]=r*u+a*l+n*o-i*h,e[2]=n*u+a*h+i*l-r*o,e[3]=a*u-i*o-r*l-n*h,o=s[4],l=s[5],h=s[6],u=s[7],e[4]=i*u+a*o+r*h-n*l,e[5]=r*u+a*l+n*o-i*h,e[6]=n*u+a*h+i*l-r*o,e[7]=a*u-i*o-r*l-n*h,e},Oi=function(e,t,s,i){if(Math.abs(i)<EPSILON)return Ii(e,t);var r=Math.hypot(s[0],s[1],s[2]);i*=.5;var n=Math.sin(i),a=n*s[0]/r,o=n*s[1]/r,l=n*s[2]/r,h=Math.cos(i),u=t[0],c=t[1],d=t[2],p=t[3];e[0]=u*h+p*a+c*l-d*o,e[1]=c*h+p*o+d*a-u*l,e[2]=d*h+p*l+u*o-c*a,e[3]=p*h-u*a-c*o-d*l;var _=t[4],m=t[5],f=t[6],g=t[7];return e[4]=_*h+g*a+m*l-f*o,e[5]=m*h+g*o+f*a-_*l,e[6]=f*h+g*l+_*o-m*a,e[7]=g*h-_*a-m*o-f*l,e},Bi=function(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e[2]=t[2]+s[2],e[3]=t[3]+s[3],e[4]=t[4]+s[4],e[5]=t[5]+s[5],e[6]=t[6]+s[6],e[7]=t[7]+s[7],e},Li=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=s[4],l=s[5],h=s[6],u=s[7],c=t[4],d=t[5],p=t[6],_=t[7],m=s[0],f=s[1],g=s[2],y=s[3];return e[0]=i*y+a*m+r*g-n*f,e[1]=r*y+a*f+n*m-i*g,e[2]=n*y+a*g+i*f-r*m,e[3]=a*y-i*m-r*f-n*g,e[4]=i*u+a*o+r*h-n*l+c*y+_*m+d*g-p*f,e[5]=r*u+a*l+n*o-i*h+d*y+_*f+p*m-c*g,e[6]=n*u+a*h+i*l-r*o+p*y+_*g+c*f-d*m,e[7]=a*u-i*o-r*l-n*h+_*y-c*m-d*f-p*g,e},ki=function(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e[3]=t[3]*s,e[4]=t[4]*s,e[5]=t[5]*s,e[6]=t[6]*s,e[7]=t[7]*s,e},Vi=function(e,t,s,i){var r=1-i;return dot$1(t,s)<0&&(i=-i),e[0]=t[0]*r+s[0]*i,e[1]=t[1]*r+s[1]*i,e[2]=t[2]*r+s[2]*i,e[3]=t[3]*r+s[3]*i,e[4]=t[4]*r+s[4]*i,e[5]=t[5]*r+s[5]*i,e[6]=t[6]*r+s[6]*i,e[7]=t[7]*r+s[7]*i,e},Ui=function(e,t){var s=squaredLength$1(t);return e[0]=-t[0]/s,e[1]=-t[1]/s,e[2]=-t[2]/s,e[3]=t[3]/s,e[4]=-t[4]/s,e[5]=-t[5]/s,e[6]=-t[6]/s,e[7]=t[7]/s,e},Wi=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=t[7],e},Hi=function(e,t){var s=squaredLength$1(t);if(s>0){s=Math.sqrt(s);var i=t[0]/s,r=t[1]/s,n=t[2]/s,a=t[3]/s,o=t[4],l=t[5],h=t[6],u=t[7],c=i*o+r*l+n*h+a*u;e[0]=i,e[1]=r,e[2]=n,e[3]=a,e[4]=(o-i*c)/s,e[5]=(l-r*c)/s,e[6]=(h-n*c)/s,e[7]=(u-a*c)/s}return e},zi=function(e){return"quat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+")"},ji=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]},Yi=function(e,t){var s=e[0],i=e[1],r=e[2],n=e[3],a=e[4],o=e[5],l=e[6],h=e[7],u=t[0],c=t[1],d=t[2],p=t[3],_=t[4],m=t[5],f=t[6],g=t[7];return Math.abs(s-u)<=EPSILON*Math.max(1,Math.abs(s),Math.abs(u))&&Math.abs(i-c)<=EPSILON*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(r-d)<=EPSILON*Math.max(1,Math.abs(r),Math.abs(d))&&Math.abs(n-p)<=EPSILON*Math.max(1,Math.abs(n),Math.abs(p))&&Math.abs(a-_)<=EPSILON*Math.max(1,Math.abs(a),Math.abs(_))&&Math.abs(o-m)<=EPSILON*Math.max(1,Math.abs(o),Math.abs(m))&&Math.abs(l-f)<=EPSILON*Math.max(1,Math.abs(l),Math.abs(f))&&Math.abs(h-g)<=EPSILON*Math.max(1,Math.abs(h),Math.abs(g))},qi=function(){var e=new ARRAY_TYPE(2);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0),e},Xi=function(e){var t=new ARRAY_TYPE(2);return t[0]=e[0],t[1]=e[1],t},$i=function(e,t){var s=new ARRAY_TYPE(2);return s[0]=e,s[1]=t,s},Ki=function(e,t){return e[0]=t[0],e[1]=t[1],e},Ji=function(e,t,s){return e[0]=t,e[1]=s,e},Qi=function(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e},Zi=function(e,t,s){return e[0]=t[0]-s[0],e[1]=t[1]-s[1],e},er=function(e,t,s){return e[0]=t[0]*s[0],e[1]=t[1]*s[1],e},tr=function(e,t,s){return e[0]=t[0]/s[0],e[1]=t[1]/s[1],e},sr=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e},ir=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e},rr=function(e,t,s){return e[0]=Math.min(t[0],s[0]),e[1]=Math.min(t[1],s[1]),e},nr=function(e,t,s){return e[0]=Math.max(t[0],s[0]),e[1]=Math.max(t[1],s[1]),e},ar=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e},lr=function(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e},hr=function(e,t,s,i){return e[0]=t[0]+s[0]*i,e[1]=t[1]+s[1]*i,e},ur=function(e,t){var s=t[0]-e[0],i=t[1]-e[1];return Math.hypot(s,i)},cr=function(e,t){var s=t[0]-e[0],i=t[1]-e[1];return s*s+i*i},dr=function(e){var t=e[0],s=e[1];return Math.hypot(t,s)},pr=function(e){var t=e[0],s=e[1];return t*t+s*s},_r=function(e,t){return e[0]=-t[0],e[1]=-t[1],e},mr=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e},fr=function(e,t){var s=t[0],i=t[1],r=s*s+i*i;return r>0&&(r=1/Math.sqrt(r)),e[0]=t[0]*r,e[1]=t[1]*r,e},gr=function(e,t){return e[0]*t[0]+e[1]*t[1]},yr=function(e,t,s){var i=t[0]*s[1]-t[1]*s[0];return e[0]=e[1]=0,e[2]=i,e},Sr=function(e,t,s,i){var r=t[0],n=t[1];return e[0]=r+i*(s[0]-r),e[1]=n+i*(s[1]-n),e},Tr=function(e,t){t=t||1;var s=2*RANDOM()*Math.PI;return e[0]=Math.cos(s)*t,e[1]=Math.sin(s)*t,e},xr=function(e,t,s){var i=t[0],r=t[1];return e[0]=s[0]*i+s[2]*r,e[1]=s[1]*i+s[3]*r,e},br=function(e,t,s){var i=t[0],r=t[1];return e[0]=s[0]*i+s[2]*r+s[4],e[1]=s[1]*i+s[3]*r+s[5],e},Gr=function(e,t,s){var i=t[0],r=t[1];return e[0]=s[0]*i+s[3]*r+s[6],e[1]=s[1]*i+s[4]*r+s[7],e},Ir=function(e,t,s){var i=t[0],r=t[1];return e[0]=s[0]*i+s[4]*r+s[12],e[1]=s[1]*i+s[5]*r+s[13],e},vr=function(e,t,s,i){var r=t[0]-s[0],n=t[1]-s[1],a=Math.sin(i),o=Math.cos(i);return e[0]=r*o-n*a+s[0],e[1]=r*a+n*o+s[1],e},Cr=function(e,t){var s=e[0],i=e[1],r=t[0],n=t[1],a=Math.sqrt((s*s+i*i)*(r*r+n*n)),o=a&&(s*r+i*n)/a;return Math.acos(Math.min(Math.max(o,-1),1))},wr=function(e){return e[0]=0,e[1]=0,e},Ar=function(e){return"vec2("+e[0]+", "+e[1]+")"},Rr=function(e,t){return e[0]===t[0]&&e[1]===t[1]},Pr=function(e,t){var s=e[0],i=e[1],r=t[0],n=t[1];return Math.abs(s-r)<=EPSILON*Math.max(1,Math.abs(s),Math.abs(r))&&Math.abs(i-n)<=EPSILON*Math.max(1,Math.abs(i),Math.abs(n))};setMatrixArrayType=e,toRadian=t,equals$9=n,create$8=h,clone$8=u,copy$8=p,identity$5=_,fromValues$8=m,set$8=g,transpose$2=y,invert$5=S,adjoint$2=T,determinant$3=x,multiply$8=b,rotate$4=G,scale$8=I,fromRotation$4=v,fromScaling$3=C,str$8=w,frob$3=A,LDU=R,add$8=P,subtract$6=M,exactEquals$8=E,equals$8=D,multiplyScalar$3=N,multiplyScalarAndAdd$3=F,create$7=O,clone$7=B,copy$7=L,identity$4=k,fromValues$7=V,set$7=U,invert$4=W,determinant$2=H,multiply$7=z,rotate$3=j,scale$7=Y,translate$3=q,fromRotation$3=X,fromScaling$2=$,fromTranslation$3=K,str$7=J,frob$2=Q,add$7=Z,subtract$5=ee,multiplyScalar$2=te,multiplyScalarAndAdd$2=se,exactEquals$7=ie,equals$7=re,create$6=ne,fromMat4$1=ae,clone$6=oe,copy$6=le,fromValues$6=he,set$6=ue,identity$3=ce,transpose$1=de,invert$3=pe,adjoint$1=_e,determinant$1=me,multiply$6=fe,translate$2=ge,rotate$2=ye,scale$6=Se,fromTranslation$2=Te,fromRotation$2=xe,fromScaling$1=be,fromMat2d=Ge,fromQuat$1=Ie,normalFromMat4=ve,projection=Ce,str$6=we,frob$1=Ae,add$6=Re,subtract$4=Pe,multiplyScalar$1=Me,multiplyScalarAndAdd$1=Ee,exactEquals$6=De,equals$6=Ne,create$5=Fe,clone$5=Oe,copy$5=Be,fromValues$5=Le,set$5=ke,identity$2=Ve,transpose=Ue,invert$2=We,adjoint=He,determinant=ze,multiply$5=je,translate$1=Ye,scale$5=qe,rotate$1=Xe,rotateX$3=$e,rotateY$3=Ke,rotateZ$3=Je,fromTranslation$1=Qe,fromScaling=Ze,fromRotation$1=et,fromXRotation=tt,fromYRotation=st,fromZRotation=it,fromRotationTranslation$1=rt,fromQuat2=nt,getTranslation$1=at,getScaling=ot,getRotation=lt,decompose=ht,fromRotationTranslationScale=ut,fromRotationTranslationScaleOrigin=ct,fromQuat=dt,frustum=pt,perspectiveNO=_t,perspectiveZO=mt,perspectiveFromFieldOfView=ft,orthoNO=gt,orthoZO=yt,lookAt=St,targetTo=Tt,str$5=xt,frob=bt,add$5=Gt,subtract$3=It,multiplyScalar=vt,multiplyScalarAndAdd=Ct,exactEquals$5=wt,equals$5=At,create$4=Rt,clone$4=Pt,length$4=Mt,fromValues$4=Et,copy$4=Dt,set$4=Nt,add$4=Ft,subtract$2=Ot,multiply$4=Bt,divide$2=Lt,ceil$2=kt,floor$2=Vt,min$2=Ut,max$2=Wt,round$2=Ht,scale$4=zt,scaleAndAdd$2=jt,distance$2=Yt,squaredDistance$2=qt,squaredLength$4=Xt,negate$2=$t,inverse$2=Kt,normalize$4=Jt,dot$4=Qt,cross$2=Zt,lerp$4=es,slerp$1=ts,hermite=ss,bezier=is,random$3=rs,transformMat4$2=ns,transformMat3$1=as,transformQuat$1=os,rotateX$2=ls,rotateY$2=hs,rotateZ$2=us,angle$1=cs,zero$2=ds,str$4=ps,exactEquals$4=_s,equals$4=ms,create$3=fs,clone$3=gs,fromValues$3=ys,copy$3=Ss,set$3=Ts,add$3=xs,subtract$1=bs,multiply$3=Gs,divide$1=Is,ceil$1=vs,floor$1=Cs,min$1=ws,max$1=As,round$1=Rs,scale$3=Ps,scaleAndAdd$1=Ms,distance$1=Es,squaredDistance$1=Ds,length$3=Ns,squaredLength$3=Fs,negate$1=Os,inverse$1=Bs,normalize$3=Ls,dot$3=ks,cross$1=Vs,lerp$3=Us,random$2=Ws,transformMat4$1=Hs,transformQuat=zs,zero$1=js,str$3=Ys,exactEquals$3=qs,equals$3=Xs,create$2=$s,identity$1=Ks,setAxisAngle=Js,getAxisAngle=Qs,getAngle=Zs,multiply$2=ei,rotateX$1=ti,rotateY$1=si,rotateZ$1=ii,calculateW=ri,exp=ni,ln=ai,pow=oi,slerp=li,random$1=hi,invert$1=ui,conjugate$1=ci,fromMat3=di,fromEuler=pi,str$2=_i,equals$2=mi,create$1=fi,clone$1=gi,fromValues$1=yi,fromRotationTranslationValues=Si,fromRotationTranslation=Ti,fromTranslation=xi,fromRotation=bi,fromMat4=Gi,copy$1=Ii,identity=vi,set$1=Ci,getDual=wi,setDual=Ai,getTranslation=Ri,translate=Pi,rotateX=Mi,rotateY=Ei,rotateZ=Di,rotateByQuatAppend=Ni,rotateByQuatPrepend=Fi,rotateAroundAxis=Oi,add$1=Bi,multiply$1=Li,scale$1=ki,lerp$1=Vi,invert=Ui,conjugate=Wi,normalize$1=Hi,str$1=zi,exactEquals$1=ji,equals$1=Yi,create=qi,clone=Xi,fromValues=$i,copy=Ki,set=Ji,add=Qi,subtract=Zi,multiply=er,divide=tr,ceil=sr,floor=ir,min=rr,max=nr,round=ar,scale=lr,scaleAndAdd=hr,distance=ur,squaredDistance=cr,length=dr,squaredLength=pr,negate=_r,inverse=mr,normalize=fr,dot=gr,cross=yr,lerp=Sr,random=Tr,transformMat2=xr,transformMat2d=br,transformMat3=Gr,transformMat4=Ir,rotate=vr,angle=Cr,zero=wr,str=Ar,exactEquals=Rr,equals=Pr,EPSILON=1e-6,ARRAY_TYPE="undefined"!=typeof Float32Array?Float32Array:Array,RANDOM=Math.random,ANGLE_ORDER="zyx",degree=Math.PI/180,Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)}),common={__proto__:null,EPSILON:EPSILON,get ARRAY_TYPE(){return ARRAY_TYPE},RANDOM:RANDOM,ANGLE_ORDER:ANGLE_ORDER,setMatrixArrayType:e,toRadian:t,equals:n},mul$8=b,sub$6=M,mat2=Object.freeze({__proto__:null,create:h,clone:u,copy:p,identity:_,fromValues:m,set:g,transpose:y,invert:S,adjoint:T,determinant:x,multiply:b,rotate:G,scale:I,fromRotation:v,fromScaling:C,str:w,frob:A,LDU:R,add:P,subtract:M,exactEquals:E,equals:D,multiplyScalar:N,multiplyScalarAndAdd:F,mul:mul$8,sub:sub$6}),mul$7=z,sub$5=ee,mat2d=Object.freeze({__proto__:null,create:O,clone:B,copy:L,identity:k,fromValues:V,set:U,invert:W,determinant:H,multiply:z,rotate:j,scale:Y,translate:q,fromRotation:X,fromScaling:$,fromTranslation:K,str:J,frob:Q,add:Z,subtract:ee,multiplyScalar:te,multiplyScalarAndAdd:se,exactEquals:ie,equals:re,mul:mul$7,sub:sub$5}),mul$6=fe,sub$4=Pe,mat3=Object.freeze({__proto__:null,create:ne,fromMat4:ae,clone:oe,copy:le,fromValues:he,set:ue,identity:ce,transpose:de,invert:pe,adjoint:_e,determinant:me,multiply:fe,translate:ge,rotate:ye,scale:Se,fromTranslation:Te,fromRotation:xe,fromScaling:be,fromMat2d:Ge,fromQuat:Ie,normalFromMat4:ve,projection:Ce,str:we,frob:Ae,add:Re,subtract:Pe,multiplyScalar:Me,multiplyScalarAndAdd:Ee,exactEquals:De,equals:Ne,mul:mul$6,sub:sub$4}),perspective=_t,ortho=gt,mul$5=je,sub$3=It,mat4=Object.freeze({__proto__:null,create:Fe,clone:Oe,copy:Be,fromValues:Le,set:ke,identity:Ve,transpose:Ue,invert:We,adjoint:He,determinant:ze,multiply:je,translate:Ye,scale:qe,rotate:Xe,rotateX:$e,rotateY:Ke,rotateZ:Je,fromTranslation:Qe,fromScaling:Ze,fromRotation:et,fromXRotation:tt,fromYRotation:st,fromZRotation:it,fromRotationTranslation:rt,fromQuat2:nt,getTranslation:at,getScaling:ot,getRotation:lt,decompose:ht,fromRotationTranslationScale:ut,fromRotationTranslationScaleOrigin:ct,fromQuat:dt,frustum:pt,perspectiveNO:_t,perspective:perspective,perspectiveZO:mt,perspectiveFromFieldOfView:ft,orthoNO:gt,ortho:ortho,orthoZO:yt,lookAt:St,targetTo:Tt,str:xt,frob:bt,add:Gt,subtract:It,multiplyScalar:vt,multiplyScalarAndAdd:Ct,exactEquals:wt,equals:At,mul:mul$5,sub:sub$3}),sub$2=Ot,mul$4=Bt,div$2=Lt,dist$2=Yt,sqrDist$2=qt,len$4=Mt,sqrLen$4=Xt,t2=Rt(),forEach$2=function(e,t,s,i,r,n){var a,o;for(t||(t=3),s||(s=0),o=i?Math.min(i*t+s,e.length):e.length,a=s;a<o;a+=t)t2[0]=e[a],t2[1]=e[a+1],t2[2]=e[a+2],r(t2,t2,n),e[a]=t2[0],e[a+1]=t2[1],e[a+2]=t2[2];return e},vec3=Object.freeze({__proto__:null,create:Rt,clone:Pt,length:Mt,fromValues:Et,copy:Dt,set:Nt,add:Ft,subtract:Ot,multiply:Bt,divide:Lt,ceil:kt,floor:Vt,min:Ut,max:Wt,round:Ht,scale:zt,scaleAndAdd:jt,distance:Yt,squaredDistance:qt,squaredLength:Xt,negate:$t,inverse:Kt,normalize:Jt,dot:Qt,cross:Zt,lerp:es,slerp:ts,hermite:ss,bezier:is,random:rs,transformMat4:ns,transformMat3:as,transformQuat:os,rotateX:ls,rotateY:hs,rotateZ:us,angle:cs,zero:ds,str:ps,exactEquals:_s,equals:ms,sub:sub$2,mul:mul$4,div:div$2,dist:dist$2,sqrDist:sqrDist$2,len:len$4,sqrLen:sqrLen$4,forEach:forEach$2}),sub$1=bs,mul$3=Gs,div$1=Is,dist$1=Es,sqrDist$1=Ds,len$3=Ns,sqrLen$3=Fs,forEach$1=function(){var e=fs();return function(t,s,i,r,n,a){var o,l;for(s||(s=4),i||(i=0),l=r?Math.min(r*s+i,t.length):t.length,o=i;o<l;o+=s)e[0]=t[o],e[1]=t[o+1],e[2]=t[o+2],e[3]=t[o+3],n(e,e,a),t[o]=e[0],t[o+1]=e[1],t[o+2]=e[2],t[o+3]=e[3];return t}}(),vec4=Object.freeze({__proto__:null,create:fs,clone:gs,fromValues:ys,copy:Ss,set:Ts,add:xs,subtract:bs,multiply:Gs,divide:Is,ceil:vs,floor:Cs,min:ws,max:As,round:Rs,scale:Ps,scaleAndAdd:Ms,distance:Es,squaredDistance:Ds,length:Ns,squaredLength:Fs,negate:Os,inverse:Bs,normalize:Ls,dot:ks,cross:Vs,lerp:Us,random:Ws,transformMat4:Hs,transformQuat:zs,zero:js,str:Ys,exactEquals:qs,equals:Xs,sub:sub$1,mul:mul$3,div:div$1,dist:dist$1,sqrDist:sqrDist$1,len:len$3,sqrLen:sqrLen$3,forEach:forEach$1}),clone$2=gs,fromValues$2=ys,copy$2=Ss,set$2=Ts,add$2=xs,mul$2=ei,scale$2=Ps,dot$2=ks,lerp$2=Us,length$2=Ns,len$2=length$2,squaredLength$2=Fs,sqrLen$2=squaredLength$2,normalize$2=Ls,exactEquals$2=qs,rotationTo=function(){var e=Rt(),t=Et(1,0,0),s=Et(0,1,0);return function(i,r,n){var a=Qt(r,n);return a<-.999999?(Zt(e,t,r),len$4(e)<1e-6&&Zt(e,s,r),Jt(e,e),Js(i,e,Math.PI),i):a>.999999?(i[0]=0,i[1]=0,i[2]=0,i[3]=1,i):(Zt(e,r,n),i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=1+a,normalize$2(i,i))}}(),sqlerp=function(){var e=$s(),t=$s();return function(s,i,r,n,a,o){return li(e,i,a,o),li(t,r,n,o),li(s,e,t,2*o*(1-o)),s}}(),setAxes=function(){var e=ne();return function(t,s,i,r){return e[0]=i[0],e[3]=i[1],e[6]=i[2],e[1]=r[0],e[4]=r[1],e[7]=r[2],e[2]=-s[0],e[5]=-s[1],e[8]=-s[2],normalize$2(t,di(t,e))}}(),quat=Object.freeze({__proto__:null,create:$s,identity:Ks,setAxisAngle:Js,getAxisAngle:Qs,getAngle:Zs,multiply:ei,rotateX:ti,rotateY:si,rotateZ:ii,calculateW:ri,exp:ni,ln:ai,pow:oi,slerp:li,random:hi,invert:ui,conjugate:ci,fromMat3:di,fromEuler:pi,str:_i,clone:clone$2,fromValues:fromValues$2,copy:copy$2,set:set$2,add:add$2,mul:mul$2,scale:scale$2,dot:dot$2,lerp:lerp$2,length:length$2,len:len$2,squaredLength:squaredLength$2,sqrLen:sqrLen$2,normalize:normalize$2,exactEquals:exactEquals$2,equals:mi,rotationTo:rotationTo,sqlerp:sqlerp,setAxes:setAxes}),getReal=copy$2,setReal=copy$2,mul$1=Li,dot$1=dot$2,length$1=length$2,len$1=length$1,squaredLength$1=squaredLength$2,sqrLen$1=squaredLength$1,quat2=Object.freeze({__proto__:null,create:fi,clone:gi,fromValues:yi,fromRotationTranslationValues:Si,fromRotationTranslation:Ti,fromTranslation:xi,fromRotation:bi,fromMat4:Gi,copy:Ii,identity:vi,set:Ci,getReal:getReal,getDual:wi,setReal:setReal,setDual:Ai,getTranslation:Ri,translate:Pi,rotateX:Mi,rotateY:Ei,rotateZ:Di,rotateByQuatAppend:Ni,rotateByQuatPrepend:Fi,rotateAroundAxis:Oi,add:Bi,multiply:Li,mul:mul$1,scale:ki,dot:dot$1,lerp:Vi,invert:Ui,conjugate:Wi,length:length$1,len:len$1,squaredLength:squaredLength$1,sqrLen:sqrLen$1,normalize:Hi,str:zi,exactEquals:ji,equals:Yi}),len=dr,sub=Zi,mul=er,div=tr,dist=ur,sqrDist=cr,sqrLen=pr,forEach=function(){var e=qi();return function(t,s,i,r,n,a){var o,l;for(s||(s=2),i||(i=0),l=r?Math.min(r*s+i,t.length):t.length,o=i;o<l;o+=s)e[0]=t[o],e[1]=t[o+1],n(e,e,a),t[o]=e[0],t[o+1]=e[1];return t}}(),vec2=Object.freeze({__proto__:null,create:qi,clone:Xi,fromValues:$i,copy:Ki,set:Ji,add:Qi,subtract:Zi,multiply:er,divide:tr,ceil:sr,floor:ir,min:rr,max:nr,round:ar,scale:lr,scaleAndAdd:hr,distance:ur,squaredDistance:cr,length:dr,squaredLength:pr,negate:_r,inverse:mr,normalize:fr,dot:gr,cross:yr,lerp:Sr,random:Tr,transformMat2:xr,transformMat2d:br,transformMat3:Gr,transformMat4:Ir,rotate:vr,angle:Cr,zero:wr,str:Ar,exactEquals:Rr,equals:Pr,len:len,sub:sub,mul:mul,div:div,dist:dist,sqrDist:sqrDist,sqrLen:sqrLen,forEach:forEach}),globalThis.glMatrix=common,globalThis.glMatrix.mat2=mat2,globalThis.glMatrix.mat2d=mat2d,globalThis.glMatrix.mat3=mat3,globalThis.glMatrix.mat4=mat4,globalThis.glMatrix.quat=quat,globalThis.glMatrix.quat2=quat2,globalThis.glMatrix.vec2=vec2,globalThis.glMatrix.vec3=vec3,globalThis.glMatrix.vec4=vec4}var t2,EPSILON,ARRAY_TYPE,RANDOM,ANGLE_ORDER,degree,common,mul$8,sub$6,mat2,mul$7,sub$5,mat2d,mul$6,sub$4,mat3,perspective,ortho,mul$5,sub$3,mat4,sub$2,mul$4,div$2,dist$2,sqrDist$2,len$4,sqrLen$4,forEach$2,vec3,sub$1,mul$3,div$1,dist$1,sqrDist$1,len$3,sqrLen$3,forEach$1,vec4,clone$2,fromValues$2,copy$2,set$2,add$2,mul$2,scale$2,dot$2,lerp$2,length$2,len$2,squaredLength$2,sqrLen$2,normalize$2,exactEquals$2,rotationTo,sqlerp,setAxes,quat,getReal,setReal,mul$1,dot$1,length$1,len$1,squaredLength$1,sqrLen$1,quat2,len,sub,mul,div,dist,sqrDist,sqrLen,forEach,vec2,setMatrixArrayType,toRadian,equals$9,create$8,clone$8,copy$8,identity$5,fromValues$8,set$8,transpose$2,invert$5,adjoint$2,determinant$3,multiply$8,rotate$4,scale$8,fromRotation$4,fromScaling$3,str$8,frob$3,LDU,add$8,subtract$6,exactEquals$8,equals$8,multiplyScalar$3,multiplyScalarAndAdd$3,create$7,clone$7,copy$7,identity$4,fromValues$7,set$7,invert$4,determinant$2,multiply$7,rotate$3,scale$7,translate$3,fromRotation$3,fromScaling$2,fromTranslation$3,str$7,frob$2,add$7,subtract$5,multiplyScalar$2,multiplyScalarAndAdd$2,exactEquals$7,equals$7,create$6,fromMat4$1,clone$6,copy$6,fromValues$6,set$6,identity$3,transpose$1,invert$3,adjoint$1,determinant$1,multiply$6,translate$2,rotate$2,scale$6,fromTranslation$2,fromRotation$2,fromScaling$1,fromMat2d,fromQuat$1,normalFromMat4,projection,str$6,frob$1,add$6,subtract$4,multiplyScalar$1,multiplyScalarAndAdd$1,exactEquals$6,equals$6,create$5,clone$5,copy$5,fromValues$5,set$5,identity$2,transpose,invert$2,adjoint,determinant,multiply$5,translate$1,scale$5,rotate$1,rotateX$3,rotateY$3,rotateZ$3,fromTranslation$1,fromScaling,fromRotation$1,fromXRotation,fromYRotation,fromZRotation,fromRotationTranslation$1,fromQuat2,getTranslation$1,getScaling,getRotation,decompose,fromRotationTranslationScale,fromRotationTranslationScaleOrigin,fromQuat,frustum,perspectiveNO,perspectiveZO,perspectiveFromFieldOfView,orthoNO,orthoZO,lookAt,targetTo,str$5,frob,add$5,subtract$3,multiplyScalar,multiplyScalarAndAdd,exactEquals$5,equals$5,create$4,clone$4,length$4,fromValues$4,copy$4,set$4,add$4,subtract$2,multiply$4,divide$2,ceil$2,floor$2,min$2,max$2,round$2,scale$4,scaleAndAdd$2,distance$2,squaredDistance$2,squaredLength$4,negate$2,inverse$2,normalize$4,dot$4,cross$2,lerp$4,slerp$1,hermite,bezier,random$3,transformMat4$2,transformMat3$1,transformQuat$1,rotateX$2,rotateY$2,rotateZ$2,angle$1,zero$2,str$4,exactEquals$4,equals$4,create$3,clone$3,fromValues$3,copy$3,set$3,add$3,subtract$1,multiply$3,divide$1,ceil$1,floor$1,min$1,max$1,round$1,scale$3,scaleAndAdd$1,distance$1,squaredDistance$1,length$3,squaredLength$3,negate$1,inverse$1,normalize$3,dot$3,cross$1,lerp$3,random$2,transformMat4$1,transformQuat,zero$1,str$3,exactEquals$3,equals$3,create$2,identity$1,setAxisAngle,getAxisAngle,getAngle,multiply$2,rotateX$1,rotateY$1,rotateZ$1,calculateW,exp,ln,pow,slerp,random$1,invert$1,conjugate$1,fromMat3,fromEuler,str$2,equals$2,create$1,clone$1,fromValues$1,fromRotationTranslationValues,fromRotationTranslation,fromTranslation,fromRotation,fromMat4,copy$1,identity,set$1,getDual,setDual,getTranslation,translate,rotateX,rotateY,rotateZ,rotateByQuatAppend,rotateByQuatPrepend,rotateAroundAxis,add$1,multiply$1,scale$1,lerp$1,invert,conjugate,normalize$1,str$1,exactEquals$1,equals$1,create,clone,fromValues,copy,set,add,subtract,multiply,divide,ceil,floor,min,max,round,scale,scaleAndAdd,distance,squaredDistance,length,squaredLength,negate,inverse,normalize,dot,cross,lerp,random,transformMat2,transformMat2d,transformMat3,transformMat4,rotate,angle,zero,str,exactEquals,equals,tmpPoint1,tmpPoint2,tmpLine1,tmpLine2,lineInt,lineSegmentsIntersect,triangleArea,isLeft,isLeftOn,isRight,isRightOn,collinear,sqdist,polygonAt,polygonClear,polygonAppend,polygonMakeCCW,polygonReverse,polygonIsReflex,polygonCanSee,polygonCanSee2,polygonCopy,polygonGetCutEdges,polygonDecomp,polygonSlice,polygonIsSimple,getIntersectionPoint,polygonQuickDecomp,polygonRemoveCollinearPoints,polygonRemoveDuplicatePoints,scalar_eq,points_eq,ReadBrandList,RunTest,GetWindowsNTVersionName,s,a,c,i,l,f,d,r,a,o,arrayFlat,assertFail,isValidTypeChange,logDefendedObjectWarning,CheckDefendedObjectsUsedCorrectly,getObjectPropertySet,VerifyObjectPropertiesConsistent,isNegativeZero,padTwoDigits,hueToRGB,RequireStringOrNumber,SetNewCallback,DoAsyncifiedWork,DoNextAsyncifiedJob,ClearTimeCache,CheckActiveIdleTimeouts,lookupHtmlEntity,bbToHtmlReplacerFunc,IsWordBreakWhiteSpace,IsOpeningCJKPunctiationChar,IsContinuingCJKPunctuationChar,WordBreakTrimEnd,IsNewline,PlaneFromPoints,IsInFrontOfPlane,IsPointInFrontOfPlane,interpolateQuad,GetFormatSpecifiers,fillOrStrokeRect,ptToPx,getOffsetParam,CheckPendingPolls,UpdateLayoutEndValues,makeNullFilledArray,GetFragmentInputStructDeclaration,HashPipelineState,SortZOrderList,GetDispatcher,MakeIWorldInstanceClass,GetDispatcher,GetTimelineState,GetTimelineState,GetTweenState,IsStaticTextureDataType,getActual,GetTypeFromFileExtension,AddScript,SortByInstLastCachedZIndex,SortByInstLastCachedZIndex,SortByInstZElevation,vec3EqualsXYZ,MaybePrepareLayerDraw,SortSolArray,IsSolArrayIdentical,NoActions,WrapIndex,GetExpressionFunc,EvalParams,EvalParams,GetInst,GetWorldInfo,GetInst_SDKv2,GetWorldInfo_SDKv2,GetObjectClass,GetLayer,CollMemory_Add,CollMemory_Remove,CollMemory_RemoveInstance,CollMemory_Get,DoOverlapCondition,FinishCollisionConditionPicking,FinishCollisionCondition,PickByUID_Normal,PickByUID_Inverted,GetNextParamMap,ValidateInternalAPIToken,ForEachOrdered_SortInstances,SortZOrderList,SortInstancesByValue,ResizeArray,DoForEachTrigger,CompareValues,GetKeyboardSdkInstance,StringFromCharCode,GetSdkInstance,shuffle,pickGradient2,pickGradient3,dot2,dot3,quintic,fract,sq,swap,uint64,splitmix64,rotl,next,nextFloat,GetMouseSdkInstance,MaybeCloseImageBitmap,GetAudioSdkInstance,GetAudioDOMInterface,WrapModeToStr,CloneDrawable,getIndexForEase,ValidateTags,unaryminus,bothNumbers,add,subtract,multiply,divide,mod,pow,and,or;{let Mr=function(e,t,s){s=s||0;var i,r,n,a,o,l,h,u=[0,0];return i=e[1][1]-e[0][1],r=e[0][0]-e[1][0],n=i*e[0][0]+r*e[0][1],a=t[1][1]-t[0][1],o=t[0][0]-t[1][0],l=a*t[0][0]+o*t[0][1],rn(h=i*o-a*r,0,s)||(u[0]=(o*n-r*l)/h,u[1]=(i*l-a*n)/h),u},Er=function(e,t,s,i){var r=t[0]-e[0],n=t[1]-e[1],a=i[0]-s[0],o=i[1]-s[1];if(a*n-o*r===0)return!1;var l=(r*(s[1]-e[1])+n*(e[0]-s[0]))/(a*n-o*r),h=(a*(e[1]-s[1])+o*(s[0]-e[0]))/(o*r-a*n);return l>=0&&l<=1&&h>=0&&h<=1},Dr=function(e,t,s){return(t[0]-e[0])*(s[1]-e[1])-(s[0]-e[0])*(t[1]-e[1])},Nr=function(e,t,s){return Dr(e,t,s)>0},Fr=function(e,t,s){return Dr(e,t,s)>=0},Or=function(e,t,s){return Dr(e,t,s)<0},Br=function(e,t,s){return Dr(e,t,s)<=0},Lr=function(e,t,s,i){if(i){var r=tmpPoint1,n=tmpPoint2;r[0]=t[0]-e[0],r[1]=t[1]-e[1],n[0]=s[0]-t[0],n[1]=s[1]-t[1];var a=r[0]*n[0]+r[1]*n[1],o=Math.sqrt(r[0]*r[0]+r[1]*r[1]),l=Math.sqrt(n[0]*n[0]+n[1]*n[1]);return Math.acos(a/(o*l))<i}return 0===Dr(e,t,s)},kr=function(e,t){var s=t[0]-e[0],i=t[1]-e[1];return s*s+i*i},Vr=function(e,t){var s=e.length;return e[t<0?t%s+s:t%s]},Ur=function(e){e.length=0},Wr=function(e,t,s,i){for(var r=s;r<i;r++)e.push(t[r])},Hr=function(e){for(var t=0,s=e,i=1;i<e.length;++i)(s[i][1]<s[t][1]||s[i][1]===s[t][1]&&s[i][0]>s[t][0])&&(t=i);return!Nr(Vr(e,t-1),Vr(e,t),Vr(e,t+1))&&(zr(e),!0)},zr=function(e){for(var t=[],s=e.length,i=0;i!==s;i++)t.push(e.pop());for(i=0;i!==s;i++)e[i]=t[i]},jr=function(e,t){return Or(Vr(e,t-1),Vr(e,t),Vr(e,t+1))},Yr=function(e,t,s){var i,r,n=tmpLine1,a=tmpLine2;if(Fr(Vr(e,t+1),Vr(e,t),Vr(e,s))&&Br(Vr(e,t-1),Vr(e,t),Vr(e,s)))return!1;r=kr(Vr(e,t),Vr(e,s));for(var o=0;o!==e.length;++o)if((o+1)%e.length!==t&&o!==t&&Fr(Vr(e,t),Vr(e,s),Vr(e,o+1))&&Br(Vr(e,t),Vr(e,s),Vr(e,o))&&(n[0]=Vr(e,t),n[1]=Vr(e,s),a[0]=Vr(e,o),a[1]=Vr(e,o+1),i=Mr(n,a),kr(Vr(e,t),i)<r))return!1;return!0},qr=function(e,t,s){for(var i=0;i!==e.length;++i)if(i!==t&&i!==s&&(i+1)%e.length!==t&&(i+1)%e.length!==s&&Er(Vr(e,t),Vr(e,s),Vr(e,i),Vr(e,i+1)))return!1;return!0},Xr=function(e,t,s,i){var r=i||[];if(Ur(r),t<s)for(var n=t;n<=s;n++)r.push(e[n]);else{for(n=0;n<=s;n++)r.push(e[n]);for(n=t;n<e.length;n++)r.push(e[n])}return r},$r=function(e){for(var t=[],s=[],i=[],r=[],n=Number.MAX_VALUE,a=0;a<e.length;++a)if(jr(e,a))for(var o=0;o<e.length;++o)if(Yr(e,a,o)){s=$r(Xr(e,a,o,r)),i=$r(Xr(e,o,a,r));for(var l=0;l<i.length;l++)s.push(i[l]);s.length<n&&(t=s,n=s.length,t.push([Vr(e,a),Vr(e,o)]))}return t},Kr=function(e){var t=$r(e);return t.length>0?Jr(e,t):[e]},Jr=function(e,t){if(0===t.length)return[e];if(t instanceof Array&&t.length&&t[0]instanceof Array&&2===t[0].length&&t[0][0]instanceof Array){for(var s=[e],i=0;i<t.length;i++)for(var r=t[i],n=0;n<s.length;n++){var a=Jr(s[n],r);if(a){s.splice(n,1),s.push(a[0],a[1]);break}}return s}return r=t,i=e.indexOf(r[0]),n=e.indexOf(r[1]),-1!==i&&-1!==n&&[Xr(e,i,n),Xr(e,n,i)]},Qr=function(e){var t,s=e;for(t=0;t<s.length-1;t++)for(var i=0;i<t-1;i++)if(Er(s[t],s[t+1],s[i],s[i+1]))return!1;for(t=1;t<s.length-2;t++)if(Er(s[0],s[s.length-1],s[t],s[t+1]))return!1;return!0},Zr=function(e,t,s,i,r){r=r||0;var n=t[1]-e[1],a=e[0]-t[0],o=n*e[0]+a*e[1],l=i[1]-s[1],h=s[0]-i[0],u=l*s[0]+h*s[1],c=n*h-l*a;return rn(c,0,r)?[0,0]:[(h*o-a*u)/c,(n*u-l*o)/c]},en=function(e,t,s,i,r,n,a){n=n||100,a=a||0,r=r||25,t=void 0!==t?t:[],s=s||[],i=i||[];var o=[0,0],l=[0,0],h=[0,0],u=0,c=0,d=0,p=0,_=0,m=0,f=0,g=[],y=[],S=e,T=e;if(T.length<3)return t;if(++a>n)return console.warn("quickDecomp: max level ("+n+") reached."),t;for(var x=0;x<e.length;++x)if(jr(S,x)){s.push(S[x]),u=c=Number.MAX_VALUE;for(var b=0;b<e.length;++b)Nr(Vr(S,x-1),Vr(S,x),Vr(S,b))&&Br(Vr(S,x-1),Vr(S,x),Vr(S,b-1))&&(h=Zr(Vr(S,x-1),Vr(S,x),Vr(S,b),Vr(S,b-1)),Or(Vr(S,x+1),Vr(S,x),h)&&(d=kr(S[x],h))<c&&(c=d,l=h,m=b)),Nr(Vr(S,x+1),Vr(S,x),Vr(S,b+1))&&Br(Vr(S,x+1),Vr(S,x),Vr(S,b))&&(h=Zr(Vr(S,x+1),Vr(S,x),Vr(S,b),Vr(S,b+1)),Nr(Vr(S,x-1),Vr(S,x),h)&&(d=kr(S[x],h))<u&&(u=d,o=h,_=b));if(m===(_+1)%e.length)h[0]=(l[0]+o[0])/2,h[1]=(l[1]+o[1])/2,i.push(h),x<_?(Wr(g,S,x,_+1),g.push(h),y.push(h),0!==m&&Wr(y,S,m,S.length),Wr(y,S,0,x+1)):(0!==x&&Wr(g,S,x,S.length),Wr(g,S,0,_+1),g.push(h),y.push(h),Wr(y,S,m,x+1));else{if(m>_&&(_+=e.length),p=Number.MAX_VALUE,_<m)return t;for(b=m;b<=_;++b)Fr(Vr(S,x-1),Vr(S,x),Vr(S,b))&&Br(Vr(S,x+1),Vr(S,x),Vr(S,b))&&(d=kr(Vr(S,x),Vr(S,b)))<p&&qr(S,x,b)&&(p=d,f=b%e.length);x<f?(Wr(g,S,x,f+1),0!==f&&Wr(y,S,f,T.length),Wr(y,S,0,x+1)):(0!==x&&Wr(g,S,x,T.length),Wr(g,S,0,f+1),Wr(y,S,f,x+1))}return g.length<y.length?(en(g,t,s,i,r,n,a),en(y,t,s,i,r,n,a)):(en(y,t,s,i,r,n,a),en(g,t,s,i,r,n,a)),t}return t.push(e),t},tn=function(e,t){for(var s=0,i=e.length-1;e.length>3&&i>=0;--i)Lr(Vr(e,i-1),Vr(e,i),Vr(e,i+1),t)&&(e.splice(i%e.length,1),s++);return s},sn=function(e,t){for(var s=e.length-1;s>=1;--s)for(var i=e[s],r=s-1;r>=0;--r)nn(i,e[r],t)&&e.splice(s,1)},rn=function(e,t,s){return s=s||0,Math.abs(e-t)<=s},nn=function(e,t,s){return rn(e[0],t[0],s)&&rn(e[1],t[1],s)};lineInt=Mr,lineSegmentsIntersect=Er,triangleArea=Dr,isLeft=Nr,isLeftOn=Fr,isRight=Or,isRightOn=Br,collinear=Lr,sqdist=kr,polygonAt=Vr,polygonClear=Ur,polygonAppend=Wr,polygonMakeCCW=Hr,polygonReverse=zr,polygonIsReflex=jr,polygonCanSee=Yr,polygonCanSee2=qr,polygonCopy=Xr,polygonGetCutEdges=$r,polygonDecomp=Kr,polygonSlice=Jr,polygonIsSimple=Qr,getIntersectionPoint=Zr,polygonQuickDecomp=en,polygonRemoveCollinearPoints=tn,polygonRemoveDuplicatePoints=sn,scalar_eq=rn,points_eq=nn,tmpPoint1=[],tmpPoint2=[],tmpLine1=[],tmpLine2=[],self.polyDecomp={decomp:Kr,quickDecomp:en,isSimple:Qr,removeCollinearPoints:tn,removeDuplicatePoints:sn,makeCCW:Hr}}{let an=!1,on=!1,hn="dev";const un=Symbol("Construct internal API token");let cn=16;const dn=self.C3=class{constructor(){throw TypeError("static class can't be instantiated")}static _GetInternalAPIToken(){if(cn<=0)throw new Error("cannot obtain internal API token");return--cn,un}static SetReady(){an=!0}static IsReady(){return an}static SetAppStarted(){on=!0}static HasAppStarted(){return on}static SetBuildMode(e){hn=e}static GetBuildMode(){return hn}static IsReleaseBuild(){return"final"===hn}};dn.isDebug=!1,dn.isDebugDefend=!1,dn.hardwareConcurrency=navigator.hardwareConcurrency||2,self.C3X={}}{const pn=self.C3;pn.QueryParser=class{constructor(e){this._queryString=e,this._parameters=new Map,this._Parse()}_Parse(){let e=this._queryString;(e.startsWith("?")||e.startsWith("#"))&&(e=e.substr(1));const t=e.split("&");for(const e of t)this._ParseParameter(e)}_ParseParameter(e){if(!e)return;if(!e.includes("="))return void this._parameters.set(e,null);const t=e.indexOf("="),s=decodeURIComponent(e.substring(0,t)),i=decodeURIComponent(e.substring(t+1));this._parameters.set(s,i)}LogAll(){for(const e of this._parameters)console.log("[QueryParser] Parameter '"+e[0]+"' = "+(null===e[1]?"null":"'"+e[1]+"'"))}Has(e){return this._parameters.has(e)}Get(e){const t=this._parameters.get(e);return void 0===t?null:t}ClearHash(){history.replaceState("",document.title,location.pathname+location.search)}Reparse(e){this._queryString=e,this._parameters.clear(),this._Parse()}},pn.QueryString=new pn.QueryParser(location.search),pn.LocationHashString=new pn.QueryParser(location.hash),pn.QueryString.Has("perf")&&(pn.isPerformanceProfiling=!0),"dev"!==pn.QueryString.Get("mode")&&pn.SetBuildMode("final")}{let _n=function(e){const t=parseFloat(e);return gn.get(t)||(t>=13?"11":"NT "+e)};GetWindowsNTVersionName=_n;const mn=self.C3,fn="(unknown)";mn.Platform={OS:fn,OSVersion:fn,Browser:fn,BrowserVersion:fn,BrowserVersionNumber:NaN,BrowserEngine:fn,Context:"browser",IsDesktop:!0,IsMobile:!1,IsAppleOS:!1,IsIpadOS:!1,GetDetailedInfo:async()=>{}};const gn=new Map([[5,"2000"],[5.1,"XP"],[5.2,"XP"],[6,"Vista"],[6.1,"7"],[6.2,"8"],[6.3,"8.1"],[10,"10"]]),yn=navigator.userAgent,Sn=navigator.userAgentData;if(Sn&&Sn.brands.length>0){let xn=function(e){let t="",s="",i="",r="";for(const n of e){const e=bn.get(n.brand);!t&&e&&(t=e,s=n.version);const a=Gn.get(n.brand);!i&&a&&(i=a,r=n.version)}t||"Chromium"!==i||(mn.Platform.Browser="Chromium",mn.Platform.BrowserVersion=r),mn.Platform.Browser=t||fn,mn.Platform.BrowserVersion=s||fn,mn.Platform.BrowserEngine=i||fn};ReadBrandList=xn,mn.Platform.OS=Sn.platform,mn.Platform.IsMobile=Sn.mobile,mn.Platform.IsDesktop=!mn.Platform.IsMobile;const bn=new Map([["Google Chrome","Chrome"],["Microsoft Edge","Edge"],["Opera","Opera"],["Opera GX","Opera GX"],["Mozilla Firefox","Firefox"],["Apple Safari","Safari"],["NW.js","NW.js"]]),Gn=new Map([["Chromium","Chromium"],["Gecko","Gecko"],["WebKit","WebKit"]]);xn(Sn.brands);let In=!1;mn.Platform.GetDetailedInfo=async()=>{if(!In)try{const e=await navigator.userAgentData.getHighEntropyValues(["platformVersion","fullVersionList"]);xn(e.fullVersionList),"Windows"===mn.Platform.OS?mn.Platform.OSVersion=_n(e.platformVersion):mn.Platform.OSVersion=e.platformVersion,In=!0}catch(e){console.warn("Failed to get detailed user agent information: ",e)}}}else{let vn=function(e,t){const s=Array.isArray(e)?e:[e];for(const e of s){const s=e.exec(yn);if(s){t(s);break}}};RunTest=vn,vn(/windows\s+nt\s+([\d\.]+)/i,e=>{mn.Platform.OS="Windows";const t=e[1];mn.Platform.OSVersion=_n(t)}),vn(/mac\s+os\s+x\s+([\d\._]+)/i,e=>{mn.Platform.OS="macOS",mn.Platform.OSVersion=e[1].replace(/_/g,".")}),vn(/CrOS/,()=>{mn.Platform.OS="Chrome OS"}),vn(/linux|openbsd|freebsd|netbsd/i,()=>{mn.Platform.OS="Linux"}),vn(/android/i,()=>{mn.Platform.OS="Android"}),vn(/android\s+([\d\.]+)/i,e=>{mn.Platform.OS="Android",mn.Platform.OSVersion=e[1]}),mn.Platform.OS===fn&&(vn(/(iphone|ipod|ipad)/i,e=>{mn.Platform.OS="iOS"}),vn([/iphone\s+os\s+([\d\._]+)/i,/ipad[^)]*os\s+([\d\._]+)/i],e=>{mn.Platform.OS="iOS",mn.Platform.OSVersion=e[1].replace(/_/g,".")}));const Cn=/chrome\//i.test(yn),wn=/chromium\//i.test(yn),An=/edg\//i.test(yn),Rn=/OPR\//.test(yn),Pn=/nwjs/i.test(yn),Mn=/safari\//i.test(yn),En=/webkit/i.test(yn);An||Rn||vn(/chrome\/([\d\.]+)/i,e=>{mn.Platform.Browser="Chrome",mn.Platform.BrowserVersion=e[1],mn.Platform.BrowserEngine="Chromium"}),vn(/edg\/([\d\.]+)/i,e=>{mn.Platform.Browser="Edge",mn.Platform.BrowserVersion=e[1],mn.Platform.BrowserEngine="Chromium"}),vn(/OPR\/([\d\.]+)/,e=>{mn.Platform.Browser="Opera",mn.Platform.BrowserVersion=e[1],mn.Platform.BrowserEngine="Chromium"}),vn(/chromium\/([\d\.]+)/i,e=>{mn.Platform.Browser="Chromium",mn.Platform.BrowserVersion=e[1],mn.Platform.BrowserEngine="Chromium"}),vn(/nwjs\/[0-9.]+/i,e=>{mn.Platform.Browser="NW.js",mn.Platform.BrowserVersion=e[1],mn.Platform.BrowserEngine="Chromium",mn.Platform.Context="nwjs"}),vn(/firefox\/([\d\.]+)/i,e=>{mn.Platform.Browser="Firefox",mn.Platform.BrowserVersion=e[1],mn.Platform.BrowserEngine="Gecko"}),!Mn||Cn||wn||An||Rn||Pn||(mn.Platform.Browser="Safari",mn.Platform.BrowserEngine="WebKit",vn(/version\/([\d\.]+)/i,e=>{mn.Platform.BrowserVersion=e[1]}),vn(/crios\/([\d\.]+)/i,e=>{mn.Platform.Browser="Chrome for iOS",mn.Platform.BrowserVersion=e[1]}),vn(/fxios\/([\d\.]+)/i,e=>{mn.Platform.Browser="Firefox for iOS",mn.Platform.BrowserVersion=e[1]}),vn(/edgios\/([\d\.]+)/i,e=>{mn.Platform.Browser="Edge for iOS",mn.Platform.BrowserVersion=e[1]})),mn.Platform.BrowserEngine===fn&&En&&(mn.Platform.BrowserEngine="WebKit"),"Android"===mn.Platform.OS&&"Safari"===mn.Platform.Browser&&(mn.Platform.Browser="Stock");const Dn=new Set(["Windows","macOS","Linux","Chrome OS"]).has(mn.Platform.OS)||"nwjs"===mn.Platform.Context;mn.Platform.IsDesktop=Dn,mn.Platform.IsMobile=!Dn}"Chrome"===mn.Platform.Browser&&"browser"===mn.Platform.Context&&/wv\)/.test(yn)&&(mn.Platform.Context="webview"),"nwjs"!==mn.Platform.Context&&"undefined"!=typeof window&&(window.matchMedia&&window.matchMedia("(display-mode: standalone)").matches||navigator.standalone)&&(mn.Platform.Context="webapp"),mn.Platform.BrowserVersionNumber=parseFloat(mn.Platform.BrowserVersion);const Tn="macOS"===mn.Platform.OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>2;Tn&&(mn.Platform.OS="iOS",mn.Platform.OSVersion=mn.Platform.BrowserVersion,mn.Platform.IsDesktop=!1,mn.Platform.IsMobile=!0,mn.Platform.IsIpadOS=!0),mn.Platform.IsAppleOS="macOS"===mn.Platform.OS||"iOS"===mn.Platform.OS}{let Nn=function(e){return new Promise((t,s)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>s(e.error)})},Fn=function(e){return new Promise((t,s)=>{e.oncomplete=()=>t(),e.onerror=()=>s(e.error),e.onabort=()=>s(e.error)})},On=function(e,t){return Yn(e,t)},Bn=function(e,t){return Yn(e,t,!0)},Ln=function(e){kn(e);let t=Hn.get(e);return t instanceof Promise||(t=qn(e),Hn.set(e,t),t.catch(t=>Hn.delete(e))),t},kn=function(e){if("string"!=typeof e)throw new TypeError("expected string")},Vn=function(e,t){const s=e.objectStore(Wn).openCursor();return new Promise(e=>{const i=[];s.onsuccess=s=>{const r=s.target.result;if(r){switch(t){case"entries":i.push([r.key,r.value]);break;case"keys":i.push(r.key);break;case"values":i.push(r.value)}r.continue()}else e(i)}})};s=Nn,a=Fn,c=On,i=Bn,l=Ln,f=kn,d=Vn;const Un=2,Wn="keyvaluepairs",Hn=new Map,zn="undefined"!=typeof IDBObjectStore&&"function"==typeof IDBObjectStore.prototype.getAll,jn="undefined"!=typeof IDBObjectStore&&"function"==typeof IDBObjectStore.prototype.getAllKeys;async function Yn(e,t,s=!1,i=!0){const r=await Ln(e);try{return t(r.transaction([Wn],s?"readwrite":"readonly"))}catch(r){if(i&&"InvalidStateError"===r.name)return Hn.delete(e),Yn(e,t,s,!1);throw r}}async function qn(e){kn(e);const t=indexedDB.open(e,Un);return t.addEventListener("upgradeneeded",t=>{try{t.target.result.createObjectStore(Wn)}catch(t){console.error(`Failed to create objectstore for database ${e}`,t)}}),Nn(t)}class Xn{constructor(e){kn(e),this.name=e}async ready(){await Ln(this.name)}set(e,t){return kn(e),Bn(this.name,async s=>{const i=Nn(s.objectStore(Wn).put(t,e)),r=Fn(s);await Promise.all([r,i])})}get(e){return kn(e),On(this.name,async t=>{const s=Nn(t.objectStore(Wn).get(e)),i=Fn(t),[r,n]=await Promise.all([i,s]);return n})}delete(e){return kn(e),Bn(this.name,async t=>{const s=Nn(t.objectStore(Wn).delete(e)),i=Fn(t);await Promise.all([i,s])})}clear(){return Bn(this.name,async e=>{const t=Nn(e.objectStore(Wn).clear()),s=Fn(e);await Promise.all([s,t])})}keys(){return On(this.name,async e=>{let t;t=jn?Nn(e.objectStore(Wn).getAllKeys()):Vn(e,"keys");const s=Fn(e),[i,r]=await Promise.all([s,t]);return r})}values(){return On(this.name,async e=>{let t;t=zn?Nn(e.objectStore(Wn).getAll()):Vn(e,"values");const s=Fn(e),[i,r]=await Promise.all([s,t]);return r})}entries(){return On(this.name,async e=>{const t=Vn(e,"entries"),s=Fn(e),[i,r]=await Promise.all([s,t]);return r})}}self.KVStorageContainer=Xn}{let $n=function(e){throw new Error(`"${e}" is not implemented`)},Kn=function(e){if("function"==typeof e)throw new Error("localforage callback API is not implemented; please use the promise API instead")},Jn=function(e){return"object"==typeof e?new Promise(t=>{const{port1:s,port2:i}=new MessageChannel;i.onmessage=e=>t(e.data),s.postMessage(e)}):Promise.resolve(e)};r=$n,a=Kn,o=Jn;const Qn=self.KVStorageContainer,Zn=[/no available storage method found/i,/an attempt was made to break through the security policy of the user agent/i,/the user denied permission to access the database/i,/a mutation operation was attempted on a database that did not allow mutations/i,/idbfactory\.open\(\) called in an invalid security context/i];class ea{constructor(e){this._inst=e,this._isInMemory=!this._inst,this._isInMemory||"undefined"!=typeof indexedDB||(this._isInMemory=!0,console.warn("Unable to use local storage because IndexedDB API is not available")),this._memoryStorage=new Map}_MaybeSwitchToMemoryFallback(e){if(!this._isInMemory)for(const t of Zn)if(e&&t.test(e.message)){console.error("Unable to use local storage, reverting to in-memory store: ",e,e.message),this._isInMemory=!0;break}}async _getItemFallback(e){const t=this._memoryStorage.get(e),s=await Jn(t);return void 0===s?null:s}async _setItemFallback(e,t){t=await Jn(t),this._memoryStorage.set(e,t)}_removeItemFallback(e){this._memoryStorage.delete(e)}_clearFallback(){this._memoryStorage.clear()}_keysFallback(){return Array.from(this._memoryStorage.keys())}IsInMemory(){return this._isInMemory}GetMemoryStorage(){return this._memoryStorage}SetMemoryStorage(e){this._memoryStorage=e}async getItem(e,t){if(Kn(t),this._isInMemory)return await this._getItemFallback(e);let s;try{s=await this._inst.get(e)}catch(t){return this._MaybeSwitchToMemoryFallback(t),this._isInMemory?await this._getItemFallback(e):(console.error(`Error reading '${e}' from storage, returning null: `,t),null)}return void 0===s?null:s}async setItem(e,t,s){if(Kn(s),void 0===t&&(t=null),this._isInMemory)await this._setItemFallback(e,t);else try{await this._inst.set(e,t)}catch(s){if(this._MaybeSwitchToMemoryFallback(s),!this._isInMemory)throw s;await this._setItemFallback(e,t)}}async removeItem(e,t){if(Kn(t),this._isInMemory)this._removeItemFallback(e);else try{await this._inst.delete(e)}catch(t){this._MaybeSwitchToMemoryFallback(t),this._isInMemory?this._removeItemFallback(e):console.error(`Error removing '${e}' from storage: `,t)}}async clear(e){if(Kn(e),this._isInMemory)this._clearFallback();else try{await this._inst.clear()}catch(e){this._MaybeSwitchToMemoryFallback(e),this._isInMemory?this._clearFallback():console.error("Error clearing storage: ",e)}}async keys(e){if(Kn(e),this._isInMemory)return this._keysFallback();let t=[];try{t=await this._inst.keys()}catch(e){if(this._MaybeSwitchToMemoryFallback(e),this._isInMemory)return this._keysFallback();console.error("Error getting storage keys: ",e)}return t}ready(e){return Kn(e),this._isInMemory?Promise.resolve(!0):this._inst.ready()}createInstance(e){if(e.forceInMemoryFallback)return new ea(null);{const t=e.name;if("string"!=typeof t)throw new TypeError("invalid store name");const s=new Qn(t);return new ea(s)}}length(e){$n("localforage.length()")}key(e,t){$n("localforage.key()")}iterate(e,t){$n("localforage.iterate()")}setDriver(e){$n("localforage.setDriver()")}config(e){$n("localforage.config()")}defineDriver(e){$n("localforage.defineDriver()")}driver(){$n("localforage.driver()")}supports(e){$n("localforage.supports()")}dropInstance(){$n("localforage.dropInstance()")}}self.localforage=new ea(new Qn("localforage"))}{const ta=self.C3;if(ta.Supports={},ta.Supports.WebAnimations=(()=>{try{if("undefined"==typeof document)return!1;const e=document.createElement("div");return void 0!==e.animate&&void 0!==e.animate([{opacity:"0"},{opacity:"1"}],1e3).reverse}catch(e){return!1}})(),ta.Supports.DialogElement="undefined"!=typeof HTMLDialogElement,ta.Supports.RequestIdleCallback=!!self.requestIdleCallback,ta.Supports.ImageBitmap=!!self.createImageBitmap,ta.Supports.ImageBitmapOptions=!1,ta.Supports.ImageBitmapOptionsResize=!1,ta.Supports.ImageBitmap){try{self.createImageBitmap(new ImageData(32,32),{premultiplyAlpha:"none"}).then(()=>{ta.Supports.ImageBitmapOptions=!0}).catch(()=>{ta.Supports.ImageBitmapOptions=!1})}catch(sa){ta.Supports.ImageBitmapOptions=!1}try{self.createImageBitmap(new ImageData(32,32),{resizeWidth:10,resizeHeight:10}).then(e=>{ta.Supports.ImageBitmapOptionsResize=10===e.width&&10===e.height}).catch(()=>{ta.Supports.ImageBitmapOptionsResize=!1})}catch(ia){ta.Supports.ImageBitmapOptionsResize=!1}}if(ta.Supports.ClipboardReadText=!(!navigator.clipboard||!navigator.clipboard.readText),ta.Supports.PermissionsQuery=!(!navigator.permissions||!navigator.permissions.query),ta.Supports.ClipboardPermissionsQuery=!1,ta.Supports.PermissionsQuery){const ra={name:"clipboard-read"};navigator.permissions.query(ra).then(()=>{ta.Supports.ClipboardPermissionsQuery=!0}).catch(()=>{ta.Supports.ClipboardPermissionsQuery=!1})}ta.Supports.AsyncClipboardApi=!!(navigator.permissions&&navigator.clipboard&&self.ClipboardItem),ta.Supports.Proxies="undefined"!=typeof Proxy,ta.Supports.DownloadAttribute="undefined"!=typeof document&&void 0!==document.createElement("a").download,ta.Supports.Fetch="function"==typeof fetch,ta.Supports.PersistentStorage=!!(self.isSecureContext&&"Opera"!==ta.Platform.Browser&&navigator.storage&&navigator.storage.persist),ta.Supports.StorageQuotaEstimate=!!(self.isSecureContext&&navigator.storage&&navigator.storage.estimate),ta.Supports.Fullscreen=(()=>{if("undefined"==typeof document)return!1;if("iOS"===ta.Platform.OS)return!1;const e=document.documentElement;return!!(e.requestFullscreen||e.msRequestFullscreen||e.mozRequestFullScreen||e.webkitRequestFullscreen)})(),ta.Supports.ImageDecoder=void 0!==self.ImageDecoder,ta.Supports.WebCodecs=!!self.VideoEncoder,ta.Supports.NativeFileSystemAPI=!!self.showOpenFilePicker,ta.Supports.QueryLocalFonts=!!self.queryLocalFonts,ta.Supports.UserActivation=!!navigator.userActivation,ta.Supports.CanvasToBlobWebP=!1,(async()=>{let e;"undefined"==typeof document?e=new OffscreenCanvas(32,32):(e=document.createElement("canvas"),e.width=32,e.height=32);const t=e.getContext("2d");t.fillStyle="blue",t.fillRect(0,0,32,32);let s=null;try{e.convertToBlob?s=await e.convertToBlob({type:"image/webp",quality:1}):e.toBlob&&(s=await new Promise(t=>e.toBlob(t,"image/webp",1))),ta.Supports.CanvasToBlobWebP=s&&"image/webp"===s.type}catch(e){ta.Supports.CanvasToBlobWebP=!1}})()}{const na=self.C3;if(!String.prototype.trimStart){const aa=/^[\x09\x0A\x0B\x0C\x0D\x20\xA0\u1680\u180E\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u3000\u2028\u2029\uFEFF]*/;String.prototype.trimStart=function(){return this.replace(aa,"")}}if(!String.prototype.trimEnd){const oa=/[\x09\x0A\x0B\x0C\x0D\x20\xA0\u1680\u180E\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u3000\u2028\u2029\uFEFF]*$/;String.prototype.trimEnd=function(){return this.replace(oa,"")}}if(String.prototype.replaceAll||(String.prototype.replaceAll=function(e,t){return this.replace(new RegExp(na.EscapeRegex(e),"g"),t)}),Array.prototype.values||(Array.prototype.values=function*(){for(const e of this)yield e}),!Array.prototype.flat){let la=function(e,t){return e.reduce((e,s)=>t>0&&Array.isArray(s)?(Array.prototype.push.apply(e,la(s,t-1)),e):(e.push(s),e),[])};arrayFlat=la,Array.prototype.flat=function(e=1){return la(this,e)}}Array.prototype.at||(Array.prototype.at=function(e){if((e=Math.trunc(e)||0)<0&&(e+=this.length),!(e<0||e>=this.length))return this[e]}),String.prototype.at||(String.prototype.at=function(e){if((e=Math.trunc(e)||0)<0&&(e+=this.length),!(e<0||e>=this.length))return this[e]}),RegExp.escape||(RegExp.escape=function(e){return String(e).replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}),Set.prototype.isSubsetOf||(Set.prototype.isSubsetOf=function(e){if(!(e instanceof Set))throw new TypeError("argument must be a Set");for(const t of this)if(!e.has(t))return!1;return!0}),navigator.storage&&!navigator.storage.estimate&&navigator.webkitTemporaryStorage&&navigator.webkitTemporaryStorage.queryUsageAndQuota&&(navigator.storage.estimate=function(){return new Promise((e,t)=>navigator.webkitTemporaryStorage.queryUsageAndQuota((t,s)=>e({usage:t,quota:s}),t))}),void 0===self.isSecureContext&&(self.isSecureContext="https:"===location.protocol),void 0===self.globalThis&&(self.globalThis=self)}{let ha=function(e){let t="Assertion failure: "+e+"\n\nStack trace:\n"+ua.GetCallStack();console.error(t)};assertFail=ha;const ua=self.C3;self.assert=function(e,t){e||ha(t)}}{const ca=self.C3,da=self.C3X;ca.IsNumber=function(e){return"number"==typeof e},ca.IsFiniteNumber=function(e){return ca.IsNumber(e)&&isFinite(e)},ca.RequireNumber=function(e){if(!ca.IsNumber(e))throw new TypeError("expected number")},ca.RequireOptionalNumber=function(e){ca.IsNullOrUndefined(e)},ca.RequireNumberInRange=function(e,t,s){if(!ca.IsNumber(e)||isNaN(e)||t>e||s<e)throw new RangeError("number outside of range")},ca.RequireAllNumber=function(...e){for(let t of e);},ca.RequireFiniteNumber=function(e){if(!ca.IsFiniteNumber(e))throw new TypeError("expected finite number")},ca.RequireOptionalFiniteNumber=function(e){ca.IsNullOrUndefined(e)},ca.RequireAllFiniteNumber=function(...e){for(let t of e);},ca.IsString=function(e){return"string"==typeof e},ca.RequireString=function(e){if(!ca.IsString(e))throw new TypeError("expected string")},ca.RequireOptionalString=function(e){ca.IsNullOrUndefined(e)},ca.RequireAllString=function(...e){for(let t of e);},ca.IsSimpleObject=function(e){if("object"!=typeof e||null===e)return!1;let t=Object.getPrototypeOf(e);return t?t.constructor===Object:null===t},ca.RequireSimpleObject=function(e){if(!ca.IsSimpleObject(e))throw new TypeError("expected simple object")},ca.RequireOptionalSimpleObject=function(e){if(!ca.IsNullOrUndefined(e)&&!ca.IsSimpleObject(e))throw new TypeError("expected simple object")},ca.IsObject=function(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)},ca.RequireObject=function(e){if(!ca.IsObject(e))throw new TypeError("expected object")},ca.RequireOptionalObject=function(e){ca.IsNullOrUndefined(e)},ca.RequireAllObject=function(...e){for(let t of e);},ca.IsFileLike=function(e){return ca.WeakIsInstanceOf(e,Blob)&&"string"==typeof e.name},ca.RequireFileLike=function(e){if(!ca.IsFileLike(e))throw new TypeError("expected file")},ca.RequireOptionalFileLike=function(e){ca.IsNullOrUndefined(e)},ca.IsArray=function(e){return Array.isArray(e)},ca.RequireArray=function(e){if(!ca.IsArray(e))throw new TypeError("expected array")},ca.RequireOptionalArray=function(e){ca.IsNullOrUndefined(e)},ca.RequireAllArray=function(...e){for(let t of e);},ca.Is2DArray=function(e){return!(!ca.IsArray(e)||e.length&&!ca.IsArray(e[0]))},ca.Require2DArray=function(e){if(!ca.Is2DArray(e))throw new TypeError("expected 2d array");for(let t of e)if(!ca.IsArray(t))throw new TypeError("expected 2d array")},ca.RequireOptional2DArray=function(e){ca.IsNullOrUndefined(e)},ca.IsFunction=function(e){return"function"==typeof e},ca.RequireFunction=function(e,t){if(!ca.IsFunction(e))throw new TypeError("expected function");if(!ca.IsNullOrUndefined(t)&&e!==t)throw new TypeError("expected same function reference")},ca.RequireOptionalFunction=function(e){ca.IsNullOrUndefined(e)},ca.RequireAllFunction=function(...e){for(let t of e);},ca.RequireAnyFunction=function(e,...t){if(!ca.IsFunction(e))throw new TypeError("expected function");if(!t.length)throw new Error("missing comparison functions");for(let s of t)if(!ca.IsNullOrUndefined(s)&&e===s)return;throw new TypeError("expected same function reference")},ca.RequireOptionalAllFunction=function(...e){if(!ca.IsNullOrUndefined(e))for(let t of e);},ca.IsInstanceOf=function(e,t){return e instanceof t},ca.IsInstanceOfAny=function(e,...t){for(let s of t)if(ca.IsInstanceOf(e,s))return!0;return!1},ca.RequireInstanceOf=function(e,t){if(!ca.IsInstanceOf(e,t))throw new TypeError("unexpected type")},ca.RequireOptionalInstanceOf=function(e,t){ca.IsNullOrUndefined(e)},ca.RequireAllInstanceOf=function(e,...t){for(let e of t);},ca.RequireAnyInstanceOf=function(e,...t){if(!ca.IsInstanceOfAny(e,...t))throw new TypeError("unexpected type")},ca.RequireAnyOptionalInstanceOf=function(e,...t){if(!ca.IsNullOrUndefined(e)&&!ca.IsInstanceOfAny(e,...t))throw new TypeError("unexpected type")},ca.IsArrayOf=function(e,t){for(let s of e)if(!ca.IsInstanceOf(s,t))return!1;return!0},ca.IsArrayOfFiniteNumbers=function(e){for(let t of e)if(!ca.IsFiniteNumber(t))return!1;return!0},ca.RequireArrayOf=function(e,t){for(let t of e);},ca.RequireOptionalArrayOf=function(e,t){if(!ca.IsNullOrUndefined(e))for(let t of e);},ca.RequireOptionalArrayOfFunctions=function(e,t){if(!ca.IsNullOrUndefined(e))for(let t of e);},ca.RequireArrayOfAny=function(e,...t){for(let t of e);},ca.RequireOptionalArrayOfAny=function(e,...t){if(!ca.IsNullOrUndefined(e))for(let t of e);},ca.IsDOMNode=function(e,t){return!(ca.IsNullOrUndefined(e)||!ca.IsString(e.nodeName))&&(!t||ca.equalsNoCase(e.nodeName,t))},ca.RequireDOMNode=function(e,t){if(ca.IsNullOrUndefined(e)||!ca.IsString(e.nodeName))throw new TypeError("expected DOM node");if(t&&!ca.equalsNoCase(e.nodeName,t))throw new TypeError(`expected DOM '${t}' node`)},ca.RequireOptionalDOMNode=function(e,t){ca.IsNullOrUndefined(e)},ca.IsHTMLElement=function(e,t){return!(ca.IsNullOrUndefined(e)||!ca.IsString(e.tagName))&&(!t||ca.equalsNoCase(e.tagName,t))},ca.RequireHTMLElement=function(e,t){if(ca.IsNullOrUndefined(e)||!ca.IsString(e.tagName))throw new TypeError("expected HTML element");if(t&&!ca.equalsNoCase(e.tagName,t))throw new TypeError(`expected HTML '${t}' element`)},ca.RequireOptionalHTMLElement=function(e,t){ca.IsNullOrUndefined(e)},ca.IsDrawable=function(e){return ca.IsHTMLElement(e,"img")||ca.IsHTMLElement(e,"canvas")||ca.IsHTMLElement(e,"video")||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap},ca.RequireDrawable=function(e){if(!ca.IsDrawable(e))throw new TypeError("expected drawable")},ca.RequireOptionalDrawable=function(e){ca.IsNullOrUndefined(e)},ca.IsDrawableOrImageData=function(e){return e instanceof ImageData||ca.IsDrawable(e)},ca.RequireDrawableOrImageData=function(e){if(!ca.IsDrawableOrImageData(e))throw new TypeError("expected drawable or image data")},ca.RequireOptionalDrawableOrImageData=function(e){if(!ca.IsNullOrUndefined(e)&&!ca.IsDrawableOrImageData(e))throw new TypeError("expected drawable or image data")},ca.IsStringLike=function(e){return"string"==typeof e||ca.HtmlString&&e instanceof ca.HtmlString||e instanceof ca.BBString},ca.RequireStringLike=function(e){if(!ca.IsStringLike(e))throw new TypeError("expected string-like")},ca.RequireOptionalStringLike=function(e){ca.IsNullOrUndefined(e)},ca.RequireAllStringLike=function(...e){for(let t of e);},ca.RequireOverride=function(){throw new Error("must be overridden")},ca.NotYetImplemented=function(){throw new Error("not yet implemented")},ca.IsGeneratorFunction=function(e){return e.constructor===function*(){}.constructor},ca.RequireGeneratorFunction=function(e){if(!ca.IsGeneratorFunction(e))throw new Error("expected generator function")},ca.IsIterable=function(e){return"function"===e[Symbol.iterator]},ca.RequireIterable=function(e){if(!ca.IsIterable(e))throw new Error("expected iterable")},ca.IsDefined=function(e){return!ca.IsNullOrUndefined(e)},ca.IsNullOrUndefined=function(e){return null==e},ca.AreArrayElementsOfSameType=function(e){let t=e[0].constructor;for(let s of e)if(s.constructor!==t)return!1;return t},ca.AreArrayElementsOfType=function(e,t){for(let s of e)if(!(s instanceof t))return!1;return!0};const pa=Object.getPrototypeOf(Uint8Array);ca.IsTypedArray=function(e){return ca.IsInstanceOf(e,pa)},ca.RequireTypedArray=function(e){},ca.WeakRequireTypedArray=function(e){ca.WeakRequireInstanceOf(e,pa)},ca.WeakRequireAnyInstanceOf=function(e,...t){if(!ca.WeakIsAnyInstanceOf(e,...t))throw new TypeError("unexpected type")},ca.WeakIsAnyInstanceOf=function(e,...t){for(const s of t)if(ca.WeakIsInstanceOf(e,s))return!0;return!1},ca.WeakRequireInstanceOf=function(e,t){if(!ca.WeakIsInstanceOf(e,t))throw new TypeError("unexpected type")},ca.WeakIsInstanceOf=function(e,t){for(;e=Object.getPrototypeOf(e);)if(e.constructor.name===t.name)return!0;return!1},da.RequireNumber=ca.RequireNumber,da.RequireOptionalNumber=ca.RequireOptionalNumber,da.RequireFiniteNumber=ca.RequireFiniteNumber,da.RequireOptionalFiniteNumber=ca.RequireOptionalFiniteNumber,da.RequireString=ca.RequireString,da.RequireOptionalString=ca.RequireOptionalString,da.RequireObject=ca.RequireObject,da.RequireOptionalObject=ca.RequireOptionalObject,da.RequireArray=ca.RequireArray,da.RequireOptionalArray=ca.RequireOptionalArray,da.RequireFunction=ca.RequireFunction,da.RequireOptionalFunction=ca.RequireOptionalFunction,da.RequireInstanceOf=ca.RequireInstanceOf,da.RequireOptionalInstanceOf=ca.RequireOptionalInstanceOf,da.IsNullOrUndefined=ca.IsNullOrUndefined}{let _a=function(e,t){let s=Sa.getType(e),i=Sa.getType(t);return"null"===s||"null"===i||"undefined"!==s&&"undefined"!==i&&s===i},ma=function(e){console.warn("[Defence] "+e+" @",Sa.GetCallStack())},fa=function(){if(wa=-1,ba.size>0||Ga.size>0){let e=[...new Set([...ba.keys()].map(e=>Sa.getName(e)))].join(",");console.warn(`An object derived from DefendedBase was not protected with debugDefend(). This will disable some checks. See the coding guidelines! Possible affected class names: ${e}`),ba.clear(),Ga.clear()}},ga=function(e){let t=new Set;for(let s in e)t.add(s);return t},ya=function(e,t){let s=ga(t),i=Aa.get(e);if(i){let t=[];for(let e of i.values())s.has(e)?s.delete(e):t.push(e);Sa.appendArray(t,[...s]),t.length&&console.warn(`[Defence] '${Sa.getName(e)}' constructor creates inconsistent properties: ${t.join(", ")}`)}else Aa.set(e,s)};isValidTypeChange=_a,logDefendedObjectWarning=ma,CheckDefendedObjectsUsedCorrectly=fa,getObjectPropertySet=ga,VerifyObjectPropertiesConsistent=ya;const Sa=self.C3,Ta=new Map;let xa;Sa.ColorLog=function(e,t){console.log(`%c${e}`,`font-weight: bold; color:${t}`)},Sa.RafLog=function(e,...t){Ta.has(e)||Ta.set(e,-1),-1===Ta.get(e)&&Ta.set(e,requestAnimationFrame(()=>{console.log(`%c${e}`,"font-weight: bold",...t),Ta.set(e,-1)}))},Sa.StartMeasure=function(e){performance.mark(e),xa||(xa=new Map),xa.has(e)||xa.set(e,{current:0,total:0,average:0,calls:1,toString:function(){return`${e} :: current => ${this.current.toPrecision(3)} :: average => ${this.average.toPrecision(3)} :: calls => ${this.calls}`}})},Sa.EndMeasure=function(e){performance.measure(`measure-${e}`,e);const t=performance.getEntriesByName(`measure-${e}`)[0],s=xa.get(e);s.current=t.duration,s.total+=s.current,s.average=s.total/s.calls,console.log(s.toString()),s.calls++,performance.clearMarks(e),performance.clearMeasures(`measure-${e}`)},Sa.GetCallStack=function(){return(new Error).stack},Sa.Debugger=function(){},Sa.cast=function(e,t){return e&&e instanceof t?e:null},Sa.getName=function(e){return void 0===e?"undefined":null===e?"null":"boolean"==typeof e?"<boolean>":Sa.IsNumber(e)?"<number>":Sa.IsString(e)?"<string>":Sa.IsArray(e)?"<array>":"symbol"==typeof e?"<"+e.toString()+">":Sa.IsFunction(e)?e.name&&"Function"!==e.name?e.name:"<anonymous function>":"object"==typeof e?e.constructor&&e.constructor.name&&"Object"!==e.constructor.name?e.constructor.name:"<anonymous object>":"<unknown>"},Sa.getType=function(e){return null===e?"null":Array.isArray(e)?"array":typeof e},Sa.range=function*(e,t){if(!isFinite(Math.abs(e-t)))throw new Error("Invalid parameters");if(e>t)for(let s=e-1;s>=t;s--)yield s;else for(let s=e;s<t;s++)yield s};let ba=new Map,Ga=new Map,Ia=new WeakMap,va=new WeakMap;Sa.DefendHandler={};const Ca=new Set(["then","splice"]);Sa.DefendHandler.get=function(e,t){return t in e||"symbol"==typeof t||Ca.has(t)||ma(`Accessed missing property '${t}' from defended object '${Sa.getName(e)}', returning undefined`),va.has(e)&&"symbol"!=typeof t&&!Ca.has(t)&&ma(`Accessed property '${t}' on a released object '${Sa.getName(e)}'\nObject was originally released at: ${va.get(e)})\nCall stack at access: `),e[t]},Sa.DefendHandler.set=function(e,t,s){return t in e||ba.has(e)||ma(`Set non-existent property '${t}' to '${s}' on defended object '${Sa.getName(e)}'`),_a(e[t],s)||ba.has(e)||ma(`Set '${Sa.getType(e[t])}' property '${t}' to type '${Sa.getType(s)}' on defended object '${Sa.getName(e)}'`),va.has(e)&&ma(`Set property '${t}' on a released object '${Sa.getName(e)}'\nObject was originally released at: ${va.get(e)})\nCall stack at access: `),e[t]=s,!0},Sa.DefendHandler.deleteProperty=function(e,t){throw new ReferenceError(`Cannot delete property '${t}' from defended object '${Sa.getName(e)}'`)},Sa.DefendHandler.defineProperty=function(e,t,s){throw new ReferenceError(`Cannot define property '${t}' on defended object '${Sa.getName(e)}'`)},Sa.DefendHandler.enumerate=function(e){throw new ReferenceError(`Cannot enumerate defended object '${Sa.getName(e)}'`)};let wa=-1;Sa.DefendedBase=class{constructor(){if(!Sa.isDebugDefend||!Sa.Supports.Proxies)return;let e=new.target,t=Object.create(e.prototype),s=new Proxy(t,Sa.DefendHandler);return ba.set(t,s),Ga.set(s,t),Ia.set(s,t),-1===wa&&(wa=requestAnimationFrame(fa)),s}},Sa.debugDefend=function(e){if(Sa.isDebugDefend&&Sa.Supports.Proxies&&e instanceof Sa.DefendedBase){if(!Ga.has(e))return e;let t=Ga.get(e);return Ga.delete(e),ba.delete(t),e}return Sa.isDebug?Object.seal(e):e},Sa.New=function(e,...t){let s;try{s=new e(...t)}catch(e){throw Ga.clear(),ba.clear(),e}return Sa.isDebugDefend&&ya(e,s),Sa.debugDefend(s)},Sa.Release=function(e){let t=Ia.get(e);t&&va.set(t,Sa.GetCallStack())},Sa.WasReleased=function(e){let t=Ia.get(e);return!!t&&!!va.get(t)};let Aa=new Map;Sa.PerfMark=class{constructor(e){this._name="",e&&this.start(e)}start(e){Sa.isPerformanceProfiling&&(this._name=e,performance.mark(this._name+"-Start"))}end(){Sa.isPerformanceProfiling&&(performance.mark(this._name+"-End"),performance.measure(this._name,this._name+"-Start",this._name+"-End"))}next(e){Sa.isPerformanceProfiling&&(this.end(),this._name=e,performance.mark(this._name+"-Start"))}}}{let Ra=function(e){return 0===e&&1/e<0};isNegativeZero=Ra;const Pa=self.C3,Ma=2*Math.PI,Ea=Math.PI/180,Da=180/Math.PI;Pa.wrap=function(e,t,s){e=Math.floor(e),t=Math.floor(t);const i=(s=Math.floor(s))-t;if(0===i)return s;if(e<t){const r=s-(t-e)%i;return r===s?0:r}return t+(e-t)%i},Pa.mapToRange=function(e,t,s,i,r){const n=s-t;return 0===n&&0===i?e:(e-t)*(r-i)/n+i},Pa.normalize=function(e,t,s){return t-s===0?1:(e-t)/(s-t)},Pa.clamp=function(e,t,s){return e<t?t:e>s?s:e},Pa.clampAngle=function(e){return(e%=Ma)<0&&(e+=Ma),e},Pa.toRadians=function(e){return e*Ea},Pa.toDegrees=function(e){return e*Da},Pa.hypot2DFast=function(e,t){return Math.sqrt(e*e+t*t)},Pa.hypot3DFast=function(e,t,s){return Math.sqrt(e*e+t*t+s*s)},Pa.distanceTo=function(e,t,s,i){return Pa.hypot2DFast(s-e,i-t)},Pa.distanceSquared=function(e,t,s,i){const r=s-e,n=i-t;return r*r+n*n},Pa.angleTo=function(e,t,s,i){return Math.atan2(i-t,s-e)},Pa.angleDiff=function(e,t){if(e===t)return 0;let s=Math.sin(e),i=Math.cos(e),r=s*Math.sin(t)+i*Math.cos(t);return r>=1?0:r<=-1?Math.PI:Math.acos(r)},Pa.angleRotate=function(e,t,s){let i=Math.sin(e),r=Math.cos(e),n=Math.sin(t),a=Math.cos(t);return Math.acos(i*n+r*a)>s?r*n-i*a>0?Pa.clampAngle(e+s):Pa.clampAngle(e-s):Pa.clampAngle(t)},Pa.angleClockwise=function(e,t){let s=Math.sin(e);return Math.cos(e)*Math.sin(t)-s*Math.cos(t)<=0},Pa.angleLerp=function(e,t,s,i=0){let r=Pa.angleDiff(e,t);const n=Ma*i;return Pa.angleClockwise(t,e)?Pa.clampAngle(e+(r+n)*s):Pa.clampAngle(e-(r+n)*s)},Pa.angleLerpClockwise=function(e,t,s,i=0){const r=Pa.angleDiff(e,t),n=Ma*i;return Pa.angleClockwise(t,e)?Pa.clampAngle(e+(r+n)*s):Pa.clampAngle(e+(Ma-r+n)*s)},Pa.angleLerpAntiClockwise=function(e,t,s,i=0){const r=Pa.angleDiff(e,t),n=Ma*i;return Pa.angleClockwise(t,e)?Pa.clampAngle(e-(-Ma+r-n)*s):Pa.clampAngle(e-(r+n)*s)},Pa.angleReflect=function(e,t){const s=Pa.angleDiff(e,t);return Pa.angleClockwise(e,t)?Pa.clampAngle(t-s):Pa.clampAngle(t+s)},Pa.lerp=function(e,t,s){return e+s*(t-e)},Pa.unlerp=function(e,t,s){return e===t?0:(s-e)/(t-e)},Pa.relerp=function(e,t,s,i,r){return Pa.lerp(i,r,Pa.unlerp(e,t,s))},Pa.qarp=function(e,t,s,i){return Pa.lerp(Pa.lerp(e,t,i),Pa.lerp(t,s,i),i)},Pa.cubic=function(e,t,s,i,r){return Pa.lerp(Pa.qarp(e,t,s,r),Pa.qarp(t,s,i,r),r)},Pa.cosp=function(e,t,s){return(e+t+(e-t)*Math.cos(s*Math.PI))/2},Pa.isPOT=function(e){return e>0&&!(e-1&e)},Pa.nextHighestPowerOfTwo=function(e){--e;for(let t=1;t<32;t<<=1)e|=e>>t;return e+1},Pa.roundToNearestFraction=function(e,t){return Math.round(e*t)/t},Pa.floorToNearestFraction=function(e,t){return Math.floor(e*t)/t},Pa.roundToDp=function(e,t){t=Math.max(Math.floor(t),0);const s=Math.pow(10,t);return Math.round(e*s)/s},Pa.countDecimals=function(e){return Math.floor(e)!==e&&e.toString().split(".")[1].length||0},Pa.toFixed=function(e,t){let s=e.toFixed(t),i=s.length-1;for(;i>=0&&"0"===s.charAt(i);--i);return i>=0&&"."===s.charAt(i)&&--i,i<0?s:s.substr(0,i+1)},Pa.PackRGB=function(e,t,s){return Pa.clamp(e,0,255)|Pa.clamp(t,0,255)<<8|Pa.clamp(s,0,255)<<16};const Na=1024,Fa=1023,Oa=16384,Ba=8191,La=-8192;Pa.PackRGBAEx=function(e,t,s,i){return(e=Pa.clamp(Math.floor(1024*e),-8192,8191))<0&&(e+=16384),(t=Pa.clamp(Math.floor(1024*t),-8192,8191))<0&&(t+=16384),(s=Pa.clamp(Math.floor(1024*s),-8192,8191))<0&&(s+=16384),-(16384*e*16384*1024+16384*t*1024+1024*s+(i=Pa.clamp(Math.floor(1023*i),0,1023)))},Pa.PackRGBEx=function(e,t,s){return Pa.PackRGBAEx(e,t,s,1)},Pa.GetRValue=function(e){if(e>=0)return(255&e)/255;{let t=Math.floor(-e/274877906944);return t>8191&&(t-=16384),t/1024}},Pa.GetGValue=function(e){if(e>=0)return((65280&e)>>8)/255;{let t=Math.floor(-e%274877906944/16777216);return t>8191&&(t-=16384),t/1024}},Pa.GetBValue=function(e){if(e>=0)return((16711680&e)>>16)/255;{let t=Math.floor(-e%16777216/1024);return t>8191&&(t-=16384),t/1024}},Pa.GetAValue=function(e){return Ra(e)?0:e>=0?1:Math.floor(-e%1024)/1023},Pa.greatestCommonDivisor=function(e,t){for(e=Math.floor(e),t=Math.floor(t);0!==t;){let s=t;t=e%t,e=s}return e};const ka=[[3,2],[4,3],[5,4],[5,3],[6,5],[14,9],[16,9],[16,10],[21,9]];Pa.getAspectRatio=function(e,t){if((e=Math.floor(e))===(t=Math.floor(t)))return[1,1];for(let s of ka){let i=e/s[0]*s[1];if(Math.abs(t-i)<1)return s.slice(0);if(i=e/s[1]*s[0],Math.abs(t-i)<1)return[s[1],s[0]]}let s=Pa.greatestCommonDivisor(e,t);return[e/s,t/s]},Pa.segmentsIntersect=function(e,t,s,i,r,n,a,o){const l=Math.min(e,s),h=Math.max(e,s),u=Math.min(r,a),c=Math.max(r,a);if(h<u||l>c)return!1;const d=Math.min(t,i),p=Math.max(t,i),_=Math.min(n,o),m=Math.max(n,o);if(p<_||d>m)return!1;const f=r-e+a-s,g=n-t+o-i,y=s-e,S=i-t,T=a-r,x=o-n,b=Math.abs(S*T-x*y),G=T*g-x*f;if(Math.abs(G)>b)return!1;const I=y*g-S*f;return Math.abs(I)<=b},Pa.segmentsIntersectPreCalc=function(e,t,s,i,r,n,a,o,l,h,u,c){const d=Math.min(l,u),p=Math.max(l,u);if(n<d||r>p)return!1;const _=Math.min(h,c),m=Math.max(h,c);if(o<_||a>m)return!1;const f=l-e+u-s,g=h-t+c-i,y=s-e,S=i-t,T=u-l,x=c-h,b=Math.abs(S*T-x*y),G=T*g-x*f;if(Math.abs(G)>b)return!1;const I=y*g-S*f;return Math.abs(I)<=b},Pa.segmentIntersectsQuad=function(e,t,s,i,r){const n=Math.min(e,s),a=Math.max(e,s),o=Math.min(t,i),l=Math.max(t,i),h=r.getTlx(),u=r.getTly(),c=r.getTrx(),d=r.getTry(),p=r.getBrx(),_=r.getBry(),m=r.getBlx(),f=r.getBly();return Pa.segmentsIntersectPreCalc(e,t,s,i,n,a,o,l,h,u,c,d)||Pa.segmentsIntersectPreCalc(e,t,s,i,n,a,o,l,c,d,p,_)||Pa.segmentsIntersectPreCalc(e,t,s,i,n,a,o,l,p,_,m,f)||Pa.segmentsIntersectPreCalc(e,t,s,i,n,a,o,l,m,f,h,u)},Pa.segmentIntersectsAnyN=function(e,t,s,i,r){const n=Math.min(e,s),a=Math.max(e,s),o=Math.min(t,i),l=Math.max(t,i);let h=0;for(let u=r.length-4;h<=u;h+=2)if(Pa.segmentsIntersectPreCalc(e,t,s,i,n,a,o,l,r[h],r[h+1],r[h+2],r[h+3]))return!0;return Pa.segmentsIntersectPreCalc(e,t,s,i,n,a,o,l,r[h],r[h+1],r[0],r[1])};const Va=2,Ua=1e-6;Pa.rayIntersect=function(e,t,s,i,r,n,a,o){const l=s-e,h=o-n,u=l*h-(i-t)*(a-r);if(0===u)return 2;const c=((t-i)*(a-e)+l*(o-t))/u;return 0<c&&c<1.000001?(h*(a-e)+(r-a)*(o-t))/u:2},Pa.rayIntersectExtended=function(e,t,s,i,r,n,a,o,l){const h=(a-r)*l,u=(o-n)*l;return Pa.rayIntersect(e,t,s,i,r-h,n-u,a+h,o+u)},Pa.isPointInTriangleInclusive=function(e,t,s,i,r,n,a,o){const l=r-s,h=n-i,u=a-s,c=o-i,d=e-s,p=t-i,_=l*l+h*h,m=l*u+h*c,f=l*d+h*p,g=u*u+c*c,y=u*d+c*p,S=1/(_*g-m*m),T=(g*f-m*y)*S,x=(_*y-m*f)*S;return T>=0&&x>=0&&T+x<=1},Pa.triangleCartesianToBarycentric=function(e,t,s,i,r,n,a,o){const l=r-s,h=n-i,u=a-s,c=o-i,d=e-s,p=t-i,_=l*l+h*h,m=l*u+h*c,f=u*u+c*c,g=d*l+p*h,y=d*u+p*c,S=_*f-m*m,T=(f*g-m*y)/S,x=(_*y-m*g)/S;return[1-T-x,T,x]},Pa.triangleBarycentricToCartesian3d=function(e,t,s,i,r,n,a,o,l,h,u,c){return[e*i+t*a+s*h,e*r+t*o+s*u,e*n+t*l+s*c]}}{const Wa=self.C3;let Ha=null,za="";if("undefined"!=typeof document){Ha=document;const Ka=document.querySelector("base");za=Ka&&Ka.hasAttribute("href")?Ka.getAttribute("href"):"",za&&(za.startsWith("/")&&(za=za.substr(1)),za.endsWith("/")||(za+="/"))}Wa.GetBaseHref=function(){return za},Wa.GetBaseURL=function(){if(!Ha)return"";const e=Ha.location;return Wa.GetPathFromURL(e.origin+e.pathname)+za},Wa.GetPathFromURL=function(e){if(!e.length)return e;if(e.endsWith("/")||e.endsWith("\\"))return e;const t=Math.max(e.lastIndexOf("/"),e.lastIndexOf("\\"));return-1===t?"":e.substr(0,t+1)},Wa.GetFilenameFromURL=function(e){if(!e.length)return e;if(e.endsWith("/")||e.endsWith("\\"))return"";const t=Math.max(e.lastIndexOf("/"),e.lastIndexOf("\\"));return-1===t?e:e.substr(t+1)},Wa.GetFileExtension=function(e){let t=e.lastIndexOf(".");return t<1?"":e.substr(t)},Wa.SetFileExtension=function(e,t){const s=e.lastIndexOf(".");return-1===s?e+"."+t:e.substr(0,s+1)+t},Wa.GetFileNamePart=function(e){let t=e.lastIndexOf(".");return t<1?e:e.substr(0,t)},Wa.NormalizeFileSeparator=function(e){return e.replace(/\\/g,"/")},Wa.IsFileExtension=function(e,t){return t===(e?Wa.GetFileExtension(e).slice(1):"")},Wa.FileNameEquals=function(e,t){let s,i;return Wa.IsFileLike(e)&&(s=Wa.GetFileNamePart(e.name)),Wa.IsString(e)&&(s=Wa.GetFileNamePart(e)),Wa.IsFileLike(t)&&(i=Wa.GetFileNamePart(t.name)),Wa.IsString(t)&&(i=Wa.GetFileNamePart(t)),s===i},Wa.ParseFilePath=function(e){e=Wa.NormalizeFileSeparator(e);let t=/^\w\:\//.exec(e);t?(t=t[0],"/"!==(e=e.slice(3))[0]&&(e="/"+e)):t="",(e=e.replace(/\/{2,}/g,"/")).length>1&&"/"===e.slice(-1)&&(e=e.slice(0,-1));const s=e.lastIndexOf("/")+1;let i,r="",n=e,a="";s>0&&(r=e.slice(0,s),n=e.slice(s)),i=n;const o=n.lastIndexOf(".");return o>0&&(a=n.slice(o),i=n.slice(0,-a.length)),{dir:r,base:n,name:i,root:t,ext:a,full:t+r+n}},Wa.Wait=function(e,t){return new Promise((s,i)=>{self.setTimeout(s,e,t)})},Wa.swallowException=function(e){try{e()}catch(e){Wa.isDebug&&console.warn("Swallowed exception: ",e)}},Wa.noop=function(){},Wa.equalsNoCase=function(e,t){return"string"==typeof e&&"string"==typeof t&&(e===t||e.normalize().toLowerCase()===t.normalize().toLowerCase())},Wa.equalsCase=function(e,t){return"string"==typeof e&&"string"==typeof t&&(e===t||e.normalize()===t.normalize())},Wa.typedArraySet16=function(e,t,s){e[s++]=t[0],e[s++]=t[1],e[s++]=t[2],e[s++]=t[3],e[s++]=t[4],e[s++]=t[5],e[s++]=t[6],e[s++]=t[7],e[s++]=t[8],e[s++]=t[9],e[s++]=t[10],e[s++]=t[11],e[s++]=t[12],e[s++]=t[13],e[s++]=t[14],e[s]=t[15]},Wa.truncateArray=function(e,t){e.length=t},Wa.clearArray=function(e){e&&0!==e.length&&Wa.truncateArray(e,0)},Wa.clear2DArray=function(e){if(e){for(let t=0;t<e.length;t++){let s=e[t];Wa.truncateArray(s,0)}Wa.truncateArray(e,0)}},Wa.extendArray=function(e,t,s){t|=0;const i=e.length;if(!(t<=i))for(let r=i;r<t;++r)e.push(s)},Wa.resizeArray=function(e,t,s){t|=0;const i=e.length;t<i?Wa.truncateArray(e,t):t>i&&Wa.extendArray(e,t,s)},Wa.shallowAssignArray=function(e,t){Wa.clearArray(e),Wa.appendArray(e,t)},Wa.appendArray=function(e,t){if(t.length<1e4)e.push(...t);else for(let s=0,i=t.length;s<i;++s)e.push(t[s])},Wa.arrayRemove=function(e,t){if((t=Math.floor(t))<0||t>=e.length)return;let s=e.length-1;for(let i=t;i<s;++i)e[i]=e[i+1];Wa.truncateArray(e,s)},Wa.arrayFindRemove=function(e,t){let s=e.indexOf(t);s>=0&&e.splice(s,1)},Wa.arraysEqual=function(e,t){let s=e.length;if(t.length!==s)return!1;for(let i=0;i<s;++i)if(e[i]!==t[i])return!1;return!0},Wa.arrayFilterOut=function(e,t){let s=[],i=0;for(let r=0,n=e.length;r<n;++r){let n=e[r];t(n)?s.push(n):(e[i]=n,++i)}return Wa.truncateArray(e,i),s},Wa.arrayRemoveAllInSet=function(e,t){const s=e.length;let i=0;for(let s=0,r=e.length;s<r;++s){let r=e[s];t.has(r)||(e[i++]=r)}return Wa.truncateArray(e,i),s-i},Wa.isArrayIndexInBounds=function(e,t){return e===Math.floor(e)&&e>=0&&e<t.length},Wa.validateArrayIndex=function(e,t){if(!Wa.isArrayIndexInBounds(e,t))throw new RangeError("array index out of bounds")},Wa.cloneArray=function(e){return e.slice()},Wa.deepCloneArray=function(e,t){let s=[];for(let i of e)if(Wa.IsObject(i)){let e=t(i);if(!e)throw new Error("missing clone");if(e.constructor!==i.constructor)throw new Error("object is not a clone");s.push(e)}else Wa.IsArray(i)?s.push(Wa.deepCloneArray(i,t)):s.push(i);return s},Wa.clone2DArray=function(e){let t=[];for(let s of e)t.push(s.slice());return t},Wa.splitStringAndNormalize=function(e,t=" "){return e?e.split(t).map(e=>e.trim()).filter(e=>!!e):[]},Wa.filterSet=function(e,t,s){const i=new Set;for(const r of e.values())t(r)&&(s?i.add(s(r)):i.add(r));return i},Wa.mergeSets=function(e,t){return e.union?e.union(t):new Set([...e,...t])},Wa.mergeSetsInPlace=function(e,t){for(const s of t)e.add(s);return e},Wa.first=function(e){for(let t of e)return t;return null},Wa.xor=function(e,t){return!e!=!t},Wa.compare=function(e,t,s){switch(t){case 0:return e===s;case 1:return e!==s;case 2:return e<s;case 3:return e<=s;case 4:return e>s;case 5:return e>=s;default:return!1}},Wa.hasAnyOwnProperty=function(e){for(let t in e)if(e.hasOwnProperty(t))return!0;return!1},Wa.PromiseAllWithProgress=function(e,t){return e.length?new Promise((s,i)=>{const r=[];let n=0,a=!1;for(let o=0,l=e.length;o<l;++o)r.push(void 0),e[o].then(i=>{a||(r[o]=i,++n,n===e.length?s(r):t(n,e.length))}).catch(e=>{a=!0,i(e)})}):Promise.resolve([])};let ja=[];Wa.AddLibraryMemoryCallback=function(e){ja.push(e)},Wa.GetEstimatedLibraryMemoryUsage=function(){let e=0;for(let t of ja)e+=t();return Math.floor(e)};let Ya=1;const qa=new Map,Xa=new MessageChannel;Xa.port2.onmessage=function(e){const t=e.data,s=qa.get(t);qa.delete(t),s&&s(performance.now())},Wa.RequestUnlimitedAnimationFrame=function(e){const t=Ya++;return qa.set(t,e),Xa.port1.postMessage(t),t},Wa.CancelUnlimitedAnimationFrame=function(e){qa.delete(e)},Wa.PostTask=Wa.RequestUnlimitedAnimationFrame,Wa.WaitForNextTask=function(){return new Promise(e=>Wa.PostTask(e))};const $a=new Set;Wa.RequestPostAnimationFrame=function(e){const t=self.requestAnimationFrame(async s=>{await Wa.WaitForNextTask(),$a.has(t)&&($a.delete(t),e(s))});return $a.add(t),t},Wa.CancelPostAnimationFrame=function(e){$a.has(e)&&(self.cancelAnimationFrame(e),$a.delete(e))}}{const Ja=self.C3;Ja.IsAbsoluteURL=function(e){return/^(?:[a-z\-]+:)?\/\//.test(e)||"data:"===e.substr(0,5)||"blob:"===e.substr(0,5)},Ja.IsRelativeURL=function(e){return!Ja.IsAbsoluteURL(e)},Ja.ThrowIfNotOk=function(e){if(!e.ok)throw new Error(`fetch '${e.url}' response returned ${e.status} ${e.statusText}`)},Ja.FetchOk=function(e,t){return fetch(e,t).then(e=>(Ja.ThrowIfNotOk(e),e))},Ja.FetchText=function(e){return Ja.FetchOk(e).then(e=>e.text())},Ja.FetchJson=function(e){return Ja.FetchOk(e).then(e=>e.json())},Ja.FetchBlob=function(e){return Ja.FetchOk(e).then(e=>e.blob())},Ja.FetchArrayBuffer=function(e){return Ja.FetchOk(e).then(e=>e.arrayBuffer())},Ja.FetchImage=function(e){return new Promise((t,s)=>{const i=new Image;i.onload=()=>t(i),i.onerror=e=>s(e),i.src=e})},Ja.BlobToArrayBuffer=function(e){return"function"==typeof e.arrayBuffer?e.arrayBuffer():new Promise((t,s)=>{const i=new FileReader;i.onload=()=>t(i.result),i.onerror=()=>s(i.error),i.readAsArrayBuffer(e)})},Ja.BlobToString=function(e){return"function"==typeof e.text?e.text():new Promise((t,s)=>{const i=new FileReader;i.onload=()=>t(i.result),i.onerror=()=>s(i.error),i.readAsText(e)})},Ja.BlobToJson=function(e){return Ja.BlobToString(e).then(e=>JSON.parse(e))},Ja.BlobToImage=async function(e,t){let s=URL.createObjectURL(e);try{const e=await Ja.FetchImage(s);return URL.revokeObjectURL(s),s="",t&&"function"==typeof e.decode&&await e.decode(),e}finally{s&&URL.revokeObjectURL(s)}},Ja.CreateCanvas=function(e,t){if("undefined"!=typeof document&&"function"==typeof document.createElement){const s=document.createElement("canvas");return s.width=e,s.height=t,s}return new OffscreenCanvas(e,t)},Ja.CanvasToBlob=function(e,t,s){if("number"!=typeof s&&(s=1),t=t||"image/png",s=Ja.clamp(s,0,1),e.convertToBlob)return e.convertToBlob({type:t,quality:s});if(e.toBlob)return new Promise(i=>e.toBlob(i,t,s));throw new Error("could not convert canvas to blob")},Ja.DrawableToBlob=function(e,t,s){const i=Ja.CreateCanvas(e.width,e.height);return i.getContext("2d").drawImage(e,0,0),Ja.CanvasToBlob(i,t,s)},Ja.ImageDataToBlob=function(e,t,s){if(Ja.Supports.ImageBitmapOptions)return createImageBitmap(e,{premultiplyAlpha:"none"}).then(e=>Ja.DrawableToBlob(e,t,s));if(Ja.Supports.ImageBitmap)return createImageBitmap(e).then(e=>Ja.DrawableToBlob(e,t,s));{const i=Ja.CreateCanvas(e.width,e.height);return i.getContext("2d").putImageData(e,0,0),Ja.CanvasToBlob(i,t,s)}},Ja.CopySet=function(e,t){e.clear();for(const s of t)e.add(s)},Ja.MapToObject=function(e){const t=Object.create(null);for(const[s,i]of e.entries())t[s]=i;return t},Ja.ObjectToMap=function(e,t){t.clear();for(const[s,i]of Object.entries(e))t.set(s,i)},Ja.ToSuperJSON=function e(t){if("object"==typeof t&&null!==t){if(t instanceof Set)return{_c3type_:"set",data:[...t].map(t=>e(t))};if(t instanceof Map)return{_c3type_:"map",data:[...t].map(t=>[t[0],e(t[1])])};{const s=Object.create(null);for(const[i,r]of Object.entries(t))s[i]=e(r);return s}}return t},Ja.FromSuperJSON=function e(t){if("object"==typeof t&null!==t){if("set"===t._c3type_)return new Set(t.data.map(t=>e(t)));if("map"===t._c3type_)return new Map(t.data.map(t=>[t[0],e(t[1])]));{const s=Object.create(null);for(const[i,r]of Object.entries(t))s[i]=e(r);return s}}return t},Ja.CSSToCamelCase=function(e){if(e.startsWith("--"))return e;let t="",s=!1,i=0;for(const r of e)"-"===r?i>0&&(s=!0):s?(t+=r.toUpperCase(),s=!1):t+=r,++i;return t},Ja.IsIterator=function(e){return"object"==typeof e&&"function"==typeof e.next},Ja.MakeFilledArray=function(e,t){const s=[];if("function"==typeof t)for(let i=0;i<e;++i)s.push(t());else for(let i=0;i<e;++i)s.push(t);return s}}{let Qa=function(e){return 0===e.length?"00":1===e.length?"0"+e:e},Za=function(e,t,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?e+6*(t-e)*s:s<.5?t:s<2/3?e+(t-e)*(2/3-s)*6:e};padTwoDigits=Qa,hueToRGB=Za;const eo=self.C3,to=/([0-9.]+),([0-9.]+)\%?,([0-9.]+)\%?/i,so=/([0-9.]+),([0-9.]+)\%?,([0-9.]+)\%?,([0-9.])/i;eo.Color=class{constructor(e,t,s,i){this._r=NaN,this._g=NaN,this._b=NaN,this._a=NaN,this._r=0,this._g=0,this._b=0,this._a=0,e instanceof eo.Color?this.set(e):this.setRgba(e||0,t||0,s||0,i||0)}setRgb(e,t,s){return this._r=+e,this._g=+t,this._b=+s,this.clamp(),this}setRgba(e,t,s,i){return this._r=+e,this._g=+t,this._b=+s,this._a=+i,this.clamp(),this}set(e){return this._r=e._r,this._g=e._g,this._b=e._b,this._a=e._a,this}copy(e){return this.set(e)}add(e){this._r+=e._r,this._g+=e._g,this._b+=e._b,this._a+=e._a,this.clamp()}addRgb(e,t,s,i=0){this._r+=+e,this._g+=+t,this._b+=+s,this._a+=+i,this.clamp()}diff(e){this.setR(Math.max(this._r,e._r)-Math.min(this._r,e._r)),this.setG(Math.max(this._g,e._g)-Math.min(this._g,e._g)),this.setB(Math.max(this._b,e._b)-Math.min(this._b,e._b)),this.setA(Math.max(this._a,e._a)-Math.min(this._a,e._a)),this.clamp()}copyRgb(e){this._r=e._r,this._g=e._g,this._b=e._b}setR(e){this._r=eo.clamp(+e,0,1)}getR(){return this._r}setG(e){this._g=eo.clamp(+e,0,1)}getG(){return this._g}setB(e){this._b=eo.clamp(+e,0,1)}getB(){return this._b}setA(e){this._a=eo.clamp(+e,0,1)}getA(){return this._a}clone(){return eo.New(eo.Color,this._r,this._g,this._b,this._a)}toArray(){return[this._r,this._g,this._b,this._a]}toTypedArray(){return new Float64Array(this.toArray())}writeToTypedArray(e,t){e[t++]=this._r,e[t++]=this._g,e[t++]=this._b,e[t]=this._a}writeToTypedArrayx4(e,t){const s=this._r,i=this._g,r=this._b,n=this._a;for(let a=0;a<4;++a)e[t++]=s,e[t++]=i,e[t++]=r,e[t++]=n}writeRGBToTypedArray(e,t){e[t++]=this._r,e[t++]=this._g,e[t]=this._b}equals(e){return this._r===e._r&&this._g===e._g&&this._b===e._b&&this._a===e._a}equalsIgnoringAlpha(e){return this._r===e._r&&this._g===e._g&&this._b===e._b}equalsRgb(e,t,s){return this._r===e&&this._g===t&&this._b===s}equalsRgba(e,t,s,i){return this._r===e&&this._g===t&&this._b===s&&this._a===i}equalsF32Array(e,t){return e[t]===Math.fround(this._r)&&e[t+1]===Math.fround(this._g)&&e[t+2]===Math.fround(this._b)&&e[t+3]===Math.fround(this._a)}equalsRGBF32Array(e,t){return e[t]===Math.fround(this._r)&&e[t+1]===Math.fround(this._g)&&e[t+2]===Math.fround(this._b)}multiply(e){this._r*=e._r,this._g*=e._g,this._b*=e._b,this._a*=e._a}multiplyAlpha(e){this._r*=e,this._g*=e,this._b*=e,this._a*=e}premultiply(){return this._r*=this._a,this._g*=this._a,this._b*=this._a,this}unpremultiply(){return this._r/=this._a,this._g/=this._a,this._b/=this._a,this}clamp(){return this._r=eo.clamp(this._r,0,1),this._g=eo.clamp(this._g,0,1),this._b=eo.clamp(this._b,0,1),this._a=eo.clamp(this._a,0,1),this}setFromRgbValue(e){this._r=eo.GetRValue(e),this._g=eo.GetGValue(e),this._b=eo.GetBValue(e),this._a=eo.GetAValue(e)}getCssRgb(e,t,s){return`rgb(${100*(eo.IsFiniteNumber(e)?e:this.getR())}%, ${100*(eo.IsFiniteNumber(t)?t:this.getG())}%, ${100*(eo.IsFiniteNumber(s)?s:this.getB())}%)`}getCssRgba(e,t,s,i){return`rgba(${100*(eo.IsFiniteNumber(e)?e:this.getR())}%, ${100*(eo.IsFiniteNumber(t)?t:this.getG())}%, ${100*(eo.IsFiniteNumber(s)?s:this.getB())}%, ${eo.IsFiniteNumber(i)?i:this.getA()})`}toHexString(){const e=Math.round(255*this.getR()),t=Math.round(255*this.getG()),s=Math.round(255*this.getB());return"#"+Qa(e.toString(16))+Qa(t.toString(16))+Qa(s.toString(16))}parseHexString(e){if("string"!=typeof e)return!1;let t,s,i;if("#"===(e=e.trim()).charAt(0)&&(e=e.substr(1)),3===e.length)t=parseInt(e[0],16)/15,s=parseInt(e[1],16)/15,i=parseInt(e[2],16)/15;else{if(6!==e.length)return!1;t=parseInt(e.substr(0,2),16)/255,s=parseInt(e.substr(2,2),16)/255,i=parseInt(e.substr(4,2),16)/255}return isFinite(t)&&this.setR(t),isFinite(s)&&this.setG(s),isFinite(i)&&this.setB(i),this.setA(1),!0}toCommaSeparatedRgb(){return`${Math.round(255*this.getR())}, ${Math.round(255*this.getG())}, ${Math.round(255*this.getB())}`}toRgbArray(){return[Math.round(255*this.getR()),Math.round(255*this.getG()),Math.round(255*this.getB())]}parseCommaSeparatedRgb(e){if("string"!=typeof e)return!1;const t=(e=e.replace(/^rgb\(|\)|%/,"")).split(",");if(t.length<3)return!1;const s=parseInt(t[0].trim(),10)/255,i=parseInt(t[1].trim(),10)/255,r=parseInt(t[2].trim(),10)/255;return isFinite(s)&&this.setR(s),isFinite(i)&&this.setG(i),isFinite(r)&&this.setB(r),this.setA(1),!0}parseCommaSeparatedPercentageRgb(e){if("string"!=typeof e)return!1;const t=(e=e.replace(/^rgb\(|\)|%/,"")).split(",");if(t.length<3)return!1;const s=parseInt(t[0].trim(),10)/100,i=parseInt(t[1].trim(),10)/100,r=parseInt(t[2].trim(),10)/100;return isFinite(s)&&this.setR(s),isFinite(i)&&this.setG(i),isFinite(r)&&this.setB(r),this.setA(1),!0}parseCommaSeparatedRgba(e){if("string"!=typeof e)return!1;const t=(e=e.replace(/^rgba\(|\)|%/,"")).split(",");if(t.length<4)return!1;const s=parseInt(t[0].trim(),10)/255,i=parseInt(t[1].trim(),10)/255,r=parseInt(t[2].trim(),10)/255,n=parseFloat(t[3].trim());return isFinite(s)&&this.setR(s),isFinite(i)&&this.setG(i),isFinite(r)&&this.setB(r),isFinite(n)&&this.setA(n),!0}parseCommaSeparatedPercentageRgba(e){if("string"!=typeof e)return!1;const t=(e=e.replace(/^rgba\(|\)|%/,"")).split(",");if(t.length<4)return!1;const s=parseInt(t[0].trim(),10)/100,i=parseInt(t[1].trim(),10)/100,r=parseInt(t[2].trim(),10)/100,n=parseFloat(t[3].trim());return isFinite(s)&&this.setR(s),isFinite(i)&&this.setG(i),isFinite(r)&&this.setB(r),isFinite(n)&&this.setA(n),!0}parseString(e){if("string"!=typeof e)return!1;if((e=e.replace(/\s+/,"")).includes(",")){if(e.startsWith("rgb("))return e.includes("%")?this.parseCommaSeparatedPercentageRgb(e):this.parseCommaSeparatedRgb(e);if(e.startsWith("rgba("))return e.includes("%")?this.parseCommaSeparatedPercentageRgba(e):this.parseCommaSeparatedRgba(e);if(e.startsWith("hsl(")||e.startsWith("hsla("))return this.parseHSLString(e);{const t=e.split(",");return e.includes("%")?3===t.length?this.parseCommaSeparatedPercentageRgb(e):4===t.length&&this.parseCommaSeparatedPercentageRgba(e):3===t.length?this.parseCommaSeparatedRgb(e):4===t.length&&this.parseCommaSeparatedRgba(e)}}return this.parseHexString(e)}toJSON(){return[this._r,this._g,this._b,this._a]}setFromHSLA(e,t,s,i){let r,n,a;if(e%=360,t=eo.clamp(t,0,100),s=eo.clamp(s,0,100),i=eo.clamp(i,0,1),e/=360,s/=100,0==(t/=100))r=n=a=s;else{const i=s<.5?s*(1+t):s+t-s*t,o=2*s-i;r=Za(o,i,e+1/3),n=Za(o,i,e),a=Za(o,i,e-1/3)}return this.setR(r),this.setG(n),this.setB(a),this.setA(i),this}parseHSLString(e){const t=e.replace(/ |hsl|hsla|\(|\)|;/gi,""),s=to.exec(t),i=so.exec(t);return s&&4===s.length?(this.setFromHSLA(+s[1],+s[2],+s[3],1),!0):!(!i||5!==i.length||(this.setFromHSLA(+s[1],+s[2],+s[3],+s[4]),0))}toHSLAString(){const e=this._r,t=this._g,s=this._b,i=this._a;return`hsla(${eo.Color.GetHue(e,t,s)}, ${eo.Color.GetSaturation(e,t,s)}%, ${eo.Color.GetLuminosity(e,t,s)}%, ${i})`}toHSLAArray(){const e=this._r,t=this._g,s=this._b;return[eo.Color.GetHue(e,t,s),eo.Color.GetSaturation(e,t,s),eo.Color.GetLuminosity(e,t,s),this._a]}setFromJSON(e){Array.isArray(e)&&(e.length<3||(this._r=e[0],this._g=e[1],this._b=e[2],e.length>=4?this._a=e[3]:this._a=1))}set r(e){this.setR(e)}get r(){return this.getR()}set g(e){this.setG(e)}get g(){return this.getG()}set b(e){this.setB(e)}get b(){return this.getB()}set a(e){this.setA(e)}get a(){return this.getA()}setAtIndex(e,t){switch(e){case 0:this.setR(t);break;case 1:this.setG(t);break;case 2:this.setB(t);break;case 3:this.setA(t);break;default:throw new RangeError("invalid color index")}}getAtIndex(e){switch(e){case 0:return this.getR();case 1:return this.getG();case 2:return this.getB();case 3:return this.getA();default:throw new RangeError("invalid color index")}}static Equals(e,t){let s,i;if(Array.isArray(e))s=new eo.Color,s.setFromJSON(e);else{if(!(e instanceof eo.Color))throw new Error("unexpected type");s=e}if(Array.isArray(t))i=new eo.Color,i.setFromJSON(t);else{if(!(t instanceof eo.Color))throw new Error("unexpected type");i=t}return s.equals(i)}static DiffChannel(e,t){return eo.clamp(Math.max(e,t)-Math.min(e,t),0,1)}static Diff(e,t){const s=new eo.Color;return s.setR(Math.max(e._r,t._r)-Math.min(e._r,t._r)),s.setG(Math.max(e._g,t._g)-Math.min(e._g,t._g)),s.setB(Math.max(e._b,t._b)-Math.min(e._b,t._b)),s.setA(Math.max(e._a,t._a)-Math.min(e._a,t._a)),s}static DiffNoAlpha(e,t){const s=new eo.Color(0,0,0,1);return s.setR(Math.max(e._r,t._r)-Math.min(e._r,t._r)),s.setG(Math.max(e._g,t._g)-Math.min(e._g,t._g)),s.setB(Math.max(e._b,t._b)-Math.min(e._b,t._b)),s}static GetHue(e,t,s){const i=Math.max(e,t,s),r=Math.min(e,t,s);if(i===r)return 0;let n=0;switch(i){case e:n=(t-s)/(i-r)+(t<s?6:0);break;case t:n=(s-e)/(i-r)+2;break;case s:n=(e-t)/(i-r)+4}return Math.round(n/6*360)}static GetSaturation(e,t,s){const i=Math.max(e,t,s),r=Math.min(e,t,s);if(i===r)return 0;const n=i-r,a=(i+r)/2>.5?n/(2-i-r):n/(i+r);return Math.round(100*a)}static GetLuminosity(e,t,s){const i=Math.max(e,t,s),r=(i+Math.min(e,t,s))/2;return i?Math.round(100*r):0}},eo.Color.White=Object.freeze(eo.New(eo.Color,1,1,1,1)),eo.Color.Black=Object.freeze(eo.New(eo.Color,0,0,0,1)),eo.Color.TransparentBlack=Object.freeze(eo.New(eo.Color,0,0,0,0))}{const io=self.C3;io.Vector2=class{constructor(e,t){this._x=0,this._y=0,e instanceof io.Vector2?this.copy(e):this.set(e||0,t||0)}set(e,t){this._x=+e,this._y=+t}copy(e){this._x=e._x,this._y=e._y}equals(e){return this._x===e._x&&this._y===e._y}equalsValues(e,t){return this._x===e&&this._y===t}equalsF32Array(e,t){return e[t]===Math.fround(this._x)&&e[t+1]===Math.fround(this._y)}setX(e){this._x=+e}getX(){return this._x}setY(e){this._y=+e}getY(){return this._y}toArray(){return[this._x,this._y]}toTypedArray(){return new Float64Array(this.toArray())}writeToTypedArray(e,t){e[t++]=this._x,e[t]=this._y}offset(e,t){this._x+=+e,this._y+=+t}scale(e,t){this._x*=e,this._y*=t}divide(e,t){this._x/=e,this._y/=t}round(){this._x=Math.round(this._x),this._y=Math.round(this._y)}floor(){this._x=Math.floor(this._x),this._y=Math.floor(this._y)}ceil(){this._x=Math.ceil(this._x),this._y=Math.ceil(this._y)}angle(){return io.angleTo(0,0,this._x,this._y)}lengthSquared(){return this._x*this._x+this._y*this._y}length(){return io.hypot2DFast(this._x,this._y)}rotatePrecalc(e,t){const s=this._x*t-this._y*e;this._y=this._y*t+this._x*e,this._x=s}rotate(e){0!==e&&this.rotatePrecalc(Math.sin(e),Math.cos(e))}rotateAbout(e,t,s){0===e||t===this._x&&s===this._y||(this._x-=t,this._y-=s,this.rotatePrecalc(Math.sin(e),Math.cos(e)),this._x+=+t,this._y+=+s)}move(e,t){0!==t&&(this._x+=Math.cos(e)*t,this._y+=Math.sin(e)*t)}normalize(){const e=this.length();0!==e&&1!==e&&(this._x/=e,this._y/=e)}clamp(e,t){this._x=io.clamp(this._x,e,t),this._y=io.clamp(this._y,e,t)}dot(e){return this._x*e._x+this._y*e._y}reverse(){this._x=-this._x,this._y=-this._y}perp(){let e=this._x;return this._x=this._y,this._y=-e,this}}}{const ro=self.C3;ro.Rect=class{constructor(e,t,s,i){this._left=NaN,this._top=NaN,this._right=NaN,this._bottom=NaN,this._left=0,this._top=0,this._right=0,this._bottom=0,e instanceof ro.Rect?this.copy(e):this.set(e||0,t||0,s||0,i||0)}set(e,t,s,i){this._left=+e,this._top=+t,this._right=+s,this._bottom=+i}setWH(e,t,s,i){e=+e,t=+t,this._left=e,this._top=t,this._right=e+ +s,this._bottom=t+ +i}copy(e){this._left=+e._left,this._top=+e._top,this._right=+e._right,this._bottom=+e._bottom}clone(){return new ro.Rect(this._left,this._top,this._right,this._bottom)}static Merge(e,t){const s=new ro.Rect;return s.setLeft(Math.min(e._left,t._left)),s.setTop(Math.min(e._top,t._top)),s.setRight(Math.max(e._right,t._right)),s.setBottom(Math.max(e._bottom,t._bottom)),s}static FromObject(e){return new ro.Rect(e.left,e.top,e.right,e.bottom)}equals(e){return this._left===e._left&&this._top===e._top&&this._right===e._right&&this._bottom===e._bottom}equalsWH(e,t,s,i){return this._left===e&&this._top===t&&this.width()===s&&this.height()===i}equalsF32Array(e,t){return e[t]===Math.fround(this._left)&&e[t+1]===Math.fround(this._top)&&e[t+2]===Math.fround(this._right)&&e[t+3]===Math.fround(this._bottom)}setLeft(e){this._left=+e}getLeft(){return this._left}setTop(e){this._top=+e}getTop(){return this._top}setRight(e){this._right=+e}getRight(){return this._right}setBottom(e){this._bottom=+e}getBottom(){return this._bottom}toArray(){return[this._left,this._top,this._right,this._bottom]}toTypedArray(){return new Float64Array(this.toArray())}toDOMRect(){return new DOMRect(this._left,this._top,this.width(),this.height())}static fromDOMRect(e){return ro.New(ro.Rect,e.left,e.top,e.right,e.bottom)}writeToTypedArray(e,t){e[t++]=this._left,e[t++]=this._top,e[t++]=this._right,e[t]=this._bottom}writeAsQuadToTypedArray(e,t){e[t++]=this._left,e[t++]=this._top,e[t++]=this._right,e[t++]=this._top,e[t++]=this._right,e[t++]=this._bottom,e[t++]=this._left,e[t]=this._bottom}writeAsQuadToTypedArray3D(e,t,s){e[t++]=this._left,e[t++]=this._top,e[t++]=s,e[t++]=this._right,e[t++]=this._top,e[t++]=s,e[t++]=this._right,e[t++]=this._bottom,e[t++]=s,e[t++]=this._left,e[t++]=this._bottom,e[t]=s}width(){return this._right-this._left}height(){return this._bottom-this._top}midX(){return(this._left+this._right)/2}midY(){return(this._top+this._bottom)/2}offset(e,t){e=+e,t=+t,this._left+=e,this._top+=t,this._right+=e,this._bottom+=t}offsetLeft(e){this._left+=+e}offsetTop(e){this._top+=+e}offsetRight(e){this._right+=+e}offsetBottom(e){this._bottom+=+e}toSquare(e){if("x"!==e)throw new Error("invalid axis, only 'x' supported");this._top<this._bottom?this._left<this._right?this._bottom=this._top+this.width():this._bottom=this._top-this.width():this._left<this._right?this._bottom=this._top-this.width():this._bottom=this._top+this.width()}inflate(e,t){e=+e,t=+t,this._left-=e,this._top-=t,this._right+=e,this._bottom+=t}deflate(e,t){e=+e,t=+t,this._left+=e,this._top+=t,this._right-=e,this._bottom-=t}multiply(e,t){this._left*=e,this._top*=t,this._right*=e,this._bottom*=t}divide(e,t){this._left/=e,this._top/=t,this._right/=e,this._bottom/=t}mirrorAround(e){this._left=+e-this._left,this._right=+e-this._right}flipAround(e){this._top=+e-this._top,this._bottom=+e-this._bottom}rotate90DegreesAround(e,t){const s=this.width(),i=this.height(),r=this.getLeft()+s*e,n=this.getTop()+i*t;this.setWH(r-i*t,n-s*e,i,s)}swapLeftRight(){const e=this._left;this._left=this._right,this._right=e}swapTopBottom(){const e=this._top;this._top=this._bottom,this._bottom=e}shuntY(e){const t=this._top;this._top=+e-this._bottom,this._bottom=+e-t}round(){this._left=Math.round(this._left),this._top=Math.round(this._top),this._right=Math.round(this._right),this._bottom=Math.round(this._bottom)}roundInner(){this._left=Math.ceil(this._left),this._top=Math.ceil(this._top),this._right=Math.floor(this._right),this._bottom=Math.floor(this._bottom)}roundOuter(){this._left=Math.floor(this._left),this._top=Math.floor(this._top),this._right=Math.ceil(this._right),this._bottom=Math.ceil(this._bottom)}floor(){this._left=Math.floor(this._left),this._top=Math.floor(this._top),this._right=Math.floor(this._right),this._bottom=Math.floor(this._bottom)}ceil(){this._left=Math.ceil(this._left),this._top=Math.ceil(this._top),this._right=Math.ceil(this._right),this._bottom=Math.ceil(this._bottom)}clamp(e,t,s,i){this._left=Math.max(this._left,+e),this._top=Math.max(this._top,+t),this._right=Math.min(this._right,+s),this._bottom=Math.min(this._bottom,+i)}clampBoth(e,t,s,i){e=+e,t=+t,s=+s,i=+i,this._left=ro.clamp(this._left,e,s),this._top=ro.clamp(this._top,t,i),this._right=ro.clamp(this._right,e,s),this._bottom=ro.clamp(this._bottom,t,i)}normalize(){this._left>this._right&&this.swapLeftRight(),this._top>this._bottom&&this.swapTopBottom()}intersectsRect(e){return!(e._right<this._left||e._bottom<this._top||e._left>this._right||e._top>this._bottom)}intersectsRectOffset(e,t,s){return!(e._right+t<this._left||e._bottom+s<this._top||e._left+t>this._right||e._top+s>this._bottom)}containsPoint(e,t){return e>=this._left&&e<=this._right&&t>=this._top&&t<=this._bottom}containsRect(e){return e._left>=this._left&&e._top>=this._top&&e._right<=this._right&&e._bottom<=this._bottom}expandToContain(e){e._left<this._left&&(this._left=+e._left),e._top<this._top&&(this._top=+e._top),e._right>this._right&&(this._right=+e._right),e._bottom>this._bottom&&(this._bottom=+e._bottom)}lerpInto(e){this._left=ro.lerp(e._left,e._right,this._left),this._top=ro.lerp(e._top,e._bottom,this._top),this._right=ro.lerp(e._left,e._right,this._right),this._bottom=ro.lerp(e._top,e._bottom,this._bottom)}}}{const no=self.C3;no.Quad=class{constructor(e,t,s,i,r,n,a,o){this._tlx=NaN,this._tly=NaN,this._trx=NaN,this._try=NaN,this._brx=NaN,this._bry=NaN,this._blx=NaN,this._bly=NaN,this._tlx=0,this._tly=0,this._trx=0,this._try=0,this._brx=0,this._bry=0,this._blx=0,this._bly=0,e instanceof no.Quad?this.copy(e):this.set(e||0,t||0,s||0,i||0,r||0,n||0,a||0,o||0)}set(e,t,s,i,r,n,a,o){this._tlx=+e,this._tly=+t,this._trx=+s,this._try=+i,this._brx=+r,this._bry=+n,this._blx=+a,this._bly=+o}setRect(e,t,s,i){this.set(e,t,s,t,s,i,e,i)}copy(e){this._tlx=e._tlx,this._tly=e._tly,this._trx=e._trx,this._try=e._try,this._brx=e._brx,this._bry=e._bry,this._blx=e._blx,this._bly=e._bly}equals(e){return this._tlx===e._tlx&&this._tly===e._tly&&this._trx===e._trx&&this._try===e._try&&this._brx===e._brx&&this._bry===e._bry&&this._blx===e._blx&&this._bly===e._bly}setTlx(e){this._tlx=+e}getTlx(){return this._tlx}setTly(e){this._tly=+e}getTly(){return this._tly}setTrx(e){this._trx=+e}getTrx(){return this._trx}setTry(e){this._try=+e}getTry(){return this._try}setBrx(e){this._brx=+e}getBrx(){return this._brx}setBry(e){this._bry=+e}getBry(){return this._bry}setBlx(e){this._blx=+e}getBlx(){return this._blx}setBly(e){this._bly=+e}getBly(){return this._bly}toDOMQuad(){return new DOMQuad(new DOMPoint(this._tlx,this._tly),new DOMPoint(this._trx,this._try),new DOMPoint(this._brx,this._bry),new DOMPoint(this._blx,this._bly))}static fromDOMQuad(e){return no.New(no.Quad,e.p1.x,e.p1.y,e.p2.x,e.p2.y,e.p3.x,e.p3.y,e.p4.x,e.p4.y)}toArray(){return[this._tlx,this._tly,this._trx,this._try,this._brx,this._bry,this._blx,this._bly]}toTypedArray(){return new Float64Array(this.toArray())}writeToTypedArray(e,t){e[t++]=this._tlx,e[t++]=this._tly,e[t++]=this._trx,e[t++]=this._try,e[t++]=this._brx,e[t++]=this._bry,e[t++]=this._blx,e[t]=this._bly}writeToTypedArray3D(e,t,s){e[t++]=this._tlx,e[t++]=this._tly,e[t++]=s,e[t++]=this._trx,e[t++]=this._try,e[t++]=s,e[t++]=this._brx,e[t++]=this._bry,e[t++]=s,e[t++]=this._blx,e[t++]=this._bly,e[t]=s}offset(e,t){e=+e,t=+t,this._tlx+=e,this._tly+=t,this._trx+=e,this._try+=t,this._brx+=e,this._bry+=t,this._blx+=e,this._bly+=t}round(){this._tlx=Math.round(this._tlx),this._tly=Math.round(this._tly),this._trx=Math.round(this._trx),this._try=Math.round(this._try),this._brx=Math.round(this._brx),this._bry=Math.round(this._bry),this._blx=Math.round(this._blx),this._bly=Math.round(this._bly)}floor(){this._tlx=Math.floor(this._tlx),this._tly=Math.floor(this._tly),this._trx=Math.floor(this._trx),this._try=Math.floor(this._try),this._brx=Math.floor(this._brx),this._bry=Math.floor(this._bry),this._blx=Math.floor(this._blx),this._bly=Math.floor(this._bly)}ceil(){this._tlx=Math.ceil(this._tlx),this._tly=Math.ceil(this._tly),this._trx=Math.ceil(this._trx),this._try=Math.ceil(this._try),this._brx=Math.ceil(this._brx),this._bry=Math.ceil(this._bry),this._blx=Math.ceil(this._blx),this._bly=Math.ceil(this._bly)}setFromRect(e){this._tlx=e._left,this._tly=e._top,this._trx=e._right,this._try=e._top,this._brx=e._right,this._bry=e._bottom,this._blx=e._left,this._bly=e._bottom}setFromRotatedRect(e,t){0===t?this.setFromRect(e):this.setFromRotatedRectPrecalc(e,Math.sin(t),Math.cos(t))}setFromRotatedRectPrecalc(e,t,s){const i=e._left*t,r=e._top*t,n=e._right*t,a=e._bottom*t,o=e._left*s,l=e._top*s,h=e._right*s,u=e._bottom*s;this._tlx=o-r,this._tly=l+i,this._trx=h-r,this._try=l+n,this._brx=h-a,this._bry=u+n,this._blx=o-a,this._bly=u+i}getBoundingBox(e){e.set(Math.min(this._tlx,this._trx,this._brx,this._blx),Math.min(this._tly,this._try,this._bry,this._bly),Math.max(this._tlx,this._trx,this._brx,this._blx),Math.max(this._tly,this._try,this._bry,this._bly))}containsPoint(e,t){let s=this._trx-this._tlx,i=this._try-this._tly;const r=this._brx-this._tlx,n=this._bry-this._tly,a=e-this._tlx,o=t-this._tly;let l=s*s+i*i,h=s*r+i*n,u=s*a+i*o;const c=r*r+n*n,d=r*a+n*o;let p=1/(l*c-h*h),_=(c*u-h*d)*p,m=(l*d-h*u)*p;return _>=0&&m>0&&_+m<1||(s=this._blx-this._tlx,i=this._bly-this._tly,l=s*s+i*i,h=s*r+i*n,u=s*a+i*o,p=1/(l*c-h*h),_=(c*u-h*d)*p,m=(l*d-h*u)*p,_>=0&&m>0&&_+m<1)}midX(){return(this._tlx+this._trx+this._brx+this._blx)/4}midY(){return(this._tly+this._try+this._bry+this._bly)/4}intersectsSegment(e,t,s,i){return!(!this.containsPoint(e,t)&&!this.containsPoint(s,i))||no.segmentIntersectsQuad(e,t,s,i,this)}intersectsQuad(e){let t=e.midX(),s=e.midY();if(this.containsPoint(t,s))return!0;if(t=this.midX(),s=this.midY(),e.containsPoint(t,s))return!0;const i=this._tlx,r=this._tly,n=this._trx,a=this._try,o=this._brx,l=this._bry,h=this._blx,u=this._bly;return no.segmentIntersectsQuad(i,r,n,a,e)||no.segmentIntersectsQuad(n,a,o,l,e)||no.segmentIntersectsQuad(o,l,h,u,e)||no.segmentIntersectsQuad(h,u,i,r,e)}rotatePointsAnticlockwise(){const e=this._tlx,t=this._tly;this._tlx=this._trx,this._tly=this._try,this._trx=this._brx,this._try=this._bry,this._brx=this._blx,this._bry=this._bly,this._blx=e,this._bly=t}mirror(){this._swap(0,2),this._swap(1,3),this._swap(6,4),this._swap(7,5)}flip(){this._swap(0,6),this._swap(1,7),this._swap(2,4),this._swap(3,5)}diag(){this._swap(2,6),this._swap(3,7)}_swap(e,t){const s=this._getAtIndex(e);this._setAtIndex(e,this._getAtIndex(t)),this._setAtIndex(t,s)}_getAtIndex(e){switch(e){case 0:return this._tlx;case 1:return this._tly;case 2:return this._trx;case 3:return this._try;case 4:return this._brx;case 5:return this._bry;case 6:return this._blx;case 7:return this._bly;default:throw new RangeError("invalid quad point index")}}_setAtIndex(e,t){switch(t=+t,e){case 0:this._tlx=t;break;case 1:this._tly=t;break;case 2:this._trx=t;break;case 3:this._try=t;break;case 4:this._brx=t;break;case 5:this._bry=t;break;case 6:this._blx=t;break;case 7:this._bly=t;break;default:throw new RangeError("invalid quad point index")}}divide(e,t){this._tlx/=e,this._tly/=t,this._trx/=e,this._try/=t,this._brx/=e,this._bry/=t,this._blx/=e,this._bly/=t}}}{const ao=self.C3,oo=self.assert,lo=[0,0,1,0,1,1,0,1],ho=ao.New(ao.Quad);ao.CollisionPoly=class extends ao.DefendedBase{constructor(e,t=!0){super(),e||(e=lo),this._ptsArr=Float64Array.from(e),this._bbox=new ao.Rect,this._isBboxChanged=!0,this._enabled=t}Release(){}pointsArr(){return this._ptsArr}pointCount(){return this._ptsArr.length/2}setPoints(e){this._ptsArr.length===e.length?this._ptsArr.set(e):this._ptsArr=Float64Array.from(e),this._isBboxChanged=!0}setDefaultPoints(){this.setPoints(lo)}copy(e){this.setPoints(e._ptsArr)}setBboxChanged(){this._isBboxChanged=!0}_updateBbox(){if(!this._isBboxChanged)return;const e=this._ptsArr;let t=e[0],s=e[1],i=t,r=s;for(let n=0,a=e.length;n<a;n+=2){const a=e[n],o=e[n+1];a<t&&(t=a),a>i&&(i=a),o<s&&(s=o),o>r&&(r=o)}this._bbox.set(t,s,i,r),this._isBboxChanged=!1}setFromRect(e,t,s){let i=this._ptsArr;8!==i.length&&(i=new Float64Array(8),this._ptsArr=i),i[0]=e.getLeft()-t,i[1]=e.getTop()-s,i[2]=e.getRight()-t,i[3]=e.getTop()-s,i[4]=e.getRight()-t,i[5]=e.getBottom()-s,i[6]=e.getLeft()-t,i[7]=e.getBottom()-s,this._bbox.copy(e),0===t&&0===s||this._bbox.offset(-t,-s),this._isBboxChanged=!1}setFromQuad(e,t,s){ho.copy(e),ho.offset(t,s),this.setPoints(ho.toArray()),this._isBboxChanged=!0}transform(e,t,s){let i=0,r=1;0!==s&&(i=Math.sin(s),r=Math.cos(s)),this.transformPrecalc(e,t,i,r)}transformPrecalc(e,t,s,i){const r=this._ptsArr;for(let n=0,a=r.length;n<a;n+=2){const a=n+1,o=r[n]*e,l=r[a]*t;r[n]=o*i-l*s,r[a]=l*i+o*s}this._isBboxChanged=!0}offset(e,t){const s=this._ptsArr;for(let i=0,r=s.length;i<r;i+=2)s[i]+=e,s[i+1]+=t}containsPoint(e,t){const s=this._ptsArr;if(e===s[0]&&t===s[1])return!0;this._updateBbox();const i=this._bbox,r=i.getLeft()-110,n=i.getTop()-101,a=i.getRight()+131,o=i.getBottom()+120;let l=0,h=0,u=0,c=0,d=0,p=0,_=0,m=0;r<e?(l=r,u=e):(l=e,u=r),n<t?(h=n,c=t):(h=t,c=n),a<e?(d=a,_=e):(d=e,_=a),o<t?(p=o,m=t):(p=t,m=o);let f=0,g=0;for(let i=0,y=s.length;i<y;i+=2){const S=(i+2)%y,T=s[i],x=s[i+1],b=s[S],G=s[S+1];ao.segmentsIntersectPreCalc(r,n,e,t,l,u,h,c,T,x,b,G)&&++f,ao.segmentsIntersectPreCalc(a,o,e,t,d,_,p,m,T,x,b,G)&&++g}return f%2==1||g%2==1}intersectsPoly(e,t,s){const i=e._ptsArr,r=this._ptsArr;if(this.containsPoint(i[0]+t,i[1]+s))return!0;if(e.containsPoint(r[0]-t,r[1]-s))return!0;for(let e=0,n=r.length;e<n;e+=2){const a=(e+2)%n,o=r[e],l=r[e+1],h=r[a],u=r[a+1];let c=0,d=0,p=0,_=0;o<h?(c=o,p=h):(c=h,p=o),l<u?(d=l,_=u):(d=u,_=l);for(let e=0,r=i.length;e<r;e+=2){const n=(e+2)%r,a=i[e]+t,m=i[e+1]+s,f=i[n]+t,g=i[n+1]+s;if(ao.segmentsIntersectPreCalc(o,l,h,u,c,p,d,_,a,m,f,g))return!0}}return!1}intersectsSegment(e,t,s,i,r,n){if(this.containsPoint(s-e,i-t))return!0;if(this.containsPoint(r-e,n-t))return!0;let a=0,o=0,l=0,h=0;s<r?(a=s,l=r):(a=r,l=s),i<n?(o=i,h=n):(o=n,h=i);const u=this._ptsArr;for(let c=0,d=u.length;c<d;c+=2){const p=(c+2)%d,_=u[c]+e,m=u[c+1]+t,f=u[p]+e,g=u[p+1]+t;if(ao.segmentsIntersectPreCalc(s,i,r,n,a,l,o,h,_,m,f,g))return!0}return!1}mirror(e){const t=this._ptsArr;for(let s=0,i=t.length;s<i;s+=2)t[s]=2*e-t[s];this._isBboxChanged=!0}flip(e){const t=this._ptsArr;for(let s=0,i=t.length;s<i;s+=2){const i=s+1;t[i]=2*e-t[i]}this._isBboxChanged=!0}diag(){const e=this._ptsArr;for(let t=0,s=e.length;t<s;t+=2){const s=t+1,i=e[t];e[t]=e[s],e[s]=i}this._isBboxChanged=!0}GetMidX(){const e=this._ptsArr;let t=0;for(let s=0,i=e.length;s<i;s+=2)t+=e[s];return t/this.pointCount()}GetMidY(){const e=this._ptsArr;let t=0;for(let s=0,i=e.length;s<i;s+=2)t+=e[s+1];return t/this.pointCount()}GetPointsArray(){return this._ptsArr}GetPointCount(){return this.pointCount()}IsEnabled(){return this._enabled}}}{const uo=self.C3;uo.PairMap=class extends uo.DefendedBase{constructor(e){if(super(),this._firstMap=new Map,e)for(const[t,s,i]of e)this.Set(t,s,i)}Release(){this.Clear(),this._firstMap=null}IsEmpty(){return 0===this._firstMap.size}Clear(){const e=this._firstMap;for(const t of e.values())t.clear();e.clear()}Set(e,t,s){const i=this._firstMap;let r=i.get(e);r||(r=new Map,i.set(e,r)),r.set(t,s)}Get(e,t){const s=this._firstMap.get(e);return s?s.get(t):s}Has(e,t){const s=this._firstMap.get(e);return!!s&&s.has(t)}Delete(e,t){const s=this._firstMap,i=s.get(e);if(!i)return!1;const r=i.delete(t);return r&&0===i.size&&s.delete(e),r}DeleteEither(e){const t=this._firstMap,s=t.get(e);s&&(s.clear(),t.delete(e));for(const[s,i]of t.entries())i.delete(e)&&0===i.size&&t.delete(s)}GetSize(){let e=0;for(const t of this._firstMap.values())e+=t.size;return e}*values(){for(const e of this._firstMap.values())yield*e.values()}*keyPairs(){for(const[e,t]of this._firstMap.entries())for(const s of t.keys())yield[e,s]}*entries(){for(const[e,t]of this._firstMap.entries())for(const[s,i]of t.entries())yield[e,s,i]}}}{const co=self.C3;co.ArraySet=class extends co.DefendedBase{constructor(){super(),this._set=new Set,this._arr=[],this._needToRebuildArray=!1}Release(){this.Clear()}Clear(){this._set.clear(),co.clearArray(this._arr),this._needToRebuildArray=!1}Add(e){this._set.has(e)||(this._set.add(e),this._needToRebuildArray||this._arr.push(e))}Has(e){return this._set.has(e)}Delete(e){this._set.delete(e)&&(this._needToRebuildArray=!0)}GetSize(){return this._set.size}IsEmpty(){return 0===this._set.size}GetArray(){return this._needToRebuildArray&&(this._RebuildArray(),this._needToRebuildArray=!1),this._arr}_RebuildArray(){const e=this._arr;co.clearArray(e);for(const t of this._set)e.push(t)}}}{const po=self.C3,_o=new Map,mo=new Map,fo=new Map,go=new Map,yo=new Map,So=new Map,To=new Map,xo=new Map,bo=new Map;bo.set("linear","noease"),bo.set("default","noease");const Go=["default","noease","easeinquad","easeoutquad","easeinoutquad","easeincubic","easeoutcubic","easeinoutcubic","easeinquart","easeoutquart","easeinoutquart","easeinquint","easeoutquint","easeinoutquint","easeinsine","easeoutsine","easeinoutsine","easeinexpo","easeoutexpo","easeinoutexpo","easeincirc","easeoutcirc","easeinoutcirc","easeinelastic","easeoutelastic","easeinoutelastic","easeinback","easeoutback","easeinoutback","easeinbounce","easeoutbounce","easeinoutbounce"],Io=["default","noease","quad","cubic","quart","quint","sine","expo","circ","elastic","back","bounce"],vo=new Map([["linear","noease"],["in-sine","easeinsine"],["out-sine","easeoutsine"],["in-out-sine","easeinoutsine"],["in-elastic","easeinelastic"],["out-elastic","easeoutelastic"],["in-out-elastic","easeinoutelastic"],["in-back","easeinback"],["out-back","easeoutback"],["in-out-back","easeinoutback"],["in-bounce","easeinbounce"],["out-bounce","easeoutbounce"],["in-out-bounce","easeinoutbounce"],["in-cubic","easeincubic"],["out-cubic","easeoutcubic"],["in-out-cubic","easeinoutcubic"],["in-quadratic","easeinquad"],["out-quadratic","easeoutquad"],["in-out-quadratic","easeinoutquad"],["in-quartic","easeinquart"],["out-quartic","easeoutquart"],["in-out-quartic","easeinoutquart"],["in-quintic","easeinquint"],["out-quintic","easeoutquint"],["in-out-quintic","easeinoutquint"],["in-circular","easeincirc"],["out-circular","easeoutcirc"],["in-out-circular","easeinoutcirc"],["in-exponential","easeinexpo"],["out-exponential","easeoutexpo"],["in-out-exponential","easeinoutexpo"]]);self.Ease=class e{constructor(){}static InheritEase(){return"default"}static DefaultEase(){return"noease"}static ToInternal(e){return vo.get(e)}static GetEditorEaseNames(t,...s){let i,r;this._CreateEaseMap(),t?(fo.has(t)||fo.set(t,new Map),i=fo.get(t),r=[...i.keys()].filter(s=>!e.GetEditorEaseData(s,t)||e.GetEditorEaseData(s,t).transition.IsForAnyPurpose())):(i=yo,r=[...i.keys()]);const n=r.sort();return[...mo.keys()].concat(n).filter(e=>!s.includes(e))}static GetRuntimeEaseNames(){this._CreateEaseMap();const e=[...yo.keys()];return e.sort(),[...mo.keys()].concat(e)}static GetCustomRuntimeEaseNames(){this._CreateEaseMap();const e=[...yo.keys()];return e.sort(),e}static IsPredefinedTranslatedName(e){for(const t of Go)if(self.lang(`ui.bars.timeline.eases.${t}`)===e)return!0;for(const t of Io)if(self.lang(`ui.bars.timeline.short-eases.${t}`)===e)return!0}static IsNamePredefined(e){return this._CreateEaseMap(),[...mo.keys()].includes(e)}static _GetEase(t){const s=bo.get(t);return s?_o.get(s):e.IsNamePredefined(t)?_o.get(t):To.has(t)?To.get(t):void 0}static GetBuiltInTransition(e){return this._CreateEaseMap(),xo.get(e)}static GetEditorEase(t,s){this._CreateEaseMap();const i=e._GetEase(t);if(i)return i;if(!s)throw new Error("missing ease function");return fo.get(s).get(t)}static GetEditorEaseData(e,t){this._CreateEaseMap();const s=go.get(t);if(s)return s.get(e)}static HasEditorEase(t,s){return this._CreateEaseMap(),!!e._GetEase(t)||!!fo.get(s).get(t)}static GetRuntimeEase(t){this._CreateEaseMap();return e._GetEase(t)||yo.get(t)}static GetRuntimeEaseData(e){return this._CreateEaseMap(),So.get(e)}static GetEaseFromIndex(e){return this._CreateEaseMap(),this.GetRuntimeEaseNames()[e]}static GetIndexForEase(e,t){return this._CreateEaseMap(),this.GetEditorEaseNames(t).indexOf(e)}static GetIndexForEaseAtRuntime(e){return this.GetIndexForEase(e)}static _CreateEaseMap(){0===_o.size&&(this._AddPredifinedEase("default",()=>{}),this._AddPredifinedEase("noease",[{x:0,y:0,sax:.336,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.336,eay:0,se:!1,ee:!0}],!0),this._AddPredifinedEase("easeinsine",[{x:0,y:0,sax:.485,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.038,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutsine",[{x:0,y:0,sax:.038,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.485,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutsine",[{x:0,y:0,sax:.336,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.336,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinelastic",[{x:0,y:0,sax:.018,say:0,eax:0,eay:0,se:!0,ee:!1},{x:.116,y:.002,sax:.025,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:.266,y:-.005,sax:.024,say:0,eax:-.021,eay:0,se:!0,ee:!0},{x:.416,y:.016,sax:.024,say:0,eax:-.026,eay:0,se:!0,ee:!0},{x:.566,y:-.045,sax:.061,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:.716,y:.132,sax:.072,say:-.004,eax:-.045,eay:0,se:!0,ee:!0},{x:.866,y:-.373,sax:.06,say:0,eax:-.049,eay:-.002,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.038,eay:-.263,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutelastic",[{x:0,y:0,sax:.038,say:.263,eax:0,eay:0,se:!0,ee:!1},{x:.136,y:1.373,sax:.049,say:.002,eax:-.06,eay:0,se:!0,ee:!0},{x:.286,y:.868,sax:.045,say:0,eax:-.072,eay:.004,se:!0,ee:!0},{x:.436,y:1.045,sax:.025,say:0,eax:-.061,eay:0,se:!0,ee:!0},{x:.586,y:.984,sax:.026,say:0,eax:-.024,eay:0,se:!0,ee:!0},{x:.736,y:1.005,sax:.021,say:0,eax:-.024,eay:0,se:!0,ee:!0},{x:.886,y:.998,sax:.025,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.018,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutelastic",[{x:0,y:0,sax:.025,say:0,eax:0,eay:0,se:!0,ee:!1},{x:.067,y:.001,sax:.025,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:.18,y:-.005,sax:.025,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:.292,y:.025,sax:.053,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:.405,y:-.118,sax:.069,say:0,eax:-.027,eay:0,se:!0,ee:!0},{x:.597,y:1.118,sax:.027,say:0,eax:-.069,eay:0,se:!0,ee:!0},{x:.71,y:.975,sax:.025,say:0,eax:-.053,eay:0,se:!0,ee:!0},{x:.822,y:1.005,sax:.025,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:.935,y:.999,sax:.025,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.025,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinback",[{x:0,y:0,sax:.35,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.34,eay:-1.579,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutback",[{x:0,y:0,sax:.34,say:1.579,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.35,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutback",[{x:0,y:0,sax:.035,say:0,eax:0,eay:0,se:!0,ee:!1},{x:.242,y:-.1,sax:.258,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:.76,y:1.1,sax:.025,say:0,eax:-.26,eay:0,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.035,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinbounce",[{x:0,y:0,sax:.033,say:.025,eax:0,eay:0,se:!0,ee:!1},{x:.092,y:0,sax:.026,say:.078,eax:-.033,eay:.025,se:!0,ee:!0},{x:.274,y:0,sax:.097,say:.319,eax:-.026,eay:.078,se:!0,ee:!0},{x:.637,y:0,sax:.105,say:.625,eax:-.097,eay:.319,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.125,eay:-.004,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutbounce",[{x:0,y:0,sax:.125,say:.004,eax:0,eay:0,se:!0,ee:!1},{x:.365,y:1,sax:.097,say:-.319,eax:-.105,eay:-.625,se:!0,ee:!0},{x:.728,y:1,sax:.026,say:-.078,eax:-.097,eay:-.319,se:!0,ee:!0},{x:.91,y:1,sax:.033,say:-.025,eax:-.026,eay:-.078,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.033,eay:-.025,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutbounce",[{x:0,y:0,sax:.01,say:.006,eax:0,eay:0,se:!0,ee:!1},{x:.046,y:0,sax:.021,say:.038,eax:-.01,eay:.006,se:!0,ee:!0},{x:.137,y:0,sax:.059,say:.158,eax:-.021,eay:.038,se:!0,ee:!0},{x:.319,y:0,sax:.117,say:.744,eax:-.059,eay:.158,se:!0,ee:!0},{x:.683,y:1,sax:.059,say:-.158,eax:-.117,eay:-.744,se:!0,ee:!0},{x:.865,y:1,sax:.021,say:-.038,eax:-.059,eay:-.158,se:!0,ee:!0},{x:.956,y:1,sax:.01,say:-.006,eax:-.021,eay:-.038,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.01,eay:-.006,se:!1,ee:!0}]),this._AddPredifinedEase("easeincubic",[{x:0,y:0,sax:.75,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.138,eay:-.321,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutcubic",[{x:0,y:0,sax:.138,say:.321,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.75,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutcubic",[{x:0,y:0,sax:.285,say:0,eax:0,eay:0,se:!0,ee:!1},{x:.5,y:.5,sax:.081,say:.272,eax:-.081,eay:-.272,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.285,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinquad",[{x:0,y:0,sax:.4,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.178,eay:-.392,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutquad",[{x:0,y:0,sax:.178,say:.392,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.4,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutquad",[{x:0,y:0,sax:.25,say:0,eax:0,eay:0,se:!0,ee:!1},{x:.5,y:.5,sax:.03,say:.065,eax:-.03,eay:-.065,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.25,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinquart",[{x:0,y:0,sax:.5,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.25,eay:-1,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutquart",[{x:0,y:0,sax:.25,say:1,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.5,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutquart",[{x:0,y:0,sax:.765,say:.03,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.765,eay:-.03,se:!1,ee:!0}]),this._AddPredifinedEase("easeinquint",[{x:0,y:0,sax:.6,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.2,eay:-1,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutquint",[{x:0,y:0,sax:.2,say:1,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.6,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutquint",[{eax:0,eay:0,ee:!1,sax:.84,say:0,se:!0,x:0,y:0},{eax:-.84,eay:0,ee:!0,sax:0,say:0,se:!1,x:1,y:1}]),this._AddPredifinedEase("easeincirc",[{x:0,y:0,sax:.25,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.024,eay:-.808,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutcirc",[{x:0,y:0,sax:.024,say:.808,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.25,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutcirc",[{x:0,y:0,sax:.125,say:0,eax:0,eay:0,se:!0,ee:!1},{x:.5,y:.5,sax:.02,say:.428,eax:-.02,eay:-.428,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.125,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinexpo",[{x:0,y:0,sax:.66,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.14,eay:-1,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutexpo",[{x:0,y:0,sax:.14,say:1,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.66,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutexpo",[{eax:0,eay:0,ee:!1,sax:.345,say:0,se:!0,x:0,y:0},{eax:-.06,eay:-.5,ee:!0,sax:.06,say:.5,se:!0,x:.5,y:.5},{eax:-.335,eay:0,ee:!0,sax:0,say:0,se:!1,x:1,y:1}]),this._AddPrivateCustomEase("cubicbezier",this.EaseCubicBezier),this._AddPrivateCustomEase("spline",this.EaseSpline))}static _AddPredifinedEase(t,s,i=!1){if("function"==typeof s)e._AddEase(t,s,"predefined");else{if(!po.IsArray(s))throw new Error("unexpected arguments");if(self.BuiltInTransition){const r=po.New(self.BuiltInTransition,t,i);r.SetFromJson(s),e._AddEase(t,(e,t,s,i)=>r.Interpolate(e,t,s,i),"predefined"),xo.set(t,r)}else{const r=po.New(po.Transition,[t,s.map(e=>[e.x,e.y,e.sax,e.say,e.eax,e.eay,e.se,e.ee])],!1);r.MakeLinear(i),e._AddEase(t,(e,t,s,i)=>r.Interpolate(e,t,s,i),"predefined")}}}static _AddPrivateCustomEase(t,s){e._AddEase(t,s,"private")}static AddCustomEase(t,s,i,r){this._CreateEaseMap(),e._AddEase(t,s,"custom",i,r)}static RemoveCustomEase(e,t){if(this.IsNamePredefined(e))return;if([...To.keys()].includes(e))return;const s=fo.get(t);s&&s.delete(e);const i=go.get(t);i&&i.delete(e)}static _AddEase(e,t,s,i,r){switch(s){case"predefined":_o.set(e,t),mo.set(e,t);break;case"custom":i?(fo.has(i)||fo.set(i,new Map),go.has(i)||go.set(i,new Map),fo.get(i).set(e,t),go.get(i).set(e,r)):(yo.set(e,t),So.set(e,r));break;case"private":_o.set(e,t),To.set(e,t);break;default:throw new Error("unexpected ease mode")}}static NoEase(e,t,s,i){return 0===i?t:s*e/i+t}static EaseCubicBezier(e,t,s,i,r){return t+3*e*(s-t)+3*e**2*(t+i-2*s)+e**3*(r-t+3*s-3*i)}static EaseSpline(e,t,s,i,r,n,a,o,l,h){if(i===r&&n===a)return e;const u=Bo(e,t,i,n,o,h),c=Eo(s,r,a,l),d=Do(s,r,a,l),p=No(s,r,a,l);return Fo(u,c,d,p)}static GetBezierSamples(e,t,s,i){const r=[],n=Eo(e,t,s,i),a=Do(e,t,s,i),o=No(e,t,s,i);for(let e=0;e<Co;++e){const t=Fo(e*wo,n,a,o);r.push(t)}return r}};const Co=11,wo=1/(Co-1),Ao=4,Ro=.01,Po=1e-7,Mo=10,Eo=(e,t,s,i)=>i-3*s+3*t-e,Do=(e,t,s,i)=>3*s-6*t+3*e,No=(e,t,s,i)=>3*(t-e),Fo=(e,t,s,i)=>((t*e+s)*e+i)*e,Oo=(e,t,s,i)=>3*t*e*e+2*s*e+i,Bo=(e,t,s,i,r,n)=>{if(1==e)return 1;let a=0,o=1,l=n[o],h=Co-1;for(n[Co-1];o!=h&&l<=e;)o++,l=n[o],a+=wo;o--,l=n[o];let u=a+(e-l)/(n[o+1]-l)*wo;const c=Eo(t,s,i,r),d=Do(t,s,i,r),p=No(t,s,i,r),_=Oo(u,c,d,p);if(0===_)return u;if(_>=.01){for(let t=0;t<4;++t)u-=(Fo(u,c,d,p)-e)/Oo(u,c,d,p);return u}{let t,s,i=a,r=a+wo,n=0;do{u=i+(r-i)/2;let a=Fo(u,c,d,p)-e;a>0?r=u:i=u,t=Math.abs(a)>1e-7,s=++n<10}while(t&&s);return u}}}{let Lo=function(e){ko.IsString(e)};RequireStringOrNumber=Lo;const ko=self.C3;ko.ProbabilityTable=class{constructor(e){this._items=[],this._name=e||"",this._totalWeight=0}Release(){this.Clear(),this._items=null}GetName(){return this._name}Clear(){ko.clear2DArray(this._items),this._totalWeight=0}GetTotalWeight(){return this._totalWeight}Sample(e=Math.random()*this.GetTotalWeight()){let t=0;for(const[s,i]of this._items)if(t+=s,e<t)return i;return 0}HasItems(){return!!this._items.length}AddItem(e,t){Lo(t),this._totalWeight+=e,this._items.push([e,t])}RemoveItem(e,t){Lo(t);const s=0===e;for(let i=0;i<this._items.length;i++){const r=this._items[i],n=s||r[0]===e,a=r[1]===t;if(n&&a){this._items.splice(i,1),this._totalWeight-=r[0];break}}}asJSON(){return JSON.stringify(this._items)}static fromJSON(e,t){const s=new ko.ProbabilityTable(t),i=JSON.parse(e);for(const e of i){const t=e[0],i=e[1];s.AddItem(t,i)}return s}}}{const Vo=self.C3;let Uo=0;Vo.ScreenReaderText=class{constructor(e,t){this._runtime=e,this._text=t,this._id=Uo++,this._runtime.PostComponentMessageToDOM("runtime","screen-reader-text",{type:"create",id:this._id,text:this._text})}Release(){this._runtime.PostComponentMessageToDOM("runtime","screen-reader-text",{type:"release",id:this._id}),this._runtime=null,this._text="",this._id=-1}SetText(e){this._text!==e&&(this._text=e,this._runtime.PostComponentMessageToDOM("runtime","screen-reader-text",{type:"update",id:this._id,text:this._text}))}}}{const Wo=self.C3;Wo.Event=class{constructor(e,t){this.type=e,this.cancelable=!!t,this.defaultPrevented=!1,this.propagationStopped=!1,this.isAsync=!1}preventDefault(){if(!this.cancelable)throw new Error(`event '${this.type}' is not cancelable`);this.defaultPrevented=!0}stopPropagation(){if(!this.cancelable)throw new Error(`event '${this.type}' cannot be stopped`);if(this.isAsync)throw new Error(`cannot stop async event '${this.type}' propagation`);this.propagationStopped=!0}}}{const Ho=self.C3,zo=self.assert;Ho.Event.Handler=class extends Ho.DefendedBase{constructor(e){super(),this._type=e,this._captureListeners=[],this._captureListenersSet=new Set,this._listeners=[],this._listenersSet=new Set,this._fireDepth=0,this._queueModifyListeners=[]}Release(){this._fireDepth>0||(Ho.clearArray(this._captureListeners),this._captureListenersSet.clear(),Ho.clearArray(this._listeners),this._listenersSet.clear(),Ho.clearArray(this._queueModifyListeners),Ho.Release(this))}_AddListener(e,t){if(this._IsFiring())this._queueModifyListeners.push({op:"add",func:e,capture:t});else if(t){if(this._captureListenersSet.has(e))return;this._captureListeners.push(e),this._captureListenersSet.add(e)}else{if(this._listenersSet.has(e))return;this._listeners.push(e),this._listenersSet.add(e)}}_RemoveListener(e,t){this._IsFiring()?this._queueModifyListeners.push({op:"remove",func:e,capture:t}):t?this._captureListenersSet.has(e)&&(this._captureListenersSet.delete(e),Ho.arrayFindRemove(this._captureListeners,e)):this._listenersSet.has(e)&&(this._listenersSet.delete(e),Ho.arrayFindRemove(this._listeners,e))}_IsEmpty(){return!this._captureListeners.length&&!this._listeners.length}_IsFiring(){return this._fireDepth>0}_ProcessQueuedListeners(){const e=new Set,t=new Set;for(const s of this._queueModifyListeners)if("add"===s.op)this._AddListener(s.func,s.capture),s.capture?t.delete(s.func):e.delete(s.func);else{if("remove"!==s.op)throw new Error("invalid op");s.capture?(this._captureListenersSet.delete(s.func),t.add(s.func)):(this._listenersSet.delete(s.func),e.add(s.func))}Ho.arrayRemoveAllInSet(this._listeners,e),Ho.arrayRemoveAllInSet(this._captureListeners,t),Ho.clearArray(this._queueModifyListeners)}_FireCancellable(e){this._IncreaseFireDepth();let t=!1;for(let s=0,i=this._captureListeners.length;s<i;++s)if(this._captureListeners[s](e),e.propagationStopped){t=!0;break}if(!t)for(let t=0,s=this._listeners.length;t<s&&(this._listeners[t](e),!e.propagationStopped);++t);return this._DecreaseFireDepth(),!e.defaultPrevented}_FireNonCancellable(e){this._IncreaseFireDepth();for(let t=0,s=this._captureListeners.length;t<s;++t)this._captureListeners[t](e);for(let t=0,s=this._listeners.length;t<s;++t)this._listeners[t](e);return this._DecreaseFireDepth(),!0}_IncreaseFireDepth(){this._fireDepth++}_DecreaseFireDepth(){this._fireDepth--,0===this._fireDepth&&this._queueModifyListeners.length>0&&this._ProcessQueuedListeners()}SetDelayRemoveEventsEnabled(e){e?this._IncreaseFireDepth():this._DecreaseFireDepth()}_FireAsync(e){let t=[];for(let s=0,i=this._captureListeners.length;s<i;++s){let i=this._captureListeners[s];t.push(Ho.Asyncify(()=>i(e)))}for(let s=0,i=this._listeners.length;s<i;++s){let i=this._listeners[s];t.push(Ho.Asyncify(()=>i(e)))}return Promise.all(t).then(()=>!e.defaultPrevented)}_FireAndWait_AsyncOptional(e){const t=[];this._IncreaseFireDepth();for(let s=0,i=this._captureListeners.length;s<i;++s){const i=this._captureListeners[s](e);i instanceof Promise&&t.push(i)}for(let s=0,i=this._listeners.length;s<i;++s){const i=this._listeners[s](e);i instanceof Promise&&t.push(i)}return this._DecreaseFireDepth(),t.length?Promise.all(t).then(()=>!e.defaultPrevented):!e.defaultPrevented}async _FireAndWaitAsync(e){return await this._FireAndWait_AsyncOptional(e)}async _FireAndWaitAsyncSequential(e){this._IncreaseFireDepth();for(let t=0,s=this._captureListeners.length;t<s;++t){const s=this._captureListeners[t](e);s instanceof Promise&&await s}for(let t=0,s=this._listeners.length;t<s;++t){const s=this._listeners[t](e);s instanceof Promise&&await s}return this._DecreaseFireDepth(),!e.defaultPrevented}*_FireAsGenerator(e){this._IncreaseFireDepth();for(let t=0,s=this._captureListeners.length;t<s;++t){const s=this._captureListeners[t](e);Ho.IsIterator(s)&&(yield*s)}for(let t=0,s=this._listeners.length;t<s;++t){const s=this._listeners[t](e);Ho.IsIterator(s)&&(yield*s)}this._DecreaseFireDepth()}}}{const jo=self.C3;jo.Event.Dispatcher=class extends jo.DefendedBase{constructor(){super(),this._eventHandlers=new Map,this._dispatcherWasReleased=!1}Release(){if(this._dispatcherWasReleased)throw new Error("already released");this.ClearEvents(),this._dispatcherWasReleased=!0,jo.Release(this)}WasReleased(){return this._dispatcherWasReleased}ClearEvents(){if(this._eventHandlers){for(let e of this._eventHandlers.values())e.Release();this._eventHandlers.clear()}}_GetHandlerByType(e,t){let s=this._eventHandlers.get(e);return s||(t?(s=jo.New(jo.Event.Handler,e),this._eventHandlers.set(e,s),s):null)}HasAnyHandlerFor(e){return this._eventHandlers.has(e)}addEventListener(e,t,s){this._GetHandlerByType(e,!0)._AddListener(t,!!s)}removeEventListener(e,t,s){let i=this._GetHandlerByType(e,!1);i&&(i._RemoveListener(t,!!s),i._IsEmpty()&&this._eventHandlers.delete(e))}dispatchEvent(e){const t=this._GetHandlerByType(e.type,!1);return!t||(e.cancelable?t._FireCancellable(e):t._FireNonCancellable(e))}dispatchEventAsync(e){const t=this._GetHandlerByType(e.type,!1);return t?(e.isAsync=!0,t._FireAsync(e)):Promise.resolve(!0)}async dispatchEventAndClearAsync(e){const t=this._GetHandlerByType(e.type,!1);if(!t)return!0;this._eventHandlers.delete(e.type),e.isAsync=!0;const s=await t._FireAsync(e);return t.Release(),s}async dispatchEventAndWaitAsync(e){const t=this._GetHandlerByType(e.type,!1);return!t||await t._FireAndWaitAsync(e)}dispatchEventAndWait_AsyncOptional(e){const t=this._GetHandlerByType(e.type,!1);return!t||t._FireAndWait_AsyncOptional(e)}async dispatchEventAndWaitAsyncSequential(e){const t=this._GetHandlerByType(e.type,!1);return!t||await t._FireAndWaitAsyncSequential(e)}dispatchGeneratorEvent(e){const t=this._GetHandlerByType(e.type,!1);if(!t)return null;if(e.cancelable)throw new Error("not supported");return t._FireAsGenerator(e)}SetDelayRemoveEventsEnabled(e){for(const t of this._eventHandlers.values())t.SetDelayRemoveEventsEnabled(e)}}}{let Yo=function(e){tl=Zo&&0===sl?requestIdleCallback(qo,{timeout:35}):setTimeout(qo,sl>0?1:e)},qo=function(e){if(tl=-1,!el.length)return;let t=performance.now(),s=t,i=0,r=0;do{Xo(el.shift()),s=performance.now(),++i,r=(s-t)/i*1.1}while(el.length&&(Zo&&0===sl&&void 0!==e?r<e.timeRemaining():s-t+r<12));if(-1===tl&&el.length){let e=s-t;Yo(Math.max(16-e,4))}},Xo=function(e){let t;try{t=e.func()}catch(t){return void e.reject(t)}e.resolve(t)};SetNewCallback=Yo,DoAsyncifiedWork=qo,DoNextAsyncifiedJob=Xo;const $o=self.C3,Ko=12,Jo=16,Qo=35,Zo="undefined"!=typeof requestIdleCallback;let el=[],tl=-1,sl=0,il=$o.QueryString.Has("disable-asyncify");il&&console.warn("[Asyncify] Asyncify has been disabled due to disable-asyncify in the query string. Some work will now be done synchronously."),$o.Asyncify=function(e){let t=null;return $o.isDebug&&(t=$o.GetCallStack()),new Promise((s,i)=>{el.push({func:e,resolve:s,reject:i,stack:t}),il?Xo(el.pop()):-1===tl&&Yo(16)})},$o.Asyncify.SetHighThroughputMode=function(e){if(e)++sl;else if(--sl,sl<0)throw new Error("already turned off high throughput mode")}}{let rl=function(){hl=-1},nl=function(){ul=-1,cl=-1;let e=Date.now();for(let t of dl)if(t._CheckTimeout(e)){let e=t._GetDeadline();(-1===cl||e<cl)&&(cl=e)}else dl.delete(t);if(-1!==cl){let t=Math.max(cl-e+100,1e3);ul=self.setTimeout(nl,t)}};ClearTimeCache=rl,CheckActiveIdleTimeouts=nl;const al=self.C3,ol=1e3,ll=100;let hl=-1;al.FastGetDateNow=function(){return-1===hl&&(hl=Date.now(),self.setTimeout(rl,16)),hl};let ul=-1,cl=-1,dl=new Set;al.IdleTimeout=class{constructor(e,t){this._callback=e,this._timeout=1e3*t,this._deadline=0,this._isActive=!1}Reset(){let e=al.FastGetDateNow();this._deadline=e+this._timeout,this._isActive||(dl.add(this),this._isActive=!0),-1===ul?(cl=this._deadline,ul=self.setTimeout(nl,this._timeout+100)):this._deadline<cl&&cl>e+1e3&&(self.clearTimeout(ul),cl=this._deadline,ul=self.setTimeout(nl,this._timeout+100))}_CheckTimeout(e){return!(e>=this._deadline&&(this._callback()?(this._deadline=e+this._timeout,0):(this._isActive=!1,1)))}_GetDeadline(){return this._deadline}Cancel(){this._isActive&&(dl.delete(this),this._isActive=!1,0===dl.size&&-1!==ul&&(self.clearTimeout(ul),ul=-1,cl=-1))}Release(){this.Cancel(),this._callback=null}}}{const pl=self.C3;pl.Disposable=class e{constructor(e){this._disposed=!1,this._disposeAction=e}Dispose(){this._disposed||(this._disposed=!0,this._disposeAction&&(this._disposeAction(),this._disposeAction=null))}IsDisposed(){return this._disposed}Release(){this.Dispose()}static Release(t){return new e(()=>t.Release())}static From(e,t,s,i,r){if("string"!=typeof t&&!Array.isArray(t))throw new TypeError("expected string or array");if(null==i)i=!1;else if("boolean"!=typeof i&&"object"!=typeof i)throw new TypeError("invalid event listener options");if(r&&(s=s.bind(r)),Array.isArray(t)||t.includes(" ")){"string"==typeof t&&(t=t.split(" "));const r=new pl.CompositeDisposable;for(const n of t)e.addEventListener(n,s,i),r.Add(pl.New(pl.Disposable,()=>e.removeEventListener(n,s,i)));return r}return e.addEventListener(t,s,i),pl.New(pl.Disposable,()=>e.removeEventListener(t,s,i))}},pl.StubDisposable=class extends pl.Disposable{SetAction(e){this._disposeAction=e}},pl.CompositeDisposable=class extends pl.Disposable{constructor(...e){super(),this._disposables=new Set;for(let t of e)this.Add(t)}Add(...e){if(this._disposed)throw new Error("already disposed");for(let t of e)this._disposables.add(t)}Remove(e){if(this._disposed)throw new Error("already disposed");this._disposables.delete(e)}RemoveAll(){if(this._disposed)throw new Error("already disposed");if(this._disposables){for(let e of this._disposables)e.Dispose();this._disposables.clear()}}IsDisposed(){return this._disposed}Dispose(){if(this._disposed)throw new Error("already disposed");this._disposed=!0;for(let e of this._disposables)e.Dispose();this._disposables.clear(),this._disposables=null}Release(){this.Dispose()}}}{const _l=self.C3;_l.KahanSum=class extends _l.DefendedBase{constructor(){super(),this._c=0,this._y=0,this._t=0,this._sum=0}Add(e){e=+e,this._y=e-this._c,this._t=this._sum+this._y,this._c=this._t-this._sum-this._y,this._sum=this._t}Subtract(e){this._sum-=+e}Get(){return this._sum}Reset(){this._c=0,this._y=0,this._t=0,this._sum=0}Set(e){this._c=0,this._y=0,this._t=0,this._sum=+e}Copy(e){this._c=e._c,this._y=e._y,this._t=e._t,this._sum=e._sum}Release(){}}}{const ml=self.C3,fl={},gl=!0,yl=!1;fl.RBnode=function(e){this.tree=e,this.right=this.tree.sentinel,this.left=this.tree.sentinel,this.parent=null,this.color=!1,this.key=null},fl.RedBlackSet=function(e){this.size=0,this.sentinel=new fl.RBnode(this),this.sentinel.color=!1,this.root=this.sentinel,this.root.parent=this.sentinel,this.compare=e||this.default_compare},fl.RedBlackSet.prototype.default_compare=function(e,t){return e<t?-1:t<e?1:0},fl.RedBlackSet.prototype.clone=function(){var e=new fl.RedBlackSet(this.compare);return e.insertAll(this),e},fl.RedBlackSet.prototype.clear=function(){this.size=0,this.sentinel=new fl.RBnode(this),this.sentinel.color=!1,this.root=this.sentinel,this.root.parent=this.sentinel},fl.RedBlackSet.prototype.leftRotate=function(e){var t=e.right;e.right=t.left,t.left!=this.sentinel&&(t.left.parent=e),t.parent=e.parent,e.parent==this.sentinel?this.root=t:e==e.parent.left?e.parent.left=t:e.parent.right=t,t.left=e,e.parent=t},fl.RedBlackSet.prototype.rightRotate=function(e){var t=e.left;e.left=t.right,t.right!=this.sentinel&&(t.right.parent=e),t.parent=e.parent,e.parent==this.sentinel?this.root=t:e==e.parent.right?e.parent.right=t:e.parent.left=t,t.right=e,e.parent=t},fl.RedBlackSet.prototype.insert=function(e){if(this.contains(e))this.get_(e).key=e;else{var t=new fl.RBnode(this);t.key=e;for(var s=this.sentinel,i=this.root;i!=this.sentinel;)s=i,i=this.compare(t.key,i.key)<0?i.left:i.right;t.parent=s,s==this.sentinel?this.root=t:this.compare(t.key,s.key)<0?s.left=t:s.right=t,t.left=this.sentinel,t.right=this.sentinel,t.color=gl,this.insertFixup(t),this.size++}},fl.RedBlackSet.prototype.insertFixup=function(e){for(;e!=this.sentinel&&e!=this.root&&e.parent.color==gl;){var t;e.parent==e.parent.parent.left?(t=e.parent.parent.right).color==gl?(e.parent.color=!1,t.color=!1,e.parent.parent.color=gl,e=e.parent.parent):(e==e.parent.right&&(e=e.parent,this.leftRotate(e)),e.parent.color=!1,e.parent.parent.color=gl,e.parent.parent!=this.sentinel&&this.rightRotate(e.parent.parent)):(t=e.parent.parent.left).color==gl?(e.parent.color=!1,t.color=!1,e.parent.parent.color=gl,e=e.parent.parent):(e==e.parent.left&&(e=e.parent,this.rightRotate(e)),e.parent.color=!1,e.parent.parent.color=gl,e.parent.parent!=this.sentinel&&this.leftRotate(e.parent.parent))}this.root.color=!1},fl.RedBlackSet.prototype.delete_=function(e){var t,s;(s=(t=e.left==this.sentinel||e.right==this.sentinel?e:this.successor_(e)).left!=this.sentinel?t.left:t.right).parent=t.parent,t.parent==this.sentinel?this.root=s:t==t.parent.left?t.parent.left=s:t.parent.right=s,t!=e&&(e.key=t.key),0==t.color&&this.deleteFixup(s),this.size--},fl.RedBlackSet.prototype.deleteFixup=function(e){for(;e!=this.root&&0==e.color;){var t;e==e.parent.left?((t=e.parent.right).color==gl&&(t.color=!1,e.parent.color=gl,this.leftRotate(e.parent),t=e.parent.right),0==t.left.color&&0==t.right.color?(t.color=gl,e=e.parent):(0==t.right.color&&(t.left.color=!1,t.color=gl,this.rightRotate(t),t=e.parent.right),t.color=e.parent.color,e.parent.color=!1,t.right.color=!1,this.leftRotate(e.parent),e=this.root)):((t=e.parent.left).color==gl&&(t.color=!1,e.parent.color=gl,this.rightRotate(e.parent),t=e.parent.left),0==t.right.color&&0==t.left.color?(t.color=gl,e=e.parent):(0==t.left.color&&(t.right.color=!1,t.color=gl,this.leftRotate(t),t=e.parent.left),t.color=e.parent.color,e.parent.color=!1,t.left.color=!1,this.rightRotate(e.parent),e=this.root))}e.color=!1},fl.RedBlackSet.prototype.remove=function(e){var t=this.get_(e);if(t!=this.sentinel){var s=t.key;return this.delete_(t),s}return null},fl.RedBlackSet.prototype.removeSwapped=function(e,t){this.remove(t)},fl.RedBlackSet.prototype.min=function(e){for(;e.left!=this.sentinel;)e=e.left;return e},fl.RedBlackSet.prototype.max=function(e){for(;e.right!=this.sentinel;)e=e.right;return e},fl.RedBlackSet.prototype.successor_=function(e){if(e.right!=this.sentinel)return this.min(e.right);for(var t=e.parent;t!=this.sentinel&&e==t.right;)e=t,t=t.parent;return t},fl.RedBlackSet.prototype.predeccessor_=function(e){if(e.left!=this.sentinel)return this.max(e.left);for(var t=e.parent;t!=this.sentinel&&e==t.left;)e=t,t=t.parent;return t},fl.RedBlackSet.prototype.successor=function(e){if(this.size>0){var t=this.get_(e);if(t==this.sentinel)return null;if(t.right!=this.sentinel)return this.min(t.right).key;for(var s=t.parent;s!=this.sentinel&&t==s.right;)t=s,s=s.parent;return s!=this.sentinel?s.key:null}return null},fl.RedBlackSet.prototype.predecessor=function(e){if(this.size>0){var t=this.get_(e);if(t==this.sentinel)return null;if(t.left!=this.sentinel)return this.max(t.left).key;for(var s=t.parent;s!=this.sentinel&&t==s.left;)t=s,s=s.parent;return s!=this.sentinel?s.key:null}return null},fl.RedBlackSet.prototype.getMin=function(){return this.min(this.root).key},fl.RedBlackSet.prototype.getMax=function(){return this.max(this.root).key},fl.RedBlackSet.prototype.get_=function(e){for(var t=this.root;t!=this.sentinel&&0!=this.compare(t.key,e);)t=this.compare(e,t.key)<0?t.left:t.right;return t},fl.RedBlackSet.prototype.contains=function(e){return null!=this.get_(e).key},fl.RedBlackSet.prototype.getValues=function(){var e=[];return this.forEach(function(t){e.push(t)}),e},fl.RedBlackSet.prototype.insertAll=function(e){if("array"==fl.typeOf(e))for(var t=0;t<e.length;t++)this.insert(e[t]);else if("function"==fl.typeOf(e.forEach))e.forEach(this.insert,this);else if("function"==fl.typeOf(e.getValues)){var s=e.getValues();for(t=0;t<s.length;t++)this.insert(s[t])}else if("object"==fl.typeOf(e))for(var i in e)this.insert(e[i])},fl.RedBlackSet.prototype.removeAll=function(e){if("array"==fl.typeOf(e))for(var t=0;t<e.length;t++)this.remove(e[t]);else if("function"==fl.typeOf(e.forEach))e.forEach(this.removeSwapped,this);else if("function"==fl.typeOf(e.getValues)){var s=e.getValues();for(t=0;t<s.length;t++)this.remove(s[t])}else if("object"==fl.typeOf(e))for(var i in e)this.remove(e[i])},fl.RedBlackSet.prototype.containsAll=function(e){if("array"==fl.typeOf(e)){for(var t=0;t<e.length;t++)if(!this.contains(e[t]))return!1;return!0}if("function"==fl.typeOf(e.forEach))return e.every(this.contains,this);if("function"==fl.typeOf(e.getValues)){var s=e.getValues();for(t=0;t<s.length;t++)if(!this.contains(s[t]))return!1;return!0}if("object"==fl.typeOf(e)){for(var i in e)if(!this.contains(e[i]))return!1;return!0}},fl.RedBlackSet.prototype.range=function(e,t){var s=[];return this.traverseFromTo(function(e){s.push(e)},e,t),s},fl.RedBlackSet.prototype.traverse=function(e,t){if(!this.isEmpty())for(var s=this.min(this.root);s!=this.sentinel;){if(e.call(t,s.key,this))return;s=this.successor_(s)}},fl.RedBlackSet.prototype.traverseFrom=function(e,t,s){if(!this.isEmpty())for(var i=this.get_(t);i!=this.sentinel;){if(e.call(s,i.key,this))return;i=this.successor_(i)}},fl.RedBlackSet.prototype.traverseTo=function(e,t,s){if(!this.isEmpty())for(var i=this.min(this.root),r=this.get_(t);i!=r;){if(e.call(s,i.key,this))return;i=this.successor_(i)}},fl.RedBlackSet.prototype.traverseFromTo=function(e,t,s,i){if(!this.isEmpty())for(var r=this.get_(t),n=this.get_(s);r!=n;){if(e.call(i,r.key,this))return;r=this.successor_(r)}},fl.RedBlackSet.prototype.traverseBackwards=function(e,t){if(!this.isEmpty())for(var s=this.max(this.root);s!=this.sentinel;){if(e.call(t,s.key,this))return;s=this.predeccessor_(s)}},fl.RedBlackSet.prototype.forEach=function(e,t){if(!this.isEmpty())for(var s=this.min(this.root);s!=this.sentinel;s=this.successor_(s))e.call(t,s.key,s.key,this)},fl.RedBlackSet.prototype.some=function(e,t){if(this.isEmpty())return!1;for(var s=this.min(this.root);s!=this.sentinel;s=this.successor_(s))if(e.call(t,s.key,s.key,this))return!0;return!1},fl.RedBlackSet.prototype.every=function(e,t){if(this.isEmpty())return!1;for(var s=this.min(this.root);s!=this.sentinel;s=this.successor_(s))if(!e.call(t,s.key,s.key,this))return!1;return!0},fl.RedBlackSet.prototype.map=function(e,t){var s=[];if(this.isEmpty())return s;for(var i=this.min(this.root);i!=this.sentinel;i=this.successor_(i))s.push(e.call(t,i.key,i.key,this));return s},fl.RedBlackSet.prototype.filter=function(e,t){var s=[];if(this.isEmpty())return s;for(var i=this.min(this.root);i!=this.sentinel;i=this.successor_(i))e.call(t,i.key,i.key,this)&&s.push(i.key);return s},fl.RedBlackSet.prototype.getCount=function(){return this.size},fl.RedBlackSet.prototype.isEmpty=function(){return 0==this.size},fl.RedBlackSet.prototype.isSubsetOf=function(e){var t=fl.getCount(e);if(this.getCount()>t)return!1;var s=0;if(this.isEmpty())return!0;for(var i=this.min(this.root);i!=this.sentinel;i=this.successor_(i))fl.contains.call(e,e,i.key)&&s++;return s==this.getCount()},fl.RedBlackSet.prototype.intersection=function(e){var t=new fl.RedBlackSet(this.compare);if(this.isEmpty())return t;for(var s=this.min(this.root);s!=this.sentinel;s=this.successor_(s))e.contains.call(e,s.key,s.key,this)&&t.insert(s.key);return t},ml.RedBlackSet=class extends ml.DefendedBase{constructor(e){super(),this._rbSet=new fl.RedBlackSet(e),this._enableQueue=!1,this._queueInsert=new Set,this._queueRemove=new Set}Add(e){this._enableQueue?this._rbSet.contains(e)?this._queueRemove.delete(e):this._queueInsert.add(e):this._rbSet.insert(e)}Remove(e){this._enableQueue?this._rbSet.contains(e)?this._queueRemove.add(e):this._queueInsert.delete(e):this._rbSet.remove(e)}Has(e){return this._enableQueue?!!this._queueInsert.has(e)||!this._queueRemove.has(e)&&this._rbSet.contains(e):this._rbSet.contains(e)}Clear(){this._rbSet.clear(),this._queueInsert.clear(),this._queueRemove.clear()}toArray(){if(this._enableQueue)throw new Error("cannot be used in queueing mode");return this._rbSet.getValues()}GetSize(){return this._rbSet.getCount()+this._queueInsert.size-this._queueRemove.size}IsEmpty(){return 0===this.GetSize()}Front(){if(this.IsEmpty())throw new Error("empty set");if(this._enableQueue)throw new Error("cannot be used in queueing mode");const e=this._rbSet;return e.min(e.root).key}Shift(){if(this.IsEmpty())throw new Error("empty set");if(this._enableQueue)throw new Error("cannot be used in queueing mode");const e=this.Front();return this.Remove(e),e}SetQueueingEnabled(e){if(e=!!e,this._enableQueue!==e&&(this._enableQueue=e,!e)){for(const e of this._queueRemove)this._rbSet.remove(e);this._queueRemove.clear();for(const e of this._queueInsert)this._rbSet.insert(e);this._queueInsert.clear()}}ForEach(e){this._rbSet.forEach(e)}*values(){if(this.IsEmpty())return;const e=this._rbSet;for(let t=e.min(e.root);t!=e.sentinel;t=e.successor_(t))yield t.key}[Symbol.iterator](){return this.values()}}}{const Sl=self.C3;Sl.PromiseThrottle=class{constructor(e=Sl.hardwareConcurrency){this._maxParallel=e,this._queue=[],this._activeCount=0}Add(e,t){return new Promise((s,i)=>{const r={func:e,resolve:s,reject:i,opts:t};t?.signal&&t.signal.aborted?i(new Error("abort")):(t?.signal&&(r.onabort=()=>{const e=this._queue.indexOf(r);-1!==e&&(this._queue.splice(e,1),i(new Error("abort")))},t.signal.addEventListener("abort",r.onabort)),this._queue.push(r),this._MaybeStartNext())})}_FindInQueue(e){for(let t=0,s=this._queue.length;t<s;++t)if(this._queue[t].func===e)return t;return-1}RemoveAndResolve(e,t){const s=this._FindInQueue(e);if(-1===s)throw new Error("cannot find promise to resolve");this._queue[s].resolve(t),this._queue.splice(s,1)}RemoveAndReject(e,t){const s=this._FindInQueue(e);if(-1===s)throw new Error("cannot find promise to reject");this._queue[s].reject(t),this._queue.splice(s,1)}async _MaybeStartNext(){if(!this._queue.length)return;if(this._activeCount>=this._maxParallel)return;this._activeCount++;const e=this._queue.shift();e.opts?.signal&&e.onabort&&e.opts.signal.removeEventListener("abort",e.onabort);try{const t=await e.func();e.resolve(t)}catch(t){e.reject(t)}this._activeCount--,this._MaybeStartNext()}}}{const Tl=self.C3;Tl.RateLimiter=class{constructor(e,t,s){this._callback=e,this._interval=t,this._intervalOnBattery=s||2*t,this._timerId=-1,this._lastCallTime=-1/0,this._timerCallFunc=()=>this._OnTimer(),this._ignoreReset=!1,this._canRunImmediate=!1,this._callbackArguments=null}SetCanRunImmediate(e){this._canRunImmediate=!!e}_GetInterval(){return void 0!==Tl.Battery&&Tl.Battery.IsOnBatteryPower()?this._intervalOnBattery:this._interval}Call(...e){if(-1!==this._timerId)return;this._callbackArguments=e;let t=Tl.FastGetDateNow(),s=t-this._lastCallTime,i=this._GetInterval();s>=i&&this._canRunImmediate?(this._lastCallTime=t,this._RunCallback()):this._timerId=self.setTimeout(this._timerCallFunc,Math.max(i-s,4))}_RunCallback(){this._ignoreReset=!0;const e=this._callbackArguments;this._callbackArguments=null,e?this._callback(...e):this._callback(),this._ignoreReset=!1}Reset(){this._ignoreReset||(this._CancelTimer(),this._callbackArguments=null,this._lastCallTime=Tl.FastGetDateNow())}_OnTimer(){this._timerId=-1,this._lastCallTime=Tl.FastGetDateNow(),this._RunCallback()}_CancelTimer(){-1!==this._timerId&&(self.clearTimeout(this._timerId),this._timerId=-1)}Release(){this._CancelTimer(),this._callback=null,this._callbackArguments=null,this._timerCallFunc=null}}}{const xl=self.C3;xl.SVGRasterManager=class{constructor(){this._images=new Map,this._allowNpotSurfaces=!1,this._getBaseSizeCallback=null,this._rasterAtSizeCallback=null,this._releaseResultCallback=null,this._redrawCallback=null}SetNpotSurfaceAllowed(e){this._allowNpotSurfaces=!!e}IsNpotSurfaceAllowed(){return this._allowNpotSurfaces}SetGetBaseSizeCallback(e){this._getBaseSizeCallback=e}GetBaseSize(e){if(!this._getBaseSizeCallback)throw new Error("no get base size callback set");return this._getBaseSizeCallback(e)}SetRasterAtSizeCallback(e){this._rasterAtSizeCallback=e}RasterAtSize(e,t,s,i,r,n){if(!this._rasterAtSizeCallback)throw new Error("no raster at size callback set");return this._rasterAtSizeCallback(e,t,s,i,r,n)}SetReleaseResultCallback(e){this._releaseResultCallback=e}ReleaseResult(e){if(!this._releaseResultCallback)throw new Error("no release result callback set");this._releaseResultCallback(e)}SetRedrawCallback(e){this._redrawCallback=e}Redraw(){if(!this._redrawCallback)throw new Error("no redraw callback set");this._redrawCallback()}AddImage(e){let t=this._images.get(e);return t||(t=xl.New(xl.SVGRasterImage,this,e),this._images.set(e,t)),t.IncReference(),t}_RemoveImage(e){this._images.delete(e.GetDataSource())}OnTexturesChanged(){for(const e of this._images.values())e.ReleaseRasterizedResult(),e.ForceRasterAgain()}}}{const bl=self.C3,Gl=4096;bl.SVGRasterImage=class{constructor(e,t){this._manager=e,this._dataSource=t,this._refCount=0,this._baseWidth=0,this._baseHeight=0,this._getBaseSizePromise=this._manager.GetBaseSize(t).then(e=>{this._manager&&(this._baseWidth=e[0],this._baseHeight=e[1],this._manager.Redraw())}).catch(e=>{console.error("[SVG] Error loading SVG: ",e),this._hadError=!0,this._manager&&this._manager.Redraw()}),this._rasterSurfaceWidth=0,this._rasterSurfaceHeight=0,this._rasterImageWidth=0,this._rasterImageHeight=0,this._isRasterizing=!1,this._rasterizedResult=null,this._forceRaster=!1,this._hadError=!1}Release(){if(this._refCount<=0)throw new Error("already released");this._refCount--,0===this._refCount&&this._Release()}ReleaseRasterizedResult(){this._rasterizedResult&&(this._manager.ReleaseResult(this._rasterizedResult),this._rasterizedResult=null)}_Release(){this.ReleaseRasterizedResult(),this._manager._RemoveImage(this),this._manager=null}GetDataSource(){return this._dataSource}IncReference(){this._refCount++}HasReferences(){return this._refCount>0}GetRasterizedResult(){return this._rasterizedResult}ForceRasterAgain(){this._forceRaster=!0}async StartRasterForSize(e,t,s){if(0===t||0===s||this._hadError)return;if(this._isRasterizing)return;let i=bl.nextHighestPowerOfTwo(Math.ceil(t)),r=bl.nextHighestPowerOfTwo(Math.ceil(s));const n=Math.max(i,r);if(n>4096){const e=4096/n;t*=e,s*=e,i=Math.min(Math.ceil(i*e),4096),r=Math.min(Math.ceil(r*e),4096)}if(t<i&&s<r){const e=t/s;i/r>e?(t=r*e,s=r):(t=i,s=i/e)}if(this._manager.IsNpotSurfaceAllowed()&&(i=Math.ceil(t),r=Math.ceil(s)),i<=this._rasterSurfaceWidth&&r<=this._rasterSurfaceHeight&&!this._forceRaster)return;this._isRasterizing=!0,this._rasterSurfaceWidth=i,this._rasterSurfaceHeight=r;const a=await this._manager.RasterAtSize(this._dataSource,e,this._rasterSurfaceWidth,this._rasterSurfaceHeight,t,s);this._manager&&(this.ReleaseRasterizedResult(),this._rasterizedResult=a,this._rasterImageWidth=t,this._rasterImageHeight=s,this._isRasterizing=!1,this._forceRaster=!1,this._manager.Redraw())}WhenBaseSizeReady(){return this._getBaseSizePromise}GetBaseWidth(){return this._baseWidth}GetBaseHeight(){return this._baseHeight}GetRasterWidth(){return this._rasterImageWidth}GetRasterHeight(){return this._rasterImageHeight}HadError(){return this._hadError}}}{let Il=function(e){return Pl.get(e)};lookupHtmlEntity=Il;const vl=self.C3;vl.UTF8_BOM="\ufeff";const Cl=new Set("0123456789");vl.IsNumericChar=function(e){return Cl.has(e)};const wl=new Set(" \t\n\r            ​\u2028\u2029  　");vl.IsWhitespaceChar=function(e){return wl.has(e)},vl.FilterWhitespace=function(e){return[...e].filter(e=>!vl.IsWhitespaceChar(e)).join("")},vl.IsStringAllWhitespace=function(e){for(const t of e)if(!vl.IsWhitespaceChar(t))return!1;return!0},vl.IsCharArrayAllWhitespace=function(e){for(const t of e)if(!vl.IsWhitespaceChar(t))return!1;return!0},vl.IsUnprintableChar=function(e){return 1===e.length&&e.charCodeAt(0)<32},vl.FilterUnprintableChars=function(e){return[...e].filter(e=>!vl.IsUnprintableChar(e)).join("")};let Al=null;try{Al=new RegExp("\\p{P}(?<=[\\u3000-\\u303F\\uFF00-\\uFFEF])","u")}catch(t2){console.warn("Unable to detect CJK punctuation: ",t2)}vl.IsCJKPunctuationChar=function(e){return!vl.IsWhitespaceChar(e)&&Al&&Al.test(e)};const Rl=new Set("0123456789.+-e");vl.IsStringNumber=function(e){if(!(e=e.trim()).length)return!1;let t=e.charAt(0);if("-"!==t&&!Cl.has(t))return!1;for(let t of e)if(!Rl.has(t))return!1;return!0},vl.RemoveTrailingDigits=function(e){let t=e.length;for(;t>0;){let s=e.charAt(t-1);if(!vl.IsNumericChar(s))break;--t}return e.substr(0,t)},vl.IncrementNumberAtEndOf=function(e){let t=vl.RemoveTrailingDigits(e),s=e.substr(t.length);return s=s?(parseInt(s,10)+1).toString():"2",t+s};const Pl=new Map([["&","&amp;"],["<","&lt;"],[">","&gt;"],['"',"&quot;"],["'","&#39;"]]),Ml=/[&<>"']/g;vl.EscapeHTML=function(e){return e.replace(Ml,Il)},vl.EscapeJS=function(e){let t=vl.ReplaceAll(e,"\\","\\\\");return t=vl.ReplaceAll(t,'"','\\"'),t=vl.ReplaceAll(t,"\t","\\t"),t=vl.ReplaceAll(t,"\r",""),vl.ReplaceAll(t,"\n","\\n")},vl.EscapeXML=function(e){let t=vl.ReplaceAll(e,"&","&amp;");return t=vl.ReplaceAll(t,"<","&lt;"),t=vl.ReplaceAll(t,">","&gt;"),vl.ReplaceAll(t,'"',"&quot;")};const El=/[-[\]{}()*+?.,\\^$|#\s]/g;vl.EscapeRegex=function(e){return e.replace(El,"\\$&")},vl.CountCharsInString=function(e,t){let s=0;for(const i of e)i===t&&++s;return s},vl.StringPosToLineNumber=function(e,t){let s=0,i=0;for(;s<t;){if(s=e.indexOf("\n",s),-1===s)return i;i++,s++}return i},vl.FindAll=function(e,t,s=!1){if(!t)return[];s||(e=e.toLowerCase(),t=t.toLowerCase());const i=t.length;let r=0,n=0,a=[];for(;(n=e.indexOf(t,r))>-1;)a.push(n),r=n+i;return a},vl.ReplaceAll=function(e,t,s){return e.replaceAll(t,()=>s)},vl.ReplaceAllCaseInsensitive=function(e,t,s){return e.replace(new RegExp(vl.EscapeRegex(t),"gi"),()=>s)},vl.SetElementContent=function(e,t){"string"==typeof t?e.textContent=t:t.isPlainText()?e.textContent=t.toString():(e.innerHTML=t.toHTML(),t instanceof vl.BBString&&t.attachLinkHandlers(e))},vl.StringLikeEquals=function(e,t){return e instanceof vl.HtmlString||e instanceof vl.BBString?e.equals(t):t instanceof vl.HtmlString||t instanceof vl.BBString?t.equals(e):e===t},vl.StringSubstitute=function(e,...t){let s=e;for(let i=0,r=t.length;i<r;++i){const r=`{${i}}`;if(!e.includes(r))throw new Error(`missing placeholder '${r}' in string substitution`);s=s.replace(r,t[i].toString())}return s},vl.StringSubstituteAllowMissing=function(e,...t){let s=e,i=-1,r=-1;for(let n=0,a=t.length;n<a;++n){const a=`{${n}}`;e.includes(a)?(r=n,s=s.replace(a,t[n].toString())):-1===i&&(i=n)}if(i>=0&&r>=0&&i<r)throw new Error(`missing placeholder '${i}' in string substitution`);return s},vl.StringSubstituteMap=function(e,t){let s=e;for(let[e,i]of Object.entries(t))s=s.replaceAll(e,i.toString());return s},vl.SortAZ=function(e,t){return e>t?1:e<t?-1:0},vl.SortAZCaseInsensitive=function(e,t){let s=e.toLowerCase(),i=t.toLowerCase();return s>i?1:s<i?-1:0};const Dl=new self.Intl.Segmenter;vl.SplitGraphemes=function(e){const t=[];for(const s of Dl.segment(e))t.push(s.segment);return t},vl.IterateGraphemes=function*(e){for(const t of Dl.segment(e))yield t.segment},vl.CountGraphemes=function(e){let t=0;for(const s of Dl.segment(e))++t;return t};const Nl=1024,Fl=1048576,Ol=1073741824,Bl=1099511627776;vl.FormatDataSize=function(e,t){let s="common."+(t?"dataRates":"dataSizes")+".";const i=self.langSub;if(e<1024)return i(s+"bytes",e);if(e<1048576){let t=e/1024;return t=t<10?Math.round(10*t)/10:Math.round(t),i(s+"kilobytes",t)}if(e<Ol){let t=e/1048576;return t=t<10?Math.round(10*t)/10:Math.round(t),i(s+"megabytes",t)}if(e<Bl){let t=e/Ol;return t=t<10?Math.round(10*t)/10:Math.round(t),i(s+"gigabytes",t)}{let t=e/Bl;return t=t<10?Math.round(10*t)/10:Math.round(t),i(s+"terabytes",t)}};const Ll={approximate:!1,days:!0,hours:!0,minutes:!0,seconds:!0};vl.FormatTime=function(e,t){t=Object.assign({},Ll,t),vl.Lang.PushContext("common.time");const s=[],i=self.lang,r=self.langPluralSub;if(t.days){const t=Math.floor(e/86400);t>0&&(e-=24*t*3600,s.push(r(".days",null,t)))}if(t.hours){const t=Math.floor(e/3600);(t>0||s.length)&&(e-=3600*t,s.push(r(".hours",null,t)))}if(t.minutes){const i=Math.floor(e/60);(i>0||s.length||!t.seconds)&&(e-=60*i,s.push(r(".minutes",null,i)))}if(t.seconds){const t=Math.floor(e%60);s.push(r(".seconds",null,t))}const n=(t.approximate?i(".approx-prefix"):"")+s.join(i(".separator"));return vl.Lang.PopContext(),n},vl.ZeroPad=function(e,t){let s=e<0?"-":"",i=(e=Math.abs(e)).toString(),r=t-i.length;for(let e=0;e<r;++e)s+="0";return s+i},vl.StringToTitleCase=function(e){return e.toLowerCase().replace(/\b\w/g,e=>e.toUpperCase())},vl.CompareVersionStrings=function(e,t){let s=e.split(".").map(e=>e.trim()),i=t.split(".").map(e=>e.trim());vl.resizeArray(s,4,"0"),vl.resizeArray(i,4,"0"),s=s.map(e=>parseInt(e,10)),i=i.map(e=>parseInt(e,10));for(let e=0;e<4;++e){const t=s[e]-i[e];if(0!==t)return t<0?-1:1}return 0},vl.CreateGUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.floor(16*Math.random());return("x"===e?t:3&t|8).toString(16)})},vl.StringHammingDistance=function(e,t){if(e.length!==t.length)throw new Error("strings must be same length");let s=0;for(let i=0,r=e.length;i<r;++i)e.charAt(i)!==t.charAt(i)&&++s;return s},vl.StringLevenshteinDistance=function(e,t){if(0===e.length)return t.length;if(0===t.length)return e.length;let s,i,r,n,a,o;for(e.length>t.length&&(s=e,e=t,t=s),o=Array(e.length+1),i=0;i<=e.length;i++)o[i]=i;for(i=1;i<=t.length;i++){for(n=i,r=1;r<=e.length;r++)a=t[i-1]===e[r-1]?o[r-1]:Math.min(o[r-1]+1,Math.min(n+1,o[r]+1)),o[r-1]=n,n=a;o[e.length]=n}return o[e.length]}}{let kl=function(e,t,s){const i=Wl.get(s);if(!i)return"class"===s?t?"</span>":`<span class="bbclass${Xl++}">`:e;if("string"==typeof i){if("a"===i&&0===Yl.length||"abbr"===i&&0===ql.length)return e;if("a"!==i||t){if("abbr"!==i||t)return"<"+t+i+">";{const e=parseInt(s.substring(3),10)-1;if(e<0||e>=ql.length)throw new Error("invalid bbcode tip substitution");const t=ql[e];let i="";if("string"==typeof t?i=t:"function"==typeof t&&(i=t()),"string"!=typeof i)throw new TypeError("invalid bbcode tip");return`<abbr title="${Vl.ReplaceAll(i,'"',"&quot;")}">`}}{const e=parseInt(s.substring(1),10)-1;if(e<0||e>=Yl.length)throw new Error("invalid bbcode link substitution");const t=Yl[e];if("string"==typeof t)return`<a href="${Yl[e]}">`;if("function"==typeof t)return`<a class="bblink${e}">`;throw new TypeError("invalid bbcode link action")}}if(Array.isArray(i)){let e=i[0],s=i[1];return t?"</"+e+">":`<${e} class="${s}">`}};bbToHtmlReplacerFunc=kl;const Vl=self.C3,Ul=self.assert,Wl=new Map([["b","strong"],["i","em"],["s","s"],["u","u"],["sub","sub"],["sup","sup"],["small","small"],["mark","mark"],["code","code"],["a1","a"],["a2","a"],["a3","a"],["a4","a"],["a5","a"],["a6","a"],["a7","a"],["a8","a"],["a9","a"],["tip1","abbr"],["tip2","abbr"],["tip3","abbr"],["tip4","abbr"],["tip5","abbr"],["tip6","abbr"],["tip7","abbr"],["tip8","abbr"],["tip9","abbr"],["bad",["span","bbCodeBad"]],["good",["span","bbCodeGood"]],["info",["span","bbCodeInfo"]],["h1",["span","bbCodeH1"]],["h2",["span","bbCodeH2"]],["h3",["span","bbCodeH3"]],["h4",["span","bbCodeH4"]],["item",["span","bbCodeItem"]]]),Hl=new Set(["icon"]),zl=/\[(\/?)([a-zA-Z0-9]+)\]/g,jl=/\[(\/?)([^\[\n]*?)\]/g;let Yl=null,ql=null,Xl=0;const $l=/\n/g;Vl.BBString=class{constructor(e,t){if(this._bbstr=t&&t.noEscape?e:Vl.EscapeHTML(e),this._htmlstr="",this._convertLineBreaks=!1,this._linkActions=[],this._tipList=[],t){if(this._convertLineBreaks=!!t.convertLineBreaks,t.links){if(t.links.length>9)throw new Error("too many links");this._linkActions=t.links}if(t.tips){if(t.tips.length>9)throw new Error("too many tips");this._tipList=t.tips}}this._hasAnyBBtags=this._bbstr.includes("["),this._needsLineBreakConversion=this._convertLineBreaks&&this._bbstr.includes("\n"),this._isPlain=!this._hasAnyBBtags&&!this._needsLineBreakConversion&&!this._bbstr.includes("&"),this._hasParsedFragments=!1,this._fragments=[]}toString(){return this._bbstr}valueOf(){return this._bbstr}isPlainText(){return this._isPlain}toPlainText(){return this._hasAnyBBtags?this._bbstr.replace(zl,""):this._bbstr}toHTML(){if(this._isPlain)return this._bbstr;if(!this._htmlstr&&this._bbstr){let e=this._bbstr;this._hasAnyBBtags&&(Xl=0,Yl=this._linkActions,ql=this._tipList,e=e.replace(zl,kl),Yl=null,ql=null),this._needsLineBreakConversion&&(e=e.replace($l,"<br>")),this._htmlstr=e}return this._htmlstr}attachLinkHandlers(e){if(this._linkActions.length)for(let t=0,s=this._linkActions.length;t<s;++t){const s=this._linkActions[t];if("function"!=typeof s)continue;const i=e.querySelector(".bblink"+t);if(!i)throw new Error("unable to attach BBString link handler");i.onclick=s}}equals(e){return e instanceof Vl.HtmlString?this.toHTML()===e.toHTML():e instanceof Vl.BBString?this._bbstr===e._bbstr:this._bbstr===e}toFragmentList(){if(this._hasParsedFragments)return this._fragments;const e=[],t=this._bbstr,s=[];jl.lastIndex=0;let i=0,r=null;for(;null!==(r=jl.exec(t));){const n=r.index;if(n>0&&"\\"===t.charAt(n-1))continue;const a=r[0],o=r[1],l=r[2],h=t.substring(i,n);if(i=n+a.length,h&&e.push({text:h,styles:s.slice(0)}),l)if(o){const e=l.toLowerCase();for(let t=s.length-1;t>=0;--t)if(s[t].tag===e){s.splice(t,1);break}}else{let t=l,i=null;const r=l.indexOf("=");if(-1!==r?(t=l.substring(0,r).toLowerCase(),i=l.substring(r+1)):t=t.toLowerCase(),Hl.has(t)){if("icon"!==t)throw new Error(`unknown self-closing tag ${t}`);e.push({icon:i,styles:s.slice(0)})}else s.push({tag:t,param:i})}}i<t.length&&e.push({text:t.substring(i),styles:s.slice(0)});for(const t of e)t.text&&(t.text=this._ProcessBBCodeEscapeSequences(t.text));return this._fragments=e.map(e=>e.icon?Vl.New(Vl.IconFragment,{icon:e.icon,styles:e.styles}):Vl.New(Vl.TextFragment,{chArr:Vl.SplitGraphemes(e.text),styles:e.styles})),this._hasParsedFragments=!0,this._fragments}_ProcessBBCodeEscapeSequences(e){return e=Vl.ReplaceAll(e,"\\[","["),Vl.ReplaceAll(e,"\\\\","\\")}static StripTags(e){return Vl.New(Vl.BBString,e,{noEscape:!0}).toPlainText()}static StripAnyTags(e){return e.replace(jl,"")}}}{let Kl=function(e){return" "!==e&&" "!==e&&th.IsWhitespaceChar(e)},Jl=function(e){return sh.has(e)},Ql=function(e){return th.IsCJKPunctuationChar(e)&&!Jl(e)},Zl=function(e){for(;e.length>0&&Kl(e.at(-1));)e.pop()},eh=function(e){return"\n"===e||"\r\n"===e};IsWordBreakWhiteSpace=Kl,IsOpeningCJKPunctiationChar=Jl,IsContinuingCJKPunctuationChar=Ql,WordBreakTrimEnd=Zl,IsNewline=eh;const th=self.C3,sh=new Set("〈《「『【〔〖〘〚〝");th.WordWrap=class{constructor(){this._lines=[],this._iconSet=null}GetLines(){return this._lines}GetLineCount(){return this._lines.length}SetIconSet(e){this._iconSet=e}_MeasureLine(e,t){let s=0,i=0,r=0,n=0,a=0;for(const o of e){if(-1===o.GetWidth()){const e=t(o);o.SetHeight(e.height),o.SetFontBoundingBoxAscent(e.fontBoundingBoxAscent||0),o.SetFontBoundingBoxDescent(e.fontBoundingBoxDescent||0),o.SetTopToAlphabeticDistance(e.topToAlphabeticDistance||0),o.IsText()?o.SetWidth(e.width):o.IsIcon()&&o.CalculateWidthFromHeight(this._iconSet)}s+=o.GetWidth(),i=Math.max(i,o.GetHeight()),r=Math.max(r,o.GetFontBoundingBoxAscent()),n=Math.max(n,o.GetFontBoundingBoxDescent()),a=Math.max(a,o.GetTopToAlphabeticDistance())}return{width:s,height:i,fontBoundingBoxAscent:r,fontBoundingBoxDescent:n,topToAlphabeticDistance:a}}_AddLine(e,t,s,i,r,n){this._lines.push(th.New(th.WordWrap.Line,{fragments:e,width:t,height:s,fontBoundingBoxAscent:i,fontBoundingBoxDescent:r,topToAlphabeticDistance:n}))}WordWrap(e,t,s,i,r){if("string"==typeof e&&(e=[th.New(th.TextFragment,{chArr:th.SplitGraphemes(e)})]),th.clearArray(this._lines),!e.length||1===e.length&&e[0].IsText()&&e[0].IsEmpty()||s<2)return;if(1===e.length){const i=e[0];if(i.IsText()&&i.GetLength()<=100&&!i.HasNewLine()){let{width:e,height:n,fontBoundingBoxAscent:a,fontBoundingBoxDescent:o,topToAlphabeticDistance:l}=t(i);if(e+=r,i.SetWidth(e),i.SetHeight(n),i.SetFontBoundingBoxAscent(a||0),i.SetFontBoundingBoxDescent(o||0),i.SetTopToAlphabeticDistance(l||0),e<=s)return void this._AddLine([i],e,n,a,o,l)}}let n;n="word"===i?this._TokeniseByWord(e):"cjk"===i?this._TokeniseByCJK(e):this._TokeniseByChar(e),this._WrapText(n,t,s,r)}_TokeniseByWord(e){const t=[];let s=[],i=!1;for(const r of e){const e=r.GetStyles();if(r.IsIcon())s.length>0&&t.push(s),t.push([r]),s=[];else for(const n of r.GetCharacterArray())if(eh(n))s.length>0&&t.push(s),t.push([th.New(th.TextFragment,{chArr:["\n"],styles:e})]),s=[];else if(0===s.length)s.push(th.New(th.TextFragment,{chArr:[n],styles:e})),i=Kl(n);else{const r=Kl(n);if(r===i){const t=s.at(-1);t.GetStyles()===e?t._AppendChar(n):s.push(th.New(th.TextFragment,{chArr:[n],styles:e}))}else t.push(s),s=[th.New(th.TextFragment,{chArr:[n],styles:e})],i=r}}return s.length>0&&t.push(s),t}_TokeniseByCJK(e){const t=[];let s=[],i=!1;for(const r of e){const e=r.GetStyles();if(r.IsIcon())s.length>0&&t.push(s),t.push([r]),s=[];else for(const n of r.GetCharacterArray())if(eh(n))s.length>0&&t.push(s),t.push([th.New(th.TextFragment,{chArr:["\n"],styles:e})]),s=[];else if(0===s.length)s.push(th.New(th.TextFragment,{chArr:[n],styles:e})),i=Jl(n);else if(i||Ql(n)){const t=s.at(-1);t.GetStyles()===e?t._AppendChar(n):s.push(th.New(th.TextFragment,{chArr:[n],styles:e})),i=Jl(n)}else t.push(s),s=[th.New(th.TextFragment,{chArr:[n],styles:e})],i=Jl(n)}return s.length>0&&t.push(s),t}_TokeniseByChar(e){const t=[];for(const s of e)if(s.IsText()){const e=s.GetCharacterArray();th.appendArray(t,e.map(e=>[th.New(th.TextFragment,{chArr:[e],styles:s.GetStyles()})]))}else t.push([s]);return t}_CopyLine(e){return e.map(e=>e._Clone())}_AddWordToLine(e,t){const s=e.length?e.at(-1):null;let i=0;s&&s.IsText()&&t[0].IsText()&&t[0].GetStyles()===s.GetStyles()&&(s._Append(t[0].GetCharacterArray()),i=1);for(let s=t.length;i<s;++i){const s=t[i];e.push(s._Clone())}}_WrapText(e,t,s,i){let r=[],n=0,a=0,o=0,l=0,h=0;for(const i of e){if(1===i.length&&i[0].IsText()&&1===i[0].GetLength()&&eh(i[0].GetCharacterArray()[0])){if(0===a){const e=t(th.New(th.TextFragment,{chArr:[" "],styles:i[0].GetStyles()}));a=e.height,o=e.fontBoundingBoxAscent||0,l=e.fontBoundingBoxDescent||0,h=e.topToAlphabeticDistance||0}this._AddLine(r,n,a,o,l,h),r=[],n=0,a=0,o=0,l=0,h=0;continue}const e=this._CopyLine(r);this._AddWordToLine(e,i);const u=this._MeasureLine(e,t),c=u.width;if(c>=s)if(r.length>0&&this._AddLine(r,n,a,o,l,h),r=[],i[0].IsText()&&th.IsCharArrayAllWhitespace(i[0].GetCharacterArray()))n=0,a=0,o=0,l=0,h=0;else{this._AddWordToLine(r,i);const e=this._MeasureLine(r,t);n=e.width,a=e.height,o=e.fontBoundingBoxAscent,l=e.fontBoundingBoxDescent,h=e.topToAlphabeticDistance}else r=e,n=c,a=u.height,o=u.fontBoundingBoxAscent,l=u.fontBoundingBoxDescent,h=u.topToAlphabeticDistance}r.length>0&&this._AddLine(r,n,a,o,l,h),this._TrimLinesTrailingWhitespace(t,i)}_TrimLinesTrailingWhitespace(e,t){for(const s of this._lines){const i=s._GetFragmentsArray();if(!i.length)continue;let r=i.at(-1);if(r.IsText()){const n=r.GetCharacterArray(),a=n.slice(0);if(Zl(a),0===a.length)s.OffsetWidth(-r.GetWidth()),i.pop();else if(a.length<n.length){r.SetCharacterArray(a);const t=e(r).width,i=r.GetWidth()-t;r.SetWidth(t),s.OffsetWidth(-i)}0!==t&&i.length>0&&(r=i.at(-1),r.OffsetWidth(t),s.OffsetWidth(t))}}}Clear(){th.clearArray(this._lines)}GetMaxLineWidth(){return this._lines.reduce((e,t)=>Math.max(e,t.GetWidth()),0)}GetTotalLineHeight(){return this._lines.reduce((e,t)=>e+t.GetHeight(),0)}}}{const ih=self.C3;ih.WordWrap.Line=class{constructor(e){this._fragments=e.fragments||[],this._width=e.width||-1,this._height=e.height||-1,this._fontBoundingBoxAscent=e.fontBoundingBoxAscent||-1,this._fontBoundingBoxDescent=e.fontBoundingBoxDescent||-1,this._topToAlphabeticDistance=e.topToAlphabeticDistance||-1,this._posX=0,this._posY=0}fragments(){return this._fragments.values()}*fragmentsReverse(){const e=this._fragments;for(let t=e.length-1;t>=0;--t)yield e[t]}_GetFragmentsArray(){return this._fragments}OffsetWidth(e){this._width+=e}GetWidth(){return this._width}GetHeight(){return this._height}GetFoundBoundingBoxAscent(){return this._fontBoundingBoxAscent}GetFontBoundingBoxDescent(){return this._fontBoundingBoxDescent}GetTopToAlphabeticDistance(){return this._topToAlphabeticDistance}SetPosX(e){this._posX=e}GetPosX(){return this._posX}SetPosY(e){this._posY=e}GetPosY(){return this._posY}}}{const rh=self.C3;rh.FragmentBase=class{constructor(e){this._styles=e.styles||[],this._width=e.width||-1,this._height=e.height||-1,this._fontBoundingBoxAscent=e.fontBoundingBoxAscent||-1,this._fontBoundingBoxDescent=e.fontBoundingBoxDescent||-1,this._topToAlphabeticDistance=e.topToAlphabeticDistance||-1,this._posX=0,this._posY=0}IsText(){return!1}IsIcon(){return!1}GetStyles(){return this._styles}GetStyleTag(e){const t=this._styles;for(let s=t.length-1;s>=0;--s){const i=t[s];if(i.tag===e)return i}return null}HasStyleTag(e){return!!this.GetStyleTag(e)}GetStyleMap(){const e=new Map;for(const t of this._styles)e.set(t.tag,t.param);return e}OffsetWidth(e){this._width+=e}SetWidth(e){this._width=e}GetWidth(){return this._width}SetHeight(e){this._height=e}GetHeight(){return this._height}SetFontBoundingBoxAscent(e){this._fontBoundingBoxAscent=e}GetFontBoundingBoxAscent(){return this._fontBoundingBoxAscent}SetFontBoundingBoxDescent(e){this._fontBoundingBoxDescent=e}GetFontBoundingBoxDescent(){return this._fontBoundingBoxDescent}SetTopToAlphabeticDistance(e){this._topToAlphabeticDistance=e}GetTopToAlphabeticDistance(){return this._topToAlphabeticDistance}SetPosX(e){this._posX=e}GetPosX(){return this._posX}SetPosY(e){this._posY=e}GetPosY(){return this._posY}}}{const nh=self.C3;nh.TextFragment=class extends nh.FragmentBase{constructor(e){super(e),this._chArr=e.chArr}IsText(){return!0}_Append(e){nh.appendArray(this._chArr,e),this._width=-1,this._height=-1,this._fontBoundingBoxAscent=-1,this._fontBoundingBoxDescent=-1,this._topToAlphabeticDistance=-1}_AppendChar(e){this._chArr.push(e)}_Clone(){return nh.New(nh.TextFragment,{chArr:this._chArr.slice(0),styles:this._styles,width:this._width,height:this._height,fontBoundingBoxAscent:this._fontBoundingBoxAscent,fontBoundingBoxDescent:this._fontBoundingBoxDescent,topToAlphabeticDistance:this._topToAlphabeticDistance})}GetCharacterArray(){return this._chArr}SetCharacterArray(e){this._chArr=e}GetLength(){return this._chArr.length}IsEmpty(){return 0===this._chArr.length}HasNewLine(){return this._chArr.includes("\n")}}}{const ah=self.C3;ah.IconFragment=class extends ah.FragmentBase{constructor(e){super(e),this._icon=e.icon}IsIcon(){return!0}GetIconParameter(){return this._icon}_Clone(){return ah.New(ah.IconFragment,{icon:this._icon,styles:this._styles,width:this._width,height:this._height,fontBoundingBoxAscent:this._fontBoundingBoxAscent,fontBoundingBoxDescent:this._fontBoundingBoxDescent,topToAlphabeticDistance:this._topToAlphabeticDistance})}GetTextIcon(e){if(!e)return null;let t=Number(this._icon);return String(t)===this._icon?(t=Math.floor(t),e.GetTextIconByIndex(t)):e.GetTextIconByTag(this._icon)}CalculateWidthFromHeight(e){const t=this.GetTextIcon(e);this._width=t?this._height*t.GetWidth()/t.GetHeight():0}GetDrawable(e){const t=this.GetTextIcon(e);return t?t.GetDrawable():null}GetLength(){return 1}}}{const oh=self.C3;oh.TextIconManager=class{constructor(e){this._iconSets=new Map,this._getIconSetMetaCallback=e.getIconSetMeta,this._getIconSetContentCallback=e.getIconSetContent}Release(){for(const e of this._iconSets.values())e.Release();this._iconSets.clear()}GetIconSet(e){let t=this._iconSets.get(e);if(t)return t;const s=this._getIconSetMetaCallback(e);return t=oh.New(oh.TextIconSet,this,{source:e,iconMeta:s}),this._iconSets.set(e,t),t}HasIconSet(e){return this._iconSets.has(e)}DeleteIconSet(e){const t=this._iconSets.get(e);t&&t.Release(),this._iconSets.delete(e)}async _GetIconSetContent(e){return await this._getIconSetContentCallback(e)}}}{const lh=self.C3;lh.TextIconSet=class{constructor(e,t){this._textIconManager=e,this._source=t.source,this._iconsArray=[],this._iconsByTag=new Map,this._hasStartedLoad=!1,this._isLoading=!1,this._loadPromise=null;const s=t.iconMeta.icons;for(let e=0,t=s.length;e<t;++e){const t=s[e],i=lh.New(lh.TextIcon,this,{index:e,tag:t.tag,source:t.source,width:t.width,height:t.height});this._iconsArray.push(i),t.tag&&this._iconsByTag.set(t.tag.toLowerCase(),i)}}Release(){for(const e of this._iconsArray)e.Release();lh.clearArray(this._iconsArray),this._iconsByTag.clear(),this._textIconManager=null,this._source=null}HasLoaded(){return this._hasStartedLoad}IsLoading(){return this._isLoading}LoadContent(){return this._loadPromise||(this._loadPromise=this._DoLoadContent()),this._loadPromise}async _DoLoadContent(){if(this._hasStartedLoad)return;this._hasStartedLoad=!0,this._isLoading=!0;const e=await this._textIconManager._GetIconSetContent(this._source);if(!this._textIconManager)return;const t=e.icons;for(let e=0,s=Math.min(t.length,this._iconsArray.length);e<s;++e){const s=t[e].drawable;this._iconsArray[e]._SetDrawable(s)}this._isLoading=!1}GetTextIconByIndex(e){return(e=Math.floor(e))<0||e>=this._iconsArray.length?null:this._iconsArray[e]}GetTextIconByTag(e){return this._iconsByTag.get(e.toLowerCase())||null}}}{const hh=self.C3;hh.TextIcon=class{constructor(e,t){this._textIconSet=e,this._source=t.source||null,this._index=t.index,this._tag=t.tag,this._width=t.width,this._height=t.height,this._drawable=null}Release(){this._width=0,this._height=0,this._textIconSet=null}GetSource(){return this._source}GetWidth(){return this._width}GetHeight(){return this._height}_SetDrawable(e){this._drawable=e}GetDrawable(){return this._drawable}}}{let uh=function(e,t,s,i){const r=Th;mh.subtract(yh,s,t),mh.subtract(Sh,e,t),mh.cross(r,yh,Sh),mh.normalize(r,r),i.set(r[0],r[1],r[2],mh.dot(e,r))},ch=function(e,t,s,i,r,n,a){const o=a.x,l=a.y,h=a.z,u=a.w,c=a.xF,d=a.yF,p=a.zF,_=1-c,m=1-d,f=1-p;return o*e*c+o*i*_+l*t*d+l*r*m+h*s*p+h*n*f>=u||o*i*c+o*e*_+l*r*d+l*t*m+h*n*p+h*s*f>u},dh=function(e,t,s,i){return i.x*e+i.y*t+i.z*s>=i.w};PlaneFromPoints=uh,IsInFrontOfPlane=ch,IsPointInFrontOfPlane=dh;const ph=self.C3,_h=self.glMatrix,mh=_h.vec3,fh=_h.vec4,gh=_h.mat4,yh=mh.create(),Sh=mh.create(),Th=mh.create(),xh=fh.create(),bh=gh.create(),Gh=mh.create(),Ih=mh.create(),vh=mh.create(),Ch=mh.create(),wh=mh.create(),Ah=mh.create(),Rh=mh.create(),Ph=mh.create(),Mh=fh.fromValues(0,0,1,1);ph.Gfx={Project(e,t,s,i,r,n,a){const o=i[0]*e+i[4]*t+i[8]*s+i[12],l=i[1]*e+i[5]*t+i[9]*s+i[13],h=i[2]*e+i[6]*t+i[10]*s+i[14],u=i[3]*e+i[7]*t+i[11]*s+i[15];let c=r[0]*o+r[4]*l+r[8]*h+r[12]*u,d=r[1]*o+r[5]*l+r[9]*h+r[13]*u,p=r[2]*o+r[6]*l+r[10]*h+r[14]*u,_=r[3]*o+r[7]*l+r[11]*h+r[15]*u;return 0!==_&&(_=1/_,c*=_,d*=_,p*=_,a[0]=(.5*c+.5)*n[2]+n[0],a[1]=(.5*d+.5)*n[3]+n[1],a[2]=.5*(1+p),!0)},Unproject(e,t,s,i,r,n,a){const o=bh,l=xh;return gh.multiply(o,r,i),null!==gh.invert(o,o)&&(l[0]=(e-n[0])/n[2]*2-1,l[1]=(t-n[1])/n[3]*2-1,l[2]=2*s-1,l[3]=1,fh.transformMat4(l,l,o),0!==l[3]&&(l[3]=1/l[3],a[0]=l[0]*l[3],a[1]=l[1]*l[3],a[2]=l[2]*l[3],!0))},UnprojectScreenToWorldZ(e,t,s,i,r,n,a){const o=yh,l=Sh;if(!ph.Gfx.Unproject(e,t,0,i,r,n,o))return!1;if(!ph.Gfx.Unproject(e,t,1,i,r,n,l))return!1;const h=Sh;mh.subtract(h,l,o);const u=Th;mh.set(u,0,0,1);const c=-s,d=mh.dot(u,h);let p=0;if(0===d){if(0!==mh.dot(u,o)+c)return!1}else if(p=-(mh.dot(o,u)+c)/d,p<0)return!1;return mh.scaleAndAdd(a,o,h,p),!0}};class Eh{constructor(){this.x=NaN,this.y=NaN,this.z=NaN,this.w=NaN,this.xF=NaN,this.yF=NaN,this.zF=NaN}set(e,t,s,i){this.x=e,this.y=t,this.z=s,this.w=i,this.xF=e>0?1:0,this.yF=t>0?1:0,this.zF=s>0?1:0}}ph.Gfx.ViewFrustum=class{constructor(){this._leftP=new Eh,this._topP=new Eh,this._rightP=new Eh,this._bottomP=new Eh,this._nearP=new Eh,this._farP=new Eh}CalculatePlanes(e,t){const s=Mh;ph.Gfx.Unproject(0,1,0,e,t,s,Gh),ph.Gfx.Unproject(1,1,0,e,t,s,Ih),ph.Gfx.Unproject(0,0,0,e,t,s,vh),ph.Gfx.Unproject(1,0,0,e,t,s,Ch),ph.Gfx.Unproject(0,1,1,e,t,s,wh),ph.Gfx.Unproject(1,1,1,e,t,s,Ah),ph.Gfx.Unproject(0,0,1,e,t,s,Rh),ph.Gfx.Unproject(1,0,1,e,t,s,Ph),uh(vh,Gh,wh,this._leftP),uh(Gh,Ih,Ah,this._topP),uh(Ih,Ch,Ph,this._rightP),uh(Ch,vh,Rh,this._bottomP),uh(Rh,wh,Ah,this._farP),uh(Ch,Ih,Gh,this._nearP)}ContainsAABB(e,t,s,i,r,n){return ch(e,t,s,i,r,n,this._leftP)&&ch(e,t,s,i,r,n,this._topP)&&ch(e,t,s,i,r,n,this._rightP)&&ch(e,t,s,i,r,n,this._bottomP)&&ch(e,t,s,i,r,n,this._nearP)&&ch(e,t,s,i,r,n,this._farP)}IsBehindNearPlane(e,t,s){return!dh(e,t,s,this._nearP)}}}{const Dh=self.C3,Nh=self.glMatrix,Fh=Nh.vec3,Oh=Nh.vec4,Bh=Nh.mat4,Lh=Bh.create(),kh=Fh.fromValues(0,0,0),Vh=Fh.fromValues(0,0,0),Uh=Fh.fromValues(0,0,0),Wh=Fh.fromValues(0,1,0),Hh=Oh.fromValues(0,0,0,0),zh=new Dh.Quad,jh=new Dh.Rect,Yh=new Dh.Quad(0,0,1,0,1,1,0,1),qh={nearZ:1,farZ:1e4},Xh=Bh.fromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1);Dh.Gfx.RendererBase=class{constructor(e){e=Object.assign({},qh,e),this._width=0,this._height=0,this._fovY=Dh.toRadians(45),this._tan_fovY_2=Math.tan(this._fovY/2),this._matP=Bh.create(),this._matMV=Bh.create(),this._zAxisScale=!1,this._nearZ=e.nearZ,this._farZ=e.farZ,this._allShaderPrograms=[],this._shaderProgramsByName=new Map,this._spTextureFill=null,this._spPoints=null,this._spTilemapFill=null,this._spTileRandomization=null,this._spColorFill=null,this._spLinearGradientFill=null,this._spPenumbraFill=null,this._spHardEllipseFill=null,this._spHardEllipseOutline=null,this._spSmoothEllipseFill=null,this._spSmoothEllipseOutline=null,this._spSmoothLineFill=null,this._stateGroups=new Map,this._currentStateGroup=null,this._blendModeTable=[],this._namedBlendModeMap=new Map,this._baseZ=0,this._currentZ=0,this._lineWidth=1,this._lineWidthStack=[this._lineWidth],this._lineCap=1,this._lineCapStack=[this._lineCap],this._lineOffset=.5,this._lineOffsetStack=[this._lineOffset],this._frameNumber=0,this._enableMipmaps=!0,this._hasMajorPerformanceCaveat=!1}_ClearState(){this._baseZ=0,this._currentZ=0,this._spTextureFill=null,this._spPoints=null,this._spTilemapFill=null,this._spTileRandomization=null,this._spColorFill=null,this._spLinearGradientFill=null,this._spPenumbraFill=null,this._spHardEllipseFill=null,this._spHardEllipseOutline=null,this._spSmoothEllipseFill=null,this._spSmoothEllipseOutline=null,this._spSmoothLineFill=null,this._ClearAllShaderPrograms()}InitState(){this._ClearState(),this._currentStateGroup=null}OnDeviceOrContextLost(){for(const e of this._allShaderPrograms)e.Release();this._ClearState()}GetWidth(){return this._width}GetHeight(){return this._height}GetDefaultCameraZ(e){return this.IsZAxisScaleNormalized()?100:e/(2*this._GetTanFovYDiv2())}GetZAxisScaleFactor(e){return this.IsZAxisScaleNormalized()?e/(2*this._GetTanFovYDiv2())/this.GetDefaultCameraZ(e):1}SetNearZ(e){this._nearZ=e}GetNearZ(){return this._nearZ}SetFarZ(e){this._farZ=e}GetFarZ(){return this._farZ}SetFovY(e){this._fovY=e,this._tan_fovY_2=Math.tan(this._fovY/2)}GetFovY(){return this._fovY}_GetTanFovYDiv2(){return this._tan_fovY_2}SetZAxisScaleNormalized(){this._zAxisScale=!1}SetZAxisScaleRegular(){this._zAxisScale=!0}IsZAxisScaleNormalized(){return!this._zAxisScale}IsZAxisScaleRegular(){return this._zAxisScale}CalculatePerspectiveMatrix(e,t,s=.5,i=.5){const r=this.GetNearZ(),n=this.GetFarZ(),a=this.GetFovY();if(.5===s&&.5===i)this.IsWebGPU()?Bh.perspectiveZO(e,a,t,r,n):Bh.perspective(e,a,t,r,n);else{const a=2*(s=1-s)-2,o=2*s,l=2*i-2,h=2*i,u=this._GetTanFovYDiv2()*r,c=u*t;Bh.frustum(e,a*c,o*c,l*u,h*u,r,n),this.IsWebGPU()&&Bh.mul(e,Xh,e)}}CalculateOrthographicMatrix(e,t,s,i=1){const r=self.devicePixelRatio,n=2*this.GetDefaultCameraZ(s)*r*this._GetTanFovYDiv2()/s,a=t*n/(2*r*i),o=s*n/(2*r*i),l=-a,h=a,u=-o,c=o;this.IsWebGPU()?Bh.orthoZO(e,l,h,u,c,this.GetNearZ(),this.GetFarZ()):Bh.ortho(e,l,h,u,c,this.GetNearZ(),this.GetFarZ())}CalculateLookAtModelView(e,t,s,i,r,n=1){let a=1;this.IsZAxisScaleNormalized()&&(a=200*this._GetTanFovYDiv2()/r);const o=Uh;Fh.set(o,a,-a,1);const l=kh,h=Vh;Fh.multiply(l,t,o),Fh.multiply(h,s,o),Bh.lookAt(e,l,h,i||Wh),o[2]=n,Bh.scale(e,e,o)}CalculateLookAtModelView2(e,t,s,i,r,n,a,o){return Fh.set(kh,e,t,s),Fh.set(Vh,i,r,n),this.CalculateLookAtModelView(Lh,kh,Vh,Wh,a,o),Lh}_AddShaderProgram(e){this._allShaderPrograms.push(e),this._shaderProgramsByName.set(e.GetName(),e)}_RemoveShaderProgram(e){const t=this._allShaderPrograms.indexOf(e);-1!==t&&this._allShaderPrograms.splice(t,1),this._shaderProgramsByName.delete(e.GetName())}_ClearAllShaderPrograms(){Dh.clearArray(this._allShaderPrograms),this._shaderProgramsByName.clear()}GetShaderProgramByName(e){return this._shaderProgramsByName.get(e)||null}GetTextureFillShaderProgram(){return this._spTextureFill}SetTextureFillMode(){this.SetProgram(this._spTextureFill)}GetPointsRenderingProgram(){return this._spPoints}SetPointsRenderingProgram(){this.SetProgram(this._spPoints)}SetTilemapFillMode(){this.SetProgram(this._spTilemapFill)}SetTileRandomizationMode(){this.SetProgram(this._spTileRandomization)}SetColorFillMode(){this.SetProgram(this._spColorFill)}SetLinearGradientFillMode(){this.SetProgram(this._spLinearGradientFill)}SetPenumbraFillMode(){this.SetProgram(this._spPenumbraFill)}SetHardEllipseFillMode(){this.SetProgram(this._spHardEllipseFill)}SetHardEllipseOutlineMode(){this.SetProgram(this._spHardEllipseOutline)}SetSmoothEllipseFillMode(){this.SetProgram(this._spSmoothEllipseFill)}SetSmoothEllipseOutlineMode(){this.SetProgram(this._spSmoothEllipseOutline)}SetSmoothLineFillMode(){this.SetProgram(this._spSmoothLineFill)}_SetCurrentStateGroup(e){this._currentStateGroup=e}GetCurrentStateGroup(){return this._currentStateGroup}AcquireStateGroup(e,t,s,i,r,n){const a=Dh.Gfx.StateGroup.MakeKey(e,t,s,i,r,n);let o=this._stateGroups.get(a);return o||(o=Dh.New(Dh.Gfx.StateGroup,this,e,t,s,i,r,n),this._stateGroups.set(a,o)),o.AddRef(),o}ReleaseStateGroup(e){e.DecRef(),0===e._GetRefCount()&&(this._currentStateGroup===e&&(this._currentStateGroup=null),this._stateGroups.delete(e.GetKey()),e.Release())}_InitBlendModeData(e){Dh.clearArray(this._blendModeTable),this._namedBlendModeMap.clear();let t=0;for(const s of e){const e=s[0],i=s[1],r=s[2];this._blendModeTable.push([i,r]),this._namedBlendModeMap.set(e,{number:t,srcBlend:i,destBlend:r}),t++}}_GetBlendByIndex(e){return this._blendModeTable[e]}GetSrcBlendByIndex(e){return this._GetBlendByIndex(e)[0]}GetDestBlendByIndex(e){return this._GetBlendByIndex(e)[1]}GetNamedBlend(e){const t=this._namedBlendModeMap.get(e);if(void 0===t)throw new Error("invalid blend name");return t}NamedBlendToNumber(e){const t=this._namedBlendModeMap.get(e);if(void 0===t)throw new Error("invalid blend name");return t.number}SetBaseZ(e){this._baseZ=e}GetBaseZ(){return this._baseZ}SetCurrentZ(e){this._currentZ=e,this._currentStateGroup=null}GetCurrentZ(){return this._currentZ}Line(e,t,s,i){const r=Dh.angleTo(e,t,s,i),n=Math.sin(r),a=Math.cos(r),o=.5*this._lineWidth,l=n*o,h=a*o,u=this._lineCap;2===u?this.LinePreCalc_LineCap2(e,t,0,s,i,0,l,h):1===u?this.LinePreCalc_LineCap1(e,t,0,s,i,0,l,h):this.LinePreCalc_LineCap0(e,t,0,s,i,0,l,h)}Line3D(e,t,s,i,r,n){const a=Dh.angleTo(e,t,i,r),o=Math.sin(a),l=Math.cos(a),h=.5*this._lineWidth,u=o*h,c=l*h,d=this._lineCap;2===d?this.LinePreCalc_LineCap2(e,t,s,i,r,n,u,c):1===d?this.LinePreCalc_LineCap1(e,t,s,i,r,n,u,c):this.LinePreCalc_LineCap0(e,t,s,i,r,n,u,c)}LinePreCalc_LineCap2(e,t,s,i,r,n,a,o){const l=this._lineOffset,h=e+l-o,u=t+l-a,c=i+l+o,d=r+l+a,p=2*o,_=2*a,m=h+a,f=u-o,g=h-a+p,y=u+o+_,S=c+a,T=d-o,x=c-a-p,b=d+o-_;this.Quad3D2(m,f,s,S,T,n,x,b,n,g,y,s,Yh)}LinePreCalc_LineCap1(e,t,s,i,r,n,a,o){const l=this._lineOffset,h=e+l-o,u=t+l-a,c=i+l+o,d=r+l+a,p=h+a,_=u-o,m=h-a,f=u+o,g=c+a,y=d-o,S=c-a,T=d+o;this.Quad3D2(p,_,s,g,y,n,S,T,n,m,f,s,Yh)}LinePreCalc_LineCap0(e,t,s,i,r,n,a,o){const l=this._lineOffset,h=e+l,u=t+l,c=i+l,d=r+l,p=h+a,_=u-o,m=h-a,f=u+o,g=c+a,y=d-o,S=c-a,T=d+o;this.Quad3D2(p,_,s,g,y,n,S,T,n,m,f,s,Yh)}TexturedLine(e,t,s,i,r,n){const a=Dh.angleTo(e,t,s,i),o=Math.sin(a),l=Math.cos(a),h=.5*this._lineWidth,u=o*h,c=l*h,d=this._lineCap;2===d?this.TexturedLinePreCalc_LineCap2(e,t,s,i,u,c,r,n):1===d?this.TexturedLinePreCalc_LineCap1(e,t,s,i,u,c,r,n):this.TexturedLinePreCalc_LineCap0(e,t,s,i,u,c,r,n)}TexturedLinePreCalc_LineCap2(e,t,s,i,r,n,a,o){const l=this._lineOffset,h=e+l-n,u=t+l-r,c=s+l+n,d=i+l+r,p=2*n,_=2*r,m=h+r,f=u-n,g=h-r+p,y=u+n+_,S=c+r,T=d-n,x=c-r-p,b=d+n-_;zh.set(m,f,S,T,x,b,g,y),jh.set(a,0,o,0),this.Quad3(zh,jh)}TexturedLinePreCalc_LineCap1(e,t,s,i,r,n,a,o){const l=this._lineOffset,h=e+l-n,u=t+l-r,c=s+l+n,d=i+l+r,p=h+r,_=u-n,m=h-r,f=u+n,g=c+r,y=d-n,S=c-r,T=d+n;zh.set(p,_,g,y,S,T,m,f),jh.set(a,0,o,0),this.Quad3(zh,jh)}TexturedLinePreCalc_LineCap0(e,t,s,i,r,n,a,o){const l=this._lineOffset,h=e+l,u=t+l,c=s+l,d=i+l,p=h+r,_=u-n,m=h-r,f=u+n,g=c+r,y=d-n,S=c-r,T=d+n;zh.set(p,_,g,y,S,T,m,f),jh.set(a,0,o,0),this.Quad3(zh,jh)}LineRect(e,t,s,i){const r=.5*this._lineWidth,n=this._lineCap;2===n?this._LineRectPreCalc_LineCap2(e,t,s,i,r):1===n?this._LineRectPreCalc_LineCap1(e,t,s,i,r):this._LineRectPreCalc_LineCap0(e,t,s,i,r)}_LineRectPreCalc_LineCap2(e,t,s,i,r){this.LinePreCalc_LineCap2(e,t,0,s,t,0,0,r),this.LinePreCalc_LineCap2(s,t,0,s,i,0,r,0),this.LinePreCalc_LineCap2(s,i,0,e,i,0,0,-r),this.LinePreCalc_LineCap2(e,i,0,e,t,0,-r,0)}_LineRectPreCalc_LineCap1(e,t,s,i,r){this.LinePreCalc_LineCap1(e,t,0,s,t,0,0,r),this.LinePreCalc_LineCap1(s,t,0,s,i,0,r,0),this.LinePreCalc_LineCap1(s,i,0,e,i,0,0,-r),this.LinePreCalc_LineCap1(e,i,0,e,t,0,-r,0)}_LineRectPreCalc_LineCap0(e,t,s,i,r){this.LinePreCalc_LineCap0(e,t,0,s,t,0,0,r),this.LinePreCalc_LineCap0(s,t,0,s,i,0,r,0),this.LinePreCalc_LineCap0(s,i,0,e,i,0,0,-r),this.LinePreCalc_LineCap0(e,i,0,e,t,0,-r,0)}LineRect2(e){this.LineRect(e.getLeft(),e.getTop(),e.getRight(),e.getBottom())}LineQuad(e){const t=Dh.angleTo(e.getTlx(),e.getTly(),e.getTrx(),e.getTry()),s=Math.sin(t),i=Math.cos(t),r=.5*this._lineWidth,n=s*r,a=i*r,o=this._lineCap;2===o?this._LineQuadPreCalc_LineCap2(e,n,a):1===o?this._LineQuadPreCalc_LineCap1(e,n,a):this._LineQuadPreCalc_LineCap0(e,n,a)}_LineQuadPreCalc_LineCap2(e,t,s){this.LinePreCalc_LineCap2(e.getTlx(),e.getTly(),0,e.getTrx(),e.getTry(),0,t,s),this.LinePreCalc_LineCap2(e.getTrx(),e.getTry(),0,e.getBrx(),e.getBry(),0,s,-t),this.LinePreCalc_LineCap2(e.getBrx(),e.getBry(),0,e.getBlx(),e.getBly(),0,-t,-s),this.LinePreCalc_LineCap2(e.getBlx(),e.getBly(),0,e.getTlx(),e.getTly(),0,-s,t)}_LineQuadPreCalc_LineCap1(e,t,s){this.LinePreCalc_LineCap1(e.getTlx(),e.getTly(),0,e.getTrx(),e.getTry(),0,t,s),this.LinePreCalc_LineCap1(e.getTrx(),e.getTry(),0,e.getBrx(),e.getBry(),0,s,-t),this.LinePreCalc_LineCap1(e.getBrx(),e.getBry(),0,e.getBlx(),e.getBly(),0,-t,-s),this.LinePreCalc_LineCap1(e.getBlx(),e.getBly(),0,e.getTlx(),e.getTly(),0,-s,t)}_LineQuadPreCalc_LineCap0(e,t,s){this.LinePreCalc_LineCap0(e.getTlx(),e.getTly(),0,e.getTrx(),e.getTry(),0,t,s),this.LinePreCalc_LineCap0(e.getTrx(),e.getTry(),0,e.getBrx(),e.getBry(),0,s,-t),this.LinePreCalc_LineCap0(e.getBrx(),e.getBry(),0,e.getBlx(),e.getBly(),0,-t,-s),this.LinePreCalc_LineCap0(e.getBlx(),e.getBly(),0,e.getTlx(),e.getTly(),0,-s,t)}SetLineWidth(e){this._lineWidth=e,this._lineWidthStack[this._lineWidthStack.length-1]=e}GetLineWidth(){return this._lineWidth}PushLineWidth(e){if(this._lineWidthStack.length>=100)throw new Error("pushed too many line widths - check push/pop pairs");this._lineWidthStack.push(e),this._lineWidth=e}PopLineWidth(){if(this._lineWidthStack.length<=1)throw new Error("cannot pop last line width - check push/pop pairs");this._lineWidthStack.pop(),this._lineWidth=this._lineWidthStack.at(-1)}SetLineCapButt(){this._lineCap=0,this._lineCapStack[this._lineCapStack.length-1]=0}SetLineCapSquare(){this._lineCap=1,this._lineCapStack[this._lineCapStack.length-1]=0}SetLineCapZag(){this._lineCap=2,this._lineCapStack[this._lineCapStack.length-1]=0}PushLineCap(e){if("butt"===e)this.PushLineCapButt();else if("square"===e)this.PushLineCapSquare();else{if("zag"!==e)throw new Error("invalid line cap");this.PushLineCapZag()}}PushLineCapButt(){if(this._lineCapStack.length>=100)throw new Error("pushed too many line caps - check push/pop pairs");this._lineCapStack.push(0),this._lineCap=0}PushLineCapSquare(){if(this._lineCapStack.length>=100)throw new Error("pushed too many line caps - check push/pop pairs");this._lineCapStack.push(1),this._lineCap=1}PushLineCapZag(){if(this._lineCapStack.length>=100)throw new Error("pushed too many line caps - check push/pop pairs");this._lineCapStack.push(2),this._lineCap=2}PopLineCap(){if(this._lineCapStack.length<=1)throw new Error("cannot pop last line cap - check push/pop pairs");this._lineCapStack.pop(),this._lineCap=this._lineCapStack.at(-1)}SetLineOffset(e){this._lineOffset=e,this._lineOffsetStack[this._lineOffsetStack.length-1]=e}GetLineOffset(){return this._lineOffset}PushLineOffset(e){if(this._lineOffsetStack.length>=100)throw new Error("pushed too many line offsets - check push/pop pairs");this._lineOffsetStack.push(e),this._lineOffset=e}PopLineOffset(){if(this._lineOffsetStack.length<=1)throw new Error("cannot pop last line offset - check push/pop pairs");this._lineOffsetStack.pop(),this._lineOffset=this._lineOffsetStack.at(-1)}ResetCullState(){this.SetCullFaceMode(0),this.SetFrontFaceWinding(0)}ConvexPoly(e){const t=e.length/2;if(t<3)throw new Error("need at least 3 points");const s=t-2,i=s-1,r=e[0],n=e[1];for(let t=0;t<s;t+=2){const s=2*t,a=e[s+2],o=e[s+3],l=e[s+4],h=e[s+5];if(t===i)this.Quad2(r,n,a,o,l,h,l,h);else{const t=e[s+6],i=e[s+7];this.Quad2(r,n,a,o,l,h,t,i)}}}Finish(){this.EndBatch(!0),this._frameNumber++}GetFrameNumber(){return this._frameNumber}IncrementFrameNumber(){this._frameNumber++}SetMipmapsEnabled(e){this._enableMipmaps=!!e}AreMipmapsEnabled(){return this._enableMipmaps}SetHasMajorPerformanceCaveat(e){this._hasMajorPerformanceCaveat=!!e}HasMajorPerformanceCaveat(){return this._hasMajorPerformanceCaveat}IsWebGL(){return!1}IsWebGPU(){return!1}GetEstimatedBackBufferMemoryUsage(){}GetEstimatedRenderBufferMemoryUsage(){}GetEstimatedTextureMemoryUsage(){}GetEstimatedTotalMemoryUsage(){return this.GetEstimatedBackBufferMemoryUsage()+this.GetEstimatedRenderBufferMemoryUsage()+this.GetEstimatedTextureMemoryUsage()}CreateRendererText(){return Dh.New(Dh.Gfx.RendererText,this)}}}{const $h=self.C3;$h.Gfx.ShaderProgramBase=class{constructor(e,t){this._name=t.name,this._renderer=e,this._extendBoxHorizontal=t.extendBoxHorizontal||0,this._extendBoxVertical=t.extendBoxVertical||0,this._crossSampling=!!t.crossSampling,this._mustPreDraw=!!t.mustPreDraw,this._preservesOpaqueness=!!t.preservesOpaqueness,this._supports3dDirectRendering=!!t.supports3dDirectRendering,this._animated=!!t.animated,this._blendsBackground=!!t.blendsBackground,this._usesDepth=!!t.usesDepth,this._usesAnySrcRectOrPixelSize=!1,this._needsPostDrawOrExtendBox=this._crossSampling||this._blendsBackground||0!==this._extendBoxHorizontal||0!==this._extendBoxVertical}Release(){this._renderer=null}GetRenderer(){return this._renderer}GetName(){return this._name}ExtendsBox(){return 0!==this._extendBoxHorizontal||0!==this._extendBoxVertical}GetBoxExtendHorizontal(){return this._extendBoxHorizontal}GetBoxExtendVertical(){return this._extendBoxVertical}UsesCrossSampling(){return this._crossSampling}MustPreDraw(){return this._mustPreDraw}PreservesOpaqueness(){return this._preservesOpaqueness}Supports3DDirectRendering(){return this._supports3dDirectRendering}IsAnimated(){return this._animated}BlendsBackground(){return this._blendsBackground}UsesDepth(){return this._usesDepth}UsesAnySrcRectOrPixelSize(){return this._usesAnySrcRectOrPixelSize}NeedsPostDrawOrExtendsBox(){return this._needsPostDrawOrExtendBox}UsesIsSrcTexRotated(){return!1}}}{const Kh=self.C3;Kh.Gfx.StateGroup=class{constructor(e,t,s,i,r,n,a){this._renderer=e,this._refCount=0,this._shaderProgram=null,this._shaderProgramName="",this._blendMode=s,this._color=Kh.New(Kh.Color),this._color.set(i),this._zElevation=r,this._cullFaceMode=n,this._frontFaceWinding=a,"string"==typeof t?this._shaderProgramName=t:(this._shaderProgram=t,this._shaderProgramName=this._shaderProgram.GetName())}Release(){if(this._refCount>0)throw new Error("releasing state group still in use");this._renderer=null,this._shaderProgram=null,this._shaderProgramName=""}Apply(){const e=this._renderer;e.SetProgram(this._shaderProgram),e.SetBlendMode(this._blendMode),e.SetColor(this._color),e.SetCurrentZ(this._zElevation),e.SetCullFaceMode(this._cullFaceMode),e.SetFrontFaceWinding(this._frontFaceWinding),e._SetCurrentStateGroup(this)}GetKey(){return Kh.Gfx.StateGroup.MakeKey(this._shaderProgramName,this._blendMode,this._color,this._zElevation,this._cullFaceMode,this._frontFaceWinding)}AddRef(){++this._refCount}DecRef(){--this._refCount}_GetRefCount(){return this._refCount}OnContextLost(){this._shaderProgram=null}OnContextRestored(e){if(this._shaderProgram=e.GetShaderProgramByName(this._shaderProgramName),!this._shaderProgram)throw new Error("failed to restore shader program")}static MakeKey(e,t,s,i,r,n){return("string"==typeof e?e:e.GetName())+","+t+","+s.getR()+","+s.getG()+","+s.getB()+","+s.getA()+","+i+","+r+","+n}}}{let Jh=function(e,t,s){const i=s.getTlx(),r=s.getTly(),n=s.getTrx()-i,a=s.getTry()-r;return[i+n*e+(s.getBlx()-i)*t,r+a*e+(s.getBly()-r)*t]};interpolateQuad=Jh;const Qh=globalThis.C3,Zh=globalThis.assert,eu=65535;Qh.Gfx.MeshPoint=class{constructor(e,t,s){this._mesh=e,this._col=t,this._row=s,this._x=NaN,this._y=NaN,this._zElevation=NaN,this._u=NaN,this._v=NaN,this._x=0,this._y=0,this._zElevation=0,this._u=0,this._v=0}_Init(e,t,s,i){this._x=e,this._y=t,this._u=s,this._v=i}GetX(){return this._x}SetX(e){this._x!==e&&(this._x=e,this._mesh._SetPointsChanged())}GetY(){return this._y}SetY(e){this._y!==e&&(this._y=e,this._mesh._SetPointsChanged())}GetZElevation(){return this._zElevation}SetZElevation(e){this._zElevation!==e&&(this._zElevation=Math.max(e,0),this._mesh._SetPointsChanged())}GetU(){return this._u}SetU(e){this._u=e}GetV(){return this._v}SetV(e){this._v=e}_Interpolate_TexRect(e,t,s){[this._x,this._y]=Jh(e._x,e._y,t),this._zElevation=e._zElevation,this._u=Qh.lerp(s.getLeft(),s.getRight(),e._u),this._v=Qh.lerp(s.getTop(),s.getBottom(),e._v)}_Interpolate_TexQuad(e,t,s){[this._x,this._y]=Jh(e._x,e._y,t),this._zElevation=e._zElevation,[this._u,this._v]=Jh(e._u,e._v,s)}SaveToJson(){return{x:this.GetX(),y:this.GetY(),z:this.GetZElevation(),u:this.GetU(),v:this.GetV()}}LoadFromJson(e){this.SetX(e.x),this.SetY(e.y),e.hasOwnProperty("z")&&this.SetZElevation(e.z),this.SetU(e.u),this.SetV(e.v)}GetMesh(){return this._mesh}GetColumn(){return this._col}GetRow(){return this._row}},Qh.Gfx.Mesh=class{constructor(e,t,s){if(e<2||t<2)throw new Error("invalid mesh size");this._hsize=e,this._vsize=t,this._owner=s||null,this._pts=[],this._minX=0,this._minY=0,this._maxX=1,this._maxY=1,this._maxZ=0,this._bboxChanged=!1,this._meshChunks=[],this._lastZOffset=0,this._dataArrsChanged=!0;const i=e-1,r=t-1;for(let s=0;s<t;++s){const t=[];for(let n=0;n<e;++n){const e=Qh.New(Qh.Gfx.MeshPoint,this,n,s),a=n/i,o=s/r;e._Init(a,o,a,o),t.push(e)}this._pts.push(t)}}Release(){Qh.clearArray(this._pts),Qh.clearArray(this._meshChunks)}GetHSize(){return this._hsize}GetVSize(){return this._vsize}GetOwner(){return this._owner}_GetPoints(){return this._pts}_SetPointsChanged(){this._bboxChanged=!0,this._dataArrsChanged=!0}_MaybeComputeBounds(){if(!this._bboxChanged)return;let e=1/0,t=1/0,s=-1/0,i=-1/0,r=0;for(const n of this._pts)for(const a of n){const n=a.GetX(),o=a.GetY();e=Math.min(e,n),t=Math.min(t,o),s=Math.max(s,n),i=Math.max(i,o),r=Math.max(r,a.GetZElevation())}this._minX=e,this._minY=t,this._maxX=s,this._maxY=i,this._maxZ=r,this._bboxChanged=!1}GetMinX(){return this._MaybeComputeBounds(),this._minX}GetMinY(){return this._MaybeComputeBounds(),this._minY}GetMaxX(){return this._MaybeComputeBounds(),this._maxX}GetMaxY(){return this._MaybeComputeBounds(),this._maxY}GetMaxZ(){return this._MaybeComputeBounds(),this._maxZ}HasAnyZElevation(){return this.GetMaxZ()>0}GetMeshPointAt(e,t){return e=Math.floor(e),t=Math.floor(t),e<0||e>=this._hsize||t<0||t>=this._vsize?null:this._pts[t][e]}CalculateTransformedMesh(e,t,s){const i=s instanceof Qh.Rect;if(e.GetHSize()!==this.GetHSize()||e.GetVSize()!==this.GetVSize())throw new Error("source mesh wrong size");const r=e._pts,n=this._pts;for(let e=0,a=n.length;e<a;++e){const a=r[e],o=n[e];for(let e=0,r=o.length;e<r;++e){const r=a[e],n=o[e];i?n._Interpolate_TexRect(r,t,s):n._Interpolate_TexQuad(r,t,s)}}this._dataArrsChanged=!0}_MaybeUpdateDataArrays(e){if(!this._dataArrsChanged&&this._lastZOffset===e)return;const t=this._hsize,s=this._vsize,i=this._meshChunks,r=Math.floor(65535/t)-1;if(r<=0)throw new Error("mesh too large");const n=Math.ceil((s-1)/r);n<i.length&&(i.length=n);let a=0;for(let o=0;o<n;++o){const n=Math.min(r,s-a-1),l=(n+1)*t,h=3*l,u=2*l,c=(t-1)*n*6;if(o===i.length)i.push({posArr:new Float32Array(h),uvArr:new Float32Array(u),indexArr:new Uint16Array(c)});else{const e=i[o];e.posArr.length!==h&&(e.posArr=new Float32Array(h)),e.uvArr.length!==u&&(e.uvArr=new Float32Array(u)),e.indexArr.length!==c&&(e.indexArr=new Uint16Array(c))}const{posArr:d,uvArr:p,indexArr:_}=i[o];this._WriteChunkDataArrays(a,n,e,d,p,_),a+=r}this._lastZOffset=e,this._dataArrsChanged=!1}_WriteChunkDataArrays(e,t,s,i,r,n){const a=this._pts,o=this._hsize;let l=0,h=0,u=0;for(let c=e,d=e+t+1;c<d;++c){const t=a[c],p=c+1,_=c-e,m=_*o,f=(_+1)*o;for(let e=0,a=t.length;e<a;++e){const o=t[e],c=e+1;if(i[l++]=o.GetX(),i[l++]=o.GetY(),i[l++]=o.GetZElevation()+s,r[h++]=o.GetU(),r[h++]=o.GetV(),c<a&&p<d){const t=e+m,s=c+m,i=c+f,r=e+f;n[u++]=t,n[u++]=s,n[u++]=i,n[u++]=t,n[u++]=i,n[u++]=r}}}}Draw(e,t){this._MaybeUpdateDataArrays(t);for(const{posArr:t,uvArr:s,indexArr:i}of this._meshChunks)e.DrawMesh(t,s,i)}Outline(e,t){t||(t=(e,t,s)=>[e,t,s]);const s=this._pts;let i=s[0];for(let r=1,n=s.length;r<n;++r){const a=s[r];let o=i[0],l=a[0];for(let s=1,h=a.length;s<h;++s){const u=i[s],c=a[s],[d,p,_]=t(o.GetX(),o.GetY(),o.GetZElevation()),[m,f,g]=t(u.GetX(),u.GetY(),u.GetZElevation()),[y,S,T]=t(c.GetX(),c.GetY(),c.GetZElevation()),[x,b,G]=t(l.GetX(),l.GetY(),l.GetZElevation());e.Line3D(d,p,_,m,f,g),e.Line3D(d,p,_,y,S,T),e.Line3D(d,p,_,x,b,G),s===h-1&&e.Line3D(m,f,g,y,S,T),r===n-1&&e.Line3D(x,b,G,y,S,T),o=u,l=c}i=a}}InsertPolyMeshVertices(e){const t=.001,s=.99999999,i=e.pointsArr(),r=[],n=this.GetHSize()-1,a=this.GetVSize()-1,o=1/n,l=1/a,h=n-1,u=a-1;let c=i[0],d=i[1],p=Qh.clamp(Math.floor(c*n),0,h),_=Qh.clamp(Math.floor(d*a),0,u),m=!0,f=0,g=0,y=0,S=-1;const T=()=>{c=Qh.clamp(Qh.lerp(c,f,y),0,1),d=Qh.clamp(Qh.lerp(d,g,y),0,1),r.push(c,d)};for(let e=0,x=i.length;e<x;e+=2){c=i[e],d=i[e+1],r.push(c,d),p=Qh.clamp(Math.floor(c*n),0,h),_=Qh.clamp(Math.floor(d*a),0,u);const b=(e+2)%x;for(f=i[b],g=i[b+1],S=-1;;){if(r.length>1e6)throw new Error("Too many mesh poly points");const e=p*o,i=_*l,n=(p+1)*o,a=(_+1)*l;if(m=Qh.isPointInTriangleInclusive(c,d,e,i,n,i,n,a),0!==S&&(y=Qh.rayIntersectExtended(c,d,f,g,e,i,n,a,-.001),y>=0&&y<=s))T(),m=!m,S=0;else if(_>0&&2!==S&&(y=Qh.rayIntersectExtended(c,d,f,g,e,i,n,i,t),y>=0&&y<=s))T(),_--,m=!1,S=4;else if(p<h&&3!==S&&(y=Qh.rayIntersectExtended(c,d,f,g,n,i,n,a,t),y>=0&&y<=s))T(),p++,m=!1,S=1;else if(p>0&&1!==S&&(y=Qh.rayIntersectExtended(c,d,f,g,e,i,e,a,t),y>=0&&y<=s))T(),p--,m=!0,S=3;else{if(!(_<u&&4!==S&&(y=Qh.rayIntersectExtended(c,d,f,g,e,a,n,a,t),y>=0&&y<=s)))break;T(),_++,m=!0,S=2}}}return Qh.New(Qh.CollisionPoly,r)}TransformCollisionPoly(e,t){const s=this._TransformPolyPoints(e);this._SimplifyPoly(s),t.setPoints(s)}_TransformPolyPoints(e){const t=[],s=e.pointsArr();for(let e=0,i=s.length;e<i;e+=2){const i=s[e],r=s[e+1],[n,a]=this.TransformPoint(i,r);t.push(n,a)}return t}TransformPoint(e,t){const s=this.GetHSize()-1,i=this.GetVSize()-1,r=1/s,n=1/i,a=Qh.clamp(Math.floor(e*s),0,s-1),o=Qh.clamp(Math.floor(t*i),0,i-1),l=a*r,h=o*n,u=(a+1)*r,c=(o+1)*n,d=this.GetMeshPointAt(a,o),p=this.GetMeshPointAt(a+1,o+1),_=Qh.isPointInTriangleInclusive(e,t,l,h,u,h,u,c),m=_?l+r:l,f=_?h:h+n,g=this.GetMeshPointAt(a+(_?1:0),o+(_?0:1)),[y,S,T]=Qh.triangleCartesianToBarycentric(e,t,l,h,m,f,u,c);return Qh.triangleBarycentricToCartesian3d(y,S,T,d.GetX(),d.GetY(),d.GetZElevation(),g.GetX(),g.GetY(),g.GetZElevation(),p.GetX(),p.GetY(),p.GetZElevation())}_SimplifyPoly(e){const t=[],s=1e-7;let i=e[0],r=e[1],n=i-e.at(-2),a=r-e.at(-1);for(let o=0,l=e.length;o<l;o+=2){const h=(o+2)%l,u=e[h],c=e[h+1],d=u-i,p=c-r,_=Math.abs(d)<s&&Math.abs(n)<s&&Math.sign(p)===Math.sign(a),m=Math.abs(p)<s&&Math.abs(a)<s&&Math.sign(d)===Math.sign(n);(!_&&!m&&Math.abs(d/n-p/a)>.001||0==d&&0===p)&&t.push(i,r),i=u,r=c,n=d,a=p}t.length>=6&&t.length<e.length&&Qh.shallowAssignArray(e,t)}SaveToJson(){return{cols:this.GetHSize(),rows:this.GetVSize(),points:this._pts.map(e=>e.map(e=>e.SaveToJson()))}}LoadFromJson(e){const t=this.GetHSize(),s=this.GetVSize();if(e.cols!==t||e.rows!==s)throw new Error("mesh data wrong size");const i=e.points;for(let e=0;e<s;++e){const s=i[e];for(let i=0;i<t;++i)this.GetMeshPointAt(i,e).LoadFromJson(s[i])}}}}{let tu=function(e,t){let s,i,r,n;switch(e){case"rgba8":s=t.RGBA8,i=t.RGBA,r=t.RGBA,n=t.UNSIGNED_BYTE;break;case"rgb8":s=t.RGB8,i=t.RGB,r=t.RGB,n=t.UNSIGNED_BYTE;break;case"rgba4":s=t.RGBA4,i=t.RGBA,r=t.RGBA,n=t.UNSIGNED_SHORT_4_4_4_4;break;case"rgb5_a1":s=t.RGB5_A1,i=t.RGBA,r=t.RGBA,n=t.UNSIGNED_SHORT_5_5_5_1;break;case"rgb565":s=t.RGB565,i=t.RGB,r=t.RGB,n=t.UNSIGNED_SHORT_5_6_5;break;default:throw new Error("invalid pixel format")}return{sizedinternalformat:s,internalformat:i,format:r,type:n}};GetFormatSpecifiers=tu;const su=self.C3,iu=new Set(["rgba8","rgb8","rgba4","rgb5_a1","rgb565"]),ru=new Set(["nearest","bilinear","trilinear"]),nu=new Set(["default","low","high"]),au=new Set(["clamp-to-edge","repeat","mirror-repeat"]),ou={wrapX:"clamp-to-edge",wrapY:"clamp-to-edge",sampling:"trilinear",anisotropy:0,pixelFormat:"rgba8",mipMap:!0,mipMapQuality:"default",premultiplyAlpha:!0,isSvg:!1,width:-1,height:-1},lu={premultiplyAlpha:!0,flipY:!1},hu=new Set;su.Gfx.WebGLRendererTexture=class{constructor(e){this._renderer=e,this._texture=null,this._width=0,this._height=0,this._isStatic=!0,this._wrapX="clamp-to-edge",this._wrapY="clamp-to-edge",this._sampling="trilinear",this._anisotropy=0,this._pixelFormat="rgba8",this._isMipMapped=!1,this._mipMapQuality="default",this._refCount=0}_CreateStatic(e,t){if(!("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas||e instanceof ImageData||e instanceof ArrayBuffer))throw new Error("invalid texture source");if(t=Object.assign({},ou,t),this._texture)throw new Error("already created texture");if(this._wrapX=t.wrapX,this._wrapY=t.wrapY,this._sampling=t.sampling,this._anisotropy=t.anisotropy,this._pixelFormat=t.pixelFormat,this._isMipMapped=!!t.mipMap&&this._renderer.AreMipmapsEnabled(),this._mipMapQuality=t.mipMapQuality,!au.has(this._wrapX)||!au.has(this._wrapY))throw new Error("invalid wrap mode");if(!ru.has(this._sampling))throw new Error("invalid sampling");if(!iu.has(this._pixelFormat))throw new Error("invalid pixel format");if(!nu.has(this._mipMapQuality))throw new Error("invalid mipmap quality");if(this._isStatic=!0,e instanceof ArrayBuffer||null===e||t.isSvg){if(this._width=t.width,this._height=t.height,e instanceof ArrayBuffer&&e.byteLength!==this._width*this._height*4)throw new Error("ArrayBuffer wrong size")}else this._width=e.width,this._height=e.height;if(this._width<=0||this._height<=0)throw new Error("invalid texture data size");if(t.isSvg){const t=su.CreateCanvas(this._width,this._height);t.getContext("2d").drawImage(e,0,0,this._width,this._height),e=t}const s=su.isPOT(this._width)&&su.isPOT(this._height),i=this._renderer.GetMaxTextureSize();if(this._width>i||this._height>i)throw new Error("texture data exceeds maximum texture size");const r=this._renderer.GetContext(),n=this._renderer.GetWebGLVersionNumber();this._texture=r.createTexture(),r.bindTexture(r.TEXTURE_2D,this._texture),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!1);const a=tu(this._pixelFormat,r);if(this._renderer.SupportsNPOTTextures()||s||!this._IsTiled())if(n>=2){let t;t=this._isMipMapped?Math.floor(Math.log2(Math.max(this._width,this._height))+1):1,r.texStorage2D(r.TEXTURE_2D,t,a.sizedinternalformat,this._width,this._height),e instanceof ArrayBuffer?r.texSubImage2D(r.TEXTURE_2D,0,0,0,this._width,this._height,a.format,a.type,new Uint8Array(e)):null!==e&&r.texSubImage2D(r.TEXTURE_2D,0,0,0,a.format,a.type,e)}else e instanceof ArrayBuffer?r.texImage2D(r.TEXTURE_2D,0,a.internalformat,this._width,this._height,0,a.format,a.type,new Uint8Array(e)):null===e?r.texImage2D(r.TEXTURE_2D,0,a.internalformat,this._width,this._height,0,a.format,a.type,null):r.texImage2D(r.TEXTURE_2D,0,a.internalformat,a.format,a.type,e);else{if(null===e)throw new Error("cannot pass null data when creating a NPOT tiled texture without NPOT support");if(e instanceof ArrayBuffer&&(e=new ImageData(new Uint8ClampedArray(e),this._width,this._height)),e instanceof ImageData){const t=su.CreateCanvas(this._width,this._height);t.getContext("2d").putImageData(e,0,0),e=t}const t=su.CreateCanvas(su.nextHighestPowerOfTwo(this._width),su.nextHighestPowerOfTwo(this._height)),s=t.getContext("2d");s.imageSmoothingEnabled="nearest"!==this._sampling,s.drawImage(e,0,0,this._width,this._height,0,0,t.width,t.height),r.texImage2D(r.TEXTURE_2D,0,a.internalformat,a.format,a.type,t)}null!==e&&this._SetTextureParameters(r),r.bindTexture(r.TEXTURE_2D,null),this._renderer._ResetLastTexture(),this._refCount=1,hu.add(this)}_CreateDynamic(e,t,s){if(s=Object.assign({},ou,s),this._texture)throw new Error("already created texture");if(this._wrapX=s.wrapX,this._wrapY=s.wrapY,this._sampling=s.sampling,this._pixelFormat=s.pixelFormat,this._isMipMapped=!!s.mipMap&&this._renderer.AreMipmapsEnabled(),this._mipMapQuality=s.mipMapQuality,!au.has(this._wrapX)||!au.has(this._wrapY))throw new Error("invalid wrap mode");if(!ru.has(this._sampling))throw new Error("invalid sampling");if(!iu.has(this._pixelFormat))throw new Error("invalid pixel format");if(!nu.has(this._mipMapQuality))throw new Error("invalid mipmap quality");this._isStatic=!1,this._width=Math.floor(e),this._height=Math.floor(t);const i=su.isPOT(this._width)&&su.isPOT(this._height),r=this._renderer.GetMaxTextureSize();if(this._width<=0||this._height<=0)throw new Error("invalid texture size");if(this._width>r||this._height>r)throw new Error("texture exceeds maximum texture size");if(!this._renderer.SupportsNPOTTextures()&&this._IsTiled()&&!i)throw new Error("non-power-of-two tiled textures not supported");const n=this._renderer.GetContext(),a=this._renderer.GetWebGLVersionNumber();this._texture=n.createTexture(),n.bindTexture(n.TEXTURE_2D,this._texture),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s.premultiplyAlpha),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,!1);const o=tu(this._pixelFormat,n),l=a>=2?o.sizedinternalformat:o.internalformat;n.texImage2D(n.TEXTURE_2D,0,l,this._width,this._height,0,o.format,o.type,null),this._SetTextureParameters(n),n.bindTexture(n.TEXTURE_2D,null),this._renderer._ResetLastTexture(),this._refCount=1,hu.add(this)}_GetMipMapHint(e){if("default"===this._mipMapQuality)return this._isStatic?e.NICEST:e.FASTEST;if("low"===this._mipMapQuality)return e.FASTEST;if("high"===this._mipMapQuality)return e.NICEST;throw new Error("invalid mipmap quality")}_IsTiled(){return"clamp-to-edge"!==this._wrapX||"clamp-to-edge"!==this._wrapY}_GetTextureWrapMode(e,t){if("clamp-to-edge"===t)return e.CLAMP_TO_EDGE;if("repeat"===t)return e.REPEAT;if("mirror-repeat"===t)return e.MIRRORED_REPEAT;throw new Error("invalid wrap mode")}_SetTextureParameters(e){const t=su.isPOT(this._width)&&su.isPOT(this._height);if(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,this._GetTextureWrapMode(e,this._wrapX)),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,this._GetTextureWrapMode(e,this._wrapY)),"nearest"===this._sampling)e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),this._isMipMapped=!1;else if(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),(t||this._renderer.SupportsNPOTTextures())&&this._isMipMapped){e.hint(e.GENERATE_MIPMAP_HINT,this._GetMipMapHint(e)),e.generateMipmap(e.TEXTURE_2D);const t="trilinear"===this._sampling&&!this._renderer.HasMajorPerformanceCaveat();e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,t?e.LINEAR_MIPMAP_LINEAR:e.LINEAR_MIPMAP_NEAREST)}else e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),this._isMipMapped=!1;const s=this._renderer._GetAnisotropicExtension();s&&this._anisotropy>0&&"nearest"!==this._sampling&&e.texParameterf(e.TEXTURE_2D,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(this._anisotropy,this._renderer._GetMaxAnisotropy()))}_Update(e,t){if(!("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas||e instanceof ImageData))throw new Error("invalid texture source");if(!this._texture||this._refCount<=0)throw new Error("texture not created");if(this._isStatic)throw new Error("cannot update static texture");t=Object.assign({},lu,t);const s=e.width||e.videoWidth,i=e.height||e.videoHeight,r=this._renderer.GetWebGLVersionNumber(),n=this._renderer.GetContext();n.bindTexture(n.TEXTURE_2D,this._texture),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,!!t.flipY);const a=tu(this._pixelFormat,n),o=r>=2?a.sizedinternalformat:a.internalformat;try{if(this._width===s&&this._height===i){const t=su.isPOT(this._width)&&su.isPOT(this._height);n.texSubImage2D(n.TEXTURE_2D,0,0,0,a.format,a.type,e),(t||this._renderer.SupportsNPOTTextures())&&this._isMipMapped&&(n.hint(n.GENERATE_MIPMAP_HINT,this._GetMipMapHint(n)),n.generateMipmap(n.TEXTURE_2D))}else{this._width=s,this._height=i;const t=su.isPOT(this._width)&&su.isPOT(this._height);if(!this._renderer.SupportsNPOTTextures()&&this._IsTiled()&&!t)throw new Error("non-power-of-two tiled textures not supported");n.texImage2D(n.TEXTURE_2D,0,o,a.format,a.type,e),(t||this._renderer.SupportsNPOTTextures())&&this._isMipMapped&&(n.hint(n.GENERATE_MIPMAP_HINT,this._GetMipMapHint(n)),n.generateMipmap(n.TEXTURE_2D))}}catch(e){console.error("Error updating WebGL texture: ",e)}n.bindTexture(n.TEXTURE_2D,null),this._renderer._ResetLastTexture()}_Delete(){if(this._refCount>0)throw new Error("texture still has references");if(!this._texture)throw new Error("already deleted texture");hu.delete(this),this._renderer.GetContext().deleteTexture(this._texture),this._texture=null}IsValid(){return!!this._texture}_GetTexture(){return this._texture}GetRenderer(){return this._renderer}AddReference(){this._refCount++}SubtractReference(){if(this._refCount<=0)throw new Error("no more references");this._refCount--}GetReferenceCount(){return this._refCount}GetWidth(){return this._width}GetHeight(){return this._height}IsStatic(){return this._isStatic}GetEstimatedMemoryUsage(){let e=this._width*this._height;switch(this._pixelFormat){case"rgba8":e*=4;break;case"rgb8":e*=3;break;case"rgba4":case"rgb5_a1":case"rgb565":e*=2}return this._isMipMapped&&(e+=Math.floor(e/3)),e}static OnContextLost(){hu.clear()}static allTextures(){return hu.values()}}}{const uu=self.C3,cu=self.assert,du=self.glMatrix,pu=du.vec3,_u=du.mat4,mu=new Set(["nearest","bilinear","trilinear"]),fu={sampling:"trilinear",alpha:!0,depth:!1,isSampled:!0,isDefaultSize:!0,multisampling:0},gu=new Set;uu.Gfx.WebGLRenderTarget=class{constructor(e){this._renderer=e,this._frameBuffer=null,this._frameBufferNoDepth=null,this._texture=null,this._renderBuffer=null,this._width=0,this._height=0,this._isDefaultSize=!0,this._sampling="trilinear",this._alpha=!0,this._depth=!1,this._isSampled=!0,this._multisampling=0,this._projectionMatrix=_u.create(),this._lastFov=0,this._lastNearZ=0,this._lastFarZ=0}_Create(e,t,s){s=Object.assign({},fu,s);const i=this._renderer.GetWebGLVersionNumber();if(this._texture||this._renderBuffer)throw new Error("already created render target");if(this._sampling=s.sampling,this._alpha=!!s.alpha,this._depth=!!s.depth,this._isSampled=!!s.isSampled,this._isDefaultSize=!!s.isDefaultSize,this._multisampling=s.multisampling,!mu.has(this._sampling))throw new Error("invalid sampling");if(this._multisampling>0&&(i<2||this._isSampled))throw new Error("invalid use of multisampling");if(i<2&&(this._isSampled=!0),this._width=e,this._height=t,this._width<=0||this._height<=0)throw new Error("invalid render target size");this._CalculateProjection();const r=this._renderer.GetContext();if(this._frameBuffer=r.createFramebuffer(),this._depth&&(this._frameBufferNoDepth=r.createFramebuffer()),this._isSampled){this._texture=this._renderer.CreateDynamicTexture(this._width,this._height,{sampling:this._sampling,pixelFormat:this._alpha?"rgba8":"rgb8",mipMap:!1});const e=this._texture._GetTexture();r.bindFramebuffer(r.FRAMEBUFFER,this._frameBuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,e,0),this._depth&&(r.bindFramebuffer(r.FRAMEBUFFER,this._frameBufferNoDepth),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,e,0))}else{this._renderBuffer=r.createRenderbuffer(),r.bindRenderbuffer(r.RENDERBUFFER,this._renderBuffer);const e=this._alpha?r.RGBA8:r.RGB8;if(this._multisampling>0){const t=r.getInternalformatParameter(r.RENDERBUFFER,e,r.SAMPLES);if(t&&t[0]){const e=t[0];this._multisampling>e&&(this._multisampling=e)}else this._multisampling=0}0===this._multisampling?r.renderbufferStorage(r.RENDERBUFFER,e,this._width,this._height):r.renderbufferStorageMultisample(r.RENDERBUFFER,this._multisampling,e,this._width,this._height),r.bindFramebuffer(r.FRAMEBUFFER,this._frameBuffer),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.RENDERBUFFER,this._renderBuffer),this._depth&&(r.bindFramebuffer(r.FRAMEBUFFER,this._frameBufferNoDepth),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.RENDERBUFFER,this._renderBuffer)),r.bindRenderbuffer(r.RENDERBUFFER,null)}const n=this._renderer._GetDepthBuffer();this._depth&&n&&(r.bindFramebuffer(r.FRAMEBUFFER,this._frameBuffer),this._renderer._CanSampleDepth()?r.framebufferTexture2D(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.TEXTURE_2D,n,0):r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.RENDERBUFFER,n)),r.bindFramebuffer(r.FRAMEBUFFER,null),gu.add(this)}_Resize(e,t){if(this._width===e&&this._height===t)return;this._width=e,this._height=t,this._CalculateProjection();const s=this._renderer.GetContext();s.bindFramebuffer(s.FRAMEBUFFER,this._frameBuffer),this._texture?this._texture._Update(new ImageData(this._width,this._height)):(s.bindRenderbuffer(s.RENDERBUFFER,this._renderBuffer),s.renderbufferStorage(s.RENDERBUFFER,this._alpha?s.RGBA8:s.RGB8,this._width,this._height),s.bindRenderbuffer(s.RENDERBUFFER,null));const i=this._renderer._GetDepthBuffer();this._depth&&i&&(this._renderer._CanSampleDepth()?s.framebufferTexture2D(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.TEXTURE_2D,i,0):s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,i)),s.bindFramebuffer(s.FRAMEBUFFER,null)}_Delete(){if(!this._texture&&!this._renderBuffer)throw new Error("already deleted render target");gu.delete(this);const e=this._renderer.GetContext();this._texture?(e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,null,0),this._depth&&(e.bindFramebuffer(e.FRAMEBUFFER,this._frameBufferNoDepth),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,null,0)),this._renderer.DeleteTexture(this._texture),this._texture=null):this._renderBuffer&&(e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,null),this._depth&&(e.bindFramebuffer(e.FRAMEBUFFER,this._frameBufferNoDepth),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,null)),e.deleteRenderbuffer(this._renderBuffer),this._renderBuffer=null),e.bindFramebuffer(e.FRAMEBUFFER,null),this._renderer.GetWebGLVersionNumber()>=2&&(e.bindFramebuffer(e.READ_FRAMEBUFFER,null),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null)),e.deleteFramebuffer(this._frameBuffer),this._depth&&e.deleteFramebuffer(this._frameBufferNoDepth);const t=this._renderer.GetBatchState();t.currentFramebuffer=null,t.currentFramebufferNoDepth=null,this._frameBuffer=null}_CalculateProjection(){this._renderer.CalculatePerspectiveMatrix(this._projectionMatrix,this._width/this._height),this._lastFov=this._renderer.GetFovY(),this._lastNearZ=this._renderer.GetNearZ(),this._lastFarZ=this._renderer.GetFarZ()}_GetFramebuffer(){return this._frameBuffer}_GetFramebufferNoDepth(){return this._frameBufferNoDepth}GetRenderer(){return this._renderer}GetTexture(){return this._texture}GetProjectionMatrix(){return this._renderer.GetFovY()===this._lastFov&&this._renderer.GetNearZ()===this._lastNearZ&&this._renderer.GetFarZ()===this._lastFarZ||this._CalculateProjection(),this._projectionMatrix}IsLinearSampling(){return"nearest"!==this._sampling}HasAlpha(){return this._alpha}IsSampled(){return this._isSampled}HasDepthBuffer(){return this._depth}GetWidth(){return this._width}GetHeight(){return this._height}IsDefaultSize(){return this._isDefaultSize}GetMultisampling(){return this._multisampling}GetOptions(){const e={sampling:this._sampling,alpha:this._alpha,isSampled:this._isSampled};return this._isDefaultSize||(e.width=this._width,e.height=this._height),e}IsCompatibleWithOptions(e){return"nearest"!==(e=Object.assign({},fu,e)).sampling===this.IsLinearSampling()&&!!e.alpha===this.HasAlpha()&&!!e.depth===this.HasDepthBuffer()&&!(this._renderer.GetWebGLVersionNumber()>=2&&!!e.isSampled!==this.IsSampled())&&("number"==typeof e.width||"number"==typeof e.height?!this.IsDefaultSize()&&this.GetWidth()===Math.floor(e.width)&&this.GetHeight()===Math.floor(e.height):this.IsDefaultSize())}_GetWebGLTexture(){return this._texture?this._texture._GetTexture():null}GetEstimatedMemoryUsage(){return this._texture?this._texture.GetEstimatedMemoryUsage():this._width*this._height*(this._alpha?4:3)}static async DebugReadPixelsToBlob(e,t){const s=await e.ReadBackRenderTargetToImageData(t,!0);return await uu.ImageDataToBlob(s)}static OnContextLost(){gu.clear()}static allRenderTargets(){return gu.values()}static ResizeAll(e,t){for(const s of gu)s.IsDefaultSize()&&s._Resize(e,t)}}}{const yu=self.C3,Su=self.glMatrix,Tu=Su.vec3,xu=Su.mat4,bu=new Set(["aPos","aTex","aColor","aPoints","matP","matMV","samplerFront","samplerBack","samplerDepth","destStart","destEnd","srcStart","srcEnd","srcOriginStart","srcOriginEnd","pixelSize","seconds","devicePixelRatio","layerScale","layerAngle","layoutStart","layoutEnd","color","color2_","pointTexStart","pointTexEnd","zElevation","tileSize","tileSpacing","outlineThickness","zNear","zFar"]);yu.Gfx.WebGLShaderProgram=class extends yu.Gfx.ShaderProgramBase{static async Compile(e,t){const s=e.GetContext(),i=t.src,r=t.vertexSrc,n=t.name,a=s.createShader(s.FRAGMENT_SHADER);s.shaderSource(a,i),s.compileShader(a);const o=s.createShader(s.VERTEX_SHADER);s.shaderSource(o,r),s.compileShader(o);const l=s.createProgram();s.attachShader(l,a),s.attachShader(l,o),s.bindAttribLocation(l,0,"aPos"),s.bindAttribLocation(l,1,"aTex"),s.bindAttribLocation(l,2,"aColor"),s.bindAttribLocation(l,3,"aPoints"),s.linkProgram(l);const h=e._GetParallelShaderCompileExtension();if(h?await e._WaitForObjectReady(()=>s.getProgramParameter(l,h.COMPLETION_STATUS_KHR)):await yu.Wait(5),!s.getShaderParameter(a,s.COMPILE_STATUS)){const e=s.getShaderInfoLog(a);throw s.deleteShader(a),s.deleteShader(o),s.deleteProgram(l),new Error("Error compiling fragment shader: "+e)}if(!s.getShaderParameter(o,s.COMPILE_STATUS)){const e=s.getShaderInfoLog(o);throw s.deleteShader(a),s.deleteShader(o),s.deleteProgram(l),new Error("Error compiling vertex shader: "+e)}if(!s.getProgramParameter(l,s.LINK_STATUS)){const e=s.getProgramInfoLog(l);throw s.deleteShader(a),s.deleteShader(o),s.deleteProgram(l),new Error("Error linking shader program: "+e)}const u=yu.FilterUnprintableChars(s.getProgramInfoLog(l)||"").trim();return u&&!yu.IsStringAllWhitespace(u)&&console.info(`[WebGL] Shader program '${n}' compilation log: `,u),s.deleteShader(a),s.deleteShader(o),l}static async Create(e,t){const s=await yu.Gfx.WebGLShaderProgram.Compile(e,t);return new yu.Gfx.WebGLShaderProgram(e,s,t)}constructor(e,t,s){super(e,s);const i=e.GetContext(),r=e.GetBatchState();e.EndBatch(),i.useProgram(t),this._gl=i,this._shaderProgram=t,this._isDeviceTransform="<default-device-transform>"===s.name;const n=i.getAttribLocation(t,"aPos"),a=i.getAttribLocation(t,"aTex"),o=i.getAttribLocation(t,"aColor");this._locAPoints=i.getAttribLocation(t,"aPoints"),-1!==n&&(i.bindBuffer(i.ARRAY_BUFFER,e._vertexBuffer),i.vertexAttribPointer(n,3,i.FLOAT,!1,0,0),i.enableVertexAttribArray(n)),-1!==a&&(i.bindBuffer(i.ARRAY_BUFFER,e._texcoordBuffer),i.vertexAttribPointer(a,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(a)),-1!==o&&(i.bindBuffer(i.ARRAY_BUFFER,e._colorBuffer),i.vertexAttribPointer(o,4,e.IsColorDataF16()?i.HALF_FLOAT:i.FLOAT,!1,0,0),i.enableVertexAttribArray(o)),-1!==this._locAPoints&&(i.bindBuffer(i.ARRAY_BUFFER,e._pointBuffer),i.vertexAttribPointer(this._locAPoints,4,i.FLOAT,!1,0,0),i.enableVertexAttribArray(this._locAPoints)),i.bindBuffer(i.ARRAY_BUFFER,null),this._uMatP=new yu.Gfx.WebGLShaderUniform(this,"matP","mat4"),this._uMatMV=new yu.Gfx.WebGLShaderUniform(this,"matMV","mat4"),this._uColor=new yu.Gfx.WebGLShaderUniform(this,"color","vec4"),this._uSamplerFront=new yu.Gfx.WebGLShaderUniform(this,"samplerFront","sampler"),this._uPointTexStart=new yu.Gfx.WebGLShaderUniform(this,"pointTexStart","vec2"),this._uPointTexEnd=new yu.Gfx.WebGLShaderUniform(this,"pointTexEnd","vec2"),this._uZElevation=new yu.Gfx.WebGLShaderUniform(this,"zElevation","float"),this._uTileSize=new yu.Gfx.WebGLShaderUniform(this,"tileSize","vec2"),this._uTileSpacing=new yu.Gfx.WebGLShaderUniform(this,"tileSpacing","vec2"),this._uColor2=new yu.Gfx.WebGLShaderUniform(this,"color2_","vec4"),this._uOutlineThickness=new yu.Gfx.WebGLShaderUniform(this,"outlineThickness","float"),this._uSamplerBack=new yu.Gfx.WebGLShaderUniform(this,"samplerBack","sampler"),this._uSamplerDepth=new yu.Gfx.WebGLShaderUniform(this,"samplerDepth","sampler"),this._uDestStart=new yu.Gfx.WebGLShaderUniform(this,"destStart","vec2"),this._uDestEnd=new yu.Gfx.WebGLShaderUniform(this,"destEnd","vec2"),this._uSrcStart=new yu.Gfx.WebGLShaderUniform(this,"srcStart","vec2"),this._uSrcEnd=new yu.Gfx.WebGLShaderUniform(this,"srcEnd","vec2"),this._uSrcOriginStart=new yu.Gfx.WebGLShaderUniform(this,"srcOriginStart","vec2"),this._uSrcOriginEnd=new yu.Gfx.WebGLShaderUniform(this,"srcOriginEnd","vec2"),this._uPixelSize=new yu.Gfx.WebGLShaderUniform(this,"pixelSize","vec2"),this._uSeconds=new yu.Gfx.WebGLShaderUniform(this,"seconds","float"),this._uDevicePixelRatio=new yu.Gfx.WebGLShaderUniform(this,"devicePixelRatio","float"),this._uLayerScale=new yu.Gfx.WebGLShaderUniform(this,"layerScale","float"),this._uLayerAngle=new yu.Gfx.WebGLShaderUniform(this,"layerAngle","float"),this._uLayoutStart=new yu.Gfx.WebGLShaderUniform(this,"layoutStart","vec2"),this._uLayoutEnd=new yu.Gfx.WebGLShaderUniform(this,"layoutEnd","vec2"),this._uZNear=new yu.Gfx.WebGLShaderUniform(this,"zNear","float"),this._uZFar=new yu.Gfx.WebGLShaderUniform(this,"zFar","float"),this._hasAnyOptionalUniforms=!!(this._uPixelSize.IsUsed()||this._uSeconds.IsUsed()||this._uSamplerBack.IsUsed()||this._uDestStart.IsUsed()||this._uDestEnd.IsUsed()||this._uSrcStart.IsUsed()||this._uSrcEnd.IsUsed()||this._uSrcOriginStart.IsUsed()||this._uSrcOriginEnd.IsUsed()||this._uDevicePixelRatio.IsUsed()||this._uLayerScale.IsUsed()||this._uLayerAngle.IsUsed()||this._uLayoutStart.IsUsed()||this._uLayoutEnd.IsUsed());const l=s.parameters||[];this._uCustomParameters=[],this._usesAnySrcRectOrPixelSize=this._uPixelSize.IsUsed()||this._uSrcStart.IsUsed()||this._uSrcEnd.IsUsed()||this._uSrcOriginStart.IsUsed()||this._uSrcOriginEnd.IsUsed(),this._hasCurrentMatP=!1,this._hasCurrentMatMV=!1,this._uColor.Init4f(1,1,1,1),this._uColor2.Init4f(1,1,1,1),this._uSamplerFront.Init1i(0),this._uSamplerBack.Init1i(1),this._uSamplerDepth.Init1i(2),this._uPointTexStart.Init2f(0,0),this._uPointTexEnd.Init2f(1,1),this._uZElevation.Init1f(0),this._uTileSize.Init2f(0,0),this._uTileSpacing.Init2f(0,0),this._uDestStart.Init2f(0,0),this._uDestEnd.Init2f(1,1),this._uSrcStart.Init2f(0,0),this._uSrcEnd.Init2f(0,0),this._uSrcOriginStart.Init2f(0,0),this._uSrcOriginEnd.Init2f(0,0),this._uPixelSize.Init2f(0,0),this._uDevicePixelRatio.Init1f(1),this._uZNear.Init1f(e.GetNearZ()),this._uZFar.Init1f(e.GetFarZ()),this._uLayerScale.Init1f(1),this._uLayerAngle.Init1f(0),this._uSeconds.Init1f(0),this._uLayoutStart.Init2f(0,0),this._uLayoutEnd.Init2f(0,0),this._uOutlineThickness.Init1f(1);for(const e of l){const t=e[0],s=e[2],i=new yu.Gfx.WebGLShaderUniform(this,t,s);"color"===s?i.Init3f(0,0,0):i.Init1f(0),this._uCustomParameters.push(i)}this._isDeviceTransform?this._UpdateDeviceTransformUniforms(r.currentMatP):(this.UpdateMatP(r.currentMatP,!0),this.UpdateMatMV(r.currentMV,!0));const h=r.currentShader;i.useProgram(h?h._shaderProgram:null)}Release(){this._gl.deleteProgram(this._shaderProgram),this._shaderProgram=null,this._renderer._RemoveShaderProgram(this),this._gl=null,super.Release()}GetWebGLContext(){return this._gl}GetShaderProgram(){return this._shaderProgram}GetParameterCount(){return this._uCustomParameters.length}GetParameterType(e){return e<0||e>=this._uCustomParameters.length?null:this._uCustomParameters[e].GetType()}AreCustomParametersAlreadySetInBatch(e){for(let t=0,s=e.length;t<s;++t)if(!this._uCustomParameters[t].IsSetToCustomInBatch(e[t]))return!1;return!0}SetCustomParametersInBatch(e){for(let t=0,s=e.length;t<s;++t)this._uCustomParameters[t].SetBatchValueCustom(e[t])}AreOptionalUniformsAlreadySetInBatch(e,t,s,i,r,n,a,o,l,h){return!(this._uSamplerBack.IsUsed()||this._uPixelSize.IsUsed()&&!this._uPixelSize.IsSetTo2InBatch(r,n)||this._uDestStart.IsUsed()&&!this._uDestStart.IsSetTo2InBatch(e.getLeft(),e.getTop())||this._uDestEnd.IsUsed()&&!this._uDestEnd.IsSetTo2InBatch(e.getRight(),e.getBottom())||this._uDevicePixelRatio.IsUsed()&&!this._uDevicePixelRatio.IsSetTo1InBatch(a)||this._uLayerScale.IsUsed()&&!this._uLayerScale.IsSetTo1InBatch(o)||this._uLayerAngle.IsUsed()&&!this._uLayerAngle.IsSetTo1InBatch(l)||this._uSrcStart.IsUsed()&&!this._uSrcStart.IsSetTo2InBatch(t.getLeft(),t.getTop())||this._uSrcEnd.IsUsed()&&!this._uSrcEnd.IsSetTo2InBatch(t.getRight(),t.getBottom())||this._uSrcOriginStart.IsUsed()&&!this._uSrcOriginStart.IsSetTo2InBatch(s.getLeft(),s.getTop())||this._uSrcOriginEnd.IsUsed()&&!this._uSrcOriginEnd.IsSetTo2InBatch(s.getRight(),s.getBottom())||this._uLayoutStart.IsUsed()&&!this._uLayoutStart.IsSetTo2InBatch(i.getLeft(),i.getTop())||this._uLayoutEnd.IsUsed()&&!this._uLayoutEnd.IsSetTo2InBatch(i.getTop(),i.getBottom())||this._uSeconds.IsUsed()&&!this._uSeconds.IsSetTo1InBatch(h))}SetOptionalUniformsInBatch(e,t,s,i,r,n,a,o,l,h){this._uSamplerBack.IsUsed()||(this._uPixelSize.IsUsed()&&this._uPixelSize.SetBatch2(r,n),this._uDestStart.IsUsed()&&this._uDestStart.SetBatch2(e.getLeft(),e.getTop()),this._uDestEnd.IsUsed()&&this._uDestEnd.SetBatch2(e.getRight(),e.getBottom()),this._uDevicePixelRatio.IsUsed()&&this._uDevicePixelRatio.SetBatch1(a),this._uLayerScale.IsUsed()&&this._uLayerScale.SetBatch1(o),this._uLayerAngle.IsUsed()&&this._uLayerAngle.SetBatch1(l),this._uSrcStart.IsUsed()&&this._uSrcStart.SetBatch2(t.getLeft(),t.getTop()),this._uSrcEnd.IsUsed()&&this._uSrcEnd.SetBatch2(t.getRight(),t.getBottom()),this._uSrcOriginStart.IsUsed()&&this._uSrcOriginStart.SetBatch2(s.getLeft(),s.getTop()),this._uSrcOriginEnd.IsUsed()&&this._uSrcOriginEnd.SetBatch2(s.getRight(),s.getBottom()),this._uLayoutStart.IsUsed()&&this._uLayoutStart.SetBatch2(i.getLeft(),i.getTop()),this._uLayoutEnd.IsUsed()&&this._uLayoutEnd.SetBatch2(i.getTop(),i.getBottom()),this._uSeconds.IsUsed()&&this._uSeconds.SetBatch1(h))}UpdateMatP(e,t){this._hasCurrentMatP&&!t||this._isDeviceTransform||(this._uMatP.IsUsed()&&this._uMatP.UpdateMatrix4fv(e),this._hasCurrentMatP=!0)}SetMatPStale(){this._hasCurrentMatP=!1}UpdateMatMV(e,t){this._hasCurrentMatMV&&!t||this._isDeviceTransform||(this._uMatMV.IsUsed()&&this._uMatMV.UpdateMatrix4fv(e),this._hasCurrentMatMV=!0)}SetMatMVStale(){this._hasCurrentMatMV=!1}_UpdateDeviceTransformUniforms(e){if(!this._isDeviceTransform)throw new Error("not device transform shader");this._uMatP.UpdateMatrix4fv(e);const t=this._renderer,s=t.GetWidth()/2,i=t.GetHeight()/2,r=t.CalculateLookAtModelView2(s,i,t.GetDefaultCameraZ(t.GetHeight()),s,i,0,t.GetHeight());this._uMatMV.UpdateMatrix4fv(r)}UpdateColor(e){this._uColor.IsUsed()&&this._uColor.Update4f(e[0],e[1],e[2],e[3])}static GetReservedUniformNames(){return bu}static _GetConservativeDepthShaderPrefix(e){return e?"\n#extension GL_EXT_conservative_depth : enable\nlayout (depth_greater) out highp float gl_FragDepth;\n\t":""}static GetDefaultVertexShaderSource(e){const t=e?"highp":"mediump";return["attribute highp vec3 aPos;",`attribute ${t} vec2 aTex;`,`varying ${t} vec2 vTex;`,"attribute lowp vec4 aColor;","varying lowp vec4 vColor;","uniform highp mat4 matP;","uniform highp mat4 matMV;","void main(void) {","\tgl_Position = matP * matMV * vec4(aPos, 1.0);","\tvTex = aTex;","\tvColor = aColor;","}"].join("\n")}static GetDefaultVertexShaderSource_WebGL2(e){const t=e?"highp":"mediump";return["#version 300 es","in highp vec3 aPos;",`in ${t} vec2 aTex;`,`out ${t} vec2 vTex;`,"in lowp vec4 aColor;","out lowp vec4 vColor;","uniform highp mat4 matP;","uniform highp mat4 matMV;","void main(void) {","\tgl_Position = matP * matMV * vec4(aPos, 1.0);","\tvTex = aTex;","\tvColor = aColor;","}"].join("\n")}static GetTextureFillFragmentShaderSource_WebGL1_NoFragDepth(){return["varying mediump vec2 vTex;","varying lowp vec4 vColor;","uniform lowp sampler2D samplerFront;","void main(void) {","\tgl_FragColor = texture2D(samplerFront, vTex) * vColor;","}"].join("\n")}static GetTextureFillFragmentShaderSource_WebGL1_FragDepthEXT(){return["#extension GL_EXT_frag_depth : enable","varying mediump vec2 vTex;","varying lowp vec4 vColor;","uniform lowp sampler2D samplerFront;","void main(void) {","\tgl_FragColor = texture2D(samplerFront, vTex) * vColor;","\tgl_FragDepthEXT = (gl_FragColor.a == 0.0 ? 1.0 : gl_FragCoord.z);","}"].join("\n")}static GetTextureFillFragmentShaderSource_WebGL2(e){return["#version 300 es",yu.Gfx.WebGLShaderProgram._GetConservativeDepthShaderPrefix(e),"in mediump vec2 vTex;","out lowp vec4 outColor;","in lowp vec4 vColor;","uniform lowp sampler2D samplerFront;","void main(void) {","\toutColor = texture(samplerFront, vTex) * vColor;","\tgl_FragDepth = (outColor.a == 0.0 ? 1.0 : gl_FragCoord.z);","}"].join("\n")}static GetTilemapFragmentShaderSource_WebGL1_NoFragDepth(){return["varying highp vec2 vTex;","varying lowp vec4 vColor;","uniform lowp sampler2D samplerFront;","uniform highp vec2 srcStart;","uniform highp vec2 pixelSize;","uniform highp vec2 tileSize;","uniform highp vec2 tileSpacing;","void main(void) {","\thighp vec2 tile = floor(vTex);","\thighp vec2 tex = fract(vTex);","\thighp vec2 tileOrigin = srcStart + tile * (tileSize + tileSpacing);","\thighp vec2 lowerBound = tileOrigin + pixelSize / 2.0;","\thighp vec2 upperBound = tileOrigin + tileSize - pixelSize / 2.0;","\tgl_FragColor = texture2D(samplerFront, clamp(tex, lowerBound, upperBound), -16.0) * vColor;","}"].join("\n")}static GetTilemapFragmentShaderSource_WebGL1_FragDepthEXT(){return["#extension GL_EXT_frag_depth : enable","varying highp vec2 vTex;","varying lowp vec4 vColor;","uniform lowp sampler2D samplerFront;","uniform highp vec2 srcStart;","uniform highp vec2 pixelSize;","uniform highp vec2 tileSize;","uniform highp vec2 tileSpacing;","void main(void) {","\thighp vec2 tile = floor(vTex);","\thighp vec2 tex = fract(vTex);","\thighp vec2 tileOrigin = srcStart + tile * (tileSize + tileSpacing);","\thighp vec2 lowerBound = tileOrigin + pixelSize / 2.0;","\thighp vec2 upperBound = tileOrigin + tileSize - pixelSize / 2.0;","\tgl_FragColor = texture2D(samplerFront, clamp(tex, lowerBound, upperBound), -16.0) * vColor;","\tgl_FragDepthEXT = (gl_FragColor.a == 0.0 ? 1.0 : gl_FragCoord.z);","}"].join("\n")}static GetTilemapFragmentShaderSource_WebGL2(e){return["#version 300 es",yu.Gfx.WebGLShaderProgram._GetConservativeDepthShaderPrefix(e),"in highp vec2 vTex;","out lowp vec4 outColor;","in lowp vec4 vColor;","uniform lowp sampler2D samplerFront;","uniform highp vec2 srcStart;","uniform highp vec2 pixelSize;","uniform highp vec2 tileSize;","uniform highp vec2 tileSpacing;","void main(void) {","\thighp vec2 tile = floor(vTex);","\thighp vec2 tex = fract(vTex);","\thighp vec2 tileOrigin = srcStart + tile * (tileSize + tileSpacing);","\thighp vec2 lowerBound = tileOrigin + pixelSize / 2.0;","\thighp vec2 upperBound = tileOrigin + tileSize - pixelSize / 2.0;","\toutColor = texture(samplerFront, clamp(tex, lowerBound, upperBound), -16.0) * vColor;","\tgl_FragDepth = (outColor.a == 0.0 ? 1.0 : gl_FragCoord.z);","}"].join("\n")}static GetTileRandomizationFragmentShaderSource(e,t,s,i){let r="";return e>=2?r="#version 300 es\n"+yu.Gfx.WebGLShaderProgram._GetConservativeDepthShaderPrefix(i):(t&&(r="#extension GL_EXT_frag_depth : enable\n"),s&&(r+="#extension GL_EXT_shader_texture_lod : enable\n",r+="#extension GL_OES_standard_derivatives : enable\n")),r+`\nprecision highp float;\n${e>=2?"in":"varying"} vec2 vTex;\n${e>=2?"out lowp vec4 outColor;":""}\n${e>=2?"in":"varying"} lowp vec4 vColor;\nuniform lowp sampler2D samplerFront;\nuniform vec2 pixelSize;\n\nuniform vec2 tileSize;\nuniform vec2 tileSpacing;\nuniform float outlineThickness;\n\nconst float PI = 3.1415926;\n\nlowp vec4 cospVec4(lowp vec4 a, lowp vec4 b, float x)\n{\n\treturn (a + b + (a - b) * cos(x * PI)) / 2.0;\n}\n\nvec3 randVec3(vec2 seed)\n{\n\treturn vec3(fract(sin(dot(seed.xy + vec2(0.1, 0.1), vec2(12.9898,78.233))) * 43758.5453),\n\t\t\t\tfract(sin(dot(seed.yx + vec2(0.1, 0.1), vec2(12.9898,-78.233))) * 43758.5453),\n\t\t\t\tfract(sin(dot(seed.xy + vec2(0.1, 0.1), vec2(-12.9898,-78.233))) * 43758.5453));\n}\n\nlowp vec4 sampleTile(vec2 tile, vec2 uv, vec2 ddx, vec2 ddy)\n{\n\tvec2 posRandom = tileSize;\n\tfloat angleRandom = outlineThickness;\n\t\n\tvec3 rand = (randVec3(floor(tile + 0.5)) - 0.5) * 2.0;\n\t\n\tfloat angle = angleRandom * rand.z * PI;\n\tfloat sin_a = sin(angle);\n\tfloat cos_a = cos(angle);\n\tfloat aspect = pixelSize.x / pixelSize.y;\n\n\tvec2 mid = tile + vec2(0.5, 0.5);\n\tvec2 dp = uv - mid;\n\tdp.x /= aspect;\n\tvec2 r = vec2(dp.x * cos_a - dp.y * sin_a,\n\t\t\t\t  dp.y * cos_a + dp.x * sin_a);\n\tr.x *= aspect;\n\n\tvec2 p = mid + r + (posRandom * rand.xy / 2.0);\n\t\n\t${e>=2?"return textureGrad(samplerFront, p, ddx, ddy);":""}\n\t${e<2&&s?"return texture2DGradEXT(samplerFront, p, ddx, ddy);":""}\n\t${e<2&&!s?"return texture2D(samplerFront, p);":""}\n}\n\nvoid main(void) {\n\t\n\t${e<2?"lowp vec4 outColor;":""}\n\t\n\tfloat blendMarginX = tileSpacing.x;\n\tfloat blendMarginY = tileSpacing.y;\n\t\n\tvec2 tile = floor(vTex);\n\tvec2 tex = fract(vTex);\n\tvec2 ddx = ${e>=2||s?"dFdx(vTex)":"vec2(0.0, 0.0)"};\n\tvec2 ddy = ${e>=2||s?"dFdy(vTex)":"vec2(0.0, 0.0)"};\n\t\n\tvec4 curTile = sampleTile(tile, vTex, ddx, ddy);\n\t\n\tbool inLeftMargin = (tex.x < blendMarginX);\n\tbool inRightMargin = (tex.x > 1.0 - blendMarginX);\n\tbool inTopMargin = (tex.y < blendMarginY);\n\tbool inBottomMargin = (tex.y > 1.0 - blendMarginY);\n\t\n\tif (inLeftMargin)\n\t{\n\t\tlowp vec4 leftTile = sampleTile(tile + vec2(-1.0, 0.0), vTex, ddx, ddy);\n\t\tfloat leftMix = (tex.x / (blendMarginX * 2.0)) + 0.5;\n\t\tlowp vec4 leftMixedTile = cospVec4(leftTile, curTile, leftMix);\n\t\t\n\t\tif (inTopMargin)\n\t\t{\n\t\t\tlowp vec4 topTile =     sampleTile(tile + vec2(0.0,  -1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 topLeftTile = sampleTile(tile + vec2(-1.0, -1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 topLeftMixedTile = cospVec4(topLeftTile, topTile, leftMix);\n\t\t\t\n\t\t\toutColor = cospVec4(topLeftMixedTile, leftMixedTile, (tex.y / (blendMarginY * 2.0)) + 0.5);\n\t\t}\n\t\telse if (inBottomMargin)\n\t\t{\n\t\t\tlowp vec4 bottomTile =     sampleTile(tile + vec2(0.0,  1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 bottomLeftTile = sampleTile(tile + vec2(-1.0, 1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 bottomLeftMixedTile = cospVec4(bottomLeftTile, bottomTile, leftMix);\n\t\t\t\n\t\t\toutColor = cospVec4(leftMixedTile, bottomLeftMixedTile, (tex.y - (1.0 - blendMarginY)) / (blendMarginY * 2.0));\n\t\t}\n\t\telse\n\t\t{\n\t\t\toutColor = leftMixedTile;\n\t\t}\n\t}\n\telse if (inRightMargin)\n\t{\n\t\tlowp vec4 rightTile = sampleTile(tile + vec2(1.0, 0.0), vTex, ddx, ddy);\n\t\tfloat rightMix = (tex.x - (1.0 - blendMarginX)) / (blendMarginX * 2.0);\n\t\tlowp vec4 rightMixedTile = cospVec4(curTile, rightTile, rightMix);\n\t\t\n\t\tif (inTopMargin)\n\t\t{\n\t\t\tlowp vec4 topTile =      sampleTile(tile + vec2(0.0, -1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 topRightTile = sampleTile(tile + vec2(1.0, -1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 topRightMixedTile = cospVec4(topTile, topRightTile, rightMix);\n\t\t\t\n\t\t\toutColor = cospVec4(topRightMixedTile, rightMixedTile, (tex.y / (blendMarginY * 2.0)) + 0.5);\n\t\t}\n\t\telse if (inBottomMargin)\n\t\t{\n\t\t\tlowp vec4 bottomTile =      sampleTile(tile + vec2(0.0, 1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 bottomRightTile = sampleTile(tile + vec2(1.0, 1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 bottomRightMixedTile = cospVec4(bottomTile, bottomRightTile, rightMix);\n\t\t\t\n\t\t\toutColor = cospVec4(rightMixedTile, bottomRightMixedTile, (tex.y - (1.0 - blendMarginY)) / (blendMarginY * 2.0));\n\t\t}\n\t\telse\n\t\t{\n\t\t\toutColor = rightMixedTile;\n\t\t}\n\t}\n\telse if (inTopMargin)\n\t{\n\t\tlowp vec4 topTile = sampleTile(tile + vec2(0.0, -1.0), vTex, ddx, ddy);\n\t\toutColor = cospVec4(topTile, curTile, (tex.y / (blendMarginY * 2.0)) + 0.5);\n\t}\n\telse if (inBottomMargin)\n\t{\n\t\tlowp vec4 bottomTile = sampleTile(tile + vec2(0.0, 1.0), vTex, ddx, ddy);\n\t\toutColor = cospVec4(curTile, bottomTile, (tex.y - (1.0 - blendMarginY)) / (blendMarginY * 2.0));\n\t}\n\telse\n\t{\n\t\toutColor = curTile;\n\t}\n\t\n\toutColor *= vColor;\n\t${e<2?"gl_FragColor = outColor;":""}\n\t${e>=2?"gl_FragDepth = (outColor.a == 0.0 ? 1.0 : gl_FragCoord.z);":""}\n\t${e<2&&t?"gl_FragDepthEXT = (outColor.a == 0.0 ? 1.0 : gl_FragCoord.z);":""}\n}\n`}static GetPointVertexShaderSource_WebGL1(){return["attribute vec4 aPoints;","varying float pointOpacity;","uniform float zElevation;","uniform mat4 matP;","uniform mat4 matMV;","void main(void) {","\tgl_Position = matP * matMV * vec4(aPoints.xy, zElevation, 1.0);","\tgl_PointSize = aPoints.z;","\tpointOpacity = aPoints.w;","}"].join("\n")}static GetPointVertexShaderSource_WebGL2(){return["#version 300 es","in vec4 aPoints;","out float pointOpacity;","uniform float zElevation;","uniform mat4 matP;","uniform mat4 matMV;","void main(void) {","\tgl_Position = matP * matMV * vec4(aPoints.xy, zElevation, 1.0);","\tgl_PointSize = aPoints.z;","\tpointOpacity = aPoints.w;","}"].join("\n")}static GetPointFragmentShaderSource_WebGL1_NoFragDepth(){return["uniform lowp sampler2D samplerFront;","varying lowp float pointOpacity;","uniform mediump vec2 pointTexStart;","uniform mediump vec2 pointTexEnd;","uniform lowp vec4 color;","void main(void) {","\tmediump vec2 pointTexMin = min(pointTexStart, pointTexEnd);","\tmediump vec2 pointTexMax = max(pointTexStart, pointTexEnd);","\tmediump vec2 pointCoord = (pointTexEnd.x > pointTexStart.x ? gl_PointCoord : vec2(1.0 - gl_PointCoord.y, gl_PointCoord.x));","\tgl_FragColor = texture2D(samplerFront, mix(pointTexMin, pointTexMax, pointCoord)) * color * pointOpacity;","}"].join("\n")}static GetPointFragmentShaderSource_WebGL1_FragDepthEXT(){return["#extension GL_EXT_frag_depth : enable","uniform lowp sampler2D samplerFront;","varying lowp float pointOpacity;","uniform mediump vec2 pointTexStart;","uniform mediump vec2 pointTexEnd;","uniform lowp vec4 color;","void main(void) {","\tmediump vec2 pointTexMin = min(pointTexStart, pointTexEnd);","\tmediump vec2 pointTexMax = max(pointTexStart, pointTexEnd);","\tmediump vec2 pointCoord = (pointTexEnd.x > pointTexStart.x ? gl_PointCoord : vec2(1.0 - gl_PointCoord.y, gl_PointCoord.x));","\tgl_FragColor = texture2D(samplerFront, mix(pointTexMin, pointTexMax, pointCoord)) * color * pointOpacity;","\tgl_FragDepthEXT = (gl_FragColor.a == 0.0 ? 1.0 : gl_FragCoord.z);","}"].join("\n")}static GetPointFragmentShaderSource_WebGL2(e){return["#version 300 es",yu.Gfx.WebGLShaderProgram._GetConservativeDepthShaderPrefix(e),"uniform lowp sampler2D samplerFront;","in lowp float pointOpacity;","uniform mediump vec2 pointTexStart;","uniform mediump vec2 pointTexEnd;","uniform lowp vec4 color;","out lowp vec4 outColor;","void main(void) {","\tmediump vec2 pointTexMin = min(pointTexStart, pointTexEnd);","\tmediump vec2 pointTexMax = max(pointTexStart, pointTexEnd);","\tmediump vec2 pointCoord = (pointTexEnd.x > pointTexStart.x ? gl_PointCoord : vec2(1.0 - gl_PointCoord.y, gl_PointCoord.x));","\toutColor = texture(samplerFront, mix(pointTexMin, pointTexMax, pointCoord)) * color * pointOpacity;","\tgl_FragDepth = (outColor.a == 0.0 ? 1.0 : gl_FragCoord.z);","}"].join("\n")}static GetColorFillFragmentShaderSource(){return["varying lowp vec4 vColor;","void main(void) {","\tgl_FragColor = vColor;","}"].join("\n")}static GetLinearGradientFillFragmentShaderSource(){return["precision lowp float;","varying mediump vec2 vTex;","varying vec4 vColor;","uniform vec4 color2_;","vec3 fromLinear(vec3 linearRGB)","{","\tbvec3 cutoff = lessThan(linearRGB, vec3(0.0031308));","\tvec3 higher = vec3(1.055) * pow(abs(linearRGB), vec3(1.0/2.4)) - vec3(0.055);","\tvec3 lower = linearRGB * vec3(12.92);","\treturn mix(higher, lower, vec3(cutoff));","}","vec3 toLinear(vec3 sRGB)","{","\tbvec3 cutoff = lessThan(sRGB, vec3(0.04045));","\tvec3 higher = pow(abs((sRGB + vec3(0.055))/vec3(1.055)), vec3(2.4));","\tvec3 lower = sRGB/vec3(12.92);","\treturn mix(higher, lower, vec3(cutoff));","}","void main(void) {","\tvec3 linearGrad = mix(toLinear(vColor.rgb), toLinear(color2_.rgb), vTex.x);","\tfloat a = mix(vColor.a, color2_.a, vTex.x);","\tgl_FragColor = vec4(fromLinear(linearGrad) * a, a);","}"].join("\n")}static GetPenumbraFillFragmentShaderSource(){return["precision lowp float;","varying highp vec2 vTex;","varying vec4 vColor;","void main(void) {","\thighp float grad = vTex.x / (1.0 - vTex.y);","\tgl_FragColor = vColor * (1.0 - (cos(grad * 3.141592653589793) + 1.0) / 2.0);","}"].join("\n")}static GetSmoothLineFillFragmentShaderSource(){return["varying mediump vec2 vTex;","varying lowp vec4 vColor;","void main(void) {","\tlowp float f = 1.0 - abs(vTex.y - 0.5) * 2.0;","\tgl_FragColor = vColor * f;","}"].join("\n")}static GetHardEllipseFillFragmentShaderSource(){return["varying highp vec2 vTex;","varying lowp vec4 vColor;","void main(void) {","\thighp vec2 diff = vTex - vec2(0.5, 0.5);","\thighp vec2 diffSq = diff * diff;","\thighp float f = step(diffSq.x + diffSq.y, 0.25);","\tgl_FragColor = vColor * f;","}"].join("\n")}static GetHardEllipseOutlineFragmentShaderSource(){return["varying highp vec2 vTex;","varying lowp vec4 vColor;","uniform highp vec2 pixelSize;","uniform highp float outlineThickness;","void main(void) {","\thighp vec2 diff = vTex - vec2(0.5, 0.5);","\thighp vec2 diffSq = diff * diff;","\thighp float distSq = diffSq.x + diffSq.y;","\thighp vec2 norm = normalize(diff);","\thighp vec2 halfNorm = norm * 0.5;","\thighp float innerF = step(distSq, 0.25);","\thighp vec2 innerEdge = halfNorm - pixelSize * norm * outlineThickness;","\thighp vec2 innerEdgeSq = innerEdge * innerEdge;","\thighp float outerF = step(innerEdgeSq.x + innerEdgeSq.y, distSq);","\tgl_FragColor = vColor * innerF * outerF;","}"].join("\n")}static GetSmoothEllipseFillFragmentShaderSource(){return["varying highp vec2 vTex;","varying lowp vec4 vColor;","uniform highp vec2 pixelSize;","void main(void) {","\thighp vec2 diff = vTex - vec2(0.5, 0.5);","\thighp vec2 diffSq = diff * diff;","\thighp vec2 norm = normalize(diff);","\thighp vec2 halfNorm = norm * 0.5;","\thighp vec2 halfNormSq = halfNorm * halfNorm;","\thighp vec2 innerEdge = halfNorm - pixelSize * norm;","\thighp vec2 innerEdgeSq = innerEdge * innerEdge;","\thighp float f = smoothstep(halfNormSq.x + halfNormSq.y, innerEdgeSq.x + innerEdgeSq.y, diffSq.x + diffSq.y);","\tgl_FragColor = vColor * f;","}"].join("\n")}static GetSmoothEllipseOutlineFragmentShaderSource(){return["varying highp vec2 vTex;","varying lowp vec4 vColor;","uniform highp vec2 pixelSize;","uniform highp float outlineThickness;","void main(void) {","\thighp vec2 diff = vTex - vec2(0.5, 0.5);","\thighp vec2 diffSq = diff * diff;","\thighp float distSq = diffSq.x + diffSq.y;","\thighp vec2 norm = normalize(diff);","\thighp vec2 halfNorm = norm * 0.5;","\thighp vec2 halfNormSq = halfNorm * halfNorm;","\thighp vec2 pxNorm = pixelSize * norm;","\thighp vec2 innerEdge1 = halfNorm - pxNorm;","\thighp vec2 innerEdge1Sq = innerEdge1 * innerEdge1;","\thighp float innerF = smoothstep(halfNormSq.x + halfNormSq.y, innerEdge1Sq.x + innerEdge1Sq.y, distSq);","\thighp vec2 innerEdge2 = halfNorm - pxNorm * outlineThickness;","\thighp vec2 innerEdge2Sq = innerEdge2 * innerEdge2;","\thighp vec2 innerEdge3 = halfNorm - pxNorm * (outlineThickness + 1.0);","\thighp vec2 innerEdge3Sq = innerEdge3 * innerEdge3;","\thighp float outerF = smoothstep(innerEdge3Sq.x + innerEdge3Sq.y, innerEdge2Sq.x + innerEdge2Sq.y, distSq);","\tgl_FragColor = vColor * innerF * outerF;","}"].join("\n")}}}{const Gu=self.C3,Iu=self.glMatrix,vu=Iu.mat4,Cu=new Map([["float",1],["percent",1],["sampler",1],["vec2",2],["vec3",3],["color",3],["vec4",4],["mat4",16]]);Gu.Gfx.WebGLShaderUniform=class{constructor(e,t,s){if(!Cu.has(s))throw new Error("invalid uniform type");this._owner=e,this._gl=this._owner.GetWebGLContext(),this._name=t,this._type=s,this._isColorType="color"===this._type,this._location=this._gl.getUniformLocation(this._owner.GetShaderProgram(),t),this._isUsed=!!this._location;const i=Cu.get(s);this._lastValue=new Float32Array(i),this._lastBatchValue=new Float32Array(i)}Release(){this._owner=null,this._gl=null,this._location=null}IsUsed(){return this._isUsed}GetType(){return this._type}IsColorType(){return this._isColorType}Init1f(e){this.IsUsed()&&(this._lastValue[0]=e,this._lastBatchValue.set(this._lastValue),this._gl.uniform1f(this._location,e))}Init1i(e){this.IsUsed()&&(this._lastValue[0]=e,this._lastBatchValue.set(this._lastValue),this._gl.uniform1i(this._location,e))}Init2f(e,t){this.IsUsed()&&(this._lastValue[0]=e,this._lastValue[1]=t,this._lastBatchValue.set(this._lastValue),this._gl.uniform2f(this._location,e,t))}Init3f(e,t,s){this.IsUsed()&&(this._lastValue[0]=e,this._lastValue[1]=t,this._lastValue[2]=s,this._lastBatchValue.set(this._lastValue),this._gl.uniform3f(this._location,e,t,s))}Init4f(e,t,s,i){this.IsUsed()&&(this._lastValue[0]=e,this._lastValue[1]=t,this._lastValue[2]=s,this._lastValue[3]=i,this._lastBatchValue.set(this._lastValue),this._gl.uniform4f(this._location,e,t,s,i))}Update1f(e){e=Math.fround(e);const t=this._lastValue;t[0]!==e&&(t[0]=e,this._gl.uniform1f(this._location,e))}Update1i(e){const t=this._lastValue;t[0]!==e&&(t[0]=e,this._gl.uniform1i(this._location,e))}Update2f(e,t){e=Math.fround(e),t=Math.fround(t);const s=this._lastValue;s[0]===e&&s[1]===t||(s[0]=e,s[1]=t,this._gl.uniform2f(this._location,e,t))}Update3f(e,t,s){e=Math.fround(e),t=Math.fround(t),s=Math.fround(s);const i=this._lastValue;i[0]===e&&i[1]===t&&i[2]===s||(i[0]=e,i[1]=t,i[2]=s,this._gl.uniform3f(this._location,e,t,s))}Update4f(e,t,s,i){e=Math.fround(e),t=Math.fround(t),s=Math.fround(s),i=Math.fround(i);const r=this._lastValue;r[0]===e&&r[1]===t&&r[2]===s&&r[3]===i||(r[0]=e,r[1]=t,r[2]=s,r[3]=i,this._gl.uniform4f(this._location,e,t,s,i))}UpdateMatrix4fv(e){const t=this._lastValue;vu.exactEquals(t,e)||(Gu.typedArraySet16(t,e,0),this._gl.uniformMatrix4fv(this._location,!1,e))}IsSetToCustomInBatch(e){const t=this._lastBatchValue;return this.IsColorType()?t[0]===Math.fround(e.getR())&&t[1]===Math.fround(e.getG())&&t[2]===Math.fround(e.getB()):t[0]===Math.fround(e)}SetBatchValueCustom(e){const t=this._lastBatchValue;this.IsColorType()?(t[0]=e.getR(),t[1]=e.getG(),t[2]=e.getB()):t[0]=e}IsSetTo1InBatch(e){return this._lastBatchValue[0]===Math.fround(e)}IsSetTo2InBatch(e,t){const s=this._lastBatchValue;return s[0]===Math.fround(e)&&s[1]===Math.fround(t)}SetBatch1(e){this._lastBatchValue[0]=e}SetBatch2(e,t){const s=this._lastBatchValue;s[0]=e,s[1]=t}}}{const wu=self.C3,Au=self.glMatrix,Ru=Au.vec4,Pu=Au.mat4,Mu=0,Eu=1,Du=2,Nu=3,Fu=4,Ou=5,Bu=6,Lu=7,ku=8,Vu=9,Uu=10,Wu=11,Hu=12,zu=13,ju=14,Yu=15,qu=16,Xu=17,$u=18,Ku=19,Ju=20,Qu=21,Zu=22,ec=23,tc=24,sc=25,ic=26,rc=27,nc=28,ac=29,oc=30;wu.Gfx.BatchState=class{constructor(e){this.renderer=e,this.currentMV=Pu.create(),this.currentMatP=Pu.create(),this.currentFramebuffer=null,this.currentFramebufferNoDepth=null,this.isDepthSamplingEnabled=!1,this.currentShader=null,this.pointTexCoords=new wu.Rect,this.clearColor=wu.New(wu.Color,0,0,0,0)}},wu.Gfx.WebGLBatchJob=class{constructor(e){const t=new ArrayBuffer(96);this._type=0,this._batchState=e,this._gl=e.renderer.GetContext(),this._startIndex=0,this._indexCount=0,this._texParam=null,this._mat4param=new Float32Array(t,0,16),this._colorParam=new Float32Array(t,64,4),this._srcOriginRect=new Float32Array(t,80,4),this._shaderParams=[]}InitDraw(e,t){this._type=1,this._startIndex=e,this._indexCount=t}DoDraw(){const e=this._gl;e.drawElements(e.TRIANGLES,this._indexCount,e.UNSIGNED_SHORT,this._startIndex)}InitSetTexture(e){this._type=2,this._texParam=e}DoSetTexture(){const e=this._gl,t=this._texParam;e.bindTexture(e.TEXTURE_2D,t?t._GetTexture():null)}InitSetGradientColor(e){this._type=20,e.writeToTypedArray(this._colorParam,0)}DoSetGradientColor(){const e=this._colorParam,t=this._batchState.currentShader;t._uColor2.IsUsed()&&t._uColor2.Update4f(e[0],e[1],e[2],e[3])}InitSetBlend(e,t){this._type=3,this._startIndex=e,this._indexCount=t}DoSetBlend(){this._gl.blendFunc(this._startIndex,this._indexCount)}InitSetViewport(e,t,s,i){this._type=4;const r=this._colorParam;r[0]=e,r[1]=t,r[2]=s,r[3]=i}DoSetViewport(){const e=this._colorParam;this._gl.viewport(e[0],e[1],e[2],e[3])}InitSetProjection(e){this._type=5,Pu.copy(this._mat4param,e)}DoSetProjection(){const e=this._batchState,t=e.renderer._allShaderPrograms,s=e.currentShader,i=this._mat4param;for(let e=0,r=t.length;e<r;++e){const r=t[e];r===s?r.UpdateMatP(i,!0):r.SetMatPStale()}Pu.copy(e.currentMatP,i)}InitSetModelView(e){this._type=6,Pu.copy(this._mat4param,e)}DoSetModelView(){const e=this._batchState,t=e.renderer._allShaderPrograms,s=e.currentShader,i=this._mat4param;for(let e=0,r=t.length;e<r;++e){const r=t[e];r===s?r.UpdateMatMV(i,!0):r.SetMatMVStale()}Pu.copy(e.currentMV,i)}InitSetRenderTarget(e){this._type=7,this._texParam=e}DoSetRenderTarget(){const e=this._gl,t=this._texParam,s=this._batchState;t?(s.currentFramebuffer=t._GetFramebuffer(),s.currentFramebufferNoDepth=t._GetFramebufferNoDepth(),s.isDepthSamplingEnabled&&s.currentFramebufferNoDepth?e.bindFramebuffer(e.FRAMEBUFFER,s.currentFramebufferNoDepth):e.bindFramebuffer(e.FRAMEBUFFER,s.currentFramebuffer)):(s.currentFramebuffer=null,s.currentFramebufferNoDepth=null,e.bindFramebuffer(e.FRAMEBUFFER,null))}InitClearSurface(e){this._type=8,e.writeToTypedArray(this._mat4param,0)}InitClearSurface2(e,t,s,i){this._type=8;const r=this._mat4param;r[0]=e,r[1]=t,r[2]=s,r[3]=i}DoClearSurface(){const e=this._gl,t=this._mat4param,s=this._batchState.clearColor,i=t[0],r=t[1],n=t[2],a=t[3];s.equalsRgba(i,r,n,a)||(e.clearColor(i,r,n,a),s.setRgba(i,r,n,a)),e.clear(e.COLOR_BUFFER_BIT)}InitSetPointTexCoords(e){this._type=14,e.writeToTypedArray(this._mat4param,0)}DoSetPointTextureCoords(){const e=this._mat4param;this._batchState.pointTexCoords.set(e[0],e[1],e[2],e[3])}InitPoints(e,t,s){this._type=9,this._startIndex=e,this._indexCount=1,this._mat4param[0]=t,s.writeToTypedArray(this._colorParam,0)}DoPoints(){const e=this._gl,t=this._batchState,s=t.renderer._spPoints;e.useProgram(s._shaderProgram),s.UpdateMatP(t.currentMatP,!1),s.UpdateMatMV(t.currentMV,!1);const i=t.pointTexCoords;s._uPointTexStart.IsUsed()&&s._uPointTexStart.Update2f(i.getLeft(),i.getTop()),s._uPointTexEnd.IsUsed()&&s._uPointTexEnd.Update2f(i.getRight(),i.getBottom());const r=this._mat4param[0];if(s._uZElevation.IsUsed()&&s._uZElevation.Update1f(r),s._uColor.IsUsed()){const e=this._colorParam;s._uColor.Update4f(e[0],e[1],e[2],e[3])}e.drawArrays(e.POINTS,this._startIndex/4,this._indexCount),e.useProgram(t.currentShader._shaderProgram)}InitSetProgram(e){this._type=10,this._texParam=e}DoSetProgram(){const e=this._gl,t=this._batchState,s=this._texParam;t.currentShader=s,e.useProgram(s._shaderProgram),s.UpdateMatP(t.currentMatP,!1),s.UpdateMatMV(t.currentMV,!1)}InitSetProgramParameters(){this._type=11}DoSetProgramParameters(){const e=this._batchState.currentShader,t=this._gl,s=this._mat4param,i=this._colorParam,r=this._srcOriginRect;if(e._uSamplerBack.IsUsed()){const e=this._batchState.renderer,s=this._texParam;e._lastTexture1!==s&&(t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,s?s._GetTexture():null),e._lastTexture1=s,t.activeTexture(t.TEXTURE0))}e._uPixelSize.IsUsed()&&e._uPixelSize.Update2f(s[0],s[1]),e._uDestStart.IsUsed()&&e._uDestStart.Update2f(s[2],s[3]),e._uDestEnd.IsUsed()&&e._uDestEnd.Update2f(s[4],s[5]),e._uDevicePixelRatio.IsUsed()&&e._uDevicePixelRatio.Update1f(this._indexCount),e._uLayerScale.IsUsed()&&e._uLayerScale.Update1f(s[6]),e._uLayerAngle.IsUsed()&&e._uLayerAngle.Update1f(s[7]),e._uSrcStart.IsUsed()&&e._uSrcStart.Update2f(s[12],s[13]),e._uSrcEnd.IsUsed()&&e._uSrcEnd.Update2f(s[14],s[15]),e._uSrcOriginStart.IsUsed()&&e._uSrcOriginStart.Update2f(r[0],r[1]),e._uSrcOriginEnd.IsUsed()&&e._uSrcOriginEnd.Update2f(r[2],r[3]),e._uLayoutStart.IsUsed()&&e._uLayoutStart.Update2f(i[0],i[1]),e._uLayoutEnd.IsUsed()&&e._uLayoutEnd.Update2f(i[2],i[3]),e._uSeconds.IsUsed()&&e._uSeconds.Update1f(this._startIndex)}InitSetProgramCustomParameters(){this._type=12}DoSetProgramCustomParameters(){const e=this._batchState.currentShader._uCustomParameters,t=this._shaderParams;for(let s=0,i=e.length;s<i;++s){const i=e[s],r=t[s];i.IsColorType()?i.Update3f(r.getR(),r.getG(),r.getB()):i.Update1f(r)}}InitInvalidateFramebuffer(e){this._type=13,this._texParam=e}DoInvalidateFramebuffer(){const e=this._gl,t=this._texParam,s=this._batchState.currentFramebuffer;t!==s&&e.bindFramebuffer(e.FRAMEBUFFER,t),e.invalidateFramebuffer(e.FRAMEBUFFER,[e.COLOR_ATTACHMENT0]),t!==s&&e.bindFramebuffer(e.FRAMEBUFFER,s)}InitBlitFramebuffer(e,t,s){this._type=16;const i=this._mat4param,r=this._batchState.renderer;i[0]=e.GetWidth(),i[1]=e.GetHeight(),i[2]=t?t.GetWidth():r.GetWidth(),i[3]=t?t.GetHeight():r.GetHeight(),i[4]=e.IsLinearSampling()?1:0,i[5]="stretch"===s;const n=this._shaderParams;wu.clearArray(n),n.push(e._GetFramebuffer()),n.push(t?t._GetFramebuffer():null)}DoBlitFramebuffer(){const e=this._mat4param,t=this._shaderParams,s=this._gl,i=e[0],r=e[1],n=e[2],a=e[3],o=0!==e[4],l=0!==e[5],h=t[0],u=t[1];if(s.bindFramebuffer(s.READ_FRAMEBUFFER,h),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,u),l)s.blitFramebuffer(0,0,i,r,0,0,n,a,s.COLOR_BUFFER_BIT,o?s.LINEAR:s.NEAREST);else{const e=Math.min(i,n),t=Math.min(r,a),o=Math.max(r-a,0),l=Math.max(a-r,0);s.blitFramebuffer(0,o,e,t+o,0,l,e,t+l,s.COLOR_BUFFER_BIT,s.NEAREST)}}InitStartQuery(e){this._type=17,this._texParam=e}DoStartQuery(){this._texParam.BeginTimeElapsed(),this._texParam=null}InitEndQuery(e){this._type=18,this._texParam=e}DoEndQuery(){this._texParam.EndTimeElapsed(),this._texParam=null}InitSetEllipseParams(e,t,s){this._type=19;const i=this._mat4param;i[0]=e,i[1]=t,i[2]=s}DoSetEllipseParams(){const e=this._batchState.currentShader,t=this._mat4param;e._uPixelSize.IsUsed()&&e._uPixelSize.Update2f(t[0],t[1]),e._uOutlineThickness.IsUsed()&&e._uOutlineThickness.Update1f(t[2])}InitSetTilemapInfo(e,t,s,i,r,n,a){this._type=15;const o=this._mat4param;e.writeToTypedArray(o,0),o[4]=1/t,o[5]=1/s,o[6]=i/t,o[7]=r/s,o[8]=n/t,o[9]=a/s}DoSetTilemapInfo(){const e=this._batchState.currentShader,t=this._mat4param;e._uSrcStart.IsUsed()&&e._uSrcStart.Update2f(t[0],t[1]),e._uPixelSize.IsUsed()&&e._uPixelSize.Update2f(t[4],t[5]),e._uTileSize.IsUsed()&&e._uTileSize.Update2f(t[6],t[7]),e._uTileSpacing.IsUsed()&&e._uTileSpacing.Update2f(t[8],t[9])}InitSetTileRandomizationInfo(e,t,s,i,r,n,a){this._type=28;const o=this._mat4param;o[0]=1/e,o[1]=1/t,o[2]=s,o[3]=i,o[4]=r,o[5]=n,o[6]=a}DoSetTileRandomizationInfo(){const e=this._batchState.currentShader,t=this._mat4param;e._uPixelSize.IsUsed()&&e._uPixelSize.Update2f(t[0],t[1]),e._uTileSize.IsUsed()&&e._uTileSize.Update2f(t[2],t[3]),e._uOutlineThickness.IsUsed()&&e._uOutlineThickness.Update1f(t[4]),e._uTileSpacing.IsUsed()&&e._uTileSpacing.Update2f(t[5],t[6])}InitClearDepth(e){this._type=21,this._startIndex=e?1:0}DoClearDepth(){const e=this._gl,t=0!==this._startIndex;t||e.depthMask(!0),e.clear(e.DEPTH_BUFFER_BIT),t||e.depthMask(!1)}InitSetDepthEnabled(e){this._type=22,this._startIndex=e?1:0}DoSetDepthEnabled(){const e=this._gl;0===this._startIndex?(e.disable(e.DEPTH_TEST),e.depthMask(!1)):(e.enable(e.DEPTH_TEST),e.depthMask(!0))}InitSetDepthSamplingEnabled(e){this._type=23,this._startIndex=e?1:0}DoSetDepthSamplingEnabled(){const e=this._gl,t=this._batchState,s=t.renderer,i=0!==this._startIndex;t.isDepthSamplingEnabled=i,e.activeTexture(e.TEXTURE2),i?(t.currentFramebufferNoDepth&&e.bindFramebuffer(e.FRAMEBUFFER,t.currentFramebufferNoDepth),e.bindTexture(e.TEXTURE_2D,s._GetDepthBuffer())):(e.bindTexture(e.TEXTURE_2D,null),t.currentFramebufferNoDepth&&e.bindFramebuffer(e.FRAMEBUFFER,t.currentFramebuffer)),e.activeTexture(e.TEXTURE0)}InitCoplanarStartStencilPass(){this._type=24}DoCoplanarStartStencilPass(){const e=this._gl;e.clear(e.STENCIL_BUFFER_BIT),e.enable(e.STENCIL_TEST),e.stencilFunc(e.ALWAYS,1,1),e.stencilOp(e.KEEP,e.KEEP,e.REPLACE),e.colorMask(!1,!1,!1,!1)}InitCoplanarStartColorPass(){this._type=25}DoCoplanarStartColorPass(){const e=this._gl;e.enable(e.STENCIL_TEST),e.colorMask(!0,!0,!0,!0),e.stencilFunc(e.EQUAL,1,1),e.stencilOp(e.KEEP,e.KEEP,e.KEEP)}InitCoplanarRestore(){this._type=26}DoCoplanarRestore(){const e=this._gl;e.disable(e.STENCIL_TEST)}InitSetScissor(e,t,s,i,r){this._type=27,this._startIndex=e?1:0;const n=this._mat4param;n[0]=t,n[1]=s,n[2]=i,n[3]=r}DoSetScissor(){const e=this._gl,t=this._mat4param;1===this._startIndex?(e.enable(e.SCISSOR_TEST),e.scissor(t[0],t[1],t[2],t[3])):e.disable(e.SCISSOR_TEST)}InitSetCullFaceMode(e){this._type=29,this._startIndex=e}DoSetCullFaceMode(){const e=this._gl,t=this._startIndex;0===t?e.disable(e.CULL_FACE):(e.enable(e.CULL_FACE),1===t?e.cullFace(e.BACK):e.cullFace(e.FRONT))}InitSetFrontFaceWinding(e){this._type=30,this._startIndex=e}DoSetFrontFaceWinding(){const e=this._gl;e.frontFace(0===this._startIndex?e.CW:e.CCW)}Run(){switch(this._type){case 1:return void this.DoDraw();case 2:return void this.DoSetTexture();case 3:return void this.DoSetBlend();case 4:return void this.DoSetViewport();case 5:return void this.DoSetProjection();case 6:return void this.DoSetModelView();case 7:return void this.DoSetRenderTarget();case 8:return void this.DoClearSurface();case 9:return void this.DoPoints();case 10:return void this.DoSetProgram();case 11:return void this.DoSetProgramParameters();case 12:return void this.DoSetProgramCustomParameters();case 13:return void this.DoInvalidateFramebuffer();case 14:return void this.DoSetPointTextureCoords();case 15:return void this.DoSetTilemapInfo();case 16:return void this.DoBlitFramebuffer();case 17:return void this.DoStartQuery();case 18:return void this.DoEndQuery();case 19:return void this.DoSetEllipseParams();case 20:return void this.DoSetGradientColor();case 21:return void this.DoClearDepth();case 22:return void this.DoSetDepthEnabled();case 23:return void this.DoSetDepthSamplingEnabled();case 24:return void this.DoCoplanarStartStencilPass();case 25:return void this.DoCoplanarStartColorPass();case 26:return void this.DoCoplanarRestore();case 27:return void this.DoSetScissor();case 28:return void this.DoSetTileRandomizationInfo();case 29:return void this.DoSetCullFaceMode();case 30:return void this.DoSetFrontFaceWinding()}}}}{let lc=function(e,t,s,i,r,n){t?e.strokeRect(s,i,r,n):e.fillRect(s,i,r,n)},hc=function(e){return e*(4/3)},uc=function(e,t){e=e.trim();const s=parseFloat(e);return isFinite(s)?e.endsWith("%")?t*s/100:s:0};fillOrStrokeRect=lc,ptToPx=hc,getOffsetParam=uc;const cc=self.C3,dc=4096,pc=4,_c=new Set(["serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]),mc={timeout:60},fc=new cc.Color(0,0,0,1),gc=new Set(["left","center","right"]),yc=new Set(["top","center","bottom"]),Sc=new Set(["word","cjk","character"]),Tc=new Set(["ltr","rtl"]),xc=new Set;cc.FontManager&&cc.FontManager.addEventListener("fontload",e=>{const t=e.font.GetName();for(const e of xc)(e.IsBBCodeEnabled()||cc.equalsNoCase(e.GetFontName(),t))&&e._SetWordWrapChanged()});let bc=!1,Gc=!1;cc.Gfx.RendererText=class{constructor(e,t){t=Object.assign({},mc,t),this._renderer=e,this._fontName="Arial",this._fontSize=16,this._fontSizeScale=1,this._lineHeight=0,this._isBold=!1,this._isItalic=!1,this._colorStr="black",this._isBBcodeEnabled=!1,this._iconSet=null,this._iconSmoothing=!0,this.onloadfont=null,this._alreadyLoadedFonts=new Set,this._horizontalAlign="left",this._verticalAlign="top",this._text="",this._bbString=null,this._wrappedText=cc.New(cc.WordWrap),this._wrapMode="word",this._textDirection="ltr",this._wordWrapChanged=!1,this._textLayoutChanged=!1,this._drawChanged=!1,this._drawMaxCharCount=-1,this._drawCharCount=0,this._cssWidth=0,this._cssHeight=0,this._width=0,this._height=0,this._zoom=1,this._textCanvas=null,this._textContext=null,this._measureContext=null,this._measureContextTop=null,this._lastCanvasWidth=-1,this._lastCanvasHeight=-1,this._lastTextCanvasFont="",this._lastMeasureCanvasFont="",this._lastTextCanvasFillStyle="",this._lastTextCanvasOpacity=1,this._lastTextCanvasLineWidth=1,this._measureTextCallback=e=>this._MeasureText(e),this._texture=null,this._rcTex=new cc.Rect,this._scaleFactor=1,this._textureTimeout=new cc.IdleTimeout(()=>{this.ReleaseTexture(),this._SetTextCanvasSize(8,8)},t.timeout),this.ontextureupdate=null,this._wasReleased=!1,xc.add(this)}Release(){this.onloadfont=null,this._alreadyLoadedFonts.clear(),this._iconSet=null,this._bbString=null,this._textCanvas=null,this._textContext=null,this._measureContext=null,this._measureContextTop=null,this._measureTextCallback=null,this._textureTimeout.Release(),this.ontextureupdate=null,this.ReleaseTexture(),this._wrappedText.Clear(),this._wrappedText=null,this._renderer=null,this._wasReleased=!0,xc.delete(this)}_SetDrawChanged(){this._drawChanged=!0}_SetTextLayoutChanged(){this._SetDrawChanged(),this._textLayoutChanged=!0}_SetWordWrapChanged(){this._SetTextLayoutChanged(),this._wordWrapChanged=!0}SetBBCodeEnabled(e){if(e=!!e,this._isBBcodeEnabled===e)return;this._isBBcodeEnabled=e;const t=this._isBBcodeEnabled?"alphabetic":"top";this._textContext&&(this._textContext.textBaseline=t),this._measureContext&&(this._measureContext.textBaseline=t),this._SetWordWrapChanged()}IsBBCodeEnabled(){return this._isBBcodeEnabled}SetIconSet(e){this._iconSet!==e&&(this._iconSet=e,this._wrappedText.SetIconSet(e),this._iconSet&&this._iconSet.IsLoading()&&this._iconSet.LoadContent().then(()=>this._SetDrawChanged()),this._SetWordWrapChanged())}SetIconSmoothing(e){e=!!e,this._iconSmoothing!==e&&(this._iconSmoothing=e,this._SetDrawChanged())}SetFontName(e){e||(e="serif"),this._fontName!==e&&(this._fontName=e,this._SetWordWrapChanged())}GetFontName(){return this._fontName}SetFontSize(e){e<.1&&(e=.1),this._fontSize!==e&&(this._fontSize=e,this._SetWordWrapChanged())}GetFontSize(){return this._fontSize}SetFontSizeScale(e){this._fontSizeScale!==e&&(this._fontSizeScale=e,this._SetWordWrapChanged())}SetLineHeight(e){this._lineHeight!==e&&(this._lineHeight=e,this._SetTextLayoutChanged())}GetLineHeight(){return this._lineHeight}SetBold(e){e=!!e,this._isBold!==e&&(this._isBold=e,this._SetWordWrapChanged())}IsBold(){return this._isBold}SetItalic(e){e=!!e,this._isItalic!==e&&(this._isItalic=e,this._SetWordWrapChanged())}IsItalic(){return this._isItalic}SetDrawMaxCharacterCount(e){e=Math.floor(e),this._drawMaxCharCount!==e&&(this._drawMaxCharCount=e,this._SetDrawChanged())}GetDrawMaxCharacterCount(){return this._drawMaxCharCount}_GetFontString(e,t){let s=[];(this._isBold||t.HasStyleTag("b"))&&s.push("bold"),(this._isItalic||t.HasStyleTag("i"))&&s.push("italic");const i=t.GetStyleTag("size"),r=(i?parseFloat(i.param):this._fontSize)*this._fontSizeScale;e?s.push(r+"pt"):s.push(r*this.GetDrawScale()+"pt");let n=this._fontName;const a=t.GetStyleTag("font");return a&&a.param&&(n=a.param,this.onloadfont&&!this._alreadyLoadedFonts.has(n)&&(this.onloadfont(n),this._alreadyLoadedFonts.add(n))),n&&(_c.has(n)?s.push(n):s.push('"'+n+'"')),s.join(" ")}SetColor(e){e instanceof cc.Color&&(e=e.getCssRgb()),this._colorStr!==e&&(this._colorStr=e,this._SetDrawChanged())}SetColorRgb(e,t,s){fc.setRgb(e,t,s),this.SetColor(fc)}SetHorizontalAlignment(e){if(!gc.has(e))throw new Error("invalid horizontal alignment");this._horizontalAlign!==e&&(this._horizontalAlign=e,this._SetTextLayoutChanged())}GetHorizontalAlignment(){return this._horizontalAlign}SetVerticalAlignment(e){if(!yc.has(e))throw new Error("invalid vertical alignment");this._verticalAlign!==e&&(this._verticalAlign=e,this._SetTextLayoutChanged())}GetVerticalAlignment(){return this._verticalAlign}SetWordWrapMode(e){if(!Sc.has(e))throw new Error("invalid word wrap mode");this._wrapMode!==e&&(this._wrapMode=e,this._SetWordWrapChanged())}GetWordWrapMode(){return this._wrapMode}SetTextDirection(e){if(!Tc.has(e))throw new Error("invalid text direction");this._textDirection!==e&&(this._textDirection=e,this._textContext&&(this._textContext.direction=this._textDirection),this._measureContext&&(this._measureContext.direction=this._textDirection),this._SetWordWrapChanged())}GetTextDirection(){return this._textDirection}SetText(e){this._text!==e&&(this._text=e,this._SetWordWrapChanged())}GetText(){return this._text}GetDrawScale(){return this._scaleFactor*this._zoom*self.devicePixelRatio}SetSize(e,t,s){if(void 0===s&&(s=1),e<=0||e<=0)return;if(this._cssWidth===e&&this._cssHeight===t&&this._zoom===s)return;const i=this._cssWidth;this._cssWidth=e,this._cssHeight=t,this._zoom=s;const r=self.devicePixelRatio;this._width=this._cssWidth*this._zoom*r,this._height=this._cssHeight*this._zoom*r;const n=Math.max(this._width,this._height),a=Math.min(this._renderer.GetMaxTextureSize(),4096);let o=1;n>a&&(o=a/n,this._width=Math.min(this._width*o,a),this._height=Math.min(this._height*o,a)),this._scaleFactor=o,this._cssWidth!==i?this._SetWordWrapChanged():this._SetTextLayoutChanged()}GetWidth(){return this._width}GetHeight(){return this._height}GetZoom(){return this._zoom}GetTextWidth(){return this._UpdateTextMeasurements(),this._wrappedText.GetMaxLineWidth()}GetTextHeight(){return this._UpdateTextMeasurements(),this._wrappedText.GetTotalLineHeight()+this._wrappedText.GetLineCount()*(this._lineHeight+4)-this._lineHeight}GetLengthInGraphemes(){this._UpdateTextMeasurements();let e=0;for(const t of this._wrappedText.GetLines())for(const s of t.fragments())e+=s.GetLength();return e}GetTexture(){return this._textureTimeout.Reset(),this._MaybeUpdate(),this._texture}HitTestFragment(e,t){this._UpdateTextMeasurements();const s=this.GetDrawScale(),i=this._wrappedText.GetLines();for(const r of i){const i=r.GetFontBoundingBoxDescent()*s;if(t>=r.GetPosY()-r.GetHeight()*s+i&&t<r.GetPosY()+i)for(const t of r.fragments())if(e>=t.GetPosX()&&e<t.GetPosX()+t.GetWidth()*s)return t}return null}*fragmentsWithTag(e){this._UpdateTextMeasurements();const t=this._wrappedText.GetLines();for(const s of t)for(const t of s.fragments()){const s=t.GetStyleTag("tag");s&&cc.equalsNoCase(s.param,e)&&(yield t)}}FindFragmentWithTag(e,t){for(const s of this.fragmentsWithTag(e)){if(0===t)return s;--t}return null}CountFragmentsWithTag(e){let t=0;for(const s of this.fragmentsWithTag(e))++t;return t}_MaybeUpdate(){(!this._texture||this._drawChanged||this._textLayoutChanged||this._wordWrapChanged)&&(this._wasReleased||this._width<=0||this._height<=0||(this._drawChanged=!1,this._DoUpdate()))}_DoUpdate(){this._wasReleased||(this._UpdateTextMeasurements(),this._SetTextCanvasSize(Math.max(cc.nextHighestPowerOfTwo(Math.ceil(this._width)),128),Math.max(cc.nextHighestPowerOfTwo(Math.ceil(this._height)),64)),this._DrawTextToCanvas(),this._UpdateTexture(),this._textureTimeout.Reset())}_SetTextCanvasSize(e,t){this._textCanvas||(this._textCanvas=cc.CreateCanvas(16,16));let s=!1;this._lastCanvasWidth===e&&this._lastCanvasHeight===t||(this._lastCanvasWidth=e,this._lastCanvasHeight=t,this._textCanvas.width=e,this._textCanvas.height=t,s=!0),this._textContext||(this._textContext=this._textCanvas.getContext("2d"),s=!0),s?(this._textContext.textBaseline=this._isBBcodeEnabled?"alphabetic":"top",this._textContext.direction=this._textDirection,this._textContext.font=this._lastTextCanvasFont,this._textContext.fillStyle=this._lastTextCanvasFillStyle,this._textContext.strokeStyle=this._lastTextCanvasFillStyle,this._textContext.globalAlpha=this._lastTextCanvasOpacity,this._textContext.lineWidth=this._lastTextCanvasLineWidth):this._textContext.clearRect(0,0,e,t)}_MaybeCreateMeasureContext(){this._measureContext||(this._measureContext=cc.CreateCanvas(16,16).getContext("2d"),this._measureContextTop=cc.CreateCanvas(16,16).getContext("2d"),this._measureContext.textBaseline=this._isBBcodeEnabled?"alphabetic":"top",this._measureContextTop.textBaseline="top",this._measureContext.direction=this._textDirection,this._measureContextTop.direction=this._textDirection)}_SetMeasureFontString(e){this._lastMeasureCanvasFont!==e&&(this._lastMeasureCanvasFont=e,this._measureContext.font=e,this._measureContextTop.font=e)}_SupportsFontBoundingBoxMeasurements(){if(!bc){bc=!0,this._MaybeCreateMeasureContext();const e=this._measureContext.measureText("test");Gc="number"==typeof e.fontBoundingBoxAscent&&"number"==typeof e.fontBoundingBoxDescent}return Gc}_UpdateTextMeasurements(){this._UpdateWordWrap(),this._UpdateTextLayout()}_UpdateWordWrap(){this._wordWrapChanged&&(this._MaybeCreateMeasureContext(),!this._isBBcodeEnabled||this._bbString&&this._bbString.toString()===this._text||(this._bbString=new cc.BBString(this._text,{noEscape:!0})),this._wrappedText.WordWrap(this._isBBcodeEnabled?this._bbString.toFragmentList():this._text,this._measureTextCallback,this._cssWidth,this._wrapMode,0),this._wordWrapChanged=!1)}_UpdateTextLayout(){this._textLayoutChanged&&(this._LayoutText(),this._textLayoutChanged=!1)}_MeasureText(e){const t=e.IsText()?e.GetCharacterArray().join(""):" ";this._SetMeasureFontString(this._GetFontString(!0,e));const s=e.GetStyleTag("size"),i=(s?parseFloat(s.param):this._fontSize)*this._fontSizeScale,r=this._measureContext.measureText(t);let n=0;if(this._isBBcodeEnabled&&this._SupportsFontBoundingBoxMeasurements()){const e=this._measureContextTop.measureText(t);n=r.fontBoundingBoxAscent-e.fontBoundingBoxAscent}return{width:r.width,height:hc(i),fontBoundingBoxAscent:r.fontBoundingBoxAscent||0,fontBoundingBoxDescent:r.fontBoundingBoxDescent||0,topToAlphabeticDistance:n}}_SetDrawFontString(e){this._lastTextCanvasFont!==e&&(this._lastTextCanvasFont=e,this._textContext.font=e)}_SetDrawCanvasColor(e){this._lastTextCanvasFillStyle!==e&&(this._lastTextCanvasFillStyle=e,this._textContext.fillStyle=e,this._textContext.strokeStyle=e)}_SetDrawCanvasOpacity(e){this._lastTextCanvasOpacity!==e&&(this._lastTextCanvasOpacity=e,this._textContext.globalAlpha=e)}_SetDrawCanvasLineWith(e){this._lastTextCanvasLineWidth!==e&&(this._lastTextCanvasLineWidth=e,this._textContext.lineWidth=e)}_LayoutText(){const e=this.GetDrawScale(),t=(4+this._lineHeight)*e;let s=0;const i=this._wrappedText.GetLines();if(0===i.length)return;for(const e of i){e.SetPosX(NaN),e.SetPosY(NaN);for(const t of e.fragments())t.SetPosX(NaN),t.SetPosY(NaN)}const r=this._isBBcodeEnabled&&this._SupportsFontBoundingBoxMeasurements();let n=i[0].GetHeight()*e;if("center"===this._verticalAlign){const a=i.reduce((s,i)=>s+i.GetHeight()*e+t,0)-t;s=Math.max(this._height/2-a/2,0),r&&(n=i[0].GetTopToAlphabeticDistance()*e)}else if("bottom"===this._verticalAlign){const n=i.reduce((s,i)=>s+i.GetHeight()*e+t,0)-this._lineHeight*e,a=r?i.at(-1).GetFontBoundingBoxDescent()*e:0;s=this._height-n-a-2}for(let r=0,a=i.length;r<a;++r){const a=i[r],o=a.GetHeight()*e,l=s;if(this._isBBcodeEnabled){if(s+=0===r?n:o,r>0&&s>this._height-4*e)break}else if(r>0&&s>=this._height-o)break;l>=0&&this._LayoutTextLine(a,s,e),this._isBBcodeEnabled||(s+=o),s+=t}}_LayoutTextLine(e,t,s){let i=0;"center"===this._horizontalAlign?i=Math.floor((this._width-e.GetWidth()*s)/2):"right"===this._horizontalAlign&&(i=this._width-e.GetWidth()*s),e.SetPosX(i),e.SetPosY(t);for(const r of"ltr"===this._textDirection?e.fragments():e.fragmentsReverse())this._LayoutFragment(r,i,t,s),i+=r.GetWidth()*s}_LayoutFragment(e,t,s,i){const r=e.GetStyleTag("offsetx");t+=r?uc(r.param,e.GetHeight())*i:0;const n=e.GetStyleTag("offsety");if(s+=n?uc(n.param,e.GetHeight())*i:0,e.IsIcon()){const t=e.GetStyleTag("iconoffsety");s+=t?uc(t.param,e.GetHeight())*i:.2*e.GetHeight()*i}e.SetPosX(t),e.SetPosY(s)}_DrawTextToCanvas(){this._textContext.imageSmoothingEnabled=this._iconSmoothing,this._textContext.imageSmoothingQuality="high",this._drawCharCount=0;const e=this.GetDrawScale(),t=this._wrappedText.GetLines();for(const s of t)this._DrawTextLine(s,e)}_DrawTextLine(e,t){const s=e.GetPosX(),i=e.GetPosY();if(Number.isFinite(s)&&Number.isFinite(i))for(const s of"ltr"===this._textDirection?e.fragments():e.fragmentsReverse())this._DrawFragment(s,t,e.GetHeight())}_DrawFragment(e,t,s){const i=this._textContext,r=e.GetPosX(),n=e.GetPosY();if(!Number.isFinite(r)||!Number.isFinite(n))return;const a=s/16;let o=e.GetWidth()*t;const l=e.GetHeight()*t,h=e.GetHeight()/16,u=(4+this._lineHeight)*t;let c=e.IsText()?e.GetCharacterArray():null;if(-1!==this._drawMaxCharCount){if(this._drawCharCount>=this._drawMaxCharCount)return;e.IsText()&&this._drawCharCount+c.length>this._drawMaxCharCount&&(c=c.slice(0,this._drawMaxCharCount-this._drawCharCount),o=this._MeasureText(e).width*t),this._drawCharCount+=e.GetLength()}const d=e.GetStyleTag("background"),p=e.HasStyleTag("u"),_=e.HasStyleTag("s");if(e.IsText()&&cc.IsCharArrayAllWhitespace(c)&&!d&&!p&&!_||e.HasStyleTag("hide"))return;const m=e.GetStyleTag("color"),f=e.GetStyleTag("opacity");this._SetDrawCanvasOpacity(f?parseFloat(f.param)/100:1),d&&(this._SetDrawCanvasColor(d.param),i.fillRect(r,n-l,o,l+u));const g=e.GetStyleTag("linethickness"),y=g?parseFloat(g.param):1,S=e.HasStyleTag("stroke");if(S&&this._SetDrawCanvasLineWith(.5*h*y*this.GetDrawScale()),e.IsText()){const t=c.join("");if(this._SetDrawFontString(this._GetFontString(!1,e)),!S){this._SetDrawCanvasLineWith(.5*h*y*this.GetDrawScale());const s=e.GetStyleTag("outlineback");s&&(this._SetDrawCanvasColor(s.param),this._FillOrStrokeText(!0,t,r,n,o))}if(this._SetDrawCanvasColor(m?m.param:this._colorStr),this._FillOrStrokeText(S,t,r,n,o),!S){this._SetDrawCanvasLineWith(.5*h*y*this.GetDrawScale());const s=e.GetStyleTag("outline");s&&(this._SetDrawCanvasColor(s.param),this._FillOrStrokeText(!0,t,r,n,o))}}else if(e.IsIcon()&&e.GetWidth()>0){const t=e.GetDrawable(this._iconSet);t&&i.drawImage(t,r,n-l,o,l)}if(this._SetDrawCanvasColor(m?m.param:this._colorStr),p&&lc(i,S,r,n+t*a,o,t*a*y),_){const e=t*h,s=n-l/4+e/2;i.fillRect(r,s-e*y/2,o,e*y)}}_FillOrStrokeText(e,t,s,i,r){"rtl"===this._textDirection&&(s+=r),e?"Gecko"===cc.Platform.BrowserEngine?this._textContext.strokeText(t,s,i,r):this._textContext.strokeText(t,s,i):"Gecko"===cc.Platform.BrowserEngine?this._textContext.fillText(t,s,i,r):this._textContext.fillText(t,s,i)}_UpdateTexture(){this._renderer.IsContextLost()||(this._texture||(this._texture=this._renderer.CreateDynamicTexture(this._textCanvas.width,this._textCanvas.height,{mipMap:!0,mipMapQuality:"high"})),this._renderer.UpdateTexture(this._textCanvas,this._texture),this._rcTex.set(0,0,this._width/this._texture.GetWidth(),this._height/this._texture.GetHeight()),this.ontextureupdate&&this.ontextureupdate())}GetTexRect(){return this._rcTex}ReleaseTexture(){this._texture&&(this._renderer.IsContextLost()||this._renderer.DeleteTexture(this._texture),this._texture=null)}static OnContextLost(){for(const e of xc)e.ReleaseTexture()}static GetAll(){return xc.values()}}}{const Ic=self.C3;class vc{constructor(e){this._gl=e.GetContext(),this._version=e.GetWebGLVersionNumber(),this._timerExt=e._GetDisjointTimerQueryExtension(),this._query=null,this._isActive=!1,this._hasResult=!1,this._result=0,1===this._version?this._query=this._timerExt.createQueryEXT():this._query=this._gl.createQuery()}Release(){this._DeleteQueryObject(),this._gl=null,this._timerExt=null,this._hasResult=!1}_DeleteQueryObject(){this._query&&(1===this._version?this._timerExt.deleteQueryEXT(this._query):this._gl.deleteQuery(this._query),this._query=null)}BeginTimeElapsed(){if(this._isActive)throw new Error("query already active");1===this._version?this._timerExt.beginQueryEXT(this._timerExt.TIME_ELAPSED_EXT,this._query):this._gl.beginQuery(this._timerExt.TIME_ELAPSED_EXT,this._query),this._isActive=!0}EndTimeElapsed(){if(!this._isActive)throw new Error("query not active");1===this._version?this._timerExt.endQueryEXT(this._timerExt.TIME_ELAPSED_EXT):this._gl.endQuery(this._timerExt.TIME_ELAPSED_EXT),this._isActive=!1}CheckForResult(){if(!this._query||this._hasResult||this._isActive)return;let e=!1;e=1===this._version?this._timerExt.getQueryObjectEXT(this._query,this._timerExt.QUERY_RESULT_AVAILABLE_EXT):this._gl.getQueryParameter(this._query,this._gl.QUERY_RESULT_AVAILABLE);const t=this._gl.getParameter(this._timerExt.GPU_DISJOINT_EXT);e&&!t&&(1===this._version?this._result=this._timerExt.getQueryObjectEXT(this._query,this._timerExt.QUERY_RESULT_EXT):this._result=this._gl.getQueryParameter(this._query,this._gl.QUERY_RESULT),this._result/=1e9,this._hasResult=!0),(e||t)&&this._DeleteQueryObject()}HasResult(){return this._hasResult}GetResult(){if(!this._hasResult)throw new Error("no result available");return this._result}}Ic.Gfx.WebGLTimeElapsedQuery=class{constructor(e){this._renderer=e,this._frameNumber=e.GetFrameNumber(),this._isActive=!1,this._parentQuery=null,this._isNested=!1,this._realQuery=null,this._queries=[]}Release(){for(const e of this._queries)e instanceof vc&&e.Release();Ic.clearArray(this._queries),this._parentQuery=null,this._realQuery=null,this._renderer=null}BeginTimeElapsed(){if(this._isActive)throw new Error("query already active");const e=this._renderer._GetTimeQueryStack();e.length>0?(this._isNested=!0,this._parentQuery=e.at(-1),this._parentQuery._EndReal(),this._parentQuery._queries.push(this)):(this._isNested=!1,this._parentQuery=null),this._isActive=!0,e.push(this),this._StartReal()}EndTimeElapsed(){if(!this._isActive)throw new Error("query not active");if(this._renderer._GetTimeQueryStack().pop()!==this)throw new Error("can only end most nested query");this._isActive=!1,this._EndReal(),this._parentQuery&&(this._parentQuery._StartReal(),this._parentQuery=null)}_StartReal(){this._realQuery=Ic.New(vc,this._renderer),this._queries.push(this._realQuery),this._realQuery.BeginTimeElapsed()}_EndReal(){this._realQuery.EndTimeElapsed(),this._realQuery=null}CheckForResult(){for(const e of this._queries)e.CheckForResult()}IsNested(){return this._isNested}HasResult(){return this._queries.every(e=>e.HasResult())}GetResult(){return this._queries.reduce((e,t)=>e+t.GetResult(),0)}GetFrameNumber(){return this._frameNumber}}}{const Cc=self.C3;Cc.Gfx.WebGLQueryResultBuffer=class{constructor(e,t=1e3){this._renderer=e,this._maxQueries=t,this._buffer=[],this._renderer._AddQueryResultBuffer(this)}Release(){this.Clear(),this._renderer._RemoveQueryResultBuffer(this),this._renderer=null}Clear(){for(const e of this._buffer)e.Release();Cc.clearArray(this._buffer)}AddTimeElapsedQuery(){const e=new Cc.Gfx.WebGLTimeElapsedQuery(this._renderer);return this._buffer.push(e),this._buffer.length>this._maxQueries&&this._buffer.shift().Release(),e}CheckForResults(e){for(const t of this._buffer){if(t.GetFrameNumber()>=e)return;if(t.IsNested())return;t.CheckForResult()}}GetFrameRangeResultSum(e,t){if(t<=e)return NaN;let s=0;for(const i of this._buffer){if(i.GetFrameNumber()>=t)break;if(!(i.GetFrameNumber()<e)){if(!i.HasResult())return NaN;s+=i.GetResult()}}return s}DeleteAllBeforeFrameNumber(e){for(let t=0,s=this._buffer.length;t<s;++t){const s=this._buffer[t];if(!(s.GetFrameNumber()<e))return void(t>0&&this._buffer.splice(0,t));s.Release()}}}}{let wc=function(){qc=-1;for(const e of Yc)e.checkFunc()&&(e.resolve(),Yc.delete(e));Yc.size>0&&(qc=self.requestAnimationFrame(wc))};CheckPendingPolls=wc;const Ac=self.C3,Rc=self.assert,Pc=self.glMatrix,Mc=Pc.vec3,Ec=Pc.vec4,Dc=Pc.mat4,Nc={powerPreference:"default",enableGpuProfiling:!0,alpha:!1,depth:!1,canSampleDepth:!1,maxWebGLVersion:2,failIfMajorPerformanceCaveat:!1},Fc=new Set(["default","low-power","high-performance"]),Oc=65535,Bc=393210,Lc=8e3,kc=7996,Vc=new Ac.Quad(0,0,1,0,1,1,0,1),Uc=Dc.create(),Wc=Dc.create(),Hc=new Ac.Quad,zc=new Ac.Rect;let jc=null;Ac.isDebug&&(self.debug_lose_webgl_context=function(){jc?jc.loseContext():console.warn("WEBGL_lose_context not supported")},self.debug_restore_webgl_context=function(){jc?jc.restoreContext():console.warn("WEBGL_lose_context not supported")});const Yc=new Set;let qc=-1;Ac.Gfx.WebGLRenderer=class extends Ac.Gfx.RendererBase{constructor(e,t){if(super(t),t=Object.assign({},Nc,t),!Fc.has(t.powerPreference))throw new Error("invalid power preference");const s={alpha:!!t.alpha,depth:!1,antialias:!1,powerPreference:t.powerPreference,failIfMajorPerformanceCaveat:!!t.failIfMajorPerformanceCaveat};let i=null,r=0;if(t.maxWebGLVersion>=2&&(i=e.getContext("webgl2",s),r=2),i||(i=e.getContext("webgl",s),r=1),!i)throw new Error("renderer-unavailable (could not get WebGL context)");this._gl=i,this._attribs=i.getContextAttributes(),this._versionString=i.getParameter(i.VERSION),this._version=r,this._viewport=Ec.create(),this._didChangeTransform=!1,this._bbProjectionMatrix=Dc.create(),this._usesDepthBuffer=!!t.depth,this._canSampleDepth=!(!t.depth||!t.canSampleDepth),this._isDepthEnabled=this._usesDepthBuffer,this._isDepthSamplingEnabled=!1,this._depthBuffer=null,this._isAutoSizeDepthBuffer=!0,this._depthBufferWidth=0,this._depthBufferHeight=0,this._vertexBuffer=null,this._texcoordBuffer=null,this._colorBuffer=null,this._indexBuffer=null,this._pointBuffer=null,this._isColorDataF16=this._version>=2&&void 0!==globalThis.Float16Array,this._vertexData=new Float32Array(196605),this._indexData=new Uint16Array(393210),this._texcoordData=new Float32Array(131070),this._colorData=this._isColorDataF16?new globalThis.Float16Array(262140):new Float32Array(262140),this._pointData=new Float32Array(32e3),this._vertexPtr=0,this._indexPtr=0,this._pointPtr=0,this._lastProgram=null,this._spDeviceTransformTextureFill=null,this._batch=[],this._batchPtr=0,this._topOfBatch=0,this._currentRenderTarget=null,this._lastPointZ=0,this._batchState=Ac.New(Ac.Gfx.BatchState,this),this._lastColor=Ac.New(Ac.Color,1,1,1,1),this._lastTexture0=null,this._lastTexture1=null,this._lastSrcBlend=0,this._lastDestBlend=0,this._lastPointTexCoords=new Ac.Rect,this._lastScissorRect=Ac.New(Ac.Rect,0,0,-1,-1),this._coplanarMode=0,this._lastCullFace=0,this._lastFrontFaceWinding=0,this._maxTextureSize=-1,this._minPointSize=0,this._maxPointSize=0,this._unmaskedVendor="(unavailable)",this._unmaskedRenderer="(unavailable)",this._extensions=[],this._isInitialisingAfterContextRestored=!1,this._parallelShaderCompileExt=null,this._anisotropicExt=null,this._conservativeDepthExt=null,this._depthTextureExt=null,this._fragDepthExt=null,this._stdDerivativesExt=null,this._textureLodExt=null,this._maxAnisotropy=0,this._isGpuProfilingEnabled=!!t.enableGpuProfiling,this._timerExt=null,this._allQueryResultBuffers=new Set,this._timeQueryStack=[]}IsWebGL(){return!0}async InitState(){super.InitState();const e=this._gl;this._lastColor.setRgba(1,1,1,1),this._lastTexture0=null,this._lastTexture1=null,this._vertexPtr=0,this._indexPtr=0,this._pointPtr=0,Ac.clearArray(this._batch),this._batchPtr=0,this._topOfBatch=0,this._lastProgram=null,this._currentRenderTarget=null,this._lastPointTexCoords.set(0,0,1,1),this._lastPointZ=0;const t=this._batchState;t.currentShader=null,t.currentFramebuffer=null,t.currentFramebufferNoDepth=null,t.clearColor.setRgba(0,0,0,0),t.pointTexCoords.set(0,0,1,1),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT),e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),this._lastSrcBlend=e.ONE,this._lastDestBlend=e.ONE_MINUS_SRC_ALPHA,this._InitBlendModes(e),e.cullFace(e.BACK),e.disable(e.CULL_FACE),this._lastCullFace=0,e.frontFace(e.CW),this._lastFrontFaceWinding=0,e.disable(e.STENCIL_TEST),e.disable(e.DITHER),this._usesDepthBuffer?(e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LEQUAL)):(e.disable(e.DEPTH_TEST),e.depthMask(!1)),this._isDepthEnabled=this._usesDepthBuffer,this._isDepthSamplingEnabled=!1,this._pointBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._pointBuffer),e.bufferData(e.ARRAY_BUFFER,this._pointData.byteLength,e.DYNAMIC_DRAW),this._vertexBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._vertexBuffer),e.bufferData(e.ARRAY_BUFFER,this._vertexData.byteLength,e.DYNAMIC_DRAW),this._texcoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._texcoordBuffer),e.bufferData(e.ARRAY_BUFFER,this._texcoordData.byteLength,e.DYNAMIC_DRAW),this._colorBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._colorBuffer),e.bufferData(e.ARRAY_BUFFER,this._colorData.byteLength,e.DYNAMIC_DRAW),this._indexBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._indexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,this._indexData.byteLength,e.DYNAMIC_DRAW),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),this._maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE);const s=e.getParameter(e.ALIASED_POINT_SIZE_RANGE);this._minPointSize=s[0],this._maxPointSize=s[1],this._maxPointSize>2048&&(this._maxPointSize=2048),this._extensions=e.getSupportedExtensions();const i=e.getExtension("WEBGL_debug_renderer_info");if(i&&(this._unmaskedVendor=e.getParameter(i.UNMASKED_VENDOR_WEBGL),this._unmaskedRenderer=e.getParameter(i.UNMASKED_RENDERER_WEBGL)),this._parallelShaderCompileExt=e.getExtension("KHR_parallel_shader_compile"),this._version>=2&&("Chromium"!==Ac.Platform.BrowserEngine||Ac.Platform.BrowserVersionNumber>=135)&&(this._conservativeDepthExt=e.getExtension("EXT_conservative_depth")),Ac.isDebug&&(jc=e.getExtension("WEBGL_lose_context")),this._isGpuProfilingEnabled&&(1===this.GetWebGLVersionNumber()?this._timerExt=e.getExtension("EXT_disjoint_timer_query"):this._timerExt=e.getExtension("EXT_disjoint_timer_query_webgl2")||e.getExtension("EXT_disjoint_timer_query")),this._anisotropicExt=e.getExtension("EXT_texture_filter_anisotropic"),this._anisotropicExt?this._maxAnisotropy=e.getParameter(this._anisotropicExt.MAX_TEXTURE_MAX_ANISOTROPY_EXT):this._maxAnisotropy=0,this.GetWebGLVersionNumber()<2&&this._usesDepthBuffer&&this._canSampleDepth&&(this._depthTextureExt=e.getExtension("WEBGL_depth_texture"),!this._depthTextureExt))throw new Error("no depth texture support");this.GetWebGLVersionNumber()<2&&(this._fragDepthExt=e.getExtension("EXT_frag_depth"),this._stdDerivativesExt=e.getExtension("OES_standard_derivatives"),this._textureLodExt=e.getExtension("EXT_shader_texture_lod"));const r=Ac.Gfx.WebGLShaderProgram,n=r.GetDefaultVertexShaderSource(!1);let a=r.GetTextureFillFragmentShaderSource_WebGL1_NoFragDepth(),o=n,l=r.GetPointFragmentShaderSource_WebGL1_NoFragDepth(),h=r.GetPointVertexShaderSource_WebGL1(),u=r.GetTilemapFragmentShaderSource_WebGL1_NoFragDepth(),c=r.GetDefaultVertexShaderSource(!0),d=!1;this._usesDepthBuffer&&(this.GetWebGLVersionNumber()<2?this._fragDepthExt&&(a=r.GetTextureFillFragmentShaderSource_WebGL1_FragDepthEXT(),l=r.GetPointFragmentShaderSource_WebGL1_FragDepthEXT(),u=r.GetTilemapFragmentShaderSource_WebGL1_FragDepthEXT(),d=!0):(o=r.GetDefaultVertexShaderSource_WebGL2(),a=r.GetTextureFillFragmentShaderSource_WebGL2(this._SupportsConservativeDepth()),l=r.GetPointFragmentShaderSource_WebGL2(this._SupportsConservativeDepth()),h=r.GetPointVertexShaderSource_WebGL2(),u=r.GetTilemapFragmentShaderSource_WebGL2(this._SupportsConservativeDepth()),c=r.GetDefaultVertexShaderSource_WebGL2(!0)));const p=r.GetTileRandomizationFragmentShaderSource(this.GetWebGLVersionNumber(),d,this._stdDerivativesExt&&this._textureLodExt,this._SupportsConservativeDepth()),_=this.GetWebGLVersionNumber()>=2?r.GetDefaultVertexShaderSource_WebGL2():n,m=[[a,o,"<default>"],[a,o,"<default-device-transform>"],[l,h,"<point>"],[r.GetColorFillFragmentShaderSource(),n,"<fill>"],[r.GetLinearGradientFillFragmentShaderSource(),n,"<lineargradient>"],[r.GetPenumbraFillFragmentShaderSource(),n,"<penumbra>"],[r.GetHardEllipseFillFragmentShaderSource(),n,"<hardellipse>"],[r.GetHardEllipseOutlineFragmentShaderSource(),n,"<hardellipseoutline>"],[r.GetSmoothEllipseFillFragmentShaderSource(),n,"<smoothellipse>"],[r.GetSmoothEllipseOutlineFragmentShaderSource(),n,"<smoothellipseoutline>"],[r.GetSmoothLineFillFragmentShaderSource(),n,"<smoothline>"],[u,c,"<tilemap>"],[p,_,"<tilerandomization>"]],f=await Promise.all(m.map(e=>this.CreateShaderProgram({src:e[0],vertexSrc:e[1],name:e[2]})));this._spTextureFill=f[0],this._spDeviceTransformTextureFill=f[1],this._spPoints=f[2],this._spColorFill=f[3],this._spLinearGradientFill=f[4],this._spPenumbraFill=f[5],this._spHardEllipseFill=f[6],this._spHardEllipseOutline=f[7],this._spSmoothEllipseFill=f[8],this._spSmoothEllipseOutline=f[9],this._spSmoothLineFill=f[10],this._spTilemapFill=f[11],this._spTileRandomization=f[12],this.SetTextureFillMode()}async CreateShaderProgram(e){const t=await Ac.Gfx.WebGLShaderProgram.Create(this,e);return this._AddShaderProgram(t),t}ResetLastProgram(){this._lastProgram=null}SetSize(e,t,s){if(this._width===e&&this._height===t&&!s)return;this.EndBatch();const i=this._gl,r=this._batchState;this._width=e,this._height=t,this._SetViewport(0,0,e,t),this.CalculatePerspectiveMatrix(this._bbProjectionMatrix,e/t),this.SetProjectionMatrix(this._bbProjectionMatrix),this._spDeviceTransformTextureFill&&(i.useProgram(this._spDeviceTransformTextureFill.GetShaderProgram()),this._spDeviceTransformTextureFill._UpdateDeviceTransformUniforms(this._matP),this._lastProgram=this._spDeviceTransformTextureFill,this._batchState.currentShader=this._spDeviceTransformTextureFill),i.bindTexture(i.TEXTURE_2D,null),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,null),i.activeTexture(i.TEXTURE0),this._lastTexture0=null,this._lastTexture1=null,this._usesDepthBuffer&&this._isAutoSizeDepthBuffer&&this._SetDepthBufferSize(this._width,this._height),this._currentRenderTarget&&this._currentRenderTarget._Resize(this._width,this._height),i.bindFramebuffer(i.FRAMEBUFFER,null),this._currentRenderTarget=null,r.currentFramebuffer=null,r.currentFramebufferNoDepth=null}_SetDepthBufferSize(e,t){const s=this._gl;this._depthBuffer&&this._depthBufferWidth===e&&this._depthBufferHeight===t||(this._canSampleDepth?(this._depthBuffer&&s.deleteTexture(this._depthBuffer),this._depthBuffer=s.createTexture(),s.bindTexture(s.TEXTURE_2D,this._depthBuffer),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),this.GetWebGLVersionNumber()>=2?s.texImage2D(s.TEXTURE_2D,0,s.DEPTH24_STENCIL8,e,t,0,s.DEPTH_STENCIL,s.UNSIGNED_INT_24_8,null):this._depthTextureExt&&s.texImage2D(s.TEXTURE_2D,0,s.DEPTH_STENCIL,e,t,0,s.DEPTH_STENCIL,this._depthTextureExt.UNSIGNED_INT_24_8_WEBGL,null),s.bindTexture(s.TEXTURE_2D,null)):(this._depthBuffer&&s.deleteRenderbuffer(this._depthBuffer),this._depthBuffer=s.createRenderbuffer(),s.bindRenderbuffer(s.RENDERBUFFER,this._depthBuffer),s.renderbufferStorage(s.RENDERBUFFER,this._version>=2?s.DEPTH24_STENCIL8:s.DEPTH_STENCIL,e,t),s.bindRenderbuffer(s.RENDERBUFFER,null)),this._depthBufferWidth=e,this._depthBufferHeight=t)}SetFixedSizeDepthBuffer(e,t){this._usesDepthBuffer&&(this._isAutoSizeDepthBuffer=!1,this._SetDepthBufferSize(e,t))}SetAutoSizeDepthBuffer(){this._usesDepthBuffer&&(this._isAutoSizeDepthBuffer=!0,this._SetDepthBufferSize(this._width,this._height))}_SetViewport(e,t,s,i){const r=this._viewport;r[0]===e&&r[1]===t&&r[2]===s&&r[3]===i||(this.PushBatch().InitSetViewport(e,t,s,i),Ec.set(r,e,t,s,i),this._topOfBatch=0)}SetFovY(e){super.SetFovY(e),this.CalculatePerspectiveMatrix(this._bbProjectionMatrix,this._width/this._height)}SetNearZ(e){super.SetNearZ(e),this.CalculatePerspectiveMatrix(this._bbProjectionMatrix,this._width/this._height)}SetFarZ(e){super.SetFarZ(e),this.CalculatePerspectiveMatrix(this._bbProjectionMatrix,this._width/this._height)}SetProjectionMatrix(e){Dc.exactEquals(this._matP,e)||(this.PushBatch().InitSetProjection(e),Dc.copy(this._matP,e),this._topOfBatch=0,this._didChangeTransform=!0)}SetDefaultRenderTargetProjectionState(){let e,t,s;const i=this._currentRenderTarget;null===i?(e=this._bbProjectionMatrix,t=this.GetWidth(),s=this.GetHeight()):(e=i.GetProjectionMatrix(),t=i.GetWidth(),s=i.GetHeight()),this.SetProjectionMatrix(e),this._SetViewport(0,0,t,s)}SetModelViewMatrix(e){Dc.exactEquals(this._matMV,e)||(this.PushBatch().InitSetModelView(e),Dc.copy(this._matMV,e),this._topOfBatch=0,this._didChangeTransform=!0)}ResetDidChangeTransformFlag(){this._didChangeTransform=!1}DidChangeTransform(){return this._didChangeTransform}GetBatchState(){return this._batchState}PushBatch(){const e=this._batch;return this._batchPtr===e.length&&e.push(new Ac.Gfx.WebGLBatchJob(this._batchState)),e[this._batchPtr++]}EndBatch(){0!==this._batchPtr&&(this.IsContextLost()||(this._WriteBuffers(),this._ExecuteBatch(),this._batchPtr=0,this._vertexPtr=0,this._indexPtr=0,this._pointPtr=0,this._topOfBatch=0))}_WriteBuffers(){const e=this._gl;this._vertexPtr>0&&(e.bindBuffer(e.ARRAY_BUFFER,this._vertexBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._vertexData.subarray(0,3*this._vertexPtr)),e.bindBuffer(e.ARRAY_BUFFER,this._texcoordBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._texcoordData.subarray(0,2*this._vertexPtr)),e.bindBuffer(e.ARRAY_BUFFER,this._colorBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._colorData.subarray(0,4*this._vertexPtr))),this._indexPtr>0&&(e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._indexBuffer),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,this._indexData.subarray(0,this._indexPtr))),this._pointPtr>0&&(e.bindBuffer(e.ARRAY_BUFFER,this._pointBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._pointData.subarray(0,this._pointPtr)))}_ExecuteBatch(){const e=this._batch;for(let t=0,s=this._batchPtr;t<s;++t)e[t].Run()}GetOpacity(){return this._lastColor.getA()}SetColorRgba(e,t,s,i){const r=this._lastColor;r.equalsRgba(e,t,s,i)||(r.setRgba(e,t,s,i),this._currentStateGroup=null,2===this._topOfBatch&&(this._topOfBatch=0))}SetOpacity(e){const t=this._lastColor;t.getA()!==e&&(t.setA(e),this._currentStateGroup=null,2===this._topOfBatch&&(this._topOfBatch=0))}SetColor(e){const t=this._lastColor;t.equals(e)||(t.set(e),this._currentStateGroup=null,2===this._topOfBatch&&(this._topOfBatch=0))}ResetColor(){this.SetColorRgba(1,1,1,1)}GetColor(){return this._lastColor}SetTexture(e){e!==this._lastTexture0&&(this.PushBatch().InitSetTexture(e),this._lastTexture0=e,this._topOfBatch=0)}_ResetLastTexture(){this._lastTexture0=null}SetBlendMode(e){const t=this._GetBlendByIndex(e);this._SetBlend(t[0],t[1])}SetNamedBlendMode(e){const t=this.GetNamedBlend(e);this._SetBlend(t.srcBlend,t.destBlend)}_SetBlend(e,t){e===this._lastSrcBlend&&t===this._lastDestBlend||(this.PushBatch().InitSetBlend(e,t),this._lastSrcBlend=e,this._lastDestBlend=t,this._topOfBatch=0,this._currentStateGroup=null)}IsPremultipliedAlphaBlend(){return this._lastSrcBlend===this._gl.ONE&&this._lastDestBlend===this._gl.ONE_MINUS_SRC_ALPHA}SetAlphaBlend(){this._SetBlend(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA)}SetNoPremultiplyAlphaBlend(){this._SetBlend(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA)}SetCullFaceMode(e){this._lastCullFace!==e&&(this.PushBatch().InitSetCullFaceMode(e),this._lastCullFace=e,this._topOfBatch=0,this._currentStateGroup=null)}GetCullFaceMode(){return this._lastCullFace}SetFrontFaceWinding(e){this._lastFrontFaceWinding!==e&&(this.PushBatch().InitSetFrontFaceWinding(e),this._lastFrontFaceWinding=e,this._topOfBatch=0,this._currentStateGroup=null)}GetFrontFaceWinding(){return this._lastFrontFaceWinding}SetCopyBlend(){this._SetBlend(this._gl.ONE,this._gl.ZERO)}Rect(e){this.Rect2(e.getLeft(),e.getTop(),e.getRight(),e.getBottom())}Rect2(e,t,s,i){this.Quad2(e,t,s,t,s,i,e,i)}_AddToDrawBatch(e,t){(this._vertexPtr+e>65535||this._indexPtr+t>393210)&&this.EndBatch(),1===this._topOfBatch?this._batch[this._batchPtr-1]._indexCount+=t:(this.PushBatch().InitDraw(2*this._indexPtr,t),this._topOfBatch=1)}_AddIndicesForQuad(){const e=this._vertexPtr;let t=this._indexPtr;this._indexPtr+=6;const s=this._indexData;s[t++]=e,s[t++]=e+1,s[t++]=e+2,s[t++]=e,s[t++]=e+2,s[t]=e+3}Quad(e){this.Quad4(e,Vc)}Quad2(e,t,s,i,r,n,a,o){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const l=this._vertexData,h=this._vertexPtr;this._vertexPtr+=4;let u=3*h;const c=this._baseZ+this._currentZ;l[u++]=e,l[u++]=t,l[u++]=c,l[u++]=s,l[u++]=i,l[u++]=c,l[u++]=r,l[u++]=n,l[u++]=c,l[u++]=a,l[u++]=o,l[u]=c,Vc.writeToTypedArray(this._texcoordData,2*h),this._lastColor.writeToTypedArrayx4(this._colorData,4*h)}Quad3(e,t){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const s=this._vertexPtr;this._vertexPtr+=4,e.writeToTypedArray3D(this._vertexData,3*s,this._baseZ+this._currentZ),t.writeAsQuadToTypedArray(this._texcoordData,2*s),this._lastColor.writeToTypedArrayx4(this._colorData,4*s)}Quad4(e,t){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const s=this._vertexPtr;this._vertexPtr+=4,e.writeToTypedArray3D(this._vertexData,3*s,this._baseZ+this._currentZ),t.writeToTypedArray(this._texcoordData,2*s),this._lastColor.writeToTypedArrayx4(this._colorData,4*s)}Quad5(e,t,s){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const i=this._vertexPtr;this._vertexPtr+=4,e.writeToTypedArray3D(this._vertexData,3*i,this._baseZ+this._currentZ),t.writeToTypedArray(this._texcoordData,2*i),this._colorData.set(s,4*i)}Quad3D(e,t,s,i,r,n,a,o,l,h,u,c,d){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const p=this._vertexData,_=this._vertexPtr;this._vertexPtr+=4;let m=3*_;const f=this._baseZ+this._currentZ;p[m++]=e,p[m++]=t,p[m++]=f+s,p[m++]=i,p[m++]=r,p[m++]=f+n,p[m++]=a,p[m++]=o,p[m++]=f+l,p[m++]=h,p[m++]=u,p[m]=f+c,d.writeAsQuadToTypedArray(this._texcoordData,2*_),this._lastColor.writeToTypedArrayx4(this._colorData,4*_)}Quad3D2(e,t,s,i,r,n,a,o,l,h,u,c,d){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const p=this._vertexData,_=this._vertexPtr;this._vertexPtr+=4;let m=3*_;const f=this._baseZ+this._currentZ;p[m++]=e,p[m++]=t,p[m++]=f+s,p[m++]=i,p[m++]=r,p[m++]=f+n,p[m++]=a,p[m++]=o,p[m++]=f+l,p[m++]=h,p[m++]=u,p[m]=f+c,d.writeToTypedArray(this._texcoordData,2*_),this._lastColor.writeToTypedArrayx4(this._colorData,4*_)}Quad3D3(e,t,s,i,r,n,a,o,l,h,u,c,d,p){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const _=this._vertexData,m=this._vertexPtr;this._vertexPtr+=4;let f=3*m;const g=this._baseZ+this._currentZ;_[f++]=e,_[f++]=t,_[f++]=g+s,_[f++]=i,_[f++]=r,_[f++]=g+n,_[f++]=a,_[f++]=o,_[f++]=g+l,_[f++]=h,_[f++]=u,_[f]=g+c,d.writeToTypedArray(this._texcoordData,2*m),this._colorData.set(p,4*m)}DrawMesh(e,t,s,i){if(e.length%3!=0)throw new Error("vertex buffer length not multiple of 3");if(e.length>196605)throw new Error(`too many vertices (${e.length/3}, limit 65535)`);if(s.length%3!=0)throw new Error("index buffer length not multiple of 3");if(s.length>393210)throw new Error(`too many indices (${s.length}, limit 393210)`);this._AddToDrawBatch(e.length,s.length);const r=this._vertexPtr;this._vertexData.set(e,3*r),this._texcoordData.set(t,2*r);const n=this._indexData;if(0===r)n.set(s,this._indexPtr);else{let e=this._indexPtr;for(let t=0,i=s.length;t<i;++t)n[e++]=s[t]+r}const a=this._colorData;if(void 0!==i)a.set(i,4*r);else{const t=this._lastColor,s=t.getR(),i=t.getG(),n=t.getB(),o=t.getA();let l=4*r;for(let t=0,r=e.length;t<r;++t)a[l++]=s,a[l++]=i,a[l++]=n,a[l++]=o}this._vertexPtr+=e.length/3,this._indexPtr+=s.length}FullscreenQuad(e,t){this.SetCurrentZ(0),Dc.copy(Uc,this._matP),Dc.copy(Wc,this._matMV),this.SetDefaultRenderTargetProjectionState();const[s,i]=this.GetRenderTargetSize(this._currentRenderTarget),r=this.CalculateLookAtModelView2(0,0,this.GetDefaultCameraZ(i),0,0,0,i);if(this.SetModelViewMatrix(r),"crop"===e&&this._currentRenderTarget&&t){const e=this._width/2,s=this._height/2,i=t.GetWidth(),r=t.GetHeight(),n=this._currentRenderTarget.GetWidth(),a=this._currentRenderTarget.GetHeight(),o=Math.min(n,i),l=Math.min(a,r),h=Math.max(r-a,0),u=Math.max(a-r,0);zc.set(-e,s-u,-e+o,s-l-u),Hc.setFromRect(zc),zc.set(0,h,o,l+h),zc.divide(i,r),this.Quad3(Hc,zc)}else{const e=s/2,t=i/2;this.Rect2(-e,t,e,-t)}this.SetProjectionMatrix(Uc),this.SetModelViewMatrix(Wc)}StartRenderingPoints(e){this._lastPointTexCoords.equals(e)||(this._lastPointTexCoords.copy(e),this.PushBatch().InitSetPointTexCoords(e),this._topOfBatch=0)}FinishRenderingPoints(){}Point(e,t,s,i){this._pointPtr>=7996&&this.EndBatch();let r=this._pointPtr;const n=this._baseZ+this._currentZ;2===this._topOfBatch&&this._lastPointZ===n?this._batch[this._batchPtr-1]._indexCount++:(this.PushBatch().InitPoints(r,n,this._lastColor),this._topOfBatch=2,this._lastPointZ=n);const a=this._pointData;a[r++]=e,a[r++]=t,a[r++]=s,a[r++]=i,this._pointPtr=r}SetProgram(e){this._lastProgram!==e&&(this.PushBatch().InitSetProgram(e),this._lastProgram=e,this._topOfBatch=0,this._currentStateGroup=null)}GetProgram(){return this._lastProgram}SetDeviceTransformTextureFillMode(){this.SetProgram(this._spDeviceTransformTextureFill)}SetGradientColor(e){this.PushBatch().InitSetGradientColor(e),this._topOfBatch=0}SetEllipseParams(e,t,s=1){this.PushBatch().InitSetEllipseParams(e,t,s),this._topOfBatch=0}SetTilemapInfo(e,t,s,i,r,n,a){if(this._lastProgram!==this._spTilemapFill)throw new Error("must set tilemap fill mode first");this.PushBatch().InitSetTilemapInfo(e,t,s,i,r,n,a),this._topOfBatch=0}SetTileRandomizationInfo(e,t,s,i,r,n,a){if(this._lastProgram!==this._spTileRandomization)throw new Error("must set tile randomization mode first");this.PushBatch().InitSetTileRandomizationInfo(e,t,s,i,r,n,a),this._topOfBatch=0}SetProgramParameters(e,t,s,i,r,n,a,o,l,h,u){const c=this._lastProgram;if(u%=10800,!c._hasAnyOptionalUniforms||c.AreOptionalUniformsAlreadySetInBatch(t,s,i,r,n,a,o,l,h,u))return;const d=this.PushBatch();d.InitSetProgramParameters(),c.SetOptionalUniformsInBatch(t,s,i,r,n,a,o,l,h,u);const p=d._mat4param;p[0]=n,p[1]=a,t.writeToTypedArray(p,2),p[6]=l,p[7]=h,s.writeToTypedArray(p,12);const _=d._colorParam;r.writeToTypedArray(_,0);const m=_[1];_[1]=_[3],_[3]=m,i.writeToTypedArray(d._srcOriginRect,0),d._startIndex=u,d._indexCount=o,c._uSamplerBack.IsUsed()?d._texParam=e?e.GetTexture():null:d._texParam=null,this._topOfBatch=0}SetProgramCustomParameters(e){const t=this._lastProgram;if(0===e.length||t.AreCustomParametersAlreadySetInBatch(e))return;const s=this.PushBatch();s.InitSetProgramCustomParameters(),t.SetCustomParametersInBatch(e),Ac.shallowAssignArray(s._shaderParams,e),this._topOfBatch=0}ClearRgba(e,t,s,i){this.PushBatch().InitClearSurface2(e,t,s,i),this._topOfBatch=0}Clear(e){this.PushBatch().InitClearSurface(e),this._topOfBatch=0}Start(){}Finish(){super.Finish(),this._gl.flush()}ClearDepth(){this._usesDepthBuffer&&this._currentRenderTarget&&this._currentRenderTarget.HasDepthBuffer()&&(this.PushBatch().InitClearDepth(this._isDepthEnabled),this._topOfBatch=0)}SetDepthEnabled(e){e=!!e,this._isDepthEnabled!==e&&this._usesDepthBuffer&&(this._isDepthEnabled=e,this.PushBatch().InitSetDepthEnabled(e),this._topOfBatch=0)}IsDepthEnabled(){return this._isDepthEnabled}_GetDepthBuffer(){return this._depthBuffer}_CanSampleDepth(){return this._canSampleDepth}SetDepthSamplingEnabled(e){if(e=!!e,this._canSampleDepth&&this._isDepthSamplingEnabled!==e){if(e&&this.IsDepthEnabled())throw new Error("depth still enabled");this._isDepthSamplingEnabled=e,this.PushBatch().InitSetDepthSamplingEnabled(e),this._topOfBatch=0}}SetScissorRect(e,t,s,i,r=0){e=Math.floor(e),t=Math.floor(t),s=Math.floor(s),i=Math.floor(i),this._lastScissorRect.equalsWH(e,t,s,i)||(this._lastScissorRect.setWH(e,t,s,i),t=(r||this.GetRenderTargetSize(this.GetRenderTarget())[1])-t-i,this.PushBatch().InitSetScissor(!0,e,t,s,i),this._topOfBatch=0)}RemoveScissorRect(){-1!==this._lastScissorRect.getRight()&&(this._lastScissorRect.set(0,0,-1,-1),this.PushBatch().InitSetScissor(!1,0,0,0,0),this._topOfBatch=0)}CheckForQueryResults(){for(const e of this._allQueryResultBuffers)e.CheckForResults(this._frameNumber)}IsContextLost(){return!this._gl||this._gl.isContextLost()||this._isInitialisingAfterContextRestored}OnContextLost(){super.OnDeviceOrContextLost(),Ac.Gfx.WebGLRendererTexture.OnContextLost(),Ac.Gfx.WebGLRenderTarget.OnContextLost(),Ac.Gfx.RendererText.OnContextLost();for(const e of this._allQueryResultBuffers)e.Clear();this._extensions=[],this._timerExt=null,this._parallelShaderCompileExt=null,this._conservativeDepthExt=null,this._anisotropicExt=null,this._depthTextureExt=null,this._fragDepthExt=null,this._stdDerivativesExt=null,this._textureLodExt=null,this._maxAnisotropy=0,this._unmaskedVendor="(unavailable)",this._unmaskedRenderer="(unavailable)",this._lastProgram=null,this._spDeviceTransformTextureFill=null,this._depthBuffer=null;for(const e of this._stateGroups.values())e.OnContextLost()}async OnContextRestored(){this._isInitialisingAfterContextRestored=!0,await this.InitState(),this._isInitialisingAfterContextRestored=!1;for(const e of this._stateGroups.values())e.OnContextRestored(this);this.SetSize(this._width,this._height,!0)}CreateStaticTexture(e,t){if(this.IsContextLost())throw new Error("context lost");this.EndBatch();const s=Ac.New(Ac.Gfx.WebGLRendererTexture,this);return s._CreateStatic(e,t),s}async CreateStaticTextureAsync(e,t){if(this.IsContextLost())throw new Error("context lost");if(t=Object.assign({},t),Ac.Supports.ImageBitmapOptions){let s=await createImageBitmap(e,{premultiplyAlpha:"premultiply"});const i=t.wrapX&&"clamp-to-edge"!==t.wrapX||t.wrapY&&"clamp-to-edge"!==t.wrapY,r=Ac.isPOT(s.width)&&Ac.isPOT(s.height);return this.SupportsNPOTTextures()||r||!i?t.premultiplyAlpha=!1:Ac.Supports.ImageBitmapOptionsResize?(s=await createImageBitmap(e,{premultiplyAlpha:"premultiply",resizeWidth:Ac.nextHighestPowerOfTwo(s.width),resizeHeight:Ac.nextHighestPowerOfTwo(s.height)}),t.premultiplyAlpha=!1):s=await createImageBitmap(e,{premultiplyAlpha:"none"}),await Ac.Asyncify(()=>this.CreateStaticTexture(s,t))}if(e instanceof Blob){if("undefined"==typeof Image)throw new Error("texture upload variant not supported in worker");const t=await Ac.BlobToImage(e);e=t}return await Ac.Asyncify(()=>this.CreateStaticTexture(e,t))}CreateDynamicTexture(e,t,s){this.EndBatch();const i=Ac.New(Ac.Gfx.WebGLRendererTexture,this);return i._CreateDynamic(e,t,s),i}UpdateTexture(e,t,s){this.EndBatch(),t._Update(e,s)}DeleteTexture(e){e&&(e.SubtractReference(),e.GetReferenceCount()>0||(this.EndBatch(),e===this._lastTexture0&&(this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._lastTexture0=null),e===this._lastTexture1&&(this._gl.activeTexture(this._gl.TEXTURE1),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._gl.activeTexture(this._gl.TEXTURE0),this._lastTexture1=null),e._Delete()))}CreateRenderTarget(e){let t=this._width,s=this._height,i=!0;if(e&&("number"==typeof e.width&&(t=Math.floor(e.width),i=!1),"number"==typeof e.height&&(s=Math.floor(e.height),i=!1)),t<=0||s<=0)throw new Error("invalid size");this.EndBatch();const r=Ac.New(Ac.Gfx.WebGLRenderTarget,this);return r._Create(t,s,Object.assign({isDefaultSize:i},e)),this._currentRenderTarget=null,this._batchState.currentFramebuffer=null,this._batchState.currentFramebufferNoDepth=null,r}SetRenderTarget(e,t=!0){e!==this._currentRenderTarget&&(e&&e.IsDefaultSize()&&e._Resize(this._width,this._height),this.PushBatch().InitSetRenderTarget(e),this._currentRenderTarget=e,this._topOfBatch=0,t&&this.SetDefaultRenderTargetProjectionState())}GetRenderTarget(){return this._currentRenderTarget}GetRenderTargetSize(e){return e?[e.GetWidth(),e.GetHeight()]:[this._width,this._height]}CopyRenderTarget(e,t="stretch"){this._version<2||this._currentRenderTarget&&this._currentRenderTarget.GetMultisampling()>0?(this.SetCopyBlend(),this.ResetColor(),this.DrawRenderTarget(e,t)):(this.PushBatch().InitBlitFramebuffer(e,this._currentRenderTarget,t),this._topOfBatch=0)}DrawRenderTarget(e,t="stretch"){const s=e.GetTexture();if(!s)throw new Error("not a texture-backed render target");this.SetTexture(s),this.FullscreenQuad(t,s)}InvalidateRenderTarget(e){this._version<2||(this.PushBatch().InitInvalidateFramebuffer(e._GetFramebuffer()),this._topOfBatch=0)}DeleteRenderTarget(e){this.SetRenderTarget(null),this.EndBatch();const t=e.GetTexture();t===this._lastTexture0&&(this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._lastTexture0=null),t===this._lastTexture1&&(this._gl.activeTexture(this._gl.TEXTURE1),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._gl.activeTexture(this._gl.TEXTURE0),this._lastTexture1=null),e._Delete()}async ReadBackRenderTargetToImageData(e,t,s){this.EndBatch();const i=this._currentRenderTarget;let r,n,a;e?(r=e.GetWidth(),n=e.GetHeight(),a=e._GetFramebuffer()):(r=this.GetWidth(),n=this.GetHeight(),a=null);let o=0,l=0,h=r,u=n;if(s){o=Ac.clamp(Math.floor(s.getLeft()),0,r-1),l=Ac.clamp(Math.floor(s.getTop()),0,n-1);let e=s.width();e=0===e?r-o:Ac.clamp(Math.floor(e),0,r-o);let t=s.height();t=0===t?n-l:Ac.clamp(Math.floor(t),0,n-l),h=e,u=t,l=n-(l+u)}const c=this._gl;c.bindFramebuffer(c.FRAMEBUFFER,a);const d=()=>{c.bindFramebuffer(c.FRAMEBUFFER,null),this._currentRenderTarget=null,this._batchState.currentFramebuffer=null,this._batchState.currentFramebufferNoDepth=null,this.SetRenderTarget(i)};let p;if(!t&&this.GetWebGLVersionNumber()>=2){c.bindFramebuffer(c.READ_FRAMEBUFFER,a);const e=c.createBuffer(),t=h*u*4,s=c.PIXEL_PACK_BUFFER;c.bindBuffer(s,e),c.bufferData(s,t,c.STREAM_READ),c.readPixels(o,l,h,u,c.RGBA,c.UNSIGNED_BYTE,0),c.bindFramebuffer(c.READ_FRAMEBUFFER,null),c.bindBuffer(s,null),d();const i=c.fenceSync(c.SYNC_GPU_COMMANDS_COMPLETE,0);await this._WaitForObjectReady(()=>c.getSyncParameter(i,c.SYNC_STATUS)===c.SIGNALED),c.deleteSync(i),p=new ImageData(h,u),c.bindBuffer(s,e),c.getBufferSubData(s,0,new Uint8Array(p.data.buffer),0,t),c.bindBuffer(s,null),c.deleteBuffer(e)}else p=new ImageData(h,u),c.readPixels(o,l,h,u,c.RGBA,c.UNSIGNED_BYTE,new Uint8Array(p.data.buffer)),d();return p}CoplanarStartStencilPass(){this.SetDepthEnabled(!0),this.PushBatch().InitCoplanarStartStencilPass(),this._topOfBatch=0,this._coplanarMode=1}CoplanarStartColorPass(){this.SetDepthEnabled(!1),this.PushBatch().InitCoplanarStartColorPass(),this._topOfBatch=0,this._coplanarMode=2}IsCoplanarColorPass(){return 2===this._coplanarMode}CoplanarRestoreStandardRendering(){this.SetDepthEnabled(!0),this.PushBatch().InitCoplanarRestore(),this._topOfBatch=0,this._coplanarMode=0}StartQuery(e){this.SupportsGPUProfiling()&&(this.PushBatch().InitStartQuery(e),this._topOfBatch=0)}EndQuery(e){this.SupportsGPUProfiling()&&(this.PushBatch().InitEndQuery(e),this._topOfBatch=0)}_WaitForObjectReady(e){const t=new Promise(t=>Yc.add({resolve:t,checkFunc:e}));return-1===qc&&(qc=self.requestAnimationFrame(wc)),t}GetEstimatedBackBufferMemoryUsage(){return this._width*this._height*(this._attribs.alpha?4:3)}GetEstimatedRenderBufferMemoryUsage(){let e=0;for(const t of Ac.Gfx.WebGLRenderTarget.allRenderTargets())t.GetTexture()||(e+=t.GetEstimatedMemoryUsage());return e}GetEstimatedTextureMemoryUsage(){let e=0;for(const t of Ac.Gfx.WebGLRendererTexture.allTextures())e+=t.GetEstimatedMemoryUsage();return e}GetWebGLVersionString(){return this._versionString}GetWebGLVersionNumber(){return this._version}IsColorDataF16(){return this._isColorDataF16}GetDisplayName(){return"webgl"+this.GetWebGLVersionNumber()}SupportsNPOTTextures(){return this.GetWebGLVersionNumber()>=2}GetMaxTextureSize(){return this._maxTextureSize}GetMinPointSize(){return this._minPointSize}GetMaxPointSize(){return this._maxPointSize}GetUnmaskedVendor(){return this._unmaskedVendor}GetUnmaskedRenderer(){return this._unmaskedRenderer}GetWebGLExtensionsAnalyticsString(){if(this.GetWebGLVersionNumber()>=2)return"webgl2";{const e=[];return this._fragDepthExt&&e.push("EXT_frag_depth"),this._stdDerivativesExt&&e.push("OES_standard_derivatives"),this._textureLodExt&&e.push("EXT_shader_texture_lod"),e.length>0?"webgl1:"+e.join(","):"webgl1:none"}}GetExtensions(){return this._extensions}SupportsGPUProfiling(){return!!this._timerExt}_GetDisjointTimerQueryExtension(){return this._timerExt}_GetParallelShaderCompileExtension(){return this._parallelShaderCompileExt}_SupportsConservativeDepth(){return!!this._conservativeDepthExt}_GetAnisotropicExtension(){return this._anisotropicExt}_GetMaxAnisotropy(){return this._maxAnisotropy}_AddQueryResultBuffer(e){this._allQueryResultBuffers.add(e)}_RemoveQueryResultBuffer(e){this._allQueryResultBuffers.delete(e)}_GetTimeQueryStack(){return this._timeQueryStack}GetContext(){return this._gl}_InitBlendModes(e){this._InitBlendModeData([["normal",e.ONE,e.ONE_MINUS_SRC_ALPHA],["additive",e.ONE,e.ONE],["xor",e.ONE,e.ONE_MINUS_SRC_ALPHA],["copy",e.ONE,e.ZERO],["destination-over",e.ONE_MINUS_DST_ALPHA,e.ONE],["source-in",e.DST_ALPHA,e.ZERO],["destination-in",e.ZERO,e.SRC_ALPHA],["source-out",e.ONE_MINUS_DST_ALPHA,e.ZERO],["destination-out",e.ZERO,e.ONE_MINUS_SRC_ALPHA],["source-atop",e.DST_ALPHA,e.ONE_MINUS_SRC_ALPHA],["destination-atop",e.ONE_MINUS_DST_ALPHA,e.SRC_ALPHA]])}CreateWebGLText(){return this.CreateRendererText()}}}{const Xc=self.C3,$c=self.glMatrix,Kc=$c.vec3,Jc=$c.mat4,Qc=self.assert,Zc=self.GPUBufferUsage,ed=self.GPUShaderStage,td=self.GPUMapMode,sd=self.GPUTextureUsage,id={powerPreference:"default",depth:!1,failIfMajorPerformanceCaveat:!1,canSampleBackbuffer:!1,usesBackgroundBlending:!1,canSampleDepth:!1,isMultiTexturingAllowed:!0},rd=65535,nd=393210,ad=Math.floor(65535/4),od=65535,ld=4*ad-16,hd=1,ud=2,cd=4,dd=8,pd=16,_d=32,md=64,fd=128,gd=256,yd=512,Sd=1024,Td=2048,xd=4096,bd=8192,Gd=16384,Id=32768,vd=65536,Cd=1<<17,wd=1<<18,Ad=1<<19,Rd=1<<20,Pd=1<<21,Md=1<<22,Ed=1<<23,Dd=1<<24,Nd=1<<25,Fd=1<<26,Od=1<<27,Bd=1<<28,Ld=1<<29,kd=1<<30,Vd=1,Ud=8688,Wd=8697,Hd=25072,zd=7680,jd=2,Yd=4,qd=2,Xd=4,$d=new Xc.Quad(0,0,1,0,1,1,0,1),Kd=Xc.New(Xc.Vector2),Jd=Xc.New(Xc.Rect),Qd=Xc.New(Xc.Rect),Zd=Xc.New(Xc.Quad);Xc.Gfx.WebGPURenderer=class extends Xc.Gfx.RendererBase{constructor(e){super(e),this._adapterOpts=null,this._adapter=null,this._adapterInfo=null,this._device=null,this._canvas=null,this._presentCtx=null,this._swapChainFormat="",this._swapChainTexture=null,this._swapChainTexView=null,this._viewportWidth=0,this._viewportHeight=0,this._matTransform=Jc.create(),this._depthBuffer=null,this._nullDepthBuffer=null,this._depthBufferView=null,this._nullDepthBufferView=null,this._depthBufferBindGroup=null,this._nullDepthBufferBindGroup=null,this._depthBufferWidth=0,this._depthBufferHeight=0,this._vertexUniformBuffer=null,this._fragmentUniformBuffer=null,this._fragmentC3ParamsBuffer=null,this._fragmentDefaultCustomParamsBuffer=null,this._vertexBuffer=null,this._texcoordBuffer=null,this._texIndexBuffer=null,this._colorBuffer=null,this._indexBuffer=null,this._pointsIndexBuffer=null,this._pointBuffer=null,this._vertexUniformBufferLayout=Xc.Gfx.WebGPUShaderProgram.GetVertexUniformBufferLayout(),this._vertexUniformBufferSize=Xc.Gfx.WebGPUShaderProgram.GetVertexUniformBufferSize(),this._vertexUniformArrayBuffer=null,this._vertexUniformf32=null,this._fragUniformBufferLayout=Xc.Gfx.WebGPUShaderProgram.GetFragmentUniformBufferLayout(),this._fragUniformBufferSize=Xc.Gfx.WebGPUShaderProgram.GetFragmentUniformBufferSize(),this._fragUniformArrayBuffer=null,this._fragUniformf32=null,this._fragC3ParamsLayout=Xc.Gfx.WebGPUShaderProgram.GetFragmentC3ParamsBufferLayout(),this._fragC3ParamsSize=Xc.Gfx.WebGPUShaderProgram.GetFragmentC3ParamsBufferSize(),this._fragC3ParamsArrayBuffer=null,this._fragC3Paramsf32=null,this._fragC3Paramsu32=null,this._vertexData=new Float32Array(196605),this._texcoordData=new Float32Array(131070),this._texIndexData=new Uint32Array(65535),this._colorData=null,this._indexData=new Uint16Array(393210),this._pointData=new Float32Array(4*ad),this._vertexPtr=0,this._indexPtr=0,this._currentMultiTextureIndex=0,this._currentColor=Xc.New(Xc.Color,1,1,1,1),this._pointPtr=0,this._bufferManager=Xc.New(Xc.Gfx.WebGPUBufferManager,this),this._flags=32768,this._flags2=0,this._drawFirstIndex=0,this._drawIndexCount=0,this._vertexUniformUpdateStart=0,this._vertexUniformUpdateEnd=0,this._fragUniformUpdateStart=0,this._fragUniformUpdateEnd=0,this._fragC3ParamsUpdateStart=0,this._fragC3ParamsUpdateEnd=0,this._scissorRect=Xc.New(Xc.Rect,0,0,0,0),this._currentColor2=Xc.New(Xc.Color,1,1,1,1),this._currentPointColor=Xc.New(Xc.Color,1,1,1,1),this._currentPointTexCoords=Xc.New(Xc.Rect,0,0,0,0),this._currentVertexZElevation=0,this._textureFormat="",this._bufferBindGroupLayout=null,this._defaultBufferBindGroup=null,this._textureBindGroupLayout=null,this._backTextureBindGroupLayout=null,this._depthTextureBindGroupLayout=null,this._nullTexture=null,this._currentTexture=null,this._currentTextureBindGroup=null,this._currentBackTexture=null,this._currentBackTextureBindGroup=null,this._currentDepthTextureBindGroup=null,this._currentBufferBindGroup=null,this._mipmapGeneratorPipeline=null,this._availableMultiTextures=new Set,this._nonFullMultiTexGroups=new Set,this._maxTextureSize=8192,this._pipelineLayout=null,this._defaultVertexModule=null,this._normVertexModule=null,this._currentProgram=null,this._currentBlendMode=0,this._currentMultisampleCount=0,this._currentCullFace=0,this._currentFrontFaceWinding=0,this._mipmapGeneratorProgram=null,this._spSingleTextureFill=null,this._samplerMap=new Map,this._commandEncoder=null,this._currentRenderPass=null,this._commandBuffers=[],this._backbufferRenderTarget=null,this._currentRenderTarget=null,this._canSampleBackbuffer=!1,this._usesBackgroundBlending=!1,this._canSampleDepth=!1,this._frameTimeQuerySet=null,this._timestampIsMeasuring=!1,this._timestampStartIndex=-1,this._timestampEndIndex=-1,this._timestampStartedIndices=new Set,this.ondevicelost=null,this.ondevicerestored=null,this._InitBlendModes()}IsWebGPU(){return!0}_SetFlag(e,t){t?this._flags|=e:this._flags&=~e}_IsFlagSet(e){return 0!==(this._flags&e)}_SetFlag2(e,t){t?this._flags2|=e:this._flags2&=~e}_IsFlagSet2(e){return 0!==(this._flags2&e)}async Create(e,t){if(t=Object.assign({},id,t),!navigator.gpu)throw new Error("renderer-unavailable (WebGPU not supported)");t.depth&&(this._flags|=524288),t.isMultiTexturingAllowed&&(this._flags|=65536),this._canSampleBackbuffer=!!t.canSampleBackbuffer,this._usesBackgroundBlending=!!t.usesBackgroundBlending,this._adapterOpts={},this._canSampleDepth=!(!t.depth||!t.canSampleDepth),"default"!==t.powerPreference&&(this._adapterOpts.powerPreference=t.powerPreference),this._canvas=e,await this._InitDevice(t.failIfMajorPerformanceCaveat)}async _InitDevice(e){for(this._device=null,await this._TryGetDeviceOnCurrentAdapter(e);!this._device;)this._adapter=null,await this._TryGetDeviceOnCurrentAdapter(e);await this.InitState()}async _TryGetDeviceOnCurrentAdapter(e){if(!this._adapter){if(this._adapter=await navigator.gpu.requestAdapter(this._adapterOpts),!this._adapter)throw new Error("renderer-unavailable (no WebGPU adapter available)");if(e&&(this._adapter.isFallbackAdapter||this._adapter.info.isFallbackAdapter))throw new Error("renderer-unavailable (WebGPU provided fallback adapter)");if("adreno-7xx"===this._adapter.info.architecture)throw new Error("WebGPU disabled on adreno-7xx devices - see https://issues.chromium.org/issues/329702056")}const t=[];if(this._adapter.features.has("timestamp-query")&&t.push("timestamp-query"),this._adapter.features.has("shader-f16")&&t.push("shader-f16"),this._device=await this._adapter.requestDevice({requiredFeatures:t,requiredLimits:{maxTextureDimension2D:this._adapter.limits.maxTextureDimension2D}}),!this._device)return null;this._maxTextureSize=this._device.limits.maxTextureDimension2D,this._SetFlag(134217728,this._device.features.has("timestamp-query")),this._SetFlag(268435456,this._device.features.has("shader-f16")),this._SetFlag(536870912,this._IsFlagSet(268435456)&&void 0!==globalThis.Float16Array),this._device.lost.then(e=>this._OnDeviceLost(e)),this._SetFlag(32768,!1)}async _OnDeviceLost(e){console.log("[WebGPU] Device lost: ",e),super.OnDeviceOrContextLost(),this._bufferManager.OnContextLost(),Xc.Gfx.WebGPURendererTexture.OnContextLost(),Xc.Gfx.WebGPURenderTarget.OnContextLost(),Xc.Gfx.RendererText.OnContextLost(),this._swapChainFormat="",this._swapChainTexture=null,this._swapChainTexView=null,this._depthBuffer=null,this._depthBufferView=null,this._nullDepthBuffer=null,this._nullDepthBufferView=null,this._depthBufferBindGroup=null,this._nullDepthBufferBindGroup=null,this._vertexBuffer=null,this._texcoordBuffer=null,this._texIndexBuffer=null,this._colorBuffer=null,this._indexBuffer=null,this._pointsIndexBuffer=null,this._pointBuffer=null,this._vertexUniformBuffer=null,this._fragmentUniformBuffer=null,this._fragmentC3ParamsBuffer=null,this._fragmentDefaultCustomParamsBuffer=null,this._defaultBufferBindGroup=null,this._bufferBindGroupLayout=null,this._currentBufferBindGroup=null,this._textureBindGroupLayout=null,this._backTextureBindGroupLayout=null,this._depthTextureBindGroupLayout=null,this._pipelineLayout=null,this._currentProgram=null,this._nullTexture=null,this._currentTexture=null,this._currentTextureBindGroup=null,this._currentBackTexture=null,this._currentBackTextureBindGroup=null,this._currentDepthTextureBindGroup=null,this._defaultVertexModule=null,this._normVertexModule=null,this._backbufferRenderTarget=null,this._currentRenderTarget=null,this._mipmapGeneratorPipeline=null,this._frameTimeQuerySet=null,this._mipmapGeneratorProgram=null,this._spSingleTextureFill=null,this._availableMultiTextures.clear(),this._nonFullMultiTexGroups.clear(),this._samplerMap.clear();for(const e of this._stateGroups.values())e.OnContextLost();this._device=null,this._adapter=null,this._adapterInfo=null,this._flags|=32768,this.ondevicelost&&this.ondevicelost(),await this._InitDevice();for(const e of this._stateGroups.values())e.OnContextRestored(this);this.SetSize(this._width,this._height,!0),this.ondevicerestored&&this.ondevicerestored()}async InitState(){super.InitState();const e=this._device;this._swapChainFormat=navigator.gpu.getPreferredCanvasFormat(),this._swapChainTexture=null,this._swapChainTexView=null;let t=sd.RENDER_ATTACHMENT;this._canSampleBackbuffer&&(t|=sd.TEXTURE_BINDING),this._usesBackgroundBlending&&(t|=sd.COPY_SRC),this._swapChainFormat.startsWith("rgba8")||this._swapChainFormat.startsWith("bgra8")?this._textureFormat=this._swapChainFormat:this._textureFormat="rgba8unorm",this._flags&=940113920,this._flags|=7680,this._flags2=0,this._IsFlagSet(524288)&&(this._flags|=70254592),this._vertexPtr=0,this._indexPtr=0,this._currentBlendMode=0,this._currentCullFace=0,this._currentFrontFaceWinding=0,this._currentMultisampleCount=0,this._currentColor.setRgba(1,1,1,1),this._currentColor2.setRgba(1,1,1,1),this._currentPointColor.setRgba(1,1,1,1),this._colorData=this.IsColorDataF16()?new globalThis.Float16Array(262140):new Float32Array(262140),this._vertexUniformArrayBuffer=new ArrayBuffer(this._vertexUniformBufferSize),this._vertexUniformf32=new Float32Array(this._vertexUniformArrayBuffer),this._fragUniformArrayBuffer=new ArrayBuffer(this._fragUniformBufferSize),this._fragUniformf32=new Float32Array(this._fragUniformArrayBuffer),this._fragC3ParamsArrayBuffer=new ArrayBuffer(this._fragC3ParamsSize),this._fragC3Paramsf32=new Float32Array(this._fragC3ParamsArrayBuffer),this._fragC3Paramsu32=new Uint32Array(this._fragC3ParamsArrayBuffer),this._vertexBuffer=e.createBuffer({label:"vertexbuffer",size:this._vertexData.byteLength,usage:Zc.VERTEX|Zc.COPY_DST}),this._texcoordBuffer=e.createBuffer({label:"texcoordbuffer",size:this._texcoordData.byteLength,usage:Zc.VERTEX|Zc.COPY_DST}),this._texIndexBuffer=e.createBuffer({label:"texindexbuffer",size:this._texIndexData.byteLength,usage:Zc.VERTEX|Zc.COPY_DST}),this._colorBuffer=e.createBuffer({label:"colorbuffer",size:this._colorData.byteLength,usage:Zc.VERTEX|Zc.COPY_DST}),this._indexBuffer=e.createBuffer({label:"indexbuffer",size:this._indexData.byteLength,usage:Zc.INDEX|Zc.COPY_DST}),this._pointsIndexBuffer=e.createBuffer({label:"pointsindexbuffer",size:6*ad*2,usage:Zc.INDEX,mappedAtCreation:!0});const s=this._pointsIndexBuffer.getMappedRange();this._FillPointsIndexBuffer(s),this._pointsIndexBuffer.unmap(),this._pointBuffer=e.createBuffer({label:"pointbuffer",size:this._pointData.byteLength,usage:Zc.VERTEX|Zc.STORAGE|Zc.COPY_DST}),this._bufferBindGroupLayout=e.createBindGroupLayout({label:"bufferbindgrouplayout",entries:[{binding:0,visibility:ed.VERTEX,buffer:{type:"uniform",minBindingSize:this._vertexUniformBufferSize}},{binding:1,visibility:ed.FRAGMENT,buffer:{type:"uniform",minBindingSize:this._fragUniformBufferSize}},{binding:3,visibility:ed.VERTEX,buffer:{type:"read-only-storage",minBindingSize:this._pointData.byteLength}},{binding:4,visibility:ed.FRAGMENT,buffer:{type:"uniform",minBindingSize:this._fragC3ParamsSize}},{binding:5,visibility:ed.FRAGMENT,buffer:{type:"uniform"}}]});const i=[],r=Xc.Gfx.WebGPUMultiTextureGroup.GetMultiTextureLimit();for(let e=0;e<r;++e)i.push({binding:2*e,visibility:ed.FRAGMENT,sampler:{type:"filtering"}},{binding:2*e+1,visibility:ed.FRAGMENT,texture:{sampleType:"float",viewDimension:"2d"}});this._textureBindGroupLayout=e.createBindGroupLayout({label:"texturebindgrouplayout",entries:i}),this._backTextureBindGroupLayout=e.createBindGroupLayout({label:"backtexturebindgrouplayout",entries:[{binding:0,visibility:ed.FRAGMENT,sampler:{type:"non-filtering"}},{binding:1,visibility:ed.FRAGMENT,texture:{sampleType:"float",viewDimension:"2d"}}]}),this._depthTextureBindGroupLayout=e.createBindGroupLayout({label:"depthtexturebindgrouplayout",entries:[{binding:0,visibility:ed.FRAGMENT,sampler:{type:"non-filtering"}},{binding:1,visibility:ed.FRAGMENT,texture:{sampleType:"depth",viewDimension:"2d"}}]}),this._pipelineLayout=e.createPipelineLayout({bindGroupLayouts:[this._bufferBindGroupLayout,this._textureBindGroupLayout,this._backTextureBindGroupLayout,this._depthTextureBindGroupLayout]});const n=Xc.Gfx.WebGPUShaderProgram,a=this.SupportsF16(),o=this.IsColorDataF16();this._defaultVertexModule=e.createShaderModule({label:"<default vertex module>",code:n._PreprocessVertexShaderCode(n.GetDefaultVertexShaderSource(o),a)}),this._defaultVertexModule.getCompilationInfo().then(e=>n.ReportShaderCompilationInfo("<default>","vertex",e)),this._normVertexModule=e.createShaderModule({label:"<normalized vertex module>",code:n._PreprocessVertexShaderCode(n.GetNormalizedVertexShaderSource(o),a)}),this._normVertexModule.getCompilationInfo().then(e=>n.ReportShaderCompilationInfo("<normalized>","vertex",e));const l=await Promise.all([n.Create(this,{name:"<default>",src:n.GetMultiTextureFillFragmentShaderSource(!1,o),srcFragDepth:n.GetMultiTextureFillFragmentShaderSource(!0,o),vertexSrc:n.GetTextureFillVertexShaderSource(o),normVertexSrc:n.GetNormalizedTextureFillVertexShaderSource(o)}),n.Create(this,{name:"<single-texture-fill>",src:n.GetSingleTextureFillFragmentShaderSource(!1,o),srcFragDepth:n.GetSingleTextureFillFragmentShaderSource(!0,o),vertexSrc:n.GetTextureFillVertexShaderSource(o),normVertexSrc:n.GetNormalizedTextureFillVertexShaderSource(o)}),n.Create(this,{name:"<generate-mipmap>",src:n._GetMipmapGeneratorFragmentSource(),vertexSrc:n._GetMipmapGeneratorVertexSource()}),n.Create(this,{name:"<point>",src:n._GetPointFragmentSource(!1),srcFragDepth:n._GetPointFragmentSource(!0),vertexSrc:n._GetPointVertexSource()}),n.Create(this,{name:"<tilemap>",src:n._GetTilemapFragmentShaderSource(!1),srcFragDepth:n._GetTilemapFragmentShaderSource(!0)}),n.Create(this,{name:"<fill>",src:n._GetColorFillFragmentShaderSource()}),n.Create(this,{name:"<lineargradient>",src:n._GetLinearGradientFillFragmentShaderSource()}),n.Create(this,{name:"<penumbra>",src:n._GetPenumbraFillFragmentShaderSource()}),n.Create(this,{name:"<hardellipse>",src:n._GetHardEllipseFillFragmentShaderSource()}),n.Create(this,{name:"<hardellipseoutline>",src:n._GetHardEllipseOutlineFragmentShaderSource()}),n.Create(this,{name:"<smoothellipse>",src:n._GetSmoothEllipseFillFragmentShaderSource()}),n.Create(this,{name:"<smoothellipseoutline>",src:n._GetSmoothEllipseOutlineFragmentShaderSource()}),n.Create(this,{name:"<tilerandomization>",src:n.GetTileRandomizationFragmentShaderSource(!1),srcFragDepth:n.GetTileRandomizationFragmentShaderSource(!0)}),n.Create(this,{name:"<smoothline>",src:n._GetSmoothLineFillFragmentShaderSource()})]);this._spTextureFill=l[0],this._spSingleTextureFill=l[1],this._mipmapGeneratorProgram=l[2],this._spPoints=l[3],this._spTilemapFill=l[4],this._spColorFill=l[5],this._spLinearGradientFill=l[6],this._spPenumbraFill=l[7],this._spHardEllipseFill=l[8],this._spHardEllipseOutline=l[9],this._spSmoothEllipseFill=l[10],this._spSmoothEllipseOutline=l[11],this._spTileRandomization=l[12],this._spSmoothLineFill=l[13];for(const e of l)this._AddShaderProgram(e);65536&this._flags?(this._flags|=393216,this._currentProgram=this._spTextureFill):this._currentProgram=this._spSingleTextureFill,this._mipmapGeneratorPipeline=this._mipmapGeneratorProgram._GetMipmapGeneratorPipeline(),this._vertexUniformBuffer=e.createBuffer({label:"vertexuniformbuffer",size:this._vertexUniformBufferSize,usage:Zc.UNIFORM|Zc.COPY_DST}),this._fragmentUniformBuffer=e.createBuffer({label:"fragmentuniformbuffer",size:this._fragUniformBufferSize,usage:Zc.UNIFORM|Zc.COPY_DST}),this._fragmentC3ParamsBuffer=e.createBuffer({label:"fragmentc3paramsuniformbuffer",size:this._fragC3ParamsSize,usage:Zc.UNIFORM|Zc.COPY_DST}),this._fragmentDefaultCustomParamsBuffer=e.createBuffer({label:"fragmentdefaultcustomparamsbuffer",size:16,usage:Zc.UNIFORM|Zc.COPY_DST}),this._vertexUniformUpdateStart=0,this._vertexUniformUpdateEnd=this._vertexUniformBufferSize,this._UpdateTransformUniform(),this._UpdatePointTexCoordsUniform(),this._UpdateZElevationUniform(),this._fragUniformUpdateStart=0,this._fragUniformUpdateEnd=this._fragUniformBufferSize,this._UpdateColor2Uniform(),this._UpdatePointColorUniform(),this._defaultBufferBindGroup=this._CreateBufferBindGroup(this._fragmentDefaultCustomParamsBuffer),this._currentBufferBindGroup=this._defaultBufferBindGroup;const h=Xc.CreateCanvas(32,32);h.getContext("2d"),this._nullTexture=await this.CreateStaticTextureAsync(h),this._currentTexture=null,this._currentTextureBindGroup=this._nullTexture._GetOwnTextureBindGroup(),this._currentMultiTextureIndex=0,this._currentBackTexture=null,this._currentBackTextureBindGroup=this._nullTexture._GetBackTextureBindGroup(),this._nullTexture._DisableMultiTexture(),this._nullDepthBuffer=this._device.createTexture({label:"nulldepthbuffer",size:[8,8,1],format:this._GetDepthBufferFormat(),usage:sd.TEXTURE_BINDING}),this._nullDepthBufferView=this._nullDepthBuffer.createView({label:"nulldepthbufferview",aspect:"depth-only"}),this._nullDepthBufferBindGroup=this._device.createBindGroup({label:"nulldepthbufferbindgroup",layout:this._depthTextureBindGroupLayout,entries:[{binding:0,resource:this._GetSampler({sampling:"nearest"})},{binding:1,resource:this._nullDepthBufferView}]}),this._currentDepthTextureBindGroup=this._nullDepthBufferBindGroup,this._backbufferRenderTarget=Xc.New(Xc.Gfx.WebGPURenderTarget,this,!0),this._backbufferRenderTarget.GetTexture()._BackbufferTextureSetProperties(t,this._swapChainFormat),this._currentRenderTarget=this._backbufferRenderTarget,this._CreateCommandEncoder(),this._adapterInfo=this._adapter.info,this._presentCtx||(this._presentCtx=this._canvas.getContext("webgpu")),this._presentCtx.configure({device:e,format:this._swapChainFormat,usage:t,alphaMode:"premultiplied"})}_CreateBufferBindGroup(e){return this._device.createBindGroup({layout:this._bufferBindGroupLayout,entries:[{binding:0,resource:{buffer:this._vertexUniformBuffer}},{binding:1,resource:{buffer:this._fragmentUniformBuffer}},{binding:3,resource:{buffer:this._pointBuffer}},{binding:4,resource:{buffer:this._fragmentC3ParamsBuffer}},{binding:5,resource:{buffer:e}}]})}_FillPointsIndexBuffer(e){const t=new Uint16Array(e);let s=0,i=t.length,r=0;for(;s<i;)t[s++]=r,t[s++]=r+1,t[s++]=r+2,t[s++]=r,t[s++]=r+2,t[s++]=r+3,r+=4}_GetDevice(){return this._device}_GetDefaultVertexModule(){return this._defaultVertexModule}_GetNormalizedVertexModule(){return this._normVertexModule}async CreateShaderProgram(e){const t=await Xc.Gfx.WebGPUShaderProgram.Create(this,e);return this._AddShaderProgram(t),t}GetDisplayName(){return"webgpu"}GetSwapChainFormat(){return this._swapChainFormat}_GetDepthBufferFormat(){return"depth24plus-stencil8"}_GetSwapChainTexture(){return this._swapChainTexture}_GetSwapChainTexView(){return this._swapChainTexView}_CanSampleBackbuffer(){return this._canSampleBackbuffer}UsesBackgroundBlending(){return this._usesBackgroundBlending}_GetPipelineLayout(){return this._pipelineLayout}_GetTextureBindGroupLayout(){return this._textureBindGroupLayout}_GetBackTextureBindGroupLayout(){return this._backTextureBindGroupLayout}GetTextureFormat(){return this._textureFormat}GetMaxTextureSize(){return this._maxTextureSize}IsContextLost(){return this._IsFlagSet(32768)}SupportsGPUProfiling(){return this._IsFlagSet(134217728)}SupportsF16(){return this._IsFlagSet(268435456)}IsColorDataF16(){return this._IsFlagSet(536870912)}GetEstimatedBackBufferMemoryUsage(){const e=this.GetWidth()*this.GetHeight();let t=e*Xc.Gfx.WebGPURendererTexture.GetFormatByteSize(this._swapChainFormat);return this.UsesDepthBuffer()&&(t+=e*Xc.Gfx.WebGPURendererTexture.GetFormatByteSize(this._GetDepthBufferFormat())),t}GetEstimatedRenderBufferMemoryUsage(){let e=0;for(const t of Xc.Gfx.WebGPURenderTarget.allRenderTargets())t.IsBackBuffer()||(e+=t.GetTexture().GetEstimatedMemoryUsage());return e}GetEstimatedTextureMemoryUsage(){let e=0;for(const t of Xc.Gfx.WebGPURendererTexture.allTextures())t.IsRenderTarget()||(e+=t.GetEstimatedMemoryUsage());return e}SupportsNPOTTextures(){return!0}GetBufferManager(){return this._bufferManager}SetSize(e,t,s){(this._width!==e||this._height!==t||s)&&(this.EndBatch(),this._width=e,this._height=t,this._viewportWidth=e,this._viewportHeight=t,this._backbufferRenderTarget._CalculateProjection(),this.SetProjectionMatrix(this._backbufferRenderTarget.GetProjectionMatrix()),this._currentRenderTarget&&this._currentRenderTarget._Resize(this._width,this._height),this._IsFlagSet(524288)&&this._IsFlagSet(67108864)&&this._SetDepthBufferSize(e,t))}_SetDepthBufferSize(e,t){if(this._depthBuffer){if(this._depthBufferWidth===e&&this._depthBufferHeight===t)return;this._depthBuffer.destroy()}let s=sd.RENDER_ATTACHMENT;this._canSampleDepth&&(s|=sd.TEXTURE_BINDING),this._depthBuffer=this._device.createTexture({label:"depthbuffer",size:[e,t,1],format:this._GetDepthBufferFormat(),usage:s}),this._depthBufferView=this._depthBuffer.createView({label:"depthbufferview"}),this._canSampleDepth&&(this._depthBufferBindGroup=this._device.createBindGroup({label:"depthbufferbindgroup",layout:this._depthTextureBindGroupLayout,entries:[{binding:0,resource:this._GetSampler({sampling:"nearest"})},{binding:1,resource:this._depthBuffer.createView({label:"depthbufferview",aspect:"depth-only"})}]})),this._depthBufferWidth=e,this._depthBufferHeight=t}SetFixedSizeDepthBuffer(e,t){this.UsesDepthBuffer()&&(this._SetFlag(67108864,!1),this._SetDepthBufferSize(e,t))}SetAutoSizeDepthBuffer(){this.UsesDepthBuffer()&&(this._SetFlag(67108864,!0),this._SetDepthBufferSize(this._width,this._height))}SetProjectionMatrix(e){Jc.exactEquals(this._matP,e)||(Jc.copy(this._matP,e),this._UpdateTransformUniform())}SetDefaultRenderTargetProjectionState(){this.SetProjectionMatrix(this._currentRenderTarget.GetProjectionMatrix())}SetModelViewMatrix(e){Jc.exactEquals(this._matMV,e)||(Jc.copy(this._matMV,e),this._UpdateTransformUniform())}ResetDidChangeTransformFlag(){this._SetFlag2(1,!1)}DidChangeTransform(){return this._IsFlagSet2(1)}CreateStaticTexture(e,t){if(e&&!Xc.Gfx.WebGPURendererTexture.IsGPUImageCopyExternalImageSource(e)){const t=e.width||e.videoWidth,s=e.height||e.videoHeight,i=Xc.CreateCanvas(t,s);i.getContext("2d").drawImage(e,0,0,t,s),e=i}this.EndBatch();const s=Xc.New(Xc.Gfx.WebGPURendererTexture,this);return s._Create(e,t),s}async CreateStaticTextureAsync(e,t){if(Xc.Gfx.WebGPURendererTexture.IsGPUImageCopyExternalImageSource(e))return this.CreateStaticTexture(e,t);{if(!Xc.Supports.ImageBitmapOptions)throw new Error("no support for ImageBitmapOptions");const s=await createImageBitmap(e,{premultiplyAlpha:"premultiply"});return this.CreateStaticTexture(s,t)}}_GetSampler(e){const t=e.wrapX||"clamp-to-edge",s=e.wrapY||"clamp-to-edge",i=e.sampling;let r=e.anisotropy||0;"trilinear"!==i&&(r=0);const n=`${t},${s},${i},${r}`;let a=this._samplerMap.get(n);if(a)return a;const o={addressModeU:t,addressModeV:s,magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest"};return"bilinear"!==i&&"trilinear"!==i||(o.magFilter="linear",o.minFilter="linear"),"trilinear"===i&&(o.mipmapFilter="linear",r>1&&(o.maxAnisotropy=r)),a=this._device.createSampler(o),this._samplerMap.set(n,a),a}_GetMipmapGeneratorPipeline(){return this._mipmapGeneratorPipeline}CreateDynamicTexture(e,t,s){this.EndBatch();const i=Xc.New(Xc.Gfx.WebGPURendererTexture,this);return i._CreateDynamic(e,t,s),i}UpdateTexture(e,t,s){return t._Update(e,s)}DeleteTexture(e){e&&(e.SubtractReference(),e.GetReferenceCount()>0||(this.IsContextLost()||(this.EndBatch(),this._currentTexture===e&&this.SetTexture(null),this._currentBackTexture===e&&this.SetBackTexture(null)),e._Delete()))}_SetMultiTextureAvailable(e,t){this.IsContextLost()||(t?this._availableMultiTextures.add(e):this._availableMultiTextures.delete(e))}_SetMultiTextureGroupNonFull(e,t){t?this._nonFullMultiTexGroups.add(e):this._nonFullMultiTexGroups.delete(e)}_TryCreateMultiTextureGroup(e){const t=[e],s=Xc.Gfx.WebGPUMultiTextureGroup.GetMultiTextureLimit();for(const e of this._nonFullMultiTexGroups)e.Release();for(const i of this._availableMultiTextures){if(t.length>=s)break;i!==e&&t.push(i)}t.length<2||Xc.New(Xc.Gfx.WebGPUMultiTextureGroup,this,t)}Start(){this._UpdateSwapChainTexture()}Restart(){this._UpdateSwapChainTexture()}_UpdateSwapChainTexture(){this._swapChainTexture=this._presentCtx.getCurrentTexture(),this._swapChainTexView=this._swapChainTexture.createView({label:"swapchaintextureview"}),this._backbufferRenderTarget.GetTexture()._BackbufferTextureStartFrame()}Finish(){null===this._currentRenderPass&&this._backbufferRenderTarget._IsAwaitingClear()&&this._BeginRenderPass(),super.Finish(),this._bufferManager.MaybeCollectUnusedBuffers(this._frameNumber),this._backbufferRenderTarget.GetTexture()._BackbufferTextureEndFrame(),this._swapChainTexture=null,this._swapChainTexView=null}_CreateCommandEncoder(){this._commandEncoder=this._device.createCommandEncoder(),this._flags&=-16385}StartFrameTiming(e){if(!this.SupportsGPUProfiling())throw new Error("GPU profiling not supported");if(this._frameTimeQuerySet)throw new Error("already started frame timing");return this._timestampIsMeasuring=!1,this._timestampStartedIndices.clear(),this._frameTimeQuerySet=Xc.New(Xc.Gfx.WebGPUTimeQuerySet,this,e),this._frameTimeQuerySet}StartMeasuringRenderPassTime(e,t){if(this.SupportsGPUProfiling()){if(!this._frameTimeQuerySet)throw new Error("not started frame timing");if(e<0||t<0||e===t)throw new Error("invalid timestamp index");this._MaybeEndRenderPass(),this._timestampIsMeasuring=!0,this._timestampStartIndex=e,this._timestampEndIndex=t}}StopMeasuringRenderPassTime(){this._timestampIsMeasuring&&(this._MaybeEndRenderPass(),this._timestampIsMeasuring=!1)}_AddToDrawBatch(e,t){if(this._vertexPtr+e>65535||this._indexPtr+t>393210)this.EndBatch();else if(1&this._flags)return void(this._drawIndexCount+=t);null===this._currentRenderPass&&this._BeginRenderPass(),this._flags|=1,this._drawFirstIndex=this._indexPtr,this._drawIndexCount=t}_AddIndicesForQuad(){const e=this._vertexPtr;let t=this._indexPtr;this._indexPtr+=6;const s=this._indexData;s[t++]=e,s[t++]=e+1,s[t++]=e+2,s[t++]=e,s[t++]=e+2,s[t]=e+3}_MaybeEndDrawBatch(){const e=this._flags;if(!(1&e))return;const t=this._currentRenderPass;if(16&e){const s=this._currentRenderTarget;t.setViewport(0,0,s.GetWidth(),s.GetHeight(),0,1),2&e?t.setIndexBuffer(this._pointsIndexBuffer,"uint16"):t.setIndexBuffer(this._indexBuffer,"uint16"),t.setVertexBuffer(0,this._vertexBuffer),t.setVertexBuffer(1,this._texcoordBuffer),t.setVertexBuffer(2,this._colorBuffer),t.setVertexBuffer(3,this._texIndexBuffer),25165824&e&&t.setStencilReference(1),4&e&&this._DoSetRenderPassScissorRect(t,this._scissorRect,s)}if(32&e){let s=0;1073741824&e?s=4:8388608&e?s=2:16777216&e?s=3:3145728&~e||(s=1),t.setPipeline(this._currentProgram.GetRenderPipelineForState(this._currentBlendMode,s,this._currentCullFace,this._currentFrontFaceWinding,this._currentMultisampleCount))}if(8192&e&&t.setBindGroup(0,this._currentBufferBindGroup),64&e&&t.setBindGroup(1,this._currentTextureBindGroup),128&e&&t.setBindGroup(2,this._currentBackTextureBindGroup),256&e&&t.setBindGroup(3,this._currentDepthTextureBindGroup),8&e){const s=this._currentRenderTarget;4&e?this._DoSetRenderPassScissorRect(t,this._scissorRect,s):t.setScissorRect(0,0,s.GetWidth(),s.GetHeight())}t.drawIndexed(this._drawIndexCount,1,this._drawFirstIndex,0,0),this._flags&=-8698}_DoSetRenderPassScissorRect(e,t,s){const i=s.GetWidth(),r=s.GetHeight();let n=Xc.clamp(t.getLeft(),0,i),a=Xc.clamp(t.getTop(),0,r),o=Xc.clamp(t.getRight(),n,i),l=Xc.clamp(t.getBottom(),a,r);Number.isNaN(n)&&(n=0),Number.isNaN(a)&&(a=0),Number.isNaN(o)&&(o=i),Number.isNaN(l)&&(l=r),e.setScissorRect(n,a,o-n,l-a)}_BeginRenderPass(){const e=this._flags;7680&e&&this._WriteUniformBuffers();let t=null;t=8388608&e?this._GetCoplanarStencilRenderPassOpts():16777216&e?this._GetCoplanarColorRenderPassOpts():this._GetStandardRenderPassOpts(),this._currentRenderPass=this._commandEncoder.beginRenderPass(t),this._flags|=25072}_GetStandardRenderPassOpts(){const e=this._flags,t=this._currentRenderTarget,s={colorAttachments:[{view:t._GetTextureView(),loadOp:t._IsAwaitingClear()?"clear":"load",clearValue:t._GetClearColor().toJSON(),storeOp:"store"}]};return this._MaybeSetTimestampRenderPassOption(s),t._SetIsAwaitingClear(!1),3145728&~e||(s.depthStencilAttachment={view:this._depthBufferView,depthLoadOp:4194304&e?"clear":"load",depthClearValue:1,depthStoreOp:"store",stencilLoadOp:"clear",stencilClearValue:0,stencilStoreOp:"discard"},this._flags&=-4194305),s}_GetCoplanarStencilRenderPassOpts(){const e=this._flags,t={colorAttachments:[],depthStencilAttachment:{view:this._depthBufferView,depthLoadOp:4194304&e?"clear":"load",depthClearValue:1,depthStoreOp:"store",stencilLoadOp:33554432&e?"clear":"load",stencilClearValue:0,stencilStoreOp:"store"}};return this._MaybeSetTimestampRenderPassOption(t),this._flags&=-37748737,t}_GetCoplanarColorRenderPassOpts(){const e=this._currentRenderTarget,t={colorAttachments:[{view:e._GetTextureView(),loadOp:e._IsAwaitingClear()?"clear":"load",clearValue:e._GetClearColor().toJSON(),storeOp:"store"}],depthStencilAttachment:{view:this._depthBufferView,depthReadOnly:!0,stencilReadOnly:!0}};return this._MaybeSetTimestampRenderPassOption(t),e._SetIsAwaitingClear(!1),t}_MaybeSetTimestampRenderPassOption(e){if(!this._timestampIsMeasuring)return;const t={querySet:this._frameTimeQuerySet._GetQuerySet(),endOfPassWriteIndex:this._timestampEndIndex};this._timestampStartedIndices.has(this._timestampStartIndex)||(t.beginningOfPassWriteIndex=this._timestampStartIndex,this._timestampStartedIndices.add(this._timestampStartIndex)),e.timestampWrites=t}_MaybeDoPendingClearRenderPass(e){e._IsAwaitingClear()&&(this._MaybeEndRenderPass(),this._commandEncoder.beginRenderPass({colorAttachments:[{view:e._GetTextureView(),loadOp:"clear",clearValue:e._GetClearColor().toJSON(),storeOp:"store"}]}).end(),this._flags|=16384,e._SetIsAwaitingClear(!1))}_MaybeEndRenderPass(){null!==this._currentRenderPass&&(this._MaybeEndDrawBatch(),this._currentRenderPass.end(),this._currentRenderPass=null)}EndBatch(e=!1){this._MaybeEndRenderPass(),this._frameTimeQuerySet&&e&&(this._frameTimeQuerySet.Resolve(this._commandEncoder),this._flags|=16384),16384&this._flags&&(this._commandBuffers.push(this._commandEncoder.finish()),this._CreateCommandEncoder()),0!==this._commandBuffers.length&&(this._WriteBuffers(),this._device.queue.submit(this._commandBuffers),Xc.clearArray(this._commandBuffers),this._bufferManager.AfterSubmit(),this._frameTimeQuerySet&&e&&(this._frameTimeQuerySet.ReadResult(),this._frameTimeQuerySet=null))}_WriteBuffers(){const e=this._device.queue;if(this._vertexPtr>0){const t=this._vertexPtr;e.writeBuffer(this._vertexBuffer,0,this._vertexData.buffer,0,3*t*4),e.writeBuffer(this._texcoordBuffer,0,this._texcoordData.buffer,0,2*t*4),65536&this._flags&&e.writeBuffer(this._texIndexBuffer,0,this._texIndexData.buffer,0,4*t);const s=this.IsColorDataF16()?2:4;e.writeBuffer(this._colorBuffer,0,this._colorData.buffer,0,4*t*s),this._vertexPtr=0}this._indexPtr>0&&(e.writeBuffer(this._indexBuffer,0,this._indexData.buffer,0,2*this._indexPtr),this._indexPtr=0),this._pointPtr>0&&(e.writeBuffer(this._pointBuffer,0,this._pointData.buffer,0,4*this._pointPtr),this._pointPtr=0)}_UpdateTransformUniform(){this._flags|=512,this._flags2|=1,this._MarkVertexUniformBufferRangeChanged(this._vertexUniformBufferLayout.transform)}_UpdatePointTexCoordsUniform(){const e=this._vertexUniformBufferLayout.pointTex;this._currentPointTexCoords.writeToTypedArray(this._vertexUniformf32,e.offset/4),this._MarkVertexUniformBufferRangeChanged(e)}_UpdateZElevationUniform(){const e=this._vertexUniformBufferLayout.zElevation;this._vertexUniformf32[e.offset/4]=this._currentVertexZElevation,this._MarkVertexUniformBufferRangeChanged(e)}_MarkVertexUniformBufferRangeChanged(e){const t=e.offset,s=e.end;1024&this._flags?(this._vertexUniformUpdateStart=Math.min(this._vertexUniformUpdateStart,t),this._vertexUniformUpdateEnd=Math.max(this._vertexUniformUpdateEnd,s)):(this._flags|=1024,this._vertexUniformUpdateStart=t,this._vertexUniformUpdateEnd=s,this._MaybeEndRenderPass())}_UpdateColor2Uniform(){this._UpdateFragmentUniformColor(this._currentColor2,this._fragUniformBufferLayout.color2)}_UpdatePointColorUniform(){this._UpdateFragmentUniformColor(this._currentPointColor,this._fragUniformBufferLayout.pointColor)}_UpdateFragmentUniformColor(e,t){e.writeToTypedArray(this._fragUniformf32,t.offset/4),this._MarkFragUniformBufferRangeChanged(t)}_UpdateFragmentUniformVec2(e,t){e.writeToTypedArray(this._fragUniformf32,t.offset/4),this._MarkFragUniformBufferRangeChanged(t)}_MarkFragUniformBufferRangeChanged(e){const t=e.offset,s=e.end;2048&this._flags?(this._fragUniformUpdateStart=Math.min(this._fragUniformUpdateStart,t),this._fragUniformUpdateEnd=Math.max(this._fragUniformUpdateEnd,s)):(this._flags|=2048,this._fragUniformUpdateStart=t,this._fragUniformUpdateEnd=s,this._MaybeEndRenderPass())}_MaybeUpdateFragmentC3ParamsFloat(e,t){this._fragC3Paramsf32[t.offset/4]!==Math.fround(e)&&(this._fragC3Paramsf32[t.offset/4]=e,this._MarkFragC3ParamsRangeChanged(t))}_MaybeUpdateFragmentC3ParamsUint(e,t){this._fragC3Paramsu32[t.offset/4]!==e&&(this._fragC3Paramsu32[t.offset/4]=e,this._MarkFragC3ParamsRangeChanged(t))}_MaybeUpdateFragmentC3ParamsRect(e,t){e.equalsF32Array(this._fragC3Paramsf32,t.offset/4)||(e.writeToTypedArray(this._fragC3Paramsf32,t.offset/4),this._MarkFragC3ParamsRangeChanged(t))}_MarkFragC3ParamsRangeChanged(e){const t=e.offset,s=e.end;4096&this._flags?(this._fragC3ParamsUpdateStart=Math.min(this._fragC3ParamsUpdateStart,t),this._fragC3ParamsUpdateEnd=Math.max(this._fragC3ParamsUpdateEnd,s)):(this._flags|=4096,this._fragC3ParamsUpdateStart=t,this._fragC3ParamsUpdateEnd=s,this._MaybeEndRenderPass())}_WriteUniformBuffers(){const e=this._flags;512&e&&(Jc.multiply(this._matTransform,this._matP,this._matMV),this._vertexUniformf32.set(this._matTransform,this._vertexUniformBufferLayout.transform.offset/4)),1024&e&&this._bufferManager.UpdateBufferSubData(this._commandEncoder,this._vertexUniformBuffer,this._vertexUniformArrayBuffer,this._vertexUniformUpdateStart,this._vertexUniformUpdateEnd-this._vertexUniformUpdateStart),2048&e&&this._bufferManager.UpdateBufferSubData(this._commandEncoder,this._fragmentUniformBuffer,this._fragUniformArrayBuffer,this._fragUniformUpdateStart,this._fragUniformUpdateEnd-this._fragUniformUpdateStart),4096&e&&this._bufferManager.UpdateBufferSubData(this._commandEncoder,this._fragmentC3ParamsBuffer,this._fragC3ParamsArrayBuffer,this._fragC3ParamsUpdateStart,this._fragC3ParamsUpdateEnd-this._fragC3ParamsUpdateStart),this._flags=-7681&e|16384}CreateRenderTarget(e){let t=this._width,s=this._height,i=!0;if(e&&("number"==typeof e.width&&(t=Math.floor(e.width),i=!1),"number"==typeof e.height&&(s=Math.floor(e.height),i=!1)),t<=0||s<=0)throw new Error("invalid size");this.EndBatch();const r=Xc.New(Xc.Gfx.WebGPURenderTarget,this);return r._Create(t,s,Object.assign({isDefaultSize:i},e)),r}SetRenderTarget(e,t=!0){null===e&&(e=this._backbufferRenderTarget),this._currentRenderTarget!==e&&(this._MaybeEndRenderPass(),this._currentRenderTarget=e,this._SetFlag(2097152,e.HasDepthBuffer()),e.IsDefaultSize()&&!e.IsBackBuffer()&&e._Resize(this._width,this._height),t&&this.SetDefaultRenderTargetProjectionState())}InvalidateRenderTarget(e){}GetRenderTarget(){return this._currentRenderTarget===this._backbufferRenderTarget?null:this._currentRenderTarget}GetRenderTargetSize(e){return null===e?[this._width,this._height]:[e.GetWidth(),e.GetHeight()]}GetBackbufferRenderTarget(){return this._backbufferRenderTarget}DeleteRenderTarget(e){this.EndBatch(),this._currentRenderTarget===e&&this.SetRenderTarget(null);const t=e.GetTexture();this._currentTexture===t&&this.SetTexture(null),this._currentBackTexture===t&&this.SetBackTexture(null),e._Delete()}async ReadBackRenderTargetToImageData(e,t,s){this._MaybeDoPendingClearRenderPass(e),this.EndBatch(),null===e&&(e=this._backbufferRenderTarget);const i=this._device,r=e.GetWidth(),n=e.GetHeight();let a=0,o=0,l=r,h=n;if(s){a=Xc.clamp(Math.floor(s.getLeft()),0,r-1),o=Xc.clamp(Math.floor(s.getTop()),0,n-1);let e=s.width();e=0===e?r-a:Xc.clamp(Math.floor(e),0,r-a);let t=s.height();t=0===t?n-o:Xc.clamp(Math.floor(t),0,n-o),l=e,h=t}const u=i.createCommandEncoder(),c=e.GetTexture();let d=c._GetTexture(),p=null;"rgba8unorm"===c._GetFormat()?c.CanReadPixels()||Xc.NotYetImplemented():(p=this._ConvertTextureFormat(c,"rgba8unorm",u),d=p);const _=4*l,m=256*Math.ceil(_/256),f=i.createBuffer({size:m*h,usage:Zc.MAP_READ|Zc.COPY_DST});u.copyTextureToBuffer({texture:d,origin:[a,o,0]},{buffer:f,bytesPerRow:m},[l,h,1]);const g=u.finish();i.queue.submit([g]),p&&p.destroy(),await f.mapAsync(self.GPUMapMode.READ);const y=f.getMappedRange().slice(0);let S;if(m===_)S=new ImageData(new Uint8ClampedArray(y),l,h);else{const e=new ArrayBuffer(_*h),t=new Uint8Array(e);for(let e=0;e<h;++e){const s=e*m,i=e*_;t.set(new Uint8Array(y,s,_),i)}S=new ImageData(new Uint8ClampedArray(e),l,h)}return f.destroy(),S}_ConvertTextureFormat(e,t,s){const i=this._device,r=e.GetWidth(),n=e.GetHeight();if(e._GetFormat()===t)throw new Error("no conversion necessary");e.IsSampled()||Xc.NotYetImplemented();const a=i.createTexture({size:[r,n,1],format:t,usage:sd.COPY_SRC|sd.RENDER_ATTACHMENT}),o=this._mipmapGeneratorProgram._GetMipmapGeneratorPipeline(t),l=o.getBindGroupLayout(0),h=this._GetSampler({sampling:"nearest"}),u=e._GetTexture().createView({baseMipLevel:0,mipLevelCount:1}),c=a.createView({baseMipLevel:0,mipLevelCount:1}),d=s.beginRenderPass({colorAttachments:[{view:c,loadOp:"clear",clearValue:[0,0,0,0],storeOp:"store"}]}),p=i.createBindGroup({layout:l,entries:[{binding:0,resource:h},{binding:1,resource:u}]});return d.setPipeline(o),d.setBindGroup(0,p),d.draw(4),d.end(),a}SetDepthEnabled(e){524288&this._flags&&(e=!!e,!!(1048576&this._flags)!==e&&(2097152&this._flags&&this._MaybeEndRenderPass(),this._SetFlag(1048576,e)))}IsDepthEnabled(){return this._IsFlagSet(1048576)}UsesDepthBuffer(){return this._IsFlagSet(524288)}SetDepthSamplingEnabled(e){if(!this._canSampleDepth)return;if(e&&this.IsDepthEnabled())throw new Error("depth still enabled");const t=e?this._depthBufferBindGroup:this._nullDepthBufferBindGroup;this._currentDepthTextureBindGroup!==t&&(this._MaybeEndDrawBatch(),this._currentDepthTextureBindGroup=t,this._flags|=256)}Clear(e){this._MaybeEndRenderPass(),this._currentRenderTarget._SetIsAwaitingClear(!0),this._currentRenderTarget._GetClearColor().set(e)}ClearRgba(e,t,s,i){this._MaybeEndRenderPass(),this._currentRenderTarget._SetIsAwaitingClear(!0),this._currentRenderTarget._GetClearColor().setRgba(e,t,s,i)}ClearDepth(){2621440&~this._flags||(this._MaybeEndRenderPass(),this._flags|=4194304)}SetScissorRect(e,t,s,i){e=Math.floor(e),t=Math.floor(t),s=Math.floor(s),i=Math.floor(i),4&this._flags&&this._scissorRect.equalsWH(e,t,s,i)||(this._MaybeEndDrawBatch(),this._flags|=12,this._scissorRect.setWH(e,t,s,i))}RemoveScissorRect(){4&this._flags&&(this._MaybeEndDrawBatch(),this._flags&=-5,this._flags|=8)}GetTextureFillShaderProgram(){return 65536&this._flags?this._spTextureFill:this._spSingleTextureFill}SetTextureFillMode(){this.SetProgram(this.GetTextureFillShaderProgram())}SetProgram(e){if(this._currentProgram!==e){if(e===this._spTextureFill&&!(65536&this._flags))throw new Error("cannot set multitexture fill program when multitexturing not allowed");this._MaybeEndDrawBatch(),this._currentProgram=e,this._currentStateGroup=null,this._flags|=32,this._SetMultiTexturingEnabled(e===this._spTextureFill)}}GetProgram(){return this._currentProgram}_SetMultiTexturingEnabled(e){if(e=!!e,!!(131072&this._flags)===e)return;this._SetFlag(131072,e);const t=null===this._currentTexture?this._nullTexture:this._currentTexture;this._ApplyTextureBindGroup(t)}_SetMultiTexturingActive(e){e=!!e,!!(262144&this._flags)!==e&&(this._MaybeEndDrawBatch(),this._SetFlag(262144,e),this._SetFlag(32,!0))}SetNormalizedCoordsProgramVariant(e){e=!!e,!!(1073741824&this._flags)!==e&&(this._MaybeEndDrawBatch(),this._SetFlag(1073741824,e),this._flags|=32)}IsNormalizedCoordsProgramVariant(){return this._IsFlagSet(1073741824)}SetTexture(e){e!==this._currentTexture&&(this._currentTexture=e,null===e&&(e=this._nullTexture),this._ApplyTextureBindGroup(e))}_ApplyTextureBindGroup(e){if(131072&this._flags){const t=e._GetMultiTextureBindGroup();if(null!==t)return this._SetTextureBindGroup(t),this._currentMultiTextureIndex=e._GetMultiTextureIndex(),void this._SetMultiTexturingActive(!0)}this._SetTextureBindGroup(e._GetOwnTextureBindGroup()),this._currentMultiTextureIndex=0,this._SetMultiTexturingActive(!1)}_SetTextureBindGroup(e){e!==this._currentTextureBindGroup&&(this._MaybeEndDrawBatch(),this._currentTextureBindGroup=e,this._flags|=64)}_OnTextureBindGroupChanged(e){this._currentTexture===e&&(this._MaybeEndDrawBatch(),this._currentTextureBindGroup=e._GetOwnTextureBindGroup(),this._flags|=64)}_OnMultiTextureBindGroupReleased(e){if(this._currentTextureBindGroup!==e)return;this._MaybeEndDrawBatch();const t=null===this._currentTexture?this._nullTexture:this._currentTexture;this._currentTextureBindGroup=t._GetOwnTextureBindGroup(),this._currentMultiTextureIndex=0,this._flags|=64}SetBackTexture(e){e!==this._currentBackTexture&&(this._currentBackTexture=e,null===e&&(e=this._nullTexture),this._MaybeEndDrawBatch(),this._currentBackTextureBindGroup=e._GetBackTextureBindGroup(),this._flags|=128)}CopyTextureToTexture(e,t,s,i,r,n){const a=e._GetUsage(),o=t._GetUsage();if(0===(a&sd.COPY_SRC))throw new Error("source texture missing COPY_SRC usage");if(0===(o&sd.COPY_DST))throw new Error("destination texture missing COPY_DST usage");if(e===t)throw new Error("invalid destination");const l=Math.min(e.GetWidth(),t.GetWidth()),h=Math.min(e.GetHeight(),t.GetHeight());r=Math.min(r,l-s),n=Math.min(n,h-i),r<=0||n<=0||(this._MaybeEndRenderPass(),this._commandEncoder.copyTextureToTexture({texture:e._GetTexture(),origin:[s,i]},{texture:t._GetTexture(),origin:[s,i]},[r,n]),this._flags|=16384)}_ClampToSupportedMultisampleValues(e){return e>=2?4:1}SetRenderingToMultisampleCount(e){e=this._ClampToSupportedMultisampleValues(e),this._currentMultisampleCount!==e&&(this._MaybeEndDrawBatch(),this._currentMultisampleCount=e,this._flags|=32)}SetBlendMode(e){e!==this._currentBlendMode&&(this._MaybeEndDrawBatch(),this._currentBlendMode=e,this._currentStateGroup=null,this._flags|=32)}SetNamedBlendMode(e){this.SetBlendMode(this.NamedBlendToNumber(e))}SetAlphaBlend(){this.SetBlendMode(0)}SetCopyBlend(){this.SetBlendMode(3)}SetColorRgba(e,t,s,i){const r=this._currentColor;r.equalsRgba(e,t,s,i)||(r.setRgba(e,t,s,i),this._currentStateGroup=null)}SetOpacity(e){const t=this._currentColor;t.getA()!==e&&(t.setA(e),this._currentStateGroup=null)}GetOpacity(){return this._currentColor.getA()}SetColor(e){const t=this._currentColor;t.equals(e)||(t.set(e),this._currentStateGroup=null)}ResetColor(){this.SetColorRgba(1,1,1,1)}GetColor(){return this._currentColor}SetCullFaceMode(e){e!==this._currentCullFace&&(this._MaybeEndDrawBatch(),this._currentCullFace=e,this._currentStateGroup=null,this._flags|=32)}GetCullFaceMode(){return this._currentCullFace}SetFrontFaceWinding(e){e!==this._currentFrontFaceWinding&&(this._MaybeEndDrawBatch(),this._currentFrontFaceWinding=e,this._currentStateGroup=null,this._flags|=32)}GetFrontFaceWinding(){return this._currentFrontFaceWinding}Rect(e){this.Rect2(e.getLeft(),e.getTop(),e.getRight(),e.getBottom())}Rect2(e,t,s,i){this.Quad2(e,t,s,t,s,i,e,i)}_WriteQuadTexIndices(e){const t=this._texIndexData,s=this._currentMultiTextureIndex;t[e++]=s,t[e++]=s,t[e++]=s,t[e]=s}Quad(e){this.Quad4(e,$d)}Quad2(e,t,s,i,r,n,a,o){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const l=this._vertexData,h=this._vertexPtr;this._vertexPtr+=4;let u=3*h;const c=this._baseZ+this._currentZ;l[u++]=e,l[u++]=t,l[u++]=c,l[u++]=s,l[u++]=i,l[u++]=c,l[u++]=r,l[u++]=n,l[u++]=c,l[u++]=a,l[u++]=o,l[u]=c,$d.writeToTypedArray(this._texcoordData,2*h),262144&this._flags&&this._WriteQuadTexIndices(h),this._currentColor.writeToTypedArrayx4(this._colorData,4*h)}Quad3(e,t){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const s=this._vertexPtr;this._vertexPtr+=4,e.writeToTypedArray3D(this._vertexData,3*s,this._baseZ+this._currentZ),t.writeAsQuadToTypedArray(this._texcoordData,2*s),262144&this._flags&&this._WriteQuadTexIndices(s),this._currentColor.writeToTypedArrayx4(this._colorData,4*s)}Quad4(e,t){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const s=this._vertexPtr;this._vertexPtr+=4,e.writeToTypedArray3D(this._vertexData,3*s,this._baseZ+this._currentZ),t.writeToTypedArray(this._texcoordData,2*s),262144&this._flags&&this._WriteQuadTexIndices(s),this._currentColor.writeToTypedArrayx4(this._colorData,4*s)}Quad5(e,t,s){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const i=this._vertexPtr;this._vertexPtr+=4,e.writeToTypedArray3D(this._vertexData,3*i,this._baseZ+this._currentZ),t.writeToTypedArray(this._texcoordData,2*i),262144&this._flags&&this._WriteQuadTexIndices(i),this._colorData.set(s,4*i)}Quad3D(e,t,s,i,r,n,a,o,l,h,u,c,d){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const p=this._vertexData,_=this._vertexPtr;this._vertexPtr+=4;let m=3*_;const f=this._baseZ+this._currentZ;p[m++]=e,p[m++]=t,p[m++]=f+s,p[m++]=i,p[m++]=r,p[m++]=f+n,p[m++]=a,p[m++]=o,p[m++]=f+l,p[m++]=h,p[m++]=u,p[m]=f+c,d.writeAsQuadToTypedArray(this._texcoordData,2*_),262144&this._flags&&this._WriteQuadTexIndices(_),this._currentColor.writeToTypedArrayx4(this._colorData,4*_)}Quad3D2(e,t,s,i,r,n,a,o,l,h,u,c,d){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const p=this._vertexData,_=this._vertexPtr;this._vertexPtr+=4;let m=3*_;const f=this._baseZ+this._currentZ;p[m++]=e,p[m++]=t,p[m++]=f+s,p[m++]=i,p[m++]=r,p[m++]=f+n,p[m++]=a,p[m++]=o,p[m++]=f+l,p[m++]=h,p[m++]=u,p[m]=f+c,d.writeToTypedArray(this._texcoordData,2*_),262144&this._flags&&this._WriteQuadTexIndices(_),this._currentColor.writeToTypedArrayx4(this._colorData,4*_)}Quad3D3(e,t,s,i,r,n,a,o,l,h,u,c,d,p){this._AddToDrawBatch(4,6),this._AddIndicesForQuad();const _=this._vertexData,m=this._vertexPtr;this._vertexPtr+=4;let f=3*m;const g=this._baseZ+this._currentZ;_[f++]=e,_[f++]=t,_[f++]=g+s,_[f++]=i,_[f++]=r,_[f++]=g+n,_[f++]=a,_[f++]=o,_[f++]=g+l,_[f++]=h,_[f++]=u,_[f]=g+c,d.writeToTypedArray(this._texcoordData,2*m),262144&this._flags&&this._WriteQuadTexIndices(m),this._colorData.set(p,4*m)}DrawMesh(e,t,s,i){if(e.length%3!=0)throw new Error("vertex buffer length not multiple of 3");if(e.length>196605)throw new Error(`too many vertices (${e.length/3}, limit 65535)`);if(s.length%3!=0)throw new Error("index buffer length not multiple of 3");if(s.length>393210)throw new Error(`too many indices (${s.length}, limit 393210)`);this._AddToDrawBatch(e.length,s.length);const r=this._vertexPtr;this._vertexData.set(e,3*r),this._texcoordData.set(t,2*r),262144&this._flags&&this._texIndexData.fill(this._currentMultiTextureIndex,r,r+e.length);const n=this._indexData;if(0===r)n.set(s,this._indexPtr);else{let e=this._indexPtr;for(let t=0,i=s.length;t<i;++t)n[e++]=s[t]+r}const a=this._colorData;if(void 0!==i)a.set(i,4*r);else{const t=this._currentColor,s=t.getR(),i=t.getG(),n=t.getB(),o=t.getA();let l=4*r;for(let t=0,r=e.length;t<r;++t)a[l++]=s,a[l++]=i,a[l++]=n,a[l++]=o}this._vertexPtr+=e.length/3,this._indexPtr+=s.length}StartRenderingPoints(e){this._currentPointTexCoords.equals(e)||(this._currentPointTexCoords.copy(e),this._UpdatePointTexCoordsUniform());const t=this._baseZ+this._currentZ;this._currentVertexZElevation!==t&&(this._currentVertexZElevation=t,this._UpdateZElevationUniform()),this._currentPointColor.equals(this._currentColor)||(this._currentPointColor.copy(this._currentColor),this._UpdatePointColorUniform()),this.SetProgram(this.GetPointsRenderingProgram()),this._drawIndexCount=0,this._flags|=18}FinishRenderingPoints(){this._drawIndexCount>0&&this._MaybeEndDrawBatch(),this._flags&=-3,this._flags|=16}Point(e,t,s,i){let r=this._pointPtr;r>ld&&(this.EndBatch(),r=0),1&this._flags?this._drawIndexCount+=6:(null===this._currentRenderPass&&this._BeginRenderPass(),this._flags|=1,this._drawFirstIndex=r/4*6,this._drawIndexCount=6);const n=this._pointData;n[r++]=e,n[r++]=t,n[r++]=s,n[r++]=i,this._pointPtr=r}SetGradientColor(e){this._currentColor2.equals(e)||(this._currentColor2.copy(e),this._UpdateColor2Uniform())}SetEllipseParams(e,t,s=1){const i=this._fragUniformBufferLayout,r=this._fragUniformf32;Kd.set(e,t),Kd.equalsF32Array(r,i.pixelSize.offset/4)||this._UpdateFragmentUniformVec2(Kd,i.pixelSize),r[i.outlineThickness.offset/4]!==Math.fround(s)&&(r[i.outlineThickness.offset/4]=s,this._MarkFragUniformBufferRangeChanged(i.outlineThickness))}SetTilemapInfo(e,t,s,i,r,n,a){const o=this._fragUniformBufferLayout,l=this._fragUniformf32;e.equalsF32Array(l,o.srcRect.offset/4)||(e.writeToTypedArray(l,o.srcRect.offset/4),this._MarkFragUniformBufferRangeChanged(o.srcRect)),Kd.set(i/t,r/s),Kd.equalsF32Array(l,o.tileSize.offset/4)||this._UpdateFragmentUniformVec2(Kd,o.tileSize),Kd.set(n/t,a/s),Kd.equalsF32Array(l,o.tileSpacing.offset/4)||this._UpdateFragmentUniformVec2(Kd,o.tileSpacing)}SetTileRandomizationInfo(e,t,s,i,r,n,a){const o=this._fragUniformBufferLayout,l=this._fragUniformf32;Kd.set(s,i),Kd.equalsF32Array(l,o.tileSize.offset/4)||this._UpdateFragmentUniformVec2(Kd,o.tileSize),l[o.outlineThickness.offset/4]!==Math.fround(r)&&(l[o.outlineThickness.offset/4]=r,this._MarkFragUniformBufferRangeChanged(o.outlineThickness)),Kd.set(n,a),Kd.equalsF32Array(l,o.tileSpacing.offset/4)||this._UpdateFragmentUniformVec2(Kd,o.tileSpacing)}SetProgramParameters(e,t,s,i,r,n,a,o,l,h,u){const c=this._fragC3ParamsLayout,d=this._currentProgram;u%=10800,d.BlendsBackground()&&this.SetBackTexture(e),d.UsesAnyC3ParamRect()&&(this._MaybeUpdateFragmentC3ParamsRect(t,c.destRect),this._MaybeUpdateFragmentC3ParamsRect(s,c.srcRect),this._MaybeUpdateFragmentC3ParamsRect(i,c.srcOriginRect),this._MaybeUpdateFragmentC3ParamsRect(r,c.layoutRect)),this._MaybeUpdateFragmentC3ParamsFloat(o,c.devicePixelRatio),this._MaybeUpdateFragmentC3ParamsFloat(l,c.layerScale),this._MaybeUpdateFragmentC3ParamsFloat(h,c.layerAngle),this._MaybeUpdateFragmentC3ParamsFloat(u,c.seconds),this._MaybeUpdateFragmentC3ParamsFloat(this.GetNearZ(),c.zNear),this._MaybeUpdateFragmentC3ParamsFloat(this.GetFarZ(),c.zFar)}SetProgramCustomParameters(e){e&&(e.IsChanged()&&(this._MaybeEndRenderPass(),e.UpdateBuffer(this._commandEncoder)),this._SetBufferBindGroup(e.GetBufferBindGroup()))}SetProgramParameter_IsSrcTexRotated(e){this._MaybeUpdateFragmentC3ParamsUint(e?1:0,this._fragC3ParamsLayout.isSrcTexRotated)}_SetBufferBindGroup(e){e!==this._currentBufferBindGroup&&(this._MaybeEndDrawBatch(),this._currentBufferBindGroup=e,this._flags|=8192)}_OnBufferBindGroupDestroyed(e){this._currentBufferBindGroup===e&&this._SetBufferBindGroup(this._defaultBufferBindGroup)}CopyRenderTarget(e){if(e._IsAwaitingClear())return this._currentRenderTarget._SetIsAwaitingClear(!0),void this._currentRenderTarget._GetClearColor().set(e._GetClearColor());e.GetMultisampling()>=2&&this._currentRenderTarget.GetMultisampling()<2?this._ResolveMultisampledRenderTarget(e):(this.ClearRgba(0,0,0,0),this.SetCopyBlend(),this.ResetColor(),this.DrawRenderTarget(e))}DrawRenderTarget(e){this._MaybeDoPendingClearRenderPass(e);const t=e.GetTexture();this.SetTexture(t),this.FullscreenQuad()}FullscreenQuad(){const e=this.IsNormalizedCoordsProgramVariant();e||this.SetNormalizedCoordsProgramVariant(!0),this.SetCurrentZ(0);const t=Zd,s=Jd;t.set(0,-1,0,-1,2,1,0,1),s.set(0,-1,2,1),this.Quad3(t,s),e||this.SetNormalizedCoordsProgramVariant(!1)}_ResolveMultisampledRenderTarget(e){this._MaybeDoPendingClearRenderPass(e),this._MaybeEndRenderPass(),this._commandEncoder.beginRenderPass({colorAttachments:[{view:e.GetTexture()._GetTextureView(),resolveTarget:this._currentRenderTarget.GetTexture()._GetTextureView(),loadOp:"load",storeOp:"store"}]}).end(),this._flags|=16384}CoplanarStartStencilPass(){this._MaybeEndRenderPass(),this.SetDepthEnabled(!0),this._flags|=41943040}CoplanarStartColorPass(){this._MaybeEndRenderPass(),this.SetDepthEnabled(!1),this._flags&=-8388609,this._flags|=16777216}IsCoplanarColorPass(){return this._IsFlagSet(16777216)}CoplanarRestoreStandardRendering(){this._MaybeEndRenderPass(),this.SetDepthEnabled(!0),this._flags&=-16777217}_InitBlendModes(){this._InitBlendModeData([["normal","one","one-minus-src-alpha"],["additive","one","one"],["xor","one","one-minus-src-alpha"],["copy","one","zero"],["destination-over","one-minus-dst-alpha","one"],["source-in","dst-alpha","zero"],["destination-in","zero","src-alpha"],["source-out","one-minus-dst-alpha","zero"],["destination-out","zero","one-minus-src-alpha"],["source-atop","dst-alpha","one-minus-src-alpha"],["destination-atop","one-minus-dst-alpha","src-alpha"]])}GetAvailableAdapterFeatures(){return this._adapter?[...this._adapter.features]:[]}GetAdapterInfo(){return this._adapterInfo}GetAdapterInfoString(){const e=this._adapterInfo;if(!e)return"unknown/unknown";const t=e.vendor||"unknown",s=e.architecture||"unknown",i=[];return e.device&&i.push(e.device),e.description&&i.push(e.description),e.type&&i.push(e.type),e.backend&&i.push(e.backend),t+"/"+s+(i.length>0?` (${i.join(", ")})`:"")}}}{const ep=self.C3,tp=!0;ep.Gfx.WebGPUBufferManager=class{constructor(e){this._renderer=e,this._buffers=new Map,this._recycleAfterSubmit=[],this._releaseAfterSubmit=[],this._destroyAfterSubmit=[],this._totalBufferCount=0,this._totalBufferSize=0,this._totalCreated=0,this._totalReleased=0,this._totalReturned=0,this._totalRecycled=0}GetRenderer(){return this._renderer}OnContextLost(){this._buffers.clear(),ep.clearArray(this._recycleAfterSubmit),ep.clearArray(this._releaseAfterSubmit),ep.clearArray(this._destroyAfterSubmit)}_RoundBufferSizeClass(e){return Math.max(ep.nextHighestPowerOfTwo(e),16)}GetRecyclableBuffer(e){this._totalReturned++;const t=this._RoundBufferSizeClass(e);{const e=this._buffers.get(t);if(void 0!==e&&e.length>0){const s=e.pop();return s.MarkInUse(),0===e.length&&this._buffers.delete(t),s}}return this._totalBufferCount++,this._totalBufferSize+=t,this._totalCreated++,ep.New(ep.Gfx.WebGPURecyclableBuffer,this,t)}_AddRecycledBuffer(e){this._totalRecycled++;const t=e.GetSize(),s=this._buffers.get(t);void 0===s?this._buffers.set(t,[e]):s.push(e)}_DestroyAfterSubmit(e){this._destroyAfterSubmit.push(e)}AfterSubmit(){for(const e of this._recycleAfterSubmit)e.Recycle();ep.clearArray(this._recycleAfterSubmit);for(const e of this._releaseAfterSubmit)this._totalBufferCount--,this._totalBufferSize-=e.GetSize(),e.Release();ep.clearArray(this._releaseAfterSubmit);for(const e of this._destroyAfterSubmit)e.destroy();ep.clearArray(this._destroyAfterSubmit)}MaybeCollectUnusedBuffers(e){e%30==0&&this._CollectUnusedBuffers(e)}_CollectUnusedBuffers(e){for(const[t,s]of this._buffers.entries()){let i=0;for(let t=0,r=s.length;t<r;++t){const r=s[t];r._ShouldCollect(e)?(this._totalBufferCount--,this._totalBufferSize-=r.GetSize(),r.Release(),this._totalReleased++):(s[i]=r,++i)}0===i?this._buffers.delete(t):ep.truncateArray(s,i)}this._DebugLogBufferMap()}UpdateBufferSubData(e,t,s,i,r){const n=this.GetRecyclableBuffer(r),a=n.GetBuffer(),o=a.getMappedRange(0,r);new Uint8Array(o).set(new Uint8Array(s,i,r)),a.unmap(),e.copyBufferToBuffer(a,0,t,i,r),this._recycleAfterSubmit.push(n)}_DebugLogBufferMap(){this._totalCreated=0,this._totalReleased=0,this._totalReturned=0,this._totalRecycled=0}}}{const sp=self.C3,ip=self.GPUBufferUsage,rp=self.GPUMapMode,np=self.assert,ap=0,op=1,lp=2;sp.Gfx.WebGPURecyclableBuffer=class{constructor(e,t){this._bufferManager=e,this._state=1,this._size=t,this._buffer=this.GetRenderer()._GetDevice().createBuffer({mappedAtCreation:!0,size:t,usage:ip.COPY_SRC|ip.MAP_WRITE}),this._recycledFrameNumber=0}GetRenderer(){return this._bufferManager.GetRenderer()}GetState(){return this._state}GetSize(){return this._size}GetBuffer(){return this._buffer}MarkInUse(){this._state=1}async Recycle(){this._state=2;try{await this._buffer.mapAsync(rp.WRITE)}catch(e){return void console.warn("[WebGPU] Error recycling buffer, assuming device was lost: ",e)}this.GetRenderer().IsContextLost()||(this._state=0,this._recycledFrameNumber=this.GetRenderer().GetFrameNumber(),this._bufferManager._AddRecycledBuffer(this))}Discard(){this._state=0}_ShouldCollect(e){return this._recycledFrameNumber<=e-25}Release(){this._buffer.destroy(),this._buffer=null,this._bufferManager=null}}}{const hp=self.C3,up=self.assert,cp=self.GPUBufferUsage;hp.Gfx.WebGPUEffectCustomParamsBuffer=class{constructor(e){const t=e.GetRenderer();this._shaderProgram=e,this._byteSize=e.GetCustomParametersByteSize(),this._arrayBuffer=new ArrayBuffer(this._byteSize),this._f32arr=new Float32Array(this._arrayBuffer),this._isChanged=!1,this._buffer=t._GetDevice().createBuffer({size:this._byteSize,usage:cp.UNIFORM|cp.COPY_DST}),this._bufferBindGroup=t._CreateBufferBindGroup(this._buffer)}Release(){this.GetRenderer()._OnBufferBindGroupDestroyed(this._bufferBindGroup),this.GetRenderer().GetBufferManager()._DestroyAfterSubmit(this._buffer),this._buffer=null,this._shaderProgram=null,this._arrayBuffer=null,this._f32arr=null,this._bufferBindGroup=null}GetRenderer(){return this._shaderProgram.GetRenderer()}GetShaderProgram(){return this._shaderProgram}GetBufferBindGroup(){return this._bufferBindGroup}SetParameterValue(e,t){const s=this._shaderProgram._GetCustomParameterInfo(e),i=s.type,r=s.offset/4,n=this._f32arr;if("color"===i){if(t.equalsRGBF32Array(n,r))return;t.writeRGBToTypedArray(n,r),this._isChanged=!0}else{if("float"!==i&&"percent"!==i)throw new Error(`unexpected shader param type '${i}'`);if(n[r]===Math.fround(t))return;n[r]=t,this._isChanged=!0}}IsChanged(){return this._isChanged}UpdateBuffer(e){this.GetRenderer().GetBufferManager().UpdateBufferSubData(e,this._buffer,this._arrayBuffer,0,this._byteSize),this._isChanged=!1}}}{let dp=function(e){for(const t of Object.values(e))t.end=t.offset+t.size},pp=function(e){const t=[];for(let s=0;s<e;++s)t.push(null);return t},_p=function(e){return`\nstruct FragmentInput {\n\t@location(1) fragUV : vec2<f32>,\n\t@location(2) fragColor : vec4<${e?"f16":"f32"}>,\n\t@builtin(position) fragPos : vec4<f32>\n};\n\nfn c3_getBackUV(fragPos : vec2<f32>, texBack : texture_2d<f32>) -> vec2<f32>\n{\n\treturn fragPos / vec2<f32>(textureDimensions(texBack));\n}\n\nfn c3_getDepthUV(fragPos : vec2<f32>, texDepth : texture_depth_2d) -> vec2<f32>\n{\n\treturn fragPos / vec2<f32>(textureDimensions(texDepth));\n}\n`},mp=function(e,t,s,i,r){return e<<10|t<<7|s<<5|i<<4|r};UpdateLayoutEndValues=dp,makeNullFilledArray=pp,GetFragmentInputStructDeclaration=_p,HashPipelineState=mp;const fp=self.C3,gp=4,yp=2,Sp=4,Tp=8,xp=16,bp=64,Gp="\nstruct Uniforms {\n\ttransform\t\t: mat4x4<f32>,\n\tpointTexStart\t: vec2<f32>,\n\tpointTexEnd\t\t: vec2<f32>,\n\tzElevation\t\t: f32\n};\n@binding(0) @group(0) var<uniform> uniforms : Uniforms;\n",Ip={transform:{offset:0,size:64,end:0},pointTex:{offset:64,size:16,end:0},pointTexStart:{offset:64,size:8,end:0},pointTexEnd:{offset:72,size:8,end:0},zElevation:{offset:80,size:4,end:0}};dp(Ip);const vp=Ip.zElevation.end,Cp="\nstruct Uniforms {\n\tcolor2\t\t\t\t: vec4<f32>,\n\tpointColor \t\t\t: vec4<f32>,\n\ttileSize\t\t\t: vec2<f32>,\n\ttileSpacing\t\t\t: vec2<f32>,\n\tsrcRectStart\t\t: vec2<f32>,\n\tsrcRectEnd\t\t\t: vec2<f32>,\n\tpixelSize\t\t\t: vec2<f32>,\n\toutlineThickness\t: f32\n};\n@binding(1) @group(0) var<uniform> uniforms : Uniforms;\n",wp={color2:{offset:0,size:16,end:0},pointColor:{offset:16,size:16,end:0},tileSize:{offset:32,size:8,end:0},tileSpacing:{offset:40,size:8,end:0},srcRect:{offset:48,size:16,end:0},srcRectStart:{offset:48,size:8,end:0},srcRectEnd:{offset:56,size:8,end:0},pixelSize:{offset:64,size:8,end:0},outlineThickness:{offset:72,size:4,end:0}};dp(wp);const Ap=wp.outlineThickness.end,Rp="\nstruct C3Params {\n\tsrcStart\t\t\t: vec2<f32>,\n\tsrcEnd\t\t\t\t: vec2<f32>,\n\tsrcOriginStart\t\t: vec2<f32>,\n\tsrcOriginEnd\t\t: vec2<f32>,\n\tlayoutStart\t\t\t: vec2<f32>,\n\tlayoutEnd\t\t\t: vec2<f32>,\n\tdestStart\t\t\t: vec2<f32>,\n\tdestEnd\t\t\t\t: vec2<f32>,\n\tdevicePixelRatio\t: f32,\n\tlayerScale\t\t\t: f32,\n\tlayerAngle\t\t\t: f32,\n\tseconds\t\t\t\t: f32,\n\tzNear\t\t\t\t: f32,\n\tzFar\t\t\t\t: f32,\n\tisSrcTexRotated\t\t: u32\n};\n@binding(4) @group(0) var<uniform> c3Params : C3Params;\n\nfn c3_srcToNorm(p : vec2<f32>) -> vec2<f32>\n{\n\treturn (p - c3Params.srcStart) / (c3Params.srcEnd - c3Params.srcStart);\n}\n\nfn c3_normToSrc(p : vec2<f32>) -> vec2<f32>\n{\n\treturn fma(p, c3Params.srcEnd - c3Params.srcStart, c3Params.srcStart);\n}\n\nfn c3_clampToSrc(p : vec2<f32>) -> vec2<f32>\n{\n\treturn clamp(p, min(c3Params.srcStart, c3Params.srcEnd), max(c3Params.srcStart, c3Params.srcEnd));\n}\n\nfn c3_srcOriginToNorm(p : vec2<f32>) -> vec2<f32>\n{\n\treturn (p - c3Params.srcOriginStart) / (c3Params.srcOriginEnd - c3Params.srcOriginStart);\n}\n\nfn c3_normToSrcOrigin(p : vec2<f32>) -> vec2<f32>\n{\n\treturn fma(p, c3Params.srcOriginEnd - c3Params.srcOriginStart, c3Params.srcOriginStart);\n}\n\nfn c3_clampToSrcOrigin(p : vec2<f32>) -> vec2<f32>\n{\n\treturn clamp(p, min(c3Params.srcOriginStart, c3Params.srcOriginEnd), max(c3Params.srcOriginStart, c3Params.srcOriginEnd));\n}\n\nfn c3_getLayoutPos(p : vec2<f32>) -> vec2<f32>\n{\n\treturn fma(p - c3Params.srcOriginStart, (c3Params.layoutEnd - c3Params.layoutStart) / (c3Params.srcOriginEnd - c3Params.srcOriginStart), c3Params.layoutStart);\n}\n\nfn c3_srcToDest(p : vec2<f32>) -> vec2<f32>\n{\n\treturn fma(p - c3Params.srcStart, (c3Params.destEnd - c3Params.destStart) / (c3Params.srcEnd - c3Params.srcStart), c3Params.destStart);\n}\n\nfn c3_clampToDest(p : vec2<f32>) -> vec2<f32>\n{\n\treturn clamp(p, min(c3Params.destStart, c3Params.destEnd), max(c3Params.destStart, c3Params.destEnd));\n}\n\nfn c3_linearizeDepth(depthSample : f32) -> f32\n{\n\treturn c3Params.zNear * c3Params.zFar / (c3Params.zFar + depthSample * (c3Params.zNear - c3Params.zFar));\n}\n",Pp=["srcStart","srcEnd","srcOriginStart","srcOriginEnd","c3_srcToNorm","c3_normToSrc","c3_clampToSrc","c3_srcOriginToNorm","c3_normToSrcOrigin","c3_clampToSrcOrigin","c3_getLayoutPos","c3_srcToDest"],Mp=["layoutStart","layoutEnd","destStart","destEnd","c3_clampToDest"],Ep={srcRect:{offset:0,size:16,end:0},srcStart:{offset:0,size:8,end:0},srcEnd:{offset:8,size:8,end:0},srcOriginRect:{offset:16,size:16,end:0},srcOriginStart:{offset:16,size:8,end:0},srcOriginEnd:{offset:24,size:8,end:0},layoutRect:{offset:32,size:16,end:0},layoutStart:{offset:32,size:8,end:0},layoutEnd:{offset:40,size:8,end:0},destRect:{offset:48,size:16,end:0},destStart:{offset:48,size:8,end:0},destEnd:{offset:56,size:8,end:0},devicePixelRatio:{offset:64,size:4,end:0},layerScale:{offset:68,size:4,end:0},layerAngle:{offset:72,size:4,end:0},seconds:{offset:76,size:4,end:0},zNear:{offset:80,size:4,end:0},zFar:{offset:84,size:4,end:0},isSrcTexRotated:{offset:88,size:4,end:0}};dp(Ep);const Dp=Ep.isSrcTexRotated.end,Np="\nstruct FragmentOutput {\n\t@location(0) color : vec4<f32>\n};\n",Fp=new Map([["float",4],["percent",4],["color",12]]),Op=new Map([["float",4],["percent",4],["color",16]]),Bp="\nfn c3_premultiply(c : vec4<f32>) -> vec4<f32>\n{\n\treturn vec4<f32>(c.rgb * c.a, c.a);\n}\n\nfn c3_unpremultiply(c : vec4<f32>) -> vec4<f32>\n{\n\tif (c.a == 0.0)\n\t{\n\t\treturn vec4<f32>(0.0);\n\t}\n\t\n\treturn vec4<f32>(c.rgb / c.a, c.a);\n}\n\nfn c3_grayscale(rgb : vec3<f32>) -> f32\n{\n\treturn dot(rgb, vec3<f32>(0.299, 0.587, 0.114));\n}\n\nfn c3_getPixelSize(t : texture_2d<f32>) -> vec2<f32>\n{\n\treturn vec2<f32>(1.0) / vec2<f32>(textureDimensions(t));\n}\n\nfn c3_clamp2(v : vec2<f32>, l : f32, u : f32) -> vec2<f32>\n{\n\treturn clamp(v, vec2<f32>(l), vec2<f32>(u));\n}\n\nfn c3_mod(x : f32, y : f32) -> f32\n{\n\treturn x - y * floor(x / y);\n}\n\nfn c3_mod2(x : vec2<f32>, y : vec2<f32>) -> vec2<f32>\n{\n\treturn x - y * floor(x / y);\n}\n\nfn c3_RGBtoHSL(color : vec3<f32>) -> vec3<f32>\n{\n\tvar hsl : vec3<f32> = vec3<f32>(0.0);\n\t\n\tvar fmin : f32 = min(min(color.r, color.g), color.b);\n\tvar fmax : f32 = max(max(color.r, color.g), color.b);\n\tvar delta : f32 = fmax - fmin;\n\n\thsl.z = (fmax + fmin) / 2.0;\n\n\tif (delta == 0.0)\n\t{\n\t\thsl.x = 0.0;\n\t\thsl.y = 0.0;\n\t}\n\telse \n\t{\n\t\tif (hsl.z < 0.5)\n\t\t{\n\t\t\thsl.y = delta / (fmax + fmin);\n\t\t}\n\t\telse\n\t\t{\n\t\t\thsl.y = delta / (2.0 - fmax - fmin);\n\t\t}\n\t\t\n\t\tvar dR : f32 = (((fmax - color.r) / 6.0) + (delta / 2.0)) / delta;\n\t\tvar dG : f32 = (((fmax - color.g) / 6.0) + (delta / 2.0)) / delta;\n\t\tvar dB : f32 = (((fmax - color.b) / 6.0) + (delta / 2.0)) / delta;\n\n\t\tif (color.r == fmax)\n\t\t{\n\t\t\thsl.x = dB - dG;\n\t\t}\n\t\telse if (color.g == fmax)\n\t\t{\n\t\t\thsl.x = (1.0 / 3.0) + dR - dB;\n\t\t}\n\t\telse if (color.b == fmax)\n\t\t{\n\t\t\thsl.x = (2.0 / 3.0) + dG - dR;\n\t\t}\n\n\t\tif (hsl.x < 0.0)\n\t\t{\n\t\t\thsl.x = hsl.x + 1.0;\n\t\t}\n\t\telse if (hsl.x > 1.0)\n\t\t{\n\t\t\thsl.x = hsl.x - 1.0;\n\t\t}\n\t}\n\n\treturn hsl;\n}\n\nfn c3_hueToRGB(f1 : f32, f2 : f32, hue_ : f32) -> f32\n{\n\tvar hue : f32 = hue_;\n\tif (hue < 0.0)\n\t{\n\t\thue = hue + 1.0;\n\t}\n\telse if (hue > 1.0)\n\t{\n\t\thue = hue - 1.0;\n\t}\n\t\t\n\tvar ret : f32;\n\t\n\tif ((6.0 * hue) < 1.0)\n\t{\n\t\tret = f1 + (f2 - f1) * 6.0 * hue;\n\t}\n\telse if ((2.0 * hue) < 1.0)\n\t{\n\t\tret = f2;\n\t}\n\telse if ((3.0 * hue) < 2.0)\n\t{\n\t\tret = f1 + (f2 - f1) * ((2.0 / 3.0) - hue) * 6.0;\n\t}\n\telse\n\t{\n\t\tret = f1;\n\t}\n\t\n\treturn ret;\n}\n\nfn c3_HSLtoRGB(hsl : vec3<f32>) -> vec3<f32>\n{\n\tvar rgb : vec3<f32> = vec3<f32>(hsl.z);\n\t\n\tif (hsl.y != 0.0)\n\t{\n\t\tvar f2 : f32;\n\t\t\n\t\tif (hsl.z < 0.5)\n\t\t{\n\t\t\tf2 = hsl.z * (1.0 + hsl.y);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tf2 = (hsl.z + hsl.y) - (hsl.y * hsl.z);\n\t\t}\n\t\t\t\n\t\tvar f1 : f32 = 2.0 * hsl.z - f2;\n\t\t\n\t\trgb.r = c3_hueToRGB(f1, f2, hsl.x + (1.0 / 3.0));\n\t\trgb.g = c3_hueToRGB(f1, f2, hsl.x);\n\t\trgb.b = c3_hueToRGB(f1, f2, hsl.x - (1.0 / 3.0));\n\t}\n\t\n\treturn rgb;\n}\n";fp.Gfx.WebGPUShaderProgram=class extends fp.Gfx.ShaderProgramBase{constructor(e,t){if(super(e,t),this._fragmentModule=t.fragmentModule,this._fragmentModuleFragDepth=t.fragmentModuleFragDepth,this._vertexModule=t.vertexModule,this._normVertexModule=t.normVertexModule,this._renderPipelineMap=new Map,this._mipmapPipelineMap=new Map,this._usesAnyC3ParamRect=!1,this._usesIsSrcTexRotated=!1,this._parameters=[],this._customParamsByteSize=0,t.parameters){let e=0;for(const s of t.parameters){const t=s[2];if(!Fp.has(t))throw new Error(`unrecognized effect param type '${t}'`);const i=Fp.get(t),r=Op.get(t),n=e%r;0!==n&&(e+=r-n),this._parameters.push({type:t,offset:e,size:i,end:e+i}),e+=i}this._customParamsByteSize=16*Math.ceil(e/16)}}static async Create(e,t){const s=e._GetDevice(),i=t.name,r=e.SupportsF16(),n=e.IsColorDataF16(),a=t.src,o=fp.Gfx.WebGPUShaderProgram._PreprocessFragmentShaderCode(a,r,n),l=s.createShaderModule({label:i,code:o});let h,u=null;if(t.srcFragDepth){const e=fp.Gfx.WebGPUShaderProgram._PreprocessFragmentShaderCode(t.srcFragDepth,r,n);u=s.createShaderModule({label:i,code:e})}l.getCompilationInfo().then(e=>fp.Gfx.WebGPUShaderProgram.ReportShaderCompilationInfo(i,"fragment",e));const c=fp.Gfx.WebGPUShaderProgram._PreprocessVertexShaderCode(t.vertexSrc,r);let d;c?(h=s.createShaderModule({label:i,code:c}),h.getCompilationInfo().then(e=>fp.Gfx.WebGPUShaderProgram.ReportShaderCompilationInfo(i,"vertex",e))):h=e._GetDefaultVertexModule();const p=fp.Gfx.WebGPUShaderProgram._PreprocessVertexShaderCode(t.normVertexSrc,r);p?(d=s.createShaderModule({label:i,code:p}),d.getCompilationInfo().then(e=>fp.Gfx.WebGPUShaderProgram.ReportShaderCompilationInfo(i,"vertex (norm)",e))):d=e._GetNormalizedVertexModule();const _=fp.New(fp.Gfx.WebGPUShaderProgram,e,Object.assign({fragmentModule:l,fragmentModuleFragDepth:u,vertexModule:h,normVertexModule:d},t));if(_._usesAnySrcRectOrPixelSize=a.includes("%%C3PARAMS_STRUCT%%")&&Pp.some(e=>a.includes(e)),_._usesAnyC3ParamRect=_._usesAnySrcRectOrPixelSize||a.includes("%%C3PARAMS_STRUCT%%")&&Mp.some(e=>a.includes(e)),_._usesIsSrcTexRotated=a.includes("%%C3PARAMS_STRUCT%%")&&a.includes("isSrcTexRotated"),"<generate-mipmap>"!==i){const t=_._CreateRenderPipelineAsync(0,0,0,0,0);let s=null;e.UsesDepthBuffer()&&(s=_._CreateRenderPipelineAsync(0,1,0,0,0));const[i,r]=await Promise.all([t,s]);_._renderPipelineMap.set(mp(0,0,0,0,0),i),r&&_._renderPipelineMap.set(mp(0,1,0,0,0),r)}return _}static _PreprocessShaderCode(e,t){if(!e)return e;let s="";return s=t?"enable f16;\nalias f16or32 = f16;\n":"alias f16or32 = f32;\n",s+e}static _PreprocessFragmentShaderCode(e,t,s){return e=fp.Gfx.WebGPUShaderProgram._PreprocessShaderCode(e,t),fp.StringSubstituteMap(e,{"%%SAMPLERFRONT_BINDING%%":"@binding(0) @group(1)","%%TEXTUREFRONT_BINDING%%":"@binding(1) @group(1)","%%SAMPLERBACK_BINDING%%":"@binding(0) @group(2)","%%TEXTUREBACK_BINDING%%":"@binding(1) @group(2)","%%SAMPLERDEPTH_BINDING%%":"@binding(0) @group(3)","%%TEXTUREDEPTH_BINDING%%":"@binding(1) @group(3)","%%SHADERPARAMS_BINDING%%":"@binding(5) @group(0)","%%FRAGMENTINPUT_STRUCT%%":_p(s),"%%FRAGMENTOUTPUT_STRUCT%%":Np,"%%C3PARAMS_STRUCT%%":Rp,"%%C3_UTILITY_FUNCTIONS%%":Bp})}static _PreprocessVertexShaderCode(e,t){return fp.Gfx.WebGPUShaderProgram._PreprocessShaderCode(e,t)}static ReportShaderCompilationInfo(e,t,s){for(const i of s.messages){const s=`[WebGPU] Message (${i.type}) compiling ${t} shader '${e}': ${i.message} (line ${i.lineNum}, pos ${i.linePos})`;"error"===i.type?console.error(s):"warning"===i.type?console.warn(s):console.log(s)}}Release(){this._fragmentModule=null,this._fragmentModuleFragDepth=null,this._vertexModule=null,this._normVertexModule=null,this._renderPipelineMap.clear(),this._mipmapPipelineMap.clear(),super.Release()}_GetDevice(){return this._renderer._GetDevice()}_GetPipelineLayout(){return this._renderer._GetPipelineLayout()}GetRenderer(){return this._renderer}UsesAnyC3ParamRect(){return this._usesAnyC3ParamRect}UsesIsSrcTexRotated(){return this._usesIsSrcTexRotated}GetParameterCount(){return this._parameters.length}GetParameterType(e){return e<0||e>=this._parameters.length?null:this._parameters[e].type}GetCustomParametersByteSize(){return this._customParamsByteSize}_GetCustomParameterInfo(e){return this._parameters[e]}_GetRenderPipelineDescriptor(e,t,s,i,r){const n=this._renderer,a=n.IsColorDataF16(),[o,l]=n._GetBlendByIndex(e);let h="none";switch(s){case 1:h="back";break;case 2:h="front"}const u={label:`${this.GetName()} blendMode ${e} variant ${t} multisampleCount ${r}`,layout:this._GetPipelineLayout(),primitive:{cullMode:h,frontFace:0===i?"cw":"ccw"},vertex:{module:4===t?this._normVertexModule:this._vertexModule,entryPoint:"main",buffers:[{arrayStride:12,attributes:[{shaderLocation:0,offset:0,format:"float32x3"}]},{arrayStride:8,attributes:[{shaderLocation:1,offset:0,format:"float32x2"}]},{arrayStride:4*(a?2:4),attributes:[{shaderLocation:2,offset:0,format:a?"float16x4":"float32x4"}]},{arrayStride:4,attributes:[{shaderLocation:3,offset:0,format:"uint32"}]}]},fragment:{module:this._fragmentModule,entryPoint:"main",targets:[{format:n.GetSwapChainFormat(),blend:{color:{srcFactor:o,dstFactor:l},alpha:{srcFactor:o,dstFactor:l}}}]}};if(r>=2&&(u.multisample={count:r}),1===t)u.fragment.module=this._fragmentModuleFragDepth||this._fragmentModule,u.depthStencil={format:n._GetDepthBufferFormat(),depthWriteEnabled:!0,depthCompare:"less-equal"};else if(2===t){u.fragment.module=this._fragmentModuleFragDepth||this._fragmentModule,u.fragment.targets=[];const e={compare:"always",failOp:"keep",depthFailOp:"keep",passOp:"replace"};u.depthStencil={format:n._GetDepthBufferFormat(),depthWriteEnabled:!0,depthCompare:"less-equal",stencilFront:e,stencilBack:e,stencilReadMask:1,stencilWriteMask:1}}else if(3===t){u.fragment.module=this._fragmentModuleFragDepth||this._fragmentModule;const e={compare:"equal",failOp:"keep",depthFailOp:"keep",passOp:"keep"};u.depthStencil={format:n._GetDepthBufferFormat(),depthWriteEnabled:!1,depthCompare:"always",stencilFront:e,stencilBack:e,stencilReadMask:1,stencilWriteMask:0}}return u}_CreateRenderPipeline(e,t,s,i,r){return this._GetDevice().createRenderPipeline(this._GetRenderPipelineDescriptor(e,t,s,i,r))}_CreateRenderPipelineAsync(e,t,s,i,r){return this._GetDevice().createRenderPipelineAsync(this._GetRenderPipelineDescriptor(e,t,s,i,r))}GetRenderPipelineForState(e,t,s,i,r){const n=mp(e,t,s,i,r);let a=this._renderPipelineMap.get(n);return a||(a=this._CreateRenderPipeline(e,t,s,i,r),this._renderPipelineMap.set(n,a),a)}static GetVertexUniformBufferLayout(){return Ip}static GetVertexUniformBufferSize(){return 16*Math.ceil(vp/16)}static GetFragmentUniformBufferLayout(){return wp}static GetFragmentUniformBufferSize(){return 16*Math.ceil(Ap/16)}static GetFragmentC3ParamsBufferLayout(){return Ep}static GetFragmentC3ParamsBufferSize(){return 16*Math.ceil(Dp/16)}static GetDefaultVertexShaderSource(e){const t=e?"f16":"f32";return`\n\t\t${Gp}\n\n\t\tstruct VertexInput {\n\t\t\t@location(0) position : vec3<f32>,\n\t\t\t@location(1) uv : vec2<f32>,\n\t\t\t@location(2) color : vec4<${t}>,\n\t\t\t@location(3) texIndex : u32\n\t\t};\n\n\t\tstruct VertexOutput {\n\t\t\t@builtin(position) Position : vec4<f32>,\n\t\t\t@location(1) fragUV : vec2<f32>,\n\t\t\t@location(2) fragColor : vec4<${t}>,\n\t\t\t@location(3) @interpolate(flat, either) texIndex : u32\n\t\t};\n\n\t\t@vertex\n\t\tfn main(input : VertexInput) -> VertexOutput {\n\t\t\tvar output : VertexOutput;\n\t\t\toutput.Position = uniforms.transform * vec4<f32>(input.position, 1.0);\n\t\t\toutput.fragUV = input.uv;\n\t\t\toutput.fragColor = input.color;\n\t\t\toutput.texIndex = input.texIndex;\n\t\t\treturn output;\n\t\t}`}static GetNormalizedVertexShaderSource(e){const t=e?"f16":"f32";return`\n\t\tstruct VertexInput {\n\t\t\t@location(0) position : vec3<f32>,\n\t\t\t@location(1) uv : vec2<f32>,\n\t\t\t@location(2) color : vec4<${t}>,\n\t\t\t@location(3) texIndex : u32\n\t\t};\n\n\t\tstruct VertexOutput {\n\t\t\t@builtin(position) Position : vec4<f32>,\n\t\t\t@location(1) fragUV : vec2<f32>,\n\t\t\t@location(2) fragColor : vec4<${t}>,\n\t\t\t@location(3) @interpolate(flat, either) texIndex : u32\n\t\t};\n\n\t\t@vertex\n\t\tfn main(input : VertexInput) -> VertexOutput {\n\t\t\tvar output : VertexOutput;\n\t\t\tvar p = input.position;\n\t\t\tp.y = 1.0 - p.y;\n\t\t\toutput.Position = vec4<f32>(p.xy * 2.0 - 1.0, p.z, 1.0);\n\t\t\toutput.fragUV = input.uv;\n\t\t\toutput.texIndex = input.texIndex;\n\t\t\toutput.fragColor = input.color;\n\t\t\treturn output;\n\t\t}`}static GetTextureFillVertexShaderSource(e){const t=e?"f16":"f32";return`\n\t\t${Gp}\n\n\t\tstruct VertexInput {\n\t\t\t@location(0) position : vec3<f32>,\n\t\t\t@location(1) uv : vec2<f32>,\n\t\t\t@location(2) color : vec4<${t}>,\n\t\t\t@location(3) texIndex : u32\n\t\t};\n\n\t\tstruct VertexOutput {\n\t\t\t@builtin(position) Position : vec4<f32>,\n\t\t\t@location(1) fragUV : vec2<f32>,\n\t\t\t@location(2) fragColor : vec4<${t}>,\n\t\t\t@location(3) @interpolate(flat, either) texIndex : u32\n\t\t};\n\n\t\t@vertex\n\t\tfn main(input : VertexInput) -> VertexOutput {\n\t\t\tvar output : VertexOutput;\n\t\t\toutput.Position = uniforms.transform * vec4<f32>(input.position, 1.0);\n\t\t\toutput.fragUV = input.uv;\n\t\t\toutput.fragColor = input.color;\n\t\t\toutput.texIndex = input.texIndex;\n\t\t\treturn output;\n\t\t}`}static GetNormalizedTextureFillVertexShaderSource(e){const t=e?"f16":"f32";return`\n\t\tstruct VertexInput {\n\t\t\t@location(0) position : vec3<f32>,\n\t\t\t@location(1) uv : vec2<f32>,\n\t\t\t@location(2) color : vec4<${t}>,\n\t\t\t@location(3) texIndex : u32\n\t\t};\n\n\t\tstruct VertexOutput {\n\t\t\t@builtin(position) Position : vec4<f32>,\n\t\t\t@location(1) fragUV : vec2<f32>,\n\t\t\t@location(2) fragColor : vec4<${t}>,\n\t\t\t@location(3) @interpolate(flat, either) texIndex : u32\n\t\t};\n\n\t\t@vertex\n\t\tfn main(input : VertexInput) -> VertexOutput {\n\t\t\tvar output : VertexOutput;\n\t\t\tvar p = input.position;\n\t\t\tp.y = 1.0 - p.y;\n\t\t\toutput.Position = vec4<f32>(p.xy * 2.0 - 1.0, p.z, 1.0);\n\t\t\toutput.fragUV = input.uv;\n\t\t\toutput.fragColor = input.color;\n\t\t\toutput.texIndex = input.texIndex;\n\t\t\treturn output;\n\t\t}`}static GetMultiTextureFillFragmentShaderSource(e,t){return`\n\t\t@binding(0) @group(1) var sampler0 : sampler;\n\t\t@binding(1) @group(1) var texture0 : texture_2d<f32>;\n\t\t@binding(2) @group(1) var sampler1 : sampler;\n\t\t@binding(3) @group(1) var texture1 : texture_2d<f32>;\n\t\t@binding(4) @group(1) var sampler2 : sampler;\n\t\t@binding(5) @group(1) var texture2 : texture_2d<f32>;\n\t\t@binding(6) @group(1) var sampler3 : sampler;\n\t\t@binding(7) @group(1) var texture3 : texture_2d<f32>;\n\t\t@binding(8) @group(1) var sampler4 : sampler;\n\t\t@binding(9) @group(1) var texture4 : texture_2d<f32>;\n\t\t@binding(10) @group(1) var sampler5 : sampler;\n\t\t@binding(11) @group(1) var texture5 : texture_2d<f32>;\n\t\t@binding(12) @group(1) var sampler6 : sampler;\n\t\t@binding(13) @group(1) var texture6 : texture_2d<f32>;\n\t\t@binding(14) @group(1) var sampler7 : sampler;\n\t\t@binding(15) @group(1) var texture7 : texture_2d<f32>;\n\t\t@binding(16) @group(1) var sampler8 : sampler;\n\t\t@binding(17) @group(1) var texture8 : texture_2d<f32>;\n\t\t@binding(18) @group(1) var sampler9 : sampler;\n\t\t@binding(19) @group(1) var texture9 : texture_2d<f32>;\n\t\t@binding(20) @group(1) var sampler10 : sampler;\n\t\t@binding(21) @group(1) var texture10 : texture_2d<f32>;\n\t\t@binding(22) @group(1) var sampler11 : sampler;\n\t\t@binding(23) @group(1) var texture11 : texture_2d<f32>;\n\t\t@binding(24) @group(1) var sampler12 : sampler;\n\t\t@binding(25) @group(1) var texture12 : texture_2d<f32>;\n\t\t@binding(26) @group(1) var sampler13 : sampler;\n\t\t@binding(27) @group(1) var texture13 : texture_2d<f32>;\n\n\t\tstruct FragmentInput {\n\t\t\t@location(1) fragUV : vec2<f32>,\n\t\t\t@location(2) fragColor : vec4<${t?"f16":"f32"}>,\n\t\t\t@location(3) @interpolate(flat, either) texIndex : u32,\n\t\t\t${e?"@builtin(position) fragPos: vec4<f32>":""}\n\t\t};\n\n\t\tstruct FragmentOutput {\n\t\t\t@location(0) color : vec4<f32>,\n\t\t\t${e?"@builtin(frag_depth) fragDepth: f32":""} \n\t\t};\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar texXy : vec2<f32> = input.fragUV.xy;\n\t\t\tvar texIndex : u32 = input.texIndex;\n\t\t\tvar c : vec4<f32>;\n\n\t\t\tlet dx = dpdx(texXy);\n\t\t\tlet dy = dpdy(texXy);\n\t\t\t\n\t\t\tif (texIndex <= 6)\n\t\t\t{\n\t\t\t\tif (texIndex <= 2)\n\t\t\t\t{\n\t\t\t\t\tif (texIndex == 0)\t\t\t{\tc = textureSampleGrad(texture0, sampler0, texXy, dx, dy);\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (texIndex == 1)\t\t{\tc = textureSampleGrad(texture1, sampler1, texXy, dx, dy);\t}\n\t\t\t\t\t\telse\t\t\t\t\t{\tc = textureSampleGrad(texture2, sampler2, texXy, dx, dy);\t}\n\t\t\t\t\t}\t\t\t\t\t\t\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tif (texIndex <= 4)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (texIndex == 3)\t\t{\tc = textureSampleGrad(texture3, sampler3, texXy, dx, dy);\t}\n\t\t\t\t\t\telse\t\t\t\t\t{\tc = textureSampleGrad(texture4, sampler4, texXy, dx, dy);\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (texIndex <= 5)\t\t{\tc = textureSampleGrad(texture5, sampler5, texXy, dx, dy);\t}\n\t\t\t\t\t\telse\t\t\t\t\t{\tc = textureSampleGrad(texture6, sampler6, texXy, dx, dy);\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (texIndex <= 9)\n\t\t\t\t{\n\t\t\t\t\tif (texIndex == 7)\t\t\t{\tc = textureSampleGrad(texture7, sampler7, texXy, dx, dy);\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (texIndex == 8)\t\t{\tc = textureSampleGrad(texture8, sampler8, texXy, dx, dy);\t}\n\t\t\t\t\t\telse\t\t\t\t\t{\tc = textureSampleGrad(texture9, sampler9, texXy, dx, dy);\t}\n\t\t\t\t\t}\t\t\t\t\t\t\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tif (texIndex <= 11)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (texIndex == 10)\t\t{\tc = textureSampleGrad(texture10, sampler10, texXy, dx, dy);\t}\n\t\t\t\t\t\telse\t\t\t\t\t{\tc = textureSampleGrad(texture11, sampler11, texXy, dx, dy);\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (texIndex == 12)\t\t{\tc = textureSampleGrad(texture12, sampler12, texXy, dx, dy);\t}\n\t\t\t\t\t\telse\t\t\t\t\t{\tc = textureSampleGrad(texture13, sampler13, texXy, dx, dy);\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\toutput.color = c * vec4<f32>(input.fragColor);\n\t\t\t${e?"output.fragDepth = select(input.fragPos.z, 1.0, output.color.a == 0.0);":""}\n\t\t\treturn output;\n\t\t}`}static GetSingleTextureFillFragmentShaderSource(e,t){return`\n\t\t@binding(0) @group(1) var sampler0 : sampler;\n\t\t@binding(1) @group(1) var texture0 : texture_2d<f32>;\n\n\t\tstruct FragmentInput {\n\t\t\t@location(1) fragUV : vec2<f32>,\n\t\t\t@location(2) fragColor : vec4<${t?"f16":"f32"}>,\n\t\t\t${e?"@builtin(position) fragPos: vec4<f32>":""}\n\t\t};\n\n\t\tstruct FragmentOutput {\n\t\t\t@location(0) color : vec4<f32>,\n\t\t\t${e?"@builtin(frag_depth) fragDepth: f32":""} \n\t\t};\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\toutput.color = textureSample(texture0, sampler0, input.fragUV) * vec4<f32>(input.fragColor);\n\t\t\t${e?"output.fragDepth = select(input.fragPos.z, 1.0, output.color.a == 0.0);":""}\n\t\t\treturn output;\n\t\t}`}static _GetMipmapGeneratorVertexSource(){return"\n\t\tstruct VertexInput {\n\t\t\t@builtin(vertex_index) VertexIndex : u32\n\t\t};\n\t\t\n\t\tstruct VertexOutput {\n\t\t\t@builtin(position) Position : vec4<f32>,\n\t\t\t@location(0) fragUV : vec2<f32>\n\t\t};\n\n\t\t@vertex\n\t\tfn main(input : VertexInput) -> VertexOutput {\n\n\t\t\tvar pos : array<vec2<f32>, 4> = array<vec2<f32>, 4>(\n\t\t\t\tvec2<f32>(-1.0, 1.0),\n\t\t\t\tvec2<f32>(1.0, 1.0),\n\t\t\t\tvec2<f32>(-1.0, -1.0),\n\t\t\t\tvec2<f32>(1.0, -1.0));\n\t\t\t\n\t\t\tvar output : VertexOutput;\n\t\t\tvar p : vec2<f32> = pos[input.VertexIndex];\n\t\t\toutput.Position = vec4<f32>(p, 0.0, 1.0);\n\t\t\toutput.fragUV = p / 2.0 + 0.5;\n\t\t\treturn output;\n\t\t}"}static _GetMipmapGeneratorFragmentSource(){return"\n\t\t@binding(0) @group(0) var sampler0 : sampler;\n\t\t@binding(1) @group(0) var texture0 : texture_2d<f32>;\n\n\t\tstruct FragmentInput {\n\t\t\t@location(0) fragUV : vec2<f32>\n\t\t};\n\n\t\tstruct FragmentOutput {\n\t\t\t@location(0) color : vec4<f32>\n\t\t};\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\toutput.color = textureSample(texture0, sampler0, vec2<f32>(input.fragUV.x, 1.0 - input.fragUV.y));\n\t\t\treturn output;\n\t\t}"}_GetMipmapGeneratorPipeline(e){e||(e=this._renderer.GetTextureFormat());let t=this._mipmapPipelineMap.get(e);return t||(t=this._GetDevice().createRenderPipeline({label:"<mipmap generator>",layout:"auto",vertex:{module:this._vertexModule,entryPoint:"main"},primitive:{topology:"triangle-strip",stripIndexFormat:"uint16"},fragment:{module:this._fragmentModule,entryPoint:"main",targets:[{format:e,blend:{color:{srcFactor:"one",dstFactor:"zero"},alpha:{srcFactor:"one",dstFactor:"zero"}}}]}}),this._mipmapPipelineMap.set(e,t)),t}static _GetPointVertexSource(){return`\n\t\t${Gp}\n\n\t\tstruct PointData {\n\t\t\tdata : array<vec4<f32>>\n\t\t};\n\t\t@binding(3) @group(0) var<storage> pointBuffer : PointData;\n\n\t\tstruct VertexInput {\n\t\t\t@builtin(vertex_index) VertexIndex : u32\n\t\t};\n\n\t\tstruct VertexOutput {\n\t\t\t@builtin(position) Position : vec4<f32>,\n\t\t\t@location(0) fragUV : vec2<f32>,\n\t\t\t@location(1) pointOpacity : f32\n\t\t};\n\n\t\t@vertex\n\t\tfn main(input : VertexInput) -> VertexOutput {\n\n\t\t\tvar normPos : array<vec2<f32>, 4> = array<vec2<f32>, 4>(\n\t\t\t\tvec2<f32>(-0.5, -0.5),\n\t\t\t\tvec2<f32>(0.5, -0.5),\n\t\t\t\tvec2<f32>(0.5, 0.5),\n\t\t\t\tvec2<f32>(-0.5, 0.5));\n\t\t\t\n\t\t\tvar output : VertexOutput;\n\t\t\tvar p : vec2<f32> = normPos[input.VertexIndex % u32(4)];\n\t\t\tvar pointData : vec4<f32> = pointBuffer.data[input.VertexIndex / u32(4)];\n\n\t\t\tvar size : f32 = pointData.z;\n\t\t\toutput.Position = uniforms.transform * vec4<f32>(p * size + pointData.xy, uniforms.zElevation, 1.0);\n\t\t\toutput.pointOpacity = pointData.w;\n\n\t\t\tvar pointTexMin : vec2<f32> = min(uniforms.pointTexStart, uniforms.pointTexEnd);\n\t\t\tvar pointTexMax : vec2<f32> = max(uniforms.pointTexStart, uniforms.pointTexEnd);\n\t\t\tvar pn : vec2<f32> = p + vec2<f32>(0.5, 0.5);\n\t\t\tvar pointCoord : vec2<f32> = select(vec2<f32>(1.0 - pn.y, pn.x), pn, uniforms.pointTexEnd.x > uniforms.pointTexStart.x);\n\n\t\t\toutput.fragUV = mix(pointTexMin, pointTexMax, pointCoord);\n\t\t\treturn output;\n\t\t}`}static _GetPointFragmentSource(e){return`\n\t\t${Cp}\n\n\t\t%%SAMPLERFRONT_BINDING%% var sampler0 : sampler;\n\t\t%%TEXTUREFRONT_BINDING%% var texture0 : texture_2d<f32>;\n\n\t\tstruct FragmentInput {\n\t\t\t@location(0) fragUV : vec2<f32>,\n\t\t\t@location(1) pointOpacity : f32,\n\t\t\t@builtin(position) fragPos : vec4<f32>\n\t\t};\n\t\t\n\t\tstruct FragmentOutput {\n\t\t\t@location(0) color : vec4<f32>,\n\t\t\t${e?"@builtin(frag_depth) fragDepth: f32":""} \n\t\t};\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\toutput.color = textureSample(texture0, sampler0, input.fragUV) * uniforms.pointColor * input.pointOpacity;\n\t\t\t${e?"output.fragDepth = select(input.fragPos.z, 1.0, output.color.a == 0.0);":""}\n\t\t\treturn output;\n\t\t}`}static _GetTilemapFragmentShaderSource(e){return`\n\t\t${Cp}\n\n\t\t%%SAMPLERFRONT_BINDING%% var sampler0 : sampler;\n\t\t%%TEXTUREFRONT_BINDING%% var texture0 : texture_2d<f32>;\n\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t\n\t\tstruct FragmentOutput {\n\t\t\t@location(0) color : vec4<f32>,\n\t\t\t${e?"@builtin(frag_depth) fragDepth: f32":""} \n\t\t};\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar halfPixelSize : vec2<f32> = vec2<f32>(0.5, 0.5) / vec2<f32>(textureDimensions(texture0));\n\n\t\t\tvar tile : vec2<f32> = floor(input.fragUV);\n\t\t\tvar tex : vec2<f32> = fract(input.fragUV);\n\t\t\tvar tileOrigin : vec2<f32> = uniforms.srcRectStart + tile * (uniforms.tileSize + uniforms.tileSpacing);\n\t\t\tvar lowerBound : vec2<f32> = tileOrigin + halfPixelSize;\n\t\t\tvar upperBound : vec2<f32> = tileOrigin + uniforms.tileSize - halfPixelSize;\n\n\t\t\toutput.color = textureSampleLevel(texture0, sampler0, clamp(tex, lowerBound, upperBound), 0.0) * vec4<f32>(input.fragColor);\n\t\t\t${e?"output.fragDepth = select(input.fragPos.z, 1.0, output.color.a == 0.0);":""}\n\t\t\treturn output;\n\t\t}`}static GetTileRandomizationFragmentShaderSource(e){return`\n${Cp}\n\n%%SAMPLERFRONT_BINDING%% var sampler0 : sampler;\n%%TEXTUREFRONT_BINDING%% var texture0 : texture_2d<f32>;\n\n%%FRAGMENTINPUT_STRUCT%%\n\nstruct FragmentOutput {\n\t@location(0) color : vec4<f32>,\n\t${e?"@builtin(frag_depth) fragDepth: f32":""} \n};\n\n%%C3_UTILITY_FUNCTIONS%%\n\nconst PI : f32 = 3.1415926;\n\nfn cospVec4(a : vec4<f32>, b : vec4<f32>, x : f32) -> vec4<f32>\n{\n\treturn (a + b + (a - b) * cos(x * PI)) / 2.0;\n}\n\nfn randVec3(seed : vec2<f32>) -> vec3<f32>\n{\n\treturn vec3<f32>(\n\t\tfract(sin(dot(seed.xy, vec2<f32>(12.9898,78.233))) * 43758.5453),\n\t\tfract(sin(dot(seed.yx, vec2<f32>(12.9898,-78.233))) * 43758.5453),\n\t\tfract(sin(dot(seed.xy, vec2<f32>(-12.9898,-78.233))) * 43758.5453));\n}\n\nfn sampleTile(tile : vec2<f32>, uv : vec2<f32>, ddx : vec2<f32>, ddy : vec2<f32>) -> vec4<f32>\n{\n\tvar posRandom = uniforms.tileSize;\n\tvar angleRandom = uniforms.outlineThickness;\n\tvar pixelSize = c3_getPixelSize(texture0);\n\t\n\tvar rand = (randVec3(round(tile)) - 0.5) * 2.0;\n\t\n\tvar angle = angleRandom * rand.z * PI;\n\tvar sin_a = sin(angle);\n\tvar cos_a = cos(angle);\n\tvar aspect = pixelSize.x / pixelSize.y;\n\n\tvar mid = tile + vec2<f32>(0.5, 0.5);\n\tvar dp = uv - mid;\n\tdp.x /= aspect;\n\tvar r = vec2<f32>(dp.x * cos_a - dp.y * sin_a,\n\t\t\t\t\t  dp.y * cos_a + dp.x * sin_a);\n\tr.x *= aspect;\n\n\tvar p = mid + r + (posRandom * rand.xy / 2.0);\n\t\n\treturn textureSampleGrad(texture0, sampler0, p, ddx, ddy);\n}\n\n@fragment\nfn main(input : FragmentInput) -> FragmentOutput\n{\n\tvar output : FragmentOutput;\n\t\n\tvar blendMarginX = uniforms.tileSpacing.x;\n\tvar blendMarginY = uniforms.tileSpacing.y;\n\t\n\tvar tile = floor(input.fragUV);\n\tvar tex = fract(input.fragUV);\n\tvar ddx = dpdx(input.fragUV);\n\tvar ddy = dpdy(input.fragUV);\n\t\n\tvar curTile = sampleTile(tile, input.fragUV, ddx, ddy);\n\t\n\tvar inLeftMargin = (tex.x < blendMarginX);\n\tvar inRightMargin = (tex.x > 1.0 - blendMarginX);\n\tvar inTopMargin = (tex.y < blendMarginY);\n\tvar inBottomMargin = (tex.y > 1.0 - blendMarginY);\n\t\n\tif (inLeftMargin)\n\t{\n\t\tvar leftTile = sampleTile(tile + vec2<f32>(-1.0, 0.0), input.fragUV, ddx, ddy);\n\t\tvar leftMix = (tex.x / (blendMarginX * 2.0)) + 0.5;\n\t\tvar leftMixedTile = cospVec4(leftTile, curTile, leftMix);\n\t\t\n\t\tif (inTopMargin)\n\t\t{\n\t\t\tvar topTile =     sampleTile(tile + vec2<f32>(0.0,  -1.0), input.fragUV, ddx, ddy);\n\t\t\tvar topLeftTile = sampleTile(tile + vec2<f32>(-1.0, -1.0), input.fragUV, ddx, ddy);\n\t\t\tvar topLeftMixedTile = cospVec4(topLeftTile, topTile, leftMix);\n\t\t\t\n\t\t\toutput.color = cospVec4(topLeftMixedTile, leftMixedTile, (tex.y / (blendMarginY * 2.0)) + 0.5);\n\t\t}\n\t\telse if (inBottomMargin)\n\t\t{\n\t\t\tvar bottomTile =     sampleTile(tile + vec2<f32>(0.0,  1.0), input.fragUV, ddx, ddy);\n\t\t\tvar bottomLeftTile = sampleTile(tile + vec2<f32>(-1.0, 1.0), input.fragUV, ddx, ddy);\n\t\t\tvar bottomLeftMixedTile = cospVec4(bottomLeftTile, bottomTile, leftMix);\n\t\t\t\n\t\t\toutput.color = cospVec4(leftMixedTile, bottomLeftMixedTile, (tex.y - (1.0 - blendMarginY)) / (blendMarginY * 2.0));\n\t\t}\n\t\telse\n\t\t{\n\t\t\toutput.color = leftMixedTile;\n\t\t}\n\t}\n\telse if (inRightMargin)\n\t{\n\t\tvar rightTile = sampleTile(tile + vec2(1.0, 0.0), input.fragUV, ddx, ddy);\n\t\tvar rightMix = (tex.x - (1.0 - blendMarginX)) / (blendMarginX * 2.0);\n\t\tvar rightMixedTile = cospVec4(curTile, rightTile, rightMix);\n\t\t\n\t\tif (inTopMargin)\n\t\t{\n\t\t\tvar topTile =      sampleTile(tile + vec2<f32>(0.0, -1.0), input.fragUV, ddx, ddy);\n\t\t\tvar topRightTile = sampleTile(tile + vec2<f32>(1.0, -1.0), input.fragUV, ddx, ddy);\n\t\t\tvar topRightMixedTile = cospVec4(topTile, topRightTile, rightMix);\n\t\t\t\n\t\t\toutput.color = cospVec4(topRightMixedTile, rightMixedTile, (tex.y / (blendMarginY * 2.0)) + 0.5);\n\t\t}\n\t\telse if (inBottomMargin)\n\t\t{\n\t\t\tvar bottomTile =      sampleTile(tile + vec2<f32>(0.0, 1.0), input.fragUV, ddx, ddy);\n\t\t\tvar bottomRightTile = sampleTile(tile + vec2<f32>(1.0, 1.0), input.fragUV, ddx, ddy);\n\t\t\tvar bottomRightMixedTile = cospVec4(bottomTile, bottomRightTile, rightMix);\n\t\t\t\n\t\t\toutput.color = cospVec4(rightMixedTile, bottomRightMixedTile, (tex.y - (1.0 - blendMarginY)) / (blendMarginY * 2.0));\n\t\t}\n\t\telse\n\t\t{\n\t\t\toutput.color = rightMixedTile;\n\t\t}\n\t}\n\telse if (inTopMargin)\n\t{\n\t\tvar topTile = sampleTile(tile + vec2<f32>(0.0, -1.0), input.fragUV, ddx, ddy);\n\t\toutput.color = cospVec4(topTile, curTile, (tex.y / (blendMarginY * 2.0)) + 0.5);\n\t}\n\telse if (inBottomMargin)\n\t{\n\t\tvar bottomTile = sampleTile(tile + vec2<f32>(0.0, 1.0), input.fragUV, ddx, ddy);\n\t\toutput.color = cospVec4(curTile, bottomTile, (tex.y - (1.0 - blendMarginY)) / (blendMarginY * 2.0));\n\t}\n\telse\n\t{\n\t\toutput.color = curTile;\n\t}\n\t\n\toutput.color *= vec4<f32>(input.fragColor);\n\t${e?"output.fragDepth = select(input.fragPos.z, 1.0, output.color.a == 0.0);":""}\n\treturn output;\n}\n`}static _GetColorFillFragmentShaderSource(){return"\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\toutput.color = vec4<f32>(input.fragColor);\n\t\t\treturn output;\n\t\t}"}static _GetLinearGradientFillFragmentShaderSource(){return`\n\t\t${Cp}\n\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\tfn fromLinear(linearRGB : vec3<f32>) -> vec3<f32>\n\t\t{\n\t\t\tvar cutoff : vec3<bool> = (linearRGB < vec3<f32>(0.0031308));\n\t\t\tvar higher : vec3<f32> = vec3<f32>(1.055) * pow(abs(linearRGB), vec3<f32>(1.0/2.4)) - 0.055;\n\t\t\tvar lower : vec3<f32> = linearRGB * 12.92;\n\t\t\treturn select(higher, lower, cutoff);\n\t\t}\n\n\t\tfn toLinear(sRGB : vec3<f32>) -> vec3<f32>\n\t\t{\n\t\t\tvar cutoff : vec3<bool> = (sRGB < vec3<f32>(0.04045));\n\t\t\tvar higher : vec3<f32> = pow(abs((sRGB + 0.055) / 1.055), vec3<f32>(2.4));\n\t\t\tvar lower : vec3<f32> = sRGB / 12.92;\n\t\t\treturn select(higher, lower, cutoff);\n\t\t}\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar linearGrad : vec3<f32> = mix(toLinear(vec3<f32>(input.fragColor.rgb)), toLinear(uniforms.color2.rgb), vec3<f32>(input.fragUV.x));\n\n\t\t\tvar a : f32 = mix(f32(input.fragColor.a), uniforms.color2.a, input.fragUV.x);\n\t\t\toutput.color = vec4<f32>(fromLinear(linearGrad) * a, a);\n\t\t\treturn output;\n\t\t}\n\t\t`}static _GetPenumbraFillFragmentShaderSource(){return`\n\t\t${Cp}\n\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar grad : f32 = input.fragUV.x / (1.0 - input.fragUV.y);\n\t\t\toutput.color = vec4<f32>(input.fragColor) * (1.0 - (cos(grad * 3.141592653589793) + 1.0) / 2.0);\n\t\t\treturn output;\n\t\t}\n\t\t`}static _GetHardEllipseFillFragmentShaderSource(){return"\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar diff : vec2<f32> = input.fragUV - 0.5;\n\t\t\tvar diffSq : vec2<f32> = diff * diff;\n\n\t\t\tvar f : f32 = step(diffSq.x + diffSq.y, 0.25);\n\n\t\t\toutput.color = vec4<f32>(input.fragColor) * f;\n\t\t\treturn output;\n\t\t}"}static _GetHardEllipseOutlineFragmentShaderSource(){return`\n\t\t${Cp}\n\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar diff : vec2<f32> = input.fragUV - 0.5;\n\t\t\tvar diffSq : vec2<f32> = diff * diff;\n\t\t\tvar distSq : f32 = diffSq.x + diffSq.y;\n\t\t\tvar norm : vec2<f32> = normalize(diff);\n\t\t\tvar halfNorm : vec2<f32> = norm * 0.5;\n\n\t\t\tvar innerF : f32 = step(distSq, 0.25);\n\n\t\t\tvar innerEdge : vec2<f32> = halfNorm - uniforms.pixelSize * norm * uniforms.outlineThickness;\n\t\t\tvar innerEdgeSq : vec2<f32> = innerEdge * innerEdge;\n\t\t\tvar outerF : f32 = step(innerEdgeSq.x + innerEdgeSq.y, distSq);\n\t\t\t\n\t\t\toutput.color = vec4<f32>(input.fragColor) * innerF * outerF;\n\t\t\treturn output;\n\t\t}`}static _GetSmoothEllipseFillFragmentShaderSource(){return`\n\t\t${Cp}\n\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar diff : vec2<f32> = input.fragUV - 0.5;\n\t\t\tvar diffSq : vec2<f32> = diff * diff;\n\t\t\tvar norm : vec2<f32> = normalize(diff);\n\t\t\tvar halfNorm : vec2<f32> = norm * 0.5;\n\t\t\tvar halfNormSq : vec2<f32> = halfNorm * halfNorm;\n\n\t\t\tvar innerEdge : vec2<f32> = halfNorm - uniforms.pixelSize * norm;\n\t\t\tvar innerEdgeSq : vec2<f32> = innerEdge * innerEdge;\n\n\t\t\tvar f : f32 = smoothstep(halfNormSq.x + halfNormSq.y, innerEdgeSq.x + innerEdgeSq.y, diffSq.x + diffSq.y);\n\n\t\t\toutput.color = vec4<f32>(input.fragColor) * f;\n\t\t\treturn output;\n\t\t}`}static _GetSmoothEllipseOutlineFragmentShaderSource(){return`\n\t\t${Cp}\n\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar diff : vec2<f32> = input.fragUV - 0.5;\n\t\t\tvar diffSq : vec2<f32> = diff * diff;\n\t\t\tvar distSq : f32 = diffSq.x + diffSq.y;\n\t\t\tvar norm : vec2<f32> = normalize(diff);\n\t\t\tvar halfNorm : vec2<f32> = norm * 0.5;\n\t\t\tvar halfNormSq : vec2<f32> = halfNorm * halfNorm;\n\n\t\t\tvar pxNorm : vec2<f32> = uniforms.pixelSize * norm;\n\t\t\tvar innerEdge1 : vec2<f32> = halfNorm - pxNorm;\n\t\t\tvar innerEdge1Sq : vec2<f32> = innerEdge1 * innerEdge1;\n\n\t\t\tvar innerF : f32 = smoothstep(halfNormSq.x + halfNormSq.y, innerEdge1Sq.x + innerEdge1Sq.y, distSq);\n\n\t\t\tvar innerEdge2 : vec2<f32> = halfNorm - pxNorm * uniforms.outlineThickness;\n\t\t\tvar innerEdge2Sq : vec2<f32> = innerEdge2 * innerEdge2;\n\t\t\tvar innerEdge3 : vec2<f32> = halfNorm - pxNorm * (uniforms.outlineThickness + 1.0);\n\t\t\tvar innerEdge3Sq : vec2<f32> = innerEdge3 * innerEdge3;\n\n\t\t\tvar outerF : f32 = smoothstep(innerEdge3Sq.x + innerEdge3Sq.y, innerEdge2Sq.x + innerEdge2Sq.y, distSq);\n\t\t\t\n\t\t\toutput.color = vec4<f32>(input.fragColor) * innerF * outerF;\n\t\t\treturn output;\n\t\t}`}static _GetSmoothLineFillFragmentShaderSource(){return"\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar f : f32 = 1.0 - abs(input.fragUV.y - 0.5) * 2.0;\n\t\t\toutput.color = vec4<f32>(input.fragColor) * f;\n\t\t\treturn output;\n\t\t}"}}}{const Lp=self.C3,kp=new Set(["nearest","bilinear","trilinear"]),Vp=new Set(["clamp-to-edge","repeat","mirror-repeat"]),Up=self.GPUTextureUsage,Wp={wrapX:"clamp-to-edge",wrapY:"clamp-to-edge",sampling:"trilinear",anisotropy:0,mipMap:!0,isRenderTarget:!1,isSampled:!1,canReadPixels:!1,canUpdate:!1,multisampling:0,width:-1,height:-1},Hp=[[1,["r8unorm","r8snorm","r8uint","r8sint","stencil8"]],[2,["r16uint","r16sint","r16float","rg8unorm","rg8snorm","rg8uint","rg8sint","depth16unorm"]],[3,["depth24plus"]],[4,["r32uint","r32sint","r32float","rg16uint","rg16sint","rg16float","rgba8unorm","rgba8unorm-srgb","rgba8snorm","rgba8uint","rgba8sint","bgra8unorm","bgra8unorm-srgb","rgb9e5ufloat","rgb10a2uint","rgb10a2unorm","rg11b10ufloat","depth24plus-stencil8","depth32float"]],[8,["rg32uint","rg32sint","rg32float","rgba16uint","rgba16sint","rgba16float"]],[16,["rgba32uint","rgba32sint","rgba32float"]],[5,["depth32float-stencil8"]]],zp=new Map;for(const[qp,Xp]of Hp)for(const $p of Xp)zp.set($p,qp);const jp=new Set,Yp={premultiplyAlpha:!0,flipY:!1};Lp.Gfx.WebGPURendererTexture=class{constructor(e,t){this._renderer=e,this._texture=null,this._format="",this._textureView=null,this._sampler=null,this._ownTextureBindGroup=null,this._backTextureBindGroup=null,this._width=0,this._height=0,this._isStatic=!0,this._wrapX="clamp-to-edge",this._wrapY="clamp-to-edge",this._sampling="trilinear",this._anisotropy=0,this._isMipMapped=!1,this._refCount=0,this._isRenderTarget=!1,this._isSampled=!1,this._canReadPixels=!1,this._canUpdate=!1,this._multisampling=0,this._usage=0,this._multiTextureEnabled=!0,this._multiTextureGroup=null,this._multiTextureIndex=0,this._isForBackbuffer=!!t,this._isForBackbuffer&&(this._format=this._renderer.GetSwapChainFormat(),this._isRenderTarget=!0,this._isSampled=!0,this._sampler=this._renderer._GetSampler({sampling:"nearest"}))}_InitFromOpts(e){if(this._wrapX=e.wrapX,this._wrapY=e.wrapY,this._sampling=e.sampling,this._anisotropy=e.anisotropy,this._isMipMapped=!!e.mipMap&&this._renderer.AreMipmapsEnabled()&&"nearest"!==e.sampling,this._isRenderTarget=!!e.isRenderTarget,this._isSampled=!!e.isSampled,this._canReadPixels=!!e.canReadPixels,this._canUpdate=!!e.canUpdate,this._multisampling=this._renderer._ClampToSupportedMultisampleValues(e.multisampling),!kp.has(this._sampling))throw new Error("invalid sampling");if(!Vp.has(this._wrapX)||!Vp.has(this._wrapY))throw new Error("invalid wrap mode");if(this._multisampling>=2&&this._isSampled)throw new Error("invalid use of multisampling");"nearest"===this._sampling&&(this._anisotropy=0),this._sampler=this._renderer._GetSampler({wrapX:this._wrapX,wrapY:this._wrapY,sampling:this._sampling,anisotropy:this._anisotropy}),this._CreateGPUResources(),this._refCount=1}_CreateGPUResources(){const e=this._renderer,t=e._GetDevice();this._usage=0,this._isRenderTarget?(this._usage=Up.RENDER_ATTACHMENT,this._isSampled&&(this._usage|=Up.TEXTURE_BINDING),this._canUpdate&&(this._usage|=Up.COPY_DST),this._format=this._renderer.GetSwapChainFormat()):(this._usage=Up.COPY_DST|Up.TEXTURE_BINDING,this._format=this._renderer.GetTextureFormat()),this._canReadPixels&&(this._usage|=Up.COPY_SRC),this._texture=t.createTexture({size:[this._width,this._height,1],mipLevelCount:this._GetMipLevelCount(),format:this._format,usage:this._usage,sampleCount:this._multisampling>=2?this._multisampling:1}),this._textureView=this._texture.createView();const s=[],i=Lp.Gfx.WebGPUMultiTextureGroup.GetMultiTextureLimit();for(let e=0;e<i;++e)s.push({binding:2*e,resource:this._sampler},{binding:2*e+1,resource:this._textureView});this._isRenderTarget&&!this._isSampled||(this._ownTextureBindGroup=t.createBindGroup({layout:e._GetTextureBindGroupLayout(),entries:s}),this._backTextureBindGroup=t.createBindGroup({layout:e._GetBackTextureBindGroupLayout(),entries:[{binding:0,resource:this._renderer._GetSampler({sampling:"nearest"})},{binding:1,resource:this._textureView}]})),this._CanMultiTexture()&&this._SetMultiTextureAvailable(!0),jp.add(this)}_DeleteGPUResources(){jp.delete(this),this._multiTextureGroup&&this._multiTextureGroup.Release(),this._SetMultiTextureAvailable(!1),this._texture.destroy(),this._texture=null,this._textureView=null,this._ownTextureBindGroup=null,this._backTextureBindGroup=null}static IsGPUImageCopyExternalImageSource(e){return e instanceof ImageBitmap||"undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas}static IsCreateImageBitmapDataSource(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||e instanceof ImageData}_GetDataSize(e){return[e.width||e.videoWidth,e.height||e.videoHeight]}_Create(e,t){if(e&&!Lp.Gfx.WebGPURendererTexture.IsGPUImageCopyExternalImageSource(e))throw new TypeError("invalid texture source");if(t=Object.assign({},Wp,t),this._texture)throw new Error("already created texture");if(this._isStatic=!0,e){const[t,s]=this._GetDataSize(e);this._width=t,this._height=s}else if(this._width=t.width,this._height=t.height,this._width<=0||this._height<=0)throw new Error("invalid texture size");if(this._InitFromOpts(t),this._isRenderTarget||this._isSampled)throw new Error("static texture cannot be render target");e&&this._UploadImage(e)}_UploadImage(e,t=!0){if(this._isMipMapped)this._GenerateMipmaps(e,this._GetMipLevelCount(),t);else{const s=this._renderer._GetDevice(),i=s.createCommandEncoder(),r=s.createTexture({size:[this._width,this._height,1],mipLevelCount:1,format:this._format,usage:Up.COPY_SRC|Up.COPY_DST|Up.RENDER_ATTACHMENT});this._CopyImageToMipLevel(r,e,0,t),i.copyTextureToTexture({texture:r,mipLevel:0},{texture:this._texture,mipLevel:0},[this._width,this._height,1]),s.queue.submit([i.finish()]),r.destroy()}}_CopyImageToMipLevel(e,t,s,i=!0){const[r,n]=this._GetDataSize(t);this._renderer._GetDevice().queue.copyExternalImageToTexture({source:t},{texture:e,mipLevel:s,premultipliedAlpha:!!i},[r,n,1])}_GetMipLevelCount(){return this._isMipMapped?Math.floor(Math.log2(Math.max(this._width,this._height))+1):1}_GenerateMipmaps(e,t,s=!0){const i=this._renderer._GetDevice(),r=i.createTexture({size:[this._width,this._height,1],mipLevelCount:this._GetMipLevelCount(),format:this._format,usage:Up.COPY_DST|Up.COPY_SRC|Up.TEXTURE_BINDING|Up.RENDER_ATTACHMENT}),n=this._renderer._GetMipmapGeneratorPipeline(),a=n.getBindGroupLayout(0),o=this._renderer._GetSampler({sampling:"bilinear"}),l=i.createCommandEncoder();this._CopyImageToMipLevel(r,e,0,s),l.copyTextureToTexture({texture:r,mipLevel:0},{texture:this._texture,mipLevel:0},[this._width,this._height,1]);const h=[];for(let e=0;e<t;++e)h.push(r.createView({baseMipLevel:e,mipLevelCount:1}));let u=this._width,c=this._height;for(let e=1;e<t;++e){u/=2,c/=2;const t=Math.max(Math.floor(u),1),s=Math.max(Math.floor(c),1),d=l.beginRenderPass({colorAttachments:[{view:h[e],loadOp:"clear",clearValue:[0,0,0,0],storeOp:"store"}]}),p=i.createBindGroup({layout:a,entries:[{binding:0,resource:o},{binding:1,resource:h[e-1]}]});d.setPipeline(n),d.setBindGroup(0,p),d.draw(4),d.end(),l.copyTextureToTexture({texture:r,mipLevel:e},{texture:this._texture,mipLevel:e},[t,s,1])}i.queue.submit([l.finish()]),r.destroy()}_CreateDynamic(e,t,s){if(s=Object.assign({},Wp,s),this._texture)throw new Error("already created texture");this._isStatic=!1,this._width=e,this._height=t,this._InitFromOpts(s)}async _Update(e,t){if(!Lp.Gfx.WebGPURendererTexture.IsGPUImageCopyExternalImageSource(e)&&!Lp.Gfx.WebGPURendererTexture.IsCreateImageBitmapDataSource(e))throw new Error("invalid texture source");if(!this._texture||this._refCount<=0)throw new Error("texture not created");if(this._isStatic)throw new Error("cannot update static texture");if(t=Object.assign({},Yp,t),(Lp.Gfx.WebGPURendererTexture.IsCreateImageBitmapDataSource(e)||t.flipY||!t.premultiplyAlpha)&&(e=await createImageBitmap(e,{premultiplyAlpha:t.premultiplyAlpha?"premultiply":"none",imageOrientation:t.flipY?"flipY":"none"}),!this._texture))return;this._renderer.EndBatch();const[s,i]=this._GetDataSize(e);this._width===s&&this._height===i||(this._DeleteGPUResources(),this._width=s,this._height=i,this._CreateGPUResources(),this._renderer._OnTextureBindGroupChanged(this)),this._UploadImage(e,t.premultiplyAlpha)}_Delete(){if(this._refCount>0)throw new Error("texture still has references");if(!this._texture)throw new Error("already deleted texture");this._DeleteGPUResources()}_DisableMultiTexture(){this._multiTextureEnabled=!1,this._SetMultiTextureAvailable(!1)}_CanMultiTexture(){return this._isStatic&&this._multiTextureEnabled&&!this._isRenderTarget}_SetMultiTextureAvailable(e){this._renderer._SetMultiTextureAvailable(this,e)}_SetMultiTextureGroup(e,t){if(this._multiTextureGroup)throw new Error("already in a group");this._multiTextureGroup=e,this._multiTextureIndex=t,this._SetMultiTextureAvailable(!1)}_ClearMultiTextureGroup(){this._multiTextureGroup=null,this._multiTextureIndex=0,this._CanMultiTexture()&&this._SetMultiTextureAvailable(!0)}_GetOwnTextureBindGroup(){return this._ownTextureBindGroup}_GetBackTextureBindGroup(){return this._backTextureBindGroup}_GetMultiTextureBindGroup(){return null!==this._multiTextureGroup?this._multiTextureGroup._GetBindGroup():this._CanMultiTexture()?(this._renderer._TryCreateMultiTextureGroup(this),null!==this._multiTextureGroup?this._multiTextureGroup._GetBindGroup():null):null}_GetMultiTextureIndex(){return this._multiTextureIndex}GetWidth(){return this._isForBackbuffer?this._renderer.GetWidth():this._width}GetHeight(){return this._isForBackbuffer?this._renderer.GetHeight():this._height}GetRenderer(){return this._renderer}_GetTexture(){return this._texture}_GetTextureView(){return this._textureView}_GetFormat(){return this._format}_GetSampler(){return this._sampler}GetSampling(){return this._sampling}IsLinearSampling(){return"nearest"!==this._sampling}IsRenderTarget(){return this._isRenderTarget}IsSampled(){return this._isSampled}CanReadPixels(){return this._canReadPixels}AddReference(){this._refCount++}SubtractReference(){if(this._refCount<=0)throw new Error("no more references");this._refCount--}GetReferenceCount(){return this._refCount}_GetUsage(){return this._usage}_BackbufferTextureSetProperties(e,t){this._usage=e,this._format=t}_BackbufferTextureStartFrame(){const e=this._renderer,t=e._GetDevice();this._texture=e._GetSwapChainTexture(),this._textureView=e._GetSwapChainTexView(),e._CanSampleBackbuffer()&&(this._backTextureBindGroup=t.createBindGroup({layout:e._GetBackTextureBindGroupLayout(),entries:[{binding:0,resource:this._sampler},{binding:1,resource:this._textureView}]}))}_BackbufferTextureEndFrame(){this._texture=null,this._textureView=null,this._backTextureBindGroup=null}GetEstimatedMemoryUsage(){let e=this.GetWidth()*this.GetHeight()*Lp.Gfx.WebGPURendererTexture.GetFormatByteSize(this._GetFormat());return this._isMipMapped&&(e+=Math.floor(e/3)),e}static OnContextLost(){}static allTextures(){return jp.values()}static GetFormatByteSize(e){const t=zp.get(e);return"number"==typeof t?t:NaN}}}{const Kp=self.C3;Kp.Gfx.WebGPUMultiTextureGroup=class{constructor(e,t){if(t.length<2)throw new Error("invalid multi-texture group");this._renderer=e,this._textures=t,this._multiTextureBindGroup=null;for(let e=0,s=t.length;e<s;++e)t[e]._SetMultiTextureGroup(this,e);t.length<Kp.Gfx.WebGPUMultiTextureGroup.GetMultiTextureLimit()&&this._renderer._SetMultiTextureGroupNonFull(this,!0),this._CreateBindGroup()}Release(){this._renderer._SetMultiTextureGroupNonFull(this,!1);for(const e of this._textures)e._ClearMultiTextureGroup();this._DeleteBindGroup(),Kp.clearArray(this._textures),this._renderer=null}_CreateBindGroup(){this._DeleteBindGroup();const e=this._renderer._GetDevice(),t=[],s=Kp.Gfx.WebGPUMultiTextureGroup.GetMultiTextureLimit();for(let e=0;e<s;++e){const s=this._textures[Math.min(e,this._textures.length-1)];t.push({binding:2*e,resource:s._GetSampler()},{binding:2*e+1,resource:s._GetTextureView()})}this._multiTextureBindGroup=e.createBindGroup({layout:this._renderer._GetTextureBindGroupLayout(),entries:t})}_DeleteBindGroup(){null!==this._multiTextureBindGroup&&this._renderer._OnMultiTextureBindGroupReleased(this._multiTextureBindGroup),this._multiTextureBindGroup=null}_GetBindGroup(){return this._multiTextureBindGroup}static GetMultiTextureLimit(){return 14}}}{const Jp=self.C3,Qp=self.glMatrix,Zp=Qp.vec3,e_=Qp.mat4,t_={sampling:"trilinear",alpha:!0,depth:!1,isSampled:!0,canReadPixels:!1,canUpdate:!1,isDefaultSize:!0,multisampling:0},s_=new Set;Jp.Gfx.WebGPURenderTarget=class{constructor(e,t){this._renderer=e,this._isBackBuffer=!!t,this._depth=!!t&&e.UsesDepthBuffer(),this._rendererTexture=null,this._isDefaultSize=!0,this._multisampling=0,this._isAwaitingClear=!1,this._clearColor=Jp.New(Jp.Color),this._projectionMatrix=e_.create(),this._lastFov=0,this._lastNearZ=0,this._lastFarZ=0,this._isBackBuffer&&(this._rendererTexture=Jp.New(Jp.Gfx.WebGPURendererTexture,e,!0))}_Create(e,t,s){if(s=Object.assign({},t_,s),this._rendererTexture)throw new Error("already created render target");if(this._depth=!!s.depth,this._isDefaultSize=!!s.isDefaultSize,this._multisampling=this._renderer._ClampToSupportedMultisampleValues(s.multisampling),this._multisampling>=2&&s.isSampled)throw new Error("invalid use of multisampling");this._rendererTexture=this._renderer.CreateDynamicTexture(e,t,{sampling:s.sampling,mipMap:!1,isRenderTarget:!0,isSampled:s.isSampled,canReadPixels:s.canReadPixels,canUpdate:s.canUpdate,multisampling:this._multisampling}),this._CalculateProjection(),s_.add(this)}_Delete(){s_.delete(this),this._rendererTexture._DeleteGPUResources(),this._rendererTexture=null,this._renderer=null}_Resize(e,t){if(e===this.GetWidth()&&t===this.GetHeight())return;const s=this._rendererTexture.GetSampling(),i=this._rendererTexture.IsSampled(),r=this._rendererTexture.CanReadPixels();this._rendererTexture._DeleteGPUResources(),this._rendererTexture=null,this._rendererTexture=this._renderer.CreateDynamicTexture(e,t,{sampling:s,mipMap:!1,isRenderTarget:!0,isSampled:i,canReadPixels:r}),this._CalculateProjection()}_GetTextureView(){return this._isBackBuffer?this._renderer._GetSwapChainTexView():this._rendererTexture._GetTextureView()}_CalculateProjection(){this._renderer.CalculatePerspectiveMatrix(this._projectionMatrix,this.GetWidth()/this.GetHeight()),this._lastFov=this._renderer.GetFovY(),this._lastNearZ=this._renderer.GetNearZ(),this._lastFarZ=this._renderer.GetFarZ()}IsDefaultSize(){return this._isDefaultSize}IsBackBuffer(){return this._isBackBuffer}HasDepthBuffer(){return this._depth}GetWidth(){return this._isBackBuffer?this._renderer.GetWidth():this._rendererTexture.GetWidth()}GetHeight(){return this._isBackBuffer?this._renderer.GetHeight():this._rendererTexture.GetHeight()}GetTexture(){if(this._rendererTexture)return this._rendererTexture;throw new Error("no texture")}GetRenderer(){return this._renderer}GetMultisampling(){return this._multisampling}GetProjectionMatrix(){return this._renderer.GetFovY()===this._lastFov&&this._renderer.GetNearZ()===this._lastNearZ&&this._renderer.GetFarZ()===this._lastFarZ||this._CalculateProjection(),this._projectionMatrix}IsLinearSampling(){return this._rendererTexture.IsLinearSampling()}IsSampled(){return this._rendererTexture.IsSampled()}CanReadPixels(){return this._rendererTexture.CanReadPixels()}IsCompatibleWithOptions(e){return"nearest"!==(e=Object.assign({},t_,e)).sampling===this.IsLinearSampling()&&!!e.isSampled===this.IsSampled()&&!!e.canReadPixels===this.CanReadPixels()&&!!e.depth===this.HasDepthBuffer()&&("number"==typeof e.width||"number"==typeof e.height?!this.IsDefaultSize()&&this.GetWidth()===Math.floor(e.width)&&this.GetHeight()===Math.floor(e.height):this.IsDefaultSize())}_SetIsAwaitingClear(e){this._isAwaitingClear=!!e}_IsAwaitingClear(){return this._isAwaitingClear}_GetClearColor(){return this._clearColor}static OnContextLost(){}static allRenderTargets(){return s_.values()}}}{const i_=self.C3;i_.Gfx.WebGPUTimeQuerySet=class{constructor(e,t){this._renderer=e,this._frameNumber=this._renderer.GetFrameNumber(),this._queryCount=t;const s=this._renderer._GetDevice();this._querySet=s.createQuerySet({count:this._queryCount,type:"timestamp"});const i=self.GPUBufferUsage;this._resolveBuffer=s.createBuffer({size:this._GetBufferSize(),usage:i.QUERY_RESOLVE|i.COPY_SRC}),this._readbackBuffer=s.createBuffer({size:this._GetBufferSize(),usage:i.COPY_DST|i.MAP_READ}),this._result=null}_GetBufferSize(){return 8*this._queryCount}_GetQuerySet(){return this._querySet}Resolve(e){e.resolveQuerySet(this._querySet,0,this._queryCount,this._resolveBuffer,0),e.copyBufferToBuffer(this._resolveBuffer,0,this._readbackBuffer,0,this._GetBufferSize())}async ReadResult(){const e=this._GetBufferSize();await this._readbackBuffer.mapAsync(self.GPUMapMode.READ,0,e);const t=this._readbackBuffer.getMappedRange(0,e);this._result=new BigUint64Array(t.slice(0)),this._readbackBuffer.destroy(),this._readbackBuffer=null,this._resolveBuffer.destroy(),this._resolveBuffer=null,this._querySet.destroy(),this._querySet=null}HasResult(){return null!==this._result}GetResult(){if(!this._result)throw new Error("not yet got result");return this._result}GetFrameNumber(){return this._frameNumber}}}{const r_=self.C3,n_={getDrawSize:null,getRenderTarget:null,releaseRenderTarget:null,getTime:null,redraw:null};r_.Gfx.EffectChainManager=class{constructor(e){e=Object.assign({},n_,e),this._cbGetDrawSize=e.getDrawSize,this._cbGetRenderTarget=e.getRenderTarget,this._cbReleaseRenderTarget=e.releaseRenderTarget,this._cbGetTime=e.getTime,this._cbRedraw=e.redraw,this._webgpuBackTexture=null,this._allEffectChains=new Set}_AddEffectChain(e){this._allEffectChains.add(e)}_RemoveEffectChain(e){this._allEffectChains.delete(e)}OnContextLost(){this._webgpuBackTexture=null;for(const e of this._allEffectChains)e.OnContextLost()}GetDrawSize(e){return this._cbGetDrawSize?this._cbGetDrawSize(e):[e.GetWidth(),e.GetHeight()]}GetRenderTarget(e){return this._cbGetRenderTarget(e)}ReleaseRenderTarget(e,t){this._cbReleaseRenderTarget(e,t)}GetTime(){return this._cbGetTime()}Redraw(e){this._cbRedraw(e)}_GetWebGPUBackTexture(e,t,s){return t=Math.floor(t),s=Math.floor(s),!this._webgpuBackTexture||this._webgpuBackTexture.GetWidth()===t&&this._webgpuBackTexture.GetHeight()===s||(e.DeleteTexture(this._webgpuBackTexture),this._webgpuBackTexture=null),null===this._webgpuBackTexture&&(this._webgpuBackTexture=e.CreateStaticTexture(null,{width:t,height:s,sampling:"nearest",mipMap:!1})),this._webgpuBackTexture}}}{const a_=self.C3,o_=self.assert,l_=self.glMatrix,h_=l_.mat4,u_=a_.New(a_.Rect),c_=a_.New(a_.Rect),d_=a_.New(a_.Rect),p_=a_.New(a_.Rect),__=h_.create(),m_=h_.create(),f_={drawContent:null,getSourceTextureInfo:null,getShaderParameters:null,invalidateRenderTargets:!1},g_={indexMap:null,forcePreDraw:!1,forcePostDraw:!1,is3D:!1,isSourceTextureRotated:!1,isRotatedOrNegativeSizeInstance:!1,useFullSurface:!1};a_.Gfx.EffectChain=class{constructor(e,t){t=Object.assign({},f_,t),this._manager=e,this._cbDrawContent=t.drawContent,this._cbGetSourceTextureInfo=t.getSourceTextureInfo,this._cbGetShaderParameters=t.getShaderParameters,this._cbDrawContentHook=null,this._shaderProgramList=[],this._shaderProgramIndices=[],this._steps=[],this._needsRebuild=!1,this._blendMode=0,this._isAnyShaderAnimated=!1,this._isAnyShaderDepthSampling=!1,this._isAnyShaderBackgroundBlending=!1,this._isAnyShaderCrossSampling=!1,this._isAnyIsSrcTexRotated=!1,this._useCopyTextureBackgroundSampling=!1,this._didChangeTransform=!1,this._depthEnabledAtStart=!1,this._coplanarColorPassAtStart=!1,this._canUseFastPath=!1,this._useFullSurface=!1,this._isSourceTextureRotated=!1,this._numTempSurfacesRequired=0,this._renderTargets=[null,null,null],this._invalidateRenderTargets=!!t.invalidateRenderTargets,this._boxExtendHorizontal=0,this._boxExtendVertical=0,this._drawWidth=0,this._drawHeight=0,this._contentObject=null,this._contextObject=null,this._layoutRect=a_.New(a_.Rect),this._drawSurfaceRect=a_.New(a_.Rect),this._rcTexOriginal=a_.New(a_.Rect),this._rcTexBounce=a_.New(a_.Rect),this._rcTexDest=a_.New(a_.Rect),this._devicePixelRatio=1,this._layerScale=1,this._layerAngle=0,this._time=0,this._destRenderTarget=null,this._backTex=null,this._compositOffX=0,this._compositOffY=0,this._compositRtWidth=0,this._compositRtHeight=0,this._updateOwnProjection=!1,this._projectionMatrix=h_.create(),this._modelViewMatrix=h_.create(),this._manager._AddEffectChain(this)}Release(){this._manager._RemoveEffectChain(this),a_.clearArray(this._steps),a_.clearArray(this._shaderProgramList),a_.clearArray(this._shaderProgramIndices),this._contentObject=null,this._contextObject=null,this._cbDrawContent=null,this._cbGetSourceTextureInfo=null,this._cbGetShaderParameters=null}OnContextLost(){this._needsRebuild=!0,a_.clearArray(this._steps),a_.clearArray(this._shaderProgramList),a_.clearArray(this._shaderProgramIndices)}NeedsRebuild(){return this._needsRebuild}BuildSteps(e,t){if(t=Object.assign({},g_,t),a_.clearArray(this._steps),this._boxExtendHorizontal=0,this._boxExtendVertical=0,this._isAnyShaderAnimated=!1,this._isAnyShaderDepthSampling=!1,this._isAnyShaderBackgroundBlending=!1,this._isAnyShaderCrossSampling=!1,this._isAnyIsSrcTexRotated=!1,this._useCopyTextureBackgroundSampling=!1,this._numTempSurfacesRequired=0,this._isSourceTextureRotated=!!t.isSourceTextureRotated,this._useFullSurface=!!t.useFullSurface,this._needsRebuild=!1,a_.shallowAssignArray(this._shaderProgramList,e),0===e.length)return;if(t.indexMap){if(t.indexMap.length!==e.length)throw new Error("incorrect indexMap length");a_.shallowAssignArray(this._shaderProgramIndices,t.indexMap)}else{a_.clearArray(this._shaderProgramIndices);for(let t=0,s=e.length;t<s;++t)this._shaderProgramIndices.push(t)}for(const t of e)this._boxExtendHorizontal+=t.GetBoxExtendHorizontal(),this._boxExtendVertical+=t.GetBoxExtendVertical(),t.IsAnimated()&&(this._isAnyShaderAnimated=!0),t.UsesDepth()&&(this._isAnyShaderDepthSampling=!0),t.BlendsBackground()&&(this._isAnyShaderBackgroundBlending=!0),t.UsesCrossSampling()&&(this._isAnyShaderCrossSampling=!0),t.UsesIsSrcTexRotated()&&(this._isAnyIsSrcTexRotated=!0);this._useCopyTextureBackgroundSampling=this._ShouldUseCopyTextureBackgroundSampling(e[0].GetRenderer());const s=this._ShouldPreDraw(e[0],t),i=this._ShouldPostDraw(e.at(-1),t);if(1===e.length&&!s&&!i)return void(this._canUseFastPath=!0);this._canUseFastPath=!1;let r=0;s&&(this._numTempSurfacesRequired=1,this._steps.push(a_.New(a_.Gfx.EffectChain.Step.PreDraw,this,-1,1)),r=1);for(let t=0,n=e.length;t<n;++t)if(0!==t||s){let e=1===r?2:1;t!==n-1||i||(e=0),this._numTempSurfacesRequired=Math.max(this._numTempSurfacesRequired,e),this._steps.push(a_.New(a_.Gfx.EffectChain.Step.Bounce,this,r,e,t)),r=e}else this._numTempSurfacesRequired=1,this._steps.push(a_.New(a_.Gfx.EffectChain.Step.FirstBounce,this,-1,1,t)),r=1;i&&this._steps.push(a_.New(a_.Gfx.EffectChain.Step.PostDraw,this,r,0))}_ShouldPreDraw(e,t){return!!(t.forcePreDraw||e.MustPreDraw()||t.is3D&&!e.Supports3DDirectRendering()||e.UsesDepth()&&!this._useFullSurface||0!==this._boxExtendHorizontal||0!==this._boxExtendVertical)||(e.GetRenderer().IsWebGL()?e.BlendsBackground()&&(t.isRotatedOrNegativeSizeInstance||t.isSourceTextureRotated)||e.UsesAnySrcRectOrPixelSize()&&t.isSourceTextureRotated:e.BlendsBackground()&&!this._useCopyTextureBackgroundSampling&&t.isRotatedOrNegativeSizeInstance)}_ShouldPostDraw(e,t){return!!t.forcePostDraw||(e.GetRenderer().IsWebGL()?e.BlendsBackground()||e.UsesCrossSampling():(e.BlendsBackground()||e.UsesCrossSampling())&&this._UseRenderTargetBackgroundSampling())}_ShouldUseCopyTextureBackgroundSampling(e){return e.IsWebGPU()&&this._isAnyShaderBackgroundBlending&&!this._isAnyShaderCrossSampling}Render(e,t,s){e.IsWebGPU()&&null===t&&(t=e.GetBackbufferRenderTarget()),this._destRenderTarget=t,this._contentObject=s.contentObject||null,this._contextObject=s.contextObject||null,this._blendMode=s.blendMode||0,this._devicePixelRatio=s.devicePixelRatio||1,this._layerScale=s.layerScale||1,this._layerAngle=s.layerAngle||0,this._time="number"==typeof s.time?s.time:this._manager.GetTime(),this._didChangeTransform=!1,e.ResetDidChangeTransformFlag(),this._isAnyShaderAnimated&&this._Redraw();let i=!1;if(this._UseCopyTextureBackgroundSampling()&&(this._CalculateDrawSizeAndRectangles(e,s),i=!0,this._backTex=this._manager._GetWebGPUBackTexture(e,this._drawWidth,this._drawHeight),u_.copy(this._drawSurfaceRect),u_.roundOuter(),e.IsWebGPU()&&e._MaybeDoPendingClearRenderPass(this._destRenderTarget),e.CopyTextureToTexture(this._destRenderTarget.GetTexture(),this._backTex,u_.getLeft(),u_.getTop(),u_.width(),u_.height())),this._canUseFastPath)this._Render_FastPath(e,s);else if(i||this._CalculateDrawSizeAndRectangles(e,s),0!==this._rcTexOriginal.width()||0!==this._rcTexOriginal.height()){e.SetAlphaBlend(),e.ResetCullState(),e.ResetColor(),e.SetBaseZ(0),e.SetCurrentZ(0),this._cbDrawContentHook=s.drawContentHook||null,this._compositOffX=s.compositOffX||0,this._compositOffY=s.compositOffY||0,this._compositRtWidth=s.compositRtWidth||0,this._compositRtHeight=s.compositRtHeight||0,this._updateOwnProjection=!!s.updateOwnProjection,this._OnBeforeStartEffectChain(e),this._renderTargets[0]=t,this._renderTargets[1]=this._numTempSurfacesRequired>=1?this._GetRenderTarget():null,this._renderTargets[2]=2===this._numTempSurfacesRequired?this._GetRenderTarget():null;for(const t of this._steps){const s=this._GetRenderTargetForId(t.GetSrcTargetId()),i=this._GetRenderTargetForId(t.GetDestTargetId());e.IsWebGPU()?t.Run_WebGPU(e,s,i):t.Run_WebGL(e,s,i)}e.SetTexture(null),this._renderTargets[1]&&this._ReleaseRenderTarget(this._renderTargets[1]),this._renderTargets[2]&&this._ReleaseRenderTarget(this._renderTargets[2]),this._renderTargets.fill(null),this._OnAfterEndEffectChain(e),this._destRenderTarget=null,this._backTex=null,this._contentObject=null,this._contextObject=null,this._cbDrawContentHook=null}}_CalculateDrawSizeAndRectangles(e,t){const[s,i]=this._manager.GetDrawSize(e);this._SetDrawSize(e,s,i),this._CalculateRectangles(t)}_SetDrawSize(e,t,s){if(t<=0||s<=0)throw new Error("invalid draw size");this._drawWidth===t&&this._drawHeight===s||this._CalculateDeviceTransformMatrices(e,t,s,0,0,this._projectionMatrix,this._modelViewMatrix),this._drawWidth=t,this._drawHeight=s}_CalculateDeviceTransformMatrices(e,t,s,i,r,n,a){const o=t/2+i,l=s/2+r;e.CalculatePerspectiveMatrix(n,t/s);const h=e.CalculateLookAtModelView2(o,l,e.GetDefaultCameraZ(s),o,l,0,s);h_.copy(a,h)}_CalculateRectangles(e){this._layoutRect.copy(e.layoutRect),e.drawSurfaceRect?this._drawSurfaceRect.copy(e.drawSurfaceRect):this._drawSurfaceRect.set(0,0,this._drawWidth,this._drawHeight),this._rcTexOriginal.copy(this._drawSurfaceRect),this._rcTexOriginal.divide(this._drawWidth,this._drawHeight);const t=this._layerScale*this._devicePixelRatio;this._drawSurfaceRect.inflate(this._boxExtendHorizontal*t,this._boxExtendVertical*t),this._rcTexDest.copy(this._drawSurfaceRect),this._rcTexDest.divide(this._drawWidth,this._drawHeight),this._drawSurfaceRect.clampBoth(0,0,this._drawWidth,this._drawHeight),this._rcTexBounce.copy(this._drawSurfaceRect),this._rcTexBounce.divide(this._drawWidth,this._drawHeight)}_OnBeforeStartEffectChain(e){if(this._depthEnabledAtStart=e.IsDepthEnabled(),this._coplanarColorPassAtStart=e.IsCoplanarColorPass(),this._useFullSurface)e.SetDepthEnabled(!1),this._isAnyShaderDepthSampling&&e.SetDepthSamplingEnabled(!0);else{if(u_.copy(this._drawSurfaceRect),e.IsWebGL()){const e=this._layerScale*this._devicePixelRatio;u_.inflate(Math.max(this._boxExtendHorizontal,1)*e,Math.max(this._boxExtendVertical,1)*e),u_.roundOuter(),u_.clamp(0,0,this._drawWidth,this._drawHeight)}else u_.roundOuter();e.SetScissorRect(u_.getLeft(),u_.getTop(),u_.width(),u_.height(),this._drawHeight)}}_OnAfterEffectChainDrawContent(e){e.ResetColor(),this._useFullSurface||(this._coplanarColorPassAtStart&&e.CoplanarRestoreStandardRendering(),e.SetDepthEnabled(!1),this._isAnyShaderDepthSampling&&e.SetDepthSamplingEnabled(!0)),e.IsWebGPU()&&e.SetNormalizedCoordsProgramVariant(!0)}_OnAfterEndEffectChain(e){e.SetDepthSamplingEnabled(!1),this._coplanarColorPassAtStart&&e.CoplanarStartColorPass(),e.SetDepthEnabled(this._depthEnabledAtStart),this._useFullSurface||e.RemoveScissorRect(),e.IsWebGPU()&&e.SetNormalizedCoordsProgramVariant(!1),this._didChangeTransform=e.DidChangeTransform()}_ClampRcTexDest(){this._rcTexDest.clamp(0,0,1,1)}_GetRenderTargetForId(e){return e<0?null:this._renderTargets[e]}_GetRenderTarget(){return this._manager.GetRenderTarget(this)}_GetDestRenderTarget(){return this._destRenderTarget}_ReleaseRenderTarget(e){this._manager.ReleaseRenderTarget(e,this)}_GetShaderProgramAt(e){return this._shaderProgramList[e]}_DrawContent(e){this._cbDrawContentHook?this._cbDrawContentHook(this,e,()=>this._cbDrawContent(e,this)):this._cbDrawContent(e,this),this._canUseFastPath||this._OnAfterEffectChainDrawContent(e)}_IsRenderTargetSameSizeAndOffset(e){if(this._useFullSurface)return!0;if(0!==this._compositOffX||0!==this._compositOffY||0!==this._compositRtWidth||0!==this._compositRtHeight)return!1;const[t,s]=e.GetRenderTargetSize(e.GetRenderTarget());return t===this._drawWidth&&s===this._drawHeight}_SetDeviceTransform(e,t){let s=this._projectionMatrix,i=this._modelViewMatrix;if(t&&!this._IsRenderTargetSameSizeAndOffset(e)){let t,r;s=__,i=m_,0!==this._compositRtWidth&&0!==this._compositRtHeight?[t,r]=[this._compositRtWidth,this._compositRtHeight]:[t,r]=e.GetRenderTargetSize(e.GetRenderTarget()),this._CalculateDeviceTransformMatrices(e,t,r,this._compositOffX,this._compositOffY,s,i),this._useFullSurface||e.RemoveScissorRect()}e.SetProjectionMatrix(s),e.SetModelViewMatrix(i)}_Redraw(){this._manager.Redraw(this)}_GetShaderParameters(e,t){return this._cbGetShaderParameters(this._shaderProgramIndices[e],t)}_SetProgramParameters(e,t){let s=this._rcTexDest,i=this._rcTexBounce,r=this._rcTexOriginal;e.IsWebGL()&&(c_.copy(s),c_.flipAround(1),s=c_,d_.copy(i),d_.flipAround(1),i=d_,p_.copy(r),p_.flipAround(1),r=p_),this._DoSetProgramParameters(e,t,i,r,s,1/this._drawWidth,1/this._drawHeight)}_SetFirstBounceProgramParameters(e,t){let s=this._rcTexBounce,i=this._rcTexOriginal,r=1/this._drawWidth,n=1/this._drawHeight;if(this._cbGetSourceTextureInfo){let{srcTexRect:e,srcWidth:t,srcHeight:a}=this._cbGetSourceTextureInfo(this._contentObject);e||(u_.set(0,0,0,0),e=u_),t||(t=this._drawWidth),a||(a=this._drawHeight),s=e,i=e,r=1/t,n=1/a}else e.IsWebGL()&&(d_.copy(s),d_.flipAround(1),s=d_,p_.copy(i),p_.flipAround(1),i=p_);let a=this._rcTexDest;e.IsWebGL()&&(a=c_,a.copy(this._rcTexDest),a.flipAround(1)),this._DoSetProgramParameters(e,t,s,i,a,r,n),e.IsWebGPU()&&this._isAnyIsSrcTexRotated&&e.SetProgramParameter_IsSrcTexRotated(this._isSourceTextureRotated)}_GetBackTex(e){return this._isAnyShaderBackgroundBlending?e.IsWebGPU()?this._UseCopyTextureBackgroundSampling()?this._backTex:this._destRenderTarget.GetTexture():this._destRenderTarget:null}_DoSetProgramParameters(e,t,s,i,r,n,a){e.SetProgramParameters(this._GetBackTex(e),r,s,i,this._layoutRect,n,a,this._devicePixelRatio,this._layerScale,this._layerAngle,this._time),e.SetProgramCustomParameters(this._GetShaderParameters(t,e))}_Render_FastPath(e,t){const s=this._shaderProgramList[0],i=e.IsDepthEnabled(),r=s.UsesDepth();r&&(e.SetDepthEnabled(!1),e.SetDepthSamplingEnabled(!0),this._rcTexDest.set(0,0,1,1),this._rcTexOriginal.set(0,0,1,1)),e.SetProgram(s),e.SetBlendMode(this._blendMode),e.SetRenderTarget(this._destRenderTarget),e.ResetCullState();let n=0,a=1;if(this._rcTexOriginal.set(0,0,1,1),s.UsesAnySrcRectOrPixelSize()&&this._cbGetSourceTextureInfo){const{srcTexRect:e,srcWidth:t,srcHeight:s}=this._cbGetSourceTextureInfo(this._contentObject);e&&this._rcTexOriginal.copy(e),n=Number.isFinite(t)?1/t:0,a=Number.isFinite(s)?1/s:0}else{const[t,s]=this._manager.GetDrawSize(e);n=1/t,a=1/s}t.layoutRect?this._layoutRect.copy(t.layoutRect):this._layoutRect.set(0,0,0,0),e.SetProgramParameters(this._GetBackTex(e),this._rcTexDest,this._rcTexOriginal,this._rcTexOriginal,this._layoutRect,n,a,this._devicePixelRatio,this._layerScale,this._layerAngle,this._time),e.SetProgramCustomParameters(this._GetShaderParameters(0,e)),e.IsWebGPU()&&this._isAnyIsSrcTexRotated&&e.SetProgramParameter_IsSrcTexRotated(this._isSourceTextureRotated),e.SetBaseZ(0),this._DrawContent(e),r&&(e.SetDepthSamplingEnabled(!1),e.SetDepthEnabled(i))}_UseCopyTextureBackgroundSampling(){return this._useCopyTextureBackgroundSampling}_UseRenderTargetBackgroundSampling(){return!this._useCopyTextureBackgroundSampling}IsAnyShaderBackgroundBlending(){return this._isAnyShaderBackgroundBlending}CanSkipCalculatingDrawSurfaceRect(){return!!this._canUseFastPath&&!this._UseCopyTextureBackgroundSampling()}UseFullSurface(){return this._useFullSurface}GetContentObject(){return this._contentObject}GetContextObject(){return this._contextObject}_GetBlendMode(){return this._blendMode}_UpdateOwnProjection(){return this._updateOwnProjection}DidChangeTransform(){return this._didChangeTransform}_GetDrawSurfaceRect(){return this._drawSurfaceRect}_GetRcTexBounce(){return this._rcTexBounce}_ShouldInvalidateRenderTargets(){return this._invalidateRenderTargets}async DebugLogRenderTargetContents(e,t,s){}}}{const y_=self.C3;y_.Gfx.EffectChain.Step=class{constructor(e,t,s,i=-1){this._effectChain=e,this._srcTargetId=t,this._destTargetId=s,this._index=i}GetEffectChain(){return this._effectChain}GetSrcTargetId(){return this._srcTargetId}GetDestTargetId(){return this._destTargetId}GetIndex(){return this._index}GetShaderProgram(){return this.GetEffectChain()._GetShaderProgramAt(this.GetIndex())}Run_WebGL(e,t,s){}Run_WebGPU(e,t,s){}}}{const S_=self.C3;S_.Gfx.EffectChain.Step.PreDraw=class extends S_.Gfx.EffectChain.Step{constructor(e,t,s,i){super(e,t,s,i)}Run_WebGL(e,t,s){const i=this.GetEffectChain();e.SetAlphaBlend(),e.ResetCullState(),e.SetTextureFillMode(),e.SetRenderTarget(s,i._UpdateOwnProjection()),e.ClearRgba(0,0,0,0),i._DrawContent(e),i._ClampRcTexDest()}Run_WebGPU(e,t,s){const i=this.GetEffectChain();e.SetAlphaBlend(),e.ResetCullState(),e.SetTextureFillMode(),e.SetRenderTarget(s,!1),e.ClearRgba(0,0,0,0),i._DrawContent(e),i._ClampRcTexDest()}}}{const T_=self.C3,x_=T_.New(T_.Rect),b_=T_.New(T_.Quad);T_.Gfx.EffectChain.Step.PostDraw=class extends T_.Gfx.EffectChain.Step{constructor(e,t,s,i){super(e,t,s,i)}Run_WebGL(e,t,s){const i=this.GetEffectChain();e.SetTextureFillMode(),e.SetRenderTarget(s),i._SetDeviceTransform(e,!0),e.SetBlendMode(i._GetBlendMode()),e.SetTexture(t.GetTexture()),b_.setFromRect(i._GetDrawSurfaceRect()),x_.copy(i._GetRcTexBounce()),x_.flipAround(1),e.Quad3(b_,x_),i._ShouldInvalidateRenderTargets()&&e.InvalidateRenderTarget(t)}Run_WebGPU(e,t,s){const i=this.GetEffectChain();e.SetTextureFillMode(),e.SetRenderTarget(s,!1),i._IsRenderTargetSameSizeAndOffset(e)?b_.setFromRect(i._GetRcTexBounce()):(e.SetNormalizedCoordsProgramVariant(!1),i._SetDeviceTransform(e,!0),b_.setFromRect(i._GetDrawSurfaceRect())),e.SetBackTexture(null),e.SetBlendMode(i._GetBlendMode()),e.SetTexture(t.GetTexture()),i.UseFullSurface()?e.FullscreenQuad():e.Quad3(b_,i._GetRcTexBounce())}}}{const G_=self.C3;G_.Gfx.EffectChain.Step.FirstBounce=class extends G_.Gfx.EffectChain.Step{constructor(e,t,s,i){super(e,t,s,i)}Run_WebGL(e,t,s){const i=this.GetEffectChain();e.SetRenderTarget(s,i._UpdateOwnProjection()),e.ClearRgba(0,0,0,0),e.SetCopyBlend(),e.SetProgram(this.GetShaderProgram()),i._SetFirstBounceProgramParameters(e,this.GetIndex()),i._DrawContent(e),i._ClampRcTexDest()}Run_WebGPU(e,t,s){const i=this.GetEffectChain();e.SetRenderTarget(s,!1),e.ClearRgba(0,0,0,0),e.SetCopyBlend(),e.SetProgram(this.GetShaderProgram()),i._SetFirstBounceProgramParameters(e,this.GetIndex()),i._DrawContent(e),i._ClampRcTexDest()}}}{const I_=self.C3,v_=I_.New(I_.Rect),C_=I_.New(I_.Quad);I_.Gfx.EffectChain.Step.Bounce=class extends I_.Gfx.EffectChain.Step{constructor(e,t,s,i){super(e,t,s,i)}Run_WebGL(e,t,s){const i=this.GetEffectChain();e.SetRenderTarget(s);const r=0===this.GetDestTargetId();r?e.SetBlendMode(i._GetBlendMode()):(e.ClearRgba(0,0,0,0),e.SetCopyBlend()),e.SetProgram(this.GetShaderProgram()),i._SetProgramParameters(e,this.GetIndex()),e.SetTexture(t.GetTexture()),i._SetDeviceTransform(e,r),C_.setFromRect(i._GetDrawSurfaceRect()),v_.copy(i._GetRcTexBounce()),v_.flipAround(1),e.Quad3(C_,v_),i._ShouldInvalidateRenderTargets()&&e.InvalidateRenderTarget(t)}Run_WebGPU(e,t,s){const i=this.GetEffectChain();e.SetRenderTarget(s,!1),0===this.GetDestTargetId()?(e.SetBlendMode(i._GetBlendMode()),e.SetBackTexture(null),i._IsRenderTargetSameSizeAndOffset(e)?C_.setFromRect(i._GetRcTexBounce()):(e.SetNormalizedCoordsProgramVariant(!1),i._SetDeviceTransform(e,!0),C_.setFromRect(i._GetDrawSurfaceRect()))):(e.ClearRgba(0,0,0,0),e.SetCopyBlend(),C_.setFromRect(i._GetRcTexBounce())),e.SetProgram(this.GetShaderProgram()),i._SetProgramParameters(e,this.GetIndex()),e.SetTexture(t.GetTexture()),i.UseFullSurface()?e.FullscreenQuad():e.Quad3(C_,i._GetRcTexBounce())}}}{let w_=function(e,t){const s=e[0]-t[0];return 0!==s?s:e[1]-t[1]};SortZOrderList=w_;const A_=self.C3,R_=self.C3X;let P_=null;const M_=new Set,E_=[],D_=[];let N_=!1,F_=!1,O_=!1;const B_=new Set(["vsync","unlimited-tick","unlimited-frame"]);self.IRuntime=class{constructor(e){P_=e,Object.defineProperties(this,{assets:{value:P_.GetAssetManager().GetIAssetManager(),writable:!1},collisions:{value:P_.GetCollisionEngine().GetICollisionEngine(),writable:!1},objects:{value:{},writable:!1},globalVars:{value:{},writable:!1},projectName:{value:P_.GetProjectName(),writable:!1},projectVersion:{value:P_.GetProjectVersion(),writable:!1},projectId:{value:P_.GetAppId(),writable:!1},projectUniqueId:{value:P_.GetProjectUniqueId(),writable:!1},exportDate:{value:new Date(P_.GetExportTimestamp()),writable:!1},storage:{value:new self.IStorage(P_),writable:!1},isInWorker:{value:P_.IsInWorker(),writable:!1},viewportWidth:{value:P_.GetOriginalViewportWidth(),writable:!1},viewportHeight:{value:P_.GetOriginalViewportHeight(),writable:!1},sampling:{value:P_.GetSampling(),writable:!1},isPixelRoundingEnabled:{value:P_.IsPixelRoundingEnabled(),writable:!1},platformInfo:{value:new self.IPlatformInfo(e),writable:!1},sdk:{value:new self.ISDKUtils(e),writable:!1}}),P_.UserScriptDispatcher().addEventListener("keydown",e=>{M_.has(e.key)?e.stopPropagation():M_.add(e.key)}),P_.UserScriptDispatcher().addEventListener("keyup",e=>M_.delete(e.key)),P_.Dispatcher().addEventListener("window-blur",()=>M_.clear()),P_.IsInWorker()&&(self.alert=e=>(N_||(N_=!0,console.warn("[Construct] alert() was called from a Web Worker, because the project 'Use worker' setting is enabled. This method is not normally available in a Web Worker. Construct has implemented the alert for you, but note that other features may be missing in worker mode. You may wish to disable 'Use worker', or use a more convenient function like console.log(). For more information please refer to the scripting section of the manual.")),this.alert(e)))}_InitObjects(e){Object.defineProperties(this.objects,e)}_InitGlobalVars(e){Object.defineProperties(this.globalVars,e)}addEventListener(e,t){P_.UserScriptDispatcher().addEventListener(e,t)}removeEventListener(e,t){P_.UserScriptDispatcher().removeEventListener(e,t)}callFunction(e,...t){R_.RequireString(e);const s=P_.GetEventSheetManager(),i=s.GetFunctionBlockByName(e);if(!i)throw new Error(`cannot find function name '${e}'`);if(!i.IsEnabled())return i.GetDefaultReturnValue();if(t.length<i.GetFunctionParameterCount())throw new Error(`not enough function parameters passed for '${e}' (${t.length} passed, ${i.GetFunctionParameterCount()} expected)`);const r=i.GetEventBlock();let n=r.GetSolModifiersIncludingParents();const a=s.GetCurrentEvent();if(a){n=n.slice(0);const e=new Set(n);for(const t of a.GetSolModifiersIncludingParents())e.has(t)||(n.push(t),e.add(t));for(const t of s.GetDynamicSolModifiersSet())e.has(t)||(n.push(t),e.add(t))}return r.RunAsExpressionFunctionCall(n,i.IsCopyPicked(),i.GetReturnType(),i.GetDefaultReturnValue(),...t)}setReturnValue(e){const t=P_.GetEventStack().GetCurrentExpFuncStackFrame();if(!t)throw new Error("not in a function which returns a value");switch(t.GetFunctionReturnType()){case 1:"number"==typeof e&&t.SetFunctionReturnValue(e);break;case 2:"string"==typeof e&&t.SetFunctionReturnValue(e);break;case 3:"number"!=typeof e&&"string"!=typeof e||t.SetFunctionReturnValue(e)}}signal(e){R_.RequireString(e),P_.GetEventSheetManager().Signal(e)}waitForSignal(e){return R_.RequireString(e),P_.GetEventSheetManager().WaitForSignal(e)}getViewportSize(){return[P_.GetOriginalViewportWidth(),P_.GetOriginalViewportHeight()]}get isSuspended(){return P_.IsSuspended()}get dt(){return P_.GetDt()}get dtRaw(){return P_.GetDtRaw()}get gameTime(){return P_.GetGameTime()}get tickCount(){return P_.GetTickCount()}get wallTime(){return P_.GetWallTime()}get timeScale(){return P_.GetTimeScale()}set timeScale(e){R_.RequireFiniteNumber(e),P_.SetTimeScale(e)}get fps(){return F_||(console.warn("IRuntime.fps is deprecated. Use IRuntime.framesPerSecond instead."),F_=!0),P_.GetFramesPerSecond()}get framesPerSecond(){return P_.GetFramesPerSecond()}get ticksPerSecond(){return P_.GetTicksPerSecond()}get cpuUtilisation(){return P_.GetMainThreadTime()}get gpuUtilisation(){return P_.GetGPUUtilisation()}get framerateMode(){return P_.GetFramerateMode()}set framerateMode(e){if(!B_.has(e))throw new Error("invalid framerate mode");P_._SetFramerateMode(e)}get minDt(){return P_.GetMinDt()}set minDt(e){R_.RequireFiniteNumber(e),P_.SetMinDt(e)}get maxDt(){return P_.GetMaxDt()}set maxDt(e){P_.SetMaxDt(e)}get loadingProgress(){return P_.GetAssetManager().GetLoadProgress()}get imageLoadingProgress(){return P_.GetAssetManager().GetImageLoadProgress()}random(){return P_.Random()}get layout(){const e=P_.GetMainRunningLayout();if(!e)throw new Error("no layout is running - make sure a layout is loaded before accessing");return e.GetILayout()}getLayout(e){const t=P_.GetLayoutManager();let s=null;if("number"!=typeof e&&"string"!=typeof e)throw new TypeError("expected string or number");if(s=t.GetLayout(e),!s)throw new Error("invalid layout");return s.GetILayout()}getAllLayouts(){return P_.GetLayoutManager().GetAllLayouts().map(e=>e.GetILayout())}goToLayout(e){const t=P_.GetLayoutManager();let s=null;if("number"!=typeof e&&"string"!=typeof e)throw new TypeError("expected string or number");if(s=t.GetLayout(e),!s)throw new Error("invalid layout");t.IsPendingChangeMainLayout()||t.ChangeMainLayout(s)}get keyboard(){const e=P_._GetCommonScriptInterfaces().keyboard;if(!e)throw new Error("runtime.keyboard used but Keyboard object missing - add it to your project first");return e}get mouse(){const e=P_._GetCommonScriptInterfaces().mouse;if(!e)throw new Error("runtime.mouse used but Mouse object missing - add it to your project first");return e}get touch(){const e=P_._GetCommonScriptInterfaces().touch;if(!e)throw new Error("runtime.touch used but Touch object missing - add it to your project first");return e}get timelineController(){const e=P_._GetCommonScriptInterfaces().timelineController;if(!e)throw new Error("runtime.timelineController used but Timeline Controller object missing - add it to your project first");return e}get renderer(){return P_.GetCanvasManager().GetIRenderer()}invokeDownload(e,t){R_.RequireString(e),R_.RequireString(t),P_.InvokeDownload(e,t)}getInstanceByUid(e){R_.RequireFiniteNumber(e);const t=P_.GetInstanceByUID(e);return t?t.GetInterfaceClass():null}sortZOrder(e,t){R_.RequireFunction(t);const s=P_.GetCurrentLayout();for(const t of e){const e=P_._UnwrapIWorldInstance(t),s=e.GetWorldInfo();E_.push([s.GetLayer().GetIndex(),s.GetZIndex()]),D_.push(e)}if(0===E_.length)return;E_.sort(w_),D_.sort((e,s)=>t(e.GetInterfaceClass(),s.GetInterfaceClass()));let i=!1;for(let e=0,t=E_.length;e<t;++e){const t=D_[e],r=s.GetLayerByIndex(E_[e][0]),n=E_[e][1],a=r._GetInstances();a[n]!==t&&(a[n]=t,t.GetWorldInfo()._SetLayer(r,!0),r.SetZIndicesChanged(t),i=!0)}i&&P_.UpdateRender(),A_.clearArray(E_),A_.clearArray(D_)}async createWorker(e,t){O_||(console.warn("IRuntime.createWorker() is deprecated. All modern browsers now support nested workers so this method is no longer needed."),O_=!0);const s=new MessageChannel,i=s.port1,r=s.port2;return await P_.PostComponentMessageToDOMAsync("runtime","script-create-worker",{url:e,opts:t,port2:r},[r]),i}alert(e){return P_.PostComponentMessageToDOMAsync("runtime","alert",{message:e+(P_.IsInWorker()?" [via Web Worker]":"")})}getHTMLLayer(e){return R_.RequireFiniteNumber(e),P_._GetHTMLLayerWrapElement(e)}addLoadPromise(e){P_.AddLoadPromise(e)}async saveCanvasImage(e,t,s){R_.RequireOptionalString(e),R_.RequireOptionalNumber(t),R_.RequireOptionalInstanceOf(s,DOMRect),s||(s=new DOMRect(0,0,0,0));const i=P_.GetCanvasManager();if(!i)return;P_.UpdateRender();const r=await i.SnapshotCanvas(e||"image/png",t,s.x,s.y,s.width,s.height);return await P_.TriggerAsync(A_.Plugins.System.Cnds.OnCanvasSnapshot,null),r}}}{const L_=self.C3,k_=self.C3X;let V_=null;self.IAssetManager=class{constructor(e){V_=e,Object.defineProperties(this,{isWebMOpusSupported:{value:!0,writable:!1}})}loadImageAsset(e){const t=self.IImageInfo._Unwrap(e);if(!t)throw new Error("invalid IImageInfo");t.LoadAsset(V_.GetRuntime())}fetchText(e){return V_.FetchText(e)}fetchJson(e){return V_.FetchJson(e)}fetchBlob(e){return V_.FetchBlob(e)}fetchArrayBuffer(e){return V_.FetchArrayBuffer(e)}getProjectFileUrl(e){return V_.GetProjectFileUrl(e)}getMediaFileUrl(e){return"flat"===V_.GetFileStructure()&&L_.IsRelativeURL(e)&&(e=e.toLowerCase()),V_.GetMediaFileUrl(e)}get mediaFolder(){return V_.GetMediaSubfolder()}async decodeWebMOpus(e,t){throw new Error("decodeWebMOpus() is no longer supported - use Web Audio's decodeAudioData() directly as all supported platforms now support WebM Opus")}loadScripts(...e){return V_.LoadScripts(...e)}compileWebAssembly(e){return V_.CompileWebAssembly(e)}loadStyleSheet(e){return V_.LoadStyleSheet(e)}}}{const U_=self.C3,W_=self.C3X;let H_=null;self.ICollisionEngine=class{constructor(e){H_=e,Object.defineProperties(this,{runtime:{value:H_.GetRuntime(),writable:!1}})}testOverlap(e,t){const s=H_.GetRuntime(),i=s._UnwrapIWorldInstance(e),r=s._UnwrapIWorldInstance(t);return H_.TestOverlap(i,r)}testOverlapAny(e,t){const s=H_.GetRuntime(),i=s._UnwrapIWorldInstance(e);for(const e of t){const t=s._UnwrapIWorldInstance(e);if(H_.TestOverlap(i,t))return e}return null}testOverlapSolid(e){const t=H_.GetRuntime()._UnwrapIWorldInstance(e),s=H_.TestOverlapSolid(t);return s?s.GetInterfaceClass():null}setCollisionCellSize(e,t){if(W_.RequireFiniteNumber(e),W_.RequireFiniteNumber(t),e=Math.floor(e),t=Math.floor(t),e<=0||t<=0)throw new Error("invalid cell size");H_.SetCollisionCellSize(e,t)}getCollisionCellSize(){return H_.GetCollisionCellSize()}getCollisionCandidates(e,t){const s=H_.GetRuntime();let i;i=Array.isArray(e)?e.map(e=>s._UnwrapIObjectClass(e)):[s._UnwrapIObjectClass(e)];const r=U_.Rect.FromObject(t),n=[];return H_.GetObjectClassesCollisionCandidates(null,i,r,n),n.map(e=>e.GetInterfaceClass())}}}{const z_=self.C3,j_=self.C3X;let Y_=null;const q_=new Map([["Windows","windows"],["macOS","macos"],["Linux","linux"],["Chrome OS","chrome-os"],["Android","android"],["iOS","ios"]]),X_=new Map([["Chrome","chrome"],["Chromium","chromium"],["Edge","edge"],["Opera","opera"],["NW.js","nwjs"],["Firefox","firefox"],["Safari","safari"]]),$_=new Map([["Chromium","chromium"],["Gecko","gecko"],["WebKit","webkit"]]);self.IPlatformInfo=class{constructor(e){Y_=e,Object.defineProperties(this,{isMobile:{value:z_.Platform.IsMobile,writable:!1},os:{value:q_.get(z_.Platform.OS)||"unknown",writable:!1},osVersion:{value:z_.Platform.OSVersion,writable:!1},browser:{value:X_.get(z_.Platform.Browser)||"unknown",writable:!1},browserVersion:{value:z_.Platform.BrowserVersion,writable:!1},browserEngine:{value:$_.get(z_.Platform.BrowserEngine)||"unknown",writable:!1}})}get exportType(){let e=Y_.GetExportType();return Y_.IsNWjs()?e="nwjs":Y_.IsWindowsWebView2()?e="windows-webview2":"cordova"===e?e="Android"===z_.Platform.OS?"cordova-android":"cordova-ios":"playable-ad-single-file"!==e&&"playable-ad-zip"!==e||(e="playable-ad"),e}get renderer(){return Y_.GetCanvasManager().GetRendererString()}get rendererDetail(){return Y_.GetCanvasManager().GetRendererDetailString()}get canvasClientX(){return Y_.GetCanvasManager().GetCanvasClientX()}get canvasClientY(){return Y_.GetCanvasManager().GetCanvasClientY()}get canvasCssWidth(){return Y_.GetCanvasManager().GetCssWidth()}get canvasCssHeight(){return Y_.GetCanvasManager().GetCssHeight()}get canvasDeviceWidth(){return Y_.GetCanvasManager().GetDeviceWidth()}get canvasDeviceHeight(){return Y_.GetCanvasManager().GetDeviceHeight()}get devicePixelRatio(){return Y_.GetDevicePixelRatio()}}}{const K_=self.C3,J_=self.C3X;self.IStorage=class{constructor(e){this._storage=e._GetProjectStorage()}getItem(e){return J_.RequireString(e),this._storage.getItem(e)}setItem(e,t){return J_.RequireString(e),this._storage.setItem(e,t)}removeItem(e){return J_.RequireString(e),this._storage.removeItem(e)}clear(){return this._storage.clear()}keys(){return this._storage.keys()}}}{const Q_=self.C3,Z_=self.C3X,em=Q_._GetInternalAPIToken();self.IPlugin=class{#e;constructor(){const e=Q_.AddonManager._GetInitObject2(em);this.#e=e,Object.defineProperties(this,{runtime:{value:e.GetRuntime().GetIRuntime(),writable:!1},id:{value:e.GetID(),writable:!1},isSingleGlobal:{value:e.IsSingleGlobal(),writable:!1},isWorldType:{value:e.IsWorldType(),writable:!1},isHTMLElementType:{value:e.IsHTMLElementType(),writable:!1},isRotatable:{value:e.IsRotatable(),writable:!1},hasEffects:{value:e.HasEffects(),writable:!1},is3d:{value:e.Is3D(),writable:!1},supportsHierarchies:{value:e.SupportsSceneGraph(),writable:!1},supportsMesh:{value:e.SupportsMesh(),writable:!1}}),e.GetRuntime()._MapScriptInterface(this,e)}static getByConstructor(e){if(!e)return null;const t=Q_.AddonManager.GetPluginByConstructorFunction(e);return t?t.GetIPlugin():null}getSingleGlobalObjectType(){return this.#e.GetSingleGlobalObjectClass().GetIObjectClass()}getSingleGlobalInstance(){return this.#e.GetSingleGlobalInstance().GetInterfaceClass()}}}{const tm=globalThis.C3,sm=globalThis.C3X,im=tm._GetInternalAPIToken();globalThis.IObjectClass=class{#e;constructor(){const e=tm.AddonManager._GetInitObject2(im);this.#e=e,Object.defineProperties(this,{name:{value:e.GetName(),writable:!1},runtime:{value:e.GetRuntime().GetIRuntime(),writable:!1},plugin:{value:e.GetPlugin().GetIPlugin(),writable:!1}}),e.GetRuntime()._MapScriptInterface(this,e)}addEventListener(e,t){sm.RequireString(e),sm.RequireFunction(t),this.#e.UserScriptDispatcher().addEventListener(e,t)}removeEventListener(e,t){sm.RequireString(e),sm.RequireFunction(t),this.#e.UserScriptDispatcher().removeEventListener(e,t)}getAllInstances(){return[...this.instances()]}getFirstInstance(){return tm.first(this.instances())}getPickedInstances(){return[...this.pickedInstances()]}getFirstPickedInstance(){return tm.first(this.pickedInstances())}getPairedInstance(e){const t=this.#e,s=t.GetRuntime()._UnwrapIInstance(e),i=t.GetPairedInstance(s);return i?i.GetInterfaceClass():null}*instances(){for(const e of this.#e.instancesIncludingPendingCreate())yield e.GetInterfaceClass()}*pickedInstances(){for(const e of this.#e.GetCurrentSol().GetInstances())yield e.GetInterfaceClass()}}}{const rm=globalThis.C3,nm=globalThis.C3X,am=rm._GetInternalAPIToken();globalThis.IObjectType=class extends globalThis.IObjectClass{#e;constructor(){super();const e=rm.AddonManager._GetInitObject2(am);this.#e=e}setInstanceClass(e){nm.RequireFunction(e);const t=this.#e;if(t.GetInstanceCount()>0)throw new Error("setInstanceClass() called too late, because instances have already been created - call in runOnStartup");t._SetUserScriptInstanceClass(e)}createInstance(e,t,s,i,r){if(nm.RequireNumber(t),nm.RequireNumber(s),"number"!=typeof e&&"string"!=typeof e)throw new TypeError("invalid layer parameter");const n=this.#e,a=n.GetRuntime(),o=a.GetMainRunningLayout().GetLayer(e);if(!o)throw new Error("invalid layer");const l=a.CreateInstance(n,o,t,s,i,r);i&&o.SortAndAddInstancesByZIndex(l);const h=a.GetEventSheetManager();return h.BlockFlushingInstances(!0),l._TriggerOnCreatedOnSelfAndRelated(),h.BlockFlushingInstances(!1),h.IsInEventEngine()||a.GetLayoutManager().IsEndingLayout()||a.FlushPendingInstances(),l.GetInterfaceClass()}getAllFamilies(){return this.#e.GetFamilies().map(e=>e.GetIObjectClass())}*families(){for(const e of this.#e.GetFamilies())yield e.GetIObjectClass()}isInFamily(e){return nm.RequireInstanceOf(e,globalThis.IFamily),e.hasObjectType(this)}}}{const om=globalThis.C3,lm=globalThis.C3X,hm=globalThis.IObjectType,um=om._GetInternalAPIToken();globalThis.IFamily=class extends globalThis.IObjectClass{#e;constructor(){super();const e=om.AddonManager._GetInitObject2(um);this.#e=e}getAllObjectTypes(){return this.#e.GetFamilyMembers().map(e=>e.GetIObjectClass())}*objectTypes(){for(const e of this.#e.GetFamilyMembers())yield e.GetIObjectClass()}hasObjectType(e){lm.RequireInstanceOf(e,hm);const t=this.#e,s=t.GetRuntime()._UnwrapIObjectClass(e);return t.FamilyHasMember(s)}}}{const cm=self.C3,dm=self.C3X,pm=["above","below","top-sublayer","bottom-sublayer"];self.ILayout=class{#e;constructor(e){this.#e=e;const t=[],s=e.GetEffectList(),i=s.GetAllEffectTypes().length;for(let e=0;e<i;++e)t.push(new self.IEffectInstance(s,e));Object.defineProperties(this,{runtime:{value:e.GetRuntime().GetIRuntime(),writable:!1},name:{value:e.GetName(),writable:!1},index:{value:e.GetIndex(),writable:!1},effects:{value:t,writable:!1}})}addEventListener(e,t){dm.RequireString(e),dm.RequireFunction(t),this.#e.UserScriptDispatcher().addEventListener(e,t)}removeEventListener(e,t){dm.RequireString(e),dm.RequireFunction(t),this.#e.UserScriptDispatcher().removeEventListener(e,t)}get width(){return this.#e.GetWidth()}set width(e){dm.RequireFiniteNumber(e),this.#e.SetWidth(e)}get height(){return this.#e.GetHeight()}set height(e){dm.RequireFiniteNumber(e),this.#e.SetHeight(e)}setSize(e,t){dm.RequireFiniteNumber(e),dm.RequireFiniteNumber(t);const s=this.#e;s.SetWidth(e),s.SetHeight(t)}getSize(){const e=this.#e;return[e.GetWidth(),e.GetHeight()]}set scale(e){dm.RequireFiniteNumber(e),this.#e.SetScale(e)}get scale(){return this.#e.GetScale()}set angle(e){dm.RequireFiniteNumber(e),this.#e.SetAngle(e)}get angle(){return this.#e.GetAngle()}set scrollX(e){dm.RequireNumber(e),this.#e.SetScrollX(e)}get scrollX(){return this.#e.GetScrollX()}set scrollY(e){dm.RequireNumber(e),this.#e.SetScrollY(e)}get scrollY(){return this.#e.GetScrollY()}scrollTo(e,t){dm.RequireNumber(e),dm.RequireNumber(t);const s=this.#e;s.SetScrollX(e),s.SetScrollY(t)}getScrollPosition(){const e=this.#e;return[e.GetScrollX(),e.GetScrollY()]}get isUnboundedScrolling(){return this.#e.IsUnboundedScrolling()}getLayer(e){const t=this.#e;let s=null;if("number"!=typeof e&&"string"!=typeof e)throw new TypeError("expected string or number");return s=t.GetLayer(e),s?s.GetILayer():null}getAllLayers(){return this.#e.GetLayers().map(e=>e.GetILayer())}*allLayers(){for(const e of this.#e.allLayers())yield e.GetILayer()}addLayer(e,t,s){const i=this.#e,r=self.ILayer;dm.RequireString(e),dm.RequireOptionalInstanceOf(t,r);const n=t?i.GetRuntime()._UnwrapScriptInterface(t):null,a=pm.indexOf(s);if(a<0)throw new Error("invalid location");i.AddLayer(e,n,a)}moveLayer(e,t,s){const i=this.#e,r=i.GetRuntime(),n=self.ILayer;dm.RequireInstanceOf(e,n);const a=r._UnwrapScriptInterface(e);if(!a)throw new Error("invalid layer");dm.RequireOptionalInstanceOf(t,n);const o=t?r._UnwrapScriptInterface(t):null,l=pm.indexOf(s);if(l<0)throw new Error("invalid location");i.MoveLayer(a,o,l)}removeLayer(e){const t=this.#e,s=self.ILayer;dm.RequireInstanceOf(e,s);const i=t.GetRuntime()._UnwrapScriptInterface(e);if(!i)throw new Error("invalid layer");const r=i.GetRuntime();t.RemoveLayer(i),r.GetEventSheetManager().IsInEventEngine()||r.FlushPendingInstances()}removeAllDynamicLayers(){const e=this.#e,t=e.GetRuntime();e.RemoveAllDynamicLayers(),t.GetEventSheetManager().IsInEventEngine()||t.FlushPendingInstances()}setVanishingPoint(e,t){dm.RequireFiniteNumber(e),dm.RequireFiniteNumber(t),this.#e.SetVanishingPointXY(e,t)}getVanishingPoint(){return this.#e.GetVanishingPoint()}set projection(e){dm.RequireString(e);const t=this.#e;if("perspective"===e)t.SetPerspectiveProjection();else{if("orthographic"!==e)throw new Error("invalid projection");t.SetOrthographicProjection()}}get projection(){return this.#e.IsOrthographicProjection()?"orthographic":"perspective"}}}{const _m=self.C3,mm=self.C3X,fm=new Map([["normal",0],["additive",1],["copy",3],["destination-over",4],["source-in",5],["destination-in",6],["source-out",7],["destination-out",8],["source-atop",9],["destination-atop",10]]),gm=new Map([...fm.entries()].map(e=>[e[1],e[0]])),ym=new Set(["2d","3d"]),Sm=_m.New(_m.Color);self.ILayer=class{#e;constructor(e){this.#e=e;const t=[],s=e.GetEffectList(),i=s.GetAllEffectTypes().length;for(let e=0;e<i;++e)t.push(new self.IEffectInstance(s,e));Object.defineProperties(this,{runtime:{value:e.GetRuntime().GetIRuntime(),writable:!1},name:{value:e.GetName(),writable:!1},layout:{value:e.GetLayout().GetILayout(),writable:!1},effects:{value:t,writable:!1}}),e.GetRuntime()._MapScriptInterface(this,e)}addEventListener(e,t){this.#e.UserScriptDispatcher().addEventListener(e,t)}removeEventListener(e,t){this.#e.UserScriptDispatcher().removeEventListener(e,t)}get parentLayer(){const e=this.#e.GetParentLayer();return e?e.GetILayer():null}*parentLayers(){for(const e of this.#e.parentLayers())yield e.GetILayer()}*subLayers(){for(const e of this.#e.GetSubLayers())yield e.GetILayer()}*allSubLayers(){for(const e of this.#e.GetSubLayers())for(const t of e.selfAndAllSubLayers())yield t.GetILayer()}get index(){return this.#e.GetIndex()}get isVisible(){return this.#e._IsVisibleFlagSet()}set isVisible(e){this.#e.SetVisible(e)}get isSelfAndParentsVisible(){return this.#e.IsVisible()}get isInteractive(){return this.#e.IsInteractive()}set isInteractive(e){this.#e.SetInteractive(e)}get isHTMLElementsLayer(){return this.#e.IsHTMLElementsLayer()}set isHTMLElementsLayer(e){this.#e.SetIsHTMLElementsLayer(!!e)}get isSelfAndParentsInteractive(){return this.#e.IsSelfAndParentsInteractive()}get opacity(){return this.#e.GetOpacity()}set opacity(e){e=_m.clamp(+e,0,1),isNaN(e)||this.#e.SetOpacity(e)}set scale(e){mm.RequireFiniteNumber(e),this.#e.SetOwnScale(e)}get scale(){return this.#e.GetOwnScale()}set scaleRate(e){mm.RequireFiniteNumber(e),this.#e.SetScaleRate(e)}get scaleRate(){return this.#e.GetScaleRate()}set angle(e){mm.RequireFiniteNumber(e),this.#e.SetAngle(e)}get angle(){return this.#e.GetOwnAngle()}set parallaxX(e){mm.RequireFiniteNumber(e),this.#e.SetParallaxX(e)}get parallaxX(){return this.#e.GetParallaxX()}set parallaxY(e){mm.RequireFiniteNumber(e),this.#e.SetParallaxY(e)}get parallaxY(){return this.#e.GetParallaxY()}set zElevation(e){mm.RequireFiniteNumber(e),this.#e.SetZElevation(e)}get zElevation(){return this.#e.GetZElevation()}set renderingMode(e){if(!ym.has(e))throw TypeError("invalid rendering mode");this.#e.SetRenderAs3D("3d"===e)}get renderingMode(){return this.#e.IsRenderAs3D()?"3d":"2d"}set isTransparent(e){this.#e.SetTransparent(e)}get isTransparent(){return this.#e.IsTransparent()}set isForceOwnTexture(e){this.#e.SetForceOwnTexture(e)}get isForceOwnTexture(){return this.#e.IsForceOwnTexture()}set blendMode(e){mm.RequireString(e);const t=fm.get(e);if("number"!=typeof t)throw new Error("invalid blend mode");this.#e.SetBlendMode(t)}get blendMode(){return gm.get(this.#e.GetBlendMode())}set backgroundColor(e){if(mm.RequireArray(e),e.length<3)throw new Error("expected 3 elements");Sm.setRgb(e[0],e[1],e[2]);const t=this.#e,s=t.GetBackgroundColor();s.equalsIgnoringAlpha(Sm)||(s.copyRgb(Sm),t.GetRuntime().UpdateRender())}get backgroundColor(){const e=this.#e.GetBackgroundColor();return[e.getR(),e.getG(),e.getB()]}set scrollX(e){mm.RequireNumber(e);const t=this.#e;t.SetOwnScrollPositionEnabled(!0),t.SetScrollX(e)}get scrollX(){return this.#e.GetScrollX()}set scrollY(e){mm.RequireNumber(e);const t=this.#e;t.SetOwnScrollPositionEnabled(!0),t.SetScrollY(e)}get scrollY(){return this.#e.GetScrollY()}scrollTo(e,t){mm.RequireNumber(e),mm.RequireNumber(t);const s=this.#e;s.SetOwnScrollPositionEnabled(!0),s.SetScrollX(e),s.SetScrollY(t)}getScrollPosition(){const e=this.#e;return[e.GetScrollX(),e.GetScrollY()]}restoreScrollPosition(){this.#e.SetOwnScrollPositionEnabled(!1)}getViewport(){return this.#e.GetViewport().toDOMRect()}cssPxToLayer(e,t,s=0){mm.RequireNumber(e),mm.RequireNumber(t),mm.RequireNumber(s);const i=this.#e,r=i.GetRuntime();return i.CanvasCssToLayer(e-r.GetCanvasClientX(),t-r.GetCanvasClientY(),s)}layerToCssPx(e,t,s=0){mm.RequireNumber(e),mm.RequireNumber(t),mm.RequireNumber(s);const i=this.#e,r=i.GetRuntime(),[n,a]=i.LayerToCanvasCss(e,t,s);return[n+r.GetCanvasClientX(),a+r.GetCanvasClientY()]}drawSurfaceToLayer(e,t,s=0){return mm.RequireNumber(e),mm.RequireNumber(t),mm.RequireNumber(s),this.#e.DrawSurfaceToLayer(e,t,s)}layerToDrawSurface(e,t,s=0){return mm.RequireNumber(e),mm.RequireNumber(t),mm.RequireNumber(s),this.#e.LayerToDrawSurface(e,t,s)}get renderScale(){return this.#e.GetRenderScale()}}}{let Tm=function(e){let t=Gm.get(e);return t||(t=xm.New(xm.Event.Dispatcher),Gm.set(e,t),t)};GetDispatcher=Tm;const xm=self.C3,bm=self.C3X,Gm=new WeakMap,Im=xm._GetInternalAPIToken();self.IInstance=class{#e;constructor(){const e=xm.AddonManager._GetInitObject2(Im);this.#e=e;const t={runtime:{value:e.GetRuntime().GetIRuntime(),writable:!1},objectType:{value:e.GetObjectClass().GetIObjectClass(),writable:!1},plugin:{value:e.GetPlugin().GetIPlugin(),writable:!1}};e._GetInstVarsScriptDescriptor(t),e._GetBehaviorsScriptDescriptor(t),Object.defineProperties(this,t),e.GetRuntime()._MapScriptInterface(this,e)}static _GetInitInst(){return xm.AddonManager._GetInitObject()}_release(){const e=Gm.get(this);e&&(e.Release(),Gm.delete(this))}addEventListener(e,t,s){bm.RequireString(e),bm.RequireFunction(t),Tm(this).addEventListener(e,t,s)}removeEventListener(e,t,s){bm.RequireString(e),bm.RequireFunction(t),Tm(this).removeEventListener(e,t,s)}dispatchEvent(e){Tm(this).dispatchEvent(e)}destroy(){const e=this.#e,t=e.GetRuntime();t.DestroyInstance(e),t.GetEventSheetManager().IsInEventEngine()||t.GetLayoutManager().IsEndingLayout()||t.GetEventSheetManager().IsFlushingBlocked()||t.FlushPendingInstances()}getOtherContainerInstances(){const e=this.#e.GetSiblings();return e?e.map(e=>e.GetInterfaceClass()):[]}*otherContainerInstances(){const e=this.#e;if(e.IsInContainer())for(const t of e.siblings())yield t.GetInterfaceClass()}get uid(){return this.#e.GetUID()}get iid(){return this.#e.GetIID()}get templateName(){return this.#e.GetTemplateName()}set timeScale(e){bm.RequireFiniteNumber(e),this.#e.SetTimeScale(e)}get timeScale(){return this.#e.GetActiveTimeScale()}restoreTimeScale(){this.#e.RestoreTimeScale()}get dt(){const e=this.#e;return e.GetRuntime().GetDt(e)}hasTags(...e){bm.RequireArray(e);const t=new Set(e),s=this.#e.GetTagsSet();return t.isSubsetOf(s)}setAllTags(e){bm.RequireInstanceOf(e,Set),this.#e.SetTagsSet(e)}getAllTags(){return new Set(this.#e.GetTagsSet())}signal(e){bm.RequireString(e);const t=this.#e;t.GetRuntime().GetEventSheetManager().InstanceSignal(t,e)}waitForSignal(e){bm.RequireString(e);const t=this.#e;return t.GetRuntime().GetEventSheetManager().WaitForInstanceSignal(t,e)}}}{const vm=self.C3,Cm=self.C3X,wm=vm._GetInternalAPIToken();self.ISDKInstanceBase=class extends self.IInstance{#e;#t=!1;#s=null;#i=!1;#r=null;#n;#a;constructor(e){super(),this.#e=vm.AddonManager._GetInitObject2(wm),this.#t=!1,this.#s=null,this.#i=!1,this.#r=null,this.#n=e?.domComponentId,this.#a=e?.wrapperComponentId}_release(){this._setTicking(!1),this._setTicking2(!1),super._release()}_getInitProperties(){return vm.AddonManager._GetInitProperties()}_trigger(e){const t=this.#e;t.GetRuntime().Trigger(e,t)}_triggerAsync(e){const t=this.#e;return t.GetRuntime().TriggerAsync(e,t)}_addDOMMessageHandler(e,t){if(Cm.RequireString(e),Cm.RequireFunction(t),!this.#n)throw new Error("no DOM component id set");this.#e.GetRuntime().AddDOMComponentMessageHandler(this.#n,e,t)}_addDOMMessageHandlers(e){Cm.RequireArray(e);for(const[t,s]of e)this._addDOMMessageHandler(t,s)}_postToDOM(e,t){if(Cm.RequireString(e),!this.#n)throw new Error("no DOM component id set");this.#e.GetRuntime().PostComponentMessageToDOM(this.#n,e,t)}_postToDOMAsync(e,t){if(Cm.RequireString(e),!this.#n)throw new Error("no DOM component id set");return this.#e.GetRuntime().PostComponentMessageToDOMAsync(this.#n,e,t)}_postToDOMMaybeSync(e,t){if(!this.#e.GetRuntime().IsInWorker())return window.c3_runtimeInterface._OnMessageFromRuntime({type:"event",component:this.#n,handler:e,data:t,responseId:null});this._postToDOM(e,t)}_setTicking(e){if(e=!!e,this.#t===e)return;this.#t=e;const t=this.#e.GetRuntime();if(e){if(!this.#s)if(this.#e.GetRuntime().IsDebug()){const e=globalThis.C3Debugger,t=this.plugin;this.#s=()=>{const s=performance.now();this._tick(),e.AddIndividualPluginTickTime(t,performance.now()-s)}}else this.#s=()=>this._tick();t.Dispatcher().addEventListener("tick",this.#s)}else t.Dispatcher().removeEventListener("tick",this.#s)}_isTicking(){return this.#t}_tick(){}_setTicking2(e){if(e=!!e,this.#i===e)return;this.#i=e;const t=this.#e.GetRuntime();if(e){if(!this.#r)if(this.#e.GetRuntime().IsDebug()){const e=globalThis.C3Debugger,t=this.plugin;this.#r=()=>{const s=performance.now();this._tick2(),e.AddIndividualPluginTickTime(t,performance.now()-s)}}else this.#r=()=>this._tick2();t.Dispatcher().addEventListener("tick2",this.#r)}else t.Dispatcher().removeEventListener("tick2",this.#r)}_isTicking2(){return this.#i}_tick2(){}_getDebuggerProperties(){return[]}_saveToJson(){return null}_loadFromJson(e){}_isWrapperExtensionAvailable(){if(!this.#a)throw new Error("no wrapper component id set");return this.#e.GetRuntime().HasWrapperComponentId(this.#a)}_addWrapperExtensionMessageHandler(e,t){if(Cm.RequireString(e),Cm.RequireFunction(t),!this.#a)throw new Error("no wrapper component id set");this.#e.GetRuntime().AddWrapperExtensionMessageHandler(this.#a,e,t)}_addWrapperMessageHandlers(e){Cm.RequireArray(e);for(const[t,s]of e)this._addWrapperExtensionMessageHandler(t,s)}_sendWrapperExtensionMessage(e,t){if(!this.#a)throw new Error("no wrapper component id set");this.runtime.sdk.sendWrapperExtensionMessage(this.#a,e,t)}_sendWrapperExtensionMessageAsync(e,t){if(!this.#a)throw new Error("no wrapper component id set");return this.runtime.sdk.sendWrapperExtensionMessageAsync(this.#a,e,t)}}}{let Am=function(e){return class t extends e{#e;#t;constructor(e){super(e);const t=Rm.AddonManager._GetInitObject2(Om),s=t.GetWorldInfo();this.#e=t,this.#t=s,Fm.set(this,t);const i=[],r=s.GetInstanceEffectList();if(r){const e=s.GetObjectClass().GetEffectList().GetAllEffectTypes().length;for(let t=0;t<e;++t)i.push(new self.IEffectInstance(r,t))}const n={effects:{value:i,writable:!1}};Object.defineProperties(this,n)}get layout(){return this.#t.GetLayout().GetILayout()}get layer(){return this.#t.GetLayer().GetILayer()}get x(){return this.#t.GetX()}set x(e){e=+e;const t=this.#t;isNaN(e)||t.GetX()===e||(t.SetX(e),t.SetBboxChanged())}get y(){return this.#t.GetY()}set y(e){e=+e;const t=this.#t;isNaN(e)||t.GetY()===e||(t.SetY(e),t.SetBboxChanged())}setPosition(e,t){e=+e,t=+t;const s=this.#t;isNaN(e)||isNaN(t)||s.GetX()===e&&s.GetY()===t||(s.SetXY(e,t),s.SetBboxChanged())}getPosition(){const e=this.#t;return[e.GetX(),e.GetY()]}offsetPosition(e,t){if(e=+e,t=+t,isNaN(e)||isNaN(t)||0===e&&0===t)return;const s=this.#t;s.OffsetXY(e,t),s.SetBboxChanged()}set originX(e){e=+e;const t=this.#t;isNaN(e)||t.GetOriginX()===e||(t.SetOriginX(e),t.SetBboxChanged())}get originX(){return this.#t.GetOriginX()}set originY(e){e=+e;const t=this.#t;isNaN(e)||t.GetOriginY()===e||(t.SetOriginY(e),t.SetBboxChanged())}get originY(){return this.#t.GetOriginY()}setOrigin(e,t){e=+e,t=+t;const s=this.#t;isNaN(e)||isNaN(t)||s.GetOriginX()===e&&s.GetOriginY()===t||(s.SetOriginX(e),s.SetOriginY(t),s.SetBboxChanged())}getOrigin(){const e=this.#t;return[e.GetOriginX(),e.GetOriginY()]}get zElevation(){return this.#t.GetZElevation()}set zElevation(e){e=+e;const t=this.#e,s=this.#t;isNaN(e)||s.GetZElevation()===e||(s.SetZElevation(e),t.GetRuntime().UpdateRender())}get totalZElevation(){return this.#t.GetTotalZElevation()}get width(){return this.#t.GetWidth()}set width(e){e=+e;const t=this.#t;isNaN(e)||t.GetWidth()===e||(t.SetWidth(e),t.SetBboxChanged())}get height(){return this.#t.GetHeight()}set height(e){e=+e;const t=this.#t;isNaN(e)||t.GetHeight()===e||(t.SetHeight(e),t.SetBboxChanged())}setSize(e,t){e=+e,t=+t;const s=this.#t;isNaN(e)||isNaN(t)||s.GetWidth()===e&&s.GetHeight()===t||(s.SetSize(e,t),s.SetBboxChanged())}getSize(){const e=this.#t;return[e.GetWidth(),e.GetHeight()]}get angle(){return this.#t.GetAngle()}set angle(e){e=Rm.clampAngle(+e);const t=this.#t;isNaN(e)||t.GetAngle()===e||(t.SetAngle(e),t.SetBboxChanged())}get angleDegrees(){return Rm.toDegrees(this.angle)}set angleDegrees(e){this.angle=Rm.toRadians(e)}getBoundingBox(e){return e?(this.#t.CalculateBbox(Dm,Nm,!1),Dm.toDOMRect()):this.#t.GetBoundingBox().toDOMRect()}getBoundingQuad(e){return e?(this.#t.CalculateBbox(Dm,Nm,!1),Nm.toDOMQuad()):this.#t.GetBoundingQuad().toDOMQuad()}isOnScreen(){return this.#t.IsInViewport2()}get isVisible(){return this.#t.IsVisible()}set isVisible(e){e=!!e;const t=this.#e,s=this.#t;s.IsVisible()!==e&&(s.SetVisible(e),t.GetRuntime().UpdateRender())}get opacity(){return this.#t.GetOpacity()}set opacity(e){e=Rm.clamp(+e,0,1);const t=this.#e,s=this.#t;isNaN(e)||s.GetOpacity()===e||(s.SetOpacity(e),t.GetRuntime().UpdateRender())}set colorRgb(e){if(Pm.RequireArray(e),e.length<3)throw new Error("expected 3 elements");km.setRgb(e[0],e[1],e[2]);const t=this.#e,s=this.#t;s.GetUnpremultipliedColor().equalsIgnoringAlpha(km)||(s.SetUnpremultipliedColor(km),t.GetRuntime().UpdateRender())}get colorRgb(){const e=this.#t.GetUnpremultipliedColor();return[e.getR(),e.getG(),e.getB()]}set blendMode(e){Pm.RequireString(e);const t=Bm.get(e);if("number"!=typeof t)throw new Error("invalid blend mode");const s=this.#e;this.#t.SetBlendMode(t),s.GetRuntime().UpdateRender()}get blendMode(){return Lm.get(this.#t.GetBlendMode())}moveToTop(){this.#t.ZOrderMoveToTop()}moveToBottom(){this.#t.ZOrderMoveToBottom()}moveToLayer(e){Pm.RequireInstanceOf(e,Em);const t=this.#e,s=t.GetRuntime()._UnwrapScriptInterface(e);if(!s)throw new Error("invalid layer");t.GetWorldInfo().ZOrderMoveToLayer(s)}moveAdjacentToInstance(e,s){Pm.RequireInstanceOf(e,t),this.#t.ZOrderMoveAdjacentToInstance(Fm.get(e),s)}get zIndex(){return this.#t.GetZIndex()}get isCollisionEnabled(){return this.#t.IsCollisionEnabled()}set isCollisionEnabled(e){this.#t.SetCollisionEnabled(!!e)}containsPoint(e,t){return Pm.RequireNumber(e),Pm.RequireNumber(t),this.#t.ContainsPoint(+e,+t)}testOverlap(e){Pm.RequireInstanceOf(e,t);const s=this.#e,i=Fm.get(e);return s.GetRuntime().GetCollisionEngine().TestOverlap(s,i)}testOverlapSolid(){const e=this.#e,t=e.GetRuntime().GetCollisionEngine().TestOverlapSolid(e);return t?t.GetInterfaceClass():null}getParent(){const e=this.#e.GetParent();return e?e.GetInterfaceClass():null}getTopParent(){const e=this.#e.GetTopParent();return e?e.GetInterfaceClass():null}*parents(){for(const e of this.#e.parents())yield e.GetInterfaceClass()}getChildCount(){return this.#e.GetChildCount()}getChildAt(e){const t=this.#e.GetChildAt(e);return t?t.GetInterfaceClass():null}*children(){for(const e of this.#e.children())yield e.GetInterfaceClass()}*allChildren(){for(const e of this.#e.allChildren())yield e.GetInterfaceClass()}addChild(e,s){Pm.RequireInstanceOf(e,t),Pm.RequireOptionalObject(s),s||(s={});const i=this.#e,r=Fm.get(e);i.AddChild(r,s)}removeChild(e){Pm.RequireInstanceOf(e,t);const s=this.#e,i=Fm.get(e);s.RemoveChild(i)}removeFromParent(){const e=this.#e;e.HasParent()&&e.GetParent().RemoveChild(e)}getHierarchyOpts(){const e=this.#t;return{transformX:e.GetTransformWithParentX(),transformY:e.GetTransformWithParentY(),transformWidth:e.GetTransformWithParentWidth(),transformHeight:e.GetTransformWithParentHeight(),transformAngle:e.GetTransformWithParentAngle(),transformZElevation:e.GetTransformWithParentZElevation(),transformOpacity:e.GetTransformWithParentOpacity(),transformVisibility:e.GetTransformWithParentVisibility(),destroyWithParent:e.GetDestroyWithParent()}}createMesh(e,t){Pm.RequireFiniteNumber(e),Pm.RequireFiniteNumber(t),this.#t.CreateMesh(e,t)}releaseMesh(){const e=this.#t;e.ReleaseMesh(),e.SetBboxChanged()}setMeshPoint(e,t,s){Pm.RequireFiniteNumber(e),Pm.RequireFiniteNumber(t),Pm.RequireObject(s);const i=this.#t;i.SetMeshPoint(e,t,s)&&i.SetBboxChanged()}getMeshPoint(e,t){let s=NaN,i=NaN,r=NaN,n=NaN,a=NaN;const o=this.#t;if(o.HasMesh()){const l=o.GetSourceMesh().GetMeshPointAt(e,t);null!==l&&(s=l.GetX(),i=l.GetY(),r=l.GetZElevation(),n=l.GetU(),a=l.GetV())}return{x:s,y:i,zElevation:r,u:n,v:a}}getMeshSize(){const e=this.#t;if(!e.HasMesh())return[0,0];const t=e.GetSourceMesh();return[t.GetHSize(),t.GetVSize()]}}};MakeIWorldInstanceClass=Am;const Rm=self.C3,Pm=self.C3X,Mm=self.IInstance,Em=self.ILayer,Dm=Rm.New(Rm.Rect),Nm=Rm.New(Rm.Quad),Fm=new WeakMap,Om=Rm._GetInternalAPIToken(),Bm=new Map([["normal",0],["additive",1],["copy",3],["destination-over",4],["source-in",5],["destination-in",6],["source-out",7],["destination-out",8],["source-atop",9],["destination-atop",10]]),Lm=new Map([...Bm.entries()].map(e=>[e[1],e[0]])),km=Rm.New(Rm.Color);self.IWorldInstance=Am(self.IInstance),self.IWorldInstanceSDKBase=Am(self.ISDKInstanceBase)}{const Vm=self.C3,Um=self.C3X;self.IDOMInstance=class extends self.IWorldInstance{#e;constructor(){super(),this.#e=self.IInstance._GetInitInst()}getElement(){return this.#e.GetSdkInstance()._GetElementInDOMMode()}focus(){this.#e.GetSdkInstance().FocusElement()}blur(){this.#e.GetSdkInstance().BlurElement()}setCssStyle(e,t){Um.RequireString(e),this.#e.GetSdkInstance().SetElementCSSStyle(e,t)}}}{let Wm=function(e){let t=jm.get(e);return t||(t=Hm.New(Hm.Event.Dispatcher),jm.set(e,t),t)};GetDispatcher=Wm;const Hm=self.C3,zm=self.C3X,jm=new WeakMap,Ym=Hm._GetInternalAPIToken();self.IBehaviorInstance=class{#e;constructor(){const e=Hm.AddonManager._GetInitObject2(Ym);this.#e=e;const t={runtime:{value:e.GetRuntime().GetIRuntime(),writable:!1},behavior:{value:e.GetBehavior().GetIBehavior(),writable:!1},behaviorType:{value:e.GetBehaviorType().GetIBehaviorType(),writable:!1}};Object.defineProperties(this,t),e.GetRuntime()._MapScriptInterface(this,e)}static _GetInitInst(){return Hm.AddonManager._GetInitObject()}get instance(){return this.#e.GetObjectInstance().GetInterfaceClass()}_release(){const e=jm.get(this);e&&(e.Release(),jm.delete(this))}addEventListener(e,t,s){zm.RequireString(e),zm.RequireFunction(t),Wm(this).addEventListener(e,t,s)}removeEventListener(e,t,s){zm.RequireString(e),zm.RequireFunction(t),Wm(this).removeEventListener(e,t,s)}dispatchEvent(e){Wm(this).dispatchEvent(e)}}}{const qm=self.C3,Xm=self.C3X,$m=qm._GetInternalAPIToken();self.IBehaviorType=class{constructor(){const e=qm.AddonManager._GetInitObject2($m),t={runtime:{value:e.GetRuntime().GetIRuntime(),writable:!1},behavior:{value:e.GetBehavior().GetIBehavior(),writable:!1},name:{value:e.GetName(),writable:!1}};Object.defineProperties(this,t)}}}{const Km=self.C3,Jm=self.C3X,Qm=Km._GetInternalAPIToken();self.IBehavior=class{#t;constructor(){const e=Km.AddonManager._GetInitObject2(Qm);this.#t=e;const t={runtime:{value:e.GetRuntime().GetIRuntime(),writable:!1},id:{value:e.GetID(),writable:!1}};Object.defineProperties(this,t),e.GetRuntime()._MapScriptInterface(this,e)}getAllInstances(){return this.#t.GetInstances().map(e=>e.GetInterfaceClass())}static getByConstructor(e){if(!e)return null;const t=Km.AddonManager.GetBehaviorByConstructorFunction(e);return t?t.GetIBehavior():null}}}{const Zm=self.C3,ef=self.C3X,tf=Zm.New(Zm.Color);self.IEffectInstance=class{#e;constructor(e,t){this.#e=e;const s={index:{value:t,writable:!1}};Object.defineProperties(this,s)}get name(){return this.#e.GetAllEffectTypes()[this.index].GetName()}get isActive(){return this.#e.IsEffectIndexActive(this.index)}set isActive(e){e=!!e;const t=this.#e;t.IsEffectIndexActive(this.index)!==e&&(t.SetEffectIndexActive(this.index,e),t.UpdateActiveEffects(),t.GetRuntime().UpdateRender())}setParameter(e,t){ef.RequireFiniteNumber(e),e=Math.floor(+e);const s=this.#e,i=s.GetEffectParameter(this.index,e);if(null===i)throw new RangeError("invalid index");if(i instanceof Zm.Color){if(!Array.isArray(t)||t.length<3)throw new TypeError("expected array with 3 elements");tf.setRgb(t[0],t[1],t[2]),t=tf}else if("number"!=typeof t)throw new TypeError("expected number");s.SetEffectParameter(this.index,e,t)&&s.IsEffectIndexActive(this.index)&&s.GetRuntime().UpdateRender()}getParameter(e){ef.RequireFiniteNumber(e),e=Math.floor(+e);const t=this.#e.GetEffectParameter(this.index,e);if(null===t)throw new RangeError("invalid index");return t instanceof Zm.Color?[t.getR(),t.getG(),t.getB()]:t}}}{const sf=self.C3,rf=self.C3X;self.IAnimation=class{#e;constructor(e){this.#e=e,Object.defineProperties(this,{name:{value:e.GetName(),writable:!1}})}get speed(){return this.#e.GetSpeed()}get isLooping(){return this.#e.IsLooping()}get repeatCount(){return this.#e.GetRepeatCount()}get repeatTo(){return this.#e.GetRepeatTo()}get isPingPong(){return this.#e.IsPingPong()}get frameCount(){return this.#e.GetFrameCount()}getFrames(){return this.#e.GetFrames().map(e=>e.GetIAnimationFrame())}*frames(){for(const e of this.#e.GetFrames())yield e.GetIAnimationFrame()}}}{const nf=self.C3,af=self.C3X;self.IImageInfo=class{#t;constructor(e){this.#t=e}static _Unwrap(e){return e.#t}get width(){return this.#t.GetWidth()}get height(){return this.#t.GetHeight()}getSize(){const e=this.#t;return[e.GetWidth(),e.GetHeight()]}getTexture(e){return e.getTextureForImageInfo(this)}getTexRect(){return this.#t.GetTexRect().toDOMRect()}}}{const of=self.C3,lf=self.C3X;self.IAnimationFrame=class extends self.IImageInfo{#t;constructor(e){super(e.GetImageInfo()),this.#t=e,Object.defineProperties(this,{duration:{value:e.GetDuration(),writable:!1},originX:{value:e.GetOriginX(),writable:!1},originY:{value:e.GetOriginY(),writable:!1}})}getOrigin(){const e=this.#t;return[e.GetOriginX(),e.GetOriginY()]}getImagePointCount(){return this.#t.GetImagePointCount()}getImagePointX(e){return this.getImagePoint(e)[0]}getImagePointY(e){return this.getImagePoint(e)[1]}getImagePoint(e){const t=this.#t;let s=null;if("number"==typeof e)s=t.GetImagePointByIndex(Math.floor(e));else{if("string"!=typeof e)throw new TypeError("expected string or number");s=t.GetImagePointByName(e)}return s?[s.GetX(),s.GetY()]:this.getOrigin()}getPolyPointCount(){const e=this.#t.GetCollisionPoly();return e?e.pointCount():0}getPolyPointX(e){return this.getPolyPoint(e)[0]}getPolyPointY(e){return this.getPolyPoint(e)[1]}getPolyPoint(e){lf.RequireFiniteNumber(e),e=Math.floor(e);const t=this.#t.GetCollisionPoly();if(!t||e<0||e>=t.pointCount())return[0,0];const s=t.pointsArr();return[s[2*e],s[2*e+1]]}get tag(){return this.#t.GetTag()}}}{let hf=function(e){const t=df.get(e);if(t.IsReleased())throw new Error("timeline/tween was released and is no longer valid");return t};GetTimelineState=hf;const uf=self.C3,cf=self.C3X,df=new WeakMap;self.ITimelineStateBase=class{constructor(e){df.set(this,e),e.GetRuntime()._MapScriptInterface(this,e)}pause(){hf(this).Stop()}resume(){hf(this).Resume()}stop(){hf(this).Reset()}hasTags(e){return hf(this).HasTags(e)}set time(e){cf.RequireFiniteNumber(e),hf(this).SetTime(e)}get time(){return hf(this).GetTime()}set totalTime(e){cf.RequireFiniteNumber(e),hf(this).SetTotalTime(e)}get totalTime(){return hf(this).GetTotalTime()}set isLooping(e){hf(this).SetLoop(!!e)}get isLooping(){return hf(this).GetLoop()}set isPingPong(e){hf(this).SetPingPong(!!e)}get isPingPong(){return hf(this).GetPingPong()}set playbackRate(e){cf.RequireFiniteNumber(e),hf(this).SetPlaybackRate(e)}get playbackRate(){return hf(this).GetPlaybackRate()}get progress(){const e=hf(this);return e.GetTime()/e.GetTotalTime()}get tags(){return hf(this).GetTags()}get finished(){return hf(this).GetPlayPromise()}get isPlaying(){return hf(this).IsPlaying()}get isPaused(){return hf(this).IsPaused()}get isReleased(){return df.get(this).IsReleased()}}}{let pf=function(e){const t=ff.get(e);if(t.IsReleased())throw new Error("timeline was released and is no longer valid");return t};GetTimelineState=pf;const _f=self.C3,mf=self.C3X,ff=new WeakMap;let gf=null;self.ITimelineState=class extends self.ITimelineStateBase{constructor(e){super(e),ff.set(this,e);const t={name:{value:e.GetName(),writable:!1}};Object.defineProperties(this,t)}}}{let yf=function(e){const t=xf.get(e);if(t.IsReleased())throw new Error("tween was released and is no longer valid");return t};GetTweenState=yf;const Sf=self.C3,Tf=self.C3X,xf=new WeakMap,bf=new WeakMap;let Gf=null;self.ITweenState=class extends self.ITimelineStateBase{constructor(e,t,s){super(e),Gf||(Gf=s.easeToIndexFunc),xf.set(this,e),t&&bf.set(this,t)}stop(){const e=yf(this);bf.get(this).ReleaseTween(e)}setEase(e){Tf.RequireString(e);const t=self.Ease.GetEaseFromIndex(Gf(e));yf(this).SetEase(t)}get instance(){const e=yf(this).GetInstance();return e?e.GetInterfaceClass():null}get isDestroyOnComplete(){return yf(this).GetDestroyInstanceOnComplete()}set isDestroyOnComplete(e){yf(this).SetDestroyInstanceOnComplete(!!e)}get value(){const e=yf(this);if("value"!==e.GetId())throw new Error("not a value tween");return e.GetPropertyTrack("value").GetSourceAdapterValue()}}}{const If=self.C3,vf=self.C3X;self.ISDKPluginBase=class extends self.IPlugin{constructor(){super()}}}{const Cf=self.C3,wf=self.C3X,Af=Cf._GetInternalAPIToken();self.ISDKDOMPluginBase=class extends self.ISDKPluginBase{#e;#s;#t=0;#n=new Map;constructor(e){if(super(),this.#e=Cf.AddonManager._GetInitObject2(Af),!e?.domComponentId)throw new Error("no DOM component ID specified");this.#s=e.domComponentId,this._addElementMessageHandler("elem-focused",e=>e._onElemFocused()),this._addElementMessageHandler("elem-blurred",e=>{e&&e._onElemBlurred()})}_addElement(e){const t=this.#t++;return this.#n.set(t,e),t}_removeElement(e){this.#n.delete(e)}_addElementMessageHandler(e,t){this.#e.GetRuntime().AddDOMComponentMessageHandler(this.#s,e,e=>{const s=this.#n.get(e.elementId);t(s,e)})}_addElementMessageHandlers(e){wf.RequireArray(e);for(const[t,s]of e)this._addElementMessageHandlers(t,s)}}}{const Rf=self.C3,Pf=self.C3X,Mf=new WeakMap,Ef=Rf._GetInternalAPIToken();self.ISDKObjectTypeBase=class extends self.IObjectType{#e;constructor(){super(),this.#e=Rf.AddonManager._GetInitObject2(Ef)}_onCreate(){}getImageInfo(){return this.#e.GetImageInfo().GetIImageInfo()}_loadTextures(e){}_releaseTextures(e){}_onDynamicTextureLoadComplete(){}_preloadTexturesWithInstances(e){}}}{const Df=self.C3,Nf=self.C3X,Ff=new WeakMap,Of=Df._GetInternalAPIToken();self.ISDKWorldInstanceBase=class extends self.IWorldInstanceSDKBase{#e;#r=null;#t=null;constructor(e){super(e),this.#e=Df.AddonManager._GetInitObject2(Of)}_release(){if(super._release(),this.#r){const e=this.#e.GetRuntime().Dispatcher();e.removeEventListener("renderercontextlost",this.#r),e.removeEventListener("renderercontextrestored",this.#t),this.#r=null,this.#t=null}}_handleRendererContextLoss(){if(this.#r)return;this.#r=()=>this._onRendererContextLost(),this.#t=()=>this._onRendererContextRestored();const e=this.#e.GetRuntime().Dispatcher();e.addEventListener("renderercontextlost",this.#r),e.addEventListener("renderercontextrestored",this.#t)}_onRendererContextLost(){}_onRendererContextRestored(){}_draw(e){}_rendersToOwnZPlane(){return!0}_mustPreDraw(){return!1}}}{const Bf=self.C3,Lf=self.C3X,kf=Bf.New(Bf.Rect),Vf=new WeakMap,Uf=Bf._GetInternalAPIToken();self.ISDKDOMInstanceBase=class extends self.ISDKWorldInstanceBase{#e=-1;#t=!0;#n=!1;#i=!1;#s=-.2;#a=Bf.New(Bf.Rect,0,0,-1,-1);#o=0;#l=0;#h=-1;#u=-1;#c=!1;constructor(e){if(!e?.domComponentId)throw new Error("no DOM component ID specified");super(e);const t=Bf.AddonManager._GetInitObject2(Uf);Vf.set(this,t),this.#e=this.plugin._addElement(this);const s=t.GetRuntime().GetCanvasManager();this.#o=s.GetLastWidth(),this.#l=s.GetLastHeight(),this._setTicking(!0)}_release(){super._release(),this.plugin._removeElement(this.#e),this._postToDOMElement("destroy"),this.#e=-1,Vf.delete(this)}_getElementInDOMMode(){if(Vf.get(this).GetRuntime().IsInWorker())throw new Error("not valid in worker mode");return this._postToDOMElementMaybeSync("get-element")}_postToDOMElement(e,t){t||(t={}),t.elementId=this.#e,this._postToDOM(e,t)}_postToDOMElementMaybeSync(e,t){return t||(t={}),t.elementId=this.#e,this._postToDOMMaybeSync(e,t)}_postToDOMElementAsync(e,t){return t||(t={}),t.elementId=this.#e,this._postToDOMAsync(e,t)}_createElement(e){e||(e={});const t=Vf.get(this).GetWorldInfo();e.elementId=this.#e,e.isVisible=t.IsVisible(),e.htmlIndex=t.GetLayer().GetHTMLIndex(),e.htmlZIndex=t.GetHTMLZIndex(),Object.assign(e,this._getElementState()),this.#t=!!e.isVisible,this._postToDOMMaybeSync("create",e),this._updatePosition(!0)}setElementVisible(e){e=!!e,this.#t!==e&&(this.#t=e,this._postToDOMElement("set-visible",{isVisible:e}))}_tick(){this._updatePosition(!1)}_shouldPreserveElement(){const e=Vf.get(this).GetRuntime().GetCanvasManager().GetFullscreenMode();return"Android"===Bf.Platform.OS&&("scale-inner"===e||"scale-outer"===e||"crop"===e)}_updatePosition(e){const t=Vf.get(this);if(t.IsDestroyed())return;const s=t.GetWorldInfo(),i=s.GetLayer(),r=s.GetBoundingBox();let[n,a]=i.LayerToCanvasCss(r.getLeft(),r.getTop()),[o,l]=i.LayerToCanvasCss(r.getRight(),r.getBottom());const h=t.GetRuntime().GetCanvasManager(),u=h.GetCssWidth(),c=h.GetCssHeight();if(!s.IsVisible()||!i.IsVisible())return void this.setElementVisible(!1);if(!this._shouldPreserveElement()&&(o<=0||l<=0||n>=u||a>=c))return void this.setElementVisible(!1);kf.set(n,a,o,l);const d=h.GetLastWidth(),p=h.GetLastHeight(),_=i.GetHTMLIndex(),m=s.GetHTMLZIndex();if(!e&&kf.equals(this.#a)&&this.#o===d&&this.#l===p&&this.#h===_&&this.#u===m)return void this.setElementVisible(!0);this.#a.copy(kf),this.#o=d,this.#l=p,this.#h=_,this.#u=m,this.setElementVisible(!0);let f=null;this.#i&&(f=i.GetDisplayScale()+this.#s),this._postToDOMElement("update-position",{left:Math.round(this.#a.getLeft()),top:Math.round(this.#a.getTop()),width:Math.round(this.#a.width()),height:Math.round(this.#a.height()),htmlIndex:_,htmlZIndex:m,fontSize:f})}focusElement(){this._postToDOMElementMaybeSync("focus",{focus:!0})}blurElement(){this._postToDOMElementMaybeSync("focus",{focus:!1})}_onElemFocused(){this.#n=!0}_onElemBlurred(){this.#n=!1}isElementFocused(){return this.#n}setElementCSSStyle(e,t){this.postToDOMElement("set-css-style",{prop:Bf.CSSToCamelCase(e),val:t})}setElementAttribute(e,t){this.postToDOMElement("set-attribute",{name:e,val:t})}removeElementAttribute(e){this.postToDOMElement("remove-attribute",{name:e})}_updateElementState(){this.#c||(this.#c=!0,Promise.resolve().then(()=>{this.#c=!1,this._postToDOMElement("update-state",this._getElementState())}))}_getElementState(){}_getElementId(){return this.#e}}}{const Wf=self.C3,Hf=self.C3X;self.ISDKBehaviorBase=class extends self.IBehavior{constructor(){super()}}}{const zf=self.C3,jf=self.C3X;self.ISDKBehaviorTypeBase=class extends globalThis.IBehaviorType{constructor(){super()}_onCreate(){}}}{const Yf=self.C3,qf=self.C3X,Xf=new WeakMap,$f=Yf._GetInternalAPIToken();self.ISDKBehaviorInstanceBase=class extends self.IBehaviorInstance{#i=!1;#t=!1;#e=!1;constructor(){super(),Xf.set(this,Yf.AddonManager._GetInitObject2($f))}_release(){super._release(),this._setTicking(!1),this._setTicking2(!1),this._setPostTicking(!1),Xf.delete(this)}_getInitProperties(){return Yf.AddonManager._GetInitProperties()}_postCreate(){}_trigger(e){const t=Xf.get(this);t.GetRuntime().Trigger(e,t.GetObjectInstance(),t.GetBehaviorType())}_triggerAsync(e){const t=Xf.get(this);return t.GetRuntime().TriggerAsync(e,t.GetObjectInstance(),t.GetBehaviorType())}_setTicking(e){if(e=!!e,this.#i===e)return;this.#i=e;const t=Xf.get(this).GetRuntime();e?t._AddBehInstToTick(this):t._RemoveBehInstToTick(this)}_isTicking(){return this.#i}_tick(){}_setTicking2(e){if(e=!!e,this.#t===e)return;this.#t=e;const t=Xf.get(this).GetRuntime();e?t._AddBehInstToTick2(this):t._RemoveBehInstToTick2(this)}_isTicking2(){return this.#t}_tick2(){}_setPostTicking(e){if(e=!!e,this.#e===e)return;this.#e=e;const t=Xf.get(this).GetRuntime();e?t._AddBehInstToPostTick(this):t._RemoveBehInstToPostTick(this)}_isPostTicking(){return this.#e}_postTick(){}_getDebuggerProperties(){return[]}_saveToJson(){return null}_loadFromJson(e){}}}{const Kf=self.C3,Jf=self.C3X;let Qf=null;self.ISDKUtils=class{constructor(e){Qf=e}addLoadPromise(e){Qf.AddLoadPromise(e)}sendWrapperExtensionMessage(e,t,s){Jf.RequireString(e),Jf.RequireString(t),Jf.RequireOptionalArray(s),Qf.SendWrapperExtensionMessage(e,t,s)}sendWrapperExtensionMessageAsync(e,t,s){return Jf.RequireString(e),Jf.RequireString(t),Jf.RequireOptionalArray(s),Qf.SendWrapperExtensionMessageAsync(e,t,s)}createLoopingConditionContext(e){return Jf.RequireOptionalString(e),new self.ILoopingConditionContext(Qf,e)}set isAutoSuspendEnabled(e){Qf._SetAutoSuspendEnabled(!!e)}get isAutoSuspendEnabled(){return Qf._IsAutoSuspendEnabled()}setSuspended(e){Qf.SetSuspended(!!e)}getObjectClassBySid(e){Jf.RequireNumber(e);const t=Qf.GetObjectClassBySID(e);return t?t.GetIObjectClass():null}}}{const Zf=self.C3,eg=self.C3X;self.ILoopingConditionContext=class{#e;#t;#a;#s;#n;#r;constructor(e,t){this.#e=e;const s=e.GetEventSheetManager(),i=e.GetCurrentEvent();this.#t=i,this.#a=i.GetSolModifiers();const r=e.GetEventStack();this.#s=r.GetCurrentStackFrame(),this.#n=r.Push(i);const n=s.GetLoopStack().Push();this.#r=n,t&&n.SetName(t),e.SetDebuggingEnabled(!1)}retrigger(){const e=this.#e.GetEventSheetManager(),t=this.#a,s=this.#r;e.PushCopySol(t),this.#t.Retrigger(this.#s,this.#n),e.PopSol(t),s.SetIndex(s.GetIndex()+1)}get isStopped(){return this.#r.IsStopped()}release(){const e=this.#e,t=e.GetEventStack(),s=e.GetEventSheetManager().GetLoopStack();e.SetDebuggingEnabled(!0),s.Pop(),t.Pop()}}}{let tg=function(e){return e instanceof ImageBitmap||"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas};IsStaticTextureDataType=tg;const sg=self.C3,ig=self.C3X;let rg=null,ng=null;const ag=["none","back","front"],og=["cw","ccw"];self.IRenderer=class{constructor(e,t){ng=e,rg=t}setAlphaBlendMode(){rg.SetAlphaBlend()}setBlendMode(e){rg.SetNamedBlendMode(e)}setColorFillMode(){rg.SetColorFillMode()}setTextureFillMode(){rg.SetTextureFillMode()}setSmoothLineFillMode(){rg.SetSmoothLineFillMode()}setColor(e){rg.SetColorRgba(e[0],e[1],e[2],e[3])}setColorRgba(e,t,s,i){rg.SetColorRgba(e,t,s,i)}resetColor(){rg.ResetColor()}setOpacity(e){rg.SetOpacity(e)}setCurrentZ(e){rg.SetCurrentZ(e)}getCurrentZ(){return rg.GetCurrentZ()}setCullFaceMode(e){const t=ag.indexOf(e);if(-1===t)throw new Error("invalid cull mode");rg.SetCullFaceMode(t)}getCullFaceMode(){return ag[rg.GetCullFaceMode()]}setFrontFaceWinding(e){const t=og.indexOf(e);if(-1===t)throw new Error("invalid front face winding");rg.SetFrontFaceWinding(t)}getFrontFaceWinding(){return rg.GetFrontFaceWinding()}rect(e){rg.Rect2(e.left,e.top,e.right,e.bottom)}rect2(e,t,s,i){rg.Rect2(e,t,s,i)}quad(e){rg.Quad(sg.Quad.fromDOMQuad(e))}quad2(e,t,s,i,r,n,a,o){rg.Quad2(e,t,s,i,r,n,a,o)}quad3(e,t){rg.Quad3(sg.Quad.fromDOMQuad(e),sg.Rect.fromDOMRect(t))}quad4(e,t){rg.Quad4(sg.Quad.fromDOMQuad(e),sg.Quad.fromDOMQuad(t))}quad5(e,t,s){rg.Quad5(sg.Quad.fromDOMQuad(e),sg.Quad.fromDOMQuad(t),s)}quad3D(e,t,s,i,r,n,a,o,l,h,u,c,d){rg.Quad3D(e,t,s,i,r,n,a,o,l,h,u,c,sg.Rect.fromDOMRect(d))}quad3D2(e,t,s,i,r,n,a,o,l,h,u,c,d){rg.Quad3D2(e,t,s,i,r,n,a,o,l,h,u,c,sg.Quad.fromDOMQuad(d))}quad3D3(e,t,s,i,r,n,a,o,l,h,u,c,d,p){rg.Quad3D3(e,t,s,i,r,n,a,o,l,h,u,c,sg.Quad.fromDOMQuad(d),p)}drawMesh(e,t,s,i){rg.DrawMesh(e,t,s,i)}convexPoly(e){rg.ConvexPoly(e)}line(e,t,s,i){rg.Line(e,t,s,i)}texturedLine(e,t,s,i,r,n){rg.TexturedLine(e,t,s,i,r,n)}lineRect(e,t,s,i){rg.LineRect(e,t,s,i)}lineRect2(e){rg.LineRect2(sg.Rect.fromDOMRect(e))}lineQuad(e){rg.LineQuad(sg.Quad.fromDOMQuad(e))}pushLineWidth(e){rg.PushLineWidth(e)}popLineWidth(){rg.PopLineWidth()}pushLineCap(e){rg.PushLineCap(e)}popLineCap(){rg.PopLineCap()}setTexture(e){ig.RequireOptionalInstanceOf(e,self.ITexture);const t=e?ng._UnwrapScriptInterface(e):null;rg.SetTexture(t)}loadTextureForImageInfo(e,t){const s=self.IImageInfo._Unwrap(e);if(!s)throw new Error("invalid IImageInfo");return s.LoadStaticTexture(rg,{wrapX:t?.wrapX??"clamp-to-edge",wrapY:t?.wrapY??"clamp-to-edge",sampling:t?.sampling??"trilinear",mipMap:t?.mipMap??!0})}releaseTextureForImageInfo(e){const t=self.IImageInfo._Unwrap(e);if(!t)throw new Error("invalid IImageInfo");t.ReleaseTexture()}getTextureForImageInfo(e){const t=self.IImageInfo._Unwrap(e);if(!t)throw new Error("invalid IImageInfo");const s=t.GetTexture();return self.ITexture.GetInterface(ng,s)}createStaticTexture(e,t){if(!tg(e))throw new TypeError("invalid texture data");const s=rg.CreateStaticTexture(e,{wrapX:t?.wrapX??"clamp-to-edge",wrapY:t?.wrapY??"clamp-to-edge",sampling:t?.sampling??"trilinear",mipMap:t?.mipMap??!0});return self.ITexture.GetInterface(ng,s)}createDynamicTexture(e,t,s){ig.RequireFiniteNumber(e),ig.RequireFiniteNumber(t);const i=rg.CreateDynamicTexture(e,t,{wrapX:s?.wrapX??"clamp-to-edge",wrapY:s?.wrapY??"clamp-to-edge",sampling:s?.sampling??"trilinear",mipMap:s?.mipMap??!0});return self.ITexture.GetInterface(ng,i)}updateTexture(e,t,s){ig.RequireInstanceOf(t,self.ITexture);const i=ng._UnwrapScriptInterface(t);rg.UpdateTexture(e,i,{premultiplyAlpha:s?.premultiplyAlpha??!0})}deleteTexture(e){ig.RequireInstanceOf(e,self.ITexture);const t=ng._UnwrapScriptInterface(e);rg.DeleteTexture(t)}createRendererText(){const e=rg.CreateRendererText();return new self.IRendererText(ng,e)}setDeviceTransform(){ng.GetCanvasManager().SetDeviceTransform(rg)}setLayerTransform(e){ig.RequireInstanceOf(e,globalThis.ILayer),ng._UnwrapScriptInterface(e)._SetTransform(rg)}}}{const lg=self.C3,hg=self.C3X,ug=new WeakMap,cg=new WeakMap;self.ITexture=class{constructor(e,t){ug.set(this,{runtime:e,texture:t}),cg.set(t,this),e._MapScriptInterface(this,t),Object.defineProperties(this,{width:{value:t.GetWidth(),writable:!1},height:{value:t.GetHeight(),writable:!1}})}static GetInterface(e,t){if(!t)return null;return cg.get(t)||new self.ITexture(e,t)}}}{let dg=function(e){return mg.get(e).rendererText};getActual=dg;const pg=self.C3,_g=self.C3X,mg=new WeakMap;self.IRendererText=class{constructor(e,t){mg.set(this,{runtime:e,rendererText:t}),e._MapScriptInterface(this,t)}release(){dg(this).Release()}set fontFace(e){_g.RequireString(e),dg(this).SetFontName(e)}get fontFace(){return dg(this).GetFontName()}set sizePt(e){_g.RequireFiniteNumber(e),dg(this).SetFontSize(e)}get sizePt(){return dg(this).GetFontSize()}set lineHeight(e){_g.RequireFiniteNumber(e),dg(this).SetLineHeight(e)}get lineHeight(){return dg(this).GetLineHeight()}set isBold(e){dg(this).SetBold(e)}get isBold(){return dg(this).IsBold()}set isItalic(e){dg(this).SetItalic(e)}get isItalic(){return dg(this).IsItalic()}setColor(e){_g.RequireArray(e),this.setColorRgb(e[0],e[1],e[2])}setColorRgb(e,t,s){dg(this).SetColorRgb(e,t,s)}setCssColor(e){_g.RequireString(e),dg(this).SetColor(e)}set horizontalAlign(e){dg(this).SetHorizontalAlignment(e)}get horizontalAlign(){return dg(this).GetHorizontalAlignment()}set verticalAlign(e){dg(this).SetVerticalAlignment(e)}get verticalAlign(){return dg(this).GetVerticalAlignment()}set wordWrapMode(e){dg(this).SetWordWrapMode(e)}get wordWrapMode(){return dg(this).GetWordWrapMode()}set textDirection(e){dg(this).SetTextDirection(e)}get textDirection(){return dg(this).GetTextDirection()}set text(e){_g.RequireString(e),dg(this).SetText(e)}get text(){return dg(this).GetText()}setSize(e,t,s){_g.RequireFiniteNumber(e),_g.RequireFiniteNumber(t),_g.RequireFiniteNumber(s),dg(this).SetSize(e,t,s)}getTexture(){const{runtime:e,rendererText:t}=mg.get(this),s=t.GetTexture();return self.ITexture.GetInterface(e,s)}getTexRect(){return dg(this).GetTexRect().toDOMRect()}setTextureUpdateCallback(e){_g.RequireFunction(e),dg(this).ontextureupdate=e}releaseTexture(){dg(this).ReleaseTexture()}get textWidth(){return dg(this).GetTextWidth()}get textHeight(){return dg(this).GetTextHeight()}}}{let fg=function(e){if(!e)return"";const t=e.split(".");if(t.length<2)return"";const s=t.at(-1).toLowerCase();return Tg.get(s)||""},gg=function(e){return new Promise((t,s)=>{const i=document.createElement("script");i.onload=t,i.onerror=s,i.async=!1,i.type="module",i.src=e,document.head.appendChild(i)})};GetTypeFromFileExtension=fg,AddScript=gg;const yg=self.C3,Sg=new Set(["local","remote"]),Tg=new Map([["mp4","video/mp4"],["webm","video/webm"],["m4a","audio/mp4"],["mp3","audio/mpeg"],["js","application/javascript"],["wasm","application/wasm"],["svg","image/svg+xml"],["html","text/html"]]);yg.AssetManager=class extends yg.DefendedBase{constructor(e,t){super();const s=t.exportType;this._runtime=e,this._fileStructure="folders",this._cordovaBlobUrlCache=new Map,this._isCordova="cordova"===s,this._isiOSCordova=!!t.isiOSCordova,this._isFileProtocol=!!t.isFileProtocol,this._swClientId=t.swClientId,this._supportedAudioFormats=t.supportedAudioFormats||{},this._audioFiles=new Map,this._preloadSounds=!1,this._scriptSubfolder=t.scriptFolder,this._mediaSubfolder="",this._fontsSubfolder="",this._iconsSubfolder="",this._fileMap=t.fileMap||new Map,this._fileMapBlobUrls=new Map;const i="html5"===s||"scirra-arcade"===s||"instant-games"===s;this._defaultLoadPolicy=i?"remote":"local",this._imageAssetsMap=new Map,this._webFonts=[],this._loadPromises=[],this._hasFinishedInitialLoad=!1,this._totalAssetSizeToLoad=0,this._assetSizeLoaded=0,this._lastLoadProgress=0,this._hasHadErrorLoading=!1,this._loadingRateLimiter=yg.New(yg.RateLimiter,()=>this._FireLoadingProgressEvent(),50),this._localPromiseThrottle=yg.New(yg.PromiseThrottle,Math.max(yg.hardwareConcurrency,8)),this._remotePromiseThrottle=yg.New(yg.PromiseThrottle,20),this._iAssetManager=new self.IAssetManager(this)}Release(){for(const e of this._imageAssetsMap.values())e.Release();this._imageAssetsMap.clear(),yg.clearArray(this._loadPromises),this._runtime=null}GetRuntime(){return this._runtime}_SetFileStructure(e){this._fileStructure=e}GetFileStructure(){return this._fileStructure}GetScriptSubfolder(){return this._scriptSubfolder}_SetMediaSubfolder(e){this._mediaSubfolder=e}GetMediaSubfolder(){return this._mediaSubfolder}_SetFontsSubfolder(e){this._fontsSubfolder=e}GetFontsSubfolder(){return this._fontsSubfolder}_SetIconsSubfolder(e){this._iconsSubfolder=e}GetIconsSubfolder(){return this._iconsSubfolder}IsFileProtocol(){return this._isFileProtocol}FetchBlob(e,t){return t=t||this._defaultLoadPolicy,yg.IsRelativeURL(e)?("flat"===this._fileStructure&&(e=e.toLowerCase()),this._isCordova&&this._isFileProtocol?this.CordovaFetchLocalFileAsBlob(e):"playable-ad-single-file"===this._runtime.GetExportType()?self.c3_runtimeInterface._PlayableAdFetchBlob(e):"local"===t?this._localPromiseThrottle.Add(()=>yg.FetchBlob(e)):this._remotePromiseThrottle.Add(()=>yg.FetchBlob(e))):yg.FetchBlob(e)}FetchArrayBuffer(e){return yg.IsRelativeURL(e)?("flat"===this._fileStructure&&(e=e.toLowerCase()),this._isCordova&&this._isFileProtocol?this.CordovaFetchLocalFileAsArrayBuffer(e):"playable-ad-single-file"===this._runtime.GetExportType()?yg.BlobToArrayBuffer(self.c3_runtimeInterface._PlayableAdFetchBlob(e)):"local"===this._defaultLoadPolicy?this._localPromiseThrottle.Add(()=>yg.FetchArrayBuffer(e)):this._remotePromiseThrottle.Add(()=>yg.FetchArrayBuffer(e))):yg.FetchArrayBuffer(e)}FetchText(e){return yg.IsRelativeURL(e)?("flat"===this._fileStructure&&(e=e.toLowerCase()),this._isCordova&&this._isFileProtocol?this.CordovaFetchLocalFileAsText(e):"playable-ad-single-file"===this._runtime.GetExportType()?yg.BlobToString(self.c3_runtimeInterface._PlayableAdFetchBlob(e)):"local"===this._defaultLoadPolicy?this._localPromiseThrottle.Add(()=>yg.FetchText(e)):this._remotePromiseThrottle.Add(()=>yg.FetchText(e))):yg.FetchText(e)}async FetchJson(e){const t=await this.FetchText(e);return JSON.parse(t)}_CordovaFetchLocalFileAs(e,t){return"flat"===this._fileStructure&&(e=e.toLowerCase()),this._runtime.PostComponentMessageToDOMAsync("runtime","cordova-fetch-local-file",{filename:e,as:t})}CordovaFetchLocalFileAsText(e){return this._CordovaFetchLocalFileAs(e,"text")}async CordovaFetchLocalFileAsBlob(e){const t=await this._CordovaFetchLocalFileAs(e,"buffer"),s=fg(e);return new Blob([t],{type:s})}async CordovaFetchLocalFileAsBlobURL(e){"flat"===this._fileStructure&&(e=e.toLowerCase());let t=this._cordovaBlobUrlCache.get(e);if(t)return t;const s=await this.CordovaFetchLocalFileAsBlob(e);return t=URL.createObjectURL(s),this._cordovaBlobUrlCache.set(e,t),t}CordovaFetchLocalFileAsArrayBuffer(e){return this._CordovaFetchLocalFileAs(e,"buffer")}GetMediaFileUrl(e){"flat"===this._fileStructure&&(e=e.toLowerCase());let t=this._mediaSubfolder+e;return"Gecko"===yg.Platform.BrowserEngine&&"preview"===this._runtime.GetExportType()&&(t=this._GetLocalBlobURLFromFileMap(t)),t}GetProjectFileUrl(e){return yg.IsAbsoluteURL(e)?Promise.resolve(e):this._isCordova&&this._isFileProtocol?this.CordovaFetchLocalFileAsBlobURL(e):"playable-ad-single-file"===this._runtime.GetExportType()?URL.createObjectURL(self.c3_runtimeInterface._PlayableAdFetchBlob(e)):("flat"===this._fileStructure&&(e=e.toLowerCase()),Promise.resolve(e))}GetProjectFileIframeUrl(e){if(yg.IsAbsoluteURL(e)||"preview"!==this._runtime.GetExportType()||!this._swClientId||!e)return e;try{const t=new URL(e,location.href);return t.searchParams.set("__c3_client_id",this._swClientId),t.toString()}catch(t){return console.warn("Invalid iframe URL: "+e),e}}LoadProjectFileUrl(e){return this.GetProjectFileUrl(e)}_GetImageAssetKey(e,t){return(t?"true":"false")+"|"+e}LoadImage(e){const t=!!e.isTiled;if(e.loadPolicy&&!Sg.has(e.loadPolicy))throw new Error("invalid load policy");const s=this._GetImageAssetKey(e.url,t);let i=this._imageAssetsMap.get(s);return i||(i=yg.New(yg.ImageAsset,this,{url:e.url,size:e.size||0,loadPolicy:e.loadPolicy||this._defaultLoadPolicy,isTiled:t}),this._imageAssetsMap.set(s,i),this._hasFinishedInitialLoad||(this._totalAssetSizeToLoad+=i.GetSize(),this._loadPromises.push(i.Load().then(()=>this._AddLoadedSize(i.GetSize())))),i)}_ReleaseImageAsset(e){const t=this._GetImageAssetKey(e.GetURL(),e.IsTiled());this._imageAssetsMap.delete(t)}async WaitForAllToLoad(){try{await Promise.all(this._loadPromises),this._lastLoadProgress=1}catch(e){console.error("Error loading: ",e),this._hasHadErrorLoading=!0,this._FireLoadingProgressEvent()}}SetInitialLoadFinished(){this._hasFinishedInitialLoad=!0}HasHadErrorLoading(){return this._hasHadErrorLoading}_AddLoadedSize(e){this._assetSizeLoaded+=e,this._loadingRateLimiter.Call()}_FireLoadingProgressEvent(){const e=yg.New(yg.Event,"loadingprogress");this._lastLoadProgress=yg.clamp(this._assetSizeLoaded/this._totalAssetSizeToLoad,0,1),e.progress=this._lastLoadProgress,this._runtime.Dispatcher().dispatchEvent(e),this._runtime.DispatchUserScriptEvent(yg.New(yg.Event,"loadingprogress"))}GetLoadProgress(){return this._lastLoadProgress}GetImageLoadProgress(){return this._runtime.GetSystemPlugin().GetImageLoadingProgress()}_SetWebFonts(e){yg.shallowAssignArray(this._webFonts,e),this._webFonts.length&&this._loadPromises.push(this._LoadWebFonts())}async _LoadWebFonts(){const e=[],t=[];for(const[s,i,r]of this._webFonts)this._totalAssetSizeToLoad+=r,e.push(this._LoadWebFont(s,i,t).then(()=>this._AddLoadedSize(r)));await Promise.all(e),this._runtime.IsInWorker()&&t.length>0&&await this._runtime.PostComponentMessageToDOMAsync("runtime","load-webfonts",{webfonts:t})}async _LoadWebFont(e,t,s){try{let i=await this.GetProjectFileUrl(t);"Gecko"===yg.Platform.BrowserEngine&&(e=`'${e}'`),("Gecko"===yg.Platform.BrowserEngine&&"preview"===this._runtime.GetExportType()||"playable-ad-single-file"===this._runtime.GetExportType())&&(i=this._GetLocalBlobURLFromFileMap(i));const r=new FontFace(e,`url('${i}')`);this._runtime.IsInWorker()?self.fonts.add(r):document.fonts.add(r),await r.load(),this._runtime.IsInWorker()&&s.push({name:e,url:i})}catch(t){console.warn(`[C3 runtime] Failed to load web font '${e}': `,t)}}IsAudioFormatSupported(e){return!!this._supportedAudioFormats[e]}_SetAudioFiles(e,t){this._preloadSounds=!!t;for(const[t,s,i]of e)this._audioFiles.set(t,{fileName:t,formats:s.map(e=>({type:e[0],fileExtension:e[1],fullName:t+e[1],fileSize:e[2]})),isMusic:i})}GetPreferredAudioFile(e){"flat"===this._fileStructure&&(e=e.toLowerCase());const t=this._audioFiles.get(e);if(!t)return null;let s=null;for(const e of t.formats)if(s||"audio/webm; codecs=opus"!==e.type||(s=e),this.IsAudioFormatSupported(e.type))return e;return s}GetProjectAudioFileUrl(e){const t=this.GetPreferredAudioFile(e);return t?{url:this.GetMediaFileUrl(t.fullName),type:t.type}:null}GetAudioToPreload(){if(this._preloadSounds){const e=[];for(const t of this._audioFiles.values()){if(t.isMusic)continue;const s=this.GetPreferredAudioFile(t.fileName);s&&e.push({originalUrl:t.fileName,url:this.GetMediaFileUrl(s.fullName),type:s.type,fileSize:s.fileSize})}return e}return[]}_GetLocalBlobFromFileMap(e){return"preview"===this._runtime.GetExportType()&&(e=new URL(e,location.href).toString()),this._fileMap.get(e)||null}_GetLocalBlobURLFromFileMap(e){let t=this._fileMapBlobUrls.get(e);if(t)return t;const s=this._GetLocalBlobFromFileMap(e);return s?(t=URL.createObjectURL(s),this._fileMapBlobUrls.set(e,t),t):e}GetIAssetManager(){return this._iAssetManager}async LoadScripts(...e){const t=await Promise.all(e.map(e=>this.GetProjectFileUrl(e)));if(this._runtime.IsInWorker())if(1===e.length){const t=e[0];await import((yg.IsRelativeURL(t)?"./":"")+t)}else{const t=e.map(e=>`import "${yg.IsRelativeURL(e)?"./":""}${e}";`).join("\n"),s=URL.createObjectURL(new Blob([t],{type:"application/javascript"}));await import(s)}else await Promise.all(t.map(e=>gg(e)))}async CompileWebAssembly(e){if(WebAssembly.compileStreaming){const t=await this.GetProjectFileUrl(e);return await WebAssembly.compileStreaming(fetch(t))}{const t=await yg.FetchArrayBuffer(e);return await WebAssembly.compile(t)}}async LoadStyleSheet(e){const t=await this.GetProjectFileUrl(e);return await this._runtime.PostComponentMessageToDOMAsync("runtime","add-stylesheet",{url:t})}}}{const xg=self.C3;xg.Asset=class extends xg.DefendedBase{constructor(e,t){super(),this._assetManager=e,this._runtime=e.GetRuntime(),this._url=t.url||"",this._size=t.size,this._loadPolicy=t.loadPolicy,this._blob=t.blob||null,this._isLoaded=!!this._blob,this._loadPromise=null}Release(){this._loadPromise=null,this._assetManager=null,this._runtime=null,this._blob=null}GetURL(){return this._url}GetSize(){return this._size}Load(){return"local"===this._loadPolicy||this._blob?(this._isLoaded=!0,Promise.resolve()):(this._loadPromise||(this._loadPromise=this._assetManager.FetchBlob(this._url,this._loadPolicy).then(e=>(this._isLoaded=!0,this._loadPromise=null,this._blob=e,e)).catch(e=>{console.error("Error loading resource: ",e),this._loadPromise=null})),this._loadPromise)}IsLoaded(){return this._isLoaded}GetBlob(){return this._blob?Promise.resolve(this._blob):this._loadPromise?this._loadPromise:this._assetManager.FetchBlob(this._url,this._loadPolicy)}}}{const bg=self.C3,Gg=new bg.PromiseThrottle,Ig=new Set;bg.ImageAsset=class extends bg.Asset{constructor(e,t){super(e,t),this._texturePromise=null,this._webglTexture=null,this._refCount=0,this._imageWidth=-1,this._imageHeight=-1,this._isTiled=!!t.isTiled,Ig.add(this)}Release(){if(0!==this._refCount)throw new Error("released image asset which still has texture references");this._assetManager._ReleaseImageAsset(this),this._texturePromise=null,Ig.delete(this),super.Release()}static OnRendererContextLost(){for(const e of Ig)e._texturePromise=null,e._webglTexture=null,e._refCount=0}LoadStaticTexture(e,t){return t=t||{},this._refCount++,this._webglTexture?Promise.resolve(this._webglTexture):(this._texturePromise||(t.anisotropy=this._runtime.GetCanvasManager().GetTextureAnisotropy(),this._texturePromise=this._DoLoadStaticTexture(e,t)),this._texturePromise)}async _DoLoadStaticTexture(e,t){try{const s=await this.GetBlob();return 0===this._refCount?(this._texturePromise=null,null):await Gg.Add(async()=>{const i=await e.CreateStaticTextureAsync(s,t);return this._texturePromise=null,0===this._refCount?(e.DeleteTexture(i),null):(this._webglTexture=i,this._imageWidth=i.GetWidth(),this._imageHeight=i.GetHeight(),this._webglTexture)})}catch(e){throw console.error("Failed to load texture: ",e),e}}ReleaseTexture(){if(this._refCount<=0)throw new Error("texture released too many times");this._refCount--,0===this._refCount&&this._webglTexture&&(this._webglTexture.GetRenderer().DeleteTexture(this._webglTexture),this._webglTexture=null)}GetRefCount(){return this._refCount}GetTexture(){return this._webglTexture}GetWidth(){return this._imageWidth}GetHeight(){return this._imageHeight}IsTiled(){return this._isTiled}async LoadToDrawable(){const e=await this.GetBlob();return bg.Supports.ImageBitmap?await createImageBitmap(e):await bg.BlobToImage(e)}}}{let vg=function(e,t){return e.GetWorldInfo()._GetLastCachedZIndex()-t.GetWorldInfo()._GetLastCachedZIndex()};SortByInstLastCachedZIndex=vg;const Cg=self.C3,wg=self.assert;Cg.RenderCell=class extends Cg.DefendedBase{constructor(e,t,s){super(),this._grid=e,this._x=t,this._y=s,this._instances=[],this._isSorted=!0,this._pendingRemoval=new Set,this._isAnyPendingRemoval=!1}Release(){Cg.clearArray(this._instances),this._pendingRemoval.clear(),this._grid=null}Reset(){Cg.clearArray(this._instances),this._isSorted=!0,this._pendingRemoval.clear(),this._isAnyPendingRemoval=!1}SetChanged(){this._isSorted=!1}IsEmpty(){return!this._instances.length||!(this._instances.length>this._pendingRemoval.size)&&(this._FlushPending(),!0)}Insert(e){if(this._pendingRemoval.has(e))return this._pendingRemoval.delete(e),void(0===this._pendingRemoval.size&&(this._isAnyPendingRemoval=!1));this._instances.push(e),this._isSorted=1===this._instances.length}Remove(e){this._pendingRemoval.add(e),this._isAnyPendingRemoval=!0,this._pendingRemoval.size>=50&&this._FlushPending()}_FlushPending(){this._isAnyPendingRemoval&&(this._instances.length!==this._pendingRemoval.size?(Cg.arrayRemoveAllInSet(this._instances,this._pendingRemoval),this._pendingRemoval.clear(),this._isAnyPendingRemoval=!1):this.Reset())}_EnsureSorted(){this._isSorted||(this._instances.sort(vg),this._isSorted=!0)}Dump(e){this._FlushPending(),this._EnsureSorted(),this._instances.length&&e.push(this._instances)}}}{const Ag=self.C3;Ag.RenderGrid=class extends Ag.DefendedBase{constructor(e,t){super(),this._cellWidth=e,this._cellHeight=t,this._cells=Ag.New(Ag.PairMap)}Release(){this._cells.Release(),this._cells=null}GetCell(e,t,s){let i=this._cells.Get(e,t);return i||(s?(i=Ag.New(Ag.RenderCell,this,e,t),this._cells.Set(e,t,i),i):null)}XToCell(e){return Math.floor(e/this._cellWidth)}YToCell(e){return Math.floor(e/this._cellHeight)}Update(e,t,s){if(t)for(let i=t.getLeft(),r=t.getRight();i<=r;++i)for(let r=t.getTop(),n=t.getBottom();r<=n;++r){if(s&&s.containsPoint(i,r))continue;const t=this.GetCell(i,r,!1);t&&(t.Remove(e),t.IsEmpty()&&this._cells.Delete(i,r))}if(s)for(let i=s.getLeft(),r=s.getRight();i<=r;++i)for(let r=s.getTop(),n=s.getBottom();r<=n;++r)t&&t.containsPoint(i,r)||this.GetCell(i,r,!0).Insert(e)}QueryRange(e,t){let s=this.XToCell(e.getLeft());const i=this.YToCell(e.getTop()),r=this.XToCell(e.getRight()),n=this.YToCell(e.getBottom());for(;s<=r;++s)for(let e=i;e<=n;++e){const i=this.GetCell(s,e,!1);i&&i.Dump(t)}}MarkRangeChanged(e){let t=e.getLeft();const s=e.getTop(),i=e.getRight(),r=e.getBottom();for(;t<=i;++t)for(let e=s;e<=r;++e){const s=this.GetCell(t,e,!1);s&&s.SetChanged()}}}}{let Rg=function(e,t){return e.GetWorldInfo()._GetLastCachedZIndex()-t.GetWorldInfo()._GetLastCachedZIndex()},Pg=function(e,t){return e.GetWorldInfo().GetZElevation()-t.GetWorldInfo().GetZElevation()};SortByInstLastCachedZIndex=Rg,SortByInstZElevation=Pg;const Mg=self.C3,Eg=self.assert,Dg=new Mg.Rect,Ng=new Mg.Quad,Fg=[],Og=new Mg.Rect,Bg=new Mg.Rect,Lg=self.glMatrix,kg=Lg.vec3,Vg=Lg.vec4,Ug=Lg.mat4,Wg=Ug.create(),Hg=kg.create(),zg=Vg.create(),jg=kg.create(),Yg=kg.create(),qg=kg.create(),Xg=Mg.New(Mg.Vector2),$g=Mg.New(Mg.Rect),Kg=[],Jg=[],Qg=[],Zg={name:"",sid:-1,isDynamic:!1,isVisible:!0,isInteractive:!0,isHTMLElementsLayer:!1,backgroundColor:[1,1,1,1],isTransparent:!0,parallax:[1,1],opacity:1,isForceOwnTexture:!1,renderAs3d:!1,useCameraDistanceDrawOrder:!1,useRenderCells:!1,scaleRate:1,blendMode:0,zElevation:0,initialInstancesData:[],effectListData:[],subLayersData:[]},ey=new Map,ty=e=>{if(!e.instance.GetObjectClass().IsGlobal())return;const t=e.instance.GetUID();ey.has(t)&&(ey.delete(t),ey.size||e.instance.GetRuntime().Dispatcher().removeEventListener("instancedestroy",ty))};Mg.Layer=class extends Mg.DefendedBase{constructor(e,t,s){super(),s=Object.assign({},Zg,s),this._layout=e,this._runtime=e.GetRuntime(),this._parentLayer=t,this._name=s.name,this._index=-1,this._isHTMLElementsLayer=!!s.isHTMLElementsLayer,this._htmlIndex=-1,this._sid=s.sid,this._isDynamic=!!s.isDynamic,this._isVisible=!!s.isVisible,this._isInteractive=!!s.isInteractive,this._backgroundColor=Mg.New(Mg.Color),this._backgroundColor.setFromJSON(s.backgroundColor),this._isTransparent=!!s.isTransparent,this._parallaxX=s.parallax[0],this._parallaxY=s.parallax[1],this._color=Mg.New(Mg.Color,1,1,1,s.opacity),this._premultipliedColor=Mg.New(Mg.Color),this._isForceOwnTexture=!!s.isForceOwnTexture,this._renderAs3d=!!s.renderAs3d,this._useCameraDistanceDrawOrder=!!s.useCameraDistanceDrawOrder,this._useRenderCells=!!s.useRenderCells,this._scaleRate=s.scaleRate,this._blendMode=s.blendMode,this._curRenderTarget=null,this._scale=1,this._zElevation=s.zElevation,this._angle=0,this._scrollX=0,this._scrollY=0,this._hasOwnScrollPosition=!1,this._viewport=Mg.New(Mg.Rect),this._viewportZ0=Mg.New(Mg.Rect),this._viewport3D=Mg.New(Mg.Rect),this._isViewportChanged=!0,this._projectionMatrix=Ug.create(),this._isProjectionMatrixChanged=!0,this._modelViewMatrix=Ug.create(),this._isMVMatrixChanged=!0,this._viewFrustum=Mg.New(Mg.Gfx.ViewFrustum),this._isViewFrustumChanged=!0,this._startupInitialInstances=[],this._initialInstancesData=s.initialInstancesData,this._initialInstances=[],this._createdGlobalUids=[],this._initialUIDsToInstanceData=new Map,this._instances=[],this._zIndicesUpToDate=!1,this._htmlZIndicesUpToDate=!1,this._anyInstanceZElevated=!1;const i=this._runtime.GetCanvasManager();this._effectList=Mg.New(Mg.EffectList,this,s.effectListData),this._effectChain=Mg.New(Mg.Gfx.EffectChain,i.GetEffectChainManager(),{drawContent:(e,t)=>{const s=t.GetContentObject(),r=s.GetRenderTarget();e.SetColor(s.GetPremultipliedColor()),e.DrawRenderTarget(r),e.InvalidateRenderTarget(r),i.ReleaseAdditionalRenderTarget(r)},getShaderParameters:e=>this.GetEffectList()._GetEffectChainShaderParametersForIndex(e)}),this._needsRebuildEffectChainSteps=!0,this._wasDefaultColor=!0,this._renderGrid=null,this._lastRenderList=[],this._isRenderListUpToDate=!1,this._lastRenderCells=Mg.New(Mg.Rect,0,0,-1,-1),this._curRenderCells=Mg.New(Mg.Rect,0,0,-1,-1),this._iLayer=new self.ILayer(this),this._userScriptDispatcher=Mg.New(Mg.Event.Dispatcher),this._UpdatePremultipliedColor(),this.UsesRenderCells()&&(this._renderGrid=Mg.New(Mg.RenderGrid,this._runtime.GetOriginalViewportWidth(),this._runtime.GetOriginalViewportHeight())),this._subLayers=s.subLayersData.map(e=>Mg.Layer.CreateFromExportData(this._layout,this,e))}_InitInitialInstances(){for(const e of this._initialInstancesData){const t=this._runtime.GetObjectClassByIndex(e[1]);this._layout._AddInitialObjectClass(t),t.GetDefaultInstanceData()||(t.SetDefaultInstanceData(e),t._SetDefaultLayerIndex(this._index)),this._initialInstances.push(e),this._initialUIDsToInstanceData.set(e[2],e)}Mg.shallowAssignArray(this._startupInitialInstances,this._initialInstances),this._initialInstancesData=null}static CreateFromExportData(e,t,s){return Mg.New(Mg.Layer,e,t,{name:s[0],sid:s[2],isVisible:s[3],isInteractive:s[13],isHTMLElementsLayer:s[19],backgroundColor:s[4].map(e=>e/255),isTransparent:s[5],parallax:[s[6],s[7]],opacity:s[8],isForceOwnTexture:s[9],renderAs3d:s[17],useCameraDistanceDrawOrder:s[18],useRenderCells:s[10],scaleRate:s[11],blendMode:s[12],zElevation:s[16],initialInstancesData:s[14],effectListData:s[15],subLayersData:s[20]})}Release(){for(const e of this._subLayers)e.Release();Mg.clearArray(this._subLayers);for(const e of this._instances)this._runtime.DestroyInstance(e);Mg.clearArray(this._instances),this._effectList.Release(),this._effectList=null,this._effectChain.Release(),this._effectChain=null,this._iLayer=null,this._parentLayer=null,this._layout=null,this._runtime=null}WasReleased(){return!this._layout}GetInitialInstanceData(e){return this._initialUIDsToInstanceData.get(e)}CreateInitialInstances(e){const t=this._layout.IsFirstVisit(),s=this._initialInstances;let i=0;for(let r=0,n=s.length;r<n;++r){const n=s[r],a=this._runtime.GetObjectClassByIndex(n[1]);let o=!0;if(!a.HasPersistBehavior()||t)if(a.IsGlobal()&&ey.has(n[2]))o=!1;else{const t=this._runtime.CreateInstanceFromData(n,this,!0);e.push(t),a.IsGlobal()&&(ey.size||this._runtime.Dispatcher().addEventListener("instancedestroy",ty),ey.set(t.GetUID(),t),o=!1,this._createdGlobalUids.push(t.GetUID()))}o&&(s[i]=s[r],++i)}Mg.truncateArray(s,i),this._runtime.FlushPendingInstances(),this.SetZIndicesChanged()}_AddInstance(e,t){if(!e.GetPlugin().IsWorldType())throw new Error("instance is not of world type");const s=e.GetWorldInfo();if(s.GetLayer()!==this)throw new Error("instance added to wrong layer");this._instances.push(e),0!==s.GetZElevation()&&(this._anyInstanceZElevated=!0),t&&this.UsesRenderCells()&&e.GetWorldInfo().SetBboxChanged(),this.SetZIndicesChanged(e)}_MaybeAddInstance(e){this._instances.includes(e)||(this._instances.push(e),0!==e.GetWorldInfo().GetZElevation()&&(this._anyInstanceZElevated=!0),this.SetZIndicesChanged(e))}_PrependInstance(e,t){const s=e.GetWorldInfo();if(s.GetLayer()!==this)throw new Error("instance added to wrong layer");this._instances.unshift(e),0!==s.GetZElevation()&&(this._anyInstanceZElevated=!0),this.SetZIndicesChanged(e),t&&this.UsesRenderCells()&&e.GetWorldInfo().SetBboxChanged()}_RemoveInstance(e,t){const s=this._instances.indexOf(e);s<0||(t&&this.UsesRenderCells()&&e.GetWorldInfo()._RemoveFromRenderCells(),this._instances.splice(s,1),this.SetZIndicesChanged(e),this._MaybeResetAnyInstanceZElevatedFlag())}_SetAnyInstanceZElevated(){this._anyInstanceZElevated=!0}_MaybeResetAnyInstanceZElevatedFlag(){0===this._instances.length&&(this._anyInstanceZElevated=!1)}_SortInstancesByLastCachedZIndex(e){if(e){const e=new Set;for(const t of this._instances){const s=t.GetWorldInfo()._GetLastCachedZIndex();s>=0&&e.add(s)}let t=-1;for(const s of this._instances){const i=s.GetWorldInfo();if(!(i._GetLastCachedZIndex()>=0)){for(++t;e.has(t);)++t;i._SetZIndex(t)}}}this._instances.sort(Rg)}_Start(){}_End(){for(const e of this._instances)e.GetObjectClass().IsGlobal()||this._runtime.DestroyInstance(e);this._runtime.FlushPendingInstances(),Mg.clearArray(this._instances),this._anyInstanceZElevated=!1,this.SetZIndicesChanged()}RecreateInitialObjects(e,t,s,i,r,n){const a=this._runtime.GetEventSheetManager(),o=this._runtime.GetAllObjectClasses(),l=e.IsFamily(),h=[];for(const u of this._initialInstances){const c=u[0],d=c[0],p=c[1];if(!t.containsPoint(d,p))continue;const _=o[u[1]];if(_!==e){if(!l)continue;if(!e.FamilyHasMember(_))continue}let m=r;if(!m){const e=this._runtime.GetCurrentLayout();this.GetLayout()===e?m=this:(m=e.GetLayerByName(this.GetName()),m||(m=e.GetLayerByIndex(this.GetIndex())))}const f=this._runtime.CreateInstanceFromData(u,m,!1,void 0,void 0,!1,n,void 0,n);n&&m.SortAndAddInstancesByZIndex(f);const g=f.GetWorldInfo();g.OffsetXY(s,i),g.SetBboxChanged(),a.BlockFlushingInstances(!0),f._TriggerOnCreatedOnSelfAndRelated(),a.BlockFlushingInstances(!1),h.push(f)}return h}GetInstanceCount(){return this._instances.length}GetLayout(){return this._layout}GetName(){return this._name}_SetIndex(e){this._index=e}GetIndex(){return this._index}_SetHTMLIndex(e){this._htmlIndex=e}GetHTMLIndex(){return this._htmlIndex}IsHTMLElementsLayer(){return this._isHTMLElementsLayer}SetIsHTMLElementsLayer(e){e=!!e,this._isHTMLElementsLayer!==e&&(this._isHTMLElementsLayer=e,this._layout._ReindexAndUpdateAllLayers(),this._runtime.UpdateRender())}_GetSiblingIndex(){let e=-1;const t=this.GetParentLayer();return e=t?t.GetSubLayers().indexOf(this):this.GetLayout()._GetRootLayers().indexOf(this),e}GetSID(){return this._sid}GetRuntime(){return this._runtime}IsDynamic(){return this._isDynamic}HasAnyDynamicParentLayer(){for(const e of this.parentLayers())if(e.IsDynamic())return!0;return!1}GetDevicePixelRatio(){return this._runtime.GetDevicePixelRatio()}GetEffectList(){return this._effectList}GetEffectChain(){return this._MaybeRebuildEffectChainSteps(),this._effectChain}_MaybeRebuildEffectChainSteps(){const e=this.HasDefaultColor();if(!this._needsRebuildEffectChainSteps&&e===this._wasDefaultColor&&!this._effectChain.NeedsRebuild())return;const t=this.GetEffectList().GetActiveEffectTypes();this._effectChain.BuildSteps(t.map(e=>e.GetShaderProgram()),{indexMap:t.map(e=>e.GetIndex()),forcePreDraw:!e,useFullSurface:!0}),this._needsRebuildEffectChainSteps=!1,this._wasDefaultColor=e}UpdateActiveEffects(){this.GetEffectList().UpdateActiveEffects(),this._needsRebuildEffectChainSteps=!0}UsesRenderCells(){return this._useRenderCells&&!this._useCameraDistanceDrawOrder}GetRenderGrid(){return this._renderGrid}SetRenderListStale(){this._isRenderListUpToDate=!1}IsVisible(){for(const e of this.selfAndParentLayers())if(!e._IsVisibleFlagSet())return!1;return!0}_IsVisibleFlagSet(){return this._isVisible}SetVisible(e){e=!!e,this._isVisible!==e&&(this._isVisible=e,this._runtime.UpdateRender())}SetInteractive(e){this._isInteractive=!!e}IsInteractive(){return this._isInteractive}IsSelfAndParentsInteractive(){for(const e of this.selfAndParentLayers())if(!e.IsInteractive())return!1;return!0}SetOwnScrollPositionEnabled(e){if(e=!!e,this._hasOwnScrollPosition!==e){if(this._hasOwnScrollPosition=e,e){const e=this.GetLayout();this._scrollX=e.GetScrollX(),this._scrollY=e.GetScrollY()}this._SetMVMatrixChanged(),this._runtime.UpdateRender()}}IsOwnScrollPositionEnabled(){return this._hasOwnScrollPosition}SetScrollX(e){const t=this.GetLayout(),s=t.GetScrollLeftBound(),i=t.GetScrollRightBound();e>i&&(e=i),e<s&&(e=s),this._scrollX!==e&&(this._scrollX=e,this.IsOwnScrollPositionEnabled()&&(this._SetMVMatrixChanged(),this._runtime.UpdateRender()))}SetScrollY(e){const t=this.GetLayout(),s=t.GetScrollTopBound(),i=t.GetScrollBottomBound();e>i&&(e=i),e<s&&(e=s),this._scrollY!==e&&(this._scrollY=e,this.IsOwnScrollPositionEnabled()&&(this._SetMVMatrixChanged(),this._runtime.UpdateRender()))}GetScrollX(){return this.IsOwnScrollPositionEnabled()?this._scrollX:this.GetLayout().GetScrollX()}GetScrollY(){return this.IsOwnScrollPositionEnabled()?this._scrollY:this.GetLayout().GetScrollY()}GetViewport(){return this._MaybeUpdateViewport(),this._viewport}_GetViewportZ0(){return this._MaybeUpdateViewport(),this._viewportZ0}GetViewport3D(){return this._MaybeUpdateViewport(),this._viewport3D}_GetVanishingPoint(){return this.GetLayout().GetVanishingPoint()}GetDefaultCameraZ(e){return this._runtime.GetDefaultCameraZ(e)}GetViewportForZ(e,t){const s=this._GetViewportZ0();if(0===e)t.copy(s);else{let i=s.midX(),r=s.midY();const n=this.Get2DScaleFactorToZ(e),a=s.width()/n,o=s.height()/n,[l,h]=this._GetVanishingPoint();if(.5!==l||.5!==h){const t=this.Get2DCameraZ(),s=this._runtime,n=this.GetDefaultCameraZ()/t;let a=(l-.5)*s.GetViewportWidth()/n,o=(h-.5)*s.GetViewportHeight()/n;const u=this.GetAngle();0!==u&&(Xg.set(a,o),Xg.rotate(u),a=Xg.getX(),o=Xg.getY());const c=Mg.unlerp(t,0,e);i+=Mg.lerp(a,0,c),r+=Mg.lerp(o,0,c)}t.set(i-a/2,r-o/2,i+a/2,r+o/2)}}GetOpacity(){return this._color.getA()}SetOpacity(e){e=Mg.clamp(e,0,1),this._color.getA()!==e&&(this._color.setA(e),this._UpdatePremultipliedColor(),this._runtime.UpdateRender())}_UpdatePremultipliedColor(){this._premultipliedColor.copy(this._color),this._premultipliedColor.premultiply()}GetPremultipliedColor(){return this._premultipliedColor}HasDefaultColor(){return this._color.equalsRgba(1,1,1,1)}GetScaleRate(){return this._scaleRate}SetScaleRate(e){this._scaleRate!==e&&(this._scaleRate=e,this._SetMVMatrixChanged(),this._runtime.UpdateRender())}GetParallaxX(){return this._parallaxX}GetParallaxY(){return this._parallaxY}SetParallax(e,t){this._parallaxX===e&&this._parallaxY===t||(this._parallaxX=e,this._parallaxY=t,this._SetMVMatrixChanged(),this._runtime.UpdateRender())}SetParallaxX(e){this.SetParallax(e,this.GetParallaxY())}SetParallaxY(e){this.SetParallax(this.GetParallaxX(),e)}SetZElevation(e){this._zElevation!==e&&(this._zElevation=e,this._runtime.UpdateRender())}GetZElevation(){return this._zElevation}SetAngle(e){e=Mg.clampAngle(e),this._angle!==e&&(this._angle=e,this._SetMVMatrixChanged(),this._runtime.UpdateRender())}GetAngle(){return Mg.clampAngle(this._layout.GetAngle()+this._angle)}GetOwnAngle(){return this._angle}HasInstances(){return this._instances.length>0}_GetInstances(){return this._instances}_GetInstancesInDrawOrder(){return this.RendersIn3DMode()&&this._useCameraDistanceDrawOrder?(Mg.shallowAssignArray(Qg,this._GetInstances()),Qg.sort((e,t)=>this._SortInstancesByCameraDistance(e,t)),Qg):this._GetInstances()}_AppendAllInstancesIncludingSubLayersInDrawOrder(e){Mg.appendArray(e,this._GetInstancesInDrawOrder());for(const t of this._subLayers)t.IsVisible()&&t.GetOpacity()>0&&t._AppendAllInstancesIncludingSubLayersInDrawOrder(e)}_SortInstancesByCameraDistance(e,t){const s=this.GetLayout().Get3DCameraPosition(),i=s[0],r=s[1],n=s[2],a=e.GetWorldInfo(),o=t.GetWorldInfo(),l=a.GetX()-i,h=a.GetY()-r,u=a.GetZElevation()-n,c=o.GetX()-i,d=o.GetY()-r,p=o.GetZElevation()-n;return c*c+d*d+p*p-(l*l+h*h+u*u)}GetBackgroundColor(){return this._backgroundColor}IsTransparent(){return this._isTransparent}SetTransparent(e){e=!!e,this._isTransparent!==e&&(this._isTransparent=e,this._runtime.UpdateRender())}IsForceOwnTexture(){return this._isForceOwnTexture}SetForceOwnTexture(e){e=!!e,this._isForceOwnTexture!==e&&(this._isForceOwnTexture=e,this._runtime.UpdateRender())}SetRenderAs3D(e){e=!!e,this._renderAs3d!==e&&(this._renderAs3d=e,this._SetMVMatrixChanged(),this._runtime.UpdateRender())}IsRenderAs3D(){return this._renderAs3d}RendersIn2DMode(){return!this.GetRuntime().Uses3DFeatures()||!this._renderAs3d}RendersIn3DMode(){return!this.RendersIn2DMode()}Has3DCamera(){return this.RendersIn3DMode()&&this.GetLayout().Is3DCameraEnabled()}SelfAndAllSubLayersHave3DCamera(){if(!this.Has3DCamera())return!1;for(const e of this._subLayers)if(!e.SelfAndAllSubLayersHave3DCamera())return!1;return!0}SetBlendMode(e){this._blendMode!==e&&(this._blendMode=e,this._runtime.UpdateRender())}GetBlendMode(){return this._blendMode}IsRootLayer(){return!this._parentLayer}GetParentLayer(){return this._parentLayer}_SetParentLayer(e){this._parentLayer=e}GetSubLayers(){return this._subLayers}HasAnySubLayers(){return this._subLayers.length>0}_AddSubLayer(e,t=!0){t?this._subLayers.push(e):this._subLayers.unshift(e)}_InsertSubLayer(e,t,s){let i=this._subLayers.indexOf(t);if(-1===i)throw new Error("cannot find layer to insert by");s&&++i,this._subLayers.splice(i,0,e)}_RemoveSubLayer(e){const t=this._subLayers.indexOf(e);if(-1===t)throw new Error("cannot find layer to remove");this._subLayers.splice(t,1)}HasAnyVisibleSubLayer(){for(const e of this._subLayers)if(e.ShouldDraw())return!0;return!1}*selfAndAllSubLayers(){for(const e of this._subLayers)yield*e.selfAndAllSubLayers();yield this}*parentLayers(){let e=this.GetParentLayer();for(;e;)yield e,e=e.GetParentLayer()}*selfAndParentLayers(){yield this,yield*this.parentLayers()}HasParentLayer(e){for(const t of this.parentLayers())if(t===e)return!0;return!1}IsTransformCompatibleWith(e){return this===e||this._parallaxX===e._parallaxX&&this._parallaxY===e._parallaxY&&this._scale===e._scale&&this._scaleRate===e._scaleRate&&this._angle===e._angle&&this.GetScrollX()===e.GetScrollX()&&this.GetScrollY()===e.GetScrollY()}SaveTransform(){return{parallaxX:this.GetParallaxX(),parallaxY:this.GetParallaxY(),scale:this.GetOwnScale(),scaleRate:this.GetScaleRate(),angle:this.GetOwnAngle(),hasOwnScroll:this.IsOwnScrollPositionEnabled(),scrollX:this.GetScrollX(),scrollY:this.GetScrollY()}}RestoreTransform(e){this.SetParallax(e.parallaxX,e.parallaxY),this.SetOwnScale(e.scale),this.SetScaleRate(e.scaleRate),this.SetAngle(e.angle),this.SetOwnScrollPositionEnabled(e.hasOwnScroll),this.SetScrollX(e.scrollX),this.SetScrollY(e.scrollY),this._MaybeUpdateViewport()}_RemoveAllInstancesInSet(e){0!==e.size&&Mg.arrayRemoveAllInSet(this._instances,e)>0&&(this._MaybeResetAnyInstanceZElevatedFlag(),this.SetZIndicesChanged())}SetZIndicesChanged(e){this._zIndicesUpToDate=!1,this._isRenderListUpToDate=!1,e&&!e.GetObjectClass().GetPlugin().IsHTMLElementType()||(this._htmlZIndicesUpToDate=!1)}_UpdateZIndices(){if(!this._zIndicesUpToDate){if(this._instances.sort(Pg),this.UsesRenderCells())for(let e=0,t=this._instances.length;e<t;++e){const t=this._instances[e].GetWorldInfo();t._SetZIndex(e),this._renderGrid.MarkRangeChanged(t.GetRenderCellRange())}else for(let e=0,t=this._instances.length;e<t;++e)this._instances[e].GetWorldInfo()._SetZIndex(e);this._zIndicesUpToDate=!0}}_UpdateHTMLZIndices(){if(this._htmlZIndicesUpToDate)return;const e=this._layout.GetRootLayersForHTMLLayer(this.GetHTMLIndex()).map(e=>[...e.selfAndAllSubLayers()]).flat();let t=0;for(const s of e){for(const e of s._GetInstances())e.GetObjectClass().GetPlugin().IsHTMLElementType()&&e.GetWorldInfo()._SetHTMLZIndex(t++);s._SetHTMLZIndicesUpToDate()}}_SetHTMLZIndicesUpToDate(){this._htmlZIndicesUpToDate=!0}_GetHTMLLayerDOMState(){return{isVisible:this.IsVisible(),opacity:this.GetOpacity(),isInteractive:this.IsInteractive()}}MoveInstanceAdjacent(e,t,s){const i=e.GetWorldInfo(),r=t.GetWorldInfo();if(i.GetLayer()!==this||r.GetLayer()!==this)throw new Error("can't arrange Z order unless both objects on this layer");const n=i.GetZIndex();let a=r.GetZIndex();return n!==a+(s?1:-1)&&(Mg.arrayRemove(this._instances,n),n<a&&a--,s&&a++,a===this._instances.length?this._instances.push(e):this._instances.splice(a,0,e),this.SetZIndicesChanged(e),!0)}_MergeSortedZArrays(e,t){const s=[];let i=0,r=0,n=e.length,a=t.length;for(;i<n&&r<a;){const n=e[i],a=t[r];n.GetWorldInfo()._GetLastCachedZIndex()<a.GetWorldInfo()._GetLastCachedZIndex()?(s.push(n),++i):(s.push(a),++r)}for(;i<n;++i)s.push(e[i]);for(;r<a;++r)s.push(t[r]);return s}_MergeAllSortedZArrays_pass(e){const t=[],s=e.length;for(let i=0;i<s-1;i+=2){const s=e[i],r=e[i+1];t.push(this._MergeSortedZArrays(s,r))}return s%2==1&&t.push(e[s-1]),t}_MergeAllSortedZArrays(e){for(;e.length>1;)e=this._MergeAllSortedZArrays_pass(e);return e[0]}_GetRenderCellInstancesToDraw(){return this._UpdateZIndices(),Mg.clearArray(Fg),this._renderGrid.QueryRange(this.GetViewport(),Fg),Fg.length?1===Fg.length?Fg[0]:this._MergeAllSortedZArrays(Fg):[]}ShouldDraw(){return this.IsVisible()&&this.GetOpacity()>0&&this._DrawsAnyContentInSelfOrSubLayers()}_DrawsAnyContentInSelfOrSubLayers(){if(this.HasInstances()||!this.IsTransparent()||this._userScriptDispatcher.HasAnyHandlerFor("beforedraw")||this._userScriptDispatcher.HasAnyHandlerFor("afterdraw"))return!0;for(const e of this._subLayers)if(e._DrawsAnyContentInSelfOrSubLayers())return!0;return!1}UsesOwnTexture(){return this.IsForceOwnTexture()||!this.HasDefaultColor()||0!==this.GetBlendMode()||this._effectList.HasAnyActiveEffect()}SelfOrAnySubLayerUsesOwnTexture(){if(this.UsesOwnTexture())return!0;for(const e of this._subLayers)if(e.SelfOrAnySubLayerUsesOwnTexture())return!0;return!1}GetRenderTarget(){return this._curRenderTarget}Get2DScaleFactorToZ(e){if(this._layout.IsOrthographicProjection())return 1;{const t=this.Get3DCameraZ();return t/(t-e)}}GetResolutionScaleFactorToZ(e){const t=this._runtime.GetRenderScale();if(this._layout.IsOrthographicProjection())return t;{const s=this.Get3DCameraZ();return this.GetDefaultCameraZ()/Math.abs(s-e)*t}}_SetMVMatrixChanged(){this._isMVMatrixChanged=!0,this._isViewFrustumChanged=!0,this._isViewportChanged=!0}_GetModelViewMatrix(e){return this._isMVMatrixChanged&&(this._CalculateModelViewMatrix(e,this._modelViewMatrix,0,0,null),this._isMVMatrixChanged=!1),this._modelViewMatrix}Get2DCameraZ(e){return this.GetDefaultCameraZ(e)/this.GetNormalScale()}Get3DCameraZ(){return this.Has3DCamera()?this.GetLayout().Get3DCameraPosition()[2]:this.Get2DCameraZ()}GetCameraPosition(){if(this.Has3DCamera()){const e=this.GetLayout().Get3DCameraPosition();return[e[0],e[1],e[2]]}return this._Get2DCameraPosition()}_Get2DCameraPosition(e=0,t=0,s=0){const i=this._runtime,r=this.GetLayout(),n=i.GetParallaxXOrigin(),a=i.GetParallaxYOrigin();let o=(this.GetScrollX()-n)*this._parallaxX+n,l=(this.GetScrollY()-a)*this._parallaxY+a;i.IsPixelRoundingEnabled()&&(o=Math.round(o),l=Math.round(l));let h=o+e,u=l+t;const c=r.IsOrthographicProjection()?this.GetDefaultCameraZ(s):this.Get2DCameraZ(s),[d,p]=this._GetVanishingPoint();if(.5!==d||.5!==p){const e=this.GetDefaultCameraZ(s)/c;let t=(d-.5)*i.GetViewportWidth()/e,r=(p-.5)*i.GetViewportHeight()/e;const n=this.GetAngle();0!==n&&(Xg.set(t,r),Xg.rotate(n),t=Xg.getX(),r=Xg.getY()),h+=t,u+=r}return[h,u,c]}_CalculateModelViewMatrix(e,t,s,i,r){const n=this._runtime,a=this.GetLayout();if(this.Has3DCamera()){kg.copy(jg,a.Get3DCameraPosition()),kg.copy(Yg,a.Get3DCameraLookAt()),kg.copy(qg,a.Get3DCameraUpVector());const e=n.GetParallaxXOrigin(),t=n.GetParallaxYOrigin(),s=Yg[0]-jg[0],i=Yg[1]-jg[1],r=Yg[2]-jg[2];jg[0]=(jg[0]-e)*this._parallaxX+e,jg[1]=(jg[1]-t)*this._parallaxY+t,jg[2]*=Math.max(this._parallaxX,this._parallaxY),Yg[0]=jg[0]+s,Yg[1]=jg[1]+i,Yg[2]=jg[2]+r}else{const[e,t,n]=this._Get2DCameraPosition(s,i,r);kg.set(jg,e,t,n),kg.set(Yg,e,t,n-100);const a=this.GetAngle();0===a?kg.set(qg,0,1,0):kg.set(qg,Math.sin(a),Math.cos(a),0)}e.CalculateLookAtModelView(t,jg,Yg,qg,r||n.GetViewportHeight())}_SetProjectionMatrixChanged(){this._isProjectionMatrixChanged=!0,this._isViewFrustumChanged=!0,this._isViewportChanged=!0}_GetProjectionMatrix(e){return this._isProjectionMatrixChanged&&(this._CalculateProjectionMatrix(e),this._isProjectionMatrixChanged=!1),this._projectionMatrix}_CalculateProjectionMatrix(e){const t=this._runtime.GetCanvasManager(),[s,i]=this._GetVanishingPoint();if(this._layout.IsOrthographicProjection())e.CalculateOrthographicMatrix(this._projectionMatrix,t.GetDrawWidth(),t.GetDrawHeight());else if(.5===s&&.5===i)Ug.copy(this._projectionMatrix,t.GetDefaultProjectionMatrix());else{const r=t.GetDrawWidth(),n=t.GetDrawHeight();e.CalculatePerspectiveMatrix(this._projectionMatrix,r/n,s,i)}}_SetTransform(e,t=!0,s=0,i=0,r=0){t&&e.SetProjectionMatrix(this._GetProjectionMatrix(e));let n=null;0===s&&0===i&&0===r?n=this._GetModelViewMatrix(e):(this._CalculateModelViewMatrix(e,Wg,s,i,r),n=Wg),e.SetModelViewMatrix(n)}PrepareForDraw(e){this._SetTransform(e),e.SetBaseZ(this.GetZElevation())}_MaybeStartWebGLProfiling(e){let t=null;if(e.IsWebGL()&&this._runtime.IsGPUProfiling()){const s=this._runtime.GetCanvasManager().GetLayerTimingsBuffer(this);s&&(t=s.AddTimeElapsedQuery(),e.StartQuery(t))}return t}_MaybeStartWebGPUProfiling(e){if(e.IsWebGPU()&&this._runtime.IsGPUProfiling()){const t=2*(this.GetIndex()+1);e.StartMeasuringRenderPassTime(t,t+1)}}_FireDrawEvent(e,t){if(this._userScriptDispatcher.HasAnyHandlerFor(t)){e.SetTextureFillMode(),e.SetTexture(null),e.SetAlphaBlend(),e.ResetCullState(),e.SetColorRgba(1,1,1,1),e.SetBaseZ(this.GetZElevation()),e.SetCurrentZ(0);const s=new Mg.Event(t);s.renderer=this._runtime.GetCanvasManager().GetIRenderer(),this.DispatchUserScriptEvent(s)}}Draw(e,t,s){const i=this._runtime.GetCanvasManager(),r=this.UsesOwnTexture();let n=null;const a=this._MaybeStartWebGLProfiling(e);if(this._MaybeStartWebGPUProfiling(e),r){const t={sampling:this._runtime.GetSampling(),isSampled:!0,canReadPixels:!!e.IsWebGPU()&&this._runtime.UsesAnyBackgroundBlending()};"low"===i.GetCurrentFullscreenScalingQuality()&&(t.width=i.GetDrawWidth(),t.height=i.GetDrawHeight()),n=this._runtime.GetAdditionalRenderTarget(t),this._curRenderTarget=n,e.SetRenderTarget(n),this.IsTransparent()&&e.ClearRgba(0,0,0,0)}else this._curRenderTarget=t,e.SetRenderTarget(t);if(this.IsTransparent()||e.Clear(this._backgroundColor),this._layout._DrawLayerList(e,this._curRenderTarget,this._subLayers,r&&this.IsTransparent()),this._MaybeStartWebGPUProfiling(e),this._SetTransform(e),e.SetBaseZ(this.GetZElevation()),e.SetDepthEnabled(this.RendersIn3DMode()),this._FireDrawEvent(e,"beforedraw"),this.GetNormalScale()>Number.EPSILON){this._UpdateZIndices();const t=this.UsesRenderCells()&&0===this.GetZElevation()&&!this._anyInstanceZElevated;this.Has3DCamera()?this._DrawInstances_3DCamera(e):t?this._DrawInstances_RenderCells(e):this._DrawInstances(e,this._GetInstancesInDrawOrder())}this._FireDrawEvent(e,"afterdraw"),e.SetBaseZ(0),e.SetCurrentZ(0),r&&(e.SetDepthEnabled(!1),this._DrawLayerOwnTextureToRenderTarget(e,n,t,s)),a&&e.EndQuery(a),this._curRenderTarget=null}_DrawInstances(e,t){const s=this.GetViewport(),i=this._curRenderTarget,r=this.GetLayout().IsOrthographicProjection(),n=this.GetLayout().HasVanishingPointOutsideViewport();let a=null;for(let o=0,l=t.length;o<l;++o){const l=t[o];if(l===a)continue;a=l;const h=l.GetWorldInfo();h.IsVisible()&&h.IsInViewport(s,n,r)&&this._DrawInstanceMaybeWithEffects(l,h,e,i)}}_DrawInstances_3DCamera(e){const t=this._curRenderTarget,s=this._GetViewFrustum(),i=Kg,r=Jg,n=this._GetInstancesInDrawOrder();for(let a=0,o=n.length;a<o;){const l=n[a],h=l.GetWorldInfo();if(!h.IsVisible()||!h.IsInViewport3D(s)){++a;continue}(!l.RendersToOwnZPlane()||h.GetDepth()>0)&&r.push(l);const u=l.GetWorldInfo().GetTotalZElevation();i.push(l);let c=a+1;for(;c<o;++c){const e=n[c],t=e.GetWorldInfo();if(t.IsVisible()&&t.IsInViewport3D(s)){if(t.GetTotalZElevation()!==u)break;e.RendersToOwnZPlane()?(t.GetDepth()>0&&r.push(e),i.push(e)):r.push(e)}}if(1!==i.length||i[0].MustMitigateZFighting()){this._DrawCoplanarInstances_3DCamera(e,i);for(let s=0,i=r.length;s<i;++s){const i=r[s],n=i.GetWorldInfo();n._SetDrawNonBackFacesOnly(!0),this._DrawInstanceMaybeWithEffects(i,n,e,t),n._SetDrawNonBackFacesOnly(!1)}}else{this._DrawInstanceMaybeWithEffects(l,h,e,t);for(let s=0,i=r.length;s<i;++s){const i=r[s];if(i===l)continue;const n=i.GetWorldInfo();n.GetLayer()._DrawInstanceMaybeWithEffects(i,n,e,t)}}a=c,Mg.clearArray(i),Mg.clearArray(r)}}_DrawCoplanarInstances_3DCamera(e,t){const s=this._curRenderTarget;e.CoplanarStartStencilPass();for(let s=0,i=t.length;s<i;++s){const i=t[s],r=i.GetWorldInfo();r._SetDrawBackFaceOnly(!0),this._DrawInstance(i,r,e)}e.CoplanarStartColorPass();for(let i=0,r=t.length;i<r;++i){const r=t[i],n=r.GetWorldInfo();this._DrawInstanceMaybeWithEffects(r,n,e,s),n._SetDrawBackFaceOnly(!1)}e.CoplanarRestoreStandardRendering()}_DrawInstances_RenderCells(e){const t=this._renderGrid,s=this._curRenderCells,i=this._lastRenderCells,r=this.GetViewport();let n;s.set(t.XToCell(r.getLeft()),t.YToCell(r.getTop()),t.XToCell(r.getRight()),t.YToCell(r.getBottom())),this._isRenderListUpToDate&&s.equals(i)?n=this._lastRenderList:(n=this._GetRenderCellInstancesToDraw(),this._isRenderListUpToDate=!0,i.copy(s)),this._DrawInstances(e,n),n!==this._lastRenderList&&Mg.shallowAssignArray(this._lastRenderList,n)}_DrawInstanceMaybeWithEffects(e,t,s,i){t.HasAnyActiveEffect()?this._DrawInstanceWithEffectsAndRestore(e,t,s,i):this._DrawInstance(e,t,s)}_DrawInstance(e,t,s){const i=t.GetRendererStateGroup();s.GetCurrentStateGroup()!==i&&i.Apply(),e.Draw(s)}_DrawInstanceWithEffectsAndRestore(e,t,s,i){this._DrawInstanceWithEffects(e,t,s,i,null)&&this._SetTransform(s)}_DrawInstanceWithEffects(e,t,s,i,r){const n=t.GetInstanceEffectList().GetEffectChain();return n.Render(s,i,{contentObject:e,blendMode:t.GetBlendMode(),devicePixelRatio:this._runtime.GetEffectDevicePixelRatioParam(),time:e.GetInstanceGameTime(),layerScale:this._runtime.GetEffectLayerScaleParam()*this.GetNormalScale(),layerAngle:this.GetAngle(),layoutRect:t.GetBoundingBox(),drawSurfaceRect:n.CanSkipCalculatingDrawSurfaceRect()?null:this._InstanceBoxToDrawSurface(t),drawContentHook:r&&r.drawContentHook,compositOffX:r&&r.compositOffX,compositOffY:r&&r.compositOffY,compositRtWidth:r&&r.compositRtWidth,compositRtHeight:r&&r.compositRtHeight,updateOwnProjection:r&&r.updateOwnProjection}),s.SetBaseZ(this.GetZElevation()),n.DidChangeTransform()}_DrawLayerOwnTextureToRenderTarget(e,t,s,i){const r=this._effectList.GetActiveEffectTypes(),n=this._runtime;0===r.length?(e.SetRenderTarget(s),e.SetTextureFillMode(),i&&0===this._blendMode&&this.HasDefaultColor()?e.CopyRenderTarget(t):(e.SetBlendMode(this._blendMode),e.SetColor(this._premultipliedColor),e.DrawRenderTarget(t)),e.InvalidateRenderTarget(t),n.ReleaseAdditionalRenderTarget(t)):this.GetEffectChain().Render(e,s,{contentObject:this,blendMode:this.GetBlendMode(),devicePixelRatio:n.GetEffectDevicePixelRatioParam(),layerScale:n.GetEffectLayerScaleParam()*this.GetNormalScale(),layerAngle:this.GetAngle(),layoutRect:this.GetViewport(),drawSurfaceRect:null,invalidateRenderTargets:!0})}GetOwnScale(){return this._scale}SetOwnScale(e){this._scale!==e&&(this._scale=e,this._layout.BoundScrolling(),this._SetMVMatrixChanged(),this._runtime.UpdateRender())}GetRenderScale(){return this.GetNormalScale()*this._runtime.GetRenderScale()}GetDisplayScale(){return this.GetNormalScale()*this._runtime.GetDisplayScale()}GetNormalScale(){return(this._scale*this._layout.GetScale()-1)*this._scaleRate+1}_MaybeUpdateViewport(){if(!this._isViewportChanged)return;this._isViewportChanged=!1;const e=this._runtime.GetParallaxXOrigin(),t=this._runtime.GetParallaxYOrigin(),s=(this.GetScrollX()-e)*this._parallaxX+e,i=(this.GetScrollY()-t)*this._parallaxY+t,r=this.GetNormalScale(),n=this._runtime.GetViewportWidth()/r,a=this._runtime.GetViewportHeight()/r;let o=s-n/2,l=i-a/2;this._runtime.IsPixelRoundingEnabled()&&(o=Math.round(o),l=Math.round(l));const h=this._viewportZ0;h.set(o,l,o+n,l+a);const u=this.GetAngle();0!==u&&(Dg.copy(h),Dg.offset(-h.midX(),-h.midY()),Ng.setFromRotatedRect(Dg,u),Ng.getBoundingBox(Dg),Dg.offset(h.midX(),h.midY()),h.copy(Dg));const c=this._zElevation;this.GetViewportForZ(c,this._viewport),this.Has3DCamera()?this.CalculateViewport3D(c,this._viewport3D):this._viewport3D.copy(this._viewport)}CalculateViewport3D(e,t){const s=this._runtime.GetCanvasManager(),i=s.GetCssWidth(),r=s.GetCssHeight(),[n,a]=this.CanvasCssToLayer(0,0,e),[o,l]=this.CanvasCssToLayer(i,0,e),[h,u]=this.CanvasCssToLayer(i,r,e),[c,d]=this.CanvasCssToLayer(0,r,e);let p=Math.min(n,o,h,c),_=Math.min(a,l,u,d),m=Math.max(n,o,h,c),f=Math.max(a,l,u,d);isFinite(p)||(p=-1/0),isFinite(_)||(_=-1/0),isFinite(m)||(m=1/0),isFinite(f)||(f=1/0),t.set(p,_,m,f)}CanvasCssToLayer(e,t,s=0){return this._CanvasToLayer(e,t,s,this.GetDisplayScale())}DrawSurfaceToLayer(e,t,s=0){return this._CanvasToLayer(e,t,s,this.GetRenderScale()*this.GetDevicePixelRatio())}_CanvasToLayer(e,t,s,i){const r=this._runtime,n=r.GetRenderer(),a=this.GetNormalScale(),o=r.GetViewportWidth()/a,l=r.GetViewportHeight()/a,h=zg;Vg.set(h,0,0,o,l),e/=i,t=h[3]-t/i;const u=this._GetProjectionMatrix(n),c=this._GetModelViewMatrix(n),d=Hg;return Mg.Gfx.UnprojectScreenToWorldZ(e,t,s,c,u,h,d)?[d[0],d[1]]:[NaN,NaN]}CanvasCssToLayer_DefaultTransform(e,t){const s=this._scale,i=this._scaleRate,r=this._parallaxX,n=this._parallaxY,a=this._angle,o=this.Has3DCamera();o&&this.GetLayout().Set3DCameraEnabled(!1),this._scale=1,this._scaleRate=1,this._parallaxX=1,this._parallaxY=1,this._angle=0,this._SetMVMatrixChanged();const l=this.CanvasCssToLayer(e,t);return this._scale=s,this._scaleRate=i,this._parallaxX=r,this._parallaxY=n,this._angle=a,this._SetMVMatrixChanged(),o&&this.GetLayout().Set3DCameraEnabled(!0),l}LayerToCanvasCss(e,t,s=0){return this._LayerToCanvas(e,t,s,this.GetDisplayScale())}LayerToDrawSurface(e,t,s=0){return this._LayerToCanvas(e,t,s,this.GetRenderScale()*this.GetDevicePixelRatio())}_LayerToCanvas(e,t,s,i){const r=this._runtime,n=r.GetRenderer(),a=this.GetNormalScale(),o=r.GetViewportWidth()/a,l=r.GetViewportHeight()/a,h=zg;Vg.set(h,0,0,o,l);const u=this._GetProjectionMatrix(n),c=this._GetModelViewMatrix(n),d=Hg;return Mg.Gfx.Project(e,t,s,c,u,h,d)?[d[0]*i,(h[3]-d[1])*i]:[NaN,NaN]}_GetLayerToDrawSurfaceScale(e,t){return e*=this.GetRenderScale()*this.GetDevicePixelRatio(),0!==t&&(e*=this.Get2DScaleFactorToZ(t)),e}_InstanceBoxToDrawSurface(e){const t=e.GetBoundingBox(),s=e.GetTotalZElevation(),i=e.GetDepth(),r=s+i,n=t.getLeft(),a=t.getTop(),o=t.getRight(),l=t.getBottom();if(this.Has3DCamera()){if(this._IsPointBehindNearPlane(n,a,s)||this._IsPointBehindNearPlane(o,a,s)||this._IsPointBehindNearPlane(o,l,s)||this._IsPointBehindNearPlane(n,l,s))return null;if(i>0&&(this._IsPointBehindNearPlane(n,a,r)||this._IsPointBehindNearPlane(o,a,r)||this._IsPointBehindNearPlane(o,l,r)||this._IsPointBehindNearPlane(n,l,r)))return null}else if(r>=this.Get2DCameraZ())return null;let[h,u]=this.LayerToDrawSurface(n,a,s),[c,d]=this.LayerToDrawSurface(o,l,s);if(0!==this.GetAngle()||i>0||this.Has3DCamera()){const[e,t]=this.LayerToDrawSurface(o,a,s),[p,_]=this.LayerToDrawSurface(n,l,s);if(i>0){const[s,i]=this.LayerToDrawSurface(n,a,r),[m,f]=this.LayerToDrawSurface(o,a,r),[g,y]=this.LayerToDrawSurface(o,l,r),[S,T]=this.LayerToDrawSurface(n,l,r);let x=Math.min(h,c,e,p,s,m,g,S);c=Math.max(h,c,e,p,s,m,g,S),h=x,x=Math.min(u,d,t,_,i,f,y,T),d=Math.max(u,d,t,_,i,f,y,T),u=x}else{let s=Math.min(h,c,e,p);c=Math.max(h,c,e,p),h=s,s=Math.min(u,d,t,_),d=Math.max(u,d,t,_),u=s}}return Dg.set(h,u,c,d),Dg}_GetViewFrustum(){return this._isViewFrustumChanged&&(this._UpdateViewFrustum(),this._isViewFrustumChanged=!1),this._viewFrustum}_UpdateViewFrustum(){const e=this._runtime.GetRenderer(),t=this._GetProjectionMatrix(e),s=this._GetModelViewMatrix(e);this._viewFrustum.CalculatePlanes(s,t)}_IsPointBehindNearPlane(e,t,s){return this._GetViewFrustum().IsBehindNearPlane(e,t,s)}_SaveToJson(){return{d:this.IsDynamic(),s:this.GetOwnScale(),a:this.GetOwnAngle(),v:this._IsVisibleFlagSet(),i:this.IsInteractive(),html:this.IsHTMLElementsLayer(),bc:this._backgroundColor.toJSON(),t:this.IsTransparent(),sx:this._scrollX,sy:this._scrollY,hosp:this._hasOwnScrollPosition,px:this.GetParallaxX(),py:this.GetParallaxY(),c:this._color.toJSON(),sr:this.GetScaleRate(),fx:this._effectList.SaveToJson(),cg:this._createdGlobalUids}}_LoadFromJson(e){this._isDynamic=!!e.d,this._scale=e.s,this._angle=e.a,this._isVisible=!!e.v,this._isInteractive=!e.hasOwnProperty("i")||e.i,this._isHTMLElementsLayer=!!e.html,this._backgroundColor.setFromJSON(e.bc),this._isTransparent=!!e.t,e.hasOwnProperty("sx")&&(this._scrollX=e.sx),e.hasOwnProperty("sy")&&(this._scrollY=e.sy),e.hasOwnProperty("hosp")&&(this._hasOwnScrollPosition=!!e.hosp),this._parallaxX=e.px,this._parallaxY=e.py,this._color.setFromJSON(e.c),this._UpdatePremultipliedColor(),this._scaleRate=e.sr,Mg.shallowAssignArray(this._createdGlobalUids,e.cg),Mg.shallowAssignArray(this._initialInstances,this._startupInitialInstances);const t=new Set(this._createdGlobalUids);let s=0;for(let e=0,i=this._initialInstances.length;e<i;++e)t.has(this._initialInstances[e][2])||(this._initialInstances[s]=this._initialInstances[e],++s);Mg.truncateArray(this._initialInstances,s),this._effectList.LoadFromJson(e.fx),this._needsRebuildEffectChainSteps=!0}_LoadFromJsonAfterInstances(){this._SortInstancesByLastCachedZIndex(!1),this.SetZIndicesChanged(),this._SetMVMatrixChanged(),this._SetProjectionMatrixChanged()}GetILayer(){return this._iLayer}UserScriptDispatcher(){return this._userScriptDispatcher}DispatchUserScriptEvent(e){e.layer=this.GetILayer(),this._userScriptDispatcher.dispatchEvent(e)}SortAndAddInstancesByZIndex(e,t=!1,s=!1){if(this._instances.includes(e))return t&&this._instances.sort((e,t)=>(e.GetWorldInfo().GetSceneGraphZIndex()??0)-(t.GetWorldInfo().GetSceneGraphZIndex()??0)),void(s&&this._instances.forEach((e,t)=>e.GetWorldInfo()._SetZIndex(t)));if(e.HasChildren()){const t=[...e.allChildren()];t.push(e),t.sort((e,t)=>(e.GetWorldInfo().GetSceneGraphZIndex()??0)-(t.GetWorldInfo().GetSceneGraphZIndex()??0));for(const e of t)if(e.IsInContainer())for(const s of e.siblings()){if(t.includes(s))continue;const e=[...s.allChildren()];e.push(s),e.sort((e,t)=>(e.GetWorldInfo().GetSceneGraphZIndex()??0)-(t.GetWorldInfo().GetSceneGraphZIndex()??0)),e&&e.length&&t.splice(t.length,0,...e)}for(const e of t)e.GetPlugin().IsWorldType()&&this._AddInstance(e,!0);s&&this._instances.forEach((e,t)=>e.GetWorldInfo()._SetZIndex(t))}else{if(e.GetPlugin().IsWorldType()&&this._AddInstance(e,!0),!e.IsInContainer())return void(s&&this._instances.forEach((e,t)=>e.GetWorldInfo()._SetZIndex(t)));for(const t of e.siblings()){const e=[...t.allChildren()];if(e.push(t),e.sort((e,t)=>(e.GetWorldInfo().GetSceneGraphZIndex()??0)-(t.GetWorldInfo().GetSceneGraphZIndex()??0)),e&&e.length)for(const t of e)t.GetPlugin().IsWorldType()&&this._AddInstance(t,!0)}s&&this._instances.forEach((e,t)=>e.GetWorldInfo()._SetZIndex(t))}}}}{let sy=function(e,t,s,i){return e[0]===Math.fround(t)&&e[1]===Math.fround(s)&&e[2]===Math.fround(i)},iy=function(e,t){gy!==e&&(e.PrepareForDraw(t),gy=e)};vec3EqualsXYZ=sy,MaybePrepareLayerDraw=iy;const ry=self.C3,ny=self.C3Debugger,ay=self.assert,oy=ry.New(ry.Rect),ly=ry.New(ry.Rect),hy=ry.New(ry.Rect),uy=ry.New(ry.Color),cy=self.glMatrix,dy=cy.vec3,py=[],_y=[],my=[],fy=[];let gy=null;ry.Layout=class extends ry.DefendedBase{constructor(e,t,s){super(),this._layoutManager=e,this._runtime=e.GetRuntime(),this._name=s[0],this._originalWidth=s[1],this._originalHeight=s[2],this._width=s[1],this._height=s[2],this._isUnboundedScrolling=!!s[3],this._isOrthographicProjection=!!s[4],this._vanishingPointX=s[5],this._vanishingPointY=s[6],this._eventSheetName=s[7],this._eventSheet=null,this._sid=s[8],this._index=t,this._scrollX=0,this._scrollY=0,this._scale=1,this._angle=0,this._initialObjectClasses=new Set,this._textureLoadedTypes=new Set,this._textureLoadPendingPromises=new Set,this._createdInstances=[],this._createdPersistedInstances=[],this._createdPersistedInstancesToDataMap=new Map,this._createdPersistedIndexToInstanceMap=new Map,this._initialNonWorld=[],this._is3dCameraEnabled=!1,this._cam3dposition=dy.create(),this._cam3dlook=dy.create(),this._cam3dup=dy.create(),this._rootLayers=[],this._allLayersFlat=[],this._layersByName=new Map,this._layersBySid=new Map,this._pendingSetHTMLLayerCount=-1;const i=this._runtime.GetCanvasManager();this._effectList=ry.New(ry.EffectList,this,s[11]),this._effectChain=ry.New(ry.Gfx.EffectChain,i.GetEffectChainManager(),{drawContent:(e,t)=>{const s=t.GetContentObject().GetRenderTarget();e.ResetColor(),e.DrawRenderTarget(s),e.InvalidateRenderTarget(s),i.ReleaseAdditionalRenderTarget(s)},getShaderParameters:e=>this.GetEffectList()._GetEffectChainShaderParametersForIndex(e)}),this._needsRebuildEffectChainSteps=!0,this._wasFullScreenQualityLow=!1,this._curRenderTarget=null,this._persistData={},this._persistedIntances=new Map,this._isFirstVisit=!0,this._iLayout=new self.ILayout(this),this._userScriptDispatcher=ry.New(ry.Event.Dispatcher);for(const e of s[9])this._rootLayers.push(ry.Layer.CreateFromExportData(this,null,e));this._ReindexLayers();for(const e of this.allLayers())e._InitInitialInstances();for(const e of s[10]){const t=this._runtime.GetObjectClassByIndex(e[1]);if(!t)throw new Error("missing nonworld object class");t.GetDefaultInstanceData()||t.SetDefaultInstanceData(e),this._initialNonWorld.push(e),this._AddInitialObjectClass(t)}}Release(){for(const e of this._allLayersFlat)e.Release();ry.clearArray(this._allLayersFlat),this._textureLoadPendingPromises.clear(),this._eventSheet=null,this._layoutManager=null,this._runtime=null}GetRuntime(){return this._runtime}GetName(){return this._name}GetSID(){return this._sid}GetIndex(){return this._index}GetEffectList(){return this._effectList}GetEffectChain(){return this._MaybeRebuildEffectChainSteps(),this._effectChain}_MaybeRebuildEffectChainSteps(){const e="low"===this._runtime.GetCanvasManager().GetCurrentFullscreenScalingQuality();if(!this._needsRebuildEffectChainSteps&&this._wasFullScreenQualityLow===e&&!this._effectChain.NeedsRebuild())return;const t=this.GetEffectList().GetActiveEffectTypes();this._effectChain.BuildSteps(t.map(e=>e.GetShaderProgram()),{indexMap:t.map(e=>e.GetIndex()),forcePostDraw:e,useFullSurface:!0}),this._needsRebuildEffectChainSteps=!1,this._wasFullScreenQualityLow=e}UpdateActiveEffects(){this.GetEffectList().UpdateActiveEffects(),this._needsRebuildEffectChainSteps=!0}GetMinLayerScale(){let e=this._allLayersFlat[0].GetNormalScale();for(let t=1,s=this._allLayersFlat.length;t<s;++t){const s=this._allLayersFlat[t];0===s.GetParallaxX()&&0===s.GetParallaxY()||(e=Math.min(e,s.GetNormalScale()))}return e}_GetScrollBoundMarginHorizontal(){return.5*this._runtime.GetViewportWidth()/this.GetMinLayerScale()}_GetScrollBoundMarginVertical(){return.5*this._runtime.GetViewportHeight()/this.GetMinLayerScale()}GetScrollLeftBound(){return this.IsUnboundedScrolling()?-1/0:this._GetScrollBoundMarginHorizontal()}GetScrollRightBound(){return this.IsUnboundedScrolling()?1/0:this.GetWidth()-this._GetScrollBoundMarginHorizontal()}GetScrollTopBound(){return this.IsUnboundedScrolling()?-1/0:this._GetScrollBoundMarginVertical()}GetScrollBottomBound(){return this.IsUnboundedScrolling()?1/0:this.GetHeight()-this._GetScrollBoundMarginVertical()}SetScrollX(e){const t=this.GetScrollLeftBound(),s=this.GetScrollRightBound();e>s&&(e=s),e<t&&(e=t),this._scrollX!==e&&(this._scrollX=e,this._SetAllLayersMVChanged(),this._runtime.UpdateRender())}GetScrollX(){return this._scrollX}SetScrollY(e){const t=this.GetScrollTopBound(),s=this.GetScrollBottomBound();e>s&&(e=s),e<t&&(e=t),this._scrollY!==e&&(this._scrollY=e,this._SetAllLayersMVChanged(),this._runtime.UpdateRender())}GetScrollY(){return this._scrollY}IsUnboundedScrolling(){return this._isUnboundedScrolling}BoundScrolling(){this.SetScrollX(this.GetScrollX()),this.SetScrollY(this.GetScrollY());for(const e of this._allLayersFlat)e.IsOwnScrollPositionEnabled()&&(e.SetScrollX(e.GetScrollX()),e.SetScrollY(e.GetScrollY()))}SetVanishingPointXY(e,t){this._vanishingPointX===e&&this._vanishingPointY===t||(this._vanishingPointX=e,this._vanishingPointY=t,this.IsPerspectiveProjection()&&(this._SetAllLayersProjectionChanged(),this._SetAllLayersMVChanged(),this._runtime.UpdateRender()))}GetVanishingPointX(){return this.IsOrthographicProjection()?.5:this._vanishingPointX}GetVanishingPointY(){return this.IsOrthographicProjection()?.5:this._vanishingPointY}GetVanishingPoint(){return[this.GetVanishingPointX(),this.GetVanishingPointY()]}HasVanishingPointOutsideViewport(){const e=this.GetVanishingPointX(),t=this.GetVanishingPointY();return e<0||e>1||t<0||t>1}SetPerspectiveProjection(){this._isOrthographicProjection&&(this._isOrthographicProjection=!1,this._SetAllLayersProjectionChanged(),this._SetAllLayersMVChanged(),this._runtime.UpdateRender())}SetOrthographicProjection(){this._isOrthographicProjection||(this._isOrthographicProjection=!0,this._SetAllLayersProjectionChanged(),this._SetAllLayersMVChanged(),this._runtime.UpdateRender())}IsOrthographicProjection(){return this._isOrthographicProjection}IsPerspectiveProjection(){return!this.IsOrthographicProjection()}Set3DCameraEnabled(e){e=!!e,this._is3dCameraEnabled!==e&&(this._is3dCameraEnabled=e,this._SetAllLayersMVChanged(),this._runtime.UpdateRender())}Is3DCameraEnabled(){return this._is3dCameraEnabled}Set3DCameraOrientation(e,t,s,i,r,n,a,o,l){sy(this._cam3dposition,e,t,s)&&sy(this._cam3dlook,i,r,n)&&sy(this._cam3dup,a,o,l)||(dy.set(this._cam3dposition,e,t,s),dy.set(this._cam3dlook,i,r,n),dy.set(this._cam3dup,a,o,l),this.Set3DCameraChanged())}Set3DCameraChanged(){this._SetAllLayersMVChanged(),this._runtime.UpdateRender()}Get3DCameraPosition(){return this._cam3dposition}Get3DCameraLookAt(){return this._cam3dlook}Get3DCameraUpVector(){return this._cam3dup}GetScale(){return this._scale}SetScale(e){this._scale!==e&&(this._scale=e,this._SetAllLayersMVChanged(),this.BoundScrolling(),this._runtime.UpdateRender())}SetAngle(e){e=ry.clampAngle(e),this._angle!==e&&(this._angle=e,this._SetAllLayersMVChanged(),this._runtime.UpdateRender())}GetAngle(){return this._angle}GetWidth(){return this._width}SetWidth(e){!isFinite(e)||e<1||(this._width=e)}GetHeight(){return this._height}SetHeight(e){!isFinite(e)||e<1||(this._height=e)}GetEventSheet(){return this._eventSheet}_GetRootLayers(){return this._rootLayers}*allLayers(){for(const e of this._rootLayers)yield*e.selfAndAllSubLayers()}GetLayers(){return this._allLayersFlat}GetLayerCount(){return this._allLayersFlat.length}GetLayer(e){return"number"==typeof e?this.GetLayerByIndex(e):this.GetLayerByName(e.toString())}GetLayerByIndex(e){return e=ry.clamp(Math.floor(e),0,this._allLayersFlat.length-1),this._allLayersFlat[e]}GetLayerByName(e){return this._layersByName.get(e.toLowerCase())||null}HasLayerByName(e){return!!this.GetLayerByName(e)}GetLayerBySID(e){return this._layersBySid.get(e)||null}_SetAllLayersProjectionChanged(){for(const e of this._allLayersFlat)e._SetProjectionMatrixChanged()}_SetAllLayersMVChanged(){for(const e of this._allLayersFlat)e._SetMVMatrixChanged()}AddLayer(e,t,s){if(this.HasLayerByName(e))throw new Error(`layer name '${e}' already in use`);if(!t&&s<2)throw new Error("invalid insert position");const i=s>=2?t:t.GetParentLayer(),r=ry.New(ry.Layer,this,i,{name:e,sid:Math.floor(1e15*Math.random()),isDynamic:!0});this._InsertLayer(r,t,s),this.GetRuntime().UpdateRender(),this._ReindexAndUpdateAllLayers()}MoveLayer(e,t,s){if(!t&&s<2)throw new Error("invalid insert position");e===t&&s<2||(this._RemoveLayer(e),this._InsertLayer(e,t,s),this.GetRuntime().UpdateRender(),this._ReindexAndUpdateAllLayers())}RemoveLayer(e){if(this._RemoveLayer(e)){const t=this._runtime.GetEventSheetManager();t.BlockFlushingInstances(!0),e.Release(),t.BlockFlushingInstances(!1),this.GetRuntime().UpdateRender(),this._ReindexAndUpdateAllLayers()}}RemoveAllDynamicLayers(){const e=new Set;for(const t of this.allLayers())t.IsDynamic()&&!t.HasAnyDynamicParentLayer()&&e.add(t);if(0===e.size)return;const t=this._runtime.GetEventSheetManager();t.BlockFlushingInstances(!0);for(const t of e)this._RemoveLayer(t),t.Release();t.BlockFlushingInstances(!1),this.GetRuntime().UpdateRender(),this._ReindexAndUpdateAllLayers()}_InsertLayer(e,t,s){if(s>=2)if(t){if(t===e||t.HasParentLayer(e))throw new Error(`cannot move layer '${e.GetName()}' to sub-layer of itself`);t._AddSubLayer(e,2===s),e._SetParentLayer(t)}else 2===s?this._rootLayers.push(e):this._rootLayers.unshift(e),e._SetParentLayer(null);else{const i=t.GetParentLayer();if(i){if(t.HasParentLayer(e))throw new Error(`cannot move layer '${e.GetName()}' to sub-layer of itself`);i._InsertSubLayer(e,t,0===s),e._SetParentLayer(i)}else{let i=this._rootLayers.indexOf(t);if(-1===i)throw new Error("cannot find layer to insert by");0===s&&++i,this._rootLayers.splice(i,0,e),e._SetParentLayer(null)}}}_RemoveLayer(e){const t=e.GetParentLayer();if(t)return t._RemoveSubLayer(e),!0;if(this._rootLayers.length>1){const t=this._rootLayers.indexOf(e);if(-1===t)throw new Error("cannot find layer to remove");return this._rootLayers.splice(t,1),!0}return!1}_ReindexLayers(){this._allLayersFlat=[...this.allLayers()],this._layersByName.clear(),this._layersBySid.clear();for(let e=0,t=this._allLayersFlat.length;e<t;++e){const t=this._allLayersFlat[e];t._SetIndex(e),this._layersByName.set(t.GetName().toLowerCase(),t),this._layersBySid.set(t.GetSID(),t)}}_ReindexHTMLLayers(){let e=0;for(const t of this._rootLayers){for(const s of t.selfAndAllSubLayers())s._SetHTMLIndex(e);t.IsHTMLElementsLayer()&&e++}}GetHTMLLayerCount(){return this._rootLayers.at(-1).GetHTMLIndex()+1}async _ReindexAndUpdateAllLayers(){this._ReindexLayers(),this._ReindexHTMLLayers(),this._pendingSetHTMLLayerCount=this.GetHTMLLayerCount()}_GetPendingSetHTMLLayerCount(){return this._pendingSetHTMLLayerCount}_ResetPendingHTMLLayerCount(){this._pendingSetHTMLLayerCount=-1}GetRootLayersForHTMLLayer(e){const t=[];for(const s of this._rootLayers){const i=s.GetHTMLIndex();if(i===e)t.push(s);else if(i>e)break}return t}SaveTransform(){return{scrollX:this.GetScrollX(),scrollY:this.GetScrollY(),scale:this.GetScale(),angle:this.GetAngle(),vpX:this.GetVanishingPointX(),vpY:this.GetVanishingPointY()}}RestoreTransform(e){this.SetScrollX(e.scrollX),this.SetScrollY(e.scrollY),this.SetScale(e.scale),this.SetAngle(e.angle),this.SetVanishingPointXY(e.vpX,e.vpY)}GetLayoutBackgroundColor(){let e=this._rootLayers.filter(e=>e.ShouldDraw())[0];for(;e;){if(!e.IsTransparent())return uy.copyRgb(e.GetBackgroundColor()),uy.setA(1),uy;if(e.UsesOwnTexture())return uy.setRgba(0,0,0,0),uy;e=e.GetSubLayers().filter(e=>e.ShouldDraw())[0]}return uy.setRgba(0,0,0,0),uy}IsFirstVisit(){return this._isFirstVisit}_GetInitialObjectClasses(){return[...this._initialObjectClasses]}_AddInitialObjectClass(e){if(e.IsInContainer())for(const t of e.GetContainer().GetObjectTypes())this._initialObjectClasses.add(t);else this._initialObjectClasses.add(e)}_GetTextureLoadedObjectTypes(){return[...this._textureLoadedTypes]}_Load(e,t){if(e===this||!t)return Promise.resolve();e&&(ry.CopySet(this._textureLoadedTypes,e._textureLoadedTypes),e._textureLoadedTypes.clear());const s=[];for(const e of this._initialObjectClasses)this._textureLoadedTypes.has(e)||(s.push(e.LoadTextures(t)),this._textureLoadedTypes.add(e));return Promise.all(s)}async MaybeLoadTexturesFor(e){if(e.IsFamily())throw new Error("cannot load textures for family");const t=this._runtime.GetRenderer();if(!t||t.IsContextLost()||this._textureLoadedTypes.has(e))return;this._textureLoadedTypes.add(e);const s=e.LoadTextures(t);this._AddPendingTextureLoadPromise(s),await s,e.OnDynamicTextureLoadComplete(),this._runtime.UpdateRender()}_AddPendingTextureLoadPromise(e){this._textureLoadPendingPromises.add(e),e.then(()=>this._textureLoadPendingPromises.delete(e)).catch(()=>this._textureLoadPendingPromises.delete(e))}WaitForPendingTextureLoadsToComplete(){return Promise.all([...this._textureLoadPendingPromises])}MaybeUnloadTexturesFor(e){if(e.IsFamily()||e.GetInstanceCount()>0)throw new Error("cannot unload textures");const t=this._runtime.GetRenderer();t&&this._textureLoadedTypes.has(e)&&(this._textureLoadedTypes.delete(e),e.ReleaseTextures(t))}_Unload(e,t){if(e!==this&&t)for(const t of this._textureLoadedTypes)t.IsGlobal()||e._initialObjectClasses.has(t)||(t.ReleaseTextures(),this._textureLoadedTypes.delete(t))}_OnRendererContextLost(){this._textureLoadedTypes.clear()}async _StartRunning(e){const t=this._runtime,s=this._layoutManager,i=t.GetEventSheetManager();this._eventSheetName&&(this._eventSheet=i.GetEventSheetByName(this._eventSheetName),this._eventSheet._UpdateDeepIncludes()),s._SetMainRunningLayout(this),this._width=this._originalWidth,this._height=this._originalHeight,this._scrollX=t.GetOriginalViewportWidth()/2,this._scrollY=t.GetOriginalViewportHeight()/2,this.BoundScrolling(),this._SetAllLayersProjectionChanged(),this._SetAllLayersMVChanged(),this._ReindexHTMLLayers(),await this._runtime.GetCanvasManager().SetHTMLLayerCount(this.GetHTMLLayerCount(),!0),this._MoveGlobalObjectsToThisLayout(e),this._runtime.SetUsingCreatePromises(!0),this._CreateInitialInstances(),this._isFirstVisit||this._CreatePersistedInstances(),this._CreateAndLinkContainerInstances(this._createdInstances),this._CreateAndLinkContainerInstances(this._createdPersistedInstances),this._CreateInitialNonWorldInstances(),s.ClearPendingChangeLayout(),t.FlushPendingInstances(),this._runtime.SetUsingCreatePromises(!1);const r=this._runtime.GetCreatePromises();if(await Promise.all(r),ry.clearArray(r),!t.IsLoadingState()){for(const e of this._createdInstances)e.SetupInitialSceneGraphConnections();for(const e of this._createdPersistedInstances)e.SetupPersistedSceneGraphConnections(this._createdPersistedInstancesToDataMap,this._createdPersistedIndexToInstanceMap);for(const[e,t]of Object.entries(this._persistData)){const s=this._runtime.GetObjectClassBySID(parseInt(e,10));s&&!s.IsFamily()&&s.HasPersistBehavior()&&ry.clearArray(t)}for(const e of this._createdInstances)e._TriggerOnCreated();for(const e of this._createdPersistedInstances)e._TriggerOnCreated();for(const e of this._createdInstances)e.HasParent()||e._OnHierarchyReady();for(const e of this._createdPersistedInstances)e.HasParent()||e._OnHierarchyReady()}ry.clearArray(this._createdInstances),ry.clearArray(this._createdPersistedInstances),this._createdPersistedInstancesToDataMap.clear(),this._createdPersistedIndexToInstanceMap.clear(),await Promise.all([...this._initialObjectClasses].map(e=>e.PreloadTexturesWithInstances(this._runtime.GetRenderer()))),e&&(t.Dispatcher().dispatchEvent(new ry.Event("beforefirstlayoutstart")),await t.DispatchUserScriptEventAsyncWait(new ry.Event("beforeprojectstart"))),await this.DispatchRuntimeUserScriptEventAsyncWait(new ry.Event("beforeanylayoutstart")),t.Dispatcher().dispatchEvent(new ry.Event("beforelayoutstart")),await this.DispatchUserScriptEventAsyncWait(new ry.Event("beforelayoutstart")),t.IsLoadingState()||await t.TriggerAsync(ry.Plugins.System.Cnds.OnLayoutStart,null,null),t.Dispatcher().dispatchEvent(new ry.Event("afterlayoutstart")),await this.DispatchUserScriptEventAsyncWait(new ry.Event("afterlayoutstart")),await this.DispatchRuntimeUserScriptEventAsyncWait(new ry.Event("afteranylayoutstart")),e&&(t.Dispatcher().dispatchEvent(new ry.Event("afterfirstlayoutstart")),await t.DispatchUserScriptEventAsyncWait(new ry.Event("afterprojectstart"))),i._RunQueuedTriggers(s),await this.WaitForPendingTextureLoadsToComplete(),this._isFirstVisit=!1}_MoveGlobalObjectsToThisLayout(e){for(const e of this._runtime.GetAllObjectClasses())if(!e.IsFamily()&&e.IsWorldType())for(const t of e.GetInstances()){const e=t.GetWorldInfo(),s=e.GetLayer(),i=ry.clamp(s.GetIndex(),0,this._allLayersFlat.length-1),r=this._allLayersFlat[i];e._SetLayer(r,!0),r._MaybeAddInstance(t)}if(!e)for(const e of this._allLayersFlat)e._SortInstancesByLastCachedZIndex(!1)}_CreateInitialInstances(){for(const e of this._allLayersFlat)e.CreateInitialInstances(this._createdInstances),e._Start()}_CreatePersistedInstances(){let e=!1;for(const[t,s]of Object.entries(this._persistData)){const i=this._runtime.GetObjectClassBySID(parseInt(t,10));if(i&&!i.IsFamily()&&i.HasPersistBehavior())for(const t of s){let s=null;if(i.IsWorldType()&&(s=t.hasOwnProperty("instJson")?this.GetLayerBySID(t.instJson.w.l):this.GetLayerBySID(t.w.l),!s))continue;const r=this._runtime.CreateInstanceFromData(i,s,!1,0,0,!0);t.hasOwnProperty("instJson")?r.LoadFromJson(t.instJson):r.LoadFromJson(t),e=!0,this._createdPersistedInstances.push(r),t.hasOwnProperty("instJson")&&(this._createdPersistedInstancesToDataMap.set(r,t),this._createdPersistedIndexToInstanceMap.set(t.index,r))}}for(const e of this._allLayersFlat)e._SortInstancesByLastCachedZIndex(!0),e.SetZIndicesChanged();e&&(this._runtime.FlushPendingInstances(),this._runtime._RefreshUidMap())}_CreateAndLinkContainerInstances(e){for(const t of e){if(!t.IsInContainer())continue;const s=t.GetWorldInfo(),i=t.GetIID();for(const r of t.GetObjectClass().GetContainer().objectTypes()){if(r===t.GetObjectClass())continue;const n=r.GetInstances();if(n.length>i)t._AddSibling(n[i]);else{let i;i=s?this._runtime.CreateInstanceFromData(r,s.GetLayer(),!0,s.GetX(),s.GetY(),!0):this._runtime.CreateInstanceFromData(r,null,!0,0,0,!0),this._runtime.FlushPendingInstances(),r._UpdateIIDs(),t._AddSibling(i),e.push(i)}}}}_CreateInitialNonWorldInstances(){for(const e of this._initialNonWorld)this._runtime.GetObjectClassByIndex(e[1]).IsInContainer()||this._runtime.CreateInstanceFromData(e,null,!0)}_CreateGlobalNonWorlds(){const e=[],t=this._initialNonWorld;let s=0;for(let i=0,r=t.length;i<r;++i){const r=t[i],n=this._runtime.GetObjectClassByIndex(r[1]);n.IsGlobal()?n.IsInContainer()&&n.GetContainer().HasAnyWorldType()||e.push(this._runtime.CreateInstanceFromData(r,null,!0)):(t[s]=r,++s)}ry.truncateArray(t,s),this._runtime.FlushPendingInstances(),this._CreateAndLinkContainerInstances(e)}RecreateInitialObjects(e,t,s,i,r,n,a){if(s)return s.RecreateInitialObjects(e,t,r,n,i,a);{const s=[];for(const o of this._allLayersFlat)s.push(o.RecreateInitialObjects(e,t,r,n,i,a));return s.flat()}}async _StopRunning(){const e=this._layoutManager;this._runtime.IsLoadingState()||(await this.DispatchRuntimeUserScriptEventAsyncWait(new ry.Event("beforeanylayoutend")),await this.DispatchUserScriptEventAsyncWait(new ry.Event("beforelayoutend")),await this._runtime.TriggerAsync(ry.Plugins.System.Cnds.OnLayoutEnd,null,null),await this.DispatchUserScriptEventAsyncWait(new ry.Event("afterlayoutend")),await this.DispatchRuntimeUserScriptEventAsyncWait(new ry.Event("afteranylayoutend"))),e.SetIsEndingLayout(!0),this._runtime.GetEventSheetManager().ClearAllScheduledWaits(),this._isFirstVisit||this._SavePersistData();for(const e of this._allLayersFlat)e._End();for(const e of this._runtime.GetAllObjectClasses())if(!(e.IsGlobal()||e.IsWorldType()||e.GetPlugin().IsSingleGlobal()||e.IsFamily())){for(const t of e.GetInstances())this._runtime.DestroyInstance(t);this._runtime.FlushPendingInstances()}e.SetIsEndingLayout(!1),e.GetMainRunningLayout()===this&&e._SetMainRunningLayout(null)}_SaveInstanceToPersist(e,t){const s=e.GetObjectClass().GetSID().toString();this._persistData.hasOwnProperty(s)||(this._persistData[s]=[]);const i=this._persistData[s],r={index:t,instJson:e.SaveToJson(),sceneGraphJson:{children:[]}};i.push(r),this._persistedIntances.set(e,r)}_SaveSceneGraphInfoToPersist(e){const t=this._persistedIntances.get(e);for(const s of e.GetChildren()){const e=this._persistedIntances.get(s);e&&t.sceneGraphJson.children.push({index:e.index,flags:ry.SceneGraphInfo._GetFlagsNumber(s.GetWorldInfo())})}}_SavePersistData(){this._persistedIntances.clear();let e=0;for(const t of this._allLayersFlat){t._UpdateZIndices();for(const s of t._GetInstances()){const t=s.GetObjectClass();!t.IsGlobal()&&t.HasPersistBehavior()&&(this._SaveInstanceToPersist(s,e),e++)}}for(const e of this._allLayersFlat)for(const t of e._GetInstances()){const e=t.GetObjectClass();!e.IsGlobal()&&e.HasPersistBehavior()&&this._SaveSceneGraphInfoToPersist(t)}this._persistedIntances.clear()}ResetPersistData(){this._persistData={},this._isFirstVisit=!0}GetRenderTarget(){return this._curRenderTarget}UsesOwnTexture(){const e=this._runtime,t=e.GetRenderer().IsWebGL();return"low"===e.GetCanvasManager().GetCurrentFullscreenScalingQuality()||t&&e.UsesAnyBackgroundBlending()||this._effectList.HasAnyActiveEffect()||t&&e.Uses3DFeatures()}_MaybeStartDrawToOwnTexture(e){const t=this._runtime.GetCanvasManager();if(this.UsesOwnTexture()){e.SetRenderTarget(null),e.ClearRgba(0,0,0,0);const s={sampling:this._runtime.GetSampling(),isSampled:e.IsWebGPU()||this._runtime.UsesAnyBackgroundBlending()||this._effectList.HasAnyActiveEffect(),canReadPixels:!!e.IsWebGPU()&&this._runtime.UsesAnyBackgroundBlending()};"low"===t.GetCurrentFullscreenScalingQuality()&&(s.width=t.GetDrawWidth(),s.height=t.GetDrawHeight()),this._curRenderTarget=this._runtime.GetAdditionalRenderTarget(s)}else this._curRenderTarget=null}_MaybeCopyOwnTextureToBackbuffer(e){this._runtime._NeedsHTMLLayerCompositing(e)&&(e.SetDepthEnabled(!1),e.SetRenderTarget(null),e.SetTextureFillMode(),e.CopyRenderTarget(this._curRenderTarget))}_MaybeEndDrawToOwnTexture(e){this.UsesOwnTexture()&&(e.SetDepthEnabled(!1),this._DrawLayoutOwnTextureToRenderTarget(e,this._curRenderTarget))}DrawMain(e){e.SetRenderTarget(this._curRenderTarget),e.Clear(this.GetLayoutBackgroundColor()),this._runtime.Uses3DFeatures()&&e.ClearDepth();const t=this.GetRootLayersForHTMLLayer(0);this._DrawLayerList(e,this._curRenderTarget,t,!0),e.IsWebGPU()&&e.StartMeasuringRenderPassTime(0,1),this._MaybeEndDrawToOwnTexture(e),this._curRenderTarget=null}DrawForHTMLLayerIndex(e,t){let s=null;this._runtime._NeedsHTMLLayerCompositing(e)&&(s=this._curRenderTarget),e.SetRenderTarget(s),e.ClearRgba(0,0,0,0),this._runtime.Uses3DFeatures()&&e.ClearDepth();const i=this.GetRootLayersForHTMLLayer(t);this._DrawLayerList(e,s,i,!0),this._MaybeCopyOwnTextureToBackbuffer(e),e.EndBatch(),this._runtime.GetCanvasManager().BlitMainCanvasToHTMLLayerCanvas(t)}_DrawLayerList(e,t,s,i){const r=s.filter(e=>e.ShouldDraw());for(let s=0,n=r.length;s<n;){const a=r[s];if(a.SelfAndAllSubLayersHave3DCamera()&&!a.SelfOrAnySubLayerUsesOwnTexture()){py.push(a);for(let e=s+1;e<n;++e){const t=r[e];if(!t.SelfAndAllSubLayersHave3DCamera()||t.SelfOrAnySubLayerUsesOwnTexture())break;py.push(r[e])}if(py.length>=2||1===py.length&&py[0].HasAnyVisibleSubLayer()){this._Draw3DLayers(e,t,py),s+=py.length,ry.clearArray(py);continue}ry.clearArray(py)}a.Draw(e,t,i&&0===s),++s}}_DrawLayoutOwnTextureToRenderTarget(e,t){const s=this._effectList.GetActiveEffectTypes(),i=this._runtime;0===s.length?(e.SetRenderTarget(null),e.SetTextureFillMode(),e.CopyRenderTarget(t),e.InvalidateRenderTarget(t),i.ReleaseAdditionalRenderTarget(t)):(hy.set(0,0,i.GetViewportWidth(),i.GetViewportHeight()),this.GetEffectChain().Render(e,null,{contentObject:this,blendMode:3,devicePixelRatio:this._runtime.GetEffectDevicePixelRatioParam(),layerScale:this._runtime.GetEffectLayerScaleParam()*this.GetScale(),layerAngle:this.GetAngle(),layoutRect:hy,drawSurfaceRect:null,invalidateRenderTargets:!0}))}_Draw3DLayers(e,t,s){const i=s[0],r=i._MaybeStartWebGLProfiling(e);i._MaybeStartWebGPUProfiling(e),s[0].IsTransparent()||(uy.copyRgb(s[0].GetBackgroundColor()),uy.setA(1),e.Clear(uy)),e.SetDepthEnabled(!0);const n=_y,a=my,o=fy;for(const t of s)t._UpdateZIndices(),t._AppendAllInstancesIncludingSubLayersInDrawOrder(n),t._FireDrawEvent(e,"beforedraw");for(let s=0,i=n.length;s<i;){const r=n[s],l=r.GetWorldInfo(),h=l.GetLayer();if(!l.IsVisible()||!l.IsInViewport3D(h._GetViewFrustum())){++s;continue}(!r.RendersToOwnZPlane()||l.GetDepth()>0)&&o.push(r);const u=r.GetWorldInfo().GetTotalZElevation();a.push(r);let c=s+1;for(;c<i;++c){const e=n[c],t=e.GetWorldInfo();if(t.IsVisible()&&t.IsInViewport3D(t.GetLayer()._GetViewFrustum())){if(t.GetTotalZElevation()!==u)break;e.RendersToOwnZPlane()?(t.GetDepth()>0&&o.push(e),a.push(e)):o.push(e)}}if(1!==a.length||a[0].MustMitigateZFighting()){this._Draw3DLayersCoplanarInstances(e,t,a);for(let s=0,i=o.length;s<i;++s){const i=o[s],r=i.GetWorldInfo(),n=r.GetLayer();r._SetDrawNonBackFacesOnly(!0),iy(n,e),n._DrawInstanceMaybeWithEffects(i,r,e,t),r._SetDrawNonBackFacesOnly(!1)}}else{iy(h,e),h._DrawInstanceMaybeWithEffects(r,l,e,t);for(let s=0,i=o.length;s<i;++s){const i=o[s];if(i===r)continue;const n=i.GetWorldInfo(),a=n.GetLayer();iy(a,e),a._DrawInstanceMaybeWithEffects(i,n,e,t)}}s=c,ry.clearArray(a),ry.clearArray(o)}for(const t of s)t._FireDrawEvent(e,"afterdraw");r&&e.EndQuery(r),ry.clearArray(n),gy=null}_Draw3DLayersCoplanarInstances(e,t,s){e.CoplanarStartStencilPass();for(let t=0,i=s.length;t<i;++t){const i=s[t],r=i.GetWorldInfo(),n=r.GetLayer();r._SetDrawBackFaceOnly(!0),iy(n,e),n._DrawInstance(i,r,e)}e.CoplanarStartColorPass();for(let i=0,r=s.length;i<r;++i){const r=s[i],n=r.GetWorldInfo(),a=n.GetLayer();iy(a,e),a._DrawInstanceMaybeWithEffects(r,n,e,t),n._SetDrawBackFaceOnly(!1)}e.CoplanarRestoreStandardRendering()}_SaveToJson(){const e={sx:this.GetScrollX(),sy:this.GetScrollY(),s:this.GetScale(),a:this.GetAngle(),w:this.GetWidth(),h:this.GetHeight(),ortho:this.IsOrthographicProjection(),vpX:this.GetVanishingPointX(),vpY:this.GetVanishingPointY(),fv:this._isFirstVisit,persist:this._persistData,fx:this._effectList.SaveToJson(),layers:{},dynamicLayers:[]};for(const t of this._allLayersFlat)if(t.IsDynamic()){const s=t.GetParentLayer();e.dynamicLayers.push({sid:t.GetSID(),name:t.GetName(),parentSid:s?s.GetSID():null,siblingIndex:t._GetSiblingIndex(),data:t._SaveToJson()})}else e.layers[t.GetSID().toString()]=t._SaveToJson();return e}_LoadFromJson(e){this._scrollX=e.sx,this._scrollY=e.sy,this._scale=e.s,this._angle=e.a,this._width=e.w,this._height=e.h,this._isOrthographicProjection=!!e.ortho,e.hasOwnProperty("vpX")&&(this._vanishingPointX=e.vpX),e.hasOwnProperty("vpY")&&(this._vanishingPointY=e.vpY),this._isFirstVisit=!!e.fv,this._persistData=e.persist,this._effectList.LoadFromJson(e.fx),this._needsRebuildEffectChainSteps=!0;for(const[t,s]of Object.entries(e.layers)){const e=parseInt(t,10),i=this.GetLayerBySID(e);i&&i._LoadFromJson(s)}if(e.hasOwnProperty("dynamicLayers")){this.RemoveAllDynamicLayers(),this._runtime.FlushPendingInstances();const t=new Map,s=e.dynamicLayers;for(let e=s.length-1;e>=0;--e){const i=s[e],r=i.sid,n=i.name,a=i.parentSid,o=i.siblingIndex,l=i.data;if(this._ReindexLayers(),this.HasLayerByName(n)||this.GetLayerBySID(r))continue;let h,u;if(null===a)h=null,u=this._rootLayers;else{if(h=this.GetLayerBySID(a),!h)continue;u=h.GetSubLayers()}const c=ry.New(ry.Layer,this,h,{name:n,sid:r,isDynamic:!0});u.push(c);let d=t.get(u);d||(d=[],t.set(u,d)),d.push({layer:c,siblingIndex:o}),c._LoadFromJson(l)}for(const[e,s]of t){s.sort((e,t)=>e.siblingIndex-t.siblingIndex);for(const t of s){const s=t.layer,i=t.siblingIndex;let r=e.indexOf(s);e.splice(r,1),e.splice(i,0,s)}}}this._ReindexAndUpdateAllLayers(),this._SetAllLayersProjectionChanged(),this._SetAllLayersMVChanged()}GetILayout(){return this._iLayout}UserScriptDispatcher(){return this._userScriptDispatcher}DispatchUserScriptEvent(e){e.layout=this.GetILayout();const t=this._runtime,s=t.IsDebug()&&!t.GetEventSheetManager().IsInEventEngine();s&&ny.StartMeasuringScriptTime(),this._userScriptDispatcher.dispatchEvent(e),s&&ny.AddScriptTime()}DispatchUserScriptEventAsyncWait(e){return e.layout=this.GetILayout(),this._userScriptDispatcher.dispatchEventAndWaitAsync(e)}DispatchRuntimeUserScriptEventAsyncWait(e){return e.layout=this.GetILayout(),this._runtime.DispatchUserScriptEventAsyncWait(e)}_LogLayerTree(){this._LogLayerList(this._rootLayers)}_LogLayerList(e,t=0){const s=e.slice(0);s.reverse();for(const e of s)console.log(`${"\t".repeat(t)}- ${e.GetName()}`),this._LogLayerList(e.GetSubLayers(),t+1)}}}{const yy=self.C3;yy.LayoutManager=class extends yy.DefendedBase{#t;#s=[];#d=new Map;#l=new Map;#i=null;#e=[];#n=null;#a=0;#p=null;constructor(e){super(),this.#t=e}Release(){this.#t=null,this.#i=null,this.#n=null,this.#p=null,yy.clearArray(this.#s),this.#d.clear(),this.#l.clear(),yy.clearArray(this.#e)}Create(e){const t=yy.New(yy.Layout,this,this.#s.length,e);this.#s.push(t),this.#d.set(t.GetName().toLowerCase(),t),this.#l.set(t.GetSID(),t)}GetRuntime(){return this.#t}SetFirstLayout(e){this.#n=e}GetFirstLayout(){if(this.#n)return this.#n;if(this.#s.length)return this.#s[0];throw new Error("no first layout")}GetLayoutByName(e){return this.#d.get(e.toLowerCase())||null}GetLayoutBySID(e){return this.#l.get(e)||null}GetLayoutByIndex(e){return e=yy.clamp(Math.floor(e),0,this.#s.length-1),this.#s[e]}GetLayout(e){return"number"==typeof e?this.GetLayoutByIndex(e):this.GetLayoutByName(e.toString())}GetAllLayouts(){return this.#s}_SetMainRunningLayout(e){this.#i=e}GetMainRunningLayout(){return this.#i}_AddRunningSubLayout(e){if(this.#e.includes(e))throw new Error("layout already running");this.#e.push(e)}_RemoveRunningSubLayout(e){const t=this.#e.indexOf(e);if(-1===t)throw new Error("layout not running");this.#e.splice(t,1)}*runningLayouts(){this.#i&&(yield this.#i),this.#e.length&&(yield*this.#e)}IsLayoutRunning(e){return this.#i===e||this.#e.includes(e)}SetIsEndingLayout(e){if(e)this.#a++;else{if(this.#a<=0)throw new Error("already unset");this.#a--}}IsEndingLayout(){return this.#a>0}ChangeMainLayout(e){this.#p=e}ClearPendingChangeLayout(){this.#p=null}IsPendingChangeMainLayout(){return!!this.#p}GetPendingChangeMainLayout(){return this.#p}SetAllLayerProjectionChanged(){const e=this.GetMainRunningLayout();e&&e._SetAllLayersProjectionChanged()}SetAllLayerMVChanged(){const e=this.GetMainRunningLayout();e&&e._SetAllLayersMVChanged()}}}{const Sy=self.C3,Ty=new RegExp("<(.+?)>","g");Sy.TimelineManager=class extends Sy.DefendedBase{constructor(e){super(),this._runtime=e,this._timelineDataManager=Sy.New(Sy.TimelineDataManager),this._pluginInstance=null,this._timelines=[],this._timelinesByName=new Map,this._objectClassToTimelineMap=new Map,this._timelinesCreatedByTemplate=new Map,this._scheduledTimelines=[],this._playingTimelines=[],this._markedForRemovalTimelines=[],this._hasRuntimeListeners=!1,this._changingLayout=!1,this._isTickingTimelines=!1,this._tickFunc=()=>this._OnTick(),this._tick2Func=()=>this._OnTick2(),this._beforeLayoutChange=()=>this._OnBeforeChangeLayout(),this._layoutChange=()=>this._OnAfterChangeLayout(),this._instanceDestroy=e=>this._OnInstanceDestroy(e.instance),this._beforeLoad=e=>this._OnBeforeLoad(),this._afterLoad=e=>this._OnAfterLoad(),this._afterLayoutStart=e=>this._OnAfterLayoutStart(),this._destroyedWhileLoadingState=[],this._renderChange=0}Release(){this.RemoveRuntimeListeners(),this._tickFunc=null,this._tick2Func=null,this._beforeLayoutChange=null,this._layoutChange=null,this._instanceDestroy=null,this._afterLoad=null;for(const e of this._timelines)e.Stop(),e.Release();Sy.clearArray(this._timelines),this._timelines=null,this._timelineDataManager.Release(),this._timelineDataManager=null,Sy.clearArray(this._scheduledTimelines),this._scheduledTimelines=null,Sy.clearArray(this._playingTimelines),this._playingTimelines=null,Sy.clearArray(this._markedForRemovalTimelines),this._markedForRemovalTimelines=null,this._timelinesByName.clear(),this._timelinesByName=null,this._objectClassToTimelineMap.clear(),this._objectClassToTimelineMap=null,this._timelinesCreatedByTemplate.clear(),this._timelinesCreatedByTemplate=null,Sy.clearArray(this._destroyedWhileLoadingState),this._destroyedWhileLoadingState=null,this._runtime=null}AddRuntimeListeners(){const e=this._runtime.Dispatcher();e.addEventListener("pretick",this._tickFunc),e.addEventListener("tick2",this._tick2Func),e.addEventListener("beforelayoutchange",this._beforeLayoutChange),e.addEventListener("layoutchange",this._layoutChange),e.addEventListener("instancedestroy",this._instanceDestroy),e.addEventListener("beforeload",this._beforeLoad),e.addEventListener("afterload",this._afterLoad),e.addEventListener("afterlayoutstart",this._afterLayoutStart)}RemoveRuntimeListeners(){const e=this._runtime.Dispatcher();e.removeEventListener("pretick",this._tickFunc),e.removeEventListener("tick2",this._tick2Func),e.removeEventListener("beforelayoutchange",this._beforeLayoutChange),e.removeEventListener("layoutchange",this._layoutChange),e.removeEventListener("instancedestroy",this._instanceDestroy),e.removeEventListener("beforeload",this._beforeLoad),e.removeEventListener("afterload",this._afterLoad),e.removeEventListener("afterlayoutstart",this._afterLayoutStart)}Create(e){this._timelineDataManager.Add(e);const t=Sy.TimelineState.CreateInitial(e,this);this.Add(t),this.SetTimelineObjectClassesToMap(t),this._timelinesCreatedByTemplate.set(t.GetName(),0)}CreateFromTemplate(e){const t=this.GetTimelineDataManager(),s=e.GetTemplateName(),i=t.Get(s),r=Sy.TimelineState.CreateFromTemplate(`${s}:${this._timelinesCreatedByTemplate.get(s)}`,i,this);return this._IncreaseTemplateTimelinesCount(s),this.Add(r),r}_IncreaseTemplateTimelinesCount(e){this._timelinesCreatedByTemplate.set(e,this._timelinesCreatedByTemplate.get(e)+1)}_SetCreatedTemplateTimelinesCount(){for(const e of this._timelines){if(e.IsTemplate())continue;const t=e.GetTemplateName();this._IncreaseTemplateTimelinesCount(t)}}_ClearCreatedTemplateTimelinesCount(){for(const e of this._timelinesCreatedByTemplate.keys())this._timelinesCreatedByTemplate.set(e,0)}Add(e){this._timelines.push(e),this._timelinesByName.set(e.GetName().toLowerCase(),e)}Remove(e){e.Removed(),e.IsTemplate()||(Sy.arrayFindRemove(this._timelines,e),Sy.arrayFindRemove(this._scheduledTimelines,e),Sy.arrayFindRemove(this._playingTimelines,e),Sy.arrayFindRemove(this._markedForRemovalTimelines,e),this._timelinesByName.delete(e.GetName().toLowerCase()),this.RemoveTimelineFromObjectClassMap(e),e.IsReleased()||e.Release())}Trigger(e){this._runtime.Trigger(e,this._pluginInstance,null)}GetRuntime(){return this._runtime}GetTimelineDataManager(){return this._timelineDataManager}SetPluginInstance(e){this._pluginInstance=e}GetPluginInstance(){return this._pluginInstance}*GetTimelines(){for(const e of this._timelines)yield e}*GetPlayingTimelines(){for(const e of this._playingTimelines)yield e}SetTimelineObjectClassToMap(e,t){this._objectClassToTimelineMap.has(e)||this._objectClassToTimelineMap.set(e,new Set),this._objectClassToTimelineMap.get(e).add(t)}SetTimelineObjectClassesToMap(e){for(const t of e.GetObjectClasses())this.SetTimelineObjectClassToMap(t,e)}RemoveTimelineFromObjectClassMap(e){for(const[t,s]of this._objectClassToTimelineMap.entries())s.has(e)&&(s.delete(e),0===s.size&&this._objectClassToTimelineMap.delete(t))}GetTimelinesForObjectClass(e){if(this._objectClassToTimelineMap.has(e))return this._objectClassToTimelineMap.get(e)}GetTimelineOfTemplateForInstances(e,t){if(t)for(const s of this._timelines)if(t.every(e=>s.HasTrackInstance(e.instance,e.trackId))&&s.GetName().includes(e.GetName()))return s}GetTimelineByName(e){return this._timelinesByName.get(e.toLowerCase())||null}GetScheduledOrPlayingTimelineByName(e){for(const t of this._scheduledTimelines)if(t.GetName()===e)return t;for(const t of this._playingTimelines)if(t.GetName()===e)return t;return null}*GetTimelinesByName(e){if(Ty.test(e)){let t;Ty.lastIndex=0;const s=new Set;do{if(t=Ty.exec(e),t){const e=t[1].split(",");for(const t of e)s.add(t)}}while(t);for(const e of s.values()){const t=this.GetTimelineByName(e);t&&(yield t)}s.clear()}else{const t=this.GetTimelineByName(e);t&&(yield t)}}*GetTimelinesByTags(e){for(const t of this._timelines)t.HasTags(e)&&(yield t)}AddScheduledTimeline(e){this._scheduledTimelines.includes(e)||this._scheduledTimelines.push(e),this._MaybeEnableRuntimeListeners()}RemovePlayingTimeline(e){Sy.arrayFindRemove(this._playingTimelines,e),this._MaybeDisableRuntimeListeners()}ScheduleTimeline(e){this._playingTimelines.includes(e)?(e.SetPlaying(!0),e.SetScheduled(!1),e.SetMarkedForRemoval(!1)):(e.SetPlaying(!1),e.SetScheduled(!0),e.SetMarkedForRemoval(!1),this._scheduledTimelines.includes(e)||this._scheduledTimelines.push(e)),this._MaybeEnableRuntimeListeners()}DeScheduleTimeline(e){e.SetPlaying(!1),e.SetScheduled(!1),e.ResolvePlayPromise(),Sy.arrayFindRemove(this._scheduledTimelines,e),this._MaybeDisableRuntimeListeners()}CompleteTimeline(e){e.SetPlaying(!1),e.SetScheduled(!1),this._playingTimelines.includes(e)&&(e.SetMarkedForRemoval(!0),this._markedForRemovalTimelines.push(e),Sy.arrayFindRemove(this._playingTimelines,e)),this._scheduledTimelines.includes(e)&&e.SetMarkedForRemoval(!0)}CompleteTimelineBeforeChangeOfLayout(e){e.SetPlaying(!1),e.SetScheduled(!1),e.SetMarkedForRemoval(!1),e.SetPlaybackRate(1),Sy.arrayFindRemove(this._playingTimelines,e)}CompleteTimelineAndResolve(e){this.CompleteTimeline(e),e.ResolvePlayPromise()}_OnTick(){const e=this.GetRuntime();if(e.IsLoadingState())return;if(!this._hasRuntimeListeners)return;if(this._changingLayout)return;let t=0;for(e.IsDebug()&&(t=performance.now()),this._isTickingTimelines=!0;this._scheduledTimelines.length;){const e=this._scheduledTimelines.pop();e.IsMarkedForRemoval()?(e.SetInitialStateForce(),this._markedForRemovalTimelines.push(e)):(e.SetInitialState(),this._playingTimelines.push(e)),0!==e.GetRenderChange()&&(this._renderChange=1)}const s=this._runtime._GetDtFast(),i=this._runtime.GetDt1(),r=this._runtime.GetTimeScale();for(let e=this._playingTimelines.length-1;e>=0;e--){const t=this._playingTimelines[e];t&&t.Tick(s,r,i)}this._isTickingTimelines=!1,e.IsDebug()&&globalThis.C3Debugger.AddTweensAndTimelinesTime(performance.now()-t),0!==this._renderChange&&e.UpdateRender()}_OnTick2(){const e=this.GetRuntime();if(e.IsLoadingState())return;if(!this._hasRuntimeListeners)return;if(this._changingLayout)return;let t,s=0;e.IsDebug()&&(s=performance.now());for(let e=0,s=this._markedForRemovalTimelines.length;e<s;e++){const s=this._markedForRemovalTimelines[e];t||(t=new Set),s.Removed(),this._MaybeExecuteTimelineFinishTriggers(s),t.add(s)}if(t){Sy.arrayRemoveAllInSet(this._markedForRemovalTimelines,t),this._renderChange=0;for(let e=0,t=this._playingTimelines.length;e<t;e++)if(0!==this._playingTimelines[e].GetRenderChange()){this._renderChange=1;break}}this._MaybeDisableRuntimeListeners(),e.IsDebug()&&globalThis.C3Debugger.AddTweensAndTimelinesTime(performance.now()-s)}_MaybeExecuteTimelineFinishTriggers(e){e.IsReleased()||e.HasValidTracks()&&e.IsComplete()&&e.InitialStateSet()&&e.FinishTriggers()}_MaybeEnableRuntimeListeners(){this._hasRuntimeListeners||(this._hasRuntimeListeners=!0)}_MaybeDisableRuntimeListeners(){this._markedForRemovalTimelines.length||this._playingTimelines.length||this._scheduledTimelines.length||this._isTickingTimelines||(this._hasRuntimeListeners=!1)}_OnBeforeChangeLayout(){for(this._changingLayout=!0;this._scheduledTimelines.length;)this.DeScheduleTimeline(this._scheduledTimelines.pop());const e=new Set;for(const t of this._playingTimelines)t._OnBeforeChangeLayout()&&(t.Removed(),e.add(t));Sy.arrayRemoveAllInSet(this._playingTimelines,e),e.clear();for(const t of this._markedForRemovalTimelines)t._OnBeforeChangeLayout()&&(t.Removed(),e.add(t));Sy.arrayRemoveAllInSet(this._markedForRemovalTimelines,e),this._MaybeDisableRuntimeListeners();for(const e of this._timelines)e.CleanCaches()}_OnAfterChangeLayout(){this._changingLayout=!1}_OnInstanceDestroy(e){const t=e.GetObjectClass(),s=this.GetTimelinesForObjectClass(t);if(s)if(this._runtime.IsLoadingState())this._destroyedWhileLoadingState.push(e);else for(const e of s)e.IsTemplate()||(e.IsReleased()?this.Remove(e):e.HasValidTracks()||(this._MaybeExecuteTimelineFinishTriggers(e),this.Remove(e)))}_OnBeforeLoad(){for(const e of this._scheduledTimelines.map(e=>e))this._MaybeExecuteTimelineFinishTriggers(e),this.Remove(e);for(const e of this._playingTimelines.map(e=>e))this._MaybeExecuteTimelineFinishTriggers(e),this.Remove(e)}_OnAfterLoad(){for(const e of this._destroyedWhileLoadingState)this._OnInstanceDestroy(e);Sy.clearArray(this._destroyedWhileLoadingState);for(const e of this._timelines)e._OnAfterLoad()}_OnAfterLayoutStart(){const e=this._runtime.GetLayoutManager().GetMainRunningLayout();if(e)for(const t of this._timelines){const s=t.GetStartOnLayout();s&&e.GetName()===s&&this.ScheduleTimeline(t)}}_SaveToJson(){return{timelinesJson:this._SaveTimelinesToJson(),scheduledTimelinesJson:this._SaveScheduledTimelinesToJson(),playingTimelinesJson:this._SavePlayingTimelinesToJson(),markedForRemovalTimelinesJson:this._SaveMarkedForRemovalTimelinesToJson(),hasRuntimeListeners:this._hasRuntimeListeners,changingLayout:this._changingLayout,isTickingTimelines:this._isTickingTimelines}}_LoadFromJson(e){e&&(this._ClearCreatedTemplateTimelinesCount(),this._LoadTimelinesFromJson(e.timelinesJson),this._LoadScheduledTimelinesFromJson(e.scheduledTimelinesJson),this._LoadPlayingTimelinesFromJson(e.playingTimelinesJson),this._LoadMarkedForRemovalTimelinesFromJson(e.markedForRemovalTimelinesJson),this._hasRuntimeListeners=!e.hasRuntimeListeners,this._changingLayout=!!e.changingLayout,this._isTickingTimelines=!!e.isTickingTimelines,this._SetCreatedTemplateTimelinesCount(),this._MaybeEnableRuntimeListeners(),this._MaybeDisableRuntimeListeners())}_SaveTimelinesToJson(){return this._timelines.map(e=>e._SaveToJson())}_LoadTimelinesFromJson(e){for(const t of e){let e=this.GetTimelineByName(t.name);if(e)e._LoadFromJson(t);else{const s=this._GetTemplateNameFromJson(t);if(!s)continue;const i=this.GetTimelineByName(s);e=this.CreateFromTemplate(i),e._LoadFromJson(t)}e.HasTracks()||this.Remove(e)}}_GetTemplateNameFromJson(e){const t=e.name.split(":");return t&&2===t.length?t[0]:null}_SaveScheduledTimelinesToJson(){return this._SaveTimelines(this._scheduledTimelines)}_LoadScheduledTimelinesFromJson(e){this._LoadTimelines(e,this._scheduledTimelines)}_SavePlayingTimelinesToJson(){return this._SaveTimelines(this._playingTimelines)}_LoadPlayingTimelinesFromJson(e){this._LoadTimelines(e,this._playingTimelines)}_SaveMarkedForRemovalTimelinesToJson(){return this._SaveTimelines(this._markedForRemovalTimelines)}_LoadMarkedForRemovalTimelinesFromJson(e){this._LoadTimelines(e,this._markedForRemovalTimelines)}_IsTimelineInJson(e,t){if(!t)return!1;for(const s of t)if(s===e.GetName())return!0;return!1}_SaveTimelines(e){return e.map(e=>e.GetName())}_LoadTimelines(e,t){const s=new Set;for(const i of t)this._IsTimelineInJson(i,e)||s.add(i);if(Sy.arrayRemoveAllInSet(t,s),e){const s=e=>t=>t.GetName()===e;for(const i of e){const e=this.GetTimelineByName(i);e&&(t.find(s(i))||t.push(e))}}}}}{const xy=self.C3,by=100,Gy=.01,Iy=25,vy=20,Cy=5,wy=[0,0],Ay=[0,0],Ry=[0,0],Py=[0,0,0,0,0],My=new Array(4),Ey=[{x:0,y:0,t:0,distance:0},{x:0,y:0,t:0,distance:0},{x:0,y:0,t:0,distance:0}],Dy={x:0,y:0,t:0,distance:0};xy.TimelineInfo=class{constructor(e,t){this._initialized=!1,this._timeline=e,this._segments=[];let s=null;if(s=t?this._timeline.GetTrackById(t):xy.first(this._timeline.GetTracks()),!s)return;const i=s.GetPropertyTrack("offsetX"),r=s.GetPropertyTrack("offsetY");if(!i||!r)return;this._xTrack=i,this._yTrack=r;const n=i.GetPropertyKeyframeDataItemArrayIncludingDisabled(),a=r.GetPropertyKeyframeDataItemArrayIncludingDisabled();for(let e=1,t=Math.min(n.length,a.length);e<t;++e){const t=n[e],s=(t.GetNext(),t.GetPrevious()),i=a[e],r=(i.GetNext(),i.GetPrevious());s&&"cubic-bezier"===s.GetPathMode()&&r&&"cubic-bezier"===r.GetPathMode()?this._segments.push(xy.New(xy.TimelineCubicBezierSegmentInfo,s,r,t,i,this._segments.length)):(s&&"line"===s.GetPathMode()&&r&&r.GetPathMode(),this._segments.push(xy.New(xy.TimelineLineSegmentInfo,t,i,this._segments.length)))}this._initialized=!0}Release(){for(const e of this._segments)e.Release();xy.clearArray(this._segments),this._segments=null,this._timeline=null,this._xTrack=null,this._yTrack=null}WasInitialized(){return this._initialized}segments(){return this._segments}SetOrigin(e){const t="relative"===this._xTrack.GetResultMode()?e.GetX():0,s="relative"===this._yTrack.GetResultMode()?e.GetY():0;for(const e of this._segments)e.SetOrigin(t,s)}Project(e,t,s){let i=NaN,r=this._segments.length;for(let s=0;s<r;s++){const r=this._segments[s];if("cubic-bezier"===r.GetType()){const s=r.Project(e,t);(isNaN(i)||s[3]<i)&&(i=s[3],Ry[0]=s[2],Ry[1]=r.GetIndex())}}return Ry}ProjectWithOptions(e,t,s){const i=s.tRange;xy.IsFiniteNumber(i[0])||(i[0]=0),xy.IsFiniteNumber(i[1])||(i[1]=1);let r=NaN,n=this._segments.length;for(let s=0;s<n;s++){const n=this._segments[s];if("cubic-bezier"===n.GetType()){const s=n.ProjectWithRange(e,t,i);(isNaN(r)||s[3]<r)&&(r=s[3],Ry[0]=s[2],Ry[1]=n.GetIndex())}}return Ry}Tangent(e,t){return this._segments[t].Tangent(e)}TangentAngle(e,t){return this._segments[t].TangentAngle(e)}},xy.TimelineCubicBezierSegmentInfo=class{constructor(e,t,s,i,r){this._index=r;const n=e.GetAddOn("cubic-bezier"),a=s.GetAddOn("cubic-bezier"),o=t.GetAddOn("cubic-bezier"),l=i.GetAddOn("cubic-bezier");this._aX=e.GetValueWithResultMode(),this._aY=t.GetValueWithResultMode(),this._bX=e.GetValueWithResultMode()+n.GetStartAnchor(),this._bY=t.GetValueWithResultMode()+o.GetStartAnchor(),this._cX=s.GetValueWithResultMode()+a.GetEndAnchor(),this._cY=i.GetValueWithResultMode()+l.GetEndAnchor(),this._dX=s.GetValueWithResultMode(),this._dY=i.GetValueWithResultMode(),this._aXO=0,this._aYO=0,this._bXO=0,this._bYO=0,this._cXO=0,this._cYO=0,this._dXO=0,this._dYO=0,this._d0x=0,this._d0y=0,this._d1x=0,this._d1y=0,this._d2x=0,this._d2y=0,this._x1Factor=0,this._x2Factor=0,this._x3Factor=0,this._y1Factor=0,this._y2Factor=0,this._y3Factor=0,this._lutIndex=NaN,this._initialized=!1,this._len=100,this._arcLengths=new Array(this._len+1),this._arcLengths[0]=0,this._length=0,this._lut=[],this._lutObjects=[];for(let e=0;e<100;e++)this._lutObjects.push({x:0,y:0,t:0,distance:0});this._CalculateLength()}Release(){xy.clearArray(this._arcLengths),this._arcLengths=null,xy.clearArray(this._lut),this._lut=null,xy.clearArray(this._lutObjects),this._lutObjects=null}GetType(){return"cubic-bezier"}GetIndex(){return this._index}GetStepCount(){return Math.floor(this._length/25)}GetStepIncrement(){return 1/this.GetStepCount()}SetOrigin(e,t){this._originX=e,this._originY=t,this._arcLengths=new Array(this._len+1),this._arcLengths[0]=0,this._CalculateLength(),this._aXO=this._aX+this._originX,this._aYO=this._aY+this._originY,this._bXO=this._bX+this._originX,this._bYO=this._bY+this._originY,this._cXO=this._cX+this._originX,this._cYO=this._cY+this._originY,this._dXO=this._dX+this._originX,this._dYO=this._dY+this._originY,this._d0x=3*(this._bXO-this._aXO),this._d0y=3*(this._bYO-this._aYO),this._d1x=3*(this._cXO-this._bXO),this._d1y=3*(this._cYO-this._bYO),this._d2x=3*(this._dXO-this._cXO),this._d2y=3*(this._dYO-this._cYO),this._x1Factor=3*(this._bXO-this._aXO),this._x2Factor=3*(this._aXO+this._cXO-2*this._bXO),this._x3Factor=this._dXO-this._aXO+3*(this._bXO-this._cXO),this._y1Factor=3*(this._bYO-this._aYO),this._y2Factor=3*(this._aYO+this._cYO-2*this._bYO),this._y3Factor=this._dYO-this._aYO+3*(this._bYO-this._cYO)}Map(e){if(!this._initialized)return NaN;const t=this._Map(e);return Ay[0]=this._X(t),Ay[1]=this._Y(t),Ay}Project(e,t){const s=this._GenerateLUT(100),i=this._FindClosestFromLUT(e,t,s),r=this._RefineProjection(e,t,s,i);return Py[0]=r.x,Py[1]=r.y,Py[2]=r.t,Py[3]=r.distance,Py}ProjectWithRange(e,t,s){const i=this._GenerateLUT(100),r=this._FindClosestFromLUTWithRange(e,t,i,s),n=this._RefineProjection(e,t,i,r);return Py[0]=n.x,Py[1]=n.y,Py[2]=n.t,Py[3]=n.distance,Py}Tangent(e){const t=1-e,s=t*t,i=2*t*e,r=e*e,n=s*this._d0x+i*this._d1x+r*this._d2x,a=s*this._d0y+i*this._d1y+r*this._d2y,o=xy.hypot2DFast(n,a);return wy[0]=n/o,wy[1]=a/o,wy}TangentAngle(e){const t=1-e,s=t*t,i=2*t*e,r=e*e,n=s*this._d0x+i*this._d1x+r*this._d2x,a=s*this._d0y+i*this._d1y+r*this._d2y;return Math.atan2(a,n)}_Map(e){if(!this._initialized)return;let t=e*this._arcLengths[this._len],s=0,i=this._len,r=0;for(;s<i;)r=s+((i-s)/2|0),this._arcLengths[r]<t?s=r+1:i=r;this._arcLengths[r]>t&&r--;const n=this._arcLengths[r];return n===t?r/this._len:(r+(t-n)/(this._arcLengths[r+1]-n))/this._len}_X(e){return this._initialized?self.Ease.GetRuntimeEase("cubicbezier")(e,this._aX+this._originX,this._bX+this._originX,this._cX+this._originX,this._dX+this._originX):NaN}_Y(e){return this._initialized?self.Ease.GetRuntimeEase("cubicbezier")(e,this._aY+this._originY,this._bY+this._originY,this._cY+this._originY,this._dY+this._originY):NaN}_GenerateLUT(e){if(e=e||100,this._lut.length>=e)return this._lut;this._lut=new Array(e),e++;for(let t=0;t<e-1;t++){const s=t/(e-1),i=s**2,r=s**3,n=this._x1Factor*s,a=this._x2Factor*i,o=this._x3Factor*r,l=this._y1Factor*s,h=this._y2Factor*i,u=this._y3Factor*r,c=this._aXO+n+a+o,d=this._aYO+l+h+u;this._lutObjects[t].x=c,this._lutObjects[t].y=d,this._lutObjects[t].t=s,this._lutObjects[t].distance=0,this._lut[t]=this._lutObjects[t]}return this._lut}_FindClosestFromLUT(e,t,s,i=null,r=Number.MAX_SAFE_INTEGER){let n=0;if(isNaN(this._lutIndex))for(let i=0;i<100;i++){const a=s[i],o=a.x-e,l=a.y-t;a.distance=o*o+l*l,a.distance<r&&(r=a.distance,n=i)}else{for(let i=this._lutIndex;i<this._lutIndex+5&&!(i>=s.length);i++){const a=s[i],o=a.x-e,l=a.y-t;a.distance=o*o+l*l,a.distance<r&&(r=a.distance,n=i)}for(let i=this._lutIndex;i>this._lutIndex-5&&!(i<0);i--){const a=s[i],o=a.x-e,l=a.y-t;a.distance=o*o+l*l,a.distance<r&&(r=a.distance,n=i)}}return this._lutIndex=n,n}_FindClosestFromLUTWithRange(e,t,s,i,r=Number.MAX_SAFE_INTEGER){let n=0;if(isNaN(this._lutIndex))for(let a=0;a<100;a++){const o=s[a],l=o.x-e,h=o.y-t;o.distance=l*l+h*h,o.t>=i[0]&&o.t<=i[1]&&o.distance<r&&(r=o.distance,n=a)}else{for(let a=this._lutIndex;a<this._lutIndex+5&&!(a>=s.length);a++){const o=s[a],l=o.x-e,h=o.y-t;o.distance=l*l+h*h,o.t>=i[0]&&o.t<=i[1]&&o.distance<r&&(r=o.distance,n=a)}for(let a=this._lutIndex;a>this._lutIndex-5&&!(a<0);a--){const o=s[a],l=o.x-e,h=o.y-t;o.distance=l*l+h*h,o.t>=i[0]&&o.t<=i[1]&&o.distance<r&&(r=o.distance,n=a)}}return this._lutIndex=n,n}_RefineProjection(e,t,s,i){let r=s[i],n=1,a=Number.MAX_SAFE_INTEGER;e:do{const n=s.length;let o=0===i?0:i-1,l=i===n-1?n-1:i+1,h=s[o].t,u=(s[l].t-h)/4;if(u<.001)break;My[0]=s[o];for(let s=1;s<=2;s++){const n=h+s*u,o=n**2,l=n**3,c=this._x1Factor*n,d=this._x2Factor*o,p=this._x3Factor*l,_=this._y1Factor*n,m=this._y2Factor*o,f=this._y3Factor*l,g=this._aXO+c+d+p,y=this._aYO+_+m+f,S=g-e,T=y-t,x=S*S+T*T;if(x<a){a=x,i=s,Dy.x=g,Dy.y=y,Dy.t=n,Dy.distance=x,r=Dy;break e}const b=Ey[s-1];b.x=g,b.y=y,b.t=n,b.distance=x,My[s]=b}My[3]=s[l],s=My}while(n++<20);return r}_CalculateLength(){this._initialized=!0;let e=this._X(0),t=this._Y(0),s=0;for(let i=1;i<=this._len;i++){const r=this._X(.01*i),n=this._Y(.01*i),a=e-r,o=t-n;s+=xy.hypot2DFast(a,o),this._arcLengths[i]=s,e=r,t=n}this._length=s}},xy.TimelineLineSegmentInfo=class{constructor(e,t,s){this._index=s,this._targetX=e.GetValueWithResultMode(),this._targetY=t.GetValueWithResultMode(),this._originX=0,this._originY=0}Release(){}GetType(){return"line"}GetIndex(){return this._index}SetOrigin(e,t){this._originX=e,this._originY=t}GetX(){return this._targetX+this._originX}GetY(){return this._targetY+this._originY}}}{const Ny=self.C3,Fy=0,Oy=1;Ny.TimelineState=class extends Ny.DefendedBase{constructor(e,t,s){super(),this._runtime=s.GetRuntime(),this._timelineManager=s,this._timelineDataItem=t,this._name=e,this._tracks=[],this._tracksLength=0,this._beforeAndAfterTracks=null,this._beforeAndAfterTracksLength=0,this.CreateTrackStates(),this._playPromise=null,this._playResolve=null,this._playheadTime=0,this._overshoot=0,this._playbackRate=1,this._pingPongState=0,this._resumePingPongState=-1,this._currentRepeatCount=1,this._isPlaying=!1,this._isScheduled=!1,this._initialStateSet=!1,this._complete=!0,this._released=!1,this._markedForRemoval=!1,this._completedTick=-1,this._implicitPause=!1,this._isTemplate=!1,this._finishedTriggers=!1,this._firstTick=!1,this._lastDelta=NaN,this._tags=[""],this._stringTags="",this._tagsChanged=!1,this._renderChange=0,this._hasNestedContent=0,this._stoppedKeyframeDataItem=null,this._iTimelineState=null}static CreateInitial(e,t){const s=t.GetTimelineDataManager(),i=s.GetNameId(),r=s.Get(e[i]),n=Ny.New(Ny.TimelineState,e[i],r,t);return n.SetIsTemplate(!0),n}static CreateFromTemplate(e,t,s){return Ny.New(Ny.TimelineState,e,t,s)}Release(){if(this.IsReleased())return;const e=this._runtime.Dispatcher();this._timelineManager.DeScheduleTimeline(this),this._timelineManager.CompleteTimelineAndResolve(this);for(const e of this._tracks)e.Release();Ny.clearArray(this._tracks),this._tracks=null,this._runtime=null,this._timelineManager=null,this._timelineDataItem=null,this._released=!0,this._playPromise=null,this._playResolve=null,this.FireReleaseEvent(e)}FireReleaseEvent(e){const t=Ny.New(Ny.Event,"timelinestatereleased");t.timelineState=this,e.dispatchEvent(t)}GetType(){return 0}CreateTrackStates(){for(const e of this._timelineDataItem.GetTrackData().trackDataItems())this._tracksLength=this._tracks.push(Ny.TrackState.Create(this,e))}GetTimelineManager(){return this._timelineManager}GetRuntime(){return this._runtime}GetTracks(){return this._tracks}GetSimilarPropertyTracks(e,t,s,i){if(!this._hasNestedContent)return;let r;for(let n=0;n<this._tracks.length;n++){let a=this._tracks[n];if(e!==a.GetInstance())continue;const o=a.GetPropertyTrack(s);o&&t.constructor===o.GetSourceAdapter().constructor&&o.GetResultMode()===i.GetResultMode()&&(r||(r=[]),r.push(o))}return r}HasTracks(){return!!this._tracks.length}GetTrackById(e){for(const t of this._tracks)if(Ny.equalsNoCase(t.GetId(),e))return t;return null}GetTrackByName(e){for(const t of this._tracks)if(!t.IsInstanceTrack()&&Ny.equalsNoCase(t.GetName(),e))return t;return null}SetName(e){this._name=e}GetName(){return this._name}GetTimelineDataItem(){return this._timelineDataItem}GetTemplateName(){return this._timelineDataItem.GetName()}GetTotalTime(){return this._timelineDataItem.GetTotalTime()}SetTotalTime(e){this._timelineDataItem.SetTotalTime(e)}GetStep(){return this._timelineDataItem.GetStep()}SetStep(e){this._timelineDataItem.SetStep(e)}GetInterpolationMode(){return this._timelineDataItem.GetInterpolationMode()}SetInterpolationMode(e){this._timelineDataItem.SetInterpolationMode(e)}GetResultMode(){return this._timelineDataItem.GetResultMode()}SetResultMode(e){this._timelineDataItem.GetResultMode(e)}SetEase(e){for(const t of this.GetTracks())t.SetEase(e)}GetLoop(){return this._timelineDataItem.GetLoop()}SetLoop(e){return this._timelineDataItem.SetLoop(e)}GetPingPong(){return this._timelineDataItem.GetPingPong()}SetPingPong(e){return this._timelineDataItem.SetPingPong(e)}GetRepeatCount(){return this._timelineDataItem.GetRepeatCount()}SetRepeatCount(e){return this._timelineDataItem.SetRepeatCount(e)}SetPlaybackRate(e){return this._playbackRate=e}GetPlaybackRate(){return this._playbackRate}GetStartOnLayout(){return this._timelineDataItem.GetStartOnLayout()}GetTransformWithSceneGraph(){return this._timelineDataItem.GetTransformWithSceneGraph()}GetUseSystemTimescale(){return this._timelineDataItem.GetUseSystemTimescale()}GetPingPongState(){return this._pingPongState}IsForwardPlayBack(){return!this.IsPlaying()||this._playbackRate>0}GetPlayPromise(){return this._playPromise||(this._playPromise=new Promise(e=>{this._playResolve=e})),this._playPromise}ResolvePlayPromise(){this._playPromise&&(this._playResolve(),this._playPromise=null,this._playResolve=null)}SetTags(e){this._tags=Ny.TimelineState._GetTagArray(e),this._tagsChanged=!0}GetTags(){return this._tags}GetStringTags(){return this._tagsChanged&&(this._stringTags=this._tags.join(" ")),this._tagsChanged=!1,this._stringTags}HasTags(e){if(!this._tags)return!1;if(!this._tags.length)return!1;const t=Ny.TimelineState._GetTagArray(e);return!!t&&!!t.length&&t.every(Ny.TimelineState._HasTag,this)}OnStarted(){Ny.Plugins.Timeline&&this.constructor===Ny.TimelineState&&(Ny.Plugins.Timeline.Cnds.PushTriggerTimeline(this),this._timelineManager.Trigger(Ny.Plugins.Timeline.Cnds.OnTimelineStarted),this._timelineManager.Trigger(Ny.Plugins.Timeline.Cnds.OnTimelineStartedByName),this._timelineManager.Trigger(Ny.Plugins.Timeline.Cnds.OnTimelineStartedByTags),this._timelineManager.Trigger(Ny.Plugins.Timeline.Cnds.OnAnyTimelineStarted),Ny.Plugins.Timeline.Cnds.PopTriggerTimeline())}OnCompleted(){this._completedTick=this._runtime.GetTickCount()}FinishTriggers(){this._finishedTriggers||(this._finishedTriggers=!0,Ny.Plugins.Timeline&&this.constructor===Ny.TimelineState&&(Ny.Plugins.Timeline.Cnds.PushTriggerTimeline(this),this._timelineManager.Trigger(Ny.Plugins.Timeline.Cnds.OnTimelineFinished),this._timelineManager.Trigger(Ny.Plugins.Timeline.Cnds.OnTimelineFinishedByName),this._timelineManager.Trigger(Ny.Plugins.Timeline.Cnds.OnTimelineFinishedByTags),this._timelineManager.Trigger(Ny.Plugins.Timeline.Cnds.OnAnyTimelineFinished),Ny.Plugins.Timeline.Cnds.PopTriggerTimeline()))}SetPlaying(e){this._isPlaying=e}IsCompletedTick(){return this._completedTick===this._runtime.GetTickCount()}IsPlaying(e=!1){return!!this.IsCompletedTick()||!(!this.IsScheduled()||e)||this._isPlaying}_IsPlaying(){return this.IsPlaying(!0)}IsPaused(){return this._IsPaused()}_IsPaused(){return!(this.IsReleased()||this.IsScheduled()||this._IsPlaying()||this.IsComplete())}SetScheduled(e){this._isScheduled=e}IsScheduled(){return this._isScheduled}SetComplete(e){this._complete=e;const t=this.GetLoop(),s=this.GetPingPong();if(t||s){if(t&&!s);else if(!t&&s){const e=this.GetTime();1===this._pingPongState&&(e<=0||e>=this.GetTotalTime())&&(this._complete=!0)}}else{const e=this.GetTime();(e<=0||e>=this.GetTotalTime())&&(this._complete=!0)}}IsComplete(){return this._complete}IsReleased(){return this._released}SetMarkedForRemoval(e){this._markedForRemoval=e}IsMarkedForRemoval(){return this._markedForRemoval}SetImplicitPause(e){this._implicitPause=e}IsImplicitPause(){return this._implicitPause}SetIsTemplate(e){this._isTemplate=!!e}IsTemplate(){return this._isTemplate}InitialStateSet(){return this._initialStateSet}GetTime(){return this._playheadTime}SetTime(e){const t=this.GetTime();this._SetTime(e),this.SetComplete(!1),this.IsComplete()||this.SetImplicitPause(!0),(this._IsPlaying()||this.IsScheduled()||!this._initialStateSet)&&(this._IsPlaying()||this.IsScheduled()||this._initialStateSet?this._IsPlaying()?this.Stop():this.IsScheduled()&&(this._timelineManager.DeScheduleTimeline(this),this.SetInitialStateFromSetTime()):this.SetInitialStateFromSetTime()),this._SetUpdateStateBefore(),this._Interpolate(this.GetTime(),!1,!0,!0,t),this._SetUpdateStateAfter(),this._renderChange&&this.GetRuntime().UpdateRender(),this._OnSetTime()}_SetTime(e){Ny.IsFiniteNumber(e)||(e=this.GetTotalTime()),e<0?this._playheadTime=0:e>=this.GetTotalTime()?this._playheadTime=this.GetTotalTime():this._playheadTime=e}_SetTimeAndReset(e){Ny.IsFiniteNumber(e)||(e=this.GetTotalTime()),e<0?this._playheadTime=0:e>=this.GetTotalTime()?this._playheadTime=this.GetTotalTime():this._playheadTime=e;for(const e of this._tracks)e.SetResetState()}_OnSetTime(){Ny.Plugins.Timeline&&this.constructor===Ny.TimelineState&&(Ny.Plugins.Timeline.Cnds.PushTriggerTimeline(this),this._timelineManager.Trigger(Ny.Plugins.Timeline.Cnds.OnTimeSet),this._timelineManager.Trigger(Ny.Plugins.Timeline.Cnds.OnTimeSetByName),this._timelineManager.Trigger(Ny.Plugins.Timeline.Cnds.OnTimeSetByTags),Ny.Plugins.Timeline.Cnds.PopTriggerTimeline())}_CanResume(){if(this.GetLoop())return!0;if(this.GetPingPong()&&1===this._pingPongState){if(this.IsForwardPlayBack()){if(this.GetTime()>=this.GetTotalTime())return!1}else if(this.GetTime()<=0)return!1}else if(!this.GetLoop()&&!this.GetPingPong())if(this.IsForwardPlayBack()){if(this.GetTime()>=this.GetTotalTime())return!1}else if(this.GetTime()<=0)return!1;return!0}Resume(){this.IsReleased()||this._CanResume()&&this.Play(!0)}Play(e=!1){return!this.IsReleased()&&!this.IsScheduled()&&(this._IsPlaying()&&this.IsCompletedTick()?this._SchedulePlayingTimeline():!this._IsPlaying()&&!!(this.IsComplete()||e||this.IsImplicitPause())&&this._ScheduleStoppedTimeline())}_SchedulePlayingTimeline(){return this.SetImplicitPause(!1),this._timelineManager.RemovePlayingTimeline(this),this._timelineManager.ScheduleTimeline(this),this.GetPlayPromise(),!0}_ScheduleStoppedTimeline(){return this.SetImplicitPause(!1),this._timelineManager.ScheduleTimeline(this),this.GetPlayPromise(),!0}Stop(e=!1){this.IsReleased()||(this.SetComplete(e),this._timelineManager.CompleteTimeline(this),this.IsComplete()&&this.ResolvePlayPromise())}Reset(e=!0,t=!1){if(this.IsReleased())return;if(!this._IsPlaying()&&this.IsScheduled())return this._timelineManager.DeScheduleTimeline(this);if(this.IsComplete())return;this.Stop(!0),this.IsForwardPlayBack()?this._SetTime(0):this._SetTime(this.GetTotalTime());const s=this.GetTime();this._SetUpdateStateBefore(),t?this._InterpolateBeforeChangeLayout(s):this._Interpolate(s,!1,!1,!0),e&&this._OnSetTime(),this._SetUpdateStateAfter(),this._renderChange&&e&&this.GetRuntime().UpdateRender()}ResetBeforeChangeLayout(){this.Reset(!1,!0)}_InterpolateBeforeChangeLayout(e){this._Interpolate(e,!1,!1,!0,NaN,!1,!0)}_OnBeforeChangeLayout(){return!!this.IsReleased()||!(!this.GetRuntime().IsLoadingState()&&this.HasValidGlobalTracks())&&(this._timelineManager.CompleteTimelineBeforeChangeOfLayout(this),this.GetRuntime().IsLoadingState()||this.ResetBeforeChangeLayout(),!0)}SetInitialStateFromSetTime(){this.SetInitialState(!0)}SetInitialStateForce(){this.SetInitialState(!1,!0),this.SetPlaying(!1),this.SetScheduled(!1)}SetInitialState(e=!1,t=!1){if(!this.IsMarkedForRemoval()||t)if(e){this._finishedTriggers=!1,this._initialStateSet=!0,this._firstTick=!0,this._SetUpdateStateBefore();for(const e of this._tracks)e.SetInitialState();this._SetUpdateStateAfter()}else if(this.SetPlaying(!0),this.SetScheduled(!1),this.OnStarted(),this.IsComplete()){this._completedTick=-1,0!==this._pingPongState&&(this._playbackRate=Math.abs(this._playbackRate)),this._pingPongState=0,this._resumePingPongState=-1,this._currentRepeatCount=1,this._complete=!1,this._finishedTriggers=!1,this._initialStateSet=!0,this._firstTick=!0,this.IsForwardPlayBack()?this._SetTime(0):this._SetTime(this.GetTotalTime()),this._SetUpdateStateBefore();for(const e of this._tracks)e.SetInitialState();this._SetUpdateStateAfter()}else{-1!==this._resumePingPongState&&(this._pingPongState=this._resumePingPongState),this._firstTick=!0,this._finishedTriggers=!1,this._SetUpdateStateBefore();for(const e of this._tracks)e.SetResumeState();this._SetUpdateStateAfter()}}GetRenderChange(){return this._renderChange}_SetUpdateStateBefore(){this._hasNestedContent=0;for(const e of this._tracks)e.IsNested()&&(this._hasNestedContent=1)}_SetUpdateStateAfter(){this._renderChange=0;for(const e of this._tracks)e._SetUpdateState(),0===this._renderChange&&1===e.GetRenderChange()&&(this._renderChange=1),this._beforeAndAfterTracks||1!==e.GetNeedsBeforeAndAfter()||(this._beforeAndAfterTracks||(this._beforeAndAfterTracks=[]),this._beforeAndAfterTracksLength=this._beforeAndAfterTracks.push(e))}Tick(e,t,s){if(this.GetUseSystemTimescale()){if(0===e&&0===this._lastDelta)return;this._lastDelta=e,e=s}else{if(0===s&&0===this._lastDelta)return;this._lastDelta=s,e=s,t=1}const i=this._playheadTime+this._overshoot,r=i+e*t*this._playbackRate,n=this._timelineDataItem._totalTime;r<0?(this._playheadTime=0,this._overshoot=-r):r>=n?(this._playheadTime=n,this._overshoot=this._playheadTime-r):(this._playheadTime=r,this._overshoot=0);let a=!1,o=!1;const l=this.GetLoop(),h=this.GetPingPong();let u;l||h?l&&!h?this._playbackRate>0?this._playheadTime>=n&&(this._SetTimeAndReset(0),o=!0):this._playheadTime<=0&&(this._SetTimeAndReset(n),o=!0):!l&&h?this._playbackRate>0?this._playheadTime>=n&&(this._SetTime(n),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,1===this._pingPongState?this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._pingPongState=0):a=!0:0===this._pingPongState&&(this._pingPongState=1)):this._playheadTime<=0&&(this._SetTime(0),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,1===this._pingPongState?this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._pingPongState=0):a=!0:0===this._pingPongState&&(this._pingPongState=1)):l&&h&&(this._playbackRate>0?this._playheadTime>=n&&(this._SetTime(n),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,this._pingPongState++,Ny.wrap(this._pingPongState,0,2)):this._playheadTime<=0&&(this._SetTime(0),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,this._pingPongState++,Ny.wrap(this._pingPongState,0,2))):this._playbackRate>0?this._playheadTime>=n&&(this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._SetTimeAndReset(0),o=!0):(this._SetTime(n),a=!0)):this._playheadTime<=0&&(this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._SetTimeAndReset(n),o=!0):(this._SetTime(0),a=!0));const c=this._tracksLength;if(a){for(u=0;u<c;u++)this._tracks[u].SetEndState();return this.Stop(!0),void this.OnCompleted()}const d=this._beforeAndAfterTracksLength;for(u=0;u<d;u++)this._beforeAndAfterTracks[u].BeforeInterpolate();if(1===this._hasNestedContent)for(u=0;u<c;u++){const e=this._tracks[u],t=e.GetStartOffset();this._playheadTime-t<0&&i-t>0?(this._playheadTime=t<0?0:t>=n?n:t,e.Interpolate(t,!0,!1,o,this._firstTick,!1)):e.Interpolate(this._playheadTime,!0,!1,o,this._firstTick,!1)}else for(u=0;u<c;u++)this._tracks[u].Interpolate(this._playheadTime,!0,!1,o,this._firstTick,!1);if(!this.IsPlaying()&&this._stoppedKeyframeDataItem){const e=this._stoppedKeyframeDataItem.GetTime()+this._stoppedKeyframeDataItem.GetKeyframeData().GetTrackDataItem().GetStartOffset(),t=this._playheadTime-e;this._playheadTime-=t,0!==this._overshoot&&(this._overshoot-=t),this._stoppedKeyframeDataItem=null}for(u=0;u<d;u++)this._beforeAndAfterTracks[u].AfterInterpolate();this._firstTick&&(this._firstTick=!1)}SetStoppedOnKeyframe(e){this._stoppedKeyframeDataItem=e}GetStoppedOnKeyframe(){return this._stoppedKeyframeDataItem}_Interpolate(e,t=!1,s=!1,i=!1,r=NaN,n=!1,a=!1){for(const e of this._tracks)e.BeforeInterpolate();for(const n of this._tracks){let o=e;if("number"==typeof r&&!isNaN(r)){const e=this.GetTime()-n.GetStartOffset(),t=r-n.GetStartOffset();e<0&&t>0&&(o=n.GetStartOffset(),this._SetTime(o))}n.Interpolate(o,t,s,i,this._firstTick,a)}for(const e of this._tracks)e.AfterInterpolate();this._firstTick&&n&&(this._firstTick=!1)}AddTrack(){const e=this._timelineDataItem.GetTrackData().AddEmptyTrackDataItem(),t=Ny.TrackState.Create(this,e);return this._tracksLength=this._tracks.push(t),t}Removed(){if(!this.IsReleased())for(const e of this._tracks)e.TimelineRemoved()}CleanCaches(){for(const e of this._tracks)e.CleanCaches()}ClearTrackInstances(){for(const e of this._tracks)e.ClearInstance()}SetTrackInstance(e,t,s){if(t){if("number"==typeof s&&s>=0){const e=this._tracks[s];if(!e)return;return e.SetInstance(t),void this._timelineManager.SetTimelineObjectClassToMap(t.GetObjectClass(),this)}for(const s of this._tracks)if(s.IsInstanceTrack()){if(e){if(s.GetId()!==e)continue;s.SetInstance(t),this._timelineManager.SetTimelineObjectClassToMap(t.GetObjectClass(),this);break}if(!s.HasInstance()){s.SetInstance(t),this._timelineManager.SetTimelineObjectClassToMap(t.GetObjectClass(),this);break}}}}HasTrackInstance(e,t){for(const s of this._tracks)if(s.IsInstanceTrack())if(t){if(t===s.GetId()&&e===s.GetInstance())return!0}else if(e===s.GetInstance())return!0;return!1}HasValidTracks(){return this._tracks.some(e=>!e.IsInstanceTrack()||e.CanInstanceBeValid())}HasValidGlobalTracks(){return this._tracks.some(e=>{if(e.IsInstanceTrack()){if(!e.CanInstanceBeValid())return!1;const t=e.GetObjectClass();return!!t&&t.IsGlobal()}return!1})}GetPropertyTrack(e){for(const t of this.GetTracks())for(const s of t.GetPropertyTracks())if(s.GetPropertyName()===e)return s}GetTrackFromInstance(e){for(const t of this._tracks)if(e===t.GetInstance())return t;return null}GetKeyframeWithTags(e){let t=e?e.split(" "):[];const s=new Set(t.map(e=>e.toLowerCase().trim()));t=[...s.values()];for(const e of this.GetTracks())for(const s of e.GetKeyframeDataItems())if(t.every(e=>s.HasTag(e)))return s}GetObjectClasses(){const e=[];for(const t of this.GetTracks())e.push(t.GetObjectClass());return e.filter(e=>e)}_OnAfterLoad(){for(const e of this.GetTracks())e._OnAfterLoad()}_SaveToJson(){return{tracksJson:this._SaveTracksToJson(),name:this._name,playheadTime:this.GetTime(),playbackRate:this._playbackRate,pingPongState:this._pingPongState,resumePingPongState:this._resumePingPongState,currentRepeatCount:this._currentRepeatCount,isPlaying:this._isPlaying,isScheduled:this._isScheduled,initialStateSet:this._initialStateSet,finishedTriggers:this._finishedTriggers,complete:this._complete,released:this._released,markedForRemoval:this._markedForRemoval,completedTick:this._completedTick,implicitPause:this._implicitPause,isTemplate:this._isTemplate,tags:this._tags.join(" "),stringTags:this._stringTags,tagsChanged:this._tagsChanged,firstTick:this._firstTick}}_LoadFromJson(e){e&&(this._LoadTracksFromJson(e.tracksJson),this._name=e.name,this._playheadTime=e.playheadTime,this._playbackRate=e.playbackRate,this._pingPongState=e.pingPongState,this._resumePingPongState=e.hasOwnProperty("resumePingPongState")?e.resumePingPongState:-1,this._currentRepeatCount=e.currentRepeatCount,this._isPlaying=!!e.isPlaying,this._isScheduled=!!e.isScheduled,this._initialStateSet=!!e.initialStateSet,this._finishedTriggers=!!e.hasOwnProperty("finishedTriggers")&&!!e.finishedTriggers,this._complete=!!e.complete,this._released=!!e.released,this._markedForRemoval=!!e.markedForRemoval,this._completedTick=e.completedTick,this._implicitPause=!!e.implicitPause,this._isTemplate=!!e.isTemplate,this._tags=e.tags.split(" "),this._stringTags=e.stringTags,this._tagsChanged=!!e.tagsChanged,this._firstTick=!!e.firstTick)}_SaveTracksToJson(){return this._tracks.map(e=>e._SaveToJson())}_LoadTracksFromJson(e){this.ClearTrackInstances(),e.forEach((e,t)=>{this._tracks[t]._LoadFromJson(e)}),this._tracks.filter(e=>e.CanInstanceBeValid())}static _HasTag(e){const t=this.GetTags();return""===e?1===t.length&&""===t[0]:t.map(e=>e.toLowerCase()).includes(e.toLowerCase())}static _GetTagArray(e){if(Ny.IsArray(e))return e.slice(0);if(Ny.IsString(e))return e.split(" ");throw new Error("invalid tags")}GetITimelineState(){return this._iTimelineState||(this._iTimelineState=Ny.New(self.ITimelineState,this)),this._iTimelineState}}}{const By=self.C3,Ly=0,ky=1,Vy=2;By.TrackState=class extends By.DefendedBase{constructor(e,t){super(),this._timeline=e,this._trackDataItem=t,this._trackData=t.GetTrackData(),this._instanceUid=NaN,this._objectClassIndex=NaN,this._instance=null,this._worldInfo=null,this._cleared=!1,this._isNested=t.GetStartOffset()>0,this._initialStateOfNestedSet=!1,this._endStateOfNestedSet=!1,this._instanceUidToLoad=NaN,this._lastKeyframeDataItem=null,this._keyframeDataItems=this._trackDataItem.GetKeyframeData().GetKeyframeDataItemArray(),this._propertyTracks=[],this.CreatePropertyTrackStates(),this._worldInfoChange=0,this._renderChange=0,this._needsBeforeAndAfter=0}static Create(e,t){return By.New(By.TrackState,e,t)}Release(){this._keyframeDataItems=null;for(const e of this._propertyTracks)e.Release();By.clearArray(this._propertyTracks),this._propertyTracks=null,this._timeline=null,this._instance=null,this._worldInfo=null,this._trackDataItem=null,this._lastKeyframeDataItem=null}CreatePropertyTrackStates(){for(const e of this._trackDataItem.GetPropertyTrackData().propertyTrackDataItems())this._propertyTracks.push(By.PropertyTrackState.Create(this,e))}TimelineRemoved(){for(const e of this._propertyTracks)e.TimelineRemoved()}CleanCaches(){for(const e of this._propertyTracks)e.CleanCaches();this._instance=null,this._worldInfo=null}GetTimeline(){return this._timeline}GetRuntime(){return this._timeline.GetRuntime()}GetKeyframeDataItems(){return this._keyframeDataItems||(this._keyframeDataItems=this._trackDataItem.GetKeyframeData().GetKeyframeDataItemArray()),this._keyframeDataItems}GetPropertyTracks(){return this._propertyTracks}GetPropertyTrack(e){for(let t=0;t<this._propertyTracks.length;t++){const s=this._propertyTracks[t];if(s.GetPropertyName()===e)return s}}MaybeGetInstance(){this._instance||this.GetInstance()}IsInstanceValid(){return!!this._instance&&!this._instance.IsDestroyed()}CanInstanceBeValid(){if(!this.IsInstanceTrack())return!1;const e=this.GetInstanceUID(),t=this.GetRuntime().GetInstanceByUID(e);return!!t&&!t.IsDestroyed()}GetObjectClass(){if(!this.IsInstanceTrack())return;const e=this.GetObjectClassIndex();return-1!==e?this.GetRuntime().GetObjectClassByIndex(e):void 0}GetTrackIndexInTimeline(){return this._timeline.GetTracks().indexOf(this)}ClearInstance(){this._instance=null,this._instanceUid=NaN,this._worldInfo=null,this._objectClassIndex=NaN,this._cleared=!0}HasInstance(){return!!this._instance}GetInstance(){if(this._cleared)return;if(this._instance&&this.IsInstanceValid())return this._instance;const e=this.GetInstanceUID();return this._instance=this.GetRuntime().GetInstanceByUID(e),this._instance}SetInstance(e){if(this._cleared=!1,this._instance!==e){this.CleanCaches(),this._instance=e,this._objectClassIndex=e.GetObjectClass().GetIndex(),this._instanceUid=e.GetUID(),this._worldInfo=e.GetWorldInfo();for(const t of this.propertyTrackItems()){const s=t.propertyTrack,i=t.sourceAdapter;switch(s.GetSourceAdapterId()){case"instance-variable":{i.GetEditorIndex();const s=e.GetObjectClass(),r=s.GetInstanceVariableIndexByName(t.name),n=s.GetInstanceVariableName(r),a=s.GetInstanceVariableType(r);n===t.name&&a===t.type&&i.UpdateInstanceVariableIndex(r);break}case"behavior":{const s=t.behaviorType,r=this.GetObjectClass(),n=e.GetObjectClass(),a=i.GetBehaviorType(n);if(s&&a){const e=s.GetName();r.GetBehaviorIndexByName(e),n.GetBehaviorIndexByName(e),i.GetEditorIndex(),i.UpdateBehaviorTypeSid(a.GetSID())}break}}}}}*propertyTrackItems(){for(const e of this._propertyTracks){const t=e.GetSourceAdapter(),s=this.GetObjectClass(),i={propertyTrack:e,sourceAdapter:t};switch(e.GetSourceAdapterId()){case"world-instance":i.property=e.GetPropertyName();break;case"instance-variable":{const e=t.GetEditorIndex();i.name=s.GetInstanceVariableName(e),i.type=s.GetInstanceVariableType(e);break}case"effect":{const e=s.GetEffectList(),r=t.GetEffectType(e);i.effectType=r;break}case"behavior":{const e=t.GetBehaviorType(s);i.behaviorType=e;break}case"plugin":i.plugin=s.GetPlugin()}yield i}}GetWorldInfo(){if(this._worldInfo&&this.IsInstanceValid())return this._worldInfo;const e=this.GetInstance();return e&&(this._worldInfo=e.GetWorldInfo()),this._worldInfo}GetTrackDataItem(){return this._trackDataItem}GetInstanceUID(){return isNaN(this._instanceUid)?this._trackDataItem.GetInstanceUID():this._instanceUid}SetInstanceUID(e){this._trackDataItem.SetInstanceUID(e)}GetInterpolationMode(){return this._trackDataItem.GetInterpolationMode()}SetInterpolationMode(e){this._trackDataItem.SetInterpolationMode(e)}GetResultMode(){return this._trackDataItem.GetResultMode()}GetId(){return this._trackDataItem.GetId()}GetStartOffset(){return this._trackDataItem.GetStartOffset()}GetLocalTotalTime(){return this._trackDataItem.GetLocalTotalTime()}SetLocalTotalTime(e){this._trackDataItem.SetLocalTotalTime(e)}SetResultMode(e){this._trackDataItem.SetResultMode(e)}SetEase(e){for(const t of this.GetKeyframeDataItems())t.SetEase(e);for(const t of this.GetPropertyTracks())t.SetEase(e)}GetEnable(){return this._trackDataItem.GetEnable()}SetEnable(e){this._trackDataItem.SetEnable(e)}GetObjectClassIndex(){return isNaN(this._objectClassIndex)?this._trackDataItem.GetObjectClassIndex():this._objectClassIndex}SetObjectClassIndex(e){this._trackDataItem.SetObjectClassIndex(e)}SetOriginalWidth(e){this._trackDataItem.SetOriginalWidth(e)}GetOriginalWidth(){const e=this.GetInstance();return e&&e.GetSdkInstance().IsOriginalSizeKnown()?e.GetSdkInstance().GetOriginalWidth():this._trackDataItem.GetOriginalWidth()}SetOriginalHeight(e){this._trackDataItem.SetOriginalHeight(e)}GetOriginalHeight(){const e=this.GetInstance();return e&&e.GetSdkInstance().IsOriginalSizeKnown()?e.GetSdkInstance().GetOriginalHeight():this._trackDataItem.GetOriginalHeight()}GetType(){return this._trackDataItem.GetType()}GetName(){return this._trackDataItem.GetName()}IsInstanceTrack(){return 0===this.GetType()}IsValueTrack(){return 1===this.GetType()}IsAudioTrack(){return 2===this.GetType()}GetWorldInfoChange(){return this._worldInfoChange}GetRenderChange(){return this._renderChange}GetNeedsBeforeAndAfter(){return this._needsBeforeAndAfter}IsNested(){return this._isNested}SetResetState(){for(const e of this._propertyTracks)e.SetResetState()}SetInitialState(){if(this.MaybeGetInstance(),!this.IsInstanceValid()&&this.IsInstanceTrack())return;const e=this.GetTimeline().IsForwardPlayBack(),t=e?0:this.GetLocalTotalTime();for(const e of this._propertyTracks)e.SetInitialState(t),0===this._worldInfoChange&&1===e.GetWorldInfoChange()&&(this._worldInfoChange=1),0===this._renderChange&&1===e.GetRenderChange()&&(this._renderChange=1);this._needsBeforeAndAfter=0,this._propertyTracks.some(e=>e.GetNeedsBeforeAndAfter())&&(this._needsBeforeAndAfter=1),this._lastKeyframeDataItem=e?this._GetLastKeyFrameBeforeTime(t):this._GetFirstKeyFrameAfterTime(t),this._initialStateOfNestedSet=!1,this._endStateOfNestedSet=!1,this.Interpolate(t),this.OnInitialKeyframeReached(this._lastKeyframeDataItem)}SetResumeState(){if(this.MaybeGetInstance(),!this.IsInstanceValid()&&this.IsInstanceTrack())return;const e=this._timeline.IsForwardPlayBack(),t=this._timeline.GetTime()-this.GetStartOffset();this._lastKeyframeDataItem=e?this._GetLastKeyFrameBeforeTime(t):this._GetFirstKeyFrameAfterTime(t);for(const e of this._propertyTracks)e.SetResumeState(t)}SetEndState(){if(!this.GetTimeline().IsComplete()&&(this.MaybeGetInstance(),(this.IsInstanceValid()||!this.IsInstanceTrack())&&!this._isNested)){const e=this._timeline.GetTime();e>=this.GetStartOffset()+this.GetLocalTotalTime()?this.Interpolate(this.GetLocalTotalTime(),!0,!1,!0,!1,!1,!0):e<=0&&this.Interpolate(0,!0,!1,!0,!1,!1,!0)}}_SetUpdateState(){for(let e=0,t=this._propertyTracks.length;e<t;e++){const t=this._propertyTracks[e];t._SetUpdateState(),0===this._worldInfoChange&&1===t.GetWorldInfoChange()&&(this._worldInfoChange=1),0===this._renderChange&&1===t.GetRenderChange()&&(this._renderChange=1)}}BeforeInterpolate(){const e=this._propertyTracks.length;for(let t=0;t<e;t++)this._propertyTracks[t].BeforeInterpolate()}Interpolate(e,t=!1,s=!1,i=!1,r=!1,n=!1,a=!1){this._instance||this.GetInstance();const o=this._instance&&!this._instance.IsDestroyed(),l=0===this._trackDataItem._type;if((o||!l)&&!(n&&l&&this.GetObjectClass().IsGlobal()||(e-=this.GetStartOffset())<0)){this.MaybeSetInitialStateOfNestedTrack(e,t),this.MaybeTriggerKeyframeReachedConditions(e,t,r),!this.GetTimeline().IsPlaying()&&this.GetTimeline().GetStoppedOnKeyframe()&&(e=this.GetTimeline().GetStoppedOnKeyframe().GetTime());for(let t=0,r=this._propertyTracks.length;t<r;t++)this._propertyTracks[t].Interpolate(e,s,i,a);this.MaybeSetEndStateOfNestedTrack(e,t),0!==this._worldInfoChange&&(this._worldInfo||(this._worldInfo=this._instance.GetWorldInfo()),this._worldInfo&&this._worldInfo.SetBboxChanged())}}AfterInterpolate(){const e=this._propertyTracks.length;for(let t=0;t<e;t++)this._propertyTracks[t].AfterInterpolate()}MaybeSetInitialStateOfNestedTrack(e,t){if(t&&this._isNested&&!this._initialStateOfNestedSet){if(this.GetTimeline().IsForwardPlayBack()){if(e<0)return}else if(e>this.GetLocalTotalTime())return;for(const e of this._propertyTracks)e.SetInitialState();this._initialStateOfNestedSet=!0}}MaybeSetEndStateOfNestedTrack(e,t){if(t&&this._isNested&&!this._endStateOfNestedSet)if(this.GetTimeline().IsForwardPlayBack()){if(e>=this.GetLocalTotalTime()){for(const e of this._propertyTracks)e.Interpolate(this.GetLocalTotalTime(),!1,!0);this._endStateOfNestedSet=!0}}else if(e<=0){for(const e of this._propertyTracks)e.Interpolate(0,!1,!0);this._endStateOfNestedSet=!0}}MaybeTriggerKeyframeReachedConditions(e,t,s){if(s)return;if(!t)return;if(!By.Plugins.Timeline)return;const i=this.GetTimeline();if(i.IsForwardPlayBack()){const t=this._lastKeyframeDataItem.GetNext(),s=this._lastKeyframeDataItem.GetTime(),r=t?t.GetTime():i.GetTotalTime();(e<=s||e>=r)&&(this._lastKeyframeDataItem=this._trackData.GetFirstKeyFrameDataItemLowerOrEqualThan(e,this._trackDataItem),t&&this.OnKeyframeReached(this._lastKeyframeDataItem))}else{if(!this._trackData.GetFirstKeyFrameDataItemHigherOrEqualThan(e,this._trackDataItem))return;this._lastKeyframeDataItem||(this._lastKeyframeDataItem=this._trackData.GetFirstKeyFrameDataItemHigherOrEqualThan(e,this._trackDataItem));const t=this._lastKeyframeDataItem.GetLast(),s=this._lastKeyframeDataItem.GetTime(),i=t?t.GetTime():0;(e>=s||e<=i)&&(this._lastKeyframeDataItem=this._trackData.GetFirstKeyFrameDataItemHigherOrEqualThan(e,this._trackDataItem),this._lastKeyframeDataItem&&this.OnKeyframeReached(this._lastKeyframeDataItem))}}_GetLastKeyFrameBeforeTime(e){return this._trackData.GetKeyFrameDataItemAtTime(e,this._trackDataItem)||this._trackData.GetFirstKeyFrameDataItemLowerOrEqualThan(e,this._trackDataItem)}_GetFirstKeyFrameAfterTime(e){return this._trackData.GetKeyFrameDataItemAtTime(e,this._trackDataItem)||this._trackData.GetFirstKeyFrameDataItemHigherOrEqualThan(e,this._trackDataItem)}OnKeyframeReached(e,t=!1){if(!By.Plugins.Timeline)return;const s=this.GetTimeline(),i=s.GetTimelineManager();By.Plugins.Timeline.Cnds.PushTriggerTimeline(s),By.Plugins.Timeline.Cnds.PushTriggerKeyframe(e),i.Trigger(By.Plugins.Timeline.Cnds.OnAnyKeyframeReached),i.Trigger(By.Plugins.Timeline.Cnds.OnKeyframeReached),s.IsPlaying()||t||s.SetStoppedOnKeyframe(e),By.Plugins.Timeline.Cnds.PopTriggerTimeline(s),By.Plugins.Timeline.Cnds.PopTriggerKeyframe(e)}OnInitialKeyframeReached(e){this.OnKeyframeReached(e,!0)}AddKeyframe(){return this._trackDataItem.GetKeyframeData().AddEmptyKeyframeDataItem()}AddPropertyTrack(){const e=this._trackDataItem.GetPropertyTrackData().AddEmptyPropertyTrackDataItem(),t=By.PropertyTrackState.Create(this,e);return this._propertyTracks.push(t),t}DeleteKeyframes(e){this._trackDataItem.GetKeyframeData().DeleteKeyframeDataItems(e)}DeletePropertyKeyframes(e){for(const t of this._propertyTracks)t.DeletePropertyKeyframes(e)}SaveState(){for(const e of this._propertyTracks)e.SaveState()}CompareInitialStateWithCurrent(){if(this.MaybeGetInstance(),this.IsInstanceValid()||!this.IsInstanceTrack())for(const e of this._propertyTracks)e.CompareInitialStateWithCurrent()}CompareSaveStateWithCurrent(){if(this.MaybeGetInstance(),!this.IsInstanceValid()&&this.IsInstanceTrack())return;let e=!1;for(const t of this._propertyTracks){const s=t.CompareSaveStateWithCurrent();!e&&s&&(e=!0)}if(e){const e=this.AddKeyframe();e.SetTime(this.GetTimeline().GetTime()),e.SetEase("noease"),e.SetEnable(!0),e.SetTags("")}}_OnAfterLoad(){isNaN(this._instanceUidToLoad)||this._LoadInstanceFromJson(this._instanceUidToLoad),this._instanceUidToLoad=NaN}_SaveToJson(){const e=this.GetInstance(),t=e?e.GetUID():this.GetInstanceUID();return{propertyTracksJson:this._SavePropertyTracksToJson(),lastKeyframeDataItemJson:this._SaveLastKeyframeDataItemToJson(),initialStateOfNestedSet:this._initialStateOfNestedSet,endStateOfNestedSet:this._endStateOfNestedSet,instanceUid:t,cleared:this._cleared}}_LoadFromJson(e){if(e){this._LoadPropertyTracksFromJson(e.propertyTracksJson),this._LoadLastKeyframeDataItemFromJson(e.lastKeyframeDataItemJson),this._instanceUidToLoad=e.instanceUid,this._initialStateOfNestedSet=!1,e.hasOwnProperty.initialStateOfNestedSet&&(this._initialStateOfNestedSet=e.initialStateOfNestedSet),this._endStateOfNestedSet=!1,e.hasOwnProperty.endStateOfNestedSet&&(this._endStateOfNestedSet=e.endStateOfNestedSet),this._cleared=!!e.hasOwnProperty("cleared")&&e.cleared;for(const e of this._propertyTracks)0===this._worldInfoChange&&1===e.GetWorldInfoChange()&&(this._worldInfoChange=1),0===this._renderChange&&1===e.GetRenderChange()&&(this._renderChange=1);this._needsBeforeAndAfter=0,this._propertyTracks.some(e=>e.GetNeedsBeforeAndAfter())&&(this._needsBeforeAndAfter=1)}}_SaveLastKeyframeDataItemToJson(){return this._trackDataItem.GetKeyframeData().GetKeyframeDataItemIndex(this._lastKeyframeDataItem)}_SavePropertyTracksToJson(){return this._propertyTracks.map(e=>e._SaveToJson())}_LoadPropertyTracksFromJson(e){e.forEach((e,t)=>{this._propertyTracks[t]._LoadFromJson(e)})}_LoadInstanceFromJson(e){if(!By.IsFiniteNumber(e))return;const t=this.GetRuntime().GetInstanceByUID(e);t&&this.GetTimeline().SetTrackInstance(this._trackDataItem.GetId(),t,this.GetTrackIndexInTimeline())}_LoadLastKeyframeDataItemFromJson(e){const t=this._trackDataItem.GetKeyframeData();this._lastKeyframeDataItem=t.GetKeyframeDataItemFromIndex(e)}}}{const Uy=self.C3;Uy.PropertyTrackState=class extends Uy.DefendedBase{constructor(e,t){super(),this._track=e,this._propertyTrackDataItem=t,this._propertyTrackData=t.GetPropertyTrackData(),this._worldInfoChange=0,this._renderChange=0,this._needsBeforeAndAfter=0,this._sourceAdapter=this.GetSourceAdapter(),this._propertyKeyframeDataItems=this._propertyTrackDataItem.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray(),this._lastPropertyKeyframeDataItem=null,this._absoluteValueObject=null}static Create(e,t){return Uy.New(Uy.PropertyTrackState,e,t)}Release(){this._track=null,this._sourceAdapter&&(this._sourceAdapter.Release(),this._sourceAdapter=null),this._propertyKeyframeDataItems=null,this._propertyTrackDataItem=null,this._propertyTrackData=null}GetWorldInfoChange(){return this._worldInfoChange}GetRenderChange(){return this._renderChange}GetNeedsBeforeAndAfter(){return this._needsBeforeAndAfter}HasAbsoluteValueObject(){return!!this._absoluteValueObject}SetAbsoluteValueObject(e){this._absoluteValueObject=e}GetAbsoluteValueObject(){return this._absoluteValueObject}GetTrack(){return this._track}GetPropertyTrackDataItem(){return this._propertyTrackDataItem}GetPropertyTrackData(){return this._propertyTrackData}GetTimeline(){return this._track.GetTimeline()}GetRuntime(){return this._track.GetRuntime()}GetInstance(){return this._track.GetInstance()}GetSourceAdapter(){if(this._sourceAdapter)return this._sourceAdapter;let e;switch(this._propertyTrackDataItem.GetSourceAdapterId()){case"behavior":e=new Uy.PropertyTrackState.BehaviorSourceAdapter(this);break;case"effect":e=new Uy.PropertyTrackState.EffectSourceAdapter(this),this._renderChange=1;break;case"instance-variable":e=new Uy.PropertyTrackState.InstanceVariableSourceAdapter(this);break;case"plugin":e=new Uy.PropertyTrackState.PluginSourceAdapter(this),this._renderChange=1;break;case"world-instance":e=new Uy.PropertyTrackState.PropertySourceAdapter(this),this._renderChange=1,this._worldInfoChange=1;break;case"value":e=new Uy.PropertyTrackState.ValueSourceAdapter(this);break;case"audio":e=new Uy.PropertyTrackState.AudioSourceAdapter(this)}return this._sourceAdapter=e,this._sourceAdapter}GetSourceAdapterId(){return this._propertyTrackDataItem.GetSourceAdapterId()}SetSourceAdapterId(e){this._propertyTrackDataItem.SetSourceAdapterId(e)}GetSourceAdapterArgs(){return this._propertyTrackDataItem.GetSourceAdapterArguments()}SetSourceAdapterArgs(e){this._propertyTrackDataItem.SetSourceAdapterArguments(e)}GetSourceAdapterValue(){return this.GetSourceAdapter().GetValue()}GetPropertyName(){return this._propertyTrackDataItem.GetProperty()}SetPropertyName(e){this._propertyTrackDataItem.SetProperty(e)}GetPropertyType(){return this._propertyTrackDataItem.GetType()}SetPropertyType(e){this._propertyTrackDataItem.SetType(e)}GetPropertyKeyframeType(){return this.GetPropertyTrackData().GetFirstPropertyKeyframeDataItem(this._propertyTrackDataItem).GetType()}GetMin(){return this._propertyTrackDataItem.GetMin()}SetMin(e){this._propertyTrackDataItem.SetMin(e)}GetMax(){return this._propertyTrackDataItem.GetMax()}SetMax(e){this._propertyTrackDataItem.SetMax(e)}GetEnable(){return this._propertyTrackDataItem.GetEnable()}SetEnable(e){this._propertyTrackDataItem.SetEnable(e)}GetInterpolationMode(){return this._propertyTrackDataItem.GetInterpolationMode()}SetInterpolationMode(e){this._propertyTrackDataItem.SetInterpolationMode(e)}GetResultMode(){return this._propertyTrackDataItem.GetResultMode()}SetResultMode(e){this._propertyTrackDataItem.SetResultMode(e)}SetEase(e){for(const t of this.GetPropertyKeyframeDataItems())t.SetEase(e)}CanHavePropertyKeyframes(){return this._propertyTrackDataItem.CanHavePropertyKeyframes()}GetPropertyKeyframeDataItems(){return this._propertyKeyframeDataItems||(this._propertyKeyframeDataItems=this._propertyTrackDataItem.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray()),this._propertyKeyframeDataItems}GetPropertyKeyframeDataItemArrayIncludingDisabled(){return this._propertyTrackDataItem.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArrayIncludingDisabled()}GetPropertyKeyFrameDataItemAtTime(e){return this._propertyTrackData.GetPropertyKeyFrameDataItemAtTime(e,this._propertyTrackDataItem)}GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e){return this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem)}GetPropertyKeyframeDataItemPairForTime(e){let t,s=this._propertyTrackData.GetPropertyKeyFrameDataItemAtTime(e,this._propertyTrackDataItem);return s?t=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemHigherThan(e,this._propertyTrackDataItem):(s=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem),t=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemHigherOrEqualThan(e,this._propertyTrackDataItem)),{start:s,end:t}}*GetPropertyKeyframeValues(){for(const e of this.GetPropertyKeyframeDataItems())yield e.GetValueWithResultMode()}*GetPropertyKeyframeTimes(){for(const e of this.GetPropertyKeyframeDataItems())yield e.GetTime()}TimelineRemoved(){this.GetSourceAdapter().TimelineRemoved()}CleanCaches(){this.GetSourceAdapter().CleanCaches()}GetCurrentState(){return this.GetSourceAdapter().GetCurrentState()}SetResetState(){this.GetSourceAdapter().SetResetState()}SetInitialState(e){this.GetSourceAdapter().SetInitialState(),this._lastPropertyKeyframeDataItem=this._GetLastPropertyKeyFrameBeforeTime(e),this._SetUpdateState()}SetResumeState(e){this.GetSourceAdapter().SetResumeState(),this._lastPropertyKeyframeDataItem=this._GetLastPropertyKeyFrameBeforeTime(e)}_SetUpdateState(){const e=this.GetTrack();if(this._needsBeforeAndAfter=0,e.IsInstanceTrack()){const t=this.GetTimeline(),s=e.GetInstance(),i=this.GetSourceAdapter(),r=this.GetPropertyName();if(i.MayNeedBeforeAndAfterInterpolate()){const e=t.GetSimilarPropertyTracks(s,i,r,this);e&&e.length&&(this._needsBeforeAndAfter=1)}else this._needsBeforeAndAfter=0}}_GetLastPropertyKeyFrameBeforeTime(e){const t=this.GetTimeline();return this._propertyTrackData.GetPropertyKeyFrameDataItemAtTime(e,this._propertyTrackDataItem)||(t.IsForwardPlayBack()?this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem):this._propertyTrackData.GetFirstPropertyKeyFrameDataItemHigherOrEqualThan(e,this._propertyTrackDataItem))}BeforeInterpolate(){this._sourceAdapter.BeforeInterpolate()}Interpolate(e,t=!1,s=!1,i=!1){let r,n,a=!1;if(t)r=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem);else{if(this._lastPropertyKeyframeDataItem){const t=this.GetTimeline(),s=this._lastPropertyKeyframeDataItem.GetNext(),i=this._lastPropertyKeyframeDataItem.GetTime(),r=s?s.GetTime():t.GetTotalTime();(e<=i||e>=r)&&(this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem),a=!0)}else this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem),a=!0;r=this._lastPropertyKeyframeDataItem}r&&(n=r.GetNext()),this._sourceAdapter.Interpolate(e,r,n,t,s,i,a)}GetInterpolatedValue(e){if(this._lastPropertyKeyframeDataItem){const t=this.GetTimeline(),s=this._lastPropertyKeyframeDataItem.GetNext(),i=this._lastPropertyKeyframeDataItem.GetTime(),r=s?s.GetTime():t.GetTotalTime();(e<=i||e>=r)&&(this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem))}else this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem);const t=this._lastPropertyKeyframeDataItem,s=t.GetNext();return this._sourceAdapter.GetInterpolatedValue(e,t,s)}GetInterpolatedValueFast(e,t,s){return this._sourceAdapter.GetInterpolatedValue(e,t,s)}AfterInterpolate(){this._sourceAdapter.AfterInterpolate()}static GetStartPropertyKeyframeForTime(e,t){const s=t.GetPropertyTrackDataItem();return t._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,s)}static GetEndPropertyKeyframeForTime(e,t){const s=t.GetPropertyTrackDataItem();return t._propertyTrackData.GetFirstPropertyKeyFrameDataItemHigherOrEqualThan(e,s)}AddPropertyKeyframe(){const e=this._propertyTrackDataItem.GetPropertyKeyframeData().AddEmptyPropertyKeyframeDataItem();return this._lastPropertyKeyframeDataItem=null,e}DeletePropertyKeyframes(e){this._lastPropertyKeyframeDataItem=null,this._propertyTrackDataItem.GetPropertyKeyframeData().DeletePropertyKeyframeDataItems(e)}SaveState(){this.GetSourceAdapter().SaveState()}CompareInitialStateWithCurrent(){if(this.GetSourceAdapter().CompareInitialStateWithCurrent()){const e=this._propertyTrackData.GetFirstPropertyKeyframeDataItem(this._propertyTrackDataItem),t=this.GetSourceAdapter().GetCurrentState();e.SetAbsoluteValue(t)}}CompareSaveStateWithCurrent(){const e=this.GetSourceAdapter().CompareSaveStateWithCurrent();return e&&this.AddPropertyKeyframeAtCurrentTime(),this.GetSourceAdapter().ClearSaveState(),e}AddPropertyKeyframeAtCurrentTime(){const e=this.GetTimeline().GetTime(),t=this.GetSourceAdapter(),s=Uy.PropertyTrackState.GetStartPropertyKeyframeForTime(e,this),i=this.AddPropertyKeyframe();i.SetType(s.GetType()),i.SetTime(e),i.SetEase(s.GetEase()),i.SetEnable(!0),i.SetValue(t.GetValueAtTime()),i.SetAbsoluteValue(t.GetCurrentState())}_SaveToJson(){return{sourceAdapterJson:this.GetSourceAdapter()._SaveToJson()}}_LoadFromJson(e){e&&this.GetSourceAdapter()._LoadFromJson(e.sourceAdapterJson)}}}{const Wy=self.C3,Hy=Wy.PropertyTrackState;Hy.PropertySourceAdapter=class{constructor(e){this._propertyTrack=e,this._propertyAdapter=null,this.GetPropertyAdapter()}Release(){this._propertyAdapter&&(this._propertyAdapter.Release(),this._propertyAdapter=null),this._propertyTrack=null}MayNeedBeforeAndAfterInterpolate(){return this._propertyAdapter.MayNeedBeforeAndAfterInterpolate()}GetPropertyTrack(){return this._propertyTrack}TimelineRemoved(){this._propertyAdapter&&this._propertyAdapter.TimelineRemoved()}CleanCaches(){this._propertyAdapter&&this._propertyAdapter.CleanCaches()}GetPropertyAdapter(){return this._propertyAdapter||(this._propertyAdapter=this._CreatePropertyAdapter()),this._propertyAdapter}GetEditorIndex(){}GetIndex(){return this.GetEditorIndex()}GetTarget(){}SetResetState(){this.GetPropertyAdapter().SetResetState()}SetInitialState(){this.GetPropertyAdapter().SetInitialState()}SetResumeState(){this.GetPropertyAdapter().SetResumeState()}BeforeInterpolate(){this._propertyAdapter.BeforeChangeProperty()}Interpolate(e,t,s,i,r,n,a){let o;switch(this._propertyTrack.GetPropertyKeyframeType()){case"numeric":o=Hy.NumericTypeAdapter.Interpolate(e,t,s,this._propertyTrack);break;case"angle":o=Hy.AngleTypeAdapter.Interpolate(e,t,s,this._propertyTrack);break;case"boolean":o=Hy.BooleanTypeAdapter.Interpolate(e,t,s,this._propertyTrack);break;case"color":o=Hy.ColorTypeAdapter.Interpolate(e,t,s,this._propertyTrack);break;case"text":o=Hy.TextTypeAdapter.Interpolate(e,t,s,this._propertyTrack)}this._propertyAdapter.ChangeProperty(e,o,t,s,i,r,n,a)}GetInterpolatedValue(e,t,s){switch(this._propertyTrack.GetPropertyKeyframeType()){case"numeric":return Hy.NumericTypeAdapter.Interpolate(e,t,s,this._propertyTrack);case"angle":return Hy.AngleTypeAdapter.Interpolate(e,t,s,this._propertyTrack);case"boolean":return Hy.BooleanTypeAdapter.Interpolate(e,t,s,this._propertyTrack);case"color":return Hy.ColorTypeAdapter.Interpolate(e,t,s,this._propertyTrack);case"text":return Hy.TextTypeAdapter.Interpolate(e,t,s,this._propertyTrack)}}AfterInterpolate(){this._propertyAdapter.AfterChangeProperty()}SaveState(){this.GetPropertyAdapter().SetSaveState()}ClearSaveState(){this.GetPropertyAdapter().ClearSaveState()}GetCurrentState(){return this.GetPropertyAdapter().GetCurrentState()}CompareInitialStateWithCurrent(){return this.GetPropertyAdapter().CompareInitialStateWithCurrent()}CompareSaveStateWithCurrent(){return this.GetPropertyAdapter().CompareSaveStateWithCurrent()}GetValueAtTime(){const e=this._propertyTrack,t=e.GetTrack().GetTimeline().GetTime(),s=Hy.GetStartPropertyKeyframeForTime(t,e),i=s.GetNext();switch(e.GetPropertyKeyframeType()){case"numeric":return Hy.NumericTypeAdapter.Interpolate(t,s,i,e);case"angle":return Hy.AngleTypeAdapter.Interpolate(t,s,i,e);case"boolean":return Hy.BooleanTypeAdapter.Interpolate(t,s,i,e);case"color":return Hy.ColorTypeAdapter.Interpolate(t,s,i,e);case"text":return Hy.TextTypeAdapter.Interpolate(t,s,i,e)}}_CreatePropertyAdapter(){const e=this._propertyTrack;switch(e.CanHavePropertyKeyframes()?e.GetPropertyKeyframeType():""){case"combo":case"boolean":case"text":case"string":return new Hy.PropertyInterpolationAdapter.NoInterpolationAdapter(this);case"numeric":case"number":case"angle":return"combo"===this._propertyTrack.GetPropertyType()?new Hy.PropertyInterpolationAdapter.NoInterpolationAdapter(this):new Hy.PropertyInterpolationAdapter.NumericInterpolationAdapter(this);case"color":case"offsetColor":return new Hy.PropertyInterpolationAdapter.ColorInterpolationAdapter(this);default:return new Hy.PropertyInterpolationAdapter.NumericInterpolationAdapter(this)}}_SaveToJson(){return{propertyAdapterJson:this.GetPropertyAdapter()._SaveToJson()}}_LoadFromJson(e){e&&this.GetPropertyAdapter()._LoadFromJson(e.propertyAdapterJson)}}}{const zy=self.C3,jy=0;class Yy extends zy.PropertyTrackState.PropertySourceAdapter{constructor(e){super(e),this._updatedIndex=NaN}GetEditorIndex(){return this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[0]}GetIndex(){return this._updatedIndex?this._updatedIndex:super.GetIndex()}GetTarget(){return this._propertyTrack.GetTrack().GetInstance()}UpdateInstanceVariableIndex(e){this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[0]!==e&&(this._updatedIndex=e)}Interpolate(e,t,s,i,r,n,a){this.GetPropertyAdapter().CanChange(t.GetValue())&&super.Interpolate(e,t,s,i,r,n,a)}GetInterpolatedValue(e,t,s){if(this.GetPropertyAdapter().CanChange(t.GetValue()))return super.GetInterpolatedValue(e,t,s)}_SaveToJson(){return Object.assign(super._SaveToJson(),{index:this._updatedIndex})}_LoadFromJson(e){e&&(super._LoadFromJson(e),this._updatedIndex=e.index)}}zy.PropertyTrackState.InstanceVariableSourceAdapter=Yy}{const qy=self.C3,Xy=0,$y=1,Ky=2;class Jy extends qy.PropertyTrackState.PropertySourceAdapter{constructor(e){super(e),this._sid=NaN}GetEditorIndex(){return this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[1]}GetTarget(){const e=this._propertyTrack.GetPropertyTrackDataItem(),t=this._propertyTrack.GetTrack(),s=this._sid?this._sid:e.GetSourceAdapterArguments()[0],i=t.GetInstance(),r=i.GetBehaviorIndexBySID(s);return i.GetBehaviorInstances()[r].GetSdkInstance()}GetBehaviorType(e){const t=this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[2];return e.GetBehaviorTypeByName(t)}UpdateBehaviorTypeSid(e){this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[0]!==e&&(this._sid=e)}Interpolate(e,t,s,i,r,n,a){const o=this._propertyTrack.GetTrack().GetInstance();this.GetBehaviorType(o.GetObjectClass())&&super.Interpolate(e,t,s,i,r,n,a)}GetInterpolatedValue(e,t,s){const i=this._propertyTrack.GetTrack().GetInstance();if(this.GetBehaviorType(i.GetObjectClass()))return super.GetInterpolatedValue(e,t,s)}_SaveToJson(){return Object.assign(super._SaveToJson(),{sid:this._sid})}_LoadFromJson(e){e&&(super._LoadFromJson(e),this._sid=e.sid)}}qy.PropertyTrackState.BehaviorSourceAdapter=Jy}{const Qy=self.C3,Zy=0,eS=1;class tS extends Qy.PropertyTrackState.PropertySourceAdapter{constructor(e){super(e)}GetEditorIndex(){return this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[1]}GetTarget(){const e=this._propertyTrack.GetTrack().GetWorldInfo().GetInstanceEffectList(),t=e.GetEffectList(),s=this.GetEffectType(t).GetIndex();return e.IsEffectIndexActive(s)?e.GetEffectParametersForIndex(s):null}GetEffectType(e){const t=this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[0];return e.GetEffectTypeByName(t)}Interpolate(e,t,s,i,r,n,a){this._IsEffectActive()&&super.Interpolate(e,t,s,i,r,n,a)}GetInterpolatedValue(e,t,s){if(this._IsEffectActive())return super.GetInterpolatedValue(e,t,s)}_IsEffectActive(){const e=this._propertyTrack.GetTrack().GetWorldInfo().GetInstanceEffectList(),t=e.GetEffectList(),s=this.GetEffectType(t);if(!s)return;const i=s.GetIndex();return e.IsEffectIndexActive(i)}}Qy.PropertyTrackState.EffectSourceAdapter=tS}{const sS=self.C3,iS=0;class rS extends sS.PropertyTrackState.PropertySourceAdapter{constructor(e){super(e)}GetEditorIndex(){return this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[0]}GetTarget(){return this._propertyTrack.GetTrack().GetInstance().GetSdkInstance()}Interpolate(e,t,s,i,r,n,a){const o=this._propertyTrack.GetTrack();o.GetObjectClass().GetPlugin()===o.GetInstance().GetObjectClass().GetPlugin()&&super.Interpolate(e,t,s,i,r,n,a)}GetInterpolatedValue(e,t,s){const i=this._propertyTrack.GetTrack();if(i.GetObjectClass().GetPlugin()===i.GetInstance().GetObjectClass().GetPlugin())return super.GetInterpolatedValue(e,t,s)}GetOptionalCallbacks(){const e=this._propertyTrack.GetTrack(),t=e.GetObjectClass().GetPlugin();if(sS.Plugins.Sprite&&t instanceof sS.Plugins.Sprite&&("initial-frame"===this._propertyTrack.GetPropertyName()||"initial-animation"===this._propertyTrack.GetPropertyName()))switch(this._propertyTrack.GetResultMode()){case"relative":return{onFrameChange:(t,s,i,r,n)=>{if(s!==r){const i=r/s,n=e.GetPropertyTrack("offsetWidth"),a=e.GetPropertyTrack("offsetScaleX");if(n||a){const o=n?.GetSourceAdapter()?.GetPropertyAdapter(),l=a?.GetSourceAdapter()?.GetPropertyAdapter();if(t.HasParent()&&t.GetTransformWithParentWidth())l&&l.SetOriginalSizeProperty(r),t.SetWidth(this.GetNewWidth(r,s,t,e,o,l));else{const s=r*((t._GetSceneGraphInfo()?._GetStartWidth()??this.GetInstanceOriginalWidth(t,e))/this.GetInstanceOriginalWidth(t,e));l&&l.SetOriginalSizeProperty(r);const n=o?.GetChangeAccumulatorProperty()??0,a=l?.GetChangeAccumulatorProperty()??0;t.SetWidth(s+(n+a*i))}}else t.SetWidth(t.GetWidth()*i)}if(i!==n){const s=n/i,r=e.GetPropertyTrack("offsetHeight"),a=e.GetPropertyTrack("offsetScaleY");if(r||a){const o=r?.GetSourceAdapter()?.GetPropertyAdapter(),l=a?.GetSourceAdapter()?.GetPropertyAdapter();if(t.HasParent()&&t.GetTransformWithParentHeight())l&&l.SetOriginalSizeProperty(n),t.SetHeight(this.GetNewHeight(n,i,t,e,o,l));else{const i=n*((t._GetSceneGraphInfo()?._GetStartHeight()??this.GetInstanceOriginalHeight(t,e))/this.GetInstanceOriginalHeight(t,e));l&&l.SetOriginalSizeProperty(n);const r=o?.GetChangeAccumulatorProperty()??0,a=l?.GetChangeAccumulatorProperty()??0;t.SetHeight(i+(r+a*s))}}else t.SetHeight(t.GetHeight()*s)}}};case"absolute":return null}}GetLastPropertyKeyframeValue(e,t,s,i=0){const r=t.GetTimeline().GetTrackFromInstance(e.GetInstance());if(!r)return i;const n=r.GetPropertyTrack(s);if(!n)return i;const a=n.GetPropertyTrackDataItem().GetPropertyKeyframeData();if(!a)return i;const o=a.GetLastPropertyKeyframeDataItem();return o?o.GetValue():i}GetInstanceOriginalWidth(e,t){const s=t.GetTimeline().GetTrackFromInstance(e.GetInstance());if(s)return s.GetOriginalWidth();const i=e.GetInstance().GetSdkInstance();return i.IsOriginalSizeKnown()?i.GetOriginalWidth():e._GetSceneGraphInfo()._GetStartWidth()}GetInstanceOriginalHeight(e,t){const s=t.GetTimeline().GetTrackFromInstance(e.GetInstance());if(s)return s.GetOriginalHeight();const i=e.GetInstance().GetSdkInstance();return i.IsOriginalSizeKnown()?i.GetOriginalHeight():e._GetSceneGraphInfo()._GetStartHeight()}GetNewWidth(e,t,s,i,r,n){const a=s._GetSceneGraphInfo()._GetStartWidth(),o=a/s.GetParent()._GetSceneGraphInfo()._GetStartWidth();let l=1;const h=n?.GetAbsoluteScaleXOffsetProperty()??0;if(0!==h){const e=a/this.GetInstanceOriginalWidth(s,i);l=(e+h)/(0===e?Number.EPSILON:e)}const u=a*(e/t);let c=r?.GetAbsoluteWidthOffsetProperty()??0;c+=u-a;const d=(a+c)/(0===a?Number.EPSILON:a);return s.GetParent().GetWidth()*o*l*d}GetNewHeight(e,t,s,i,r,n){const a=s._GetSceneGraphInfo()._GetStartHeight(),o=a/s.GetParent()._GetSceneGraphInfo()._GetStartHeight();let l=1;const h=n?.GetAbsoluteScaleYOffsetProperty()??0;if(0!==h){const e=a/this.GetInstanceOriginalHeight(s,i);l=(e+h)/(0===e?Number.EPSILON:e)}const u=a*(e/t);let c=r?.GetAbsoluteHeightOffsetProperty()??0;c+=u-a;const d=(a+c)/(0===a?Number.EPSILON:a);return s.GetParent().GetHeight()*o*l*d}}sS.PropertyTrackState.PluginSourceAdapter=rS}{const nS=self.C3;class aS extends nS.PropertyTrackState.PropertySourceAdapter{constructor(e){super(e),this._value=0,this._init=!1}MayNeedBeforeAndAfterInterpolate(){return!1}SetInitialState(){const e=this._propertyTrack.GetPropertyTrackData();let t=this._propertyTrack.GetPropertyTrackDataItem();t=e.GetFirstPropertyKeyframeDataItem(t),this._value=t.GetValueWithResultMode()}SetResumeState(){}GetValue(){return this._init||this._propertyTrack.Interpolate(0),this._value}Interpolate(e,t,s,i,r,n,a){this._value=nS.PropertyTrackState.NumericTypeAdapter.Interpolate(e,t,s,this._propertyTrack),this._init=!0}SaveState(){}ClearSaveState(){}GetCurrentState(){return this._value}CompareInitialStateWithCurrent(){return!1}CompareSaveStateWithCurrent(){return!1}_SaveToJson(){return{value:this._value,init:this._init}}_LoadFromJson(e){e&&(this._value=e.value,this._init=!e.hasOwnProperty("init")||e.init)}}nS.PropertyTrackState.ValueSourceAdapter=aS}{const oS=self.C3,lS=0,hS=0,uS=1,cS=1,dS=2,pS=3;class _S extends oS.PropertyTrackState.PropertySourceAdapter{constructor(e){super(e),this._audioPlaybackStarted=!1,this._sdkInstance=null,this._actions=null,this._expressions=null,this._timeline=this._propertyTrack.GetTimeline(),this._track=this._propertyTrack.GetTrack(),this._sourceAdapterArgs=this._propertyTrack.GetSourceAdapterArgs(),this._fileArgs=this._sourceAdapterArgs[0],this._startOffsetTime=this._sourceAdapterArgs[1],this._sourceAdapterArgs[3]?this._audioTag=this._sourceAdapterArgs[3]:this._audioTag=Math.random().toString(36).slice(2),this._pauseTime=NaN,this._pauseVolume=NaN,this._volume=NaN,this._audioSource=null,this._Initialize()}Release(){super.Release(),this._sdkInstance=null,this._actions=null,this._expressions=null,this._timeline=null,this._track=null,this._sourceAdapterArgs=null,this._fileArgs=null,this._audioSource=null}_Initialize(){if(!self.C3.Plugins.Audio)return;const e=this._propertyTrack.GetRuntime().GetSingleGlobalObjectClassByCtor(self.C3.Plugins.Audio);e&&(this._sdkInstance=e.GetSingleGlobalInstance().GetSdkInstance()),this._actions=self.C3.Plugins.Audio.Acts,this._expressions=self.C3.Plugins.Audio.Exps}_MaybeSetAudioSource(){if(this._audioSource)return;const e=this._propertyTrack.GetTrack().GetPropertyTrack("audioSource");e&&(this._audioSource=e.GetSourceAdapter())}_GetPauseVolume(){const e=this._propertyTrack.GetTrack().GetPropertyTrack("volume");return e?e.GetSourceAdapter()._pauseVolume:this._pauseVolume}TimelineRemoved(){super.TimelineRemoved(),this._audioPlaybackStarted=!1,this._sdkInstance&&(this._expressions&&(this._pauseTime=this._expressions.PlaybackTime.call(this._sdkInstance,this._audioTag),this._pauseVolume=this._expressions.Volume.call(this._sdkInstance,this._audioTag)),this._actions&&this._actions.Stop.call(this._sdkInstance,this._audioTag))}GetAudioTag(){return this._audioTag}GetVolume(){return this._volume}SetVolume(e){this._volume=e}SetInitialState(){super.SetInitialState(),this._pauseTime=NaN,this._audioPlaybackStarted=!1}SetResumeState(){super.SetResumeState();const e=this._propertyTrack.GetTimeline().GetTime();switch(this._pauseTime=e-this._startOffsetTime,this._propertyTrack.GetPropertyName()){case"audioSource":break;case"volume":this._pauseVolume=this._propertyTrack.GetInterpolatedValue(e)}this._audioPlaybackStarted=!1}Interpolate(e,t,s,i,r,n,a){if(this._sdkInstance)switch(this._propertyTrack.GetPropertyName()){case"audioSource":{if(!this._timeline.IsForwardPlayBack())return;if(i)return void(this._actions&&this._actions.Stop.call(this._sdkInstance,this._audioTag));if(e<this._startOffsetTime)return void(this._audioPlaybackStarted=!1);const t=this._expressions.PlaybackRate.call(this._sdkInstance,this._audioTag),s=this._timeline.GetPlaybackRate();if(s!==t&&this._actions.SetPlaybackRate.call(this._sdkInstance,this._audioTag,s),this._audioPlaybackStarted)return;if(!this._propertyTrack.GetTimeline().IsPlaying())return;if(this._audioPlaybackStarted=!0,isNaN(this._pauseTime)){const t=self.performance.now(),s=e-this._startOffsetTime;if("suspended"===this._sdkInstance.GetAudioContextState())return void(this._audioPlaybackStarted=!1);const i=s+(self.performance.now()-t)/1e3;if(this._actions){let e=this.GetVolume();isNaN(e)?(this.SetVolume(0),e=0):this.SetVolume(e),this._actions.PlayFromTimeline.call(this._sdkInstance,this._fileArgs,e,this._audioTag,i)}}else{const e=this._pauseTime;this._pauseTime=NaN;const t=this._GetPauseVolume();if(this._pauseVolume=NaN,"suspended"===this._sdkInstance.GetAudioContextState())return void(this._audioPlaybackStarted=!1);this._actions&&(this.SetVolume(t),this._actions.PlayFromTimeline.call(this._sdkInstance,this._fileArgs,t,this._audioTag,e))}break}case"volume":this._MaybeSetAudioSource(),super.Interpolate(e,t,s,i,r,n,a)}}GetInterpolatedValue(e,t,s){if(this._sdkInstance)switch(this._propertyTrack.GetPropertyName()){case"audioSource":return;case"volume":return this._MaybeSetAudioSource(),super.GetInterpolatedValue(e,t,s)}}Getter(e,t){return this._audioSource?this._audioSource.GetVolume():0}Setter(e,t,s,i){this._audioSource&&this._audioSource.SetVolume(this.Getter()+t),this._actions&&this._audioSource&&this._actions.SetVolume.call(this._sdkInstance,this._audioSource.GetAudioTag(),this._audioSource.GetVolume())}AbsoluteSetter(e,t,s){this._audioSource&&this._audioSource.SetVolume(t),this._actions&&this._audioSource&&this._actions.SetVolume.call(this._sdkInstance,this._audioSource.GetAudioTag(),this._audioSource.GetVolume())}DoesRounding(){return!0}_SaveToJson(){return{audioPlaybackStarted:this._audioPlaybackStarted,audioTag:this._audioTag,pauseTime:this._pauseTime,pauseVolume:this._pauseVolume,volume:this._volume}}_LoadFromJson(e){e&&(this._audioPlaybackStarted=e.audioPlaybackStarted,this._audioTag=e.audioTag,this._pauseTime=e.pauseTime,this._pauseVolume=e.pauseVolume,this._volume=e.volume,this._Initialize())}}oS.PropertyTrackState.AudioSourceAdapter=_S}{const mS=self.C3;mS.PropertyTrackState.PropertyInterpolationAdapter=class{constructor(e){this._sourceAdapter=e,this._propertyTrack=e.GetPropertyTrack(),this._worldInfo=this._propertyTrack.GetTrack().GetWorldInfo(),this._property=this._propertyTrack.GetPropertyName(),this._firstAbsoluteUpdate=!1,this._saveState=null,this._target=null}Release(){this._sourceAdapter=null,this._propertyTrack=null,this._worldInfo=null,this._saveState=null,this._target=null}MayNeedBeforeAndAfterInterpolate(){return!1}TimelineRemoved(){}CleanCaches(){this._worldInfo=null,this._saveState=null,this._target=null}GetSourceAdapter(){return this._sourceAdapter}GetPropertyTrack(){return this._propertyTrack}GetWorldInfo(){return this._worldInfo||(this._worldInfo=this._propertyTrack.GetTrack().GetWorldInfo()),this._worldInfo}SetFirstAbsoluteUpdate(e){this._firstAbsoluteUpdate=!!e}GetFirstAbsoluteUpdate(){return this._firstAbsoluteUpdate}SetResetState(){}SetInitialState(){}SetResumeState(){}SetSaveState(){this._saveState=this.GetCurrentState()}ClearSaveState(){this._saveState=null}GetCurrentState(){}CompareInitialStateWithCurrent(){}CompareSaveStateWithCurrent(){}CanChange(e){return typeof this._Getter()==typeof e}BeforeChangeProperty(){}ChangeProperty(e,t,s,i,r,n,a,o){}AfterChangeProperty(){}_FirstKeyframeGetter(){return this._PickTimelinePlaybackMode(()=>{const e=this._propertyTrack.GetPropertyTrackDataItem();return this._propertyTrack.GetPropertyTrackData().GetFirstPropertyKeyframeDataItem(e)},()=>{const e=this._propertyTrack.GetPropertyTrackDataItem();return this._propertyTrack.GetPropertyTrackData().GetLastPropertyKeyframeDataItem(e)}).GetAbsoluteValue()}_CurrentKeyframeGetter(){const e=this._propertyTrack.GetTimeline().GetTime()-this._propertyTrack.GetTrack().GetStartOffset();return this._PickTimelinePlaybackMode(()=>{const t=this._propertyTrack.GetPropertyTrackDataItem();return this._propertyTrack.GetPropertyTrackData().GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,t)},()=>{const t=this._propertyTrack.GetPropertyTrackDataItem(),s=this._propertyTrack.GetPropertyTrackData();return s.GetFirstPropertyKeyFrameDataItemHigherOrEqualThan(e,t)||s.GetLastPropertyKeyframeDataItem(t)}).GetAbsoluteValue()}_PickTimelinePlaybackMode(e,t){return this._propertyTrack.GetTimeline().IsForwardPlayBack()?e():t()}_PickResultMode(e,t){return"relative"===this._propertyTrack.GetResultMode()?e():t()}_PickFirstAbsoluteUpdate(e,t){return this.GetFirstAbsoluteUpdate()?(this.SetFirstAbsoluteUpdate(!1),e()):t()}_GetAbsoluteInitialValue(e){}_GetIndex(){return this._sourceAdapter.GetIndex()}_GetTarget(){return this._target||(this._target=this._sourceAdapter.GetTarget()),this._target}_PickSource(e,t,s,i,r,n){switch(this._propertyTrack.GetSourceAdapterId()){case"behavior":return e();case"effect":return t();case"instance-variable":return s();case"plugin":return i();case"world-instance":return r();case"audio":return n()}}_SaveToJson(){return{firstAbsoluteUpdate:this._firstAbsoluteUpdate,saveState:this._saveState}}_LoadFromJson(e){e&&(this._firstAbsoluteUpdate=e.firstAbsoluteUpdate,this._saveState=e.saveState)}_GetPropertyKeyframeStubs(e,t=!1){const s=[];for(const i of e){const e=i.GetTrack().GetStartOffset();for(const r of i.GetPropertyKeyframeDataItems())t&&0===r.GetTime()?s.push({time:e+r.GetTime(),value:r.GetAbsoluteValue()}):t||s.push({time:e+r.GetTime(),value:r.GetAbsoluteValue()})}return s.sort((e,t)=>e.time-t.time)}_GetLastPropertyKeyframeStub(e,t,s){return this._GetPropertyKeyframeStubLowerThanPlayhead(t,s)}_GetPropertyKeyframeStubLowerThanPlayhead(e,t){for(let s=t.length-1;s>=0;s--)if(t[s].time<=e)return t[s];return null}}}{const fS=self.C3,gS=new Map,yS=[0,0,0];class SS extends fS.PropertyTrackState.PropertyInterpolationAdapter{constructor(e){super(e)}SetResetState(){}SetInitialState(){}SetResumeState(){}GetCurrentState(){const e=this._propertyTrack.GetSourceAdapterId(),t=this._GetTarget(),s=this._GetIndex();switch(e){case"behavior":case"plugin":return this._ToColorArray(t.GetPropertyValueByIndex(s));case"effect":return this._ToColorArray(t[s]);case"world-instance":return this._ToColorArray(this._Getter())}}CompareInitialStateWithCurrent(){const e=this._FirstKeyframeGetter();return!this._CompareColors(e,this._Getter())}CompareSaveStateWithCurrent(){return!fS.IsNullOrUndefined(this._saveState)&&!this._CompareColors(this._saveState,this._Getter())}_CompareColors(e,t){return e=this._GetColorFromArray(e),t=this._GetColorFromArray(t),e.equalsIgnoringAlpha(t)}_FirstKeyframeGetter(){const e=super._FirstKeyframeGetter();return this._GetColorFromArray(e)}_CurrentKeyframeGetter(){const e=super._CurrentKeyframeGetter();return this._GetColorFromArray(e)}_GetAbsoluteInitialValue(e){}_ToColorArray(e){return fS.IsInstanceOf(e,fS.Color)?e.toArray().slice(0,3):e.slice(0,3)}_GetColorFromArray(e){return fS.IsInstanceOf(e,fS.Color)?e:new fS.Color(e[0],e[1],e[2],1)}CanChange(e){return!0}MayNeedBeforeAndAfterInterpolate(){return!0}BeforeChangeProperty(){const e=this._propertyTrack.GetTimeline(),t=this._propertyTrack.GetInstance(),s=this._propertyTrack.GetSourceAdapter(),i=e.GetSimilarPropertyTracks(t,s,this._property,this._propertyTrack);if(i&&i.length>1){gS.has(t)||gS.set(t,new Map);const e=gS.get(t),s=this._propertyTrack.GetSourceAdapterId();e.has(s)||e.set(s,new Map);const i=e.get(s);i.has(this._property)||i.set(this._property,{used:!1,color:new fS.Color(0,0,0,1)})}}_GetTmpColor(e,t,s){const i=gS.get(e).get(t).get(s);return i.used=!0,i.color}ChangeProperty(e,t,s,i,r,n,a,o){const l=this._propertyTrack.GetTimeline(),h=this._propertyTrack.GetTrack(),u=this._propertyTrack.GetInstance(),c=this._propertyTrack.GetSourceAdapter(),d=this._propertyTrack.GetSourceAdapterId(),p=this._property,_=l.GetSimilarPropertyTracks(u,c,p,this._propertyTrack);if(_&&_.length>1){const e=this._GetPropertyKeyframeStubs(_,!0),s=this._GetLastPropertyKeyframeStub(l,l.GetTime(),e);if(s){const e=h.GetStartOffset(),i=s.time-e;if(0===i)this._GetTmpColor(u,d,this._property).addRgb(t[0],t[1],t[2]);else{if(i<0)return;const e=t[0],s=t[1],r=t[2],n=this._propertyTrack.Interpolate(i,!1,!0),a=fS.Color.DiffChannel(e,n[0]),o=fS.Color.DiffChannel(s,n[1]),l=fS.Color.DiffChannel(r,n[2]);this._GetTmpColor(u,d,this._property).addRgb(a,o,l)}}}else this._Setter(t[0],t[1],t[2])}AfterChangeProperty(){const e=this._propertyTrack.GetInstance();if(!gS.has(e))return;const t=gS.get(e),s=this._propertyTrack.GetSourceAdapterId();if(!t.has(s))return;const i=t.get(s);if(!i.has(this._property))return;const r=i.get(this._property),n=r.used,a=r.color;n&&this._Setter(a.getR(),a.getG(),a.getB()),0===i.size&&t.delete(s),0===t.size&&gS.delete(e)}_Getter(){const e=this._propertyTrack.GetSourceAdapterId(),t=this._GetTarget(),s=this._GetIndex();switch(e){case"behavior":case"plugin":return this._GetColorFromArray(t.GetPropertyValueByIndex(s));case"effect":return t[s].clone();case"world-instance":return this.GetWorldInfo().GetUnpremultipliedColor().clone()}}_Setter(e,t,s){const i=this._propertyTrack.GetSourceAdapterId(),r=this._GetTarget(),n=this._GetIndex();switch(i){case"behavior":case"plugin":yS[0]=e,yS[1]=t,yS[2]=s,r.SetPropertyValueByIndex(n,yS);break;case"effect":r[n].setRgb(e,t,s);break;case"world-instance":this.GetWorldInfo().SetUnpremultipliedColorRGB(e,t,s)}}_SaveToJson(){}_LoadFromJson(e){}}fS.PropertyTrackState.PropertyInterpolationAdapter.ColorInterpolationAdapter=SS}{const TS=self.C3,xS=TS.PropertyTrackState;class bS extends TS.PropertyTrackState.PropertyInterpolationAdapter{constructor(e){super(e)}SetResetState(){}SetInitialState(){}SetResumeState(){}GetCurrentState(){return this._Getter()}CompareInitialStateWithCurrent(){return this._FirstKeyframeGetter()!==this.GetCurrentState()}CompareSaveStateWithCurrent(){return!TS.IsNullOrUndefined(this._saveState)&&this._saveState!==this.GetCurrentState()}MayNeedBeforeAndAfterInterpolate(){return!1}ChangeProperty(e,t,s,i,r,n,a,o){const l=this._propertyTrack,h=l.GetTrack(),u=l.GetSourceAdapterId(),c=l.GetTimeline(),d=h.GetInstance(),p=l.GetSourceAdapter(),_=this._property,m=c.GetSimilarPropertyTracks(d,p,_,l);if(m&&m.length>1){const s=this._GetPropertyKeyframeStubs(m),i=e+h.GetStartOffset(),r=this._GetLastPropertyKeyframeStub(c,i,s);r&&(t=r.value)}switch(l.GetPropertyKeyframeType()){case"numeric":if(!xS.NumericTypeAdapter.WillChange(this._GetIndex(),this._GetTarget(),t,u))return;break;case"angle":if(!xS.AngleTypeAdapter.WillChange(this._GetIndex(),this._GetTarget(),t,u))return;break;case"boolean":if(!xS.BooleanTypeAdapter.WillChange(this._GetIndex(),this._GetTarget(),t,u))return;break;case"color":if(!xS.ColorTypeAdapter.WillChange(this._GetIndex(),this._GetTarget(),t,u))return;break;case"text":if(!xS.TextTypeAdapter.WillChange(this._GetIndex(),this._GetTarget(),t,u))return}this._Setter(t)}_Getter(){const e=this._propertyTrack.GetSourceAdapterId(),t=this._GetTarget(),s=this._GetIndex();switch(e){case"behavior":case"plugin":return t.GetPropertyValueByIndex(s);case"effect":return t[s];case"instance-variable":return t.GetInstanceVariableValue(s)}}_Setter(e){const t=this._propertyTrack.GetSourceAdapterId(),s=this._GetTarget(),i=this._GetIndex();switch(t){case"behavior":case"plugin":s.SetPropertyValueByIndex(i,e);break;case"effect":s[i]=e;break;case"instance-variable":s.SetInstanceVariableValue(i,e)}}}TS.PropertyTrackState.PropertyInterpolationAdapter.NoInterpolationAdapter=bS}{const GS=self.C3,IS=GS.PropertyTrackState.PropertyInterpolationAdapter,vS=new Map,CS=(e,t,s,i,r,n=!1,a=null,o=null)=>{vS.set(e,{setter:t,absolute_setter:s,getter:i,round:r,fRound:n,init:a,reset:o})},wS=(e,t)=>{const s=t.GetTimeline().GetTrackFromInstance(e.GetInstance());if(s)return s.GetOriginalWidth();const i=e.GetInstance().GetSdkInstance();return i.IsOriginalSizeKnown()?i.GetOriginalWidth():e._GetSceneGraphInfo()._GetStartWidth()},AS=(e,t,s,i=0)=>{const r=t.GetTimeline().GetTrackFromInstance(e.GetInstance());if(!r)return i;const n=r.GetPropertyTrack(s);if(!n)return i;const a=n.GetPropertyTrackDataItem().GetPropertyKeyframeData();if(!a)return i;const o=a.GetLastPropertyKeyframeDataItem();return o?o.GetValue():i},RS=e=>{const t=[];let s=e.GetParent();for(;s;)t.push(s),s=s.GetParent();return t.reverse(),t};CS("offsetX",(e,t,s,i)=>{"relative"===i._propertyTrack.GetResultMode()?e.OffsetX(t,s.GetTimeline().GetTransformWithSceneGraph()):e.OffsetX(t)},(e,t)=>e.SetX(t),e=>e.GetX(),!0),CS("offsetY",(e,t,s,i)=>{"relative"===i._propertyTrack.GetResultMode()?e.OffsetY(t,s.GetTimeline().GetTransformWithSceneGraph()):e.OffsetY(t)},(e,t)=>e.SetY(t),e=>e.GetY(),!0),CS("offsetWidth",(e,t,s,i,r=!1,n=!0)=>{if(0===t)return;const a="relative"===i._propertyTrack.GetResultMode(),o=1===i._typeAdapter.GetType();if((a||o)&&e.HasParent()&&e.GetTransformWithParentWidth()){if(isNaN(i._absoluteToFactor)){const t=RS(e);let s;s=o?t[t.length-1].GetWidth():t[t.length-1]._GetSceneGraphInfo()._GetStartWidth(),i._absoluteToFactor=0===s?Number.EPSILON:s}if(r)return;i._absoluteWidthOffset+=t;const s=t/i._absoluteToFactor;e.OffsetWidth(s,n),i._changeAccumulator+=s}else e.OffsetWidth(t),i._changeAccumulator+=t},(e,t)=>e.SetWidth(t),e=>e.GetWidth(),!0,!1,null,e=>{e._changeAccumulator=0,e._absoluteWidthOffset=0}),CS("offsetHeight",(e,t,s,i,r=!1,n=!0)=>{if(0===t)return;const a="relative"===i._propertyTrack.GetResultMode(),o=1===i._typeAdapter.GetType();if((a||o)&&e.HasParent()&&e.GetTransformWithParentHeight()){if(isNaN(i._absoluteToFactor)){const t=RS(e);let s;s=o?t[t.length-1].GetHeight():t[t.length-1]._GetSceneGraphInfo()._GetStartHeight(),i._absoluteToFactor=0===s?Number.EPSILON:s}if(r)return;i._absoluteHeightOffset+=t;const s=t/i._absoluteToFactor;e.OffsetHeight(s,n),i._changeAccumulator+=s}else e.OffsetHeight(t),i._changeAccumulator+=t},(e,t)=>e.SetHeight(t),e=>e.GetHeight(),!0,!1,null,e=>{e._changeAccumulator=0,e._absoluteHeightOffset=0}),CS("offsetAngle",(e,t,s,i,r)=>{e.OffsetAngle(t)},(e,t)=>e.SetAngle(t),e=>e.GetAngle(),!1,!0),CS("offsetOpacity",(e,t,s,i,r)=>{t/=i._opacityFactor?i._opacityFactor:1;const n=e.GetOpacity()+t;if(0===i._clampAccumulator)n>1?i._clampAccumulator+=n-1:n<0&&(i._clampAccumulator+=n),e.OffsetOpacity(t);else{const s=e.GetOpacity()+t;t>0&&i._clampAccumulator>0?s>1&&(i._clampAccumulator+=s-1):t>0&&i._clampAccumulator<0?(i._clampAccumulator+=t,i._clampAccumulator>0&&(e.OffsetOpacity(i._clampAccumulator),i._clampAccumulator=0)):t<0&&i._clampAccumulator>0?(i._clampAccumulator+=t,i._clampAccumulator<0&&(e.OffsetOpacity(i._clampAccumulator),i._clampAccumulator=0)):t<0&&i._clampAccumulator<0&&s<0&&(i._clampAccumulator+=s)}},(e,t)=>{e.SetOpacity(t)},e=>e.GetOpacity(),!1,!0,(e,t,s)=>{switch(e._clampAccumulator=0,e._propertyTrack.GetResultMode()){case"relative":{e._propertyTrack.GetPropertyTrackData();const t=e._propertyTrack.GetPropertyTrackDataItem().GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray();let s=e.GetWorldInfo().GetOpacity(),i=s;for(const r of t){const t=r.GetTime();i=s+e._propertyTrack.GetInterpolatedValue(t),i=GS.clamp(i,0,1)}e._totalForewardOpacityDelta=s-i,e._totalForewardOpacityDelta=Math.round(100*(e._totalForewardOpacityDelta+Number.EPSILON))/100,i=s;for(let s=t.length-1;s>=0;s--){const r=t[s].GetTime();i-=e._propertyTrack.GetInterpolatedValue(r),i=GS.clamp(i,0,1)}e._totalBackwardOpacityDelta=i,e._totalBackwardOpacityDelta=Math.round(100*(e._totalBackwardOpacityDelta+Number.EPSILON))/100;break}}const i="relative"===e._propertyTrack.GetResultMode(),r=1===e._typeAdapter.GetType();if((i||r)&&t.HasParent()&&t.GetTransformWithParentOpacity()){const i=RS(t);let r=i[0]._GetSceneGraphInfo().GetStartOpacity();r+=AS(i[0],s,"offsetOpacity");for(let e=1;e<i.length;e++)r+=AS(i[e],s,"offsetOpacity");e._opacityFactor=0===r?1:r}},e=>{switch(e._propertyTrack.GetResultMode()){case"relative":{e._clampAccumulator=0;const t=e.GetWorldInfo();let s=t.GetOpacity();s=Math.round(100*(s+Number.EPSILON))/100,e._propertyTrack.GetTimeline().IsForwardPlayBack()?(t.SetOpacity(s+e._totalForewardOpacityDelta),e._lastValue=0):(t.SetOpacity(s-e._totalBackwardOpacityDelta),e._lastValue=e.GetSourceAdapter().GetValueAtTime());break}}}),CS("offsetOriginX",(e,t)=>e.OffsetOriginX(t),(e,t)=>e.SetOriginX(t),e=>e.GetOriginX(),!1),CS("offsetOriginY",(e,t)=>e.OffsetOriginY(t),(e,t)=>e.SetOriginY(t),e=>e.GetOriginY(),!1),CS("offsetZElevation",(e,t)=>e.OffsetZElevation(t),(e,t)=>e.SetZElevation(t),e=>e.GetZElevation(),!0),CS("offsetScaleX",(e,t,s,i)=>{if(0===t)return;const r=e.GetWidth()<0?-1:1;if(i._absoluteScaleXOffset+=t,"relative"===i._propertyTrack.GetResultMode()&&e.HasParent()&&e.GetTransformWithParentWidth()){const n=AS(e,s,"offsetWidth"),a=isNaN(i._originalSize)?s.GetOriginalWidth():i._originalSize,o=(a+n/(e._GetSceneGraphInfo()._GetStartWidth()/a))*r*t;isNaN(i._absoluteToFactor)&&vS.get("offsetWidth").setter(e,1,s,i,!0);const l=o/i._absoluteToFactor;e.OffsetWidth(l,!0),i._changeAccumulator+=l}else{const n=(isNaN(i._originalSize)?s.GetOriginalWidth():i._originalSize)*r*t;e.OffsetWidth(n),i._changeAccumulator+=n}},(e,t,s)=>{e.SetWidth(s.GetOriginalWidth()*t)},(e,t)=>{const s=e.GetWidth()<0?-1:1;if(e.GetTransformWithParentWidth()){const i=e.GetParent(),r=t.GetTimeline().GetTrackFromInstance(i.GetInstance());let n=NaN;if(r)n=i.GetWidth()/r.GetOriginalWidth();else{const e=i.GetInstance().GetSdkInstance();n=e.IsOriginalSizeKnown()?i.GetWidth()/e.GetOriginalWidth():1}return e.GetWidth()*s/(t.GetOriginalWidth()*n)}return e.GetWidth()*s/t.GetOriginalWidth()},!1,!1,null,e=>{e._changeAccumulator=0,e._originalSize=NaN,e._absoluteScaleXOffset=0}),CS("offsetScaleY",(e,t,s,i)=>{if(0===t)return;const r=e.GetHeight()<0?-1:1;if(i._absoluteScaleYOffset+=t,"relative"===i._propertyTrack.GetResultMode()&&e.HasParent()&&e.GetTransformWithParentHeight()){const n=AS(e,s,"offsetHeight"),a=isNaN(i._originalSize)?s.GetOriginalHeight():i._originalSize,o=(a+n/(e._GetSceneGraphInfo()._GetStartHeight()/a))*r*t;isNaN(i._absoluteToFactor)&&vS.get("offsetHeight").setter(e,1,s,i,!0);const l=o/i._absoluteToFactor;e.OffsetHeight(l,!0),i._changeAccumulator+=l}else{const n=(isNaN(i._originalSize)?s.GetOriginalHeight():i._originalSize)*r*t;e.OffsetHeight(n),i._changeAccumulator+=n}},(e,t,s)=>{e.SetHeight(s.GetOriginalHeight()*t)},(e,t)=>{const s=e.GetHeight()<0?-1:1;if(e.GetTransformWithParentHeight()){const i=e.GetParent(),r=t.GetTimeline().GetTrackFromInstance(i.GetInstance());let n=NaN;if(r)n=i.GetHeight()/r.GetOriginalHeight();else{const e=i.GetInstance().GetSdkInstance();n=e.IsOriginalSizeKnown()?i.GetHeight()/e.GetOriginalHeight():1}return e.GetHeight()*s/(t.GetOriginalHeight()*n)}return e.GetHeight()*s/t.GetOriginalHeight()},!1,!1,null,e=>{e._changeAccumulator=0,e._originalSize=NaN,e._absoluteScaleYOffset=0});class PS extends GS.PropertyTrackState.PropertyInterpolationAdapter{constructor(e){super(e),this._lastValue=0,this._clampAccumulator=0,this._totalForewardOpacityDelta=0,this._totalBackwardOpacityDelta=0,this._opacityFactor=NaN,this._absoluteToFactor=NaN,this._changeAccumulator=0,this._originalSize=NaN,this._absoluteWidthOffset=0,this._absoluteScaleXOffset=0,this._absoluteHeightOffset=0,this._absoluteScaleYOffset=0,this._angleReflectMirrorOrFlip=void 0,this._angleReflectMirrorAndFlip=void 0,this._instance_getter=null,this._instance_setter=null,this._instance_absolute_setter=null,this._reset_action=null,this._init_action=null,this._source_adapter_getter=null,this._source_adapter_setter=null,this._source_adapter_absolute_setter=null,this._round=!1,this._fRound=!1,GS.IsInstanceOf(this._propertyTrack.GetTimeline(),GS.TweenState)?this._typeAdapter=new GS.PropertyTrackState.PropertyInterpolationAdapter.NumericInterpolationAdapterForTween(this):this._typeAdapter=new GS.PropertyTrackState.PropertyInterpolationAdapter.NumericInterpolationAdapterForTimeline(this);const t=this._propertyTrack.GetPropertyName();switch(this._propertyTrack.GetSourceAdapterId()){case"world-instance":{const e=vS.get(t);this._instance_getter=e.getter,this._instance_setter=e.setter,this._instance_absolute_setter=e.absolute_setter,this._round=e.round,this._fRound=e.fRound,this._init_action=e.init,this._reset_action=e.reset;break}case"audio":this._source_adapter_getter=e.Getter,this._source_adapter_setter=e.Setter,this._source_adapter_absolute_setter=e.AbsoluteSetter,this._round=!!e.DoesRounding(),this._fRound=!1}}Release(){this._typeAdapter=null,this._instance_getter=null,this._instance_setter=null,this._instance_absolute_setter=null,this._reset_action=null,this._init_action=null,this._source_adapter_getter=null,this._source_adapter_setter=null,this._source_adapter_absolute_setter=null,super.Release()}MayNeedBeforeAndAfterInterpolate(){return this._typeAdapter.MayNeedBeforeAndAfterInterpolate()}GetLastValue(){return this._lastValue}SetLastValue(e){this._lastValue=e}SetResetState(){this._reset_action&&this._reset_action(this)}SetInitialState(){const e=this._typeAdapter.SetInitialState();if("number"==typeof e&&(this._lastValue=e),this._init_action){const e=this.GetWorldInfo(),t=this._propertyTrack.GetTrack();this._init_action(this,e,t)}}SetResumeState(){const e=this._typeAdapter.SetResumeState();"number"==typeof e&&(this._lastValue=e)}GetCurrentState(){return this._Getter()}CompareInitialStateWithCurrent(){return this._FirstKeyframeGetter()!==this.GetCurrentState()}CompareSaveStateWithCurrent(){return!GS.IsNullOrUndefined(this._saveState)&&this._saveState!==this.GetCurrentState()}BeforeChangeProperty(){this._typeAdapter.BeforeChangeProperty()}ChangeProperty(e,t,s,i,r,n,a,o){return this._typeAdapter.ChangeProperty(e,t,s,i,r,n,a,o)}AfterChangeProperty(){this._typeAdapter.AfterChangeProperty()}_Getter(){const e=this._GetTarget(),t=this._GetIndex(),s=this.GetWorldInfo(),i=this._propertyTrack.GetTrack();switch(this._propertyTrack.GetSourceAdapterId()){case"behavior":case"plugin":return e.GetPropertyValueByIndex(t);case"effect":return e[t];case"instance-variable":return e.GetInstanceVariableValue(t);case"world-instance":return this._instance_getter(s,i);case"audio":return this._source_adapter_getter.call(this.GetSourceAdapter(),s,i)}}_Setter(e,t,s,i=!0){const r=this._GetTarget(),n=this._GetIndex(),a=this.GetWorldInfo(),o=this._propertyTrack.GetTrack();switch(this._propertyTrack.GetSourceAdapterId()){case"behavior":r.OffsetPropertyValueByIndex(n,e);break;case"effect":r[n]+=e;break;case"instance-variable":r.SetInstanceVariableOffset(n,e);break;case"plugin":r.OffsetPropertyValueByIndex(n,e,this.GetSourceAdapter().GetOptionalCallbacks());break;case"world-instance":this._instance_setter(a,e,o,this,!1,i);break;case"audio":this._source_adapter_setter.call(this.GetSourceAdapter(),a,e,o,this)}}_SetterAbsolute(e,t,s){let i=this._propertyTrack.GetInterpolationMode();if(i="default"===i?"continuous":i,"discrete"===i&&!t)return;if("discrete"===i&&s){const e=this._propertyTrack.GetTimeline().GetTime();if(!this._propertyTrack.GetPropertyKeyFrameDataItemAtTime(e))return}const r=this._GetTarget(),n=this._GetIndex(),a=this.GetWorldInfo(),o=this._propertyTrack.GetTrack();switch(this._propertyTrack.GetSourceAdapterId()){case"behavior":r.SetPropertyValueByIndex(n,e);break;case"effect":r[n]=e;break;case"instance-variable":r.SetInstanceVariableValue(n,e);break;case"plugin":r.SetPropertyValueByIndex(n,e,this.GetSourceAdapter().GetOptionalCallbacks());break;case"world-instance":this._instance_absolute_setter(a,e,o);break;case"audio":this._source_adapter_absolute_setter.call(this.GetSourceAdapter(),a,e,o)}}_MaybeEnsureValue(e,t,s,i,r,n,a,o){this._typeAdapter._MaybeEnsureValue(e,t,s,i,r,n,a,o)}_AddDelta(e,t,s,i,r){"angle"===this._propertyTrack.GetPropertyType()&&(e=GS.toDegrees(e));const n=(e.toString().split(".")[1]||"").length,a=this._Getter();let o;switch(o=0===n?this._round?Math.round(a):this._fRound?"angle"===this._propertyTrack.GetPropertyType()?GS.toRadians(Math.round(GS.toDegrees(a))):Number(GS.toFixed(a,2)):a:this._round?Number(GS.toFixed(a,n)):(this._fRound,a),this._Setter(o-a,t,s,!1),this._propertyTrack.GetPropertyName()){case"offsetWidth":case"offsetScaleX":{const e=this.GetWorldInfo(),t=e.GetWidth(),s=Number(GS.toFixed(t,2));e.OffsetWidth(s-t);break}case"offsetHeight":case"offsetScaleY":{const e=this.GetWorldInfo(),t=e.GetHeight(),s=Number(GS.toFixed(t,2));e.OffsetHeight(s-t);break}}}_SaveToJson(){return Object.assign(super._SaveToJson(),{v:this._lastValue,a:this._clampAccumulator,fod:this._totalForewardOpacityDelta,bod:this._totalBackwardOpacityDelta,of:this._opacityFactor,sf:this._absoluteToFactor,armorf:this._angleReflectMirrorOrFlip,armandf:this._angleReflectMirrorAndFlip,ca:this._changeAccumulator,os:this._originalSize,awo:this._absoluteWidthOffset,aho:this._absoluteHeightOffset,asxo:this._absoluteScaleXOffset,asyo:this._absoluteScaleYOffset})}_LoadFromJson(e){e&&(super._LoadFromJson(e),this._lastValue=e.v,this._clampAccumulator=e.a,this._totalForewardOpacityDelta=GS.IsFiniteNumber(e.fod)?e.fod:0,this._totalBackwardOpacityDelta=GS.IsFiniteNumber(e.bod)?e.bod:0,this._opacityFactor=GS.IsFiniteNumber(e.of)?e.of:NaN,this._absoluteToFactor=GS.IsFiniteNumber(e.sf)?e.sf:NaN,this._angleReflectMirrorOrFlip=GS.IsFiniteNumber(e.armorf)?e.armorf:void 0,this._angleReflectMirrorAndFlip=GS.IsFiniteNumber(e.armandf)?e.armandf:void 0,this._changeAccumulator=GS.IsFiniteNumber(e.ca)?e.ca:0,this._originalSize=GS.IsFiniteNumber(e.os)?e.os:NaN,this._absoluteWidthOffset=GS.IsFiniteNumber(e.awo)?e.awo:0,this._absoluteHeightOffset=GS.IsFiniteNumber(e.aho)?e.aho:0,this._absoluteScaleXOffset=GS.IsFiniteNumber(e.asxo)?e.asxo:0,this._absoluteScaleYOffset=GS.IsFiniteNumber(e.asyo)?e.asyo:0)}SetOriginalSizeProperty(e){this._originalSize=e}GetChangeAccumulatorProperty(){return this._changeAccumulator}GetAbsoluteWidthOffsetProperty(){return this._absoluteWidthOffset}GetAbsoluteHeightOffsetProperty(){return this._absoluteHeightOffset}GetAbsoluteScaleXOffsetProperty(){return this._absoluteScaleXOffset}GetAbsoluteScaleYOffsetProperty(){return this._absoluteScaleYOffset}}GS.PropertyTrackState.PropertyInterpolationAdapter.NumericInterpolationAdapter=PS}{const MS=self.C3;class ES{constructor(e){this._used=!1,this._value=0,this._propertyKeyframeReached=!1,this._endState=!1,this._propertyTracks=e;for(let e=0,t=this._propertyTracks.length;e<t;e++)this._propertyTracks[e].SetAbsoluteValueObject(this)}GetPropertyTracks(){return this._propertyTracks}SetUsed(){this._used=!0}GetUsed(){return this._used}SetValue(e){this._value=e}GetValue(){return this._value}SetPropertyKeyframeReached(e){this._propertyKeyframeReached=e}GetPropertyKeyframeReached(){return this._propertyKeyframeReached}SetEndState(e){this._endState=e}GetEndState(){return this._endState}Reset(){this._used=!1,this._value=0,this._propertyKeyframeReached=!1,this._endState=!1}}class DS{constructor(e){this._numericInterpolationAdapter=e}Release(){this._numericInterpolationAdapter=null}GetType(){return 0}SetInitialState(){const e=this._numericInterpolationAdapter;return this._numericInterpolationAdapter.GetPropertyTrack(),e._PickResultMode(()=>e._PickTimelinePlaybackMode(()=>0,()=>e.GetSourceAdapter().GetValueAtTime()),()=>{})}SetResumeState(){}MayNeedBeforeAndAfterInterpolate(){switch(this._numericInterpolationAdapter,this._numericInterpolationAdapter.GetPropertyTrack().GetResultMode()){case"relative":return!1;case"absolute":return!0}}BeforeChangeProperty(){this._numericInterpolationAdapter;const e=this._numericInterpolationAdapter.GetPropertyTrack(),t=e.GetPropertyName();switch(e.GetResultMode()){case"relative":break;case"absolute":if(e.HasAbsoluteValueObject())e.GetAbsoluteValueObject().Reset();else{const s=e.GetTimeline(),i=e.GetInstance(),r=e.GetSourceAdapter(),n=s.GetSimilarPropertyTracks(i,r,t,e);n&&n.length>1&&new ES(n)}}}ChangeProperty(e,t,s,i,r,n,a,o){const l=this._numericInterpolationAdapter,h=this._numericInterpolationAdapter.GetPropertyTrack();switch(h.GetResultMode()){case"relative":{const a=l.GetLastValue();l._Setter(t-a,s,i),n&&this._MaybeEnsureValue(e,s,i,r,a,t),l.SetLastValue(t);break}case"absolute":{const e=h.GetTimeline(),s=h.GetTrack();if(h.GetInstance(),h.GetSourceAdapter(),h.HasAbsoluteValueObject()){const i=h.GetAbsoluteValueObject(),r=i.GetPropertyTracks(),n=l._GetPropertyKeyframeStubs(r,!0),u=l._GetLastPropertyKeyframeStub(e,e.GetTime(),n);if(u){const e=s.GetStartOffset(),r=u.time-e;if(0===r)i.SetEndState(a),i.SetPropertyKeyframeReached(o),i.SetUsed(),i.SetValue(i.GetValue()+t);else{if(r<0)return;const e=h.GetInterpolatedValue(r);i.SetEndState(a),i.SetPropertyKeyframeReached(o),i.SetUsed(),i.SetValue(i.GetValue()+(t-e))}}}else l._SetterAbsolute(t,o,a);break}}}AfterChangeProperty(){const e=this._numericInterpolationAdapter,t=this._numericInterpolationAdapter.GetPropertyTrack();switch(t.GetResultMode()){case"relative":break;case"absolute":if(t.HasAbsoluteValueObject()){const s=t.GetAbsoluteValueObject();s.GetUsed()&&e._SetterAbsolute(s.GetValue(),s.GetPropertyKeyframeReached(),s.GetEndState())}}}_MaybeEnsureValue(e,t,s,i,r,n){const a=this._numericInterpolationAdapter;i||(t&&e===t.GetTime()?a._AddDelta(t.GetValueWithResultMode(),t,s):s&&e===s.GetTime()?a._AddDelta(s.GetValueWithResultMode(),t,s):n-r===0&&a._AddDelta(t.GetValueWithResultMode(),t,s))}}MS.PropertyTrackState.PropertyInterpolationAdapter.NumericInterpolationAdapterForTimeline=DS}{const NS=self.C3;class FS{constructor(e){this._numericInterpolationAdapter=e}Release(){this._numericInterpolationAdapter=null}GetType(){return 1}SetInitialState(){const e=this._numericInterpolationAdapter;return e.SetFirstAbsoluteUpdate(!0),this._GetAbsoluteInitialValue(e._FirstKeyframeGetter())}SetResumeState(){const e=this._numericInterpolationAdapter;if(e._FirstKeyframeGetter()!==e._CurrentKeyframeGetter())return e.SetFirstAbsoluteUpdate(!0),this._GetAbsoluteInitialValue(e._CurrentKeyframeGetter())}MayNeedBeforeAndAfterInterpolate(){return!1}BeforeChangeProperty(){}ChangeProperty(e,t,s,i,r,n,a,o){const l=this._numericInterpolationAdapter,h=l.GetLastValue();switch(l.GetPropertyTrack().GetResultMode()){case"relative":l._Setter(t-h,s,i),n&&this._MaybeEnsureValue(e,s,i,r,h,t,!1,a);break;case"absolute":l.GetFirstAbsoluteUpdate()?(l.SetFirstAbsoluteUpdate(!1),l._Setter(h,s,i)):0===e&&0===l.GetPropertyTrack().GetTimeline().GetTotalTime()?l._SetterAbsolute(t,!0,!1):(l._Setter(t-h,s,i),n&&this._MaybeEnsureValue(e,s,i,r,h,t,this._ForceEndValue(),a))}l.SetLastValue(t)}AfterChangeProperty(){}_GetAbsoluteInitialValue(e){return e-this._numericInterpolationAdapter.GetCurrentState()}_ForceEndValue(){const e=this._numericInterpolationAdapter,t=e.GetWorldInfo().GetInstance(),s=e.GetPropertyTrack().GetRuntime().GetTimelineManager();let i=0;for(const e of s.GetPlayingTimelines())0===e.GetType()?e.HasTrackInstance(t)&&i++:1===e.GetType()&&e.GetInstance()===t&&i++;return i<=1}_MaybeEnsureValue(e,t,s,i,r,n,a,o){const l=this._numericInterpolationAdapter;i?t&&e===t.GetTime()?l._AddDelta(t.GetValueWithResultMode(),t,s,a,o):s&&e===s.GetTime()?l._AddDelta(s.GetValueWithResultMode(),t,s,a,o):s||l._AddDelta(t.GetValueWithResultMode(),t,s,a,o):t&&e===t.GetTime()?l._AddDelta(t.GetValueWithResultMode(),t,s,a,o):s&&e===s.GetTime()?l._AddDelta(s.GetValueWithResultMode(),t,s,a,o):n-r===0&&l._AddDelta(t.GetValueWithResultMode(),t,s,a,o)}}NS.PropertyTrackState.PropertyInterpolationAdapter.NumericInterpolationAdapterForTween=FS}{const OS=self.C3,BS=self.Ease;OS.PropertyTrackState.NumericTypeAdapter=class{constructor(){}static WillChange(e,t,s,i){let r;switch(i){case"behavior":case"plugin":r=t.GetPropertyValueByIndex(e);break;case"effect":r=t[e];break;case"instance-variable":r=t.GetInstanceVariableValue(e)}return r!==s}static Interpolate(e,t,s,i){if(!s){let e=i.GetPropertyTrackDataItem();return e=i.GetPropertyTrackData().GetLastPropertyKeyframeDataItem(e),e.GetValueWithResultMode()}let r=i.GetInterpolationMode();if("default"===r&&(r="continuous"),"combo"===i.GetPropertyType()&&(r="discrete"),"discrete"===r)return t.GetValueWithResultMode();if("continuous"===r||"step"===r){const n=i.GetTimeline().GetStep();if("step"===r&&0!==n){const t=1/n;e=Math.floor(e*t)/t}const a=t.GetValueWithResultMode(),o=s.GetValueWithResultMode(),l=t.GetAddOn("cubic-bezier"),h=s.GetAddOn("cubic-bezier"),u=l&&l.GetStartEnable()&&h&&h.GetEndEnable();if(!u&&a===o)return a;const c=t.GetTime(),d=s.GetTime();"step"===r&&0!==n&&(e=OS.clamp(e,c,d));const p=OS.normalize(e,c,d),_=t.GetEase();let m;if(u){const e=d-c;m=BS.GetRuntimeEase(_)(e*p,0,1,e),m=BS.GetRuntimeEase("cubicbezier")(m,a,a+l.GetStartAnchor(),o+h.GetEndAnchor(),o)}else m=BS.GetRuntimeEase(_)((d-c)*p,a,o-a,d-c);return"integer"===i.GetPropertyType()?Math.floor(m):m}}}}{const LS=self.C3;LS.PropertyTrackState.AngleTypeAdapter=class{constructor(){}static WillChange(e,t,s,i){let r;switch(i){case"behavior":case"plugin":r=t.GetPropertyValueByIndex(e);break;case"effect":r=t[e];break;case"instance-variable":r=t.GetInstanceVariableValue(e)}return r!==s}static Interpolate(e,t,s,i){if(!s){let e=i.GetPropertyTrackDataItem();return e=i.GetPropertyTrackData().GetLastPropertyKeyframeDataItem(e),e.GetValueWithResultMode()}let r=i.GetInterpolationMode();if("default"===r&&(r="continuous"),"combo"===i.GetPropertyType()&&(r="discrete"),"discrete"===r)return t.GetValueWithResultMode();if("continuous"===r||"step"===r){const n=i.GetTimeline().GetStep();if("step"===r&&0!==n){const t=1/n;e=Math.floor(e*t)/t}const a=t.GetTime(),o=s.GetTime(),l=t.GetValueWithResultMode(),h=s.GetValueWithResultMode();"step"===r&&0!==n&&(e=LS.clamp(e,a,o));const u=t.GetAddOn("angle");if(!u){if(l===h)return l;const s=LS.normalize(e,a,o),i=self.Ease.GetRuntimeEase(t.GetEase());return LS.angleLerp(l,h,i(s,0,1,1))}{const s=u.GetRevolutions();if(l===h&&0===s)return l;const i=LS.normalize(e,a,o),r=self.Ease.GetRuntimeEase(t.GetEase())(i,0,1,1);switch(u.GetDirection()){case"closest":return LS.angleLerp(l,h,r,s);case"clockwise":return LS.angleLerpClockwise(l,h,r,s);case"anti-clockwise":return LS.angleLerpAntiClockwise(l,h,r,s)}}}}}}{const kS=self.C3;kS.PropertyTrackState.BooleanTypeAdapter=class{constructor(){}static WillChange(e,t,s,i){let r;switch(i){case"behavior":case"plugin":r=t.GetPropertyValueByIndex(e);break;case"effect":r=t[e];break;case"instance-variable":r=t.GetInstanceVariableValue(e)}return!!r!=!!s}static Interpolate(e,t,s,i){if(!s){let e=i.GetPropertyTrackDataItem();return e=i.GetPropertyTrackData().GetLastPropertyKeyframeDataItem(e),e.GetValueWithResultMode()?1:0}return t.GetValueWithResultMode()?1:0}}}{const VS=self.C3,US=[0,0,0],WS=[0,0,0],HS=[0,0,0];VS.PropertyTrackState.ColorTypeAdapter=class{constructor(){}static WillChange(e,t,s,i){let r;switch(i){case"behavior":case"plugin":r=t.GetPropertyValueByIndex(e);break;case"effect":r=t[e];break;case"instance-variable":r=t.GetInstanceVariableValue(e)}return Array.isArray(s)?(US[0]=s[0],US[1]=s[1],US[2]=s[2]):(HS.parseCommaSeparatedRgb(s),US[0]=Math.floor(255*HS.getR()),US[1]=Math.floor(255*HS.getG()),US[2]=Math.floor(255*HS.getB())),Array.isArray(r)?(WS[0]=r[0],WS[1]=r[1],WS[2]=r[2]):(HS.parseCommaSeparatedRgb(r),WS[0]=Math.floor(255*HS.getR()),WS[1]=Math.floor(255*HS.getG()),WS[2]=Math.floor(255*HS.getB())),US[0]!==WS[0]||US[1]!==WS[1]||US[2]!==WS[2]}static Interpolate(e,t,s,i){if(!s){let e=i.GetPropertyTrackDataItem();e=i.GetPropertyTrackData().GetLastPropertyKeyframeDataItem(e);const t=e.GetValueWithResultMode();return US[0]=t[0],US[1]=t[1],US[2]=t[2],US}let r=i.GetInterpolationMode();if("default"===r&&(r="continuous"),"discrete"===r){const e=t.GetValueWithResultMode();return US[0]=e[0],US[1]=e[1],US[2]=e[2],US}if("continuous"===r||"step"===r){const n=i.GetTimeline().GetStep();if("step"===r&&0!==n){const t=1/n;e=Math.floor(e*t)/t}const a=t.GetTime(),o=s.GetTime(),l=t.GetValueWithResultMode(),h=s.GetValueWithResultMode();"step"===r&&0!==n&&(e=VS.clamp(e,a,o));const u=VS.normalize(e,a,o),c=t.GetEase(),d=l[0],p=l[1],_=l[2],m=h[0],f=h[1],g=h[2],y=self.Ease.GetRuntimeEase(c),S=o-a,T=S*u;return US[0]=d===m?d:y(T,d,m-d,S),US[1]=p===f?p:y(T,p,f-p,S),US[2]=_===g?_:y(T,_,g-_,S),US}}}}{const zS=self.C3;zS.PropertyTrackState.TextTypeAdapter=class{constructor(){}static WillChange(e,t,s,i){let r;switch(i){case"behavior":case"plugin":r=t.GetPropertyValueByIndex(e);break;case"effect":r=t[e];break;case"instance-variable":r=t.GetInstanceVariableValue(e)}return r!==s}static Interpolate(e,t,s,i){if(!s){let e=i.GetPropertyTrackDataItem();return e=i.GetPropertyTrackData().GetLastPropertyKeyframeDataItem(e),e.GetValueWithResultMode()}return t.GetValueWithResultMode()}}}{const jS=self.C3;jS.TimelineDataManager=class{constructor(){this._timelineDataItems=new Map}Release(){for(const e of this._timelineDataItems.values())e.Release();this._timelineDataItems.clear(),this._timelineDataItems=null}Add(e){const t=new jS.TimelineDataItem(e),s=t.GetName();this._timelineDataItems.set(s,t)}Get(e){return this._timelineDataItems.get(e)}GetNameId(){return 0}static _CreateDataItems(e,t,s,i){if(t)for(const r of t)jS.TimelineDataManager._CreateDataItem("create",r,e,s,i)}static _CreateDataItemsIncludingDisabled(e,t,s,i){if(t)for(const r of t)jS.TimelineDataManager._CreateDataItem("create-including-disabled",r,e,s,i)}static _LoadDataItemsFromJson(e,t,s,i){e.length?t.forEach((t,s)=>{e[s]._LoadFromJson(t)}):t.forEach(t=>{jS.TimelineDataManager._CreateDataItem("load",t,e,s,i)})}static _CreateDataItem(e,t,s,i,r){let n;if("function"==typeof i)switch(e){case"load":n=new i(null,r);break;case"create":case"create-including-disabled":n=new i(t,r)}else if("object"==typeof i){const s=t[i.prop],a=i.map.get(s);switch(e){case"load":n=new a(null,r);break;case"create":case"create-including-disabled":n=new a(t,r)}}switch(e){case"load":n._LoadFromJson(t),s.push(n);break;case"create":if("function"==typeof n.GetEnable&&!n.GetEnable())return n.Release();s.push(n);break;case"create-including-disabled":s.push(n)}}}}{const YS=self.C3,qS=0,XS=1,$S=2,KS=3,JS=4,QS=5,ZS=6,eT=7,tT=8,sT=9,iT=10,rT=11;YS.TimelineDataItem=class{constructor(e){this._name="",this._totalTime=NaN,this._step=0,this._interpolationMode="default",this._resultMode="default",this._loop=!1,this._pingPong=!1,this._repeatCount=1,this._trackData=null,this._startOnLayout="",this._transformWithSceneGraph=!1,this._useSystemTimescale=!0,e&&(this._name=e[0],this._totalTime=e[1],this._step=e[2],this._interpolationMode=e[3],this._resultMode=e[4],this._loop=!!e[6],this._pingPong=!!e[7],this._repeatCount=e[8],this._startOnLayout=e[9],this._transformWithSceneGraph=!!e[10],this._useSystemTimescale=!!e[11],this._trackData=new YS.TrackData(e[5],this))}Release(){this._trackData.Release(),this._trackData=null}GetTrackData(){return this._trackData||(this._trackData=new YS.TrackData(null,this)),this._trackData}GetName(){return this._name}SetName(e){this._name=e}GetTotalTime(){return this._totalTime}SetTotalTime(e){this._totalTime=e}GetStep(){return this._step}SetStep(e){this._step=e}GetInterpolationMode(){return this._interpolationMode}SetInterpolationMode(e){this._interpolationMode=e}GetResultMode(){return this._resultMode}SetResultMode(e){this._resultMode=e}GetLoop(){return this._loop}SetLoop(e){this._loop=e}GetPingPong(){return this._pingPong}SetPingPong(e){this._pingPong=e}GetRepeatCount(){return this._repeatCount}SetRepeatCount(e){this._repeatCount=e}GetStartOnLayout(){return this._startOnLayout}GetTransformWithSceneGraph(){return this._transformWithSceneGraph}GetUseSystemTimescale(){return this._useSystemTimescale}_SaveToJson(){return{trackDataJson:this._trackData._SaveToJson(),name:this._name,totalTime:this._totalTime,step:this._step,interpolationMode:this._interpolationMode,resultMode:this._resultMode,loop:this._loop,pingPong:this._pingPong,repeatCount:this._repeatCount,startOnLayout:this._startOnLayout,transformWithSceneGraph:!!this._transformWithSceneGraph,useSystemTimescale:this._useSystemTimescale}}_LoadFromJson(e){e&&(this.GetTrackData()._LoadFromJson(e.trackDataJson),this._name=e.name,this._totalTime=e.totalTime,this._step=e.step,this._interpolationMode=e.interpolationMode,this._resultMode=e.resultMode,this._loop=e.loop,this._pingPong=e.pingPong,this._repeatCount=e.repeatCount,this._startOnLayout=e.startOnLayout,this._transformWithSceneGraph=!!e.transformWithSceneGraph,this._useSystemTimescale=!!e.useSystemTimescale)}}}{const nT=self.C3,aT=0,oT=1,lT=2,hT=1,uT=2,cT=3,dT=4,pT=5,_T=6,mT=7,fT=0,gT=1,yT=8,ST=0,TT=1,xT=9,bT=10;class GT{constructor(e,t){this._trackData=t,this._instanceData=null,this._additionalInstanceData=null,this._instanceUid=NaN,this._objectClassIndex=NaN,this._interpolationMode="default",this._resultMode="default",this._enabled=!1,this._keyframeData=null,this._propertyTrackData=null,this._id="",this._nestedData=null,this._startOffset=0,this._localTotalTime=this._trackData.GetTimelineDataItem().GetTotalTime(),this._type=0,this._name="",e&&(e[0]&&(this._instanceData=e[0],this._instanceUid=e[0][2],this._objectClassIndex=e[0][1]),this._interpolationMode=e[1],this._resultMode=e[2],this._enabled=!!e[3],e[6]&&(this._id=e[6]),e[7]&&(this._nestedData=e[7],this._startOffset=e[7][0],this._localTotalTime=e[7][1]),e[8]&&(this._additionalInstanceData=e[8]),e[8]&&(this._additionalInstanceData=e[8]),e[9]&&(this._type=e[9]),e[10]&&(this._name=e[10]),this._keyframeData=new nT.KeyframeData(e[4],this),this._propertyTrackData=new nT.PropertyTrackData(e[5],this))}Release(){this._instanceData=null,this._trackData=null,this._keyframeData&&(this._keyframeData.Release(),this._keyframeData=null),this._propertyTrackData&&(this._propertyTrackData.Release(),this._propertyTrackData=null),this._nestedData=null}GetTrackData(){return this._trackData}GetKeyframeData(){return this._keyframeData||(this._keyframeData=new nT.KeyframeData(null,this)),this._keyframeData}GetPropertyTrackData(){return this._propertyTrackData||(this._propertyTrackData=new nT.PropertyTrackData(null,this)),this._propertyTrackData}GetInstanceData(){return this._instanceData}GetObjectClassIndex(){return this._objectClassIndex}SetObjectClassIndex(e){this._objectClassIndex=e}GetInstanceUID(){return this._instanceUid}SetInstanceUID(e){this._instanceUid=e}GetInterpolationMode(){return this._interpolationMode}SetInterpolationMode(e){this._interpolationMode=e}GetResultMode(){return this._resultMode}SetResultMode(e){this._resultMode=e}GetEnable(){return this._enabled}SetEnable(e){this._enabled=!!e}GetId(){return this._id}GetStartOffset(){return this._startOffset}GetLocalTotalTime(){return this._localTotalTime}SetLocalTotalTime(e){this._localTotalTime=e}GetOriginalWidth(){return this._additionalInstanceData[0]}SetOriginalWidth(e){this._additionalInstanceData||(this._additionalInstanceData=[]),this._additionalInstanceData[0]=e}GetOriginalHeight(){return this._additionalInstanceData||(this._additionalInstanceData=[]),this._additionalInstanceData[1]}SetOriginalHeight(e){this._additionalInstanceData||(this._additionalInstanceData=[]),this._additionalInstanceData[1]=e}GetType(){return this._type}GetName(){return this._name}_SaveToJson(){return{keyframeDataJson:this._keyframeData._SaveToJson(),propertyTrackDataJson:this._propertyTrackData._SaveToJson(),instanceData:this._instanceData,additionalInstanceData:this._additionalInstanceData,instanceUid:this._instanceUid,objectClassIndex:this._objectClassIndex,interpolationMode:this._interpolationMode,resultMode:this._resultMode,enabled:this._enabled,id:this._id,nestedData:this._nestedData,type:this._type,name:this._name}}_LoadFromJson(e){e&&(this._instanceData=e.instanceData,this._instanceUid=e.instanceUid,this._objectClassIndex=e.objectClassIndex,this._interpolationMode=e.interpolationMode,this._resultMode=e.resultMode,this._enabled=e.enabled,this._id=e.id,this._type=e.type?e.type:0,this._name=e.name?e.name:"",this._localTotalTime=this._trackData.GetTimelineDataItem().GetTotalTime(),e.nestedData&&(this._nestedData=e.nestedData,this._startOffset=this._nestedData[0],this._localTotalTime=this._nestedData[1]),e.additionalInstanceData&&(this._additionalInstanceData=e.additionalInstanceData),this.GetKeyframeData()._LoadFromJson(e.keyframeDataJson),this.GetPropertyTrackData()._LoadFromJson(e.propertyTrackDataJson))}}nT.TrackData=class{constructor(e,t){this._timelineDataItem=t,this._trackDataItems=[],nT.TimelineDataManager._CreateDataItems(this._trackDataItems,e,GT,this)}Release(){this._timelineDataItem=null;for(const e of this._trackDataItems)e.Release();nT.clearArray(this._trackDataItems),this._trackDataItems=null}GetTimelineDataItem(){return this._timelineDataItem}AddEmptyTrackDataItem(){const e=new GT(null,this);return this._trackDataItems.push(e),e}GetFirstKeyframeDataItem(e){return e.GetKeyframeData().GetKeyframeDataItemArray()[0]}GetLastKeyframeDataItem(e){return e.GetKeyframeData().GetKeyframeDataItemArray().at(-1)}GetKeyFrameDataItemAtTime(e,t){const s=t.GetKeyframeData().GetKeyframeDataItemArray(),i=s.length;for(let t=0;t<i;t++){const i=s[t];if(i.GetTime()===e)return i}}GetFirstKeyFrameDataItemHigherThan(e,t){const s=t.GetKeyframeData().GetKeyframeDataItemArray(),i=s.length;for(let t=0;t<i;t++){const i=s[t];if(i.GetTime()>e)return i}}GetFirstKeyFrameDataItemHigherOrEqualThan(e,t){const s=t.GetKeyframeData().GetKeyframeDataItemArray(),i=s.length;for(let t=0;t<i;t++){const i=s[t];if(i.GetTime()>=e)return i}}GetFirstKeyFrameDataItemLowerOrEqualThan(e,t){const s=t.GetKeyframeData().GetKeyframeDataItemArray();for(let t=s.length-1;t>=0;t--){const i=s[t];if(i.GetTime()<=e)return i}}*trackDataItems(){for(const e of this._trackDataItems)yield e}_SaveToJson(){return{trackDataItemsJson:this._trackDataItems.map(e=>e._SaveToJson())}}_LoadFromJson(e){e&&nT.TimelineDataManager._LoadDataItemsFromJson(this._trackDataItems,e.trackDataItemsJson,GT,this)}}}{const IT=self.C3,vT=0,CT=0,wT=1,AT=2,RT=3,PT=4,MT=5,ET=6,DT=7,NT=8,FT=9;class OT{constructor(e,t){this._propertyTrackData=t,this._sourceAdapterId="",this._sourceAdapterArguments=null,this._property=null,this._type=null,this._min=NaN,this._max=NaN,this._interpolationMode="default",this._resultMode="default",this._enabled=!1,this._propertyKeyframeData=null,this._canHavePropertyKeyframes=!0,e&&(this._sourceAdapterId=e[0][0],this._sourceAdapterArguments=e[0].slice(1),this._property=e[1],this._type=e[2],this._min=e[3],this._max=e[4],this._interpolationMode=e[5],this._resultMode=e[6],this._enabled=!!e[7],this._propertyKeyframeData=new IT.PropertyKeyframeData(e[8],this),this._canHavePropertyKeyframes=e[9])}Release(){this._propertyKeyframeData.Release(),this._propertyKeyframeData=null,this._propertyTrackData=null,this._sourceAdapterArguments=null}GetPropertyTrackData(){return this._propertyTrackData}GetPropertyKeyframeData(){return this._propertyKeyframeData||(this._propertyKeyframeData=new IT.PropertyKeyframeData(null,this)),this._propertyKeyframeData}GetSourceAdapterId(){return this._sourceAdapterId}SetSourceAdapterId(e){this._sourceAdapterId=e}GetSourceAdapterArguments(){return this._sourceAdapterArguments}SetSourceAdapterArguments(e){this._sourceAdapterArguments=e}GetProperty(){return this._property}SetProperty(e){this._property=e}GetType(){return this._type}SetType(e){this._type=e}GetMin(){return this._min}SetMin(e){this._min=e}GetMax(){return this._max}SetMax(e){this._max=e}GetInterpolationMode(){return this._interpolationMode}SetInterpolationMode(e){this._interpolationMode=e}GetResultMode(){return this._resultMode}SetResultMode(e){this._resultMode=e}GetEnable(){return this._enabled}SetEnable(e){this._enabled=!!e}CanHavePropertyKeyframes(){return!!this._canHavePropertyKeyframes}_SaveToJson(){return{propertyKeyframeDataJson:this._propertyKeyframeData._SaveToJson(),sourceAdapterId:this._sourceAdapterId,sourceAdapterArguments:this._sourceAdapterArguments,property:this._property,type:this._type,min:this._min,max:this._max,interpolationMode:this._interpolationMode,resultMode:this._resultMode,enabled:this._enabled,canHavePropertyKeyframes:this._canHavePropertyKeyframes}}_LoadFromJson(e){e&&(this._sourceAdapterId=e.sourceAdapterId,this._sourceAdapterArguments=e.sourceAdapterArguments,this._property=e.property,this._type=e.type,this._min=e.min,this._max=e.max,this._interpolationMode=e.interpolationMode,this._resultMode=e.resultMode,this._enabled=e.enabled,this._canHavePropertyKeyframes=e.canHavePropertyKeyframes,this.GetPropertyKeyframeData()._LoadFromJson(e.propertyKeyframeDataJson))}}IT.PropertyTrackData=class{constructor(e,t){this._trackDataItem=t,this._propertyTrackDataItems=[],IT.TimelineDataManager._CreateDataItems(this._propertyTrackDataItems,e,OT,this)}Release(){this._trackDataItem=null;for(const e of this._propertyTrackDataItems)e.Release();IT.clearArray(this._propertyTrackDataItems),this._propertyTrackDataItems=null}GetTrackDataItem(){return this._trackDataItem}AddEmptyPropertyTrackDataItem(){const e=new OT(null,this);return this._propertyTrackDataItems.push(e),e}GetFirstPropertyKeyframeDataItem(e){return e.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray()[0]}GetLastPropertyKeyframeDataItem(e){return e.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray().at(-1)}GetPropertyKeyFrameDataItemAtTime(e,t){const s=t.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray(),i=s.length;for(let t=0;t<i;t++){const i=s[t];if(i.GetTime()===e)return i}}GetFirstPropertyKeyFrameDataItemHigherThan(e,t){const s=t.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray(),i=s.length;for(let t=0;t<i;t++){const i=s[t];if(i.GetTime()>e)return i}}GetFirstPropertyKeyFrameDataItemHigherOrEqualThan(e,t){const s=t.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray(),i=s.length;for(let t=0;t<i;t++){const i=s[t];if(i.GetTime()>=e)return i}}GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,t){const s=t.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray();for(let t=s.length-1;t>=0;t--){const i=s[t];if(i.GetTime()<=e)return i}}*propertyTrackDataItems(){for(const e of this._propertyTrackDataItems)yield e}_SaveToJson(){return{propertyTrackDataItemsJson:this._propertyTrackDataItems.map(e=>e._SaveToJson())}}_LoadFromJson(e){e&&IT.TimelineDataManager._LoadDataItemsFromJson(this._propertyTrackDataItems,e.propertyTrackDataItemsJson,OT,this)}}}{const BT=self.C3,LT=0,kT=1,VT=2,UT=3;class WT{constructor(e,t){if(this._keyframeData=t,this._time=-1,this._ease="noease",this._enable=!1,this._tags=null,this._lowerTags=null,!e)return;this._time=e[0],this._ease=e[1],this._enable=!!e[2];const s=e[3];this._tags=s?s.split(" "):[],this._lowerTags=new Set(this._tags.map(e=>e.toLowerCase())),this._next=null,this._last=null}Release(){this._keyframeData=null,BT.clearArray(this._tags),this._tags=null,this._lowerTags.clear(),this._lowerTags=null,this._next=null}GetKeyframeData(){return this._keyframeData}GetNext(){return this._next}SetNext(e){this._next=e}GetLast(){return this._last}SetLast(e){this._last=e}GetTime(){return this._time}SetTime(e){this._time=e,this._keyframeData._LinkKeyframeDataItems()}GetEase(){return this._ease}SetEase(e){this._ease=e}GetEnable(){return this._enable}SetEnable(e){this._enable=!!e}GetTags(){return this._tags}SetTags(e){this._tags=e?e.split(" "):[],this._lowerTags=new Set(this._tags.map(e=>e.toLowerCase()))}GetLowerTags(){return this._lowerTags}HasTag(e){return this._lowerTags.has(e.toLowerCase())}_SaveToJson(){return{time:this._time,ease:this._ease,enable:this._enable,tags:this._tags}}_LoadFromJson(e){e&&(this._time=e.time,this._ease=e.ease,this._enable=e.enable,this._tags=e.tags,this._lowerTags=new Set(this._tags.map(e=>e.toLowerCase())))}}BT.KeyframeData=class{constructor(e,t){this._trackDataItem=t,this._keyframeDataItems=[],BT.TimelineDataManager._CreateDataItems(this._keyframeDataItems,e,WT,this),this._LinkKeyframeDataItems()}Release(){this._trackDataItem=null;for(const e of this._keyframeDataItems)e.Release();BT.clearArray(this._keyframeDataItems),this._keyframeDataItems=null}_LinkKeyframeDataItems(){this._keyframeDataItems.sort((e,t)=>e.GetTime()-t.GetTime());for(let e=0;e<this._keyframeDataItems.length;e++){const t=this._keyframeDataItems[e];t.SetNext(this._keyframeDataItems[e+1]),t.SetLast(this._keyframeDataItems[e-1])}}GetTrackDataItem(){return this._trackDataItem}GetKeyframeDataItemCount(){return this._keyframeDataItems.length}GetKeyframeDataItemArray(){return this._keyframeDataItems}AddEmptyKeyframeDataItem(){const e=new WT(null,this);return this._keyframeDataItems.push(e),this._LinkKeyframeDataItems(),e}DeleteKeyframeDataItems(e){for(const t of this._keyframeDataItems){if(!e(t))continue;const s=this._keyframeDataItems.indexOf(t);-1!==s&&(t.Release(),this._keyframeDataItems.splice(s,1))}this.SortKeyframeDataItems(),this._LinkKeyframeDataItems()}SortKeyframeDataItems(){this._keyframeDataItems.sort((e,t)=>e.GetTime()-t.GetTime())}GetKeyframeDataItemIndex(e){return this._keyframeDataItems.indexOf(e)}GetKeyframeDataItemFromIndex(e){return this._keyframeDataItems[e]}*keyframeDataItems(){for(const e of this._keyframeDataItems)yield e}*keyframeDataItemsReverse(){for(let e=this._keyframeDataItems.length-1;e>=0;e--)yield this._keyframeDataItems[e]}_SaveToJson(){return{keyframeDataItemsJson:this._keyframeDataItems.map(e=>e._SaveToJson())}}_LoadFromJson(e){e&&(BT.TimelineDataManager._LoadDataItemsFromJson(this._keyframeDataItems,e.keyframeDataItemsJson,WT,this),this._LinkKeyframeDataItems())}}}{const HT=self.C3,zT=0,jT=0,YT=1,qT=2,XT=1,$T=2,KT=3,JT=4,QT=5;class ZT{constructor(e,t){this._propertyKeyframeData=t,this._value=null,this._aValue=null,this._type="",this._time=NaN,this._ease="noease",this._enable=!1,this._addonData=null,this._addonInstance=void 0,this._pathMode="line",e&&(this._value=e[0][0],this._aValue=e[0][1],this._type=e[0][2],this._time=e[1],this._ease=e[2],this._enable=!!e[3],this._pathMode=e[5],this._addonData=null,e[4]&&(this._addonData=new HT.AddonData(e[4],this)),this._next=null,this._prev=null)}Release(){this._propertyKeyframeData=null,this._addonData&&(this._addonData.Release(),this._addonData=null),this._next=null,this._prev=null}GetAddonData(){return this._addonData}SetNext(e){this._next=e}GetNext(){return this._next}SetPrevious(e){this._prev=e}GetPrevious(){return this._prev}GetValue(){return this._value}SetValue(e){"color"===this._type&&HT.IsFiniteNumber(e)?(this._value[0]=HT.GetRValue(e),this._value[1]=HT.GetGValue(e),this._value[2]=HT.GetBValue(e)):this._value=e}GetAbsoluteValue(){return this._aValue}SetAbsoluteValue(e){"color"===this._type&&HT.IsFiniteNumber(e)?(this._aValue[0]=HT.GetRValue(e),this._aValue[1]=HT.GetGValue(e),this._aValue[2]=HT.GetBValue(e)):this._aValue=e}GetValueWithResultMode(){const e=this._propertyKeyframeData.GetPropertyTrackDataItem().GetResultMode();return"relative"===e?this.GetValue():"absolute"===e?this.GetAbsoluteValue():void 0}GetType(){return this._type}SetType(e){this._type=e}GetTime(){return this._time}SetTime(e){this._time=e,this._propertyKeyframeData._LinkPropertyKeyframeDataItems()}GetEase(){return this._ease}SetEase(e){this._ease=e}GetEnable(){return this._enable}SetEnable(e){this._enable=!!e}GetPathMode(){return this._pathMode}GetAddOn(e){if(!this._addonData)return;if(this._addonInstance||null===this._addonInstance)return this._addonInstance;const t=this._addonData.GetAddDataItemArray();if(!t)return this._addonInstance=null,this._addonInstance;const s=t.length;for(let i=0;i<s;i++){const s=t[i];if(s.GetId()===e)return this._addonInstance=s,this._addonInstance}return this._addonInstance=null,this._addonInstance}_SaveToJson(){const e=this._addonData;return{addonDataJson:e?e._SaveToJson():e,value:this._value,aValue:this._aValue,type:this._type,time:this._time,ease:this._ease,enable:this._enable}}_LoadFromJson(e){e&&(e.addonDataJson&&this._addonData._SetFromJson(e.addonDataJson),this._value=e.value,this._aValue=e.aValue,this._type=e.type,this._time=e.time,this._ease=e.ease,this._enable=e.enable)}}HT.PropertyKeyframeData=class{constructor(e,t){this._propertyTrackDataItem=t,this._propertyKeyframeDataItems=[],this._propertyKeyframeDataItemsIncludingDisabled=[],HT.TimelineDataManager._CreateDataItems(this._propertyKeyframeDataItems,e,ZT,this),HT.TimelineDataManager._CreateDataItemsIncludingDisabled(this._propertyKeyframeDataItemsIncludingDisabled,e,ZT,this),this._LinkPropertyKeyframeDataItems()}Release(){this._propertyTrackDataItem=null;for(const e of this._propertyKeyframeDataItems)e.Release();HT.clearArray(this._propertyKeyframeDataItems),this._propertyKeyframeDataItems=null;for(const e of this._propertyKeyframeDataItemsIncludingDisabled)e.Release();HT.clearArray(this._propertyKeyframeDataItemsIncludingDisabled),this._propertyKeyframeDataItemsIncludingDisabled=null}_LinkPropertyKeyframeDataItems(){let e=this._propertyKeyframeDataItems;e.sort((e,t)=>e.GetTime()-t.GetTime());for(let t=0;t<e.length;t++){const s=e[t];t+1<e.length&&s.SetNext(e[t+1]),t-1>=0&&s.SetPrevious(e[t-1])}e=this._propertyKeyframeDataItemsIncludingDisabled,e.sort((e,t)=>e.GetTime()-t.GetTime());for(let t=0;t<e.length;t++){const s=e[t];t+1<e.length&&s.SetNext(e[t+1]),t-1>=0&&s.SetPrevious(e[t-1])}}AddEmptyPropertyKeyframeDataItem(){const e=new ZT(null,this);return this._propertyKeyframeDataItems.push(e),this._LinkPropertyKeyframeDataItems(),e}DeletePropertyKeyframeDataItems(e){for(const t of this._propertyKeyframeDataItems){if(!e(t))continue;const s=this._propertyKeyframeDataItems.indexOf(t);-1!==s&&(t.Release(),this._propertyKeyframeDataItems.splice(s,1))}this.SortPropertyKeyFrameDataItems(),this._LinkPropertyKeyframeDataItems()}SortPropertyKeyFrameDataItems(){this._propertyKeyframeDataItems.sort((e,t)=>e.GetTime()-t.GetTime())}GetPropertyTrackDataItem(){return this._propertyTrackDataItem}GetPropertyKeyframeDataItemCount(){return this._propertyKeyframeDataItems.length}GetLastPropertyKeyframeDataItem(){return this._propertyKeyframeDataItems[this._propertyKeyframeDataItems.length-1]}GetPropertyKeyframeDataItemArray(){return this._propertyKeyframeDataItems}GetPropertyKeyframeDataItemArrayIncludingDisabled(){return this._propertyKeyframeDataItemsIncludingDisabled}*propertyKeyframeDataItems(){for(const e of this._propertyKeyframeDataItems)yield e}*propertyKeyframeDataItemsReverse(){for(let e=this._propertyKeyframeDataItems.length-1;e>=0;e--)yield this._propertyKeyframeDataItems[e]}_SaveToJson(){const e=this._propertyKeyframeDataItems,t=this._propertyKeyframeDataItemsIncludingDisabled;return{propertyKeyframeDataItemsJson:e.map(e=>e._SaveToJson()),propertyKeyframeDataItemsIncludingDisabledJson:t.map(e=>e._SaveToJson())}}_LoadFromJson(e){e&&(HT.TimelineDataManager._LoadDataItemsFromJson(this._propertyKeyframeDataItems,e.propertyKeyframeDataItemsJson,ZT,this),HT.TimelineDataManager._LoadDataItemsFromJson(this._propertyKeyframeDataItemsIncludingDisabled,e.propertyKeyframeDataItemsIncludingDisabledJson,ZT,this),this._LinkPropertyKeyframeDataItems())}}}{const ex=self.C3,tx=0,sx=1;class ix{constructor(e,t){this._addonData=t,this._id=e[0],this._data=e[1]}Release(){this._addonData=null,this._data=null}GetAddonData(){return this._addonData}GetId(){return this._id}_SaveToJson(){return{id:this._id,data:this._data}}_LoadFromJson(e){e&&(this._id=e.id,this._data=e.data)}}const rx=0,nx=1,ax=2,ox=3;class lx extends ix{constructor(e,t){super(e,t),this._startAnchor=this._data[0],this._startEnable=!!this._data[1],this._endAnchor=this._data[2],this._endEnable=!!this._data[3]}Release(){super.Release()}GetStartAnchor(){return this._startAnchor}GetStartEnable(){return this._startEnable}GetEndAnchor(){return this._endAnchor}GetEndEnable(){return this._endEnable}_SaveToJson(){return Object.assign(super._SaveToJson(),{startAnchor:this._startAnchor,startEnable:!!this._startEnable,endAnchor:this._endAnchor,endEnable:!!this._endEnable})}_LoadFromJson(e){e&&(super._LoadFromJson(e),this._startAnchor=e.startAnchor,this._startEnable=!!e.startEnable,this._endAnchor=e.endAnchor,this._endEnable=!!e.endEnable)}}const hx=0,ux=1;class cx extends ix{constructor(e,t){super(e,t),this._direction=this._data[0],this._revolutions=this._data[1]}Release(){super.Release()}GetDirection(){return this._direction}GetRevolutions(){return this._revolutions}_SaveToJson(){return Object.assign(super._SaveToJson(),{direction:this._direction,revolutions:this._revolutions})}_LoadFromJson(e){e&&(super._LoadFromJson(e),this._direction=e.direction,this._revolutions=e.revolutions)}}ex.AddonData=class{constructor(e,t){this._propertyKeyframeDataItem=t,this._addonDataItems=[],ex.TimelineDataManager._CreateDataItems(this._addonDataItems,e,{prop:0,map:new Map([["cubic-bezier",lx],["angle",cx]])},this)}Release(){this._propertyKeyframeDataItem=null;for(const e of this._addonDataItems)e.Release();ex.clearArray(this._addonDataItems),this._addonDataItems=null}GetPropertyKeyframeDataItem(){return this._propertyKeyframeDataItem}GetAddDataItemArray(){return this._addonDataItems}*addonDataItems(){for(const e of this._addonDataItems)yield e}_SaveToJson(){return{addonDataItemsJson:this._addonDataItems.map(e=>e._SaveToJson())}}_LoadFromJson(e){e&&ex.TimelineDataManager._LoadDataItemsFromJson(this._addonDataItems,e.addonDataItemsJson,{prop:"id",map:new Map([["cubic-bezier",lx],["angle",cx]])},this)}}}{const dx=self.C3,px="start-value",_x="current-state",mx=0,fx=1;let gx=0;dx.TweenState=class extends dx.TimelineState{constructor(e,t){super("tween-"+gx++,e,t),this._id="",this._destroyInstanceOnComplete=!1,this._initialValueMode="start-value",this._instance=null,this._on_completed_callbacks=null,this._on_started_callbacks=null,this._behInst=null,this._track=null,this._iTweenState=null}FireReleaseEvent(e){const t=dx.New(dx.Event,"tweenstatereleased");t.tweenState=this,e.dispatchEvent(t)}GetType(){return 1}CreateTrackStates(){for(const e of this._timelineDataItem.GetTrackData().trackDataItems())this._tracks.push(dx.TweenTrackState.Create(this,e));this._track=this._tracks[0]}AddTrack(){const e=this._timelineDataItem.GetTrackData().AddEmptyTrackDataItem(),t=dx.TweenTrackState.Create(this,e);return this._tracks.push(t),this._CacheTrack(),t}_CacheTrack(){this._track=this._tracks[0]}GetPropertyTrack(e){return this._track.GetPropertyTracks()[0]}SetPropertyType(e){this._propertyType=e}GetInstance(){const e=this.GetTracks();if(!e||!e.length)return;const t=e[0];if(this._track=t,!t)return;const s=t.GetInstance();return t.IsInstanceValid()?s:void 0}SetBehaviorInstance(e){this._behInst=e}AddStartedCallback(e){this._on_started_callbacks||(this._on_started_callbacks=[]),this._on_started_callbacks.push(e)}AddCompletedCallback(e){this._on_completed_callbacks||(this._on_completed_callbacks=[]),this._on_completed_callbacks.push(e)}RemoveStartedCallback(e){if(!this._on_started_callbacks)return;const t=this._on_started_callbacks.indexOf(e);-1!==t&&this._on_started_callbacks.splice(t,1)}RemoveCompletedCallback(e){if(!this._on_completed_callbacks)return;const t=this._on_completed_callbacks.indexOf(e);-1!==t&&this._on_completed_callbacks.splice(t,1)}SetStartValue(e,t){for(const s of this._tracks)for(const i of s._propertyTracks){if(i.GetPropertyName()!==t)continue;const s=i.GetPropertyTrackData(),r=i.GetPropertyTrackDataItem(),n=s.GetFirstPropertyKeyframeDataItem(r);n.SetValue(e),n.SetAbsoluteValue(e)}}_GetPropertyTrackState(e){for(const t of this._tracks)for(const s of t._propertyTracks)if(s.GetPropertyName()===e)return s}BeforeSetEndValues(e){let t=!1;for(const s of e){const e=this._GetPropertyTrackState(s);e&&(this.SetStartValue(e.GetCurrentState(),s),t=!0)}if(t){if(this.IsForwardPlayBack()){const e=this.GetTotalTime()-this.GetTime();this.SetTotalTime(e);for(const t of this._tracks)t.SetLocalTotalTime(e);this._SetTime(0)}else{const e=this.GetTime();this.SetTotalTime(e);for(const t of this._tracks)t.SetLocalTotalTime(e);this._SetTime(e)}this.SetInitialStateFromSetTime()}}SetEndValue(e,t){const s=this._GetPropertyTrackState(t);if(!s)return;const i=s.GetPropertyTrackData(),r=s.GetPropertyTrackDataItem(),n=i.GetLastPropertyKeyframeDataItem(r);n.SetTime(this.GetTotalTime()),n.SetValue(e),n.SetAbsoluteValue(e)}SetId(e){this._id=e}GetId(){return this._id}SetInitialValueMode(e){this._initialValueMode=e}GetInitialValueMode(){return this._initialValueMode}SetDestroyInstanceOnComplete(e){this._destroyInstanceOnComplete=e}GetDestroyInstanceOnComplete(){return this._destroyInstanceOnComplete}OnStarted(){if(this._on_started_callbacks)for(const e of this._on_started_callbacks)e(this);if(!this.IsComplete())for(const e of this._tracks)e.CompareSaveStateWithCurrent()}OnCompleted(){this._completedTick=this._runtime.GetTickCount()}FinishTriggers(){if(!this._finishedTriggers&&(this._finishedTriggers=!0,this._on_completed_callbacks))for(const e of this._on_completed_callbacks)e(this)}SetTime(e){this._DeleteIntermediateKeyframes(),super.SetTime(e)}_SetTimeAndReset(e){dx.IsFiniteNumber(e)||(e=this.GetTotalTime()),e<0?this._playheadTime=0:e>=this.GetTotalTime()?this._playheadTime=this.GetTotalTime():this._playheadTime=e,this._track.SetResetState()}SetInitialState(e){if(!this.InitialStateSet()&&"current-state"===this.GetInitialValueMode())for(const e of this._tracks)e.CompareInitialStateWithCurrent();super.SetInitialState(e)}Stop(e=!1){if(super.Stop(e),!this.IsComplete())for(const e of this._tracks)e.SaveState()}Reset(e=!0,t=!1){this._DeleteIntermediateKeyframes(),super.Reset(e,t)}_DeleteIntermediateKeyframes(){for(const e of this._tracks){const t=e=>{const t=e.GetTime(),s=this.GetTotalTime();return 0!==t&&t!==s};e.DeleteKeyframes(t),e.DeletePropertyKeyframes(t)}}_OnBeforeChangeLayout(){if(this.IsReleased())return!0;const e=this.GetInstance();return!(e&&e.GetObjectClass().IsGlobal()||(this._timelineManager.CompleteTimelineBeforeChangeOfLayout(this),this.ResetBeforeChangeLayout(),0))}Tick(e,t,s){if(this._instance||(this._instance=this.GetInstance()),!this._instance||this._instance.IsDestroyed())return this.Stop(!0),void this.OnCompleted();const i=this._instance.GetTimeScale();if(-1!==i&&(e=s*i),0===e&&0===this._lastDelta)return;this._lastDelta=e;const r=this._playheadTime+this._overshoot+e*this._playbackRate,n=this._timelineDataItem._totalTime;r<0?(this._playheadTime=0,this._overshoot=-r):r>=n?(this._playheadTime=n,this._overshoot=this._playheadTime-r):(this._playheadTime=r,this._overshoot=0);let a=!1,o=!1;const l=this.GetLoop(),h=this.GetPingPong();if(l||h?l&&!h?this._playbackRate>0?this._playheadTime>=n&&(this._SetTimeAndReset(0),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnTweensLoop),o=!0):this._playheadTime<=0&&(this._SetTimeAndReset(n),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnTweensLoop),o=!0):!l&&h?this._playbackRate>0?this._playheadTime>=n&&(this._SetTime(n),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,1===this._pingPongState?this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnTweensLoop),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnTweensPingPong),this.IsPlaying()?this._pingPongState=0:this._resumePingPongState=0):(this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnTweensPingPong),a=!0):0===this._pingPongState&&(this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnTweensPingPong),this.IsPlaying()?this._pingPongState=1:this._resumePingPongState=1)):this._playheadTime<=0&&(this._SetTime(0),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,1===this._pingPongState?this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnTweensLoop),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnTweensPingPong),this.IsPlaying()?this._pingPongState=0:this._resumePingPongState=0):(a=!0,this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnTweensPingPong)):0===this._pingPongState&&(this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnTweensPingPong),this.IsPlaying()?this._pingPongState=1:this._resumePingPongState=1)):l&&h&&(this._playbackRate>0?this._playheadTime>=n&&(this._SetTime(n),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,0===this._pingPongState&&(this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnTweensPingPong)),1===this._pingPongState&&(this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnTweensLoop),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnTweensPingPong)),this.IsPlaying()?(this._pingPongState++,this._pingPongState=dx.wrap(this._pingPongState,0,2)):(this._resumePingPongState=this._pingPongState+1,this._resumePingPongState=dx.wrap(this._resumePingPongState,0,2))):this._playheadTime<=0&&(this._SetTime(0),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,0===this._pingPongState&&(this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnTweensPingPong)),1===this._pingPongState&&(this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnTweensLoop),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnTweensPingPong)),this.IsPlaying()?(this._pingPongState++,this._pingPongState=dx.wrap(this._pingPongState,0,2)):(this._resumePingPongState=this._pingPongState+1,this._resumePingPongState=dx.wrap(this._resumePingPongState,0,2)))):this._playbackRate>0?this._playheadTime>=n&&(this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._SetTimeAndReset(0),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnTweensLoop),o=!0):(this._SetTime(n),a=!0)):this._playheadTime<=0&&(this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._SetTimeAndReset(n),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(dx.Behaviors.Tween.Cnds.OnTweensLoop),o=!0):(this._SetTime(0),a=!0)),!this.IsReleased()&&this.IsPlaying()){if(a)return this._track.SetEndState(),this.Stop(!0),void this.OnCompleted();this._track.Interpolate(this._playheadTime,!0,!1,o,this._firstTick,!1),this._firstTick&&(this._firstTick=!1)}}_TweenTrigger(e){const t=this.GetInstance();this._behInst.PushTriggerTween(this),this._runtime.Trigger(e,t,this._behInst.GetBehaviorType()),this._behInst.PopTriggerTween()}_SaveToJson(){const e=super._SaveToJson(),t=this.GetTimelineDataItem();return Object.assign(e,{tweenDataItemJson:t._SaveToJson(),id:this._id,destroyInstanceOnComplete:this._destroyInstanceOnComplete,initialValueMode:this._initialValueMode})}_LoadFromJson(e){e&&(this.GetTimelineDataItem()._LoadFromJson(e.tweenDataItemJson),super._LoadFromJson(e),this._id=e.id,this._destroyInstanceOnComplete=e.destroyInstanceOnComplete,this._initialValueMode=e.initialValueMode,this._CacheTrack())}static IsPlaying(e){return e.IsPlaying()}static IsPaused(e){return e.IsPaused()}static IsPing(e){return!!e.GetPingPong()&&0===e.GetPingPongState()}static IsPong(e){return!!e.GetPingPong()&&1===e.GetPingPongState()}static Build(e){const t=e.runtime.GetTimelineManager(),s=new dx.TimelineDataItem;if(e.json){s._LoadFromJson(e.json.tweenDataItemJson);const i=new dx.TweenState(s,t);return i._LoadFromJson(e.json),i}{const i=new dx.TweenState(s,t);dx.IsArray(e.propertyTracksConfig)||(e.propertyTracksConfig=[e.propertyTracksConfig]),i.SetId(e.id),i.SetTags(e.tags),i.SetInitialValueMode(e.initialValueMode),i.SetDestroyInstanceOnComplete(e.releaseOnComplete),i.SetLoop(e.loop),i.SetPingPong(e.pingPong),i.SetTotalTime(e.time),i.SetStep(0),i.SetInterpolationMode("default"),i.SetResultMode(e.propertyTracksConfig[0].resultMode),i.SetRepeatCount(e.repeatCount);const r=i.AddTrack();r.SetInstanceUID(e.instance.GetUID()),r.SetInterpolationMode("default"),r.SetResultMode(e.propertyTracksConfig[0].resultMode),r.SetEnable(!0),r.SetObjectClassIndex(e.instance.GetObjectClass().GetIndex());const n=e.instance.GetSdkInstance(),a=n.IsOriginalSizeKnown()?n.GetOriginalWidth():e.instance.GetWorldInfo().GetWidth(),o=n.IsOriginalSizeKnown()?n.GetOriginalHeight():e.instance.GetWorldInfo().GetHeight();r.SetOriginalWidth(a),r.SetOriginalHeight(o);const l=r.AddKeyframe();l.SetTime(0),l.SetEase("noease"),l.SetEnable(!0),l.SetTags("");const h=r.AddKeyframe();h.SetTime(e.time),h.SetEase("noease"),h.SetEnable(!0),h.SetTags("");for(const t of e.propertyTracksConfig){const s=r.AddPropertyTrack();s.SetSourceAdapterId(t.sourceId),s.SetSourceAdapterArgs(t.sourceArgs),s.SetPropertyName(t.property),s.SetPropertyType(t.type),s.SetMin(NaN),s.SetMax(NaN),s.SetInterpolationMode("default"),s.SetResultMode(t.resultMode),s.SetEnable(!0);const i=s.AddPropertyKeyframe();i.SetType(t.valueType),i.SetTime(0),i.SetEase(t.ease),i.SetEnable(!0),i.SetValue(t.startValue),i.SetAbsoluteValue(t.startValue);const n=s.AddPropertyKeyframe();n.SetType(t.valueType),n.SetTime(e.time),n.SetEase(t.ease),n.SetEnable(!0),n.SetValue(t.endValue),n.SetAbsoluteValue(t.endValue),s.GetSourceAdapter()}return i}}static SetInstanceUID(e,t){if(!isNaN(t))for(const s of e.GetTracks())s.SetInstanceUID(t)}static SetBehaviorInstance(e,t){e.SetBehaviorInstance(t)}GetITweenState(e,t){return this._iTweenState||(this._iTweenState=dx.New(self.ITweenState,this,e,t)),this._iTweenState}}}{const yx=self.C3;yx.TweenTrackState=class extends yx.TrackState{constructor(e,t){super(e,t),this._firstPropertyTrack=null,this._secondPropertyTrack=null}static Create(e,t){return yx.New(yx.TweenTrackState,e,t)}_CachePropertyTracks(){1===this._propertyTracks.length?this._firstPropertyTrack=this._propertyTracks[0]:(this._firstPropertyTrack=this._propertyTracks[0],this._secondPropertyTrack=this._propertyTracks[1])}CreatePropertyTrackStates(){for(const e of this._trackDataItem.GetPropertyTrackData().propertyTrackDataItems())this._propertyTracks.push(yx.TweenPropertyTrackState.Create(this,e));this._CachePropertyTracks()}AddPropertyTrack(){const e=this._trackDataItem.GetPropertyTrackData().AddEmptyPropertyTrackDataItem(),t=yx.TweenPropertyTrackState.Create(this,e);return this._propertyTracks.push(t),this._CachePropertyTracks(),t}SetInitialState(){if(this.MaybeGetInstance(),!this.IsInstanceValid()&&this.IsInstanceTrack())return;const e=this.GetTimeline().IsForwardPlayBack()?0:this.GetLocalTotalTime();for(const t of this._propertyTracks)t.SetInitialState(e),0===this._worldInfoChange&&1===t.GetWorldInfoChange()&&(this._worldInfoChange=1),0===this._renderChange&&1===t.GetRenderChange()&&(this._renderChange=1);this._needsBeforeAndAfter=0,this._propertyTracks.some(e=>e.GetNeedsBeforeAndAfter())&&(this._needsBeforeAndAfter=1),this._lastKeyframeDataItem=this._GetLastKeyFrameBeforeTime(e),this._initialStateOfNestedSet=!1,this._endStateOfNestedSet=!1,this.Interpolate(e)}BeforeInterpolate(){}Interpolate(e,t=!1,s=!1,i=!1,r=!1,n=!1,a=!1){if(this._instance||this.GetInstance(),this._instance)return!this._instance.IsDestroyed()&&(!n||!this.GetObjectClass().IsGlobal())&&(this._secondPropertyTrack?(this._firstPropertyTrack.Interpolate(e,s,i,a),this._secondPropertyTrack.Interpolate(e,s,i,a)):this._firstPropertyTrack.Interpolate(e,s,i,a),void(0!==this._firstPropertyTrack.GetWorldInfoChange()&&(this._worldInfo||(this._worldInfo=this._instance.GetWorldInfo()),this._worldInfo&&this._worldInfo.SetBboxChanged())))}AfterInterpolate(){}_LoadFromJson(e){super._LoadFromJson(e),this._CachePropertyTracks()}}}{const Sx=self.C3;Sx.TweenPropertyTrackState=class extends Sx.PropertyTrackState{constructor(e,t){super(e,t),this._basic=!1}static Create(e,t){return Sx.New(Sx.TweenPropertyTrackState,e,t)}Interpolate(e,t=!1,s=!1,i=!1){let r,n;if(this._basic)r=this._propertyKeyframeDataItems[0],n=this._propertyKeyframeDataItems[1];else if(t)r=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem),n=r.GetNext();else{if(this._lastPropertyKeyframeDataItem){const t=this.GetTimeline(),s=this._lastPropertyKeyframeDataItem.GetNext(),i=this._lastPropertyKeyframeDataItem.GetTime(),r=s?s.GetTime():t.GetTotalTime();(e<=i||e>=r)&&(this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem))}else this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem);r=this._lastPropertyKeyframeDataItem,n=r.GetNext()}this._sourceAdapter.Interpolate(e,r,n,t,s,i)}AddPropertyKeyframe(){const e=this._propertyTrackDataItem.GetPropertyKeyframeData().AddEmptyPropertyKeyframeDataItem();return this._lastPropertyKeyframeDataItem=null,this._basic=this.GetPropertyKeyframeDataItems().length<=2,e}DeletePropertyKeyframes(e){this._lastPropertyKeyframeDataItem=null,this._propertyTrackDataItem.GetPropertyKeyframeData().DeletePropertyKeyframeDataItems(e),this._basic=this.GetPropertyKeyframeDataItems().length<=2}_SaveToJson(){return{sourceAdapterJson:this.GetSourceAdapter()._SaveToJson(),basic:this._basic}}_LoadFromJson(e){e&&(this.GetSourceAdapter()._LoadFromJson(e.sourceAdapterJson),this._basic=e.basic)}}}{const Tx=self.C3,xx=self.Ease,bx=0,Gx=1,Ix=2;Tx.Transition=class extends Tx.DefendedBase{constructor(e,t=!0){super(),this._name=e[0],this._linear=e[2],this._transitionKeyframes=[];for(const t of e[1]){const e=Tx.TransitionKeyframe.Create(this,t);this._transitionKeyframes.push(e)}for(let e=0;e<this._transitionKeyframes.length;e++){const t=this._transitionKeyframes[e],s=this._transitionKeyframes[e+1],i=this._transitionKeyframes[e-1];t.SetNext(s),t.SetPrevious(i)}this._precalculatedSamples=new Map,this._transitionKeyframeCache=new Map,this._PreCalcSamples(),t&&xx.AddCustomEase(this._name,(e,t,s,i)=>this.Interpolate(e,t,s,i),null,{transition:this})}static Create(e){return Tx.New(Tx.Transition,e)}Release(){for(const e of this._transitionKeyframes)e.Release();Tx.clearArray(this._transitionKeyframes),this._transitionKeyframes=null,this._precalculatedSamples.clear(),this._precalculatedSamples=null,this._transitionKeyframeCache.clear(),this._transitionKeyframeCache=null}MakeLinear(e){this._linear=!!e}GetTransitionKeyFrameAt(e){const t=this._transitionKeyframeCache.get(e);if(t)return t;for(const t of this._transitionKeyframes)if(t.GetValueX()===e)return this._transitionKeyframeCache.set(e,t),t}GetFirstTransitionKeyFrameLowerOrEqualThan(e){for(let t=this._transitionKeyframes.length-1;t>=0;t--){const s=this._transitionKeyframes[t],i=s.GetValueX();if(i<=e){let t=s;if(i<e)return t;if(i===e){for(;t;){const e=t.GetPrevious();if(!e)break;if(e.GetValueX()!==t.GetValueX())break;t=e}return t}}}}Interpolate(e,t,s,i){let r=e/i;if(this._linear){const r=this.GetTransitionKeyFrameAt(0),n=this.GetTransitionKeyFrameAt(1),a=t+(t+s)*r.GetValueY(),o=(t+s)*n.GetValueY()-a;return 0===i?a+o:xx.NoEase(e,a,o,i)}0===i&&(r=1);let n=this.GetFirstTransitionKeyFrameLowerOrEqualThan(r),a=n.GetNext();if(!a){const e=n.GetPrevious(),t=n;n=e,a=t}const o=a.GetValueX()-n.GetValueX(),l=Tx.mapToRange(r,n.GetValueX(),a.GetValueX(),0,o);if(n.IsSegmentLinear()||0===o){const e=t+(t+s)*n.GetValueY(),i=(t+s)*a.GetValueY()-e;return 0===o?1===l?e+i:e:xx.NoEase(l,e,i,o)}const h=n.GetValueX(),u=n.GetValueY(),c=n.GetValueX()+n.GetStartAnchorX(),d=n.GetValueY()+n.GetStartAnchorY(),p=a.GetValueX()+a.GetEndAnchorX(),_=a.GetValueY()+a.GetEndAnchorY(),m=a.GetValueX(),f=a.GetValueY();let g=xx.GetRuntimeEase("spline")(l,h,u,c,d,p,_,m,f,this._precalculatedSamples.get(n));return g+=n.GetValueY(),(1-g)*t+g*(t+s)}_PreCalcSamples(){this._precalculatedSamples.clear();for(let e=0;e<this._transitionKeyframes.length-1;e++){const t=this._transitionKeyframes[e];if(!t.GetStartEnable())continue;const s=t,i=this._transitionKeyframes[e+1];if(!i.GetEndEnable())continue;const r=s.GetValueX(),n=s.GetValueX()+s.GetStartAnchorX(),a=i.GetValueX()+i.GetEndAnchorX(),o=i.GetValueX();this._precalculatedSamples.set(s,xx.GetBezierSamples(r,n,a,o))}}}}{const vx=self.C3,Cx=0,wx=1,Ax=2,Rx=3,Px=4,Mx=5,Ex=6,Dx=7,Nx=8;vx.TransitionKeyframe=class extends vx.DefendedBase{constructor(e,t){super(),this._transition=e,this._valueX=t[0],this._valueY=t[1],this._startAnchorX=t[2],this._startAnchorY=t[3],this._endAnchorX=t[4],this._endAnchorY=t[5],this._startEnable=t[6],this._endEnable=t[7],this._segmentMode=t[8],this._next=null,this._prev=null}Release(){this._transition=null}static Create(e,t){return vx.New(vx.TransitionKeyframe,e,t)}SetNext(e){this._next=e}GetNext(){return this._next}SetPrevious(e){this._prev=e}GetPrevious(){return this._prev}GetValueX(){return this._valueX}GetValueY(){return this._valueY}GetStartAnchorX(){return this._startAnchorX}GetStartAnchorY(){return this._startAnchorY}GetEndAnchorX(){return this._endAnchorX}GetEndAnchorY(){return this._endAnchorY}GetStartEnable(){return this._startEnable}GetEndEnable(){return this._endEnable}IsSegmentLinear(){return"linear"===this._segmentMode}IsSegmentCubic(){return"cubic"===this._segmentMode}}}{const Fx=self.C3;Fx.TransitionManager=class extends Fx.DefendedBase{constructor(e){super(),this._runtime=e,this._transitions=[]}Release(){for(const e of this._transitions)e.Release();Fx.clearArray(this._transitions),this._transitions=null}Create(e){this._transitions.push(Fx.Transition.Create(e))}}}{const Ox=self.C3;Ox.TemplateManager=class extends Ox.DefendedBase{constructor(e){super(),this._runtime=e,this._templateDataMap=null,this._instanceToTemplateNameMap=null,this._instanceDestroy=e=>this._OnInstanceDestroy(e.instance)}Release(){if(this.RemoveRuntimeListeners(),this._templateDataMap){for(const e of this._templateDataMap.values())e.clear();this._templateDataMap.clear()}this._templateDataMap=null,this._runtime=null}Create(e){if(this._templateDataMap||(this._templateDataMap=new Map),!e)return;const t=e[0][16][0],s=e[1];this._templateDataMap.has(s)||this._templateDataMap.set(s,new Map),this._templateDataMap.get(s).set(t,e)}AddRuntimeListeners(){const e=this._runtime.Dispatcher();e&&e.addEventListener("instancedestroy",this._instanceDestroy)}RemoveRuntimeListeners(){const e=this._runtime.Dispatcher();e&&e.removeEventListener("instancedestroy",this._instanceDestroy)}HasTemplates(){return!!this._templateDataMap&&0!==this._templateDataMap.size}GetTemplateData(e,t){let s=0;if(s=e instanceof Ox.ObjectClass?e.GetIndex():e,!this._templateDataMap.has(s))return;const i=this._templateDataMap.get(s).get(t);return i?JSON.parse(JSON.stringify(i)):void 0}MapInstanceToTemplateName(e,t){this._instanceToTemplateNameMap||(this._instanceToTemplateNameMap=new WeakMap),this._instanceToTemplateNameMap.has(e)||this._instanceToTemplateNameMap.set(e,t)}GetInstanceTemplateName(e){if(!this._instanceToTemplateNameMap)return"";return this._instanceToTemplateNameMap.get(e)||""}_OnInstanceDestroy(e){this._instanceToTemplateNameMap&&this._instanceToTemplateNameMap.has(e)&&this._instanceToTemplateNameMap.delete(e)}}}{const Bx=self.C3;Bx.FlowchartManager=class{constructor(e){this._runtime=e,this._flowchartDataManager=new Bx.FlowchartDataManager}Release(){this._flowchartDataManager.Release(),this._flowchartDataManager=null,this._runtime=null}GetRuntime(){return this._runtime}Create(e){this._flowchartDataManager.Add(e)}GetFlowchartDataItemByName(e){return this._flowchartDataManager.Get(e)}HasFlowcharts(){return this._flowchartDataManager.HasFlowcharts()}}}{const Lx=self.C3;Lx.FlowchartState=class{constructor(e,t,s,i,r,n,a){this._runtime=r.GetRuntime(),this._flowchartManager=r,this._flowchartName=e,this._startNodeTag=s,this._flowchartDataItem=i,this._tag=t,this._pluginInstance=n,this._pluginUID=a??n.GetInstance().GetUID(),this._SetStartFlowchartNode(),this._currentFlowchartNodeId=this._startFlowchartNode?.GetFlowchartId()??-1,this._previousFlowchartNodeIds=[],this._previousFlowchartState=null,this._previousFlowchartStateStartNodeId=NaN,this._referenceFlowchartStates=null,this._currentReferenceFlowchartState=null,this._rootFlowchartState=null,this._previousFlowchartStateTag="",this._referenceFlowchartStatesJson=null,this._currentReferenceFlowchartStateTag="",this._rootFlowchartStateTag="",this._triggerCount=0,this._markForRelease=!1,this._released=!1}Release(){this._released||(Lx.clearArray(this._previousFlowchartNodeIds),this._previousFlowchartNodeIds=null,this._runtime=null,this._flowchartManager=null,this._flowchartDataItem=null,this._pluginInstance=null,this._previousFlowchartState=null,this._previousFlowchartStateStartNodeId=NaN,this._referenceFlowchartStates&&this._referenceFlowchartStates.clear(),this._referenceFlowchartStates=null,this._currentReferenceFlowchartState=null,this._rootFlowchartState=null,this._previousFlowchartStateTag="",this._referenceFlowchartStatesJson=null,this._currentReferenceFlowchartStateTag="",this._rootFlowchartStateTag="",this._released=!0)}WasReleased(){return this._released}GetFlowchartManager(){return this._flowchartManager}GetRuntime(){return this._runtime}GetName(){return this._flowchartName}GetFlowchartDataItem(){return this._flowchartDataItem}GetTag(){return this._tag}GetPluginInstance(){return this._pluginInstance||(this._pluginInstance=this._runtime.GetInstanceByUID(this._pluginUID).GetSdkInstance()),this._pluginInstance}GetCurrentNode(){return this.GetFlowchartElementById(this._currentFlowchartNodeId)}GetCurrentNodeTag(){const e=this.GetCurrentNode();return e?e.GetTag():""}GetCurrentNodeTags(){const e=this.GetCurrentNode();return e?e.GetTags():[]}CurrentNodeHasTags(e){const t=this.GetCurrentNodeTags();if(!t)return!1;if(!t.length)return!1;const s=Lx.FlowchartState._GetTagArray(e);return!(!s||!s.length)&&s.every(Lx.FlowchartState._HasTag,t)}CurrentNodeCompareTags(e,t){const s=this.GetCurrentNodeTags();if(!s)return!1;if(!s.length)return!1;const i=Lx.FlowchartState._GetTagArray(e);return!(!i||!i.length)&&i.every(e=>Lx.FlowchartState._CompareTag.call(s,e,t))}static _HasTag(e){const t=this;return""===e?1===t.length&&""===t[0]:t.map(e=>e.trim().toLowerCase()).includes(e.trim().toLowerCase())}static _GetTagArray(e){return e.trim().split(" ")}static _CompareTag(e,t){const s=this;return""===e?1===s.length&&""===s[0]:s.some(s=>Lx.compare(s.trim(),t,e.trim()))}GetCurrentNodeParent(e){const t=this.GetCurrentNode();if(t){if(Lx.IsFiniteNumber(e)){const s=t.GetParentFlowchartIds(),i=s?s[e]:void 0;if(Lx.IsFiniteNumber(i))return this.GetFlowchartElementById(i)}if("string"==typeof e)for(const s of t.GetParentFlowchartIds()){const t=this.GetFlowchartElementById(s);if(t.HasTags(e))return this.GetFlowchartElementById(t.GetFlowchartId())}}}GetCurrentNodeParentTag(e){const t=this.GetCurrentNodeParent(e);return t?t.GetTag():""}GetCurrentNodeParentTags(e){const t=this.GetCurrentNodeParent(e);return t?t.GetTags():""}GetCurrentNodeParentIndex(e){const t=this.GetCurrentNode();if(!t)return-1;const s=t.GetParentFlowchartIds();if(!s)return-1;const i=this.GetCurrentNodeParent(e);return i?s.indexOf(i.GetFlowchartId()):-1}GetCurrentNodeParentCount(){const e=this.GetCurrentNode();if(!e)return 0;const t=e.GetParentFlowchartIds();return t?t.length:0}GetFlowchartElementById(e){return this._flowchartDataItem.GetFlowchartElementById(e)}Reset(){this._GetRootFlowchartState()._Reset(!0)}_Reset(e){if(this._GetReferenceFlowchartStates()){for(const[e,t]of this._GetReferenceFlowchartStates().entries())t._Reset(!1);this._GetReferenceFlowchartStates().clear()}if(this._referenceFlowchartStates=null,this._previousFlowchartState=null,this._previousFlowchartStateStartNode=null,this._currentReferenceFlowchartState=null,this._previousFlowchartStateTag="",this._referenceFlowchartStatesJson=null,this._currentReferenceFlowchartStateTag="",this._rootFlowchartStateTag="",this._previousFlowchartNodeIds=[],e){this._flowchartManager.SetCurrentFlowchartState(this);const e=this._startFlowchartNode.GetFlowchartId();e!==this._currentFlowchartNodeId&&this._GotoFlowchartNode(e)}else this._currentFlowchartNodeId=this._startFlowchartNode.GetFlowchartId()}GetCurrentNodeOutputCount(){const e=this._flowchartDataItem.GetFlowchartElementById(this._currentFlowchartNodeId);return e?e.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDataItemCount():0}IsIndexOfDefaultOutput(e){return!(e<0)&&e===this.GetDefaultOutputIndex()}GetDefaultOutputIndex(){const e=this._flowchartDataItem.GetFlowchartElementById(this._currentFlowchartNodeId);if(!e)return-1;let t=e.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDefault();return t?e.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDataItems().indexOf(t):-1}GetCurrentNodeOutputNameAt(e){const t=this._GetFlowchartNodeOutputAt(e);return t?t.GetName():""}GetCurrentNodeOutputValueAt(e){let t;return Lx.IsFiniteNumber(e)&&(t=this._GetFlowchartNodeOutputAt(e)),"string"==typeof e&&(t=this._GetFlowchartNodeOutputByName(e)),"number"!=typeof e&&"string"!=typeof e&&console.warn("[Flowcharts] unexpected argument type in GetCurrentNodeOutputValueAt expression"),t?t.GetValue():""}_MaybeByPassNodes(e,t){if(e.GetEnable())return e.GetFlowchartId();{const s=e.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDefault();if(!s)return t.GetFlowchartId();const i=s.GetConnectedFlowchartNodeFlowchartId();if(!Lx.IsFiniteNumber(i))return t.GetFlowchartId();const r=this.GetFlowchartElementById(i);return r?this._MaybeByPassNodes(r,t):t.GetFlowchartId()}}_MaybeByPassNodesInReferenceFlowchart(e,t){if(e.GetEnable()){if("reference"===e.GetType()){const t=e.GetReferenceFlowchartName(),s=e.GetReferenceFlowchartStartNodeTag(),i=this._flowchartManager.GetFlowchartDataItemByName(t);if(!i)return[-1,null];const r=i.GetFlowchartNodeByTags(s);return r?this._MaybeByPassNodesInReferenceFlowchart(r,i):this._MaybeByPassNodesInReferenceFlowchart(i.GetFlowchartStartNode(),i)}return[e.GetFlowchartId(),t]}{const s=e.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDefault();if(!s)return[-1,null];const i=s.GetConnectedFlowchartNodeFlowchartId();if(!Lx.IsFiniteNumber(i))return[-1,null];const r=t.GetFlowchartElementById(i);return r?this._MaybeByPassNodesInReferenceFlowchart(r,t):[-1,null]}}_ProcessAllByPasses(e,t){let s=this.GetFlowchartElementById(e);if(s){if(!s.GetEnable()){const t=this.GetFlowchartElementById(this._currentFlowchartNodeId);e=this._MaybeByPassNodes(s,t)}if(Lx.IsFiniteNumber(e)&&e!==this._currentFlowchartNodeId)if(s=this.GetFlowchartElementById(e),"reference"===s.GetType()){const i=s.GetReferenceFlowchartName(),r=s.GetReferenceFlowchartStartNodeTag(),n=this._flowchartManager.GetFlowchartDataItemByName(i);let a=n.GetFlowchartNodeByTags(r);if(a){const s=this._MaybeByPassNodesInReferenceFlowchart(a,n);if(-1===s[0])return;t(this._currentFlowchartNodeId,e,s[1],s[0])}else t(this._currentFlowchartNodeId,e)}else t(this._currentFlowchartNodeId,e)}}GotoNextFlowchartNode(e){let t;if(Lx.IsFiniteNumber(e)&&(t=this._GetFlowchartNodeOutputAt(e)),"string"==typeof e&&(t=this._GetFlowchartNodeOutputByName(e)),!t)return;let s=t.GetConnectedFlowchartNodeFlowchartId();Lx.IsFiniteNumber(s)&&this._ProcessAllByPasses(s,(e,t,s,i)=>{this._previousFlowchartNodeIds.push(e),this._GotoFlowchartNode(t,s,i)})}GotoNextFlowchartNodeDefault(){const e=this._GetFlowchartNodeOutputDefault();if(!e)return;const t=e.GetConnectedFlowchartNodeFlowchartId();Lx.IsFiniteNumber(t)&&this._ProcessAllByPasses(t,(e,t,s,i)=>{this._previousFlowchartNodeIds.push(e),this._GotoFlowchartNode(t,s,i)})}GotoAnyFlowchartNode(e){const t=this._flowchartDataItem.GetFlowchartNodeByTags(e);if(!t)return;const s=t.GetFlowchartId();Lx.IsFiniteNumber(s)&&this._ProcessAllByPasses(s,(e,t,s,i)=>{this._previousFlowchartNodeIds.push(e),this._GotoFlowchartNode(t,s,i)})}GotoPreviousFlowchartNode(){const e=this._previousFlowchartNodeIds.pop();Lx.IsFiniteNumber(e)?this._GotoFlowchartNode(e):this._GetPreviousFlowchartState()&&(this._flowchartManager.SetCurrentFlowchartState(this._GetPreviousFlowchartState(),!0,!1,!1),this._GetPreviousFlowchartState()._GotoFlowchartNode(this._GetPreviousFlowchartStateStartNodeId()),this._GetRootFlowchartState()._SetCurrentReferenceFlowchart(this._GetPreviousFlowchartState()))}GotoParentFlowchartNode(e){if(!this.GetCurrentNode())return;const t=this.GetCurrentNodeParent(e);if(t){if(!t.GetEnable())return;const e=t.GetFlowchartId();if(!Lx.IsFiniteNumber(e))return;this._previousFlowchartNodeIds.push(this._currentFlowchartNodeId),this._GotoFlowchartNode(t.GetFlowchartId())}}HasOutput(e){if(Lx.IsFiniteNumber(e))return!!this._flowchartDataItem.GetFlowchartElementById(this._currentFlowchartNodeId).GetFlowchartNodeOutputData().GetFlowchartNodeOutputDataItems()[e];if("string"==typeof e){const t=this._flowchartDataItem.GetFlowchartElementById(this._currentFlowchartNodeId).GetFlowchartNodeOutputData().GetFlowchartNodeOutputDataItems();for(let s=0;s<t.length;s++)if(t[s].GetName()===e)return!0;return!1}return!1}MarkForRelease(){this._markForRelease=!0}IsInTriggerState(){return this._triggerCount>0}PushIsTriggerState(){this._triggerCount++}PopIsTriggerState(){this._triggerCount--,0===this._triggerCount&&this._markForRelease&&this._flowchartManager.RemoveFlowchartState(this)}_GotoFlowchartNode(e,t,s){const i=this._currentFlowchartNodeId,r=this.GetPluginInstance().GetInstance();this.PushIsTriggerState(),this._flowchartManager.PushFlowchartState(this),this._runtime.Trigger(Lx.Plugins.Flowchart.Cnds.OnBeforeAnyNodeChange,r),this._runtime.Trigger(Lx.Plugins.Flowchart.Cnds.OnBeforeTaggedNodeChange,r),this._runtime.Trigger(Lx.Plugins.Flowchart.Cnds.OnBeforeAnyNodeChangeInFlowchart,r),this._runtime.Trigger(Lx.Plugins.Flowchart.Cnds.OnBeforeTaggedNodeChangeInFlowchart,r),this._currentFlowchartNodeId=e;let n=this.GetFlowchartElementById(this._currentFlowchartNodeId);if("dictionary"===n.GetType()&&(this._runtime.Trigger(Lx.Plugins.Flowchart.Cnds.OnAnyNodeChange,r),this._runtime.Trigger(Lx.Plugins.Flowchart.Cnds.OnTaggedNodeChange,r),this._runtime.Trigger(Lx.Plugins.Flowchart.Cnds.OnAnyNodeChangeInFlowchart,r),this._runtime.Trigger(Lx.Plugins.Flowchart.Cnds.OnTaggedNodeChangeInFlowchart,r)),this._flowchartManager.PopFlowchartState(),this.PopIsTriggerState(),!this.WasReleased()&&(n=this.GetFlowchartElementById(this._currentFlowchartNodeId),"reference"===n.GetType())){const e=t?t.GetName():n.GetReferenceFlowchartName();if(this._HasReferenceFlowchartState(n)){this._previousFlowchartNodeIds.pop();const e=this._GetReferenceFlowchartState(n);this._flowchartManager.SetCurrentFlowchartState(e,!0,!0,!1),e._SetPreviousFlowchart(this,i),this._GetRootFlowchartState()._SetCurrentReferenceFlowchart(e)}else{const t="number"==typeof s?s:n.GetReferenceFlowchartStartNodeTag();if(e){this._previousFlowchartNodeIds.pop();let s=n.GetReferenceFlowchartTag();if(s){let e=this._flowchartManager.GetFlowchartState(s);for(;e;)s=Lx.IncrementNumberAtEndOf(s),e=this._flowchartManager.GetFlowchartState(s)}else{s=`${e}-ref`;let t=this._flowchartManager.GetFlowchartState(s);for(;t;)s=Lx.IncrementNumberAtEndOf(s),t=this._flowchartManager.GetFlowchartState(s)}const r=this._flowchartManager.AddFlowchartState(e,t,s,this._pluginInstance,!0);r._SetPreviousFlowchart(this,i),this._SetReferenceFlowchartState(n,r);const a=this._GetRootFlowchartState();r._SetRootFlowchartState(a),a._SetCurrentReferenceFlowchart(r)}}}}_GetFlowchartNodeOutputDefault(){const e=this._flowchartDataItem.GetFlowchartElementById(this._currentFlowchartNodeId);return e?e.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDefault():null}_GetFlowchartNodeOutputAt(e){const t=this._flowchartDataItem.GetFlowchartElementById(this._currentFlowchartNodeId);if(!t)return null;const s=t.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDataItems();if(!s)return null;return s[e]||null}_GetFlowchartNodeOutputByName(e){const t=this._flowchartDataItem.GetFlowchartElementById(this._currentFlowchartNodeId);if(!t)return null;return t.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDataItemByName(e)||null}_SetStartFlowchartNode(e){if("number"==typeof e){let t=this.GetFlowchartElementById(e);t||(t=this._flowchartDataItem.GetFlowchartStartNode()),this._startFlowchartNode=t}else if("number"==typeof this._startNodeTag){let e=this.GetFlowchartElementById(this._startNodeTag);e||(e=this._flowchartDataItem.GetFlowchartStartNode()),this._startFlowchartNode=e}else{let e=this._flowchartDataItem.GetFlowchartNodeByTags(this._startNodeTag);e||(e=this._flowchartDataItem.GetFlowchartStartNode()),this._startFlowchartNode=e}}_SaveToJson(){return this._markForRelease?null:{flowchartName:this._flowchartName,flowchartTag:this._tag,startNodeTag:this._startNodeTag,currentNodeId:this._currentFlowchartNodeId,previousNodeIds:this._previousFlowchartNodeIds,pluginUID:this._pluginInstance.GetInstance().GetUID(),reference:{previousFlowchartTag:this._GetPreviousFlowchartState()?this._GetPreviousFlowchartState().GetTag():"",previousStartNodeId:Lx.IsFiniteNumber(this._GetPreviousFlowchartStateStartNodeId())?this._GetPreviousFlowchartStateStartNodeId():NaN,referencesJson:this._GetFlowchartReferencesJson(),currentReferenceFlowchartTag:this.GetCurrentReferenceFlowchart()?this.GetCurrentReferenceFlowchart().GetTag():"",rootFlowchartTag:this._GetRootFlowchartState()?this._GetRootFlowchartState().GetTag():""}}}_GetFlowchartReferencesJson(){if(!this._HasReferenceFlowchartStates())return null;const e=[];for(const[t,s]of this._GetReferenceFlowchartStates().entries())e.push({flowchartElementId:t.GetFlowchartId(),flowchartStateTag:s.GetTag()});return e.length?e:null}_LoadFromJson(e){if(e){if(this._flowchartName=e.flowchartName,this._tag=e.flowchartTag,this._startNodeTag=e.startNodeTag,this._currentFlowchartNodeId=e.currentNodeId,this._previousFlowchartNodeIds=e.previousNodeIds,this._pluginUID=e.pluginUID,e.hasOwnProperty("reference")){const t=e.reference;this._previousFlowchartStateTag=t.previousFlowchartTag,this._previousFlowchartStateStartNodeId=t.previousStartNodeId,this._referenceFlowchartStatesJson=t.referencesJson,this._currentReferenceFlowchartStateTag=t.currentReferenceFlowchartTag,this._rootFlowchartStateTag=t.rootFlowchartTag}this._SetStartFlowchartNode()}}_GetPreviousFlowchartState(){return"string"==typeof this._previousFlowchartStateTag&&this._previousFlowchartStateTag&&(this._previousFlowchartState=this._flowchartManager.GetFlowchartState(this._previousFlowchartStateTag),this._previousFlowchartStateTag=""),this._previousFlowchartState}_GetPreviousFlowchartStateStartNodeId(){return this._previousFlowchartStateStartNodeId}_SetPreviousFlowchart(e,t){this._previousFlowchartState=e,this._previousFlowchartStateStartNodeId=t}GetCurrentReferenceFlowchart(){return"string"==typeof this._currentReferenceFlowchartStateTag&&this._currentReferenceFlowchartStateTag&&(this._currentReferenceFlowchartState=this._flowchartManager.GetFlowchartState(this._currentReferenceFlowchartStateTag),this._currentReferenceFlowchartStateTag=""),this._currentReferenceFlowchartState}_SetCurrentReferenceFlowchart(e){this._currentReferenceFlowchartState=e,this._currentReferenceFlowchartState===this&&(this._currentReferenceFlowchartState=null)}_GetRootFlowchartState(){return"string"==typeof this._rootFlowchartStateTag&&this._rootFlowchartStateTag&&(this._rootFlowchartState=this._flowchartManager.GetFlowchartState(this._rootFlowchartStateTag),this._rootFlowchartStateTag=""),this._rootFlowchartState?this._rootFlowchartState:this}_SetRootFlowchartState(e){this._rootFlowchartState=e}_HasReferenceFlowchartStates(){return this._RebuildReferenceFlowchartStates(),!!this._referenceFlowchartStates}_HasReferenceFlowchartState(e){return this._RebuildReferenceFlowchartStates(),this._referenceFlowchartStates&&this._referenceFlowchartStates.has(e)}_RebuildReferenceFlowchartStates(){if(this._referenceFlowchartStatesJson){this._referenceFlowchartStates&&this._referenceFlowchartStates.clear(),this._referenceFlowchartStates||(this._referenceFlowchartStates=new Map);for(const e of this._referenceFlowchartStatesJson){const t=this._flowchartManager.GetFlowchartState(e.flowchartStateTag),s=t.GetFlowchartElementById(e.flowchartElementId);this._referenceFlowchartStates.set(s,t)}this._referenceFlowchartStatesJson=null}}_GetReferenceFlowchartStates(){return this._RebuildReferenceFlowchartStates(),this._referenceFlowchartStates}_GetReferenceFlowchartState(e){return this._RebuildReferenceFlowchartStates(),this._referenceFlowchartStates.get(e)}_SetReferenceFlowchartState(e,t){this._referenceFlowchartStates||(this._referenceFlowchartStates=new Map),this._referenceFlowchartStates.set(e,t)}}}{const kx=self.C3;kx.FlowchartStateManager=class{constructor(e){this._runtime=e,this._flowchartStates=new Map,this._currentFlowchartState=null,this._flowchartStateStack=[],this._on_after_load=()=>this._OnAfterLoad(),this._loadJson=null}Release(){kx.clearArray(this._flowchartStateStack),this._flowchartStateStack=null,this._flowchartStates.clear(),this._flowchartStates=null,this._currentFlowchartState=null,this._runtime=null,this._loadJson=null}GetRuntime(){return this._runtime}GetFlowchartDataItemByName(e){return this._runtime.GetFlowchartManager().GetFlowchartDataItemByName(e)}AddFlowchartState(e,t,s,i,r,n){const a=this._runtime.GetFlowchartManager().GetFlowchartDataItemByName(e);if(!a)return void console.warn(`[Flowcharts] no flowchart found with name '${e}'`);if(this._flowchartStates.has(s)){const e=this._flowchartStates.get(s);e&&this.RemoveFlowchartState(e)}const o=new kx.FlowchartState(e,s,t,a,this,i,n);return this._flowchartStates.set(s,o),r&&this.SetCurrentFlowchartState(o,!0),o}RemoveFlowchartState(e){if(e.MarkForRelease(),e.IsInTriggerState())return;const t=e.GetTag();this._flowchartStates.delete(t),e.Release(),this._currentFlowchartState===e&&(this._currentFlowchartState=null)}ResetFlowchartState(e){e.Reset()}GetFlowchartState(e){return this._flowchartStates.get(e)}PushFlowchartState(e){this._flowchartStateStack.push(e)}PopFlowchartState(){this._flowchartStateStack.pop()}SetCurrentFlowchartState(e,t=!1,s=!1,i=!0){if(i){const t=e.GetCurrentReferenceFlowchart();e=t||e}e!==this._currentFlowchartState&&(this._TriggerBeforeFlowchartChange(),this._TriggerAfterFlowchartChange(e,t,s))}GetCurrentFlowchartState(e){return"string"==typeof e?this.GetFlowchartState(e):this._flowchartStateStack.length?this._flowchartStateStack[this._flowchartStateStack.length-1]:this._currentFlowchartState}_TriggerBeforeFlowchartChange(){if(!this._currentFlowchartState)return;if(this._currentFlowchartState.WasReleased())return;const e=this._currentFlowchartState.GetPluginInstance().GetInstance();this._currentFlowchartState.PushIsTriggerState(),this.PushFlowchartState(this._currentFlowchartState),this._runtime.Trigger(kx.Plugins.Flowchart.Cnds.OnBeforeFlowchartChange,e),this.PopFlowchartState(),this._currentFlowchartState.PopIsTriggerState()}_TriggerAfterFlowchartChange(e,t=!1,s=!1){if(this._currentFlowchartState=e,!this._currentFlowchartState)return;if(this._currentFlowchartState.WasReleased())return;const i=this._currentFlowchartState.GetPluginInstance().GetInstance();this._currentFlowchartState.PushIsTriggerState(),this.PushFlowchartState(this._currentFlowchartState),this._runtime.Trigger(kx.Plugins.Flowchart.Cnds.OnFlowchartChange,i),!0!==s&&"number"!=typeof s||this._currentFlowchartState._SetStartFlowchartNode(s),t&&(this._runtime.Trigger(kx.Plugins.Flowchart.Cnds.OnAnyNodeChange,i),this._runtime.Trigger(kx.Plugins.Flowchart.Cnds.OnTaggedNodeChange,i),this._runtime.Trigger(kx.Plugins.Flowchart.Cnds.OnAnyNodeChangeInFlowchart,i),this._runtime.Trigger(kx.Plugins.Flowchart.Cnds.OnTaggedNodeChangeInFlowchart,i)),this.PopFlowchartState(),this._currentFlowchartState.PopIsTriggerState()}_SaveToJson(){return{flowchartJsonObjects:[...this._flowchartStates.values()].map(e=>e._SaveToJson()),currentFlowchartTag:this._currentFlowchartState?this._currentFlowchartState.GetTag():null}}_LoadFromJson(e){if(!e)return;this._loadJson=e;const t=new Map;for(const e of this._loadJson.flowchartJsonObjects){const s=e.flowchartTag;if(this._flowchartStates.has(s)){const i=this._flowchartStates.get(s);i._LoadFromJson(e),t.set(s,i)}else{const s=this.AddFlowchartState(e.flowchartName,e.startNodeTag,e.flowchartTag,null,!1,e.pluginUID);s._LoadFromJson(e),t.set(e.flowchartTag,s)}}for(const[e,s]of this._flowchartStates.entries())t.has(e)||s.Release();this._flowchartStates.clear(),this._flowchartStates=t,this._runtime.IsLoadingState()?this._runtime.Dispatcher().addEventListener("afterload",this._on_after_load):this._OnAfterLoad()}_OnAfterLoad(){this._runtime.Dispatcher().removeEventListener("afterload",this._on_after_load);const e=this._flowchartStates.get(this._loadJson.currentFlowchartTag);e&&this.SetCurrentFlowchartState(e,!0),this._loadJson=null}}}{const Vx=self.C3;Vx.FlowchartDataManager=class{constructor(){this._flowchartDataItems=new Map}Release(){for(const e of this._flowchartDataItems.values())e.Release();this._flowchartDataItems.clear(),this._flowchartDataItems=null}Add(e){const t=new Vx.FlowchartDataItem(e),s=t.GetName();this._flowchartDataItems.set(s,t)}Get(e){return this._flowchartDataItems.get(e)}HasFlowcharts(){return!!this._flowchartDataItems.size}static CreateDataItems(e,t,s,i){if(t)for(const r of t){const t=new s(r,i);e.push(t)}}}}{const Ux=self.C3,Wx=0,Hx=1;Ux.FlowchartDataItem=class{constructor(e){this._name=e[0],this._flowchartNodeData=new Ux.FlowchartNodeData(e[1],this)}Release(){this._flowchartNodeData.Release(),this._flowchartNodeData=null}GetFlowchartNodeData(){return this._flowchartNodeData}GetFlowchartElementById(e){return this._flowchartNodeData.GetFlowchartElementById(e)}GetFlowchartNodeByTags(e){return this._flowchartNodeData.GetFlowchartNodeByTags(e)}GetFlowchartStartNode(){return this._flowchartNodeData.GetFlowchartStartNode()}GetName(){return this._name}}}{const zx=self.C3,jx=0,Yx=1,qx=2,Xx=3,$x=4,Kx=5,Jx=6,Qx=7,Zx=8,eb=8,tb=9,sb=10,ib=11;class rb{constructor(e,t){this._flowchartNodeData=t,this._type=e[7],this._flowchartId=e[0],this._tag=e[1],this._tag?this._tags=this._tag.trim().split(" ").map(e=>e.trim()):this._tags=[],this._parentFlowchartIds=e[2],this._parentOutputFlowchartIds=null,this._childrenFlowchartIds=null,this._enable=!1,"dictionary"===this._type&&(this._parentOutputFlowchartIds=e[3],this._childrenFlowchartIds=e[4],this._enable=e[8]),this._isStart=e[6],this._referenceFlowchartName=null,this._referenceFlowchartStartNodeTag=null,this._referenceFlowchartTag=null,"reference"===this._type&&(this._referenceFlowchartName=e[8],this._referenceFlowchartStartNodeTag=e[9],this._referenceFlowchartTag=e[10],this._enable=e[11]),this._flowchartNodeOutputData=new zx.FlowchartNodeOutputData(e[5],this)}Release(){this._flowchartNodeData=null}GetFlowchartNodeData(){return this._flowchartNodeData}GetFlowchartNodeOutputData(){return this._flowchartNodeOutputData}GetFlowchartId(){return this._flowchartId}GetTag(){return this._tag}GetTags(){return this._tags}HasTags(e){if(!this._tags)return!1;if(!this._tags.length)return!1;const t=zx.FlowchartState._GetTagArray(e);return!(!t||!t.length)&&t.every(zx.FlowchartState._HasTag,this._tags)}GetIsStart(){return this._isStart}SetIsStart(e){this._isStart=!!e}CanBeStartNode(){if("dictionary"===this._type)return!0;if("reference"===this._type)return!1;throw new Error(`unexpected flowchart node type: ${this._type}`)}GetParentFlowchartIds(){return this._parentFlowchartIds}GetParentOutputFlowchartIds(){return this._parentOutputFlowchartIds}GetChildrenFlowchartIds(){return this._childrenFlowchartIds}GetType(){return this._type}GetEnable(){return this._enable}GetReferenceFlowchartName(){return this._referenceFlowchartName}GetReferenceFlowchartStartNodeTag(){return this._referenceFlowchartStartNodeTag}GetReferenceFlowchartTag(){return this._referenceFlowchartTag}}zx.FlowchartNodeData=class{constructor(e,t){this._flowchartDataItem=t,this._flowchartNodeItems=[],this._flowchartNodeItemsIdMap=new Map,this._flowchartNodeItemsTagMap=new Map,this._flowchartNodeStartItem=null,zx.FlowchartDataManager.CreateDataItems(this._flowchartNodeItems,e,rb,this);for(const e of this._flowchartNodeItems){const t=e.GetFlowchartId(),s=e.GetTag(),i=e.GetTags(),r=e.GetIsStart();if(this._flowchartNodeItemsIdMap.set(t,e),s)for(const t of i)this._flowchartNodeItemsTagMap.has(t)||this._flowchartNodeItemsTagMap.set(t,new Set),this._flowchartNodeItemsTagMap.get(t).add(e);r&&(this._flowchartNodeStartItem=e);const n=e.GetFlowchartNodeOutputData();for(const e of n.flowchartNodeOutputDataItems()){const t=e.GetFlowchartId();this._flowchartNodeItemsIdMap.set(t,e)}}this._flowchartNodeStartItem||this._SetStartNodeIfMissing()}Release(){this._flowchartDataItem=null;for(const e of this._flowchartNodeItems)e.Release();zx.clearArray(this._flowchartNodeItems),this._flowchartNodeItems=null}GetFlowchartDataItem(){return this._flowchartDataItem}GetFlowchartElementById(e){return this._flowchartNodeItemsIdMap.get(e)}GetFlowchartNodeByTags(e){if(!e||!e.length)return null;const t=[];for(const s of e.trim().split(" ")){let e=this._flowchartNodeItemsTagMap.get(s.trim())??new Set;if(0===e.size)return null;t.push(e)}return[...t.reduce((e,t)=>t.size<e.size?t:e)].filter(e=>t.every(t=>t.has(e)))[0]}GetFlowchartStartNode(){return this._flowchartNodeStartItem}*flowchartNodeDataItems(){for(const e of this._flowchartNodeItems)yield e}_SetStartNodeIfMissing(){let e=0;for(const t of this.flowchartNodeDataItems())t.GetIsStart()&&e++;if(0===e){for(const e of this.flowchartNodeDataItems())if(e.CanBeStartNode()&&!e.GetIsStart())return void e.SetIsStart(!0)}else{if(1===e)return;if(e>1){let e=!0;for(const t of this.flowchartNodeDataItems())t.CanBeStartNode()&&(t.GetIsStart()&&e?e=!1:t.GetIsStart()&&!e&&t.SetIsStart(!1))}}for(const e of this.flowchartNodeDataItems())if(e.CanBeStartNode()&&e.GetIsStart())return void(this._flowchartNodeStartItem=e)}}}{const nb=self.C3,ab=0,ob=1,lb=2,hb=3,ub=4,cb=5;class db{constructor(e,t){this._flowchartNodeOutputData=t,this._flowchartId=e[0],this._name=e[1],this._value=e[2],this._connectedFlowchartNodeFlowchartId=e[3],this._enable=e[4],this._default=e[5]}Release(){this._flowchartNodeOutputData=null}GetFlowchartNodeOutputData(){return this._flowchartNodeOutputData}GetFlowchartId(){return this._flowchartId}GetName(){return this._name}GetValue(){return this._value}GetConnectedFlowchartNodeFlowchartId(){return this._connectedFlowchartNodeFlowchartId}GetEnable(){return this._enable}GetDefault(){return this._default}}nb.FlowchartNodeOutputData=class{constructor(e,t){this._flowchartDataNodeItem=t,this._flowchartNodeOutputItems=[],this._flowchartNodeOutputItemsNameMap=new Map,nb.FlowchartDataManager.CreateDataItems(this._flowchartNodeOutputItems,e,db,this),this._enabledFlowchartNodeOutputItems=this._flowchartNodeOutputItems.filter(e=>e.GetEnable());for(const e of this._enabledFlowchartNodeOutputItems)this._flowchartNodeOutputItemsNameMap.set(e.GetName(),e)}Release(){this._flowchartDataNodeItem=null;for(const e of this._flowchartNodeOutputItems)e.Release();nb.clearArray(this._flowchartNodeOutputItems),this._flowchartNodeOutputItems=null,nb.clearArray(this._enabledFlowchartNodeOutputItems),this._enabledFlowchartNodeOutputItems=null}GetFlowchartNodeDataItem(){return this._flowchartDataNodeItem}GetFlowchartNodeOutputDataItemCount(){return this._enabledFlowchartNodeOutputItems.length}GetFlowchartNodeOutputDataItems(){return this._enabledFlowchartNodeOutputItems}GetFlowchartNodeOutputDataItemByName(e){return this._flowchartNodeOutputItemsNameMap.get(e)}GetFlowchartNodeOutputDefault(){for(const e of this._enabledFlowchartNodeOutputItems)if(e.GetDefault())return e}*flowchartNodeOutputDataItems(){for(const e of this._enabledFlowchartNodeOutputItems)yield e}}}{const pb=self.C3;pb.SolStack=class extends pb.DefendedBase{constructor(e){super(),this._objectClass=e,this._stack=[],this._stack.push(pb.New(pb.Sol,this)),this._index=0,this._current=this._stack[0]}Release(){for(const e of this._stack)e.Release();pb.clearArray(this._stack),this._current=null,this._objectClass=null}GetObjectClass(){return this._objectClass}GetCurrentSol(){return this._current}GetOneBelowCurrentSol(){return this._stack[this._index-1]}Clear(){this.GetCurrentSol().Clear()}PushClean(){const e=this._stack,t=++this._index;if(t===e.length){const t=pb.New(pb.Sol,this);e.push(t),this._current=t}else{const s=e[t];s.Reset(),this._current=s}}PushCopy(){const e=this._stack,t=++this._index;t===e.length&&e.push(pb.New(pb.Sol,this));const s=e[t];s.Copy(e[t-1]),this._current=s}Pop(){this._current=this._stack[--this._index]}RemoveInstances(e){const t=this._stack;for(let s=0,i=t.length;s<i;++s)t[s].RemoveInstances(e)}}}{const _b=self.C3;_b.Sol=class extends _b.DefendedBase{constructor(e){super(),this._stack=e,this._objectClass=this._stack.GetObjectClass(),this._eventStack=this._objectClass.GetRuntime().GetEventStack(),this._selectAll=!0,this._instances=[],this._elseInstances=[]}Release(){this.ClearArrays(),this._stack=null,this._objectClass=null,this._eventStack=null}ClearArrays(){_b.clearArray(this._instances),_b.clearArray(this._elseInstances)}GetObjectClass(){return this._objectClass}IsSelectAll(){return this._selectAll}HasAnyInstances(){return this._selectAll?!!this._objectClass.GetInstanceCount():!!this._instances.length}GetInstances(){return this._selectAll?this._objectClass.GetInstances():this._instances}HasAnyElseInstances(){return!!this._elseInstances.length}GetElseInstances(){return this._elseInstances}GetExpressionInstances(){const e=this.GetInstances();return e.length?e:this._elseInstances}Reset(){this._selectAll=!0,_b.clearArray(this._elseInstances)}Clear(){this._selectAll=!0}Copy(e){e.IsSelectAll()?this.Reset():(this._selectAll=!1,_b.shallowAssignArray(this._instances,e._instances),_b.clearArray(this._elseInstances))}_PushInstance(e){this._instances.push(e)}_PushElseInstance(e){this._elseInstances.push(e)}_SetSelectAll(e){this._selectAll=!!e}_GetOwnInstances(){return this._instances}_GetOwnElseInstances(){return this._elseInstances}SetSinglePicked(e){this._selectAll=!1,_b.clearArray(this._instances),this._instances.push(e)}SetArrayPicked(e){this._selectAll=!1,_b.shallowAssignArray(this._instances,e)}SetSetPicked(e){this._selectAll=!1,_b.clearArray(this._instances);for(const t of e)this._instances.push(t)}AddElseInstances(e,t){for(const s of t)e.has(s)||this._elseInstances.push(s)}TransferElseInstancesToOwn(e){for(const t of e)this._instances.push(t);_b.arrayRemoveAllInSet(this._elseInstances,e)}ClearElseInstances(){_b.clearArray(this._elseInstances)}PickOne(e){if(e)if(this._eventStack.GetCurrentStackFrame().GetCurrentEvent().IsOrBlock()){this.IsSelectAll()&&(_b.clearArray(this._instances),_b.shallowAssignArray(this._elseInstances,e.GetObjectClass().GetInstances()),this._selectAll=!1);const t=this._elseInstances.indexOf(e);-1!==t&&(this._instances.push(this._elseInstances[t]),this._elseInstances.splice(t,1))}else this.SetSinglePicked(e)}RemoveInstances(e){_b.arrayRemoveAllInSet(this._instances,e),_b.arrayRemoveAllInSet(this._elseInstances,e)}}}{const mb=self.C3;mb.EventStack=class extends mb.DefendedBase{constructor(e){super(),this._eventSheetManager=e,this._runtime=this._eventSheetManager.GetRuntime(),this._stack=[],this._stack.push(mb.New(mb.EventStackFrame,this,null)),this._index=0,this._expFuncStack=[]}Release(){for(const e of this._stack)e.Release();mb.clearArray(this._stack),mb.clearArray(this._expFuncStack),this._eventSheetManager=null,this._runtime=null}GetEventSheetManager(){return this._eventSheetManager}GetRuntime(){return this._runtime}GetCurrentStackFrame(){return this._stack[this._index]}GetAllStackFrames(){return this._stack}GetCurrentStackFrameIndex(){return this._index}Push(e){const t=this._stack,s=++this._index;if(s===t.length){const s=mb.New(mb.EventStackFrame,this,e);return t.push(s),s}{const i=t[s];return i.Reset(e),i}}Pop(){--this._index}PushExpFunc(e){this._expFuncStack.push(e)}PopExpFunc(){this._expFuncStack.pop()}GetCurrentExpFuncStackFrame(){const e=this._expFuncStack;return 0===e.length?null:e.at(-1)}}}{const fb=self.C3;fb.EventStackFrame=class extends fb.DefendedBase{constructor(e,t){super(),this._stack=e,this._runtime=this._stack.GetRuntime(),this._currentEvent=t,this._cndIndex=0,this._actIndex=0,this._lastEventTrue=!1,this._elseBranchRan=!1,this._expressionObjectClass=null,this._functionReturnType=0,this._functionReturnValue=0,this._dynamicSolModifiers=null}Release(){this.Reset(null),this._stack=null,this._runtime=null}Reset(e){this._currentEvent=e,this._cndIndex=0,this._actIndex=0,this._lastEventTrue=!1,this._elseBranchRan=!1,this._dynamicSolModifiers=null}_Restore(e,t){this._currentEvent=e,this._cndIndex=0,this._actIndex=t}ResetQuick(){this._cndIndex=0,this._actIndex=0}GetCurrentEvent(){return this._currentEvent}SetCurrentEvent(e){this._currentEvent=e}GetConditionIndex(){return this._cndIndex}SetConditionIndex(e){this._cndIndex=e}GetActionIndex(){return this._actIndex}SetActionIndex(e){this._actIndex=e}SetLastEventTrue(e){this._lastEventTrue=!!e}GetLastEventTrue(){return this._lastEventTrue}SetElseBranchRan(e){this._elseBranchRan=!!e}GetElseBranchRan(){return this._elseBranchRan}SetExpressionObjectClass(e){this._expressionObjectClass=e}GetExpressionObjectClass(){return this._expressionObjectClass}InitCallFunctionExpression(e,t){this._functionReturnType=e,this._functionReturnValue=t}GetFunctionReturnType(){return this._functionReturnType}SetFunctionReturnValue(e){this._functionReturnValue=e}GetFunctionReturnValue(){return this._functionReturnValue}IsSolModifierAfterCnds(){const e=this._currentEvent;return!!e.IsSolWriterAfterCnds()||this._cndIndex<e.GetConditionCount()-1&&!!e.GetSolModifiers().length}SetDynamicSolModifiers(e){this._dynamicSolModifiers=e}GetDynamicSolModifiers(){return this._dynamicSolModifiers}}}{const gb=self.C3;gb.LocalVarStack=class extends gb.DefendedBase{constructor(e){super(),this._eventSheetManager=e,this._runtime=this._eventSheetManager.GetRuntime(),this._stack=[],this._index=-1,this._current=null,this._initialValues=[]}Release(){gb.clearArray(this._stack),this._eventSheetManager=null,this._runtime=null}_SetInitialValues(e){this._initialValues=e;const t=this._initialValues.slice(0);this._stack.push(t),this._index=0,this._current=t}GetEventSheetManager(){return this._eventSheetManager}GetRuntime(){return this._runtime}GetCurrent(){return this._current}Push(){const e=++this._index,t=this._stack;e===t.length?t.push(this._initialValues.slice(0)):gb.shallowAssignArray(t[e],this._initialValues),this._current=t[e]}Pop(){this._current=this._stack[--this._index]}}}{const yb=self.C3;yb.LoopStack=class extends yb.DefendedBase{constructor(e){super(),this._eventSheetManager=e,this._runtime=this._eventSheetManager.GetRuntime(),this._stack=[],this._index=-1}Release(){yb.clearArray(this._stack),this._eventSheetManager=null,this._runtime=null}GetEventSheetManager(){return this._eventSheetManager}GetRuntime(){return this._runtime}IsInLoop(){return this._index>=0}GetCurrent(){return this._stack[this._index]}Push(){if(++this._index,this._index===this._stack.length){const e=yb.New(yb.Loop,this);return this._stack.push(e),e}{const e=this._stack[this._index];return e.Reset(),e}}Pop(){--this._index}FindByName(e){const t=this._stack;for(let s=this._index;s>=0;--s){const i=t[s];if(i.GetName()===e)return i}return null}_GetStack(){return this._stack.slice(0,this._index+1)}}}{const Sb=self.C3;Sb.Loop=class extends Sb.DefendedBase{constructor(e){super(),this._loopStack=e,this._name="",this._index=0,this._isStopped=!1,this._end=NaN}Reset(){this._name="",this._index=0,this._isStopped=!1,this._end=NaN}SetName(e){this._name=e}GetName(){return this._name}SetIndex(e){this._index=e}GetIndex(){return this._index}Stop(){this._isStopped=!0}IsStopped(){return this._isStopped}SetEnd(e){this._end=e}GetEnd(){return this._end}}}{const Tb=self.C3;Tb.ArrayStack=class extends Tb.DefendedBase{constructor(){super(),this._stack=[],this._index=-1}Release(){Tb.clearArray(this._stack)}GetCurrent(){return this._stack[this._index]}Push(){if(++this._index,this._index===this._stack.length){const e=[];return this._stack.push(e),e}return this._stack[this._index]}Pop(){--this._index}}}{let xb=function(e,t){return e.GetIndex()-t.GetIndex()},bb=function(e,t){for(let s=0,i=e.length;s<i;++s)if(e[s]!==t[s])return!1;return!0};SortSolArray=xb,IsSolArrayIdentical=bb;const Gb=self.C3,Ib=self.assert;Gb.EventSheetManager=class extends Gb.DefendedBase{constructor(e){super(),this._runtime=e,this._allSheets=[],this._sheetsByName=new Map,this._allGroups=[],this._groupsByName=new Map,this._blocksBySid=new Map,this._cndsBySid=new Map,this._actsBySid=new Map,this._allUniqueSolModifiers=new Map,this._eventVarsBySid=new Map,this._nextLocalVarIndex=0,this._allGlobalVars=[],this._allLocalVars=[],this._localVarInitialValues=[],this._functionBlocksByName=new Map,this._customActionBlocksMap=new Map,this._eventStack=Gb.New(Gb.EventStack,this),this._localVarStack=Gb.New(Gb.LocalVarStack,this),this._loopStack=Gb.New(Gb.LoopStack,this),this._triggersToPostInit=[],this._queuedTriggers=[],this._queuedDebugTriggers=[],this._runningEventsDepth=0,this._executingTriggerDepth=0,this._blockFlushingDepth=0,this._scheduledWaits=[],this._asyncActionPromises=[],this._signalTags=[],this._signalPromises=new Map,this._instSignals=new Map,self.c3_callFunction=(e,t)=>this._InvokeFunctionFromJS(e,t)}Release(){this.ClearAllScheduledWaits(),this._eventStack.Release(),this._eventStack=null,this._localVarStack.Release(),this._localVarStack=null,Gb.clearArray(this._queuedTriggers),Gb.clearArray(this._queuedDebugTriggers),this._runtime=null,Gb.clearArray(this._allSheets),this._sheetsByName.clear()}Create(e){const t=Gb.New(Gb.EventSheet,this,e);this._allSheets.push(t),this._sheetsByName.set(t.GetName().toLowerCase(),t)}_AddTriggerToPostInit(e){this._triggersToPostInit.push(e)}_PostInit(){for(const e of this._customActionBlocksMap.values())e._CheckOverrideState();for(const e of this._functionBlocksByName.values())e._PostInit();for(const e of this._customActionBlocksMap.values())e._PostInit();for(const e of this._allSheets)e._PostInit();for(const e of this._allSheets)e._UpdateDeepIncludes();for(const e of this._triggersToPostInit)e._PostInit(!1);Gb.clearArray(this._triggersToPostInit),this._localVarStack._SetInitialValues(this._localVarInitialValues)}GetRuntime(){return this._runtime}GetEventSheetByName(e){return this._sheetsByName.get(e.toLowerCase())||null}_RegisterGroup(e){this._allGroups.push(e),this._groupsByName.set(e.GetGroupName(),e)}_RegisterEventBlock(e){this._blocksBySid.set(e.GetSID(),e)}_RegisterCondition(e){this._cndsBySid.set(e.GetSID(),e)}_RegisterAction(e){this._actsBySid.set(e.GetSID(),e)}_RegisterFunctionBlock(e){switch(e.GetFunctionType()){case 0:this._functionBlocksByName.set(e.GetFunctionName().toLowerCase(),e);break;case 1:this._customActionBlocksMap.set(e.GetFunctionName().toLowerCase(),e)}}_RegisterEventVariable(e){this._eventVarsBySid.set(e.GetSID(),e),e.IsGlobal()?this._allGlobalVars.push(e):this._allLocalVars.push(e)}_DeduplicateSolModifierList(e){e.length>=2&&e.sort(xb);let t=this._allUniqueSolModifiers.get(e.length);t||(t=[],this._allUniqueSolModifiers.set(e.length,t));for(let s=0,i=t.length;s<i;++s){const i=t[s];if(bb(e,i))return i}return t.push(e),e}_GetNextLocalVarIndex(e){return this._localVarInitialValues.push(e.GetInitialValue()),this._nextLocalVarIndex++}GetEventStack(){return this._eventStack}GetCurrentEventStackFrame(){return this.GetEventStack().GetCurrentStackFrame()}GetCurrentEvent(){return this.GetCurrentEventStackFrame().GetCurrentEvent()}GetCurrentCondition(){const e=this.GetCurrentEventStackFrame();return e.GetCurrentEvent().GetConditionAt(e.GetConditionIndex())}GetCurrentAction(){const e=this.GetCurrentEventStackFrame();return e.GetCurrentEvent().GetActionAt(e.GetActionIndex())}GetLocalVarStack(){return this._localVarStack}GetLoopStack(){return this._loopStack}GetAllLocalVariablesInScope(e){const t=[];for(e=e.GetScopeParent();e;)Gb.appendArray(t,e._GetAllLocalVariablesInScope()),e=e.GetScopeParent();return t}_GetLocalVariablesScriptInterface(e){const t={};for(const s of this.GetAllLocalVariablesInScope(e))t[s.GetJsPropName()]=s._GetScriptInterfaceDescriptor();return Object.create(Object.prototype,t)}GetEventVariableBySID(e){return this._eventVarsBySid.get(e)||null}GetEventBlockBySID(e){return this._blocksBySid.get(e)||null}GetConditionBySID(e){return this._cndsBySid.get(e)||null}GetActionBySID(e){return this._actsBySid.get(e)||null}GetFunctionBlockByName(e){return this._functionBlocksByName.get(e.toLowerCase())||null}GetCustomActionBlockByName(e,t){let s=this._customActionBlocksMap.get((e.GetName()+"."+t).toLowerCase());if(s)return s;if(!e.IsFamily())for(const i of e.GetFamilies())if(s=this._customActionBlocksMap.get((i.GetName()+"."+t).toLowerCase()),s)return s;return null}GetAllGlobalVariables(){return this._allGlobalVars}GetAllLocalVariables(){return this._allLocalVars}ResetAllGlobalsToInitialValue(e){for(const e of this._allGlobalVars)e.ResetToInitialValue();if(e)for(const e of this._allLocalVars)e.IsStatic()&&e.ResetToInitialValue()}GetEventGroupByName(e){return this._groupsByName.get(e.toLowerCase())||null}GetEventGroupBySID(e){const t=this._blocksBySid.get(e);return t&&t.IsGroup()?t:null}GetAllGroups(){return this._allGroups}ResetAllGroupsInitialActivation(){for(const e of this._allGroups)e.ResetInitialActivation()}_ResetAllHasRunFlags(){for(const e of this._allSheets)e._ResetHasRunFlag()}RunEvents(e){this._ResetAllHasRunFlags(),this._runningEventsDepth++;for(const t of e.runningLayouts()){const e=t.GetEventSheet();e&&(this._runtime.PushCurrentLayout(t),e.Run(),this._runtime.PopCurrentLayout())}this._runningEventsDepth--}async DebugRunEvents(e){this._ResetAllHasRunFlags(),this._runningEventsDepth++;for(const t of this._DebugRunEventsGen(e))await this._runtime.DebugBreak(t);this._runningEventsDepth--}*_DebugRunEventsGen(e){for(const t of e.runningLayouts()){const e=t.GetEventSheet();e&&(this._runtime.PushCurrentLayout(t),yield*e.DebugRun(),this._runtime.PopCurrentLayout())}}_Trigger(e,t,s,i){let r=!1;if(!e.GetMainRunningLayout())return this.QueueTrigger(t,s,i);this._executingTriggerDepth++;for(const n of e.runningLayouts()){const e=n.GetEventSheet();if(!e)continue;this._runtime.PushCurrentLayout(n);for(const n of e.deepIncludes()){const e=n._Trigger(t,s,i);r=r||e}const a=e._Trigger(t,s,i);r=r||a,this._runtime.PopCurrentLayout()}return this._executingTriggerDepth--,r}*_DebugTrigger(e,t,s,i){let r=!1;if(!e.GetMainRunningLayout())return this.QueueTrigger(t,s,i);this._executingTriggerDepth++;for(const n of e.runningLayouts()){const e=n.GetEventSheet();if(!e)continue;this._runtime.PushCurrentLayout(n);for(const n of e.deepIncludes()){const e=yield*n._DebugTrigger(t,s,i);r=r||e}const a=yield*e._DebugTrigger(t,s,i);r=r||a,this._runtime.PopCurrentLayout()}return this._executingTriggerDepth--,r}QueueTrigger(e,t,s){return this._queuedTriggers.push([e,t,s]),!1}QueueDebugTrigger(e,t,s){let i=null;const r=new Promise(e=>i=e);return this._queuedDebugTriggers.push([e,t,s,i]),r}*_RunQueuedDebugTriggersGen(){if(this._runtime.HitBreakpoint())throw new Error("should not be in breakpoint");const e=this._runtime.GetLayoutManager();for(;this._queuedDebugTriggers.length;){const[t,s,i,r]=this._queuedDebugTriggers.shift();r(yield*this._DebugTrigger(e,t,s,i))}}async RunQueuedDebugTriggersAsync(){for(const e of this._RunQueuedDebugTriggersGen())await this._runtime.DebugBreak(e)}_FastTrigger(e,t,s,i){let r=!1;const n=e.GetMainRunningLayout(),a=n.GetEventSheet();if(!a)return;this._executingTriggerDepth++,this._runtime.PushCurrentLayout(n);const o=a.deepIncludes();for(let e=0,n=o.length;e<n;++e){const n=o[e]._FastTrigger(t,s,i);r=r||n}const l=a._FastTrigger(t,s,i);return r=r||l,this._runtime.PopCurrentLayout(),this._executingTriggerDepth--,r}*_DebugFastTrigger(e,t,s,i){let r=!1;const n=e.GetMainRunningLayout(),a=n.GetEventSheet();if(!a)return;this._executingTriggerDepth++,this._runtime.PushCurrentLayout(n);const o=a.deepIncludes();for(let e=0,n=o.length;e<n;++e){const n=yield*o[e]._DebugFastTrigger(t,s,i);r=r||n}const l=yield*a._DebugFastTrigger(t,s,i);return r=r||l,this._runtime.PopCurrentLayout(),this._executingTriggerDepth--,r}GetTriggerDepth(){return this._executingTriggerDepth}IsInTrigger(){return this.GetTriggerDepth()>0}_IncTriggerDepth(){return++this._executingTriggerDepth}_DecTriggerDepth(){--this._executingTriggerDepth}IsRunningEvents(){return this._runningEventsDepth>0}IsInEventEngine(){return this.IsRunningEvents()||this.IsInTrigger()}_RunQueuedTriggers(e){for(const[t,s,i]of this._queuedTriggers)this._Trigger(e,t,s,i);Gb.clearArray(this._queuedTriggers)}BlockFlushingInstances(e){e?this._blockFlushingDepth++:this._blockFlushingDepth--}IsFlushingBlocked(){return this._blockFlushingDepth>0}ClearSol(e){for(let t=0,s=e.length;t<s;++t)e[t].GetSolStack().Clear()}PushCleanSol(e){for(let t=0,s=e.length;t<s;++t)e[t].GetSolStack().PushClean()}PushCopySol(e){for(let t=0,s=e.length;t<s;++t)e[t].GetSolStack().PushCopy()}PopSol(e){for(let t=0,s=e.length;t<s;++t)e[t].GetSolStack().Pop()}GetDynamicSolModifiersSet(e){const t=new Set,s=this._eventStack.GetAllStackFrames(),i=this._eventStack.GetCurrentStackFrameIndex();for(let r=0;r<=i;++r){const i=s[r].GetDynamicSolModifiers();if(i)for(const s of i)e&&e.has(s)||t.add(s)}return t}PushCleanSolDynamic(e){const t=new Set([...e]),s=this.GetDynamicSolModifiersSet(t);if(s.size>0){for(const e of s)e.GetSolStack().PushClean();return[...s]}return null}AddScheduledWait(){const e=Gb.New(Gb.ScheduledWait,this);return this._scheduledWaits.push(e),e}scheduledWaits(){return this._scheduledWaits}RunScheduledWaits(){if(!this._scheduledWaits.length)return;const e=this.GetCurrentEventStackFrame();let t=!1;this._runningEventsDepth++;for(let s=0,i=this._scheduledWaits.length;s<i;++s){const i=this._scheduledWaits[s];i._ShouldRun()&&i._Run(e),i.ShouldRelease()&&(t=!0)}t&&(this._FilterScheduledWaitsToRelease(),e.Reset(null)),this._runningEventsDepth--}async DebugRunScheduledWaits(){if(!this._scheduledWaits.length)return;const e=this.GetCurrentEventStackFrame();let t=!1;this._runningEventsDepth++;for(let s=0,i=this._scheduledWaits.length;s<i;++s){const i=this._scheduledWaits[s];i._ShouldRun()&&await i._DebugRun(e),i.ShouldRelease()&&(t=!0)}t&&(this._FilterScheduledWaitsToRelease(),e.Reset(null)),this._runningEventsDepth--}_FilterScheduledWaitsToRelease(){const e=Gb.arrayFilterOut(this._scheduledWaits,e=>e.ShouldRelease());for(const t of e)t.Release()}ClearAllScheduledWaits(){for(const e of this._scheduledWaits)e.Release();Gb.clearArray(this._scheduledWaits)}_OnInstancesReleased(e){for(const t of this._scheduledWaits)t.RemoveInstances(e);for(const t of e){const e=this._instSignals.get(t);if(this._instSignals.delete(t),e)for(const{resolve:t}of e.signalPromises.values())t(!0)}}AddAsyncActionPromise(e){this._asyncActionPromises.push({promise:e,triggerDepth:this.GetTriggerDepth()})}ClearAsyncActionPromises(){Gb.clearArray(this._asyncActionPromises)}GetPromiseForAllAsyncActions(){const e=this.GetTriggerDepth(),t=Promise.all(this._asyncActionPromises.filter(t=>t.triggerDepth===e).map(e=>e.promise));return this._asyncActionPromises=this._asyncActionPromises.filter(t=>t.triggerDepth<e),t}Signal(e){const t=e.toLowerCase();this._signalTags.push(t),this._runtime.Trigger(Gb.Plugins.System.Cnds.OnSignal,null),this._signalTags.pop();for(const e of this._runtime.GetEventSheetManager().scheduledWaits())e.IsSignal()&&e.GetSignalTag()===t&&e.SetSignalled();const s=this._signalPromises.get(t);s&&(s.resolve(),this._signalPromises.delete(t))}WaitForSignal(e){const t=e.toLowerCase(),s=this._signalPromises.get(t);if(s)return s.promise;{let e=null;const s=new Promise(t=>e=t);return this._signalPromises.set(t,{promise:s,resolve:e}),s}}GetCurrentSignalTag(){if(0===this._signalTags.length)throw new Error("not in a signal");return this._signalTags.at(-1)}_GetInstanceSignalState(e){let t=this._instSignals.get(e);return t||(t={signalTags:[],signalPromises:new Map},this._instSignals.set(e,t)),t}InstanceSignal(e,t){const s=this._GetInstanceSignalState(e),i=t.toLowerCase();s.signalTags.push(i),this._runtime.Trigger(e.GetPlugin().GetConstructor().Cnds.OnInstanceSignal,e),s.signalTags.pop();for(const t of this._runtime.GetEventSheetManager().scheduledWaits())t.IsInstanceSignals()&&t.GetSignalTag()===i&&t.SetInstanceSignalled(e);const r=s.signalPromises.get(i);r&&(r.resolve(!1),s.signalPromises.delete(i)),0===s.signalTags.length&&0===s.signalPromises.size&&this._instSignals.delete(e)}WaitForInstanceSignal(e,t){const s=this._GetInstanceSignalState(e),i=t.toLowerCase(),r=s.signalPromises.get(i);if(r)return r.promise;{let e=null;const t=new Promise(t=>e=t);return s.signalPromises.set(i,{promise:t,resolve:e}),t}}GetCurrentInstanceSignalTag(e){const t=this._GetInstanceSignalState(e);if(!t||0===t.signalTags.length)throw new Error("not in a signal");return t.signalTags.at(-1)}_SaveToJson(){return{groups:this._SaveGroupsToJson(),cnds:this._SaveCndsToJson(),acts:this._SaveActsToJson(),vars:this._SaveVarsToJson(),waits:this._SaveScheduledWaitsToJson()}}_LoadFromJson(e){this._LoadGroupsFromJson(e.groups),this._LoadCndsFromJson(e.cnds),this._LoadActsFromJson(e.acts),this._LoadVarsFromJson(e.vars),this._LoadScheduledWaitsFromJson(e.waits)}_SaveGroupsToJson(){const e={};for(const t of this.GetAllGroups())e[t.GetSID().toString()]=t.IsGroupActive();return e}_LoadGroupsFromJson(e){for(const[t,s]of Object.entries(e)){const e=parseInt(t,10),i=this.GetEventGroupBySID(e);i&&i.SetGroupActive(s)}}_SaveCndsToJson(){const e={};for(const[t,s]of this._cndsBySid){const i=s._SaveToJson();i&&(e[t.toString()]=i)}return e}_LoadCndsFromJson(e){const t=new Map;for(const[s,i]of Object.entries(e))t.set(parseInt(s,10),i);for(const[e,s]of this._cndsBySid)s._LoadFromJson(t.get(e)||null)}_SaveActsToJson(){const e={};for(const[t,s]of this._actsBySid){const i=s._SaveToJson();i&&(e[t.toString()]=i)}return e}_LoadActsFromJson(e){const t=new Map;for(const[s,i]of Object.entries(e))t.set(parseInt(s,10),i);for(const[e,s]of this._actsBySid)s._LoadFromJson(t.get(e)||null)}_SaveVarsToJson(){const e={};for(const[t,s]of this._eventVarsBySid)s.IsConstant()||!s.IsGlobal()&&!s.IsStatic()||(e[t.toString()]=s.GetValue());return e}_LoadVarsFromJson(e){for(const[t,s]of Object.entries(e)){const e=parseInt(t,10),i=this.GetEventVariableBySID(e);i&&i.SetValue(s)}}_SaveScheduledWaitsToJson(){return this._scheduledWaits.filter(e=>!e.IsPromise()).map(e=>e._SaveToJson())}_LoadScheduledWaitsFromJson(e){this.ClearAllScheduledWaits();for(const t of e){const e=Gb.ScheduledWait._CreateFromJson(this,t);e&&this._scheduledWaits.push(e)}}_GetPerfRecords(){return[...this._runtime.GetLayoutManager().runningLayouts()].map(e=>e.GetEventSheet()).filter(e=>e).map(e=>e._GetPerfRecord())}FindFirstFunctionBlockParent(e){for(;e;){const t=e.GetScopeParent();if(t instanceof Gb.FunctionBlock)return t;e=t}return null}_InvokeFunctionFromJS(e,t){Array.isArray(t)||(t=[]);const s=this.GetFunctionBlockByName(e.toLowerCase());if(!s)return null;if(!s.IsEnabled())return s.GetDefaultReturnValue();const i=s.GetFunctionParameters();if(t.length<i.length){t=t.slice(0);do{t.push(i[t.length].GetInitialValue())}while(t.length<i.length)}const r=s.GetEventBlock();return r.RunAsExpressionFunctionCall(r.GetSolModifiersIncludingParents(),!1,s.GetReturnType(),s.GetDefaultReturnValue(),...t)}}}{const vb=self.C3;vb.EventSheet=class extends vb.DefendedBase{constructor(e,t){super(),this._eventSheetManager=e,this._runtime=e.GetRuntime(),this._name=t[0],this._events=[],this._triggers=new Map,this._fastTriggers=new Map,this._eventsByDisplayNumber=new Map,this._hasRun=!1,this._shallowIncludes=[],this._deepIncludes=[],this._alreadyIncludedSheets=new Set;for(const e of t[1])this._CreateEvent(e,null,this._events);this._perfRecord=this._runtime.IsDebug()?{type:"sheet",name:this._name,totalTimeCounter:0,children:[]}:null}Release(){this._eventSheetManager=null,this._runtime=null}_CreateEvent(e,t,s){switch(e[0]){case 0:case 3:this._CreateEventBlock(e,t,s);break;case 1:this._CreateEventVariable(e,t,s);break;case 2:this._CreateInclude(e,t,s);break;case 4:this._CreateFunctionBlock(e,t);break;case 5:this._CreateScriptBlock(e,t,s);break;case 6:this._CreateCustomACEBlock(e,t);break;default:throw new Error("invalid event type")}}_CreateEventBlock(e,t,s){const i=vb.EventBlock.Create(this,t,e);if(i.IsOrBlock()){s.push(i);const e=i.GetConditions();for(let t=0,s=e.length;t<s;++t)e[t].IsTrigger()&&this._InitTrigger(i,t)}else i.IsTrigger()?this._InitTrigger(i,0):s.push(i)}_CreateFunctionBlock(e,t){const s=vb.FunctionBlock.CreateFunctionBlock(this,t,e);this._eventSheetManager._RegisterFunctionBlock(s)}_CreateCustomACEBlock(e,t){const s=vb.FunctionBlock.CreateCustomACEBlock(this,t,e);this._eventSheetManager._RegisterFunctionBlock(s)}_CreateEventVariable(e,t,s){const i=vb.EventVariable.Create(this,t,e);s.push(i)}_CreateInclude(e,t,s){const i=vb.EventInclude.Create(this,t,e);s.push(i)}_CreateScriptBlock(e,t,s){const i=vb.EventScript.Create(this,t,e);s.push(i)}_InitTrigger(e,t){e.IsOrBlock()||this._eventSheetManager._AddTriggerToPostInit(e);const s=e.GetConditionAt(t),i=s._GetFunc(),r=s.GetObjectClass();if(s.IsFastTrigger()){let n=this._fastTriggers.get(r);n||(n=new Map,this._fastTriggers.set(r,n));const a=s.GetFastTriggerValue().toLowerCase();let o=n.get(i);o||(o=new Map,n.set(i,o));let l=o.get(a);l||(l=[],o.set(a,l)),l.push([e,t])}else{let n=this._triggers.get(r);n||(n={methodMap:new Map,behaviors:new Map},this._triggers.set(r,n));const a=s.GetBehaviorType();let o;a?(o=n.behaviors.get(a),o||(o=new Map,n.behaviors.set(a,o))):o=n.methodMap;let l=o.get(i);l||(l=[],o.set(i,l)),l.push([e,t])}}_PostInit(){const e=this._events;for(let t=0,s=e.length;t<s;++t){const i=t<s-1&&e[t+1]instanceof vb.EventBlock&&e[t+1].IsElseBlock();e[t]._PostInit(i)}}_AddShallowInclude(e){this._shallowIncludes.push(e)}_UpdateDeepIncludes(){vb.clearArray(this._deepIncludes),this._AddDeepIncludes(this),this._alreadyIncludedSheets.clear()}_AddDeepIncludes(e){const t=e._deepIncludes,s=e._alreadyIncludedSheets;for(const i of this._shallowIncludes){const r=i.GetIncludeSheet();i.IsActive()&&e!==r&&!s.has(r)&&(s.add(r),r._AddDeepIncludes(e),t.push(r))}}deepIncludes(){return this._deepIncludes}GetEventSheetManager(){return this._eventSheetManager}GetRuntime(){return this._runtime}GetName(){return this._name}_RegisterEventByDisplayNumber(e,t){this._eventsByDisplayNumber.set(t,e)}_GetEventByDisplayNumber(e){return this._eventsByDisplayNumber.get(e)||null}_ResetHasRunFlag(){this._hasRun=!1}Run(){if(this._hasRun)return;const e=this._runtime,t=e.IsCPUProfiling(),s=t?performance.now():0;this._hasRun=!0;const i=this.GetEventSheetManager(),r=i.GetCurrentEventStackFrame();for(const t of this._events)t.Run(r),i.ClearSol(t.GetSolModifiers()),i.ClearAsyncActionPromises(),e.FlushPendingInstances();r.Reset(null),t&&(this._perfRecord.totalTimeCounter+=performance.now()-s)}*DebugRun(){if(this._hasRun)return;this._hasRun=!0;const e=this._runtime,t=this.GetEventSheetManager(),s=t.GetCurrentEventStackFrame();for(const i of this._events)yield*i.DebugRun(s),t.ClearSol(i.GetSolModifiers()),t.ClearAsyncActionPromises(),e.FlushPendingInstances();s.Reset(null)}_Trigger(e,t,s){if(!t)return this._TriggerForClass(e,t,null,null);{const i=t.GetObjectClass();let r=!1,n=this._TriggerForClass(e,t,i,s);r=r||n;for(const a of i.GetFamilies())n=this._TriggerForClass(e,t,a,s),r=r||n}}_TriggerForClass(e,t,s,i){const r=this._triggers.get(s);if(!r)return!1;const n=i?r.behaviors.get(i):r.methodMap;if(!n)return!1;const a=n.get(e);if(!a)return!1;let o=!1;for(const[e,s]of a){const i=this._ExecuteTrigger(t,e,s);o=o||i}return o}*_DebugTrigger(e,t,s){if(!t)return yield*this._DebugTriggerForClass(e,t,null,null);{const i=t.GetObjectClass();let r=!1,n=yield*this._DebugTriggerForClass(e,t,i,s);r=r||n;for(const a of i.GetFamilies())n=yield*this._DebugTriggerForClass(e,t,a,s),r=r||n}}*_DebugTriggerForClass(e,t,s,i){const r=this._triggers.get(s);if(!r)return!1;const n=i?r.behaviors.get(i):r.methodMap;if(!n)return!1;const a=n.get(e);if(!a)return!1;let o=!1;for(const[e,s]of a){let i;i=e.DebugCanRunFast()?this._ExecuteTrigger(t,e,s):yield*this._DebugExecuteTrigger(t,e,s),o=o||i}return o}_FastTrigger(e,t,s){const i=t.GetObjectClass(),r=this._fastTriggers.get(i);if(!r)return!1;const n=r.get(e);if(!n)return!1;const a=n.get(s);if(!a)return!1;let o=!1;for(let e=0,t=a.length;e<t;++e){const t=a[e],s=this._ExecuteTrigger(null,t[0],t[1]);o=o||s}return o}*_DebugFastTrigger(e,t,s){const i=t.GetObjectClass(),r=this._fastTriggers.get(i);if(!r)return!1;const n=r.get(e);if(!n)return!1;const a=n.get(s);if(!a)return!1;let o=!1;for(let e=0,t=a.length;e<t;++e){const t=a[e],s=t[0],i=t[1];let r;r=s.DebugCanRunFast()?this._ExecuteTrigger(null,s,i):yield*this._DebugExecuteTrigger(null,s,i),o=o||r}return o}_ExecuteTrigger(e,t,s){const i=this._runtime,r=this._eventSheetManager,n=r.GetCurrentEvent(),a=r.GetEventStack(),o=r.GetTriggerDepth();let l=!1;n&&r.PushCleanSol(n.GetSolModifiersIncludingParents()),r.PushCleanSol(t.GetSolModifiersIncludingParents());const h=o>1;h&&r.GetLocalVarStack().Push();const u=a.Push(t);e&&(t.GetConditions()[s].GetObjectClass().GetCurrentSol().SetSinglePicked(e),e.IsInContainer()&&e.SetSiblingsSinglePicked());let c=!0;if(t.GetParent()){const e=t.GetTriggerParents();for(let t=0,s=e.length;t<s;++t)if(!e[t].RunPreTrigger(u)){c=!1;break}}return c&&(t.IsOrBlock()?t.RunOrBlockTrigger(u,s):t.Run(u),l=u.GetLastEventTrue()),a.Pop(),h&&r.GetLocalVarStack().Pop(),r.PopSol(t.GetSolModifiersIncludingParents()),n&&r.PopSol(n.GetSolModifiersIncludingParents()),n||1!==o||(r.ClearAsyncActionPromises(),r.IsFlushingBlocked()||i.FlushPendingInstances()),l}*_DebugExecuteTrigger(e,t,s){const i=this._runtime,r=this._eventSheetManager,n=r.GetCurrentEvent(),a=r.GetEventStack(),o=r.GetTriggerDepth();let l=!1;n&&r.PushCleanSol(n.GetSolModifiersIncludingParents()),r.PushCleanSol(t.GetSolModifiersIncludingParents());const h=o>1;h&&r.GetLocalVarStack().Push();const u=a.Push(t);e&&(t.GetConditions()[s].GetObjectClass().GetCurrentSol().SetSinglePicked(e),e.IsInContainer()&&e.SetSiblingsSinglePicked());let c=!0;if(t.GetParent()){const e=t.GetTriggerParents();for(let t=0,s=e.length;t<s;++t)if(!(yield*e[t].DebugRunPreTrigger(u))){c=!1;break}}return c&&(t.IsOrBlock()?yield*t.DebugRunOrBlockTrigger(u,s):yield*t.DebugRun(u),l=u.GetLastEventTrue()),a.Pop(),h&&r.GetLocalVarStack().Pop(),r.PopSol(t.GetSolModifiersIncludingParents()),n&&r.PopSol(n.GetSolModifiersIncludingParents()),n||1!==o||(r.ClearAsyncActionPromises(),r.IsFlushingBlocked()||i.FlushPendingInstances()),l}_GetPerfRecord(){return this._perfRecord}}}{let Cb=function(e,t){return!0};NoActions=Cb;const wb=self.C3,Ab=[];function*Rb(e,t){return!0}wb.EventBlock=class extends wb.DefendedBase{constructor(e,t,s){super(),this._eventSheet=e,this._runtime=e.GetRuntime(),this._parent=t,this._scopeParent=null,this._eventStack=this._runtime.GetEventSheetManager().GetEventStack(),this._solModifiers=[],this._solModifiersIncludingParents=[],this._hasGotSolModifiersIncludingParents=!1,this._isSolWriterAfterCnds=!1,this._isTopLevelGroup=!1,this._hasElseBlock=!1,this._isOrBlock=!!s[2],this._isElseBlock=!1,this._triggerParents=null,this._conditions=[],this._actions=[],this._subEvents=[],this._RunActions=Cb,this._DebugRunActions=Rb,this._isGroup=!1,this._isInitiallyActive=!1,this._groupName="",this._isGroupActive=!1,this._containedIncludes=null,this._perfRecord=null,this._sid=s[4],this._displayNumber=s[5],this._eventSheet._RegisterEventByDisplayNumber(this,this._displayNumber),this._debugData=this._runtime.IsDebug()?{isBreakpoint:s[3][0],isBreakable:s[3][1],canRunAllConditionsFast:!1,canRunAllActionsFast:!1,canRunAllSubEventsFast:!1,canRunSelfFast:!1}:null,this.GetEventSheetManager()._RegisterEventBlock(this),3===s[0]&&this._InitGroup(s[1]);let i=0;for(const e of s[6]){const t=wb.Condition.Create(this,e,i++);this._conditions.push(t),this._AddSolModifier(t.GetObjectClass())}i=0;for(const e of s[7]){const t=wb.Action.Create(this,e,i++);this._actions.push(t)}if(9===s.length){const e=s[8];for(const t of e)this._eventSheet._CreateEvent(t,this,this._subEvents)}this._conditions.length&&(this._isElseBlock=null===this._conditions[0].GetObjectClass()&&this._conditions[0]._GetFunc()===wb.Plugins.System.Cnds.Else),0===this._conditions.length&&(this._conditions=Ab),0===this._actions.length&&(this._actions=Ab),0===this._subEvents.length&&(this._subEvents=Ab)}static Create(e,t,s){return wb.New(wb.EventBlock,e,t,s)}_InitGroup(e){this._isGroup=!0,this._isInitiallyActive=!!e[0],this._isGroupActive=this._isInitiallyActive,this._groupName=e[1].toLowerCase(),this._containedIncludes=[],this.GetEventSheetManager()._RegisterGroup(this),this._runtime.IsDebug()&&(this._perfRecord={type:"group",name:e[1],totalTimeCounter:0,children:[]})}_AddContainedInclude(e){this._containedIncludes.push(e)}_AddContainerSolModifierToList(e,t){for(const s of e.GetContainer().objectTypes())t.includes(s)||t.push(s)}_AddSolModifierToList(e,t){if(e)if(t.includes(e)||t.push(e),e.IsFamily())for(const s of e.GetFamilyMembers())s.IsInContainer()&&this._AddContainerSolModifierToList(s,t);else e.IsInContainer()&&this._AddContainerSolModifierToList(e,t)}_AddSolModifier(e){this._AddSolModifierToList(e,this._solModifiers)}_AddParentSolModifier(e){this._AddSolModifierToList(e,this._solModifiersIncludingParents)}SetAllSolModifiers(){this._solModifiers=this._runtime.GetAllObjectClasses()}_PostInit(e){this._hasElseBlock=!!e,this._IdentifyTopLevelGroup(),this._IdentifyTriggerParents();for(const e of this._conditions)e._PostInit();if(this._actions.length>0){let e=!1;for(const t of this._actions)t._PostInit(),t.HasReturnType()&&(e=!0);e?(this._RunActions=this._RunActions_ReturnValue,this._DebugRunActions=this._DebugRunActions_ReturnValue):(this._RunActions=this._RunActions_Fast,this._DebugRunActions=this._DebugRunActions_Fast)}const t=this._subEvents;for(let e=0,s=t.length;e<s;++e){const i=e<s-1&&t[e+1]instanceof wb.EventBlock&&t[e+1].IsElseBlock();t[e]._PostInit(i)}this._debugData&&this._UpdateCanRunFast(),this._perfRecord&&this._GetPerfRecordParent()._GetPerfRecord().children.push(this._perfRecord)}_GetPerfRecord(){return this._perfRecord}_GetPerfRecordParent(){let e=this.GetParent();for(;e;){if(e.IsGroup())return e;e=e.GetParent()}return this._eventSheet}_UpdateCanRunFast(){const e=this._debugData;e.canRunAllConditionsFast=this._conditions.every(e=>e.DebugCanRunFast()),e.canRunAllActionsFast=this._actions.every(e=>e.DebugCanRunFast()),e.canRunAllSubEventsFast=this._subEvents.every(e=>e.DebugCanRunFast()),e.canRunSelfFast=e.canRunAllConditionsFast&&e.canRunAllActionsFast&&e.canRunAllSubEventsFast}_UpdateCanRunFastRecursive(){let e=this;do{e._UpdateCanRunFast(),e=e.GetParent()}while(e)}_IdentifyTopLevelGroup(){if(!this.IsGroup())return;let e=this.GetParent();for(this._isTopLevelGroup=!0;e;){if(!e.IsGroup()){this._isTopLevelGroup=!1;break}e=e.GetParent()}}_IdentifySolModifiersIncludingParents(){const e=this._runtime.GetAllObjectClasses();if(this._solModifiers===e)this._solModifiersIncludingParents=e;else{this._solModifiersIncludingParents=wb.cloneArray(this._solModifiers);let e=this.GetParent();for(;e;){for(const t of e._solModifiers)this._AddParentSolModifier(t);e=e.GetParent()}const t=this.GetEventSheetManager();this._solModifiers=t._DeduplicateSolModifierList(this._solModifiers),this._solModifiersIncludingParents=t._DeduplicateSolModifierList(this._solModifiersIncludingParents)}}_IdentifyTriggerParents(){if(!this.HasAnyTriggeredCondition())return;this._triggerParents=[];let e=this.GetParent();for(;e;)this._triggerParents.push(e),e=e.GetParent();this._triggerParents.reverse()}SetSolWriterAfterCnds(){this._isSolWriterAfterCnds=!0,this._parent&&this._parent.SetSolWriterAfterCnds()}IsSolWriterAfterCnds(){return this._isSolWriterAfterCnds}GetSolModifiers(){return this._solModifiers}GetSolModifiersIncludingParents(){return this._hasGotSolModifiersIncludingParents||(this._hasGotSolModifiersIncludingParents=!0,this._IdentifySolModifiersIncludingParents()),this._solModifiersIncludingParents}HasSolModifier(e){return this._solModifiers.includes(e)}GetTriggerParents(){return this._triggerParents}GetEventSheet(){return this._eventSheet}GetEventSheetManager(){return this._eventSheet.GetEventSheetManager()}GetRuntime(){return this._runtime}GetParent(){return this._parent}_SetScopeParent(e){this._scopeParent=e}GetScopeParent(){return this._scopeParent||this._parent}GetDisplayNumber(){return this._displayNumber}IsDebugBreakable(){return this._debugData&&this._debugData.isBreakable}IsDebugBreakpoint(){return this.IsDebugBreakable()&&this._debugData.isBreakpoint}_SetDebugBreakpoint(e){this._debugData.isBreakpoint=!!e,this._UpdateCanRunFastRecursive()}IsGroup(){return this._isGroup}IsTopLevelGroup(){return this._isTopLevelGroup}IsElseBlock(){return this._isElseBlock}HasElseBlock(){return this._hasElseBlock}GetGroupName(){return this._groupName}IsGroupActive(){return this._isGroupActive}ResetInitialActivation(){this.SetGroupActive(this._isInitiallyActive)}SetGroupActive(e){if(e=!!e,!this._isGroup)throw new Error("not a group");if(this._isGroupActive!==e){this._isGroupActive=e;for(const e of this._containedIncludes)e.UpdateActive();if(this._containedIncludes.length){const e=this._runtime.GetCurrentLayout().GetEventSheet();e&&e._UpdateDeepIncludes()}}}GetSID(){return this._sid}IsOrBlock(){return this._isOrBlock}IsTrigger(){return this._conditions.length&&this._conditions[0].IsTrigger()}IsForFunctionBlock(){return this._scopeParent&&this._scopeParent instanceof wb.FunctionBlock}HasAnyTriggeredCondition(){return this.IsForFunctionBlock()||this._conditions.some(e=>e.IsTrigger())}GetConditions(){return this._conditions}GetConditionCount(){return this._conditions.length}GetConditionAt(e){if((e=Math.floor(e))<0||e>=this._conditions.length)throw new RangeError("invalid condition index");return this._conditions[e]}GetConditionByDebugIndex(e){return this.GetConditionAt(e)}IsFirstConditionOfType(e){let t=e.GetIndex();if(0===t)return!0;--t;const s=e.IsSystemOrSingleGlobalCondition()?e.GetFirstObjectParameterObjectClass():e.GetObjectClass();for(;t>=0;--t){const e=this._conditions[t];if(s===e.GetObjectClass()||e.IsSystemOrSingleGlobalCondition()&&e.GetFirstObjectParameterObjectClass()===s)return!1}return!0}GetActions(){return this._actions}GetActionCount(){return this._actions.length}GetActionAt(e){if((e=Math.floor(e))<0||e>=this._actions.length)throw new RangeError("invalid action index");return this._actions[e]}GetActionByDebugIndex(e){e=Math.floor(e);const t=this._actions.find(t=>t.GetDebugIndex()===e);if(!t)throw new RangeError("invalid action debug index");return t}_HasActionIndex(e){return(e=Math.floor(e))>=0&&e<this._actions.length}GetSubEvents(){return this._subEvents}_GetAllLocalVariablesInScope(){return this._subEvents.filter(e=>e instanceof wb.EventVariable)}RunPreTrigger(e){e.SetCurrentEvent(this);const t=this._conditions;let s=0===t.length;for(let i=0,r=t.length;i<r;++i){const r=t[i];if(e.SetConditionIndex(i),r.IsLooping())throw new Error("trigger cannot be used as sub-event to a loop");if(r.Run())s=!0;else if(!this._isOrBlock)return!1}return!this._isOrBlock||s}RunOrBlockTrigger(e,t){e.SetCurrentEvent(this),e.SetConditionIndex(t),this._conditions[t].Run()&&(this._RunActions(e,0)&&this._RunSubEvents(e),e.SetLastEventTrue(!0))}*DebugRunPreTrigger(e){e.SetCurrentEvent(this);const t=this._conditions;let s=0===t.length;for(let i=0,r=t.length;i<r;++i){const r=t[i];if(e.SetConditionIndex(i),r.IsLooping())throw new Error("trigger cannot be used as sub-event to a loop");let n;if(n=r.DebugCanRunFast()?r.Run():yield*r.DebugRun(),n)s=!0;else if(!this._isOrBlock)return!1}return!this._isOrBlock||s}*DebugRunOrBlockTrigger(e,t){e.SetCurrentEvent(this),e.SetConditionIndex(t);const s=this._conditions[t];let i;if(i=s.DebugCanRunFast()?s.Run():yield*s.DebugRun(),i){let t;t=this.DebugCanRunActionsFast()?this._RunActions(e,0):yield*this._DebugRunActions(e,0),t&&(this.DebugCanRunSubEventsFast()?this._RunSubEvents():yield*this._DebugRunSubEvents()),e.SetLastEventTrue(!0)}}Run(e){e.SetCurrentEvent(this),this._isElseBlock||e.SetElseBranchRan(!1),this._isOrBlock?this._RunOrBlock(e):this._RunAndBlock(e)}*DebugRun(e){(this.IsDebugBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),e.SetCurrentEvent(this),this._isElseBlock||e.SetElseBranchRan(!1),this._isOrBlock?yield*this._DebugRunOrBlock(e):yield*this._DebugRunAndBlock(e)}_RunOrBlock(e){const t=this._conditions;let s=0===t.length;for(let i=0,r=t.length;i<r;++i){const r=t[i];if(r.IsTrigger())continue;e.SetConditionIndex(i);const n=r.Run();s=s||n}e.SetLastEventTrue(s),s&&(this._RunActions(e,0)&&this._RunSubEvents(e),this._hasElseBlock&&e.SetElseBranchRan(!0))}*_DebugRunOrBlock(e){const t=this._conditions;let s=0===t.length;for(let i=0,r=t.length;i<r;++i){const r=t[i];if(r.IsTrigger())continue;let n;e.SetConditionIndex(i),n=r.DebugCanRunFast()?r.Run():yield*r.DebugRun(),s=s||n}if(e.SetLastEventTrue(s),s){let t;t=this.DebugCanRunActionsFast()?this._RunActions(e,0):yield*this._DebugRunActions(e,0),t&&(this.DebugCanRunSubEventsFast()?this._RunSubEvents():yield*this._DebugRunSubEvents()),this._hasElseBlock&&e.SetElseBranchRan(!0)}}_RunAndBlock(e){const t=this._conditions;for(let s=0,i=t.length;s<i;++s){const i=t[s];if(e.SetConditionIndex(s),!i.Run())return void e.SetLastEventTrue(!1)}e.SetLastEventTrue(!0),this._RunActions(e,0)&&this._RunSubEvents(e),e.GetLastEventTrue()&&this._hasElseBlock&&e.SetElseBranchRan(!0)}*_DebugRunAndBlock(e){const t=this._conditions;for(let s=0,i=t.length;s<i;++s){const i=t[s];let r;if(e.SetConditionIndex(s),r=i.DebugCanRunFast()?i.Run():yield*i.DebugRun(),!r)return void e.SetLastEventTrue(!1)}let s;e.SetLastEventTrue(!0),s=this.DebugCanRunActionsFast()?this._RunActions(e,0):yield*this._DebugRunActions(e,0),s&&(this.DebugCanRunSubEventsFast()?this._RunSubEvents():yield*this._DebugRunSubEvents()),e.GetLastEventTrue()&&this._hasElseBlock&&e.SetElseBranchRan(!0)}_RunActions_Fast(e,t){const s=this._actions;for(let i=t,r=s.length;i<r;++i){const t=s[i];e.SetActionIndex(i),t.Run()}return!0}*_DebugRunActions_Fast(e,t){const s=this._actions;for(let i=t,r=s.length;i<r;++i){const t=s[i];e.SetActionIndex(i),t.DebugCanRunFast()?t.Run():yield*t.DebugRun()}return!0}_RunActions_ReturnValue(e,t){const s=this.GetEventSheetManager(),i=this._actions;for(let r=t,n=i.length;r<n;++r){const t=i[r];e.SetActionIndex(r);const n=t.Run();if(t.CanBailOut()&&!0===n)return!1;t.IsAsync()&&n instanceof Promise&&s.AddAsyncActionPromise(n)}return!0}*_DebugRunActions_ReturnValue(e,t){const s=this.GetEventSheetManager(),i=this._actions;for(let r=t,n=i.length;r<n;++r){const t=i[r];let n;if(e.SetActionIndex(r),n=t.DebugCanRunFast()?t.Run():yield*t.DebugRun(),t.CanBailOut()&&!0===n)return!1;t.IsAsync()&&n instanceof Promise&&s.AddAsyncActionPromise(n)}return!0}_ResumeActionsAndSubEvents(e){this._RunActions(e,e.GetActionIndex())&&this._RunSubEvents()}*_DebugResumeActionsAndSubEvents(e){(yield*this._DebugRunActions(e,e.GetActionIndex()))&&(yield*this._DebugRunSubEvents())}_RunSubEvents(){if(!this._subEvents.length)return;const e=this.IsGroup()&&this._runtime.IsCPUProfiling(),t=e?performance.now():0,s=this._eventStack,i=s.Push(this);this._isSolWriterAfterCnds?this._RunSubEvents_SolWriterAfterCnds(i):this._RunSubEvents_Fast(i),s.Pop(),e&&(this._perfRecord.totalTimeCounter+=performance.now()-t)}_RunSubEvents_SolWriterAfterCnds(e){const t=this._isGroup,s=this._isTopLevelGroup,i=this.GetEventSheetManager(),r=this._subEvents;for(let n=0,a=r.length,o=a-1;n<a;++n){const a=r[n],l=a.GetSolModifiers(),h=!s||!t&&n<o;h&&i.PushCopySol(l),a.Run(e),h?i.PopSol(l):i.ClearSol(l)}}_RunSubEvents_Fast(e){const t=this._subEvents;for(let s=0,i=t.length;s<i;++s)t[s].Run(e)}*_DebugRunSubEvents(){if(!this._subEvents.length)return;const e=this._eventStack,t=e.Push(this);this._isSolWriterAfterCnds?yield*this._DebugRunSubEvents_SolWriterAfterCnds(t):yield*this._DebugRunSubEvents_Fast(t),e.Pop()}*_DebugRunSubEvents_SolWriterAfterCnds(e){const t=this._isGroup,s=this._isTopLevelGroup,i=this.GetEventSheetManager(),r=this._subEvents;for(let n=0,a=r.length,o=a-1;n<a;++n){const a=r[n],l=a.GetSolModifiers(),h=!s||!t&&n<o;h&&i.PushCopySol(l),yield*a.DebugRun(e),h?i.PopSol(l):i.ClearSol(l)}}*_DebugRunSubEvents_Fast(e){const t=this._subEvents;for(let s=0,i=t.length;s<i;++s)yield*t[s].DebugRun(e)}Retrigger(e,t){t.ResetQuick();const s=this._conditions;if(!this.IsOrBlock())for(let i=e.GetConditionIndex()+1,r=s.length;i<r;++i){const e=s[i];if(t.SetConditionIndex(i),!e.Run())return!1}return this._RunActions(t,0)&&this._RunSubEvents(t),!0}*DebugRetrigger(e,t){t.ResetQuick();const s=this._conditions;if(!this.IsOrBlock())for(let i=e.GetConditionIndex()+1,r=s.length;i<r;++i){const e=s[i];let r;if(t.SetConditionIndex(i),r=e.DebugCanRunFast()?e.Run():yield*e.DebugRun(),!r)return!1}let i;return i=this.DebugCanRunActionsFast()?this._RunActions(t,0):yield*this._DebugRunActions(t,0),i&&(this.DebugCanRunSubEventsFast()?this._RunSubEvents():yield*this._DebugRunSubEvents()),!0}DebugCanRunFast(){return!this.IsDebugBreakpoint()&&!this._runtime.DebugBreakNext()&&this._debugData.canRunSelfFast}DebugCanRunActionsFast(){return!this._runtime.DebugBreakNext()&&this._debugData.canRunAllActionsFast}DebugCanRunSubEventsFast(){return!this._runtime.DebugBreakNext()&&this._debugData.canRunAllSubEventsFast}_CheckParentsOKToRun(e){if(this.GetParent()){const t=this.GetTriggerParents();for(let s=0,i=t.length;s<i;++s)if(!t[s].RunPreTrigger(e))return!1}return!0}*_DebugCheckParentsOKToRun(e){if(this.GetParent()){const t=this.GetTriggerParents();for(let s=0,i=t.length;s<i;++s)if(!(yield*t[s].DebugRunPreTrigger(e)))return!1}return!0}_EvaluateFunctionCallParameters(e,t,s){if(t.length>0)if(s){const s=t.map(e=>e.Get(0));e.GetLocalVarStack().Push(),this._scopeParent.SetFunctionParameters(s)}else this._scopeParent.EvaluateFunctionParameters(t);else s&&e.GetLocalVarStack().Push()}RunAsFunctionCall(e,t,s,i){let r,n;const a=e.length>0;let o=null;const l=this._runtime,h=this._eventStack,u=l.GetEventSheetManager(),c=this._scopeParent,d=c.IsAsync(),p=u._IncTriggerDepth()>1;if(this._EvaluateFunctionCallParameters(u,t,p),a&&(s?u.PushCopySol(e):u.PushCleanSol(e)),null!==i){if(i.copyFromObjectClass){const e=s?i.copyFromObjectClass.GetCurrentSol():i.copyFromObjectClass.GetSolStack().GetOneBelowCurrentSol(),t=i.copyToObjectClass.GetCurrentSol();t.SetArrayPicked(e.GetInstances()),t.ClearElseInstances(),s||i.copyToObjectClass.ApplySolToContainer()}else if(i.pickObjectClass){const e=i.pickObjectClass.GetCurrentSol();e.SetArrayPicked(i.pickInstances),e.ClearElseInstances()}i.pushCleanSolDynamic&&(o=u.PushCleanSolDynamic(e))}const _=h.Push(this);return s&&_.SetDynamicSolModifiers(e),this._CheckParentsOKToRun(_)&&(_.SetCurrentEvent(this),d&&([n,r]=c.StartAsyncFunctionCall()),this._RunAndBlock(_),d&&c.MaybeFinishAsyncFunctionCall(n)),h.Pop(),p&&u.GetLocalVarStack().Pop(),null!==o&&u.PopSol(o),a&&u.PopSol(e),u._DecTriggerDepth(),r}*DebugRunAsFunctionCall(e,t,s,i){let r,n;(this.IsDebugBreakpoint()||this._runtime.DebugBreakNext())&&(yield this);const a=e.length>0;let o=null;const l=this._runtime,h=this._eventStack,u=l.GetEventSheetManager(),c=this._scopeParent,d=c.IsAsync(),p=u._IncTriggerDepth()>1;if(this._EvaluateFunctionCallParameters(u,t,p),a&&(s?u.PushCopySol(e):u.PushCleanSol(e)),null!==i){if(i.copyFromObjectClass){const e=s?i.copyFromObjectClass.GetCurrentSol():i.copyFromObjectClass.GetSolStack().GetOneBelowCurrentSol(),t=i.copyToObjectClass.GetCurrentSol();t.SetArrayPicked(e.GetInstances()),t.ClearElseInstances(),s||i.copyToObjectClass.ApplySolToContainer()}else if(i.pickObjectClass){const e=i.pickObjectClass.GetCurrentSol();e.SetArrayPicked(i.pickInstances),e.ClearElseInstances()}i.pushCleanSolDynamic&&(o=u.PushCleanSolDynamic(e))}const _=h.Push(this);return s&&_.SetDynamicSolModifiers(e),(yield*this._DebugCheckParentsOKToRun(_))&&(_.SetCurrentEvent(this),d&&([n,r]=c.StartAsyncFunctionCall()),yield*this._DebugRunAndBlock(_),d&&c.MaybeFinishAsyncFunctionCall(n)),h.Pop(),p&&u.GetLocalVarStack().Pop(),null!==o&&u.PopSol(o),a&&u.PopSol(e),u._DecTriggerDepth(),r}RunAsMappedFunctionCall(e,t){const s=this.GetSolModifiersIncludingParents(),i=s.length>0,r=this._runtime,n=this._eventStack,a=r.GetEventSheetManager(),o=a._IncTriggerDepth()>1;o&&a.GetLocalVarStack().Push(),this._scopeParent.SetFunctionParameters(e),i&&(t?a.PushCopySol(s):a.PushCleanSol(s));const l=n.Push(this);this._CheckParentsOKToRun(l)&&(l.SetCurrentEvent(this),this._RunAndBlock(l)),n.Pop(),o&&a.GetLocalVarStack().Pop(),i&&a.PopSol(s),a._DecTriggerDepth()}*DebugRunAsMappedFunctionCall(e,t){(this.IsDebugBreakpoint()||this._runtime.DebugBreakNext())&&(yield this);const s=this.GetSolModifiersIncludingParents(),i=s.length>0,r=this._runtime,n=this._eventStack,a=r.GetEventSheetManager(),o=a._IncTriggerDepth()>1;o&&a.GetLocalVarStack().Push(),this._scopeParent.SetFunctionParameters(e),i&&(t?a.PushCopySol(s):a.PushCleanSol(s));const l=n.Push(this);(yield*this._DebugCheckParentsOKToRun(l))&&(l.SetCurrentEvent(this),yield*this._DebugRunAndBlock(l)),n.Pop(),o&&a.GetLocalVarStack().Pop(),i&&a.PopSol(s),a._DecTriggerDepth()}RunAsExpressionFunctionCall(e,t,s,i,...r){let n,a;const o=e.length>0,l=this._runtime,h=this._eventStack,u=l.GetEventSheetManager(),c=this._scopeParent,d=c.IsAsync(),p=u._IncTriggerDepth()>1;p&&u.GetLocalVarStack().Push(),r.length>0&&this._scopeParent.SetFunctionParameters(r),o&&(t?u.PushCopySol(e):u.PushCleanSol(e));const _=h.Push(this);return _.InitCallFunctionExpression(s,i),h.PushExpFunc(_),l.SetDebuggingEnabled(!1),this._CheckParentsOKToRun(_)&&(_.SetCurrentEvent(this),d&&([a,n]=c.StartAsyncFunctionCall()),this._RunAndBlock(_),d&&c.MaybeFinishAsyncFunctionCall(a)),l.SetDebuggingEnabled(!0),h.Pop(),h.PopExpFunc(),p&&u.GetLocalVarStack().Pop(),o&&u.PopSol(e),u._DecTriggerDepth(),n||_.GetFunctionReturnValue()}}}{const Pb=self.C3,Mb=[];let Eb=!1;Pb.EventScript=class extends Pb.DefendedBase{constructor(e,t,s){super();const i=e.GetRuntime(),r=e.GetEventSheetManager();this._eventSheet=e,this._eventSheetManager=r,this._runtime=e.GetRuntime(),this._parent=t;const n=i.GetObjectReference(s[1]);this._func=n,this._displayNumber=s[2],this._eventSheet._RegisterEventByDisplayNumber(this,this._displayNumber),this._debugData=i.IsDebug()?{isBreakpoint:s[3][0],isBreakable:s[3][1]}:null}static Create(e,t,s){return Pb.New(Pb.EventScript,e,t,s)}_PostInit(){const e=this._func,t=this._runtime.GetEventSheetManager()._GetLocalVariablesScriptInterface(this);this._func=e.bind(null,this._runtime.GetIRuntime(),t)}GetParent(){return this._parent}GetScopeParent(){return this._parent}GetEventSheet(){return this._eventSheet}GetDisplayNumber(){return this._displayNumber}IsDebugBreakable(){return this._debugData&&this._debugData.isBreakable}IsDebugBreakpoint(){return this.IsDebugBreakable()&&this._debugData.isBreakpoint}_SetDebugBreakpoint(e){this._debugData.isBreakpoint=!!e}IsElseBlock(){return!1}GetSolModifiers(){return Mb}GetSolModifiersIncludingParents(){return this._parent?this._parent.GetSolModifiersIncludingParents():Mb}Run(e){e.SetCurrentEvent(this),this._eventSheetManager.AddAsyncActionPromise(this._RunUserScript())}async _RunUserScript(){try{await this._func()}catch(e){console.error(`Unhandled exception running script %c${this.GetEventSheet().GetName()}, event ${this.GetDisplayNumber()}:`,"font-size: 1.2em; font-weight: bold;",e),self.C3Debugger&&self.C3Debugger._SetLastErrorScript(this),Eb||(console.info("%cTip:%c run this to highlight in Construct the last script that had an error: %cgoToLastErrorScript()","font-weight: bold; text-decoration: underline","","font-weight: bold"),Eb=!0)}}*DebugRun(e){e.SetCurrentEvent(this),(this.IsDebugBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this.Run(e)}DebugCanRunFast(){return!this.IsDebugBreakpoint()&&!this._runtime.DebugBreakNext()}static HadUserScriptException(){return Eb}static SetHadUserScriptException(){Eb=!0}}}{const Db=self.C3,Nb=self.assert;Db.FunctionBlock=class extends Db.DefendedBase{constructor(e,t,s){super(),this._eventSheet=e,this._runtime=e.GetRuntime(),this._parent=t,this._functionType=0,this._functionName="",this._returnType=0,this._functionParameters=[],this._isEnabled=!0,this._aceName="",this._objectClass=null,this._hasOverrides=!1,this._innerLocalVariables=[],this._isCopyPicked=!1,this._isAsync=!1,this._nextAsyncId=0,this._currentAsyncId=-1,this._asyncMap=new Map,this._eventBlock=Db.EventBlock.Create(e,t,s),this._eventBlock._SetScopeParent(this)}InitFunctionBlock(e){this._functionType=0,this._functionName=e[0],this._returnType=e[1],this._functionParameters=e[2].map(e=>Db.EventVariable.Create(this._eventSheet,this,e)),this._isEnabled=e[3],this._isAsync=e[4],this._isCopyPicked=e[5]}InitCustomACEBlock(e){this._functionType=1,this._aceName=e[1],this._objectClass=this._runtime.GetObjectClassByIndex(e[2]),this._eventBlock._AddSolModifier(this._objectClass),this._functionName=this._objectClass.GetName()+"."+this._aceName,this._returnType=e[3],this._functionParameters=e[4].map(e=>Db.EventVariable.Create(this._eventSheet,this,e)),this._isEnabled=e[5],this._isAsync=e[6],this._isCopyPicked=e[7],this._objectClass.AddCustomAction(this)}static CreateFunctionBlock(e,t,s){const i=Db.New(Db.FunctionBlock,e,t,s),r=s[1];return i.InitFunctionBlock(r),i}static CreateCustomACEBlock(e,t,s){const i=Db.New(Db.FunctionBlock,e,t,s),r=s[1];return i.InitCustomACEBlock(r),i}_CheckOverrideState(){if(this._objectClass&&this._objectClass.IsFamily())for(const e of this._objectClass.GetFamilyMembers())if(e.HasOwnCustomActionByName(this._aceName)){this._hasOverrides=!0;break}}_PostInit(){for(const e of this._functionParameters)e._PostInit();this._eventBlock._PostInit(!1)}GetFunctionType(){return this._functionType}_GetAllLocalVariablesInScope(){return this._functionParameters}GetFunctionParameters(){return this._functionParameters}GetFunctionParameterCount(){return this._functionParameters.length}_RegisterLocalVariable(e){this._innerLocalVariables.push(e)}_GetAllInnerLocalVariables(){return this._innerLocalVariables}EvaluateFunctionParameters(e){const t=this._functionParameters;for(let s=0,i=t.length;s<i;++s)t[s].SetValue(e[s].Get(0))}SetFunctionParameters(e){const t=this._functionParameters;for(let s=0,i=t.length;s<i;++s)t[s].SetValue(e[s])}CaptureFunctionParameters(){return this._functionParameters.map(e=>e.GetValue())}GetParent(){return this._parent}GetScopeParent(){return this._parent}GetFunctionName(){return this._functionName}GetACEName(){return this._aceName}HasCustomACEOverrides(){return this._hasOverrides}GetReturnType(){return this._returnType}GetObjectClass(){return this._objectClass}IsEnabled(){return this._isEnabled}GetDefaultReturnValue(){switch(this._returnType){case 0:return null;case 2:return"";default:return 0}}GetEventBlock(){return this._eventBlock}IsCopyPicked(){return this._isCopyPicked}IsAsync(){return this._isAsync}StartAsyncFunctionCall(){const e=this._nextAsyncId++;let t;this._currentAsyncId=e;const s=new Promise(e=>t=e);return this._asyncMap.set(e,{resolve:t,pauseCount:0}),[e,s]}MaybeFinishAsyncFunctionCall(e){const t=this._asyncMap.get(e);0===t.pauseCount&&(t.resolve(),this._asyncMap.delete(e)),this._currentAsyncId=-1}PauseCurrentAsyncFunction(){return this._asyncMap.get(this._currentAsyncId).pauseCount++,this._currentAsyncId}ResumeAsyncFunction(e){this._currentAsyncId=e,this._asyncMap.get(e).pauseCount--}RunAsFamilyCustomActionWithOverrides(e,t){const s=new Map,i=[];for(const e of this._objectClass.GetCurrentSol().GetInstances()){const t=e.GetObjectClass();if(t.HasOwnCustomActionByName(this._aceName)){const i=s.get(t);Array.isArray(i)?i.push(e):s.set(t,[e])}else i.push(e)}if(i.length>0&&this._eventBlock.RunAsFunctionCall(e,t,this._isCopyPicked,{pickObjectClass:this._objectClass,pickInstances:i}),s.size>0)for(const[i,r]of s){const s=i.GetOwnCustomActionByName(this._aceName).GetEventBlock(),n=[...new Set([...e,...s.GetSolModifiers()])];s.RunAsFunctionCall(n,t,this._isCopyPicked,{pickObjectClass:i,pickInstances:r})}}*DebugRunAsFamilyCustomActionWithOverrides(e,t){const s=new Map,i=[];for(const e of this._objectClass.GetCurrentSol().GetInstances()){const t=e.GetObjectClass();if(t.HasOwnCustomActionByName(this._aceName)){const i=s.get(t);Array.isArray(i)?i.push(e):s.set(t,[e])}else i.push(e)}if(i.length>0&&(yield*this._eventBlock.DebugRunAsFunctionCall(e,t,this._isCopyPicked,{pickObjectClass:this._objectClass,pickInstances:i})),s.size>0)for(const[i,r]of s){const s=i.GetOwnCustomActionByName(this._aceName).GetEventBlock(),n=[...new Set([...e,...s.GetSolModifiers()])];yield*s.DebugRunAsFunctionCall(n,t,this._isCopyPicked,{pickObjectClass:i,pickInstances:r})}}}}{const Fb=self.C3,Ob=[];Fb.EventVariable=class extends Fb.DefendedBase{constructor(e,t,s){super();const i=e.GetEventSheetManager();this._eventSheet=e,this._eventSheetManager=i,this._runtime=e.GetRuntime(),this._parent=t,this._localVarStack=i.GetLocalVarStack(),this._name=s[1],this._type=s[2],this._initialValue=s[3],this._isStatic=!!s[4],this._isConstant=!!s[5],this._isFunctionParameter=t instanceof Fb.FunctionBlock,this._sid=s[6],this._jsPropName=this._runtime.GetJsPropName(s[8]),this._scriptSetter=e=>this.SetValue(e),this._scriptGetter=()=>this.GetValue(),this._hasSingleValue=!this._parent||this._isStatic||this._isConstant,this._value=this._initialValue,this._localIndex=-1,this.IsBoolean()&&(this._value=this._value?1:0),!this.IsLocal()||this.IsStatic()||this.IsConstant()||(this._localIndex=i._GetNextLocalVarIndex(this)),i._RegisterEventVariable(this)}static Create(e,t,s){return Fb.New(Fb.EventVariable,e,t,s)}_PostInit(){if(this.IsLocal()&&!this.IsStatic()&&!this.IsConstant()&&!this.IsFunctionParameter()){const e=this._eventSheetManager.FindFirstFunctionBlockParent(this);e&&e._RegisterLocalVariable(this)}}GetName(){return this._name}GetJsPropName(){return this._jsPropName}GetParent(){return this._parent}GetScopeParent(){return this.GetParent()}IsGlobal(){return!this.GetParent()}IsLocal(){return!this.IsGlobal()}IsFunctionParameter(){return this._isFunctionParameter}IsStatic(){return this._isStatic}IsConstant(){return this._isConstant}IsNumber(){return 0===this._type}IsString(){return 1===this._type}IsBoolean(){return 2===this._type}IsElseBlock(){return!1}GetSID(){return this._sid}GetInitialValue(){return this._initialValue}GetSolModifiers(){return Ob}Run(e){!this.IsLocal()||this.IsStatic()||this.IsConstant()||this.SetValue(this.GetInitialValue())}DebugCanRunFast(){return!0}*DebugRun(e){this.Run(e)}SetValue(e){this.IsNumber()?"number"!=typeof e&&(e=parseFloat(e)):this.IsString()?"string"!=typeof e&&(e=e.toString()):this.IsBoolean()&&(e=e?1:0),this._hasSingleValue?this._value=e:this._localVarStack.GetCurrent()[this._localIndex]=e}GetValue(){return this._hasSingleValue?this._value:this._localVarStack.GetCurrent()[this._localIndex]}GetTypedValue(){let e=this.GetValue();return this.IsBoolean()&&(e=!!e),e}ResetToInitialValue(){this._value=this._initialValue}_GetScriptInterfaceDescriptor(){return{configurable:!1,enumerable:!0,get:this._scriptGetter,set:this._scriptSetter}}}}{const Bb=self.C3,Lb=self.assert,kb=[];Bb.EventInclude=class extends Bb.DefendedBase{constructor(e,t,s){super();const i=e.GetEventSheetManager();this._eventSheet=e,this._eventSheetManager=i,this._runtime=e.GetRuntime(),this._parent=t,this._includeSheet=null,this._includeSheetName=s[1],this._isActive=!0}static Create(e,t,s){return Bb.New(Bb.EventInclude,e,t,s)}_PostInit(){this._includeSheet=this._eventSheetManager.GetEventSheetByName(this._includeSheetName),this._eventSheet._AddShallowInclude(this);let e=this.GetParent();for(;e;)e instanceof Bb.EventBlock&&e.IsGroup()&&e._AddContainedInclude(this),e=e.GetParent();this.UpdateActive(),this._runtime.IsDebug()&&this._eventSheet._GetPerfRecord().children.push(this._includeSheet._GetPerfRecord())}GetParent(){return this._parent}GetSolModifiers(){return kb}GetIncludeSheet(){return this._includeSheet}Run(e){const t=!!this.GetParent(),s=this._runtime.GetAllObjectClasses();t&&this._eventSheetManager.PushCleanSol(s),this._includeSheet.Run(),t&&this._eventSheetManager.PopSol(s)}*DebugRun(e){const t=!!this.GetParent(),s=this._runtime.GetAllObjectClasses();t&&this._eventSheetManager.PushCleanSol(s),yield*this._includeSheet.DebugRun(),t&&this._eventSheetManager.PopSol(s)}DebugCanRunFast(){return!1}IsActive(){return this._isActive}UpdateActive(){let e=this.GetParent();for(;e;){if(e instanceof Bb.EventBlock&&e.IsGroup()&&!e.IsGroupActive())return void(this._isActive=!1);e=e.GetParent()}this._isActive=!0}}}{let Vb=function(e,t){return e>=t?e%t:e<0?(e<=-t&&(e%=t),e<0&&(e+=t),e):e};WrapIndex=Vb;const Ub=self.C3,Wb=self.assert;Ub.ExpNode=class extends Ub.DefendedBase{constructor(e){super(),this._owner=e,this._runtime=e.GetRuntime()}_PostInit(){}static CreateNode(e,t){const s=t[0],i=[qb,jb,Yb,Xb,Hb,zb];return Ub.New(i[s],e,t)}};class Hb extends Ub.ExpNode{constructor(e,t){super(e),this._systemPlugin=this._runtime.GetSystemPlugin(),this._func=this._runtime.GetObjectReference(t[1]),this._func!==Ub.Plugins.System.Exps.random&&this._func!==Ub.Plugins.System.Exps.choose||this._owner.SetVariesPerInstance()}GetBoundMethod(){return this._systemPlugin._GetBoundACEMethod(this._func,this._systemPlugin)}}class zb extends Ub.ExpNode{constructor(e,t){super(e),this._functionBlock=null,this._functionName=t[1],this._owner.SetVariesPerInstance()}_PostInit(){const e=this._runtime.GetEventSheetManager();this._functionBlock=e.GetFunctionBlockByName(this._functionName),this._functionName=null;const t=this._owner.GetEventBlock(),s=this._functionBlock.GetEventBlock();this._combinedSolModifiers=[...new Set([...t.GetSolModifiersIncludingParents(),...s.GetSolModifiersIncludingParents()])],this._combinedSolModifiers=e._DeduplicateSolModifierList(this._combinedSolModifiers)}GetBoundMethod(){const e=this._functionBlock;if(e.IsEnabled()){const t=e.GetEventBlock();return Ub.EventBlock.prototype.RunAsExpressionFunctionCall.bind(t,this._combinedSolModifiers,e.IsCopyPicked(),e.GetReturnType(),e.GetDefaultReturnValue())}{const t=e.GetDefaultReturnValue();return()=>t}}}class jb extends Ub.ExpNode{constructor(e,t){super(e),this._objectClass=this._runtime.GetObjectClassByIndex(t[1]),this._func=this._runtime.GetObjectReference(t[2]),this._returnsString=!!t[3],this._eventStack=this._runtime.GetEventSheetManager().GetEventStack(),this._owner._MaybeVaryFor(this._objectClass)}GetBoundMethod(){return this._objectClass.GetPlugin()._GetBoundACEMethod(this._func,this._objectClass.GetSingleGlobalInstance().GetSdkInstance())}ExpObject(...e){const t=this._objectClass,s=t.GetCurrentSol().GetExpressionInstances(),i=s.length;if(0===i)return this._returnsString?"":0;const r=Vb(this._owner.GetSolIndex(),i);return this._eventStack.GetCurrentStackFrame().SetExpressionObjectClass(t),this._func.apply(s[r].GetSdkInstance(),e)}ExpObject_InstExpr(e,...t){const s=this._objectClass,i=s.GetInstances(),r=i.length;if(0===r||"number"!=typeof e)return this._returnsString?"":0;const n=Vb(e,r);return this._eventStack.GetCurrentStackFrame().SetExpressionObjectClass(s),this._func.apply(i[n].GetSdkInstance(),t)}}class Yb extends Ub.ExpNode{constructor(e,t){super(e),this._objectClass=this._runtime.GetObjectClassByIndex(t[1]),this._varIndex=t[3],this._returnsString=!!t[2],this._owner._MaybeVaryFor(this._objectClass)}ExpInstVar(){const e=this._objectClass.GetCurrentSol().GetExpressionInstances(),t=e.length;return 0===t?this._returnsString?"":0:e[Vb(this._owner.GetSolIndex(),t)]._GetInstanceVariableValueUnchecked(this._varIndex)}ExpInstVar_Family(){const e=this._objectClass,t=e.GetCurrentSol().GetExpressionInstances(),s=t.length;if(0===s)return this._returnsString?"":0;const i=t[Vb(this._owner.GetSolIndex(),s)],r=i.GetObjectClass().GetFamilyInstanceVariableOffset(e.GetFamilyIndex());return i._GetInstanceVariableValueUnchecked(this._varIndex+r)}ExpInstVar_InstExpr(e){const t=this._objectClass,s=t.GetInstances(),i=s.length;if(0===i||"number"!=typeof e)return this._returnsString?"":0;const r=s[Vb(e,i)];let n=0;return t.IsFamily()&&(n=r.GetObjectClass().GetFamilyInstanceVariableOffset(t.GetFamilyIndex())),r._GetInstanceVariableValueUnchecked(this._varIndex+n)}}class qb extends Ub.ExpNode{constructor(e,t){super(e),this._objectClass=this._runtime.GetObjectClassByIndex(t[1]),this._behaviorType=this._objectClass.GetBehaviorTypeByName(t[2]),this._behaviorIndex=this._objectClass.GetBehaviorIndexByName(t[2]),this._func=this._runtime.GetObjectReference(t[3]),this._returnsString=!!t[4],this._eventStack=this._runtime.GetEventSheetManager().GetEventStack(),this._owner._MaybeVaryFor(this._objectClass)}ExpBehavior(...e){const t=this._objectClass,s=t.GetCurrentSol().GetExpressionInstances(),i=s.length;if(0===i)return this._returnsString?"":0;const r=Vb(this._owner.GetSolIndex(),i);this._eventStack.GetCurrentStackFrame().SetExpressionObjectClass(t);const n=s[r];let a=0;return t.IsFamily()&&(a=n.GetObjectClass().GetFamilyBehaviorOffset(t.GetFamilyIndex())),this._func.apply(n.GetBehaviorInstances()[this._behaviorIndex+a].GetSdkInstance(),e)}ExpBehavior_InstExpr(e,...t){const s=this._objectClass,i=s.GetInstances(),r=i.length;if(0===r||"number"!=typeof e)return this._returnsString?"":0;const n=Vb(e,r);this._eventStack.GetCurrentStackFrame().SetExpressionObjectClass(s);const a=i[n];let o=0;return s.IsFamily()&&(o=a.GetObjectClass().GetFamilyBehaviorOffset(s.GetFamilyIndex())),this._func.apply(a.GetBehaviorInstances()[this._behaviorIndex+o].GetSdkInstance(),t)}}class Xb extends Ub.ExpNode{constructor(e,t){super(e),this._eventVar=null,this._eventVarSid=t[1]}_PostInit(){this._eventVar=this._runtime.GetEventSheetManager().GetEventVariableBySID(this._eventVarSid)}GetVar(){return this._eventVar}}}{let $b=function(e){const t=self.C3_ExpressionFuncs[e];if(!t)throw new Error("invalid expression number");return t};GetExpressionFunc=$b;const Kb=self.C3,Jb=self.assert;Kb.Parameter=class extends Kb.DefendedBase{constructor(e,t,s){super(),this._owner=e,this._index=s,this._type=t,this.Get=null,this._variesPerInstance=!1,this._isConstant=!1}static Create(e,t,s){const i=t[0],r=[Qb,Zb,aG,tG,iG,eG,rG,Qb,tG,tG,oG,lG,aG,uG,Zb,nG,sG,hG,cG,dG,pG,_G];return Kb.New(r[i],e,i,s,t)}_PostInit(){}SetVariesPerInstance(){this._variesPerInstance=!0}_MaybeVaryFor(e){this._variesPerInstance||e&&(e.GetPlugin().IsSingleGlobal()||(this._variesPerInstance=!0))}VariesPerInstance(){return this._variesPerInstance}GetIndex(){return this._index}GetRuntime(){return this._owner.GetRuntime()}GetEventBlock(){return this._owner.GetEventBlock()}IsConstant(){return this._isConstant}IsObjectParameter(){return 4===this._type}};class Qb extends Kb.Parameter{constructor(e,t,s,i){super(e,t,s),this._solIndex=0;const r=i[1];this._expressionNumber=r[0],this._numberedNodes=[],this._expressionFunc=null;for(let e=1,t=r.length;e<t;++e)this._numberedNodes.push(Kb.ExpNode.CreateNode(this,r[e]));this._numberedNodes.length?this.Get=this.GetExpression:(this.Get=$b(this._expressionNumber),this._isConstant=!0)}_GetNode(e){if(e<0||e>=this._numberedNodes.length)throw new RangeError("invalid numbered node");return this._numberedNodes[e]}_PostInit(){for(const e of this._numberedNodes)e._PostInit();const e=$b(this._expressionNumber);this._numberedNodes.length?this._expressionFunc=e(this):this._expressionFunc=e}GetSolIndex(){return this._solIndex}GetExpression(e){return this._solIndex=e,this._expressionFunc()}}class Zb extends Qb{constructor(e,t,s,i){super(e,t,s,i),this.Get=this.GetStringExpression,14===t&&(this.GetEventBlock().SetAllSolModifiers(),this._owner instanceof Kb.Action&&this.GetEventBlock().SetSolWriterAfterCnds())}GetStringExpression(e){this._solIndex=e;const t=this._expressionFunc();return"string"==typeof t?t:""}_GetFastTriggerValue(){return $b(this._expressionNumber)()}}class eG extends Qb{constructor(e,t,s,i){super(e,t,s,i),e.GetImplementationSdkVersion()>=2?this.Get=this.GetILayer:this.Get=this.GetLayer,this._isConstant=!1}GetLayer(e){this._solIndex=e;const t=this._expressionFunc();return this.GetRuntime().GetCurrentLayout().GetLayer(t)}GetILayer(e){const t=this.GetLayer(e);return t?t.GetILayer():null}}class tG extends Kb.Parameter{constructor(e,t,s,i){super(e,t,s),this._combo=i[1],this.Get=this.GetCombo,this._isConstant=!0}GetCombo(){return this._combo}}class sG extends Kb.Parameter{constructor(e,t,s,i){super(e,t,s),this._bool=i[1],this.Get=this.GetBoolean,this._isConstant=!0}GetBoolean(){return this._bool}}class iG extends Kb.Parameter{constructor(e,t,s,i){super(e,t,s),this._objectClass=this.GetRuntime().GetObjectClassByIndex(i[1]),e.GetImplementationSdkVersion()>=2?this.Get=this.GetIObjectClass:this.Get=this.GetObjectClass;const r=this.GetEventBlock();r._AddSolModifier(this._objectClass),this._owner instanceof Kb.Action?r.SetSolWriterAfterCnds():r.GetParent()&&r.GetParent().SetSolWriterAfterCnds(),this._isConstant=!0}GetObjectClass(){return this._objectClass}GetIObjectClass(){return this._objectClass?this._objectClass.GetIObjectClass():null}}class rG extends Kb.Parameter{constructor(e,t,s,i){super(e,t,s),this._layout=this.GetRuntime().GetLayoutManager().GetLayoutByName(i[1]),e.GetImplementationSdkVersion()>=2?this.Get=this.GetILayout:this.Get=this.GetLayout,this._isConstant=!0}GetLayout(){return this._layout}GetILayout(){return this._layout?this._layout.GetILayout():null}}class nG extends Kb.Parameter{constructor(e,t,s,i){super(e,t,s),this._timeline=this.GetRuntime().GetTimelineManager().GetTimelineByName(i[1]),e.GetImplementationSdkVersion()>=2?this.Get=this.GetITimelineState:this.Get=this.GetTimeline,this._isConstant=!0}GetTimeline(){return this._timeline}GetITimelineState(){return this._timeline?this._timeline.GetITimelineState():null}}class aG extends Kb.Parameter{constructor(e,t,s,i){super(e,t,s),this._fileInfo=i[1],this.Get=this.GetFile,this._isConstant=!0}GetFile(){return this._fileInfo}}class oG extends Kb.Parameter{constructor(e,t,s,i){super(e,t,s),this._instVarIndex=i[1];const r=this._owner.GetObjectClass();this._owner instanceof Kb.Condition&&this._owner.IsStatic()?(this.Get=this.GetInstanceVariable,this._isConstant=!0):r&&r.IsFamily()?(this.Get=this.GetFamilyInstanceVariable,this.SetVariesPerInstance()):(this.Get=this.GetInstanceVariable,this._isConstant=!0)}GetInstanceVariable(){return this._instVarIndex}GetFamilyInstanceVariable(e){e=e||0;const t=this._owner.GetObjectClass(),s=t.GetCurrentSol(),i=s.GetInstances();let r=null;if(i.length)r=i[e%i.length].GetObjectClass();else if(s.HasAnyElseInstances()){const t=s.GetElseInstances();r=t[e%t.length].GetObjectClass()}else{if(!(t.GetInstanceCount()>0))return 0;{const s=t.GetInstances();r=s[e%s.length].GetObjectClass()}}return this._instVarIndex+r.GetFamilyInstanceVariableOffset(t.GetFamilyIndex())}}class lG extends Kb.Parameter{constructor(e,t,s,i){super(e,t,s),this._eventVarSid=i[1],this._eventVar=null,e.GetImplementationSdkVersion()>=2?this.Get=this.GetIEventVariable:this.Get=this.GetEventVariable,this._isConstant=!0}_PostInit(){this._eventVar=this.GetRuntime().GetEventSheetManager().GetEventVariableBySID(this._eventVarSid)}GetEventVariable(){return this._eventVar}GetIEventVariable(){return null}}class hG extends Kb.Parameter{constructor(e,t,s,i){super(e,t,s),this._functionBlockName=i[1],this._functionBlock=null,e.GetImplementationSdkVersion()>=2?this.Get=this.GetIFunction:this.Get=this.GetFunction,this._isConstant=!0}_PostInit(){this._functionBlock=this.GetRuntime().GetEventSheetManager().GetFunctionBlockByName(this._functionBlockName),this._functionBlockName=null}GetFunction(){return this._functionBlock}GetIFunction(){return null}}class uG extends Kb.Parameter{constructor(e,t,s,i){super(e,t,s),this._subParams=[],this._variadicRet=[],this._isConstant=!0;for(let e=1,t=i.length;e<t;++e){const t=Kb.Parameter.Create(this._owner,i[e],0);this._subParams.push(t),this._variadicRet.push(0),t.IsConstant()||(this._isConstant=!1)}this.Get=this.GetVariadic}_PostInit(){for(const e of this._subParams)e._PostInit()}GetVariadic(){const e=this._subParams,t=this._variadicRet;for(let s=0,i=e.length;s<i;++s)t[s]=e[s].Get(0);return t}}class cG extends Kb.Parameter{constructor(e,t,s,i){super(e,t,s),this._easeIndex=i[1],this.Get=this.GetEase,this._isConstant=!0}GetEase(){return this._easeIndex}}class dG extends Kb.Parameter{constructor(e,t,s,i){super(e,t,s),this._brushIndex=i[1],this.Get=this.GetTilemapBrush,this._isConstant=!0}GetTilemapBrush(){return this._brushIndex}}class pG extends Qb{constructor(e,t,s,i){super(e,t,s,i),this.Get=this.GetTemplateName,this._isConstant=!1}GetTemplateName(){return this._expressionFunc()}}class _G extends Kb.Parameter{constructor(e,t,s,i){super(e,t,s),this._flowchartDataItem=this.GetRuntime().GetFlowchartManager().GetFlowchartDataItemByName(i[1]),this.Get=this.GetFlowchartName,this._isConstant=!0}GetFlowchartName(){return this._flowchartDataItem.GetName()}}}{let mG=function(e,t){for(let s=0,i=e.length;s<i;++s)t[s]=e[s].Get(0)};EvalParams=mG;const fG=self.C3,gG=self.assert,yG=[],SG=function(){};fG.Condition=class extends fG.DefendedBase{constructor(e,t,s){if(super(),this._eventBlock=e,this._runtime=e.GetRuntime(),this._index=s,this._func=this._runtime.GetObjectReference(t[1]),this._isTrigger=t[3]>0,this._isFastTrigger=2===t[3],this._isLooping=!!t[4],this._isInverted=!!t[5],this._isStatic=!!t[6],this._sid=t[7],this._isInOrBlock=this._eventBlock.IsOrBlock(),this._objectClass=null,this._behaviorType=null,this._behaviorIndex=-1,this._systemPlugin=null,this.Run=SG,this.DebugRun=SG,this._parameters=[],this._results=[],this._anyParamVariesPerInstance=!1,this._savedData=null,this._unsavedData=null,this._debugData=this._runtime.IsDebug()?{isBreakpoint:t[8][0],canDebug:t[8][1]}:null,-1===t[0]?this._systemPlugin=this._runtime.GetSystemPlugin():(this._objectClass=this._runtime.GetObjectClassByIndex(t[0]),t[2]&&(this._behaviorType=this._objectClass.GetBehaviorTypeByName(t[2]),this._behaviorIndex=this._objectClass.GetBehaviorIndexByName(t[2])),this._eventBlock.GetParent()&&this._eventBlock.GetParent().SetSolWriterAfterCnds()),10===t.length){let e=t[9];for(let t of e)this._parameters.push(fG.Parameter.Create(this,t,this._parameters.length)),this._results.push(0)}0===this._parameters.length&&(this._parameters=yG,this._results=yG),this._eventBlock.GetEventSheetManager()._RegisterCondition(this)}static Create(e,t,s){return fG.New(fG.Condition,e,t,s)}_PostInit(){for(const e of this._parameters)e._PostInit(),e.VariesPerInstance()&&(this._anyParamVariesPerInstance=!0);this._isFastTrigger?(this.Run=this._RunFastTrigger,this.DebugRun=this._DebugRunFastTrigger):this._systemPlugin?(this._SetSystemRunMethod(),this.DebugRun=this._DebugRunSystem):this._objectClass.GetPlugin().IsSingleGlobal()?(this._SetSingleGlobalRunMethod(),this.DebugRun=this._DebugRunSingleGlobal):this._isStatic?(this.Run=this._RunStatic,this.DebugRun=this._DebugRunStatic):(this.Run=this._RunObject,this.DebugRun=this._DebugRunObject)}_SetSystemRunMethod(){const e=this._systemPlugin,t=this._systemPlugin;this._SetRunMethodForBoundFunc(e,t,this._RunSystem)}_SetSingleGlobalRunMethod(){const e=this._objectClass.GetPlugin(),t=this._objectClass.GetSingleGlobalInstance().GetSdkInstance();this._SetRunMethodForBoundFunc(e,t,this._RunSingleGlobal)}_SetRunMethodForBoundFunc(e,t,s){const i=this._func,r=this._isInverted,n=this._parameters;if(0===n.length){const s=e._GetBoundACEMethod(i,t);this.Run=r?function(){return fG.xor(s(),r)}:s}else if(1===n.length){const s=n[0];if(!r&&s.IsConstant())this.Run=e._GetBoundACEMethod_1param(i,t,s.Get(0));else{const n=e._GetBoundACEMethod(i,t);this.Run=function(){return fG.xor(n(s.Get(0)),r)}}}else if(2===n.length){const s=n[0],a=n[1];if(!r&&s.IsConstant()&&a.IsConstant())this.Run=e._GetBoundACEMethod_2params(i,t,s.Get(0),a.Get(0));else{const n=e._GetBoundACEMethod(i,t);this.Run=function(){return fG.xor(n(s.Get(0),a.Get(0)),r)}}}else if(3===n.length){const s=n[0],a=n[1],o=n[2];if(!r&&s.IsConstant()&&a.IsConstant()&&o.IsConstant())this.Run=e._GetBoundACEMethod_3params(i,t,s.Get(0),a.Get(0),o.Get(0));else{const n=e._GetBoundACEMethod(i,t);this.Run=function(){return fG.xor(n(s.Get(0),a.Get(0),o.Get(0)),r)}}}else this.Run=s}GetSID(){return this._sid}_GetFunc(){return this._func}GetObjectClass(){return this._objectClass}GetBehaviorType(){return this._behaviorType}GetImplementationAddon(){return this._behaviorType?this._behaviorType.GetBehavior():this._objectClass?this._objectClass.GetPlugin():null}GetImplementationSdkVersion(){const e=this.GetImplementationAddon();return e?e.GetSdkVersion():1}GetEventBlock(){return this._eventBlock}GetRuntime(){return this._runtime}GetIndex(){return this._index}GetDebugIndex(){return this.GetIndex()}IsTrigger(){return this._isTrigger}IsFastTrigger(){return this._isFastTrigger}IsInverted(){return this._isInverted}IsLooping(){return this._isLooping}IsStatic(){return this._isStatic}IsBreakpoint(){return this._debugData.isBreakpoint}IsSystemCondition(){return!!this._systemPlugin}IsSystemOrSingleGlobalCondition(){return this.IsSystemCondition()||this._objectClass.GetPlugin().IsSingleGlobal()}GetFirstObjectParameterObjectClass(){for(const e of this._parameters)if(e.IsObjectParameter())return e.GetObjectClass();return null}_SetBreakpoint(e){this._debugData.isBreakpoint=!!e,this._eventBlock._UpdateCanRunFastRecursive()}_DebugReturnsGenerator(){return this._debugData.canDebug}DebugCanRunFast(){return!this.IsBreakpoint()&&!this._runtime.DebugBreakNext()&&!this._DebugReturnsGenerator()}GetSavedDataMap(){return this._savedData||(this._savedData=new Map),this._savedData}GetUnsavedDataMap(){return this._unsavedData||(this._unsavedData=new Map),this._unsavedData}_RunSystem(){const e=this._results;return mG(this._parameters,e),fG.xor(this._func.apply(this._systemPlugin,e),this._isInverted)}*_DebugRunSystem(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._results;mG(this._parameters,e);let t=this._func.apply(this._systemPlugin,e);return fG.IsIterator(t)&&(t=yield*t),fG.xor(t,this._isInverted)}return this.Run()}_RunSingleGlobal(){const e=this._results;mG(this._parameters,e);const t=this._objectClass.GetSingleGlobalInstance().GetSdkInstance();return fG.xor(this._func.apply(t,e),this._isInverted)}*_DebugRunSingleGlobal(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._results;mG(this._parameters,e);const t=this._objectClass.GetSingleGlobalInstance().GetSdkInstance();let s=this._func.apply(t,e);return fG.IsIterator(s)&&(s=yield*s),fG.xor(s,this._isInverted)}return this.Run()}_RunFastTrigger(){return!0}*_DebugRunFastTrigger(){return(this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),!0}_GetStaticConditionThis(){return this._behaviorType?this._behaviorType.GetBehavior().GetSdkVersion()>=2?this._behaviorType.GetIBehaviorType():this._behaviorType:this._objectClass.GetPlugin().GetSdkVersion()>=2?this._objectClass.GetIObjectClass():this._objectClass}_RunStatic(){const e=this._results;mG(this._parameters,e);const t=this._func.apply(this._GetStaticConditionThis(),e);return this._objectClass.ApplySolToContainer(),t}*_DebugRunStatic(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._results;mG(this._parameters,e);let t=this._func.apply(this._GetStaticConditionThis(),e);return fG.IsIterator(t)&&(t=yield*t),this._objectClass.ApplySolToContainer(),t}return this.Run()}_RunObject(){const e=this._parameters,t=this._results,s=this._objectClass.GetCurrentSol();for(let s=0,i=e.length;s<i;++s){const i=e[s];i.VariesPerInstance()||(t[s]=i.Get(0))}return s.IsSelectAll()?this._RunObject_FirstFilter(s):this._RunObject_NextFilter(s)}*_DebugRunObject(){return(this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._RunObject()}_EvaluateVaryingParameters(e){const t=this._parameters,s=this._results;for(let i=0,r=t.length;i<r;++i){const r=t[i];r.VariesPerInstance()&&(s[i]=r.Get(e))}}_RunObject_FirstFilter(e){const t=this._objectClass,s=t.IsFamily(),i=t.GetFamilyIndex(),r=this._behaviorIndex,n=r>=0,a=t.GetInstances(),o=this._anyParamVariesPerInstance,l=this._results,h=this._func,u=this._isInverted,c=this._isInOrBlock&&!this._isTrigger;e.ClearArrays();for(let t=0,d=a.length;t<d;++t){const d=a[t];let p;if(o&&this._EvaluateVaryingParameters(t),n){const e=s?d.GetObjectClass().GetFamilyBehaviorOffset(i):0;p=h.apply(d.GetBehaviorInstances()[r+e].GetSdkInstance(),l)}else p=h.apply(d.GetSdkInstance(),l);fG.xor(p,u)?e._PushInstance(d):c&&e._PushElseInstance(d)}return t.FinishCondition(!0),e._SetSelectAll(!1),t.ApplySolToContainer(),e.HasAnyInstances()}_RunObject_NextFilter(e){const t=this._objectClass,s=t.IsFamily(),i=t.GetFamilyIndex(),r=t.IsInContainer(),n=this._behaviorIndex,a=n>=0,o=this._anyParamVariesPerInstance,l=this._results,h=this._func,u=this._isInverted,c=this._isInOrBlock&&!this._isTrigger,d=e._GetOwnInstances(),p=e._GetOwnElseInstances(),_=c&&!this._eventBlock.IsFirstConditionOfType(this),m=_?p:d;let f=0,g=!1;for(let e=0,t=m.length;e<t;++e){const t=m[e];let y;if(o&&this._EvaluateVaryingParameters(e),a){const e=s?t.GetObjectClass().GetFamilyBehaviorOffset(i):0;y=h.apply(t.GetBehaviorInstances()[n+e].GetSdkInstance(),l)}else y=h.apply(t.GetSdkInstance(),l);fG.xor(y,u)?(g=!0,_?(d.push(t),r&&t._PushSiblingsToSolInstances()):(m[f]=t,r&&t._SetSiblingsToSolInstancesIndex(f),++f)):_?(m[f]=t,r&&t._SetSiblingsToSolElseInstancesIndex(f),++f):c&&(p.push(t),r&&t._PushSiblingsToSolElseInstances())}fG.truncateArray(m,f),r&&t._TruncateContainerSols(_,f);const y=g;return _&&!g&&(g=this._OrBlockCheckInstances(d)),t.FinishCondition(y||c),c?g:e.HasAnyInstances()}_OrBlockCheckInstances(e){const t=this._objectClass,s=t.IsFamily(),i=t.GetFamilyIndex(),r=this._anyParamVariesPerInstance,n=this._behaviorIndex,a=n>=0,o=this._results,l=this._func,h=this._isInverted;for(let t=0,u=e.length;t<u;++t){const u=e[t];let c;if(r&&this._EvaluateVaryingParameters(t),a){const e=s?u.GetObjectClass().GetFamilyBehaviorOffset(i):0;c=l.apply(u.GetBehaviorInstances()[n+e].GetSdkInstance(),o)}else c=l.apply(u.GetSdkInstance(),o);if(fG.xor(c,h))return!0}return!1}ReevaluateParameter(e,t){return this._parameters[e].Get(t)}GetFastTriggerValue(){const e=this._parameters;if(!e.length)throw new Error("no parameters");return e[0]._GetFastTriggerValue()}_SaveToJson(){if(!this._savedData||!this._savedData.size)return null;const e={};for(const[t,s]of this._savedData.entries()){let i=s;"collmemory"===t&&(i=[...s.entries()].map(e=>[e[0].GetUID(),e[1].GetUID(),e[2]])),e[t]=i}return{ex:e}}_LoadFromJson(e){if(this._savedData&&(this._savedData.clear(),this._savedData=null),!e)return;const t=this._runtime,s=e.ex;if(s){const e=this.GetSavedDataMap();e.clear();for(const[i,r]of Object.entries(s)){let s=r;"collmemory"===i&&(s=fG.New(fG.PairMap,r.map(e=>[t.GetInstanceByUID(e[0]),t.GetInstanceByUID(e[1]),e[2]]).filter(e=>e[0]&&e[1]))),e.set(i,s)}}}}}{let TG=function(e,t){for(let s=0,i=e.length;s<i;++s)t[s]=e[s].Get(0)};EvalParams=TG;const xG=self.C3,bG=self.assert,GG=[],IG=function(){},vG=function*(){},CG=1,wG=2,AG=4,RG=8,PG=16;xG.Action=class extends xG.DefendedBase{constructor(e,t,s){super(),this._eventBlock=e;const i=e.GetRuntime();this._runtime=i,this._index=s,this._sid=t.length>=4?t[3]:-1,this._actionType=t.length>=5?255&t[4]:0,this._flags=t.length>=5?t[4]>>8:0,this._func=null,this._objectClass=null,this._behaviorType=null,this._behaviorIndex=-1,this._systemPlugin=null,this._callFunctionName="",this._callCustomAceObjectClass=null,this._callEventBlock=null,this.Run=IG,this.DebugRun=IG,this._parameters=[],this._results=[],this._anyParamVariesPerInstance=!1,this._savedData=null,this._unsavedData=null;const r=-3===t[0],n=r?t[2]:t[5];if(this._debugData=i.IsDebug()||r?{isBreakpoint:n[0],canDebug:n[1],index:n[2]}:null,-1===t[0])this._systemPlugin=i.GetSystemPlugin(),this._func=i.GetObjectReference(t[1]);else if(-2===t[0])this._callFunctionName=t[1];else if(r){const e=i.GetObjectReference(t[1]);this._func=e,this.Run=this.RunUserScript,this.DebugRun=this.DebugRunUserScript,this._flags|=8}else this._objectClass=i.GetObjectClassByIndex(t[0]),4&this._flags?(this._callFunctionName=t[1],this._callCustomAceObjectClass=i.GetObjectClassByIndex(t[2])):(t[2]&&(this._behaviorType=this._objectClass.GetBehaviorTypeByName(t[2]),this._behaviorIndex=this._objectClass.GetBehaviorIndexByName(t[2])),this._func=i.GetObjectReference(t[1]));if(7===t.length){const e=t[6];for(const t of e)this._parameters.push(xG.Parameter.Create(this,t,this._parameters.length)),this._results.push(0)}0===this._parameters.length&&(this._parameters=GG,this._results=GG),this.CanPickAnyObjectClass()&&(this._eventBlock.SetAllSolModifiers(),this._eventBlock.SetSolWriterAfterCnds()),this._eventBlock.GetEventSheetManager()._RegisterAction(this)}static Create(e,t,s){return xG.New(xG.Action,e,t,s)}_PostInit(){for(const e of this._parameters)e._PostInit(),e.VariesPerInstance()&&(this._anyParamVariesPerInstance=!0);if(this._systemPlugin)this._SetSystemRunMethod(),this.DebugRun=this._DebugRunSystem;else if(this._callFunctionName)4&this._flags?this._SetCallCustomActionRunMethod():this._SetCallFunctionRunMethod(),this._callFunctionName="",this._callCustomAceObjectClass=null;else if(this.Run===this.RunUserScript){const e=this._func,t=this._runtime.GetEventSheetManager()._GetLocalVariablesScriptInterface(this._eventBlock);this._func=e.bind(null,this._runtime.GetIRuntime(),t)}else this._behaviorType?this.IsAsync()?(this.Run=this._RunBehavior_Async,this.DebugRun=this._DebugRunBehavior_Async):(this.Run=this._RunBehavior,this.DebugRun=this._DebugRunBehavior):this._objectClass.GetPlugin().IsSingleGlobal()?(this._SetSingleGlobalRunMethod(),this.DebugRun=this._DebugRunSingleGlobal):this.IsStatic()?(this.Run=this._RunObject_Static,this.DebugRun=this._DebugRunObject_Static):this.IsAsync()?(this.Run=this._RunObject_Async,this.DebugRun=this._DebugRunObject_Async):this.CallBeforeAfterHooks()?(this.Run=this._RunObject_BeforeAfterHooks,this.DebugRun=this._DebugRunObject_BeforeAfterHooks):this._parameters.length?this._parameters.every(e=>e.VariesPerInstance())?(this.Run=this._RunObject_AllParamsVary,this.DebugRun=this._DebugRunObject_AllParamsVary):this._anyParamVariesPerInstance?(this.Run=this._RunObject_SomeParamsVary,this.DebugRun=this._DebugRunObject_SomeParamsVary):this._parameters.every(e=>e.IsConstant())?(TG(this._parameters,this._results),this.Run=this._RunObject_ParamsConst,this.DebugRun=this._DebugRunObject_ParamsConst):(this.Run=this._RunObject_ParamsDontVary,this.DebugRun=this._DebugRunObject_ParamsDontVary):(this.Run=this._RunObject_ParamsConst,this.DebugRun=this._DebugRunObject_ParamsConst)}_SetSystemRunMethod(){const e=this._systemPlugin,t=this._systemPlugin;this._SetRunMethodForBoundFunc(e,t,this._RunSystem)}_SetSingleGlobalRunMethod(){const e=this._objectClass.GetPlugin(),t=this._objectClass.GetSingleGlobalInstance().GetSdkInstance();this._SetRunMethodForBoundFunc(e,t,this._RunSingleGlobal)}_SetCallFunctionRunMethod(){const e=this._eventBlock.GetEventSheetManager(),t=e.GetFunctionBlockByName(this._callFunctionName);if(t.IsEnabled()){const s=!!(2&this._flags);this._callEventBlock=t.GetEventBlock();let i=[...new Set([...this._eventBlock.GetSolModifiersIncludingParents(),...this._callEventBlock.GetSolModifiersIncludingParents()])];i=e._DeduplicateSolModifierList(i);const r=!t.IsCopyPicked()&&this._HasCopyPickedParent()?{pushCleanSolDynamic:!0}:null;if(this.Run=xG.EventBlock.prototype.RunAsFunctionCall.bind(this._callEventBlock,i,this._parameters,s,r),this._runtime.IsDebug()){const e=this;this.DebugRun=function*(){return(e.IsBreakpoint()||e._runtime.DebugBreakNext())&&(yield e),yield*e._callEventBlock.DebugRunAsFunctionCall(i,e._parameters,s,r)}}else this.DebugRun=vG}else this.Run=IG,this.DebugRun=vG}_SetCallCustomActionRunMethod(){const e=this._eventBlock.GetEventSheetManager(),t=e.GetCustomActionBlockByName(this._callCustomAceObjectClass,this._callFunctionName);if(t.IsEnabled()){const s=!!(2&this._flags);this._callEventBlock=t.GetEventBlock();let i=[...new Set([...this._eventBlock.GetSolModifiersIncludingParents(),...this._callEventBlock.GetSolModifiersIncludingParents(),this._objectClass,t.GetObjectClass()])];i=e._DeduplicateSolModifierList(i);const r=!this._objectClass.IsFamily()&&!t.GetObjectClass().IsFamily(),n=!this._objectClass.IsFamily()&&t.GetObjectClass().IsFamily(),a=this._objectClass.IsFamily();let o=null;if(!t.IsCopyPicked()&&this._HasCopyPickedParent()&&(o=o||{},o.pushCleanSolDynamic=!0),!n&&s||(o=o||{},o.copyFromObjectClass=this._objectClass,o.copyToObjectClass=t.GetObjectClass()),r||n||a&&!t.HasCustomACEOverrides()?this.Run=xG.EventBlock.prototype.RunAsFunctionCall.bind(this._callEventBlock,i,this._parameters,s,o):a&&(this.Run=xG.FunctionBlock.prototype.RunAsFamilyCustomActionWithOverrides.bind(t,i,this._parameters)),this._runtime.IsDebug()){const e=this;r||n||a&&!t.HasCustomACEOverrides()?this.DebugRun=function*(){return(e.IsBreakpoint()||e._runtime.DebugBreakNext())&&(yield e),yield*e._callEventBlock.DebugRunAsFunctionCall(i,e._parameters,s,o)}:a&&(this.DebugRun=function*(){return(e.IsBreakpoint()||e._runtime.DebugBreakNext())&&(yield e),yield*t.DebugRunAsFamilyCustomActionWithOverrides(i,e._parameters)})}else this.DebugRun=vG}else this.Run=IG,this.DebugRun=vG}_SetRunMethodForBoundFunc(e,t,s){const i=this._func,r=this._parameters;if(0===r.length)this.Run=e._GetBoundACEMethod(i,t);else if(1===r.length){const s=r[0];if(s.IsConstant())this.Run=e._GetBoundACEMethod_1param(i,t,s.Get(0));else{const r=e._GetBoundACEMethod(i,t);this.Run=function(){return r(s.Get(0))}}}else if(2===r.length){const s=r[0],n=r[1];if(s.IsConstant()&&n.IsConstant())this.Run=e._GetBoundACEMethod_2params(i,t,s.Get(0),n.Get(0));else{const r=e._GetBoundACEMethod(i,t);this.Run=function(){return r(s.Get(0),n.Get(0))}}}else if(3===r.length){const s=r[0],n=r[1],a=r[2];if(s.IsConstant()&&n.IsConstant()&&a.IsConstant())this.Run=e._GetBoundACEMethod_3params(i,t,s.Get(0),n.Get(0),a.Get(0));else{const r=e._GetBoundACEMethod(i,t);this.Run=function(){return r(s.Get(0),n.Get(0),a.Get(0))}}}else this.Run=s}GetSID(){return this._sid}IsAsync(){return!!(8&this._flags)}CanBailOut(){return!!(16&this._flags)}CallBeforeAfterHooks(){return 1===this._actionType}IsStatic(){return 2===this._actionType}CanPickAnyObjectClass(){return!!(1&this._flags)}HasReturnType(){return this.IsAsync()||this.CanBailOut()}GetObjectClass(){return this._objectClass}GetImplementationAddon(){return this._behaviorType?this._behaviorType.GetBehavior():this._objectClass?this._objectClass.GetPlugin():null}GetImplementationSdkVersion(){const e=this.GetImplementationAddon();return e?e.GetSdkVersion():1}GetEventBlock(){return this._eventBlock}_HasCopyPickedParent(){let e=this._eventBlock;do{if(e instanceof xG.FunctionBlock&&e.IsCopyPicked())return!0;e=e.GetScopeParent()}while(e);return!1}GetRuntime(){return this._runtime}GetIndex(){return this._index}GetDebugIndex(){return this._debugData.index}IsBreakpoint(){return this._debugData.isBreakpoint}_SetBreakpoint(e){this._debugData.isBreakpoint=!!e,this._eventBlock._UpdateCanRunFastRecursive()}_DebugReturnsGenerator(){return this._debugData.canDebug}DebugCanRunFast(){return!this.IsBreakpoint()&&!this._runtime.DebugBreakNext()&&!this._DebugReturnsGenerator()}GetSavedDataMap(){return this._savedData||(this._savedData=new Map),this._savedData}GetUnsavedDataMap(){return this._unsavedData||(this._unsavedData=new Map),this._unsavedData}_RunSystem(){const e=this._results;return TG(this._parameters,e),this._func.apply(this._systemPlugin,e)}*_DebugRunSystem(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._results;return TG(this._parameters,e),yield*this._func.apply(this._systemPlugin,e)}return this.Run()}_RunSingleGlobal(){const e=this._results;return TG(this._parameters,e),this._func.apply(this._objectClass.GetSingleGlobalInstance().GetSdkInstance(),e)}*_DebugRunSingleGlobal(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._results;return TG(this._parameters,e),yield*this._func.apply(this._objectClass.GetSingleGlobalInstance().GetSdkInstance(),e)}return this.Run()}_RunObject_ParamsConst(){const e=this._results,t=this._objectClass.GetCurrentSol().GetInstances();for(let s=0,i=t.length;s<i;++s)this._func.apply(t[s].GetSdkInstance(),e)}*_DebugRunObject_ParamsConst(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._results,t=this._objectClass.GetCurrentSol().GetInstances();for(let s=0,i=t.length;s<i;++s)yield*this._func.apply(t[s].GetSdkInstance(),e)}else this._RunObject_ParamsConst()}_RunObject_ParamsDontVary(){const e=this._results;TG(this._parameters,e);const t=this._objectClass.GetCurrentSol().GetInstances();for(let s=0,i=t.length;s<i;++s)this._func.apply(t[s].GetSdkInstance(),e)}*_DebugRunObject_ParamsDontVary(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._results;TG(this._parameters,e);const t=this._objectClass.GetCurrentSol().GetInstances();for(let s=0,i=t.length;s<i;++s)yield*this._func.apply(t[s].GetSdkInstance(),e)}else this._RunObject_ParamsDontVary()}_RunObject_AllParamsVary(){const e=this._parameters,t=this._results,s=this._func,i=this._objectClass.GetCurrentSol().GetInstances();for(let r=0,n=i.length;r<n;++r){const n=i[r];for(let s=0,i=e.length;s<i;++s)t[s]=e[s].Get(r);s.apply(n.GetSdkInstance(),t)}}*_DebugRunObject_AllParamsVary(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._parameters,t=this._results,s=this._func,i=this._objectClass.GetCurrentSol().GetInstances();for(let r=0,n=i.length;r<n;++r){const n=i[r];for(let s=0,i=e.length;s<i;++s)t[s]=e[s].Get(r);yield*s.apply(n.GetSdkInstance(),t)}}else this._RunObject_AllParamsVary()}_RunObject_SomeParamsVary(){const e=this._parameters,t=this._results,s=this._func,i=this._objectClass.GetCurrentSol().GetInstances();for(let s=0,i=e.length;s<i;++s){const i=e[s];i.VariesPerInstance()||(t[s]=i.Get(0))}for(let r=0,n=i.length;r<n;++r){const n=i[r];for(let s=0,i=e.length;s<i;++s){const i=e[s];i.VariesPerInstance()&&(t[s]=i.Get(r))}s.apply(n.GetSdkInstance(),t)}}*_DebugRunObject_SomeParamsVary(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._parameters,t=this._results,s=this._func,i=this._objectClass.GetCurrentSol().GetInstances();for(let s=0,i=e.length;s<i;++s){const i=e[s];i.VariesPerInstance()||(t[s]=i.Get(0))}for(let r=0,n=i.length;r<n;++r){const n=i[r];for(let s=0,i=e.length;s<i;++s){const i=e[s];i.VariesPerInstance()&&(t[s]=i.Get(r))}yield*s.apply(n.GetSdkInstance(),t)}}else this._RunObject_SomeParamsVary()}_RunObject_BeforeAfterHooks(){const e=this._parameters,t=this._results,s=this._func,i=this._objectClass,r=i.GetSdkType(),n=i.GetCurrentSol().GetInstances();r.BeforeRunAction(s);for(let i=0,r=n.length;i<r;++i){const r=n[i];for(let s=0,r=e.length;s<r;++s)t[s]=e[s].Get(i);s.apply(r.GetSdkInstance(),t)}r.AfterRunAction(s)}*_DebugRunObject_BeforeAfterHooks(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._parameters,t=this._results,s=this._func,i=this._objectClass,r=i.GetSdkType(),n=i.GetCurrentSol().GetInstances();r.BeforeRunAction(s);for(let i=0,r=n.length;i<r;++i){const r=n[i];for(let s=0,r=e.length;s<r;++s)t[s]=e[s].Get(i);yield*s.apply(r.GetSdkInstance(),t)}r.AfterRunAction(s)}else this._RunObject_BeforeAfterHooks()}_GetStaticActionThis(){return this._behaviorType?this._behaviorType.GetBehavior().GetSdkVersion()>=2?this._behaviorType.GetIBehaviorType():this._behaviorType:this._objectClass.GetPlugin().GetSdkVersion()>=2?this._objectClass.GetIObjectClass():this._objectClass}_RunObject_Static(){const e=this._results;return TG(this._parameters,e),this._func.apply(this._GetStaticActionThis(),e)}*_DebugRunObject_Static(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._results;TG(this._parameters,e);let t=this._func.apply(this._GetStaticActionThis(),e);return xG.IsIterator(t)&&(t=yield*t),t}return this._RunObject_Static()}_RunBehavior(){const e=this._objectClass,t=e.IsFamily(),s=e.GetFamilyIndex(),i=this._parameters,r=this._anyParamVariesPerInstance,n=this._results,a=this._func,o=this._behaviorIndex,l=e.GetCurrentSol().GetInstances();for(let e=0,t=i.length;e<t;++e){const t=i[e];t.VariesPerInstance()||(n[e]=t.Get(0))}for(let e=0,h=l.length;e<h;++e){const h=l[e];if(r)for(let t=0,s=i.length;t<s;++t){const s=i[t];s.VariesPerInstance()&&(n[t]=s.Get(e))}const u=t?h.GetObjectClass().GetFamilyBehaviorOffset(s):0;a.apply(h.GetBehaviorInstances()[o+u].GetSdkInstance(),n)}}*_DebugRunBehavior(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._objectClass,t=e.IsFamily(),s=e.GetFamilyIndex(),i=this._parameters,r=this._anyParamVariesPerInstance,n=this._results,a=this._func,o=this._behaviorIndex,l=e.GetCurrentSol().GetInstances();for(let e=0,t=i.length;e<t;++e){const t=i[e];t.VariesPerInstance()||(n[e]=t.Get(0))}for(let e=0,h=l.length;e<h;++e){const h=l[e];if(r)for(let t=0,s=i.length;t<s;++t){const s=i[t];s.VariesPerInstance()&&(n[t]=s.Get(e))}const u=t?h.GetObjectClass().GetFamilyBehaviorOffset(s):0;yield*a.apply(h.GetBehaviorInstances()[o+u].GetSdkInstance(),n)}}else this._RunBehavior()}_RunObject_Async(){const e=this._parameters,t=this._results,s=this._func,i=this._objectClass.GetCurrentSol().GetInstances(),r=[];for(let n=0,a=i.length;n<a;++n){const a=i[n];for(let s=0,i=e.length;s<i;++s)t[s]=e[s].Get(n);r.push(s.apply(a.GetSdkInstance(),t))}return Promise.all(r)}*_DebugRunObject_Async(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._parameters,t=this._results,s=this._func,i=this._objectClass.GetCurrentSol().GetInstances(),r=[];for(let n=0,a=i.length;n<a;++n){const a=i[n];for(let s=0,i=e.length;s<i;++s)t[s]=e[s].Get(n);r.push(yield*s.apply(a.GetSdkInstance(),t))}return Promise.all(r)}return this._RunObject_Async()}_RunBehavior_Async(){const e=this._objectClass,t=e.IsFamily(),s=e.GetFamilyIndex(),i=this._parameters,r=this._results,n=this._func,a=this._behaviorIndex,o=e.GetCurrentSol().GetInstances(),l=[];for(let e=0,h=o.length;e<h;++e){const h=o[e];for(let t=0,s=i.length;t<s;++t)r[t]=i[t].Get(e);const u=t?h.GetObjectClass().GetFamilyBehaviorOffset(s):0;l.push(n.apply(h.GetBehaviorInstances()[a+u].GetSdkInstance(),r))}return Promise.all(l)}*_DebugRunBehavior_Async(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._objectClass,t=e.IsFamily(),s=e.GetFamilyIndex(),i=this._parameters,r=this._results,n=this._func,a=this._behaviorIndex,o=e.GetCurrentSol().GetInstances(),l=[];for(let e=0,h=o.length;e<h;++e){const h=o[e];for(let t=0,s=i.length;t<s;++t)r[t]=i[t].Get(e);const u=t?h.GetObjectClass().GetFamilyBehaviorOffset(s):0;l.push(yield*n.apply(h.GetBehaviorInstances()[a+u].GetSdkInstance(),r))}return Promise.all(l)}return this._RunBehavior_Async()}async RunUserScript(){try{await this._func()}catch(e){console.error(`Unhandled exception running script %c${this._eventBlock.GetEventSheet().GetName()}, event ${this._eventBlock.GetDisplayNumber()}, action ${this.GetDebugIndex()+1}:`,"font-size: 1.2em; font-weight: bold;",e),self.C3Debugger&&self.C3Debugger._SetLastErrorScript(this),xG.EventScript.HadUserScriptException()||(console.info("%cTip:%c run this to highlight in Construct the last script that had an error: %cgoToLastErrorScript()","font-weight: bold; text-decoration: underline","","font-weight: bold"),xG.EventScript.SetHadUserScriptException())}}*DebugRunUserScript(){return(this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this.RunUserScript()}_SaveToJson(){return this._savedData&&this._savedData.size?{ex:xG.ToSuperJSON(this._savedData)}:null}_LoadFromJson(e){if(this._savedData&&(this._savedData.clear(),this._savedData=null),!e)return;const t=e.ex;t&&(this._savedData=xG.FromSuperJSON(t))}}}{let MG=function(e){return e instanceof QG?JG._UnwrapScriptInterface(e):e.GetInstance()},EG=function(e){return MG(e).GetWorldInfo()},DG=function(e){return JG._UnwrapScriptInterface(e)},NG=function(e){return DG(e).GetWorldInfo()},FG=function(e){return e instanceof ZG?JG._UnwrapScriptInterface(e):e},OG=function(e){return e instanceof eI?JG._UnwrapScriptInterface(e):e},BG=function(e,t,s,i){t.GetUID()<s.GetUID()?e.Set(t,s,i):e.Set(s,t,i)},LG=function(e,t,s){t.GetUID()<s.GetUID()?e.Delete(t,s):e.Delete(s,t)},kG=function(e,t){e.DeleteEither(t)},VG=function(e,t,s){return t.GetUID()<s.GetUID()?e.Get(t,s):e.Get(s,t)},UG=function(e,t,s,i){if(!t)return!1;const r=0!==s||0!==i,n=e.GetWorldInfo(),a=JG.GetCollisionEngine(),o=JG.GetCurrentCondition(),l=o.GetEventBlock().IsOrBlock(),h=o.GetObjectClass(),u=o.IsInverted(),c=t.GetCurrentSol(),d=h!==t;let p;nI=t,rI=d&&!u,aI=!1;let _=0,m=0,f=!1;c.IsSelectAll()?(tI.copy(n.GetBoundingBox()),tI.offset(s,i),a.GetCollisionCandidates(n.GetLayer(),t,tI,iI),p=iI):l?JG.IsCurrentConditionFirst()&&!c._GetOwnElseInstances().length&&c._GetOwnInstances().length?p=c._GetOwnInstances():(p=c._GetOwnElseInstances(),aI=!0):p=c._GetOwnInstances(),r&&(_=n.GetX(),m=n.GetY(),n.OffsetXY(s,i),n.SetBboxChanged());for(const t of p)if(a.TestOverlap(e,t)){if(f=!0,u)break;d&&oI.add(t)}return r&&(n.SetXY(_,m),n.SetBboxChanged()),YG.clearArray(iI),f},WG=function(e){const t=JG.GetCurrentEvent().IsOrBlock(),s=nI.GetCurrentSol(),i=s._GetOwnInstances(),r=s._GetOwnElseInstances();s.IsSelectAll()?(s.SetSetPicked(oI),t&&(YG.clearArray(r),s.AddElseInstances(oI,nI.GetInstances()))):t?aI?s.TransferElseInstancesToOwn(oI):(s.AddElseInstances(oI,i),s.SetSetPicked(oI)):s.SetSetPicked(oI),nI.ApplySolToContainer()},HG=function(e,t){rI&&(t&&WG(e),oI.clear(),nI=null,rI=!1)},zG=function(e,t){const s=JG.GetInstanceByUID(t);if(!s)return!1;const i=e.GetCurrentSol();if(!i.IsSelectAll()&&!i._GetOwnInstances().includes(s))return!1;if(e.IsFamily()){if(s.GetObjectClass().BelongsToFamily(e))return i.PickOne(s),e.ApplySolToContainer(),!0}else if(s.GetObjectClass()===e)return i.PickOne(s),e.ApplySolToContainer(),!0;return!1},jG=function(e,t){const s=e.GetCurrentSol();if(s.IsSelectAll()){s._SetSelectAll(!1),s.ClearArrays();const i=e.GetInstances();for(let e=0,r=i.length;e<r;++e){const r=i[e];r.GetUID()===t?s._PushElseInstance(r):s._PushInstance(r)}return e.ApplySolToContainer(),!!s._GetOwnInstances().length}{const i=s._GetOwnInstances();let r=0;for(let e=0,n=i.length;e<n;++e){const n=i[e];i[r]=n,n.GetUID()===t?s._PushElseInstance(n):++r}return YG.truncateArray(i,r),e.ApplySolToContainer(),!!i.length}};GetInst=MG,GetWorldInfo=EG,GetInst_SDKv2=DG,GetWorldInfo_SDKv2=NG,GetObjectClass=FG,GetLayer=OG,CollMemory_Add=BG,CollMemory_Remove=LG,CollMemory_RemoveInstance=kG,CollMemory_Get=VG,DoOverlapCondition=UG,FinishCollisionConditionPicking=WG,FinishCollisionCondition=HG,PickByUID_Normal=zG,PickByUID_Inverted=jG;const YG=self.C3,qG=new YG.Color,XG={},$G={},KG={};let JG=null;YG.CommonACES_SetRuntime=function(e){JG=e};const QG=self.IInstance,ZG=self.IObjectClass,eI=self.ILayer;$G.CompareX=function(e,t){return YG.compare(this.GetWorldInfo().GetX(),e,t)},KG.CompareX=function(e,t){return YG.compare(this.x,e,t)},$G.CompareY=function(e,t){return YG.compare(this.GetWorldInfo().GetY(),e,t)},KG.CompareY=function(e,t){return YG.compare(this.y,e,t)},$G.IsOnScreen=function(){return this.GetWorldInfo().IsInViewport2()},KG.IsOnScreen=function(){return this.isOnScreen()},XG.IsOutsideLayout=function(){const e=EG(this),t=e.GetLayout(),s=e.GetBoundingBox();return s.getRight()<0||s.getBottom()<0||s.getLeft()>t.GetWidth()||s.getTop()>t.GetHeight()},XG.PickDistance=function(e,t,s){const i=FG(this).GetCurrentSol(),r=i.GetInstances();if(!r.length)return!1;let n=r[0],a=n.GetWorldInfo(),o=n,l=YG.distanceSquared(a.GetX(),a.GetY(),t,s);for(let i=1,h=r.length;i<h;++i){n=r[i],a=n.GetWorldInfo();const h=YG.distanceSquared(a.GetX(),a.GetY(),t,s);(0===e&&h<l||1===e&&h>l)&&(l=h,o=n)}return i.PickOne(o),!0},$G.SetX=function(e){const t=this.GetWorldInfo();t.GetX()!==e&&(t.SetX(e),t.SetBboxChanged())},KG.SetX=function(e){this.x=+e},$G.SetY=function(e){const t=this.GetWorldInfo();t.GetY()!==e&&(t.SetY(e),t.SetBboxChanged())},KG.SetY=function(e){this.y=+e},$G.SetPos=function(e,t){const s=this.GetWorldInfo();s.EqualsXY(e,t)||(s.SetXY(e,t),s.SetBboxChanged())},KG.SetPos=function(e,t){this.setPosition(e,t)},XG.SetPosToObject=function(e,t){if(!(e=FG(e)))return;const s=MG(this),i=e.GetPairedInstance(s);if(!i)return;const[r,n]=i.GetImagePoint(t),a=s.GetWorldInfo();a.GetX()===r&&a.GetY()===n||(a.SetXY(r,n),a.SetBboxChanged())},XG.MoveForward=function(e){if(0===e)return;const t=EG(this);t.OffsetXY(t.GetCosAngle()*e,t.GetSinAngle()*e),t.SetBboxChanged()},$G.MoveAtAngle=function(e,t){if(0===t)return;const s=this.GetWorldInfo();e=YG.toRadians(e),s.OffsetXY(Math.cos(e)*t,Math.sin(e)*t),s.SetBboxChanged()},KG.MoveAtAngle=function(e,t){0!==t&&(e=YG.toRadians(e),this.offsetPosition(Math.cos(e)*t,Math.sin(e)*t))},$G.GetX=function(){return this.GetWorldInfo().GetX()},KG.GetX=function(){return this.x},$G.GetY=function(){return this.GetWorldInfo().GetY()},KG.GetY=function(){return this.y},XG.GetDt=function(){return JG.GetDt(MG(this))},$G.CompareWidth=function(e,t){return YG.compare(this.GetWorldInfo().GetWidth(),e,t)},KG.CompareWidth=function(e,t){return YG.compare(this.width,e,t)},$G.CompareHeight=function(e,t){return YG.compare(this.GetWorldInfo().GetHeight(),e,t)},KG.CompareHeight=function(e,t){return YG.compare(this.height,e,t)},$G.SetWidth=function(e){const t=this.GetWorldInfo();t.GetWidth()!==e&&(t.SetWidth(e),t.SetBboxChanged())},KG.SetWidth=function(e){this.width=e},$G.SetHeight=function(e){const t=this.GetWorldInfo();t.GetHeight()!==e&&(t.SetHeight(e),t.SetBboxChanged())},KG.SetHeight=function(e){this.height=e},$G.SetSize=function(e,t){const s=EG(this);s.GetWidth()===e&&s.GetHeight()===t||(s.SetSize(e,t),s.SetBboxChanged())},KG.SetSize=function(e,t){this.setSize(e,t)},$G.GetWidth=function(){return this.GetWorldInfo().GetWidth()},KG.GetWidth=function(){return this.width},$G.GetHeight=function(){return this.GetWorldInfo().GetHeight()},KG.GetHeight=function(){return this.height},XG.GetBboxLeft=function(){return EG(this).GetBoundingBox().getLeft()},XG.GetBboxTop=function(){return EG(this).GetBoundingBox().getTop()},XG.GetBboxRight=function(){return EG(this).GetBoundingBox().getRight()},XG.GetBboxBottom=function(){return EG(this).GetBoundingBox().getBottom()},XG.GetBboxMidX=function(){const e=EG(this).GetBoundingBox();return(e.getLeft()+e.getRight())/2},XG.GetBboxMidY=function(){const e=EG(this).GetBoundingBox();return(e.getTop()+e.getBottom())/2},XG.IsAngleWithin=function(e,t){return YG.angleDiff(EG(this).GetAngle(),YG.toRadians(t))<=YG.toRadians(e)},XG.IsAngleClockwiseFrom=function(e){return YG.angleClockwise(EG(this).GetAngle(),YG.toRadians(e))},XG.IsBetweenAngles=function(e,t){const s=YG.toRadians(e),i=YG.toRadians(t),r=EG(this).GetAngle();return YG.angleClockwise(i,s)?YG.angleClockwise(r,s)&&!YG.angleClockwise(r,i):!(!YG.angleClockwise(r,s)&&YG.angleClockwise(r,i))},$G.SetAngle=function(e){const t=this.GetWorldInfo(),s=YG.clampAngle(YG.toRadians(e));isNaN(s)||t.GetAngle()===s||(t.SetAngle(s),t.SetBboxChanged())},KG.SetAngle=function(e){this.angleDegrees=e},XG.RotateClockwise=function(e){if(isNaN(e)||0===e)return;const t=EG(this);t.SetAngle(t.GetAngle()+YG.toRadians(e)),t.SetBboxChanged()},XG.RotateCounterclockwise=function(e){if(isNaN(e)||0===e)return;const t=EG(this);t.SetAngle(t.GetAngle()-YG.toRadians(e)),t.SetBboxChanged()},XG.RotateTowardAngle=function(e,t){const s=EG(this),i=s.GetAngle(),r=YG.angleRotate(i,YG.toRadians(t),YG.toRadians(e));isNaN(r)||i===r||(s.SetAngle(r),s.SetBboxChanged())},XG.RotateTowardPosition=function(e,t,s){const i=EG(this),r=i.GetAngle(),n=t-i.GetX(),a=s-i.GetY(),o=Math.atan2(a,n),l=YG.angleRotate(r,o,YG.toRadians(e));isNaN(l)||r===l||(i.SetAngle(l),i.SetBboxChanged())},XG.SetTowardPosition=function(e,t){const s=EG(this),i=s.GetAngle(),r=e-s.GetX(),n=t-s.GetY(),a=Math.atan2(n,r);isNaN(a)||i===a||(s.SetAngle(a),s.SetBboxChanged())},$G.GetAngle=function(){return YG.toDegrees(this.GetWorldInfo().GetAngle())},KG.GetAngle=function(){return this.angleDegrees},XG.CompareOpacity=function(e,t){return YG.compare(YG.roundToDp(100*EG(this).GetOpacity(),6),e,t)},$G.IsVisible=function(){return this.GetWorldInfo().IsVisible()},KG.IsVisible=function(){return this.isVisible},XG.SetVisible=function(e){const t=EG(this);e=2===e?!t.IsVisible():0!==e,t.IsVisible()!==e&&(t.SetVisible(e),JG.UpdateRender())},XG.SetOpacity=function(e){const t=YG.clamp(e/100,0,1),s=EG(this);if(s.GetTransformWithParentOpacity()){if(s._GetSceneGraphInfo().GetOwnOpacity()===t)return}else if(s.GetOpacity()===t)return;s.SetOpacity(t),JG.UpdateRender()},XG.SetDefaultColor=function(e){qG.setFromRgbValue(e);const t=EG(this);t.GetUnpremultipliedColor().equalsIgnoringAlpha(qG)||(t.SetUnpremultipliedColor(qG),JG.UpdateRender())},XG.GetColor=function(){const e=EG(this).GetUnpremultipliedColor();return YG.PackRGBAEx(e.getR(),e.getG(),e.getB(),e.getA())},XG.GetOpacity=function(){return YG.roundToDp(100*EG(this).GetOpacity(),6)},XG.IsOnLayer=function(e){return!!(e=OG(e))&&EG(this).GetLayer()===e},XG.PickTopBottom=function(e){const t=FG(this).GetCurrentSol(),s=t.GetInstances();if(!s.length)return!1;let i=s[0];for(let t=1,r=s.length;t<r;++t){const r=s[t],n=r.GetWorldInfo(),a=i.GetWorldInfo(),o=n.GetLayer().GetIndex(),l=a.GetLayer().GetIndex();0===e?(o>l||o===l&&n.GetZIndex()>a.GetZIndex())&&(i=r):(o<l||o===l&&n.GetZIndex()<a.GetZIndex())&&(i=r)}return t.PickOne(i),!0},$G.CompareZElevation=function(e,t,s){const i=this.GetWorldInfo(),r=0===e?i.GetZElevation():i.GetTotalZElevation();return YG.compare(r,t,s)},KG.CompareZElevation=function(e,t,s){const i=0===e?this.zElevation:this.totalZElevation;return YG.compare(i,t,s)},$G.MoveToTop=function(){this.GetWorldInfo().ZOrderMoveToTop()},KG.MoveToTop=function(){this.moveToTop()},$G.MoveToBottom=function(){this.GetWorldInfo().ZOrderMoveToBottom()},KG.MoveToBottom=function(){this.moveToBottom()},XG.MoveToLayer=function(e){(e=OG(e))&&EG(this).ZOrderMoveToLayer(e)},XG.ZMoveToObject=function(e,t){const s=0===e;if(!(t=FG(t)))return;const i=MG(this),r=t.GetFirstPicked(i);r&&i.GetWorldInfo().ZOrderMoveAdjacentToInstance(r,s)},$G.SetZElevation=function(e){const t=this.GetWorldInfo();t.GetZElevation()!==e&&(t.SetZElevation(e),JG.UpdateRender())},KG.SetZElevation=function(e){this.zElevation=e},XG.LayerNumber=function(){return EG(this).GetLayer().GetIndex()},XG.LayerName=function(){return EG(this).GetLayer().GetName()},$G.ZIndex=function(){return this.GetWorldInfo().GetZIndex()},KG.ZIndex=function(){return this.zIndex},$G.ZElevation=function(){return this.GetWorldInfo().GetZElevation()},KG.ZElevation=function(){return this.zElevation},$G.TotalZElevation=function(){return this.GetWorldInfo().GetTotalZElevation()},KG.TotalZElevation=function(){return this.totalZElevation},XG.IsEffectEnabled=function(e){const t=MG(this),s=t.GetObjectClass().GetEffectList().GetEffectTypeByName(e);if(!s)return;const i=s.GetIndex();return t.GetWorldInfo().GetInstanceEffectList().IsEffectIndexActive(i)},XG.SetEffectEnabled=function(e,t){const s=MG(this),i=s.GetObjectClass().GetEffectList().GetEffectTypeByName(t);if(!i)return;const r=i.GetIndex(),n=1===e,a=s.GetWorldInfo().GetInstanceEffectList();a.IsEffectIndexActive(r)!==n&&(a.SetEffectIndexActive(r,n),a.UpdateActiveEffects(),JG.UpdateRender())},XG.SetEffectParam=function(e,t,s){const i=MG(this),r=i.GetObjectClass().GetEffectList().GetEffectTypeByName(e);if(!r)return;t=Math.floor(t);const n=r.GetShaderProgram().GetParameterType(t);if(!n)return;"color"===n?(qG.setFromRgbValue(s),s=qG):"percent"===n&&(s/=100);const a=r.GetIndex(),o=i.GetWorldInfo().GetInstanceEffectList();o.SetEffectParameter(a,t,s)&&o.IsEffectIndexActive(a)&&JG.UpdateRender()};const tI=YG.New(YG.Rect),sI=[],iI=[];let rI=!1,nI=null,aI=!1;const oI=new Set;function*lI(e){if(!e)return!1;const t=this.GetRuntime(),s=t.GetCollisionEngine(),i=t.GetEventSheetManager(),r=i.GetEventStack(),n=i.GetCurrentCondition(),a=n.GetObjectClass(),o=n.GetSavedDataMap(),l=n.GetUnsavedDataMap(),h=r.GetCurrentStackFrame(),u=t.GetTickCount(),c=u-1,d=h.GetCurrentEvent(),p=r.Push(d);let _=o.get("collmemory");_||(_=YG.New(YG.PairMap),o.set("collmemory",_)),l.get("collisionCreatedDestroyCallback")||(l.set("collisionCreatedDestroyCallback",!0),t.Dispatcher().addEventListener("instancedestroy",e=>kG(_,e.instance)));const m=a.GetCurrentSol(),f=e.GetCurrentSol(),g=m.GetInstances();let y=null;for(let t=0;t<g.length;++t){const r=g[t];f.IsSelectAll()?(s.GetCollisionCandidates(r.GetWorldInfo().GetLayer(),e,r.GetWorldInfo().GetBoundingBox(),sI),y=sI,s.AddRegisteredCollisionCandidates(r,e,y)):y=f.GetInstances();for(let t=0;t<y.length;++t){const n=y[t];if(s.TestOverlap(r,n)||s.CheckRegisteredCollision(r,n)){const t=VG(_,r,n);let s=!1,o=-2;"number"==typeof t&&(s=!0,o=t);const l=!s||o<c;if(BG(_,r,n,u),l){const t=d.GetSolModifiers();i.PushCopySol(t);const s=a.GetCurrentSol(),o=e.GetCurrentSol();if(s._SetSelectAll(!1),o._SetSelectAll(!1),a===e){const e=s._GetOwnInstances();YG.clearArray(e),e.push(r),e.push(n),a.ApplySolToContainer()}else{const t=s._GetOwnInstances(),i=o._GetOwnInstances();YG.clearArray(t),YG.clearArray(i),t.push(r),i.push(n),a.ApplySolToContainer(),e.ApplySolToContainer()}yield*d.DebugRetrigger(h,p),i.PopSol(t)}}else LG(_,r,n)}YG.clearArray(sI)}return r.Pop(),!1}XG.OnCollision=function(e){const t=FG(this);e=FG(e);const s=t.GetRuntime();if(s.IsDebugging())return lI.call(t,e);if(!e)return!1;const i=s.GetCollisionEngine(),r=s.GetEventSheetManager(),n=r.GetEventStack(),a=r.GetCurrentCondition(),o=a.GetObjectClass(),l=a.GetSavedDataMap(),h=a.GetUnsavedDataMap(),u=n.GetCurrentStackFrame(),c=s.GetTickCount(),d=c-1,p=u.GetCurrentEvent(),_=n.Push(p);let m=l.get("collmemory");m||(m=YG.New(YG.PairMap),l.set("collmemory",m)),h.get("collisionCreatedDestroyCallback")||(h.set("collisionCreatedDestroyCallback",!0),s.Dispatcher().addEventListener("instancedestroy",e=>kG(m,e.instance)));const f=o.GetCurrentSol(),g=e.GetCurrentSol(),y=f.GetInstances();let S=null;for(let t=0;t<y.length;++t){const s=y[t];g.IsSelectAll()?(i.GetCollisionCandidates(s.GetWorldInfo().GetLayer(),e,s.GetWorldInfo().GetBoundingBox(),sI),S=sI,i.AddRegisteredCollisionCandidates(s,e,S)):S=g.GetInstances();for(let t=0;t<S.length;++t){const n=S[t];if(i.TestOverlap(s,n)||i.CheckRegisteredCollision(s,n)){const t=VG(m,s,n);let i=!1,a=-2;"number"==typeof t&&(i=!0,a=t);const l=!i||a<d;if(BG(m,s,n,c),l){const t=p.GetSolModifiers();r.PushCopySol(t);const i=o.GetCurrentSol(),a=e.GetCurrentSol();if(i._SetSelectAll(!1),a._SetSelectAll(!1),o===e){const e=i._GetOwnInstances();YG.clearArray(e),e.push(s),e.push(n),o.ApplySolToContainer()}else{const t=i._GetOwnInstances(),r=a._GetOwnInstances();YG.clearArray(t),YG.clearArray(r),t.push(s),r.push(n),o.ApplySolToContainer(),e.ApplySolToContainer()}p.Retrigger(u,_),r.PopSol(t)}}else LG(m,s,n)}YG.clearArray(sI)}return n.Pop(),!1},XG.IsOverlapping=function(e){return e=FG(e),UG(MG(this),e,0,0)},XG.IsOverlappingOffset=function(e,t,s){return e=FG(e),UG(MG(this),e,t,s)},XG.OnHierarchyReady=function(){return!0},XG.HasParent=function(){return EG(this).HasParent()},XG.HasChildren=function(){return EG(this).HasChildren()},XG.PickParent=function(e,t){const s=FG(this);e=FG(e);const i=s.GetRuntime(),r=this.GetCurrentSol().GetInstances();if(0===r.length)return!1;const n=e.GetCurrentSol();let a=n.GetInstances();if(n.IsSelectAll()){const t=[...i.instancesPendingCreateForObjectClass(e)];t.length>0&&(a=a.concat(t))}if(0===a.length)return!1;const o=n.IsSelectAll()?null:new Set(a),l=new Set;for(let s=0,i=r.length;s<i;++s){const i=r[s];if(1===t)for(const t of i.parents())t.BelongsToObjectClass(e)&&(null===o||o.has(t))&&l.add(t);else{let s;if(0===t){if(s=i.GetParent(),null===s)continue}else s=i.GetTopParent();s.BelongsToObjectClass(e)&&(null===o||o.has(s))&&l.add(s)}}return 0!==l.size&&(n.SetSetPicked(l),e.ApplySolToContainer(),!0)},XG.PickChildren=function(e,t){const s=FG(this);e=FG(e);const i=s.GetRuntime(),r=s.GetCurrentSol().GetInstances();if(0===r.length)return!1;const n=e.GetCurrentSol();let a=n.GetInstances();if(n.IsSelectAll()){const t=[...i.instancesPendingCreateForObjectClass(e)];t.length>0&&(a=a.concat(t))}if(0===a.length)return!1;const o=n.IsSelectAll()?null:new Set(a),l=new Set;for(let s=0,i=r.length;s<i;++s){const i=r[s];2!==t||i.HasChildren()||!i.BelongsToObjectClass(e)||null!==o&&!o.has(i)||l.add(i);for(const s of 0===t?i.children():i.allChildren())2===t&&s.HasChildren()||s.BelongsToObjectClass(e)&&(null===o||o.has(s))&&l.add(s)}return 0!==l.size&&(n.SetSetPicked(l),e.ApplySolToContainer(),!0)},XG.PickNthChild=function(e,t,s){const i=FG(this);e=FG(e);const r=i.GetRuntime(),n=i.GetCurrentSol().GetInstances();if(0===n.length)return!1;const a=e.GetCurrentSol();let o=a.GetInstances();if(a.IsSelectAll()){const t=[...r.instancesPendingCreateForObjectClass(e)];t.length>0&&(o=o.concat(t))}if(0===o.length)return!1;const l=a.IsSelectAll()?null:new Set(o),h=[];for(let i=0,r=n.length;i<r;++i){const r=n[i];if(0===t){const t=r.GetChildAt(s);null!==t&&t.BelongsToObjectClass(e)&&(null===l||l.has(t))&&h.push(t)}else if(1===t)for(const t of r.children())if(t.BelongsToObjectClass(e)){if(0===s){(null===l||l.has(t))&&h.push(t);break}--s}}return 0!==h.length&&(a.SetArrayPicked(h),e.ApplySolToContainer(),!0)},XG.CompareChildCount=function(e,t,s){const i=MG(this);switch(e){case 0:default:return YG.compare(i.GetChildCount(),t,s);case 1:return YG.compare(i.GetAllChildCount(),t,s)}},XG.AddChild=function(e,t,s,i,r,n,a,o,l,h){e=FG(e);const u=MG(this),c=JG.GetCurrentAction().GetObjectClass();for(const d of e.allCorrespondingInstances(u,c)){if(!d.GetPlugin().SupportsSceneGraph())return;u.AddChild(d,{transformX:t,transformY:s,transformWidth:i,transformHeight:r,transformAngle:n,transformOpacity:a,transformZElevation:o,transformVisibility:l,destroyWithParent:h})}},XG.RemoveChild=function(e){e=FG(e);const t=MG(this),s=JG.GetCurrentAction().GetObjectClass();for(const i of e.allCorrespondingInstances(t,s))t.RemoveChild(i)},XG.RemoveFromParent=function(){const e=MG(this);e.HasParent()&&e.GetParent().RemoveChild(e)},XG.ParentUID=function(){const e=MG(this).GetParent();return e?e.GetUID():-1},XG.ChildCount=function(){return MG(this).GetChildCount()},XG.AllChildCount=function(){return MG(this).GetAllChildCount()},XG.SetMeshSize=function(e,t){e=Math.floor(e),t=Math.floor(t);const s=EG(this);e<2||t<2||!isFinite(e)||!isFinite(t)?(s.ReleaseMesh(),s.SetBboxChanged()):s.CreateMesh(e,t)},XG.SetMeshPoint=function(e,t,s,i,r,n,a,o){const l=EG(this);l.SetMeshPoint(e,t,{mode:0===s?"absolute":"relative",x:i,y:r,zElevation:n,u:a,v:o})&&l.SetBboxChanged()},XG.MeshColumns=function(){const e=EG(this);return e.HasMesh()?e.GetSourceMesh().GetHSize():0},XG.MeshRows=function(){const e=EG(this);return e.HasMesh()?e.GetSourceMesh().GetVSize():0},XG.SetElementVisible=function(e){const t=EG(this);e=2===e?!t.IsVisible():0!==e,t.IsVisible()!==e&&t.SetVisible(e)},XG.SetElementCSSStyle=function(e,t){this instanceof self.IInstance?this.setElementCSSStyle(e,t):this.SetElementCSSStyle(e,t)},XG.SetElementAttribute=function(e,t){this instanceof self.IInstance?this.setElementAttribute(e,""+t):this.SetElementAttribute(e,""+t)},XG.RemoveElementAttribute=function(e){this instanceof self.IInstance?this.removeElementAttribute(e):this.RemoveElementAttribute(e)},XG.SetElementFocus=function(){this instanceof self.IInstance?this.focusElement():this.FocusElement()},XG.SetElementBlur=function(){this instanceof self.IInstance?this.blurElement():this.BlurElement()},XG.IsElementFocused=function(){return this instanceof self.IInstance?this.isElementFocused():this.IsElementFocused()},XG.SetElementEnabled=function(e){this instanceof self.IInstance?this._setEnabled(0!==e):this._SetEnabled(0!==e)},XG.IsElementEnabled=function(){return this instanceof self.IInstance?this._isEnabled():this._IsEnabled()},$G.CompareInstanceVar=function(e,t,s){return YG.compare(this.GetInstance().GetInstanceVariableValue(e),t,s)},KG.CompareInstanceVar=function(e,t,s){return YG.compare(DG(this).GetInstanceVariableValue(e),t,s)},$G.IsBoolInstanceVarSet=function(e){return!!this.GetInstance().GetInstanceVariableValue(e)},KG.IsBoolInstanceVarSet=function(e){return!!DG(this).GetInstanceVariableValue(e)},XG.PickInstVarHiLow=function(e,t){const s=FG(this),i=s.GetCurrentSol(),r=i.GetInstances();if(!r.length)return!1;const n=s.IsFamily();let a=null,o=0;for(let i=0,l=r.length;i<l;++i){const l=r[i],h=n?l.GetObjectClass().GetFamilyInstanceVariableOffset(s.GetFamilyIndex()):0,u=l.GetInstanceVariableValue(h+t);(null===a||0===e&&u<o||1===e&&u>o)&&(o=u,a=l)}return i.PickOne(a),!0},XG.PickByUID=function(e){const t=FG(this);return t.GetRuntime().GetCurrentCondition().IsInverted()?jG(t,e):zG(t,e)},XG.HasTags=function(e){const t=new Set(YG.splitStringAndNormalize(e)),s=MG(this).GetTagsSet();return t.isSubsetOf(s)},XG.Tags=function(){return MG(this).GetTagsString()},XG.TagsCount=function(){return MG(this).GetTagsSet().size},XG.TagAt=function(e){return MG(this).GetTagAt(e)},XG.ChangeTags=function(e,t){const s=YG.splitStringAndNormalize(t);if(0===s.length)return;const i=MG(this),r=new Set(i.GetTagsSet());if(0===e)for(const e of s)r.add(e);else if(1===e)for(const e of s)r.delete(e);i.SetTagsSet(r)},XG.Destroy=function(){JG.DestroyInstance(MG(this))},XG.OnCreated=function(){return!0},XG.OnDestroyed=function(){return!0},$G.SetInstanceVar=function(e,t){this.GetInstance().SetInstanceVariableValue(e,t)},KG.SetInstanceVar=function(e,t){DG(this).SetInstanceVariableValue(e,t)},$G.AddInstanceVar=function(e,t){const s=this.GetInstance(),i=s.GetInstanceVariableValue(e);"number"==typeof i&&"number"!=typeof t?t=parseFloat(t):"string"==typeof i&&"string"!=typeof t&&(t=t.toString()),s.SetInstanceVariableValue(e,i+t)},KG.AddInstanceVar=function(e,t){const s=DG(this),i=s.GetInstanceVariableValue(e);"number"==typeof i&&"number"!=typeof t?t=parseFloat(t):"string"==typeof i&&"string"!=typeof t&&(t=t.toString()),s.SetInstanceVariableValue(e,i+t)},$G.SubInstanceVar=function(e,t){const s=this.GetInstance(),i=s.GetInstanceVariableValue(e);"number"==typeof i&&("number"!=typeof t&&(t=parseFloat(t)),s.SetInstanceVariableValue(e,i-t))},KG.SubInstanceVar=function(e,t){const s=DG(this),i=s.GetInstanceVariableValue(e);"number"==typeof i&&("number"!=typeof t&&(t=parseFloat(t)),s.SetInstanceVariableValue(e,i-t))},$G.SetBoolInstanceVar=function(e,t){this.GetInstance().SetInstanceVariableValue(e,t?1:0)},KG.SetBoolInstanceVar=function(e,t){DG(this).SetInstanceVariableValue(e,t?1:0)},$G.ToggleBoolInstanceVar=function(e){const t=this.GetInstance();t.SetInstanceVariableValue(e,0===t.GetInstanceVariableValue(e)?1:0)},KG.ToggleBoolInstanceVar=function(e){const t=DG(this);t.SetInstanceVariableValue(e,0===t.GetInstanceVariableValue(e)?1:0)},XG.LoadFromJsonString=function(e){let t;try{t=JSON.parse(e)}catch(e){return void console.error("Failed to load from JSON string: ",e)}const s=MG(this),i="state";JG.ClearIntancesNeedingAfterLoad(),s._OnBeforeLoad(i),s.LoadFromJson(t,i),JG.DoAfterLoad(i,{setFromJson:!0})},XG.AsJSON=function(){return JSON.stringify(MG(this).SaveToJson("state"))},XG.ObjectTypeName=function(){return MG(this).GetObjectClass().GetName()},XG.Count=function(){const e=JG.GetCurrentEventStackFrame().GetExpressionObjectClass();let t=e.GetInstanceCount();for(const s of JG.instancesPendingCreateForObjectClass(e))++t;return t},XG.PickedCount=function(){return JG.GetCurrentEventStackFrame().GetExpressionObjectClass().GetCurrentSol().GetInstances().length},$G.GetIID=function(){return this.GetInstance().GetIID()},KG.GetIID=function(){return DG(this).GetIID()},$G.GetUID=function(){return this.GetInstance().GetUID()},KG.GetUID=function(){return DG(this).GetUID()},XG.OnInstanceSignal=function(e){const t=MG(this);return e.toLowerCase()===JG.GetEventSheetManager().GetCurrentInstanceSignalTag(t)},XG.InstanceSignal=function(e){const t=MG(this);JG.GetEventSheetManager().InstanceSignal(t,e)},XG.InstanceWaitForSignal=function(e){const t=FG(this);return JG.GetEventSheetManager().AddScheduledWait().InitInstanceSignals(t.GetCurrentSol().GetInstances(),e),!0},XG.TemplateName=function(){return MG(this).GetTemplateName()},YG.AddCommonACEs=function(e,t,s){const i=e[1],r=e[3],n=e[4],a=e[5],o=e[6],l=e[7],h=e[8],u=e[10],c=e[11],d=e[12],p=e[13],_=e[14],m=e[15],f=e[16],g=t.Cnds,y=t.Acts,S=t.Exps,T=Object.assign({},XG,s>=2?KG:$G);r&&(g.CompareX=T.CompareX,g.CompareY=T.CompareY,g.IsOnScreen=T.IsOnScreen,g.IsOutsideLayout=T.IsOutsideLayout,g.PickDistance=T.PickDistance,y.SetX=T.SetX,y.SetY=T.SetY,y.SetPos=T.SetPos,y.SetPosToObject=T.SetPosToObject,y.MoveForward=T.MoveForward,y.MoveAtAngle=T.MoveAtAngle,S.X=T.GetX,S.Y=T.GetY,S.dt=T.GetDt),n&&(g.CompareWidth=T.CompareWidth,g.CompareHeight=T.CompareHeight,y.SetWidth=T.SetWidth,y.SetHeight=T.SetHeight,y.SetSize=T.SetSize,S.Width=T.GetWidth,S.Height=T.GetHeight,S.BBoxLeft=T.GetBboxLeft,S.BBoxTop=T.GetBboxTop,S.BBoxRight=T.GetBboxRight,S.BBoxBottom=T.GetBboxBottom,S.BBoxMidX=T.GetBboxMidX,S.BBoxMidY=T.GetBboxMidY),a&&(g.AngleWithin=T.IsAngleWithin,g.IsClockwiseFrom=T.IsAngleClockwiseFrom,g.IsBetweenAngles=T.IsBetweenAngles,y.SetAngle=T.SetAngle,y.RotateClockwise=T.RotateClockwise,y.RotateCounterclockwise=T.RotateCounterclockwise,y.RotateTowardAngle=T.RotateTowardAngle,y.RotateTowardPosition=T.RotateTowardPosition,y.SetTowardPosition=T.SetTowardPosition,S.Angle=T.GetAngle),o&&(g.IsVisible=T.IsVisible,g.CompareOpacity=T.CompareOpacity,y.SetVisible=T.SetVisible,y.SetOpacity=T.SetOpacity,y.SetDefaultColor=T.SetDefaultColor,S.Opacity=T.GetOpacity,S.ColorValue=T.GetColor),l&&(g.IsOnLayer=T.IsOnLayer,g.PickTopBottom=T.PickTopBottom,g.CompareZElevation=T.CompareZElevation,y.MoveToTop=T.MoveToTop,y.MoveToBottom=T.MoveToBottom,y.MoveToLayer=T.MoveToLayer,y.ZMoveToObject=T.ZMoveToObject,y.SetZElevation=T.SetZElevation,S.LayerNumber=T.LayerNumber,S.LayerName=T.LayerName,S.ZIndex=T.ZIndex,S.ZElevation=T.ZElevation,S.TotalZElevation=T.TotalZElevation),h&&(g.IsEffectEnabled=T.IsEffectEnabled,y.SetEffectEnabled=T.SetEffectEnabled,y.SetEffectParam=T.SetEffectParam),p&&(g.OnHierarchyReady=T.OnHierarchyReady,g.HasParent=T.HasParent,g.HasChildren=T.HasChildren,g.PickParent=T.PickParent,g.PickChildren=T.PickChildren,g.PickNthChild=T.PickNthChild,g.CompareChildCount=T.CompareChildCount,y.AddChild=T.AddChild,y.RemoveChild=T.RemoveChild,y.RemoveFromParent=T.RemoveFromParent,S.ParentUID=T.ParentUID,S.ChildCount=T.ChildCount,S.AllChildCount=T.AllChildCount),_&&(y.SetMeshSize=T.SetMeshSize,y.SetMeshPoint=T.SetMeshPoint,S.MeshColumns=T.MeshColumns,S.MeshRows=T.MeshRows),u&&(g.IsVisible=T.IsVisible,y.SetVisible=T.SetElementVisible,y.SetCSSStyle=T.SetElementCSSStyle,y.SetElemAttribute=T.SetElementAttribute,y.RemoveElemAttribute=T.RemoveElementAttribute),c&&(g.IsFocused=T.IsElementFocused,y.SetFocus=T.SetElementFocus,y.SetBlur=T.SetElementBlur),d&&(g.IsEnabled=T.IsElementEnabled,y.SetEnabled=T.SetElementEnabled),m&&(g.OnCollision=T.OnCollision,g.IsOverlapping=T.IsOverlapping,g.IsOverlappingOffset=T.IsOverlappingOffset,t.FinishCollisionCondition=HG),i||(g.CompareInstanceVar=T.CompareInstanceVar,g.IsBoolInstanceVarSet=T.IsBoolInstanceVarSet,g.PickInstVarHiLow=T.PickInstVarHiLow,g.PickByUID=T.PickByUID,g.HasTags=T.HasTags,y.SetInstanceVar=T.SetInstanceVar,y.AddInstanceVar=T.AddInstanceVar,y.SubInstanceVar=T.SubInstanceVar,y.SetBoolInstanceVar=T.SetBoolInstanceVar,y.ToggleBoolInstanceVar=T.ToggleBoolInstanceVar,y.ChangeTags=T.ChangeTags,g.OnCreated=T.OnCreated,g.OnDestroyed=T.OnDestroyed,y.Destroy=T.Destroy,y.LoadFromJsonString||(y.LoadFromJsonString=T.LoadFromJsonString),S.AsJSON||(S.AsJSON=T.AsJSON),S.Count=T.Count,S.PickedCount=T.PickedCount,S.IID=T.GetIID,S.UID=T.GetUID,S.ObjectTypeName=T.ObjectTypeName,S.Tags=T.Tags,S.TagsCount=T.TagsCount,S.TagAt=T.TagAt,g.OnInstanceSignal=T.OnInstanceSignal,y.InstanceSignal=T.InstanceSignal,y.InstanceWaitForSignal=T.InstanceWaitForSignal),f&&(S.TemplateName=T.TemplateName)}}{const hI=self.C3;hI.ScheduledWait=class extends hI.DefendedBase{constructor(e){super(),this._eventSheetManager=e,this._type="",this._time=-1,this._signalTag="",this._isSignalled=!1,this._event=null,this._actIndex=0,this._solModifiers=[],this._dynamicSolModifiers=null,this._sols=new Map,this._pendingInstances=null,this._callingFunctionBlock=null,this._asyncId=-1,this._functionParameters=null,this._functionInnerLocalVars=null,this._shouldRelease=!1}Release(){this._type="",this._time=-1,this._signalTag="",this._event=null,this._callingFunctionBlock=null,this._functionParameters=null,this._functionInnerLocalVars=null,this._asyncId=-1,hI.clearArray(this._solModifiers),this._dynamicSolModifiers&&(this._dynamicSolModifiers.clear(),this._dynamicSolModifiers=null);for(const e of this._sols.values())e.Release();this._sols.clear(),this._pendingInstances=null}_Init(){const e=this._eventSheetManager,t=e.GetRuntime().GetAllObjectClasses(),s=e.GetCurrentEventStackFrame();this._event=s.GetCurrentEvent(),this._actIndex=s.GetActionIndex()+1;const i=e.FindFirstFunctionBlockParent(this._event);i&&(this._callingFunctionBlock=i,this._functionParameters=i.CaptureFunctionParameters(),this._functionInnerLocalVars=i._GetAllInnerLocalVariables().map(e=>e.GetValue()),i.IsAsync()&&(this._asyncId=i.PauseCurrentAsyncFunction()));for(const e of t){const t=e.GetCurrentSol();t.IsSelectAll()&&!this._event.HasSolModifier(e)||(this._solModifiers.push(e),this._sols.set(e,hI.New(hI.SolState,t)))}const r=e.GetDynamicSolModifiersSet();this._dynamicSolModifiers=r.size>0?r:null}InitTimer(e){this._type="timer",this._Init(),this._time=this._eventSheetManager.GetRuntime().GetGameTime()+e}InitWallTimer(e){this._type="walltimer",this._Init(),this._time=this._eventSheetManager.GetRuntime().GetWallTime()+e}InitSignal(e){this._type="signal",this._Init(),this._signalTag=e.toLowerCase()}InitInstanceSignals(e,t){this._type="instance-signals",this._Init(),this._signalTag=t.toLowerCase(),this._pendingInstances=new Set(e)}InitPromise(e){this._type="promise",this._Init(),e.then(()=>this.SetSignalled()).catch(e=>{console.warn("[C3 runtime] Promise rejected in 'Wait for previous actions to complete': ",e),this.SetSignalled()})}IsTimer(){return"timer"===this._type}IsWallTimer(){return"walltimer"===this._type}IsSignal(){return"signal"===this._type}IsInstanceSignals(){return"instance-signals"===this._type}IsPromise(){return"promise"===this._type}GetSignalTag(){return this._signalTag}IsSignalled(){return this._isSignalled}SetSignalled(){this._isSignalled=!0}SetInstanceSignalled(e){this._pendingInstances.delete(e),0===this._pendingInstances.size&&this.SetSignalled()}_ShouldRun(){return this.IsTimer()?this._time<=this._eventSheetManager.GetRuntime().GetGameTime():this.IsWallTimer()?this._time<=this._eventSheetManager.GetRuntime().GetWallTime():this.IsSignalled()}_RestoreState(e){e._Restore(this._event,this._actIndex);for(const[e,t]of this._sols.entries()){const s=e.GetCurrentSol();t._Restore(s)}this._dynamicSolModifiers&&e.SetDynamicSolModifiers([...this._dynamicSolModifiers]);const t=this._callingFunctionBlock;t&&(t.SetFunctionParameters(this._functionParameters),t._GetAllInnerLocalVariables().map((e,t)=>e.SetValue(this._functionInnerLocalVars[t])),t.IsAsync()&&t.ResumeAsyncFunction(this._asyncId))}_Run(e){this._RestoreState(e),this._event._ResumeActionsAndSubEvents(e),this._callingFunctionBlock&&this._callingFunctionBlock.IsAsync()&&this._callingFunctionBlock.MaybeFinishAsyncFunctionCall(this._asyncId),this._eventSheetManager.ClearSol(this._solModifiers),this._shouldRelease=!0}async _DebugRun(e){this._RestoreState(e);for(const t of this._event._DebugResumeActionsAndSubEvents(e))await this._eventSheetManager.GetRuntime().DebugBreak(t);this._callingFunctionBlock&&this._callingFunctionBlock.IsAsync()&&this._callingFunctionBlock.MaybeFinishAsyncFunctionCall(this._asyncId),this._eventSheetManager.ClearSol(this._solModifiers),this._shouldRelease=!0}ShouldRelease(){return this._shouldRelease}RemoveInstances(e){for(const t of this._sols.values())t.RemoveInstances(e);if("instance-signals"===this._type){for(const t of e)this._pendingInstances.delete(t);0===this._pendingInstances.size&&this.SetSignalled()}}_SaveToJson(){const e={},t={wt:this._type,t:this._time,st:this._signalTag,s:this._isSignalled,ev:this._event.GetSID(),sm:this._solModifiers.map(e=>e.GetSID()),dsm:this._dynamicSolModifiers?[...this._dynamicSolModifiers].map(e=>e.GetSID()):null,sols:e};this._event._HasActionIndex(this._actIndex)&&(t.act=this._event.GetActionAt(this._actIndex).GetSID());for(const[t,s]of this._sols)e[t.GetSID().toString()]=s._SaveToJson();return"instance-signals"===this._type&&(t.pi=[...this._pendingInstances].map(e=>e.GetUID())),t}static _CreateFromJson(e,t){const s=e.GetRuntime(),i=e.GetEventBlockBySID(t.ev);if(!i)return null;let r=0;if(t.hasOwnProperty("act")){const s=e.GetActionBySID(t.act);if(!s)return null;r=s.GetIndex()}const n=hI.New(hI.ScheduledWait,e);n._time=t.t,t.hasOwnProperty("wt")?n._type=t.wt:n._type=-1===n._time?"signal":"timer",n._signalTag=t.st,n._isSignalled=t.s,n._event=i,n._actIndex=r;for(const e of t.sm){const t=s.GetObjectClassBySID(e);t&&n._solModifiers.push(t)}if(Array.isArray(t.dsm))for(const e of t.dsm){const t=s.GetObjectClassBySID(e);t&&(n._dynamicSolModifiers||(n._dynamicSolModifiers=new Set),n._dynamicSolModifiers.add(t))}for(const[i,r]of Object.entries(t.sols)){const t=parseInt(i,10),a=s.GetObjectClassBySID(t);if(!a)continue;const o=hI.New(hI.SolState,null);o._LoadFromJson(e,r),n._sols.set(a,o)}if("instance-signals"===n._type){n._pendingInstances=new Set;for(const e of t.pi){const t=s.GetInstanceByUID(e);t&&n._pendingInstances.add(t)}}return n}}}{const uI=self.C3;uI.SolState=class extends uI.DefendedBase{constructor(e){super(),this._objectClass=null,this._isSelectAll=!0,this._instances=[],e&&(this._objectClass=e.GetObjectClass(),this._isSelectAll=e.IsSelectAll(),uI.shallowAssignArray(this._instances,e._GetOwnInstances()))}Release(){this._objectClass=null,uI.clearArray(this._instances)}_Restore(e){e._SetSelectAll(this._isSelectAll),uI.shallowAssignArray(e._GetOwnInstances(),this._instances)}RemoveInstances(e){uI.arrayRemoveAllInSet(this._instances,e)}_SaveToJson(){return{sa:this._isSelectAll,insts:this._instances.map(e=>e.GetUID())}}_LoadFromJson(e,t){const s=e.GetRuntime();this._isSelectAll=!!t.sa,uI.clearArray(this._instances);for(const e of t.insts){const t=s.GetInstanceByUID(e);t&&this._instances.push(t)}}}}{let cI=function(e,t){let s=e.get(t);return s||(s=new Map,e.set(t,s)),s};GetNextParamMap=cI;const dI=self.C3;dI.SDKPluginBase=class extends dI.DefendedBase{constructor(e){super(),this._runtime=e.runtime,this._id=e.id,this._name=e.name??"",this._isSingleGlobal=!!e.isSingleGlobal,this._isWorldType=!!e.isWorld,this._isRotatable=!!e.isRotatable,this._mustPredraw=!!e.mustPredraw,this._hasEffects=!!e.hasEffects,this._supportsSceneGraph=!!e.supportsSceneGraph,this._supportsMesh=!!e.supportsMesh,this._isHTMLElementType=!!e.isHTMLElementType,this._is3d=!!e.is3d,this._sdkVersion=e.sdkVersion,this._singleGlobalObjectClass=null,this._boundACEMethodCache=new Map,this._boundACEMethodCache_1param=new Map,this._boundACEMethodCache_2params=new Map,this._boundACEMethodCache_3params=new Map,this._scriptInterfaceClass=e.scriptInterfaceClass,this._iPlugin=null}Release(){this._runtime=null}GetRuntime(){return this._runtime}GetID(){return this._id}GetName(){return this._name}OnCreate(){}GetConstructor(){return this.GetSdkVersion()>=2?this._iPlugin.constructor:this.constructor}GetSdkVersion(){return this._sdkVersion}GetScriptInterfaceClass(e=!1){let t=this._scriptInterfaceClass;return e&&"function"!=typeof t&&this.GetSdkVersion()>=2&&(t=globalThis.ISDKPluginBase),t}IsSingleGlobal(){return this._isSingleGlobal}IsWorldType(){return this._isWorldType}IsHTMLElementType(){return this._isHTMLElementType}Is3D(){return this._is3d}IsRotatable(){return this._isRotatable}MustPreDraw(){return this._mustPredraw}HasEffects(){return this._hasEffects}SupportsSceneGraph(){return this._supportsSceneGraph}SupportsMesh(){return this._supportsMesh}_GetBoundACEMethod(e,t){if(!t)throw new Error("missing 'this' binding");let s=this._boundACEMethodCache.get(e);return s||(s=e.bind(t),this._boundACEMethodCache.set(e,s),s)}_GetBoundACEMethod_1param(e,t,s){if(!t)throw new Error("missing 'this' binding");const i=cI(this._boundACEMethodCache_1param,e);let r=i.get(s);return r||(r=e.bind(t,s),i.set(s,r),r)}_GetBoundACEMethod_2params(e,t,s,i){if(!t)throw new Error("missing 'this' binding");const r=cI(this._boundACEMethodCache_2params,e),n=cI(r,s);let a=n.get(i);return a||(a=e.bind(t,s,i),n.set(i,a),a)}_GetBoundACEMethod_3params(e,t,s,i,r){if(!t)throw new Error("missing 'this' binding");const n=cI(this._boundACEMethodCache_3params,e),a=cI(n,s),o=cI(a,i);let l=o.get(r);return l||(l=e.bind(t,s,i,r),o.set(r,l),l)}_SetSingleGlobalObjectClass(e){if(!this.IsSingleGlobal())throw new Error("must be single-global plugin");this._singleGlobalObjectClass=e}GetSingleGlobalObjectClass(){if(!this.IsSingleGlobal())throw new Error("must be single-global plugin");return this._singleGlobalObjectClass}GetSingleGlobalInstance(){if(!this.IsSingleGlobal())throw new Error("must be single-global plugin");return this._singleGlobalObjectClass.GetSingleGlobalInstance()}_InitScriptInterface(){const e=this.GetSdkVersion();dI.AddonManager._PushInitObject(this,e);const t=this.GetScriptInterfaceClass(!0);if(t){if(this._iPlugin=new t,!(this._iPlugin instanceof self.IPlugin))throw new TypeError("plugin class must derive from IPlugin")}else this._iPlugin=new self.IPlugin;dI.AddonManager._PopInitObject(e)}GetIPlugin(){return this._iPlugin}}}{const pI=self.C3;pI.SDKDOMPluginBase=class extends pI.SDKPluginBase{constructor(e,t){super(e),this._domComponentId=t,this._nextElementId=0,this._instMap=new Map,this.AddElementMessageHandler("elem-focused",e=>e._OnElemFocused()),this.AddElementMessageHandler("elem-blurred",e=>{e&&e._OnElemBlurred()})}Release(){super.Release()}_AddElement(e){const t=this._nextElementId++;return this._instMap.set(t,e),t}_RemoveElement(e){this._instMap.delete(e)}AddElementMessageHandler(e,t){this._runtime.AddDOMComponentMessageHandler(this._domComponentId,e,e=>{const s=this._instMap.get(e.elementId);t(s,e)})}}}{const _I=self.C3;_I.SDKTypeBase=class extends _I.DefendedBase{constructor(e){super(),this._objectClass=e,this._runtime=e.GetRuntime(),this._plugin=e.GetPlugin()}Release(){this._objectClass=null,this._runtime=null,this._plugin=null}GetObjectClass(){return this._objectClass}GetRuntime(){return this._runtime}GetPlugin(){return this._plugin}GetImageInfo(){return this._objectClass.GetImageInfo()}OnCreate(){}FinishCondition(e){}BeforeRunAction(e){}AfterRunAction(e){}LoadTextures(e){}ReleaseTextures(){}OnDynamicTextureLoadComplete(){}PreloadTexturesWithInstances(e){}LoadTilemapData(){}GetScriptInterfaceClass(){return null}DispatchScriptEvent(e,t,s){const i=_I.New(_I.Event,e,t);i.objectClass=this,s&&Object.assign(i,s),this.GetObjectClass().DispatchUserScriptEvent(i)}}}{const mI=self.C3;mI.SDKInstanceBase=class extends mI.DefendedBase{constructor(e,t){super(),this._inst=e,this._domComponentId=t,this._wrapperComponentId=null,this._runtime=e.GetRuntime(),this._objectClass=this._inst.GetObjectClass(),this._sdkType=this._objectClass.GetSdkType(),this._tickFunc=null,this._tick2Func=null,this._isTicking=!1,this._isTicking2=!1,this._disposables=null,this._wasReleased=!1}Release(){this._wasReleased=!0,this._StopTicking(),this._StopTicking2(),this._tickFunc=null,this._tick2Func=null,this._disposables&&(this._disposables.Release(),this._disposables=null),this._inst=null,this._runtime=null,this._objectClass=null,this._sdkType=null}WasReleased(){return this._wasReleased}GetInstance(){return this._inst}GetRuntime(){return this._runtime}GetObjectClass(){return this._objectClass}GetPlugin(){return this._sdkType.GetPlugin()}GetSdkType(){return this._sdkType}GetScriptInterface(){return this._inst.GetInterfaceClass()}Trigger(e){return this._runtime.Trigger(e,this._inst,null)}DebugTrigger(e){return this._runtime.DebugTrigger(e,this._inst,null)}TriggerAsync(e){return this._runtime.TriggerAsync(e,this._inst,null)}FastTrigger(e,t){return this._runtime.FastTrigger(e,this._inst,t)}DebugFastTrigger(e,t){return this._runtime.DebugFastTrigger(e,this._inst,t)}ScheduleTriggers(e){return this._runtime.ScheduleTriggers(e)}AddDOMMessageHandler(e,t){this._runtime.AddDOMComponentMessageHandler(this._domComponentId,e,t)}AddDOMMessageHandlers(e){for(const[t,s]of e)this.AddDOMMessageHandler(t,s)}PostToDOM(e,t){this._runtime.PostComponentMessageToDOM(this._domComponentId,e,t)}PostToDOMAsync(e,t){return this._runtime.PostComponentMessageToDOMAsync(this._domComponentId,e,t)}_PostToDOMMaybeSync(e,t){if(!this._runtime.IsInWorker())return window.c3_runtimeInterface._OnMessageFromRuntime({type:"event",component:this._domComponentId,handler:e,data:t,responseId:null});this.PostToDOM(e,t)}SetWrapperExtensionComponentId(e){if(!e)throw new Error("cannot set empty component id");this._wrapperComponentId=e}IsWrapperExtensionAvailable(){if(!this._wrapperComponentId)throw new Error("wrapper extension component id not set");return this._runtime.HasWrapperComponentId(this._wrapperComponentId)}AddWrapperExtensionMessageHandler(e,t){if(!this._wrapperComponentId)throw new Error("wrapper extension component id not set");this._runtime.AddWrapperExtensionMessageHandler(this._wrapperComponentId,e,t)}AddWrapperExtensionMessageHandlers(e){for(const[t,s]of e)this.AddWrapperExtensionMessageHandler(t,s)}SendWrapperExtensionMessage(e,t){if(!this._wrapperComponentId)throw new Error("wrapper extension component id not set");this._runtime.SendWrapperExtensionMessage(this._wrapperComponentId,e,t)}SendWrapperExtensionMessageAsync(e,t){if(!this._wrapperComponentId)throw new Error("wrapper extension component id not set");return this._runtime.SendWrapperExtensionMessageAsync(this._wrapperComponentId,e,t)}Tick(){}Tick2(){}_StartTicking(){if(!this._isTicking){if(!this._tickFunc)if(this._runtime.IsDebug()){const e=globalThis.C3Debugger,t=this.GetPlugin();this._tickFunc=()=>{const s=performance.now();this.Tick(),e.AddIndividualPluginTickTime(t,performance.now()-s)}}else this._tickFunc=()=>this.Tick();this._runtime.Dispatcher().addEventListener("tick",this._tickFunc),this._isTicking=!0}}_StopTicking(){this._isTicking&&(this._runtime.Dispatcher().removeEventListener("tick",this._tickFunc),this._isTicking=!1)}IsTicking(){return this._isTicking}_StartTicking2(){if(!this._isTicking2){if(!this._tick2Func)if(this._runtime.IsDebug()){const e=globalThis.C3Debugger,t=this.GetPlugin();this._tick2Func=()=>{const s=performance.now();this.Tick2(),e.AddIndividualPluginTickTime(t,performance.now()-s)}}else this._tick2Func=()=>this.Tick2();this._runtime.Dispatcher().addEventListener("tick2",this._tick2Func),this._isTicking2=!0}}_StopTicking2(){this._isTicking2&&(this._runtime.Dispatcher().removeEventListener("tick2",this._tick2Func),this._isTicking2=!1)}IsTicking2(){return this._isTicking2}GetDebuggerProperties(){return[]}SaveToJson(){return null}LoadFromJson(e){}GetPropertyValueByIndex(e){}SetPropertyValueByIndex(e,t){}OffsetPropertyValueByIndex(e,t,s){if(0===t)return;const i=this.GetPropertyValueByIndex(e);if("number"!=typeof i)throw new Error("expected number");this.SetPropertyValueByIndex(e,i+t,s)}SetPropertyColorOffsetValueByIndex(e,t,s,i){}CallAction(e,...t){e.call(this,...t)}CallExpression(e,...t){return e.call(this,...t)}GetScriptInterfaceClass(){return null}DispatchScriptEvent(e,t,s){if(!this._inst.HasScriptInterface())return;const i=this.GetScriptInterface(),r=mI.New(mI.Event,e,t);r.instance=i,s&&Object.assign(r,s),i.dispatchEvent(r)}MustPreDraw(){return!1}}}{const fI=self.C3;fI.SDKWorldInstanceBase=class extends fI.SDKInstanceBase{constructor(e,t){super(e,t),this._worldInfo=e.GetWorldInfo(),this._renderercontextlost_handler=null,this._renderercontextrestored_handler=null}Release(){if(this._renderercontextlost_handler){const e=this._runtime.Dispatcher();e.removeEventListener("renderercontextlost",this._renderercontextlost_handler),e.removeEventListener("renderercontextrestored",this._renderercontextrestored_handler),this._renderercontextlost_handler=null,this._renderercontextrestored_handler=null}this._worldInfo=null,super.Release()}HandleWebGLContextLoss(){this.HandleRendererContextLoss()}OnWebGLContextLost(){}OnWebGLContextRestored(){}HandleRendererContextLoss(){if(this._renderercontextlost_handler)return;this._renderercontextlost_handler=()=>this.OnRendererContextLost(),this._renderercontextrestored_handler=()=>this.OnRendererContextRestored();const e=this._runtime.Dispatcher();e.addEventListener("renderercontextlost",this._renderercontextlost_handler),e.addEventListener("renderercontextrestored",this._renderercontextrestored_handler)}OnRendererContextLost(){this.OnWebGLContextLost()}OnRendererContextRestored(){this.OnWebGLContextRestored()}GetWorldInfo(){return this._worldInfo}IsOriginalSizeKnown(){return!1}GetOriginalWidth(){if(!this.IsOriginalSizeKnown())throw new Error("original size not known");const e=this.GetCurrentImageInfo();if(e)return e.GetWidth()}GetOriginalHeight(){if(!this.IsOriginalSizeKnown())throw new Error("original size not known");const e=this.GetCurrentImageInfo();if(e)return e.GetHeight()}GetCurrentImageInfo(){return null}GetCurrentSurfaceSize(){const e=this.GetCurrentImageInfo();if(e){const t=e.GetTexture();if(t)return[t.GetWidth(),t.GetHeight()]}return[100,100]}GetCurrentTexRect(){const e=this.GetCurrentImageInfo();return e?e.GetTexRect():null}GetCurrentTexQuad(){const e=this.GetCurrentImageInfo();return e?e.GetTexQuad():null}IsCurrentTexRotated(){const e=this.GetCurrentImageInfo();return!!e&&e.IsRotated()}GetImagePoint(e){const t=this._inst.GetWorldInfo();return[t.GetX(),t.GetY(),t.GetTotalZElevation()]}LoadTilemapData(e,t,s){}TestPointOverlapTile(e,t){}RendersToOwnZPlane(){return!0}}}{const gI=self.C3,yI=gI.New(gI.Rect);gI.SDKDOMInstanceBase=class extends gI.SDKWorldInstanceBase{constructor(e,t){super(e,t),this._elementId=this.GetPlugin()._AddElement(this),this._isElementShowing=!0,this._elemHasFocus=!1,this._autoFontSize=!1,this._autoFontSizeOffset=-.2,this._lastRect=gI.New(gI.Rect,0,0,-1,-1);const s=this._runtime.GetCanvasManager();this._lastWindowWidth=s.GetLastWidth(),this._lastWindowHeight=s.GetLastHeight(),this._lastHTMLIndex=-1,this._lastHTMLZIndex=-1,this._isPendingUpdateState=!1,this._StartTicking()}Release(){this.GetPlugin()._RemoveElement(this._elementId),this.PostToDOMElement("destroy"),this._elementId=-1,super.Release()}_GetElementInDOMMode(){if(this._runtime.IsInWorker())throw new Error("not valid in worker mode");return this._PostToDOMElementMaybeSync("get-element")}PostToDOMElement(e,t){t||(t={}),t.elementId=this._elementId,this.PostToDOM(e,t)}_PostToDOMElementMaybeSync(e,t){return t||(t={}),t.elementId=this._elementId,this._PostToDOMMaybeSync(e,t)}PostToDOMElementAsync(e,t){return t||(t={}),t.elementId=this._elementId,this.PostToDOMAsync(e,t)}CreateElement(e){e||(e={});const t=this.GetWorldInfo();e.elementId=this._elementId,e.isVisible=t.IsVisible(),e.htmlIndex=t.GetLayer().GetHTMLIndex(),e.htmlZIndex=t.GetHTMLZIndex(),Object.assign(e,this.GetElementState()),this._isElementShowing=!!e.isVisible,this._PostToDOMMaybeSync("create",e),this._UpdatePosition(!0)}SetElementVisible(e){e=!!e,this._isElementShowing!==e&&(this._isElementShowing=e,this.PostToDOMElement("set-visible",{isVisible:e}))}Tick(){this._UpdatePosition(!1)}_ShouldPreserveElement(){const e=this._runtime.GetCanvasManager().GetFullscreenMode();return"Android"===gI.Platform.OS&&("scale-inner"===e||"scale-outer"===e||"crop"===e)}_UpdatePosition(e){if(this.GetInstance().IsDestroyed())return;const t=this.GetWorldInfo(),s=t.GetLayer(),i=t.GetBoundingBox();let[r,n]=s.LayerToCanvasCss(i.getLeft(),i.getTop()),[a,o]=s.LayerToCanvasCss(i.getRight(),i.getBottom());const l=this._runtime.GetCanvasManager(),h=l.GetCssWidth(),u=l.GetCssHeight();if(!t.IsVisible()||!s.IsVisible())return void this.SetElementVisible(!1);if(!this._ShouldPreserveElement()&&(a<=0||o<=0||r>=h||n>=u))return void this.SetElementVisible(!1);yI.set(r,n,a,o);const c=l.GetLastWidth(),d=l.GetLastHeight(),p=s.GetHTMLIndex(),_=t.GetHTMLZIndex();if(!e&&yI.equals(this._lastRect)&&this._lastWindowWidth===c&&this._lastWindowHeight===d&&this._lastHTMLIndex===p&&this._lastHTMLZIndex===_)return void this.SetElementVisible(!0);this._lastRect.copy(yI),this._lastWindowWidth=c,this._lastWindowHeight=d,this._lastHTMLIndex=p,this._lastHTMLZIndex=_,this.SetElementVisible(!0);let m=null;this._autoFontSize&&(m=s.GetDisplayScale()+this._autoFontSizeOffset),this._PostToDOMElementMaybeSync("update-position",{left:Math.round(this._lastRect.getLeft()),top:Math.round(this._lastRect.getTop()),width:Math.round(this._lastRect.width()),height:Math.round(this._lastRect.height()),htmlIndex:p,htmlZIndex:_,fontSize:m})}FocusElement(){this._PostToDOMElementMaybeSync("focus",{focus:!0})}BlurElement(){this._PostToDOMElementMaybeSync("focus",{focus:!1})}_OnElemFocused(){this._elemHasFocus=!0}_OnElemBlurred(){this._elemHasFocus=!1}IsElementFocused(){return this._elemHasFocus}SetElementCSSStyle(e,t){this.PostToDOMElement("set-css-style",{prop:gI.CSSToCamelCase(e),val:t})}SetElementAttribute(e,t){this.PostToDOMElement("set-attribute",{name:e,val:t})}RemoveElementAttribute(e){this.PostToDOMElement("remove-attribute",{name:e})}UpdateElementState(){this._isPendingUpdateState||(this._isPendingUpdateState=!0,Promise.resolve().then(()=>{this._isPendingUpdateState=!1,this.PostToDOMElement("update-state",this.GetElementState())}))}GetElementState(){}GetElementId(){return this._elementId}}}{const SI=self.C3,TI=self.IBehavior;SI.SDKBehaviorBase=class extends SI.DefendedBase{constructor(e){super(),this._runtime=e.runtime,this._id=e.id,this._name=e.name??"",this._myObjectClasses=SI.New(SI.ArraySet),this._myInstances=SI.New(SI.ArraySet),this._sdkVersion=e.sdkVersion,this._scriptInterfaceClass=e.scriptInterfaceClass,this._iBehavior=null}Release(){this._myInstances.Release(),this._myObjectClasses.Release(),this._runtime=null}GetRuntime(){return this._runtime}GetID(){return this._id}GetName(){return this._name}OnCreate(){}GetSdkVersion(){return this._sdkVersion}GetScriptInterfaceClass(e=!1){let t=this._scriptInterfaceClass;return e&&"function"!=typeof t&&this.GetSdkVersion()>=2&&(t=globalThis.ISDKBehaviorBase),t}_AddObjectClass(e){this._myObjectClasses.Add(e)}GetObjectClasses(){return this._myObjectClasses.GetArray()}_AddInstance(e){this._myInstances.Add(e)}_RemoveInstance(e){this._myInstances.Delete(e)}GetInstances(){return this._myInstances.GetArray()}_InitScriptInterface(){const e=this.GetSdkVersion();SI.AddonManager._PushInitObject(this,e);const t=this.GetScriptInterfaceClass(!0);if(t){if(this._iBehavior=new t,!(this._iBehavior instanceof TI))throw new TypeError("behavior class must derive from IBehavior")}else this._iBehavior=new TI;SI.AddonManager._PopInitObject(e)}GetIBehavior(){return this._iBehavior}}}{const xI=self.C3;xI.SDKBehaviorTypeBase=class extends xI.DefendedBase{constructor(e){super(),this._runtime=e.GetRuntime(),this._behaviorType=e,this._objectClass=e.GetObjectClass(),this._behavior=e.GetBehavior(),this._behavior._AddObjectClass(this._objectClass)}Release(){this._runtime=null,this._behaviorType=null,this._objectClass=null,this._behavior=null}OnCreate(){}GetBehaviorType(){return this._behaviorType}GetObjectClass(){return this._objectClass}GetRuntime(){return this._runtime}GetBehavior(){return this._behavior}}}{const bI=self.C3;bI.SDKBehaviorInstanceBase=class extends bI.DefendedBase{constructor(e,t){super(),this._behInst=e,this._domComponentId=t,this._inst=e.GetObjectInstance(),this._runtime=e.GetRuntime(),this._behaviorType=e.GetBehaviorType(),this._sdkType=this._behaviorType.GetSdkType(),this._isTicking=!1,this._isTicking2=!1,this._isPostTicking=!1,this._disposables=null}Release(){this._StopTicking(),this._StopTicking2(),this._StopPostTicking(),this._disposables&&(this._disposables.Release(),this._disposables=null),this._behInst=null,this._inst=null,this._runtime=null,this._behaviorType=null,this._sdkType=null}GetBehavior(){return this._behaviorType.GetBehavior()}GetBehaviorInstance(){return this._behInst}GetObjectInstance(){return this._inst}GetObjectClass(){return this._inst.GetObjectClass()}GetWorldInfo(){return this._inst.GetWorldInfo()}GetRuntime(){return this._runtime}GetBehaviorType(){return this._behaviorType}GetSdkType(){return this._sdkType}GetScriptInterface(){return this._behInst.GetScriptInterface()}Trigger(e){return this._runtime.Trigger(e,this._inst,this._behaviorType)}DebugTrigger(e){return this._runtime.DebugTrigger(e,this._inst,this._behaviorType)}TriggerAsync(e){return this._runtime.TriggerAsync(e,this._inst,this._behaviorType)}PostCreate(){}Tick(){}Tick2(){}PostTick(){}_StartTicking(){this._isTicking||(this._runtime._AddBehInstToTick(this),this._isTicking=!0)}_StopTicking(){this._isTicking&&(this._runtime._RemoveBehInstToTick(this),this._isTicking=!1)}IsTicking(){return this._isTicking}_StartTicking2(){this._isTicking2||(this._runtime._AddBehInstToTick2(this),this._isTicking2=!0)}_StopTicking2(){this._isTicking2&&(this._runtime._RemoveBehInstToTick2(this),this._isTicking2=!1)}IsTicking2(){return this._isTicking2}_StartPostTicking(){this._isPostTicking||(this._runtime._AddBehInstToPostTick(this),this._isPostTicking=!0)}_StopPostTicking(){this._isPostTicking&&(this._runtime._RemoveBehInstToPostTick(this),this._isPostTicking=!1)}IsPostTicking(){return this._isPostTicking}GetDebuggerProperties(){return[]}AddDOMMessageHandler(e,t){this._runtime.AddDOMComponentMessageHandler(this._domComponentId,e,t)}OnSpriteFrameChanged(e,t){}SaveToJson(){return null}LoadFromJson(e){}GetPropertyValueByIndex(e){}SetPropertyValueByIndex(e,t){}OffsetPropertyValueByIndex(e,t){if(0===t)return;const s=this.GetPropertyValueByIndex(e);if("number"!=typeof s)throw new Error("expected number");this.SetPropertyValueByIndex(e,s+t)}SetPropertyColorOffsetValueByIndex(e,t,s,i){}CallAction(e,...t){e.call(this,...t)}CallExpression(e,...t){return e.call(this,...t)}GetScriptInterfaceClass(){return null}DispatchScriptEvent(e,t,s){if(!this._behInst.HasScriptInterface())return;const i=this.GetScriptInterface(),r=bI.New(bI.Event,e,t);r.behaviorInstance=i,r.instance=i.instance,s&&Object.assign(r,s),i.dispatchEvent(r)}}}{let GI=function(e){if(e!==vI)throw new Error("invalid internal API token")};ValidateInternalAPIToken=GI;const II=self.C3;II.Plugins={},II.Behaviors={};const vI=II._GetInternalAPIToken();let CI=[],wI=[],AI=[],RI=null,PI=null,MI=null,EI=null;const DI=new Map,NI=new Map;II.AddonManager=class extends II.DefendedBase{constructor(e,t){super(),this._runtime=e,this._allPlugins=[],this._systemPlugin=null,this._allBehaviors=[],this._delayCreateBehaviors=new Map,this._solidBehavior=null,this._jumpthruBehavior=null,this._wrapperComponentIds=new Set(t)}CreatePlugin(e){const t=e[19],s=this._runtime.GetObjectReference(e[0]);if(!s)throw new Error("missing plugin");II.AddCommonACEs(e,s,t);const i=t>=2?II.SDKPluginBase:s,r=II.New(i,{runtime:this._runtime,isSingleGlobal:e[1],isWorld:e[2],isRotatable:e[5],hasEffects:e[8],mustPredraw:e[9],supportsSceneGraph:e[13],supportsMesh:e[14],isHTMLElementType:e[17],is3d:e[18],sdkVersion:t,id:e[20],name:e[21],scriptInterfaceClass:t>=2?s:null});r.OnCreate(),this._allPlugins.push(r),DI.set(s,r)}CreateSystemPlugin(){this._systemPlugin=II.New(II.Plugins.System,{runtime:this._runtime,isSingleGlobal:!0}),this._systemPlugin.OnCreate()}CreateBehavior(e){const t=e[1],s=e[2],i=e[3],r=this._runtime.GetObjectReference(e[0]);if(!r)throw new Error("missing behavior");this._delayCreateBehaviors.set(r,()=>{const e=t>=2?II.SDKBehaviorBase:r,n=II.New(e,{runtime:this._runtime,id:s,name:i,sdkVersion:t,scriptInterfaceClass:t>=2?r:null});n.OnCreate(),this._allBehaviors.push(n),NI.set(r,n),!this._solidBehavior&&II.Behaviors.solid&&n instanceof II.Behaviors.solid?this._solidBehavior=n:!this._jumpthruBehavior&&II.Behaviors.jumpthru&&n instanceof II.Behaviors.jumpthru&&(this._jumpthruBehavior=n),n._InitScriptInterface()})}_DelayCreateBehavior(e){const t=this._delayCreateBehaviors.get(e);t&&(t(),this._delayCreateBehaviors.delete(e))}static _PushInitObject(e,t=1){if(II.AddonManager._PushInitObject!==RI)throw new Error("invalid method");1===t&&CI.push(e),wI.push(e)}static _PopInitObject(e=1){if(II.AddonManager._PopInitObject!==PI)throw new Error("invalid method");1===e&&CI.pop(),wI.pop()}static _GetInitObject(){if(II.AddonManager._GetInitObject!==MI)throw new Error("invalid method");if(0===CI.length)throw new Error("no init object set");return CI.at(-1)}static _GetInitObject2(e){if(II.AddonManager._GetInitObject2!==EI)throw new Error("invalid method");if(GI(e),0===wI.length)throw new Error("no init object set");return wI.at(-1)}static _PushInitProperties(e){AI.push(e)}static _PopInitProperties(){AI.pop()}static _GetInitProperties(){if(0===AI.length)throw new Error("no init properties set");return AI.at(-1)}_InitAddonScriptInterfaces(){for(const e of this._allPlugins)e._InitScriptInterface()}static GetPluginByConstructorFunction(e){return DI.get(e)||null}static GetBehaviorByConstructorFunction(e){return NI.get(e)||null}GetSystemPlugin(){return this._systemPlugin}GetSolidBehavior(){return this._solidBehavior}GetJumpthruBehavior(){return this._jumpthruBehavior}HasWrapperComponentId(e){return this._wrapperComponentIds.has(e)}},RI=II.AddonManager._PushInitObject,PI=II.AddonManager._PopInitObject,MI=II.AddonManager._GetInitObject,EI=II.AddonManager._GetInitObject2}{const FI=self.C3,OI=new Set;FI.ImageInfo=class extends FI.DefendedBase{constructor(){super(),this._generation=0,this._url="",this._size=0,this._offsetX=0,this._offsetY=0,this._width=0,this._height=0,this._isRotated=!1,this._hasMetaData=!1,this._imageAsset=null,this._textureState="",this._rcTex=FI.New(FI.Rect),this._quadTex=FI.New(FI.Quad),this._blobUrl="",this._iImageInfo=new self.IImageInfo(this),OI.add(this)}Release(){this.ReleaseTexture(),this._imageAsset&&0===this._imageAsset.GetRefCount()&&this._imageAsset.Release(),this._imageAsset=null,OI.delete(this),this.ReleaseBlobURL()}static OnRendererContextLost(){for(const e of OI)e._textureState="",e._rcTex.set(0,0,0,0),e._quadTex.setFromRect(e._rcTex)}LoadData(e){this._url=e[0],this._size=e[1],this._offsetX=e[2],this._offsetY=e[3],this._width=e[4],this._height=e[5],this._isRotated=e[6],this._hasMetaData=!0}LoadDynamicAsset(e,t,s){if(s=!!s,this._imageAsset)throw new Error("already loaded asset");this._url=t;const i={isTiled:s};return FI.IsAbsoluteURL(t)&&(i.loadPolicy="remote"),this.LoadAsset(e,i),this._imageAsset.Load()}LoadDynamicBlobAsset(e,t){if(this._imageAsset)throw new Error("already loaded asset");this._url="",this._size=t.size,this._imageAsset=FI.New(FI.ImageAsset,e.GetAssetManager(),{blob:t,size:this._size,loadPolicy:"local"})}ReplaceWith(e){if(e===this)throw new Error("cannot replace with self");this._generation++,this.ReleaseTexture(),this._url=e._url,this._size=e._size,this._offsetX=e._offsetX,this._offsetY=e._offsetY,this._width=e._width,this._height=e._height,this._isRotated=e._isRotated,this._hasMetaData=e._hasMetaData,this._imageAsset=e._imageAsset,this._textureState=e._textureState,this._rcTex=e._rcTex,this._quadTex=e._quadTex,this.ReleaseBlobURL()}GetURL(){return this._url}GetSize(){return this._size}GetOffsetX(){return this._offsetX}GetOffsetY(){return this._offsetY}IsRotated(){return this._isRotated}GetWidth(){return this._width}GetHeight(){return this._height}GetSheetWidth(){return this._imageAsset.GetWidth()}GetSheetHeight(){return this._imageAsset.GetHeight()}LoadAsset(e,t){if(this._imageAsset)throw new Error("already got asset");t=Object.assign({},t,{url:this.GetURL(),size:this.GetSize()}),this._imageAsset=e.LoadImage(t)}IsLoaded(){return this._imageAsset&&this._imageAsset.IsLoaded()}async LoadStaticTexture(e,t){if(!this._imageAsset)throw new Error("no asset");if(this._textureState)throw new Error("already loaded texture");const s=this._generation;this._textureState="loading";const i=await this._imageAsset.LoadStaticTexture(e,t);if(this._generation!==s)return null;if(!i)return this._textureState="",null;this._textureState="loaded",this._hasMetaData||(this._width=i.GetWidth(),this._height=i.GetHeight(),this._hasMetaData=!0);const r=this._isRotated?this._height:this._width,n=this._isRotated?this._width:this._height;return this._rcTex.set(this._offsetX,this._offsetY,this._offsetX+r,this._offsetY+n),this._rcTex.divide(i.GetWidth(),i.GetHeight()),this._quadTex.setFromRect(this._rcTex),this._isRotated&&this._quadTex.rotatePointsAnticlockwise(),i}ReleaseTexture(){this._textureState&&(this._imageAsset&&this._imageAsset.ReleaseTexture(),this._textureState="",this._rcTex.set(0,0,0,0),this._quadTex.setFromRect(this._rcTex))}GetTexture(){return this._imageAsset&&"loaded"===this._textureState?this._imageAsset.GetTexture():null}GetTexRect(){return this._rcTex}GetTexQuad(){return this._quadTex}GetIImageInfo(){return this._iImageInfo}GetImageAsset(){return this._imageAsset}async ExtractImageToCanvas(e){e||(e=await this._imageAsset.LoadToDrawable());const t=FI.CreateCanvas(this._width,this._height),s=t.getContext("2d");return this._isRotated?(s.rotate(Math.PI/-2),s.translate(-this._height,0),s.drawImage(e,this._offsetX,this._offsetY,this._height,this._width,0,0,this._height,this._width)):s.drawImage(e,this._offsetX,this._offsetY,this._width,this._height,0,0,this._width,this._height),t}async ExtractImageToBlobURL(e){if(this._blobUrl)return this._blobUrl;const t=await this.ExtractImageToCanvas(e),s=await FI.CanvasToBlob(t);return this._blobUrl=URL.createObjectURL(s),this._blobUrl}ReleaseBlobURL(){this._blobUrl&&(URL.revokeObjectURL(this._blobUrl),this._blobUrl="")}}}{const BI=self.C3;BI.AnimationInfo=class extends BI.DefendedBase{constructor(e){super(),this._name=e[0],this._speed=e[1],this._isLooping=!!e[2],this._repeatCount=e[3],this._repeatTo=e[4],this._isPingPong=!!e[5],this._sid=e[6],this._frames=e[7].map(e=>BI.New(BI.AnimationFrameInfo,e)),this._iAnimation=new self.IAnimation(this)}static CreateDynamic(e,t){const s=BI.New(BI.AnimationInfo,[t,0,!1,0,0,!1,Math.floor(1e15*Math.random()),[]]);return s._frames.push(BI.AnimationFrameInfo.CreateDynamic(e)),s}Release(){for(const e of this._frames)e.Release();BI.clearArray(this._frames)}LoadAllAssets(e){for(const t of this._frames)t.GetImageInfo().LoadAsset(e)}LoadAllTextures(e,t){return Promise.all(this._frames.map(s=>s.GetImageInfo().LoadStaticTexture(e,t)))}ReleaseAllTextures(){for(const e of this._frames)e.GetImageInfo().ReleaseTexture()}GetName(){return this._name}GetSID(){return this._sid}GetFrameCount(){return this._frames.length}GetFrames(){return this._frames}GetFrameAt(e){if((e=Math.floor(e))<0||e>=this._frames.length)throw new RangeError("invalid frame");return this._frames[e]}InsertFrameAt(e,t){(t=Math.floor(t))<0?this._frames.unshift(e):t>=this._frames.length?this._frames.push(e):this._frames.splice(t,0,e)}RemoveFrameAt(e){if((e=Math.floor(e))<0||e>=this._frames.length)throw new RangeError("invalid frame");this._frames[e].Release(),this._frames.splice(e,1)}GetFrameIndexByTag(e){for(let t=0,s=this._frames.length;t<s;++t)if(BI.equalsNoCase(this._frames[t].GetTag(),e))return t;return-1}FrameTagOrIndexToIndex(e){if("string"==typeof e){const t=this.GetFrameIndexByTag(e);if(-1===t)throw new Error(`cannot find animation frame with tag ${e}`);return t}return e}GetSpeed(){return this._speed}IsLooping(){return this._isLooping}GetRepeatCount(){return this._repeatCount}GetRepeatTo(){return this._repeatTo}IsPingPong(){return this._isPingPong}GetIAnimation(){return this._iAnimation}}}{const LI=self.C3,kI=(()=>{const e=atob("iVBORw0KGgoAAAANSUhEUgAAAGQAAABkAQMAAABKLAcXAAAAAXNSR0IArs4c6QAAAANQTFRFAAAAp3o92gAAAAF0Uk5TAEDm2GYAAAATSURBVBgZYxgFo2AUjIJRQFcAAAV4AAHcRQIbAAAAAElFTkSuQmCC"),t=new Uint8Array(e.length);for(let s=0,i=e.length;s<i;++s)t[s]=e.charCodeAt(s);return new Blob([t],{type:"image/png"})})();LI.AnimationFrameInfo=class extends LI.DefendedBase{constructor(e){super(),this._imageInfo=LI.New(LI.ImageInfo),this._imageInfo.LoadData(e),this._duration=e[7],this._origin=LI.New(LI.Vector2,e[8],e[9]),this._imagePoints=e[10].map(e=>LI.New(LI.ImagePoint,this,e)),this._imagePointsByName=new Map;for(const e of this._imagePoints)this._imagePointsByName.set(e.GetName().toLowerCase(),e);this._collisionPoly=null;const t=e[11];t.length>=6&&(this._collisionPoly=LI.New(LI.CollisionPoly,t)),this._tag=e[12]?e[12]:"",this._iAnimationFrame=new self.IAnimationFrame(this)}static CreateDynamic(e){const t=LI.New(LI.AnimationFrameInfo,["",0,0,0,100,100,!1,1,0,0,[],[],""]);return t._imageInfo.LoadDynamicBlobAsset(e,kI),t}Release(){this._collisionPoly&&(this._collisionPoly.Release(),this._collisionPoly=null),this._imageInfo.Release(),this._imageInfo=null}GetImageInfo(){return this._imageInfo}GetDuration(){return this._duration}GetOriginX(){return this._origin.getX()}GetOriginY(){return this._origin.getY()}GetCollisionPoly(){return this._collisionPoly}GetImagePointByName(e){return this._imagePointsByName.get(e.toLowerCase())||null}GetImagePointByIndex(e){return(e=Math.floor(e))<0||e>=this._imagePoints.length?null:this._imagePoints[e]}GetImagePointCount(){return this._imagePoints.length}GetTag(){return this._tag}GetIAnimationFrame(){return this._iAnimationFrame}}}{const VI=self.C3;VI.ImagePoint=class extends VI.DefendedBase{constructor(e,t){super(),this._afi=e,this._name=t[0],this._pos=VI.New(VI.Vector2,t[1],t[2])}Release(){}GetName(){return this._name}GetX(){return this._pos.getX()}GetY(){return this._pos.getY()}GetVec2(){return this._pos}}}{const UI=globalThis.C3,WI=globalThis.C3Debugger,HI=globalThis.IObjectClass,zI=globalThis.IObjectType,jI=globalThis.IFamily,YI=globalThis.assert;UI.ObjectClass=class extends UI.DefendedBase{constructor(e,t,s){super();const i=e.GetObjectReference(s[1]);this._runtime=e,this._plugin=UI.AddonManager.GetPluginByConstructorFunction(i),this._sdkType=null,this._instSdkCtor=i.Instance,this._index=t,this._sid=s[11],this._name=s[0],this._jsPropName=this._runtime.GetJsPropName(s[14]),this._isGlobal=!!s[9],this._isFamily=!!s[2],this._isOnLoaderLayout=!!s[10],this._instVars=s[3].map(t=>({sid:t[0],type:t[1],name:t[2],jsPropName:e.GetJsPropName(t[3])})),this._behaviorsCount=s[4],this._effectsCount=s[5],this._isWorldType=this._plugin.IsWorldType(),this._dispatcher=UI.New(UI.Event.Dispatcher),this._effectList=null;const[r,n]=e.GetCollisionEngine().GetCollisionCellSize();if(this._collisionGrid=UI.New(UI.SparseGrid,r,n),this._anyCollisionCellChanged=!0,this._familyMembers=null,this._familyMembersSet=null,this._familyIndex=-1,this._families=null,this._familiesSet=null,this._familyInstVarMap=null,this._familyBehaviorMap=null,this._familyEffectMap=null,this._isInContainer=!1,this._container=null,this._behaviorTypes=s[8].map(e=>UI.BehaviorType.Create(this,e)),this._behaviorTypesIncludingInherited=[],this._behaviorsByName=new Map,this._behaviorNameToIndex=new Map,this._usedBehaviorCtors=new Set,this._customActionMap=new Map,this._solStack=UI.New(UI.SolStack,this),this._defaultInstanceData=null,this._defaultLayerIndex=0,this._isContained=!1,this._container=null,this._imageInfo=null,this._animations=null,this._animationsByName=null,this._animationsBySid=null,this._textureRefCount=0,this._savedData=new Map,this._unsavedData=new Map,this._instances=[],this._worldInfosByLayer=new Map,this._iidsStale=!0,this._plugin.HasEffects()&&(this._effectList=UI.New(UI.EffectList,this,s[12])),s[6]&&(this._imageInfo=UI.New(UI.ImageInfo),this._imageInfo.LoadData(s[6])),s[7]){this._animations=s[7].map(e=>UI.New(UI.AnimationInfo,e)),this._animationsByName=new Map,this._animationsBySid=new Map;for(const e of this._animations)this._animationsByName.set(e.GetName().toLowerCase(),e),this._animationsBySid.set(e.GetSID(),e)}this._isFamily?(this._familyMembers=[],this._familyMembersSet=new Set,this._familyIndex=this._runtime._GetNextFamilyIndex()):(this._families=[],this._familiesSet=new Set,this._familyInstVarMap=[],this._familyBehaviorMap=[],this._familyEffectMap=[]);const a=this._plugin.GetSdkVersion();if(a<2&&(this._sdkType=UI.New(i.Type,this,s[15]),!(this._sdkType instanceof UI.SDKTypeBase)))throw new Error("v1 sdk type must derive from SDKTypeBase");let o;if(this._iObjectClass=null,this._instanceUserScriptClass=null,this._userScriptDispatcher=UI.New(UI.Event.Dispatcher),UI.AddonManager._PushInitObject(this,a),a>=2?(o=i.Type,o||(o=globalThis.ISDKObjectTypeBase)):o=this._sdkType.GetScriptInterfaceClass(),o&&!this._isFamily){if(this._iObjectClass=new o(a<2?this:null),a<2&&!(this._iObjectClass instanceof zI))throw new TypeError("script interface class must derive from IObjectType");if(a>=2&&!(this._iObjectClass instanceof globalThis.ISDKObjectTypeBase))throw new TypeError("script interface class must derive from ISDKObjectTypeBase")}else{const e=this._isFamily?jI:zI;this._iObjectClass=new e}if(UI.AddonManager._PopInitObject(a),s[13]){const e=s[13];if(e){const t=e[0],s=e[1],i=e[2];this._sdkType.LoadTilemapData(t,s,i)}}this._runtime.UsesLoaderLayout()&&!this._isFamily&&!this._isOnLoaderLayout&&this._isWorldType||this.OnCreate(),this._plugin.IsSingleGlobal()&&(this._plugin._SetSingleGlobalObjectClass(this),this._CreateSingleGlobalInstance(s)),this._loadInstancesJson=null}static Create(e,t,s){return UI.New(UI.ObjectClass,e,t,s)}Release(){if(this._dispatcher.Release(),this._dispatcher=null,this._imageInfo&&(this._imageInfo.Release(),this._imageInfo=null),this._animations){for(const e of this._animations)e.Release();UI.clearArray(this._animations),this._animationsByName.clear(),this._animationsBySid.clear()}this._loadInstancesJson=null,this._solStack.Release(),this._solStack=null,this._savedData.clear(),this._unsavedData.clear(),this._container=null,this._runtime=null}_LoadFamily(e){for(let t=1,s=e.length;t<s;++t){const s=this._runtime.GetObjectClassByIndex(e[t]);this._familyMembers.push(s),this._familyMembersSet.add(s),s._families.push(this),s._familiesSet.add(this)}}_SetContainer(e){this._isInContainer=!0,this._container=e}IsInContainer(){return this._isInContainer}GetContainer(){return this._container}_OnAfterCreate(){let e=0;if(!this._isFamily)for(const t of this._families)for(const s of t.GetBehaviorTypes()){const t=s.GetName().toLowerCase();this._behaviorsByName.set(t,s),this._behaviorNameToIndex.set(t,e),this._behaviorTypesIncludingInherited.push(s),++e}for(const t of this.GetBehaviorTypes()){const s=t.GetName().toLowerCase();this._behaviorsByName.set(s,t),this._behaviorNameToIndex.set(s,e),this._behaviorTypesIncludingInherited.push(t),++e}for(const e of this._behaviorTypesIncludingInherited)this._usedBehaviorCtors.add(e.GetBehavior().constructor);if(!this._isFamily&&this._families.length){const e=this._runtime.GetFamilyCount();UI.extendArray(this._familyInstVarMap,e,0),UI.extendArray(this._familyBehaviorMap,e,0),UI.extendArray(this._familyEffectMap,e,0);const t=[];let s=0,i=0,r=0;for(const e of this._families){const n=e.GetFamilyIndex();this._familyInstVarMap[n]=s,s+=e.GetInstanceVariablesCount(),this._familyBehaviorMap[n]=i,i+=e.GetBehaviorTypesCount(),this._familyEffectMap[n]=r,r+=e.GetEffectTypesCount();const a=e.GetEffectList();if(a&&this._effectList)for(const e of a.GetAllEffectTypes())t.push(e.Clone(this._effectList))}this._effectList&&this._effectList.PrependEffectTypes(t)}}_CreateSingleGlobalInstance(e){const t=UI.IsFiniteNumber(e[17])?e[17]:this._runtime._GetNewUID(),s=UI.New(UI.Instance,{runtime:this._runtime,objectType:this,uid:t});s._CreateSdkInstance(e[16],[]),this._runtime._MapInstanceByUID(t,s),this._instances.push(s)}GetSdkType(){return this._sdkType}IsOnLoaderLayout(){return this._isOnLoaderLayout}Dispatcher(){return this._dispatcher}OnCreate(){this._isFamily||(this._sdkType?this._sdkType.OnCreate():this._iObjectClass._onCreate())}HasLoadedTextures(){return this._textureRefCount>0}async LoadTextures(e){this._isFamily||(this._textureRefCount++,1===this._textureRefCount&&(this._sdkType?await this._sdkType.LoadTextures(e):await this._iObjectClass._loadTextures(this._runtime.GetCanvasManager().GetIRenderer())))}ReleaseTextures(){if(!this._isFamily){if(this._textureRefCount--,this._textureRefCount<0)throw new Error("released textures too many times");0===this._textureRefCount&&(this._sdkType?this._sdkType.ReleaseTextures():this._iObjectClass._releaseTextures(this._runtime.GetCanvasManager().GetIRenderer()))}}OnDynamicTextureLoadComplete(){if(this._isFamily)throw new Error("not applicable to family");this._sdkType?this._sdkType.OnDynamicTextureLoadComplete():this._iObjectClass._onDynamicTextureLoadComplete()}async PreloadTexturesWithInstances(e){this._isFamily||(this._sdkType?await this._sdkType.PreloadTexturesWithInstances(e):await this._iObjectClass._preloadTexturesWithInstances(this._runtime.GetCanvasManager().GetIRenderer()))}GetRuntime(){return this._runtime}GetPlugin(){return this._plugin}GetInstanceSdkCtor(){return this._instSdkCtor}GetName(){return this._name}GetJsPropName(){return this._jsPropName}GetIndex(){return this._index}GetSID(){return this._sid}IsFamily(){return this._isFamily}IsGlobal(){return this._isGlobal}IsWorldType(){return this._isWorldType}GetFamilyIndex(){return this._familyIndex}GetBehaviorTypes(){return this._behaviorTypes}GetBehaviorTypesCount(){return this._behaviorsCount}UsesBehaviorByCtor(e){return e&&this._usedBehaviorCtors.has(e)}GetInstanceVariablesCount(){return this._instVars.length}GetInstanceVariableSIDs(){return this._instVars.map(e=>e.sid)}GetInstanceVariableIndexBySID(e){return this._instVars.findIndex(t=>t.sid===e)}GetInstanceVariableIndexByName(e){return this._instVars.findIndex(t=>t.name===e)}_GetAllInstanceVariableNames(){return this._instVars.map(e=>e.name)}_GetAllInstanceVariableJsPropNames(){return this._instVars.map(e=>e.jsPropName)}GetInstanceVariableType(e){if((e=Math.floor(e))<0||e>=this._instVars.length)throw new RangeError("invalid instance variable index");return this._instVars[e].type}GetInstanceVariableName(e){if((e=Math.floor(e))<0||e>=this._instVars.length)throw new RangeError("invalid instance variable index");return this._instVars[e].name}GetEffectTypesCount(){return this._effectsCount}GetBehaviorTypesIncludingInherited(){return this._behaviorTypesIncludingInherited}GetBehaviorTypeByName(e){return this._behaviorsByName.get(e.toLowerCase())||null}GetBehaviorIndexByName(e){const t=this._behaviorNameToIndex.get(e.toLowerCase());return void 0===t?-1:t}GetEffectList(){return this._effectList}HasEffects(){return this._plugin.HasEffects()}UsesEffects(){return this._effectList&&this._effectList.HasAnyEffectType()}GetSolStack(){return this._solStack}GetCurrentSol(){return this._solStack.GetCurrentSol()}GetImageInfo(){return this._imageInfo}SetDefaultInstanceData(e){this._defaultInstanceData=e}GetDefaultInstanceData(){return this._defaultInstanceData}_SetDefaultLayerIndex(e){this._defaultLayerIndex=e}GetDefaultLayerIndex(){return this._defaultLayerIndex}GetAnimations(){return this._animations}GetAnimationCount(){return this._animations.length}GetFamilies(){return this._families}BelongsToFamily(e){return this._familiesSet.has(e)}GetFamilyMembers(){return this._familyMembers}FamilyHasMember(e){return this._familyMembersSet.has(e)}GetFamilyBehaviorOffset(e){return this._familyBehaviorMap[e]}GetFamilyInstanceVariableOffset(e){return this._familyInstVarMap[e]}AddCustomAction(e){this._customActionMap.set(e.GetACEName().toLowerCase(),e)}HasOwnCustomActionByName(e){return!!this.GetOwnCustomActionByName(e)}GetOwnCustomActionByName(e){const t=this._customActionMap.get(e.toLowerCase());return t&&t.IsEnabled()?t:null}GetAllAnimations(){return this._animations}GetAnimationByName(e){if(!this._animations)throw new Error("no animations");return this._animationsByName.get(e.toLowerCase())||null}GetAnimationBySID(e){if(!this._animations)throw new Error("no animations");return this._animationsBySid.get(e)||null}AddAnimation(e){if(this.GetAnimationByName(e))throw new Error(`animation name '${e}' already exists`);const t=UI.AnimationInfo.CreateDynamic(this.GetRuntime(),e);return this._animations.push(t),this._animationsByName.set(t.GetName().toLowerCase(),t),this._animationsBySid.set(t.GetSID(),t),t}RemoveAnimation(e){const t=this.GetAnimationByName(e);if(!t)throw new Error(`animation name '${e}' does not exist`);if(1===this._animations.length)throw new Error("cannot remove last animation");const s=this._animations.indexOf(t);this._animations.splice(s,1),this._animationsByName.delete(t.GetName().toLowerCase()),this._animationsBySid.delete(t.GetSID()),t.Release()}GetFirstAnimation(){if(!this._animations)throw new Error("no animations");return this._animations[0]}GetFirstAnimationFrame(){return this.GetFirstAnimation().GetFrameAt(0)}GetDefaultInstanceSize(){if(this._animations){const e=this.GetFirstAnimationFrame().GetImageInfo();return[e.GetWidth(),e.GetHeight()]}return this._imageInfo?[this._imageInfo.GetWidth(),this._imageInfo.GetHeight()]:[100,100]}GetSingleGlobalInstance(){if(!this._plugin.IsSingleGlobal())throw new Error("not a single-global plugin");return this._instances[0]}GetInstances(){return this._instances}*instances(){yield*this._instances}*instancesIncludingPendingCreate(){yield*this._instances,yield*this._runtime.instancesPendingCreateForObjectClass(this)}GetInstanceCount(){return this._instances.length}_AddInstance(e){this._instances.push(e)}_SetIIDsStale(){this._iidsStale=!0}_UpdateIIDs(){if(!this._iidsStale||this._isFamily)return;const e=this._instances;let t=0;for(let s=e.length;t<s;++t)e[t]._SetIID(t);const s=this._runtime._GetInstancesPendingCreate();for(const e of s)e.GetObjectClass()===this&&e._SetIID(t++);this._iidsStale=!1}GetInstanceByIID(e){const t=this._instances;if(e<t.length)return t[e];e-=t.length;const s=this._runtime._GetInstancesPendingCreate();for(const t of s)if(t.GetObjectClass()===this){if(0===e)return t;--e}return null}GetFirstPicked(e){if(e&&e.IsInContainer()&&e.GetObjectClass()!==this)for(const t of e.siblings())if(t.GetObjectClass()===this)return t;const t=this.GetCurrentSol().GetInstances();return t.length?t[0]:null}GetPairedInstance(e){const t=this.GetCurrentSol().GetInstances();return t.length>0?t[e.GetIID()%t.length]:null}*allCorrespondingInstances(e,t){const s=this.GetCurrentSol().GetInstances(),i=s.length,r=t.GetCurrentSol(),n=t.GetCurrentSol().GetInstances(),a=n.length;let o=e.GetIID();!t.IsFamily()&&r.IsSelectAll()||(o=n.indexOf(e));const l=Math.ceil(i/a),h=i%a;let u=0,c=0;0===h||o<h?(u=o*l,c=l):(u=h*l+(o-h)*(l-1),c=l-1);for(let e=u,t=u+c;e<t;++e)yield s[e]}FinishCondition(e){this._sdkType?.FinishCondition(e)}ApplySolToContainer(){if(!this._isInContainer||this._isFamily)return;this._UpdateIIDs();const e=this.GetCurrentSol(),t=e._GetOwnInstances(),s=e.IsSelectAll(),i=this._runtime.GetCurrentEventStackFrame(),r=i&&i.GetCurrentEvent()&&i.GetCurrentEvent().IsOrBlock();for(const i of this._container.objectTypes()){if(i===this)continue;i._UpdateIIDs();const n=i.GetCurrentSol();if(n._SetSelectAll(s),!s){const s=n._GetOwnInstances();UI.clearArray(s);for(const e of t)s.push(i.GetInstanceByIID(e.GetIID()));if(r){const t=e._GetOwnElseInstances(),s=n._GetOwnElseInstances();UI.clearArray(s);for(const e of t)s.push(i.GetInstanceByIID(e.GetIID()))}}}}_TruncateContainerSols(e,t){for(const s of this.GetContainer().objectTypes()){const i=s.GetCurrentSol();e?UI.truncateArray(i._GetOwnElseInstances(),t):UI.truncateArray(i._GetOwnInstances(),t)}}_GetCollisionCellGrid(){return this._collisionGrid}_SetAnyCollisionCellChanged(e){this._anyCollisionCellChanged=!!e}_UpdateAllCollisionCells(){if(this._anyCollisionCellChanged&&this._isWorldType){for(const e of this._instances)e.GetWorldInfo()._UpdateCollisionCell();for(const e of this._runtime._GetInstancesPendingCreate())e.GetObjectClass()===this&&e.GetWorldInfo()._UpdateCollisionCell();this._anyCollisionCellChanged=!1}}_OnWorldInstanceLayerChanged(e,t,s){if(t){const s=this._worldInfosByLayer.get(t);s&&(s.delete(e),0===s.size&&this._worldInfosByLayer.delete(t))}if(s){let t=this._worldInfosByLayer.get(s);t||(t=new Set,this._worldInfosByLayer.set(s,t)),t.add(e)}}*layersHasInstancesOn(){if(this.IsFamily()){const e=new Set;for(const t of this._familyMembers)for(const s of t.layersHasInstancesOn())e.add(s);yield*e.values()}else for(const e of this._worldInfosByLayer.keys())e.WasReleased()||(yield e)}GetSavedDataMap(){return this._savedData||(this._savedData=new Map),this._savedData}GetUnsavedDataMap(){return this._unsavedData||(this._unsavedData=new Map),this._unsavedData}HasSolidBehavior(){return this.UsesBehaviorByCtor(UI.Behaviors.solid)}HasJumpthruBehavior(){return this.UsesBehaviorByCtor(UI.Behaviors.jumpthru)}HasNoSaveBehavior(){return this.UsesBehaviorByCtor(UI.Behaviors.NoSave)}HasPersistBehavior(){return this.UsesBehaviorByCtor(UI.Behaviors.Persist)}_SaveToJson(){const e={instances:this._instances.map(e=>e.SaveToJson())};return this._savedData&&this._savedData.size&&(e.ex=UI.ToSuperJSON(this._savedData)),e}_LoadFromJson(e,t){this._savedData&&(this._savedData.clear(),this._savedData=null);const s=e.ex;s&&(this._savedData=UI.FromSuperJSON(s));const i=this._instances,r=e.instances;for(let e=0,t=Math.min(i.length,r.length);e<t;++e)i[e].LoadFromJson(r[e]);for(let e=r.length,t=i.length;e<t;++e)this._runtime.DestroyInstance(i[e]);for(let e=i.length,s=r.length;e<s;++e){const s=r[e];let i=null;if(this.IsWorldType()&&(i=this._runtime.GetMainRunningLayout().GetLayerBySID(s.w.l),!i))continue;const n=this._runtime.CreateInstanceFromData(this._defaultInstanceData||this,i,!1,0,0,!0);n.LoadFromJson(s),t&&t.add(n)}this._loadInstancesJson=r,this._SetIIDsStale()}_GetLoadInstancesJson(){return this._loadInstancesJson}_ClearLoadInstancesJson(){this._loadInstancesJson=null}_SetupSceneGraphConnectionsOnChangeOfLayout(){for(let e=0,t=this._instances;e<t;++e)this._instances[e]._SetupSceneGraphConnectionsOnChangeOfLayout()}GetIObjectClass(){return this._iObjectClass}UserScriptDispatcher(){return this._userScriptDispatcher}_GetUserScriptInstanceClass(){return this._instanceUserScriptClass}_SetUserScriptInstanceClass(e){this._instanceUserScriptClass=e}DispatchUserScriptEvent(e){const t=this._runtime,s=t.IsDebug()&&!t.GetEventSheetManager().IsInEventEngine();s&&WI.StartMeasuringScriptTime(),this._userScriptDispatcher.dispatchEvent(e),s&&WI.AddScriptTime()}}}{const qI=self.C3;qI.Container=class extends qI.DefendedBase{constructor(e,t){super(),this._runtime=e,this._objectTypes=t;for(const e of this._objectTypes)e._SetContainer(this)}Release(){this._runtime=null}GetRuntime(){return this._runtime}GetObjectTypes(){return this._objectTypes}objectTypes(){return this._objectTypes}HasAnyWorldType(){return this._objectTypes.some(e=>e.IsWorldType())}}}{const XI=self.C3,$I=self.C3Debugger,KI=self.IInstance,JI=XI.AddonManager,QI=[];let ZI=0;const ev=new WeakMap,tv=new WeakMap,sv=1,iv=2,rv=4,nv=8,av=16,ov=32,lv=64;XI.Instance=class extends XI.DefendedBase{constructor(e){if(XI.AddonManager!==JI)throw new Error("invalid addon manager");super(),this._runtime=e.runtime,this._objectType=e.objectType,this._worldInfo=null,this._sdkInst=null,this._iScriptInterface=null,this._iid=0,this._uid=e.uid,this._puid=ZI++,this._flags=0,this._tagsSet=null;const t=XI.splitStringAndNormalize(e.tags);t.length>0&&(this._tagsSet=new Set(t)),this._instVarValues=QI,this._behaviorInstances=QI;const s=this._objectType.GetBehaviorTypesIncludingInherited();s.length>0&&(this._behaviorInstances=s.map((e,t)=>XI.New(XI.BehaviorInstance,{runtime:this._runtime,behaviorType:e,instance:this,index:t}))),this._siblings=this._objectType.IsInContainer()?[]:null,this._timeScale=-1,this._dispatcher=null;const i=this.GetPlugin();if(i.MustPreDraw()&&(this._flags|=4),i.IsWorldType())if(this._worldInfo=XI.New(XI.WorldInfo,this,e.layer),e.worldData)this._worldInfo.Init(e.worldData);else{this._worldInfo.InitNoData();const[e,t]=this._objectType.GetDefaultInstanceSize();this._worldInfo.SetSize(e,t),this.GetObjectClass().UsesEffects()&&this._worldInfo.GetInstanceEffectList().LoadDefaultEffectParameters()}e.instVarData?this._LoadInstanceVariableData(e.instVarData):this._LoadDefaultInstanceVariables()}Release(){if(this._iScriptInterface&&(this._iScriptInterface._release(),this._iScriptInterface=null),this._behaviorInstances.length>0){for(const e of this._behaviorInstances)e.Release();XI.clearArray(this._behaviorInstances)}this._sdkInst&&(this._sdkInst.Release(),this._sdkInst=null);const e=ev.get(this);e&&(e.clear(),ev.delete(this));const t=tv.get(this);t&&(t.clear(),tv.delete(this)),this._siblings&&XI.clearArray(this._siblings),this._dispatcher&&(this._dispatcher.Release(),this._dispatcher=null),this._tagsSet&&this._tagsSet.clear(),this._tagsSet=null,this._runtime=null,this._objectType=null,this._instVarValues.length>0&&XI.clearArray(this._instVarValues),this._worldInfo&&(this._worldInfo.Release(),this._worldInfo=null)}_LoadInstanceVariableData(e){e.length>0&&(this._instVarValues=[],XI.shallowAssignArray(this._instVarValues,e))}_LoadDefaultInstanceVariables(){const e=this._objectType.GetInstanceVariablesCount();if(0===e)return;this._instVarValues=[];const t=[0,0,""];for(let s=0;s<e;++s)this._instVarValues.push(t[this._objectType.GetInstanceVariableType(s)])}_CreateSdkInstance(e,t){if(this._sdkInst)throw new Error("already got sdk instance");for(let e=0,s=this._behaviorInstances.length;e<s;++e)this._behaviorInstances[e]._CreateSdkInstance(t?t[e]:null);if(this.GetPlugin().GetSdkVersion()<2){if(this._sdkInst=XI.New(this._objectType.GetInstanceSdkCtor(),this,e),!(this._sdkInst instanceof XI.SDKInstanceBase))throw new Error("sdk type must derive from SDKInstanceBase");!this.GetPlugin().IsWorldType()&&this._objectType._GetUserScriptInstanceClass()&&this.GetInterfaceClass()}else{const t=this.GetPlugin().GetScriptInterfaceClass();this._InitUserScriptInterface(t.Instance,e)}}GetSdkInstance(){return this._sdkInst??this._iScriptInterface}GetWorldInfo(){return this._worldInfo}GetRuntime(){return this._runtime}GetTimeScale(){return this._timeScale}GetActiveTimeScale(){const e=this._timeScale;return-1===e?this.GetRuntime().GetTimeScale():e}SetTimeScale(e){((e=+e)<0||!isFinite(e))&&(e=0),this._timeScale=e,this.GetObjectClass().UsesEffects()&&this._runtime._SetTrackingInstanceTime(this,!0)}RestoreTimeScale(){this._timeScale=-1,this.GetObjectClass().UsesEffects()&&this._runtime._SetTrackingInstanceTime(this,!1)}GetInstanceGameTime(){return this._runtime._GetInstanceGameTime(this)}Dispatcher(){return this._dispatcher||(this._dispatcher=XI.New(XI.Event.Dispatcher)),this._dispatcher}Draw(e){this._sdkInst?this._sdkInst.Draw(e):this._iScriptInterface._draw(this._runtime.GetCanvasManager().GetIRenderer())}OnCreate(e){this._sdkInst.OnCreate(e)}_SetHasTilemap(){this._flags|=2}HasTilemap(){return!!(2&this._flags)}_MarkDestroyed(){this._flags|=1}IsDestroyed(){return!!(1&this._flags)}MustPreDraw(){return!!(4&this._flags)||(this._sdkInst?this._sdkInst.MustPreDraw():this._iScriptInterface._mustPreDraw())}SetMustMitigateZFighting(){this._flags|=32}MustMitigateZFighting(){return!!(32&this._flags)}_IsSolidEnabled(){return!!(8&this._flags)}_SetSolidEnabled(e){e?this._flags|=8:this._flags&=-9}_IsJumpthruEnabled(){return!!(16&this._flags)}_SetJumpthruEnabled(e){e?this._flags|=16:this._flags&=-17}_IsDrawingWithEffects(){return!!(64&this._flags)}_SetIsDrawingWithEffects(e){e?this._flags|=64:this._flags&=-65}SetFlag(e,t){e<<=16,t?this._flags|=e:this._flags&=~e}GetFlag(e){return!!(this._flags&e<<16)}GetCurrentImageInfo(){return this._sdkInst?this._sdkInst.GetCurrentImageInfo():null}GetCurrentSurfaceSize(){return this._sdkInst?this._sdkInst.GetCurrentSurfaceSize():null}GetCurrentTexRect(){return this._sdkInst?this._sdkInst.GetCurrentTexRect():null}GetCurrentTexQuad(){return this._sdkInst?this._sdkInst.GetCurrentTexQuad():null}IsCurrentTexRotated(){return!!this._sdkInst&&this._sdkInst.IsCurrentTexRotated()}GetImagePoint(e){return this._sdkInst?this._sdkInst.GetImagePoint(e):[this._iScriptInterface.x,this._iScriptInterface.y,this._iScriptInterface.totalZElevation]}GetObjectClass(){return this._objectType}RendersToOwnZPlane(){return this._sdkInst?this._sdkInst.RendersToOwnZPlane():this._iScriptInterface._rendersToOwnZPlane()}BelongsToObjectClass(e){return e.IsFamily()?e.FamilyHasMember(this.GetObjectClass()):this.GetObjectClass()===e}CollectInstancesToPick(e,t,s){const i=(t,s)=>{const i=s||t.GetObjectClass(),r=e.get(i);r?r.add(t):e.set(i,new Set([t]))};if(i(this,t),this.IsInContainer())for(const e of this.siblings())i(e);if(s)for(const e of this.allChildren())i(e)}VerifySupportsSceneGraph(){if(!this.GetPlugin().SupportsSceneGraph())throw new Error("object does not support scene graph")}HasParent(){return null!==this.GetParent()}GetParent(){const e=this.GetWorldInfo();if(!e)return null;const t=e.GetParent();return t?t.GetInstance():null}GetTopParent(){const e=this.GetWorldInfo();if(!e)return null;const t=e.GetTopParent();return t?t.GetInstance():null}*parents(){const e=this.GetWorldInfo();if(e)for(const t of e.parents())yield t.GetInstance()}HasChild(e){if(!e)return!1;for(const t of this.children())if(t===e)return!0;return!1}HasChildren(){const e=this.GetWorldInfo();return!!e&&e.HasChildren()}GetChildrenOfObjectClass(e){const t=this.GetWorldInfo();if(!t)return[];const s=e.GetName();return t.GetChildren().map(e=>e.GetInstance()).filter(e=>e.GetObjectClass().GetName()===s)}GetChildren(){const e=this.GetWorldInfo();return e?e.GetChildren().map(e=>e.GetInstance()):[]}*children(){const e=this.GetWorldInfo();if(e)for(const t of e.children())yield t.GetInstance()}*allChildren(){const e=this.GetWorldInfo();if(e)for(const t of e.allChildren())yield t.GetInstance()}GetChildCount(){const e=this.GetWorldInfo();return e?e.GetChildCount():0}GetParentCount(){return[...this.parents()].length}GetAllChildCount(){const e=this.GetWorldInfo();return e?e.GetAllChildCount():0}GetChildAt(e){const t=this.GetWorldInfo();if(!t)return null;const s=t.GetChildAt(e);return s?s.GetInstance():null}GetIndexInParent(){const e=this.GetWorldInfo();if(!e)return NaN;const t=e.GetParent();return t?t.GetChildIndex(e):NaN}HasChildWithUID(e){for(const t of this.GetWorldInfo().GetChildren())if(t.GetInstance().GetUID()===e)return!0;return!1}AddChild(e,t){this.VerifySupportsSceneGraph(),e.VerifySupportsSceneGraph(),this.GetWorldInfo().AddChild(e.GetWorldInfo(),t||{})}RemoveChild(e){const t=this.GetWorldInfo();t&&t.RemoveChild(e.GetWorldInfo())}GetDestroyWithParent(){const e=this.GetWorldInfo();return!!e&&e.GetDestroyWithParent()}SetupInitialSceneGraphConnections(){const e=this.GetWorldInfo();if(!e)return;const t=e.GetSceneGraphChildrenExportData();if(t)for(const e of t){const t=this._runtime.GetInstanceByUID(e[2]);if(t){const s=e[3];this.AddChild(t,{transformX:!!(1&s),transformY:!!(s>>1&1),transformWidth:!!(s>>2&1),transformHeight:!!(s>>3&1),transformAngle:!!(s>>4&1),destroyWithParent:!!(s>>5&1),transformZElevation:!!(s>>6&1),transformOpacity:!!(s>>7&1),transformVisibility:!!(s>>8&1)})}}}SetupPersistedSceneGraphConnections(e,t){const s=e.get(this);if(s)for(const e of s.sceneGraphJson.children){const s=t.get(e.index);if(!s)continue;const i=e.flags;this.AddChild(s,{transformX:!!(1&i),transformY:!!(i>>1&1),transformWidth:!!(i>>2&1),transformHeight:!!(i>>3&1),transformAngle:!!(i>>4&1),destroyWithParent:!!(i>>5&1),transformZElevation:!!(i>>6&1),transformOpacity:!!(i>>7&1),transformVisibility:!!(i>>8&1)})}}GetTemplateName(){const e=this._runtime.GetTemplateManager();return e?e.GetInstanceTemplateName(this):""}IsInContainer(){return null!==this._siblings}_ClearSiblings(){XI.clearArray(this._siblings)}_AddSibling(e){this._siblings.push(e)}GetSiblings(){return this._siblings}HasSibling(e){return!!this.GetSibling(e)}GetSibling(e){const t=this.siblings();if(null===t||0===t.length)return!1;for(const s of t)if(s.GetObjectClass()===e)return s;return null}siblings(){return this._siblings}SetSiblingsSinglePicked(){for(const e of this.siblings())e.GetObjectClass().GetCurrentSol().SetSinglePicked(e)}_PushSiblingsToSolInstances(){for(const e of this.siblings())e.GetObjectClass().GetCurrentSol()._PushInstance(e)}_SetSiblingsToSolInstancesIndex(e){for(const t of this.siblings())t.GetObjectClass().GetCurrentSol()._GetOwnInstances()[e]=t}_PushSiblingsToSolElseInstances(){for(const e of this.siblings())e.GetObjectClass().GetCurrentSol()._PushElseInstance(e)}_SetSiblingsToSolElseInstancesIndex(e){for(const t of this.siblings())t.GetObjectClass().GetCurrentSol()._GetOwnElseInstances()[e]=t}GetPlugin(){return this._objectType.GetPlugin()}_SetIID(e){this._iid=e}GetIID(){return this._objectType._UpdateIIDs(),this._iid}GetUID(){return this._uid}SetUID(e){this._uid=e}GetPUID(){return this._puid}_SetTagsSetFromJson(e){e?this.SetTagsSet(new Set(e)):this._tagsSet=null}SetTagsSet(e){if(0===e.size)this._tagsSet=null;else{this._tagsSet?this._tagsSet.clear():this._tagsSet=new Set;for(const t of e)this._tagsSet.add(t)}}GetTagsSet(){return this._tagsSet??new Set}GetTagsString(){return Array.from(this.GetTagsSet()).join(" ")}GetTagAt(e){e=Math.floor(e);for(const t of this.GetTagsSet()){if(0===e)return t;--e}return""}GetBehaviorInstances(){return this._behaviorInstances}GetBehaviorInstanceFromCtor(e){if(!e)return null;for(const t of this._behaviorInstances)if(t.GetBehavior()instanceof e)return t;return null}GetBehaviorSdkInstanceFromCtor(e){if(!e)return null;const t=this.GetBehaviorInstanceFromCtor(e);return t?t.GetSdkInstance():null}GetBehaviorIndexBySID(e){const t=this._behaviorInstances;for(let s=0,i=t.length;s<i;++s)if(t[s].GetBehaviorType().GetSID()===e)return s;return-1}GetAllInstanceVariableValues(){return this._instVarValues}_GetAllInstanceVariableNames(){return this._objectType._GetAllInstanceVariableNames()}GetInstanceVariableCount(){return this._instVarValues.length}GetInstanceVariableValue(e){e|=0;const t=this._instVarValues;if(e<0||e>=t.length)throw new RangeError("invalid instance variable");return t[e]}_GetInstanceVariableValueUnchecked(e){return this._instVarValues[e]}_GetInstanceVariableTypedValue(e){const t=this._instVarValues[e];return 0===this._objectType.GetInstanceVariableType(e)?!!t:t}SetInstanceVariableValue(e,t){e|=0;const s=this._instVarValues;if(e<0||e>=s.length)throw new RangeError("invalid instance variable");switch(this._objectType.GetInstanceVariableType(e)){case 0:s[e]=t?1:0;break;case 1:s[e]="number"==typeof t?t:parseFloat(t);break;case 2:s[e]="string"==typeof t?t:t.toString();break;default:throw new Error("unknown instance variable type")}}SetInstanceVariableOffset(e,t){if(0===t)return;e|=0;const s=this._instVarValues;if(e<0||e>=s.length)throw new RangeError("invalid instance variable");const i=s[e];if("number"!=typeof i)throw"boolean"==typeof i?new Error("can not set offset of boolean variable"):"string"==typeof i?new Error("can not set offset of string variable"):new Error("unknown instance variable type");s[e]+="number"==typeof t?t:parseFloat(t)}GetSavedDataMap(){let e=ev.get(this);return e||(e=new Map,ev.set(this,e),e)}GetUnsavedDataMap(){let e=tv.get(this);return e||(e=new Map,tv.set(this,e),e)}_HasAnyCreateDestroyHandler(e){const t=this.GetObjectClass();if(t.UserScriptDispatcher().HasAnyHandlerFor(e))return!0;for(const s of t.GetFamilies())if(s.UserScriptDispatcher().HasAnyHandlerFor(e))return!0;return!!this._runtime.UserScriptDispatcher().HasAnyHandlerFor(e)}_TriggerOnCreatedOnSelfAndRelated(e=void 0){const t=e??new Set;if(t.has(this))return;t.add(this);const s=this.GetWorldInfo();if(s&&s.HasChildren())for(const e of this.allChildren())if(t.add(e),e.IsInContainer())for(const s of e.siblings())t.add(s);if(this.IsInContainer())for(const e of this.siblings())e._TriggerOnCreatedOnSelfAndRelated(t);if(!e){for(const e of t.values())e._TriggerOnCreated();this._OnHierarchyReady()}}_OnCreatedCommon(){this._objectType._GetUserScriptInstanceClass()&&this.GetInterfaceClass();for(const e of this._behaviorInstances)e.PostCreate()}_OnCreatedForLoadingSavegame(){this._OnCreatedCommon()}_TriggerOnCreated(){if(this._OnCreatedCommon(),this._HasAnyCreateDestroyHandler("instancecreate")){const e=this.GetObjectClass(),t=new XI.Event("instancecreate");t.instance=this.GetInterfaceClass(),e.DispatchUserScriptEvent(t);for(const s of e.GetFamilies())s.DispatchUserScriptEvent(t);this._runtime.DispatchUserScriptEvent(t)}this._runtime.Trigger(this.GetPlugin().GetConstructor().Cnds.OnCreated,this,null)}_OnHierarchyReady(){if(this.GetPlugin().SupportsSceneGraph()){if(this.DispatchUserScriptEvent(new XI.Event("hierarchyready")),this._HasAnyCreateDestroyHandler("hierarchyready")){const e=this.GetObjectClass(),t=new XI.Event("hierarchyready");t.instance=this.GetInterfaceClass(),e.DispatchUserScriptEvent(t);for(const s of e.GetFamilies())s.DispatchUserScriptEvent(t);this._runtime.DispatchUserScriptEvent(t)}this._runtime.Trigger(this.GetPlugin().GetConstructor().Cnds.OnHierarchyReady,this,null)}}_TriggerOnDestroyed(){this._runtime.Trigger(this.GetPlugin().GetConstructor().Cnds.OnDestroyed,this,null)}_FireDestroyedScriptEvents(e){if(this._iScriptInterface){const t=new XI.Event("destroy");t.isEndingLayout=e,this.DispatchUserScriptEvent(t)}if(!this._HasAnyCreateDestroyHandler("instancedestroy"))return;const t=this.GetObjectClass(),s=new XI.Event("instancedestroy");s.instance=this.GetInterfaceClass(),s.isEndingLayout=e,t.DispatchUserScriptEvent(s);for(const e of t.GetFamilies())e.DispatchUserScriptEvent(s);this._runtime.DispatchUserScriptEvent(s)}_GetDebuggerProperties(){return this._sdkInst?this._sdkInst.GetDebuggerProperties():this._iScriptInterface._getDebuggerProperties()}SaveToJson(e="full",t=null){const s={};"full"===e?s.uid=this.GetUID():s.c3=!0;const i=this.GetTagsSet();if(i.size>0&&(s.tags=Array.from(i)),"visual-state"!==e){const t=ev.get(this);if(t&&t.size&&(s.ex=XI.ToSuperJSON(t)),-1!==this.GetTimeScale()&&(s.mts=this.GetTimeScale()),this._objectType.GetInstanceVariablesCount()>0){const e={},t=this._objectType.GetInstanceVariableSIDs();for(let s=0,i=this._instVarValues.length;s<i;++s)e[t[s].toString()]=this._instVarValues[s];s.ivs=e}if(this._behaviorInstances.length){const t={};for(const s of this._behaviorInstances){const i=s.SaveToJson(e);i&&(t[s.GetBehaviorType().GetSID().toString()]=i)}s.behs=t}}this._worldInfo&&(s.w=this._worldInfo._SaveToJson(e,t));const r=this._sdkInst?this._sdkInst.SaveToJson():this._iScriptInterface._saveToJson();return r&&(s.data=r),s}_OnBeforeLoad(e="full",t=null){this._worldInfo&&this._worldInfo._OnBeforeLoad(e)}_OnAfterLoad(e,t="full",s=null){this._worldInfo&&this._worldInfo._OnAfterLoad(e,t,s)}_OnAfterLoad2(e,t="full",s=null){this._worldInfo&&this._worldInfo._OnAfterLoad2(e,t,s)}_SetupSceneGraphConnectionsOnChangeOfLayout(){this.GetPlugin().IsWorldType()&&this._worldInfo._SetupSceneGraphConnectionsOnChangeOfLayout()}LoadFromJson(e,t="full",s=null){if("full"===t)this._uid=e.uid;else if(!e.c3)return;if(this._SetTagsSetFromJson(e.tags),"visual-state"!==t){let t=ev.get(this);t&&(t.clear(),ev.delete(this));const s=e.ex;s&&(t=XI.FromSuperJSON(s),ev.set(this,t)),this._timeScale=e.hasOwnProperty("mts")?e.mts:-1;const i=e.ivs;if(i)for(const[e,t]of Object.entries(i)){const s=parseInt(e,10),i=this._objectType.GetInstanceVariableIndexBySID(s);if(i<0||i>=this._instVarValues.length)continue;let r=t;null===r&&(r=NaN),this._instVarValues[i]=r}}if(this.GetPlugin().IsWorldType()){const i=e.w;if(i){const e=i.l;if(this._worldInfo.GetLayer().GetSID()!==e){const s=this._worldInfo.GetLayer(),i=s.GetLayout().GetLayerBySID(e);i?(this._worldInfo._SetLayer(i),s._RemoveInstance(this,!0),i._AddInstance(this,!0),i.SetZIndicesChanged(this),this._worldInfo.SetBboxChanged()):"full"===t&&this._runtime.DestroyInstance(this)}this._worldInfo._LoadFromJson(i,t,s)}}if("visual-state"!==t){const s=e.behs;if(s)for(const[e,i]of Object.entries(s)){const s=parseInt(e,10),r=this.GetBehaviorIndexBySID(s);r<0||r>=this._behaviorInstances.length||this._behaviorInstances[r].LoadFromJson(i,t)}}const i=e.data;i&&(this._sdkInst?this._sdkInst.LoadFromJson(i,t):this._iScriptInterface._loadFromJson(i))}MoveToLayerWithSID(e){if(this._worldInfo.GetLayer().GetSID()===e)return;const t=this._worldInfo.GetLayer(),s=t.GetLayout().GetLayerBySID(e);s&&(this._worldInfo._SetLayer(s),t._RemoveInstance(this,!0),s._AddInstance(this,!0),s.SetZIndicesChanged(this),this._worldInfo.SetBboxChanged())}GetInterfaceClass(){return this._iScriptInterface||this._InitUserScriptInterface()}HasScriptInterface(){return!!this._iScriptInterface}_InitUserScriptInterface(e,t){const s=this._worldInfo?e?self.ISDKWorldInstanceBase:self.IWorldInstance:e?self.ISDKInstanceBase:self.IInstance,i=e||this._sdkInst.GetScriptInterfaceClass(),r=this._objectType._GetUserScriptInstanceClass(),n=r||i||s,a=this.GetPlugin().GetSdkVersion();if(XI.AddonManager._PushInitObject(this,a),XI.AddonManager._PushInitProperties(t),this._iScriptInterface=new n,XI.AddonManager._PopInitProperties(),XI.AddonManager._PopInitObject(a),i&&!(this._iScriptInterface instanceof s))throw new TypeError(`script interface class '${i.name}' does not extend the right base class '${s.name}'`);if(r){const e=i||s;if(!(this._iScriptInterface instanceof e))throw new TypeError(`setInstanceClass(): class '${r.name}' does not extend the right base class - check it extends the right class, e.g. globalThis.InstanceType.MyObjectName`)}return this._iScriptInterface}_GetInstVarsScriptDescriptor(e){if(0===this._instVarValues.length)return;const t={},s=this._objectType._GetAllInstanceVariableJsPropNames();for(let e=0,i=s.length;e<i;++e)t[s[e]]={configurable:!1,enumerable:!0,get:XI.Instance.prototype._GetInstanceVariableTypedValue.bind(this,e),set:XI.Instance.prototype.SetInstanceVariableValue.bind(this,e)};const i=Object.create(Object.prototype,t);e.instVars={value:i,writable:!1}}_GetBehaviorsScriptDescriptor(e){const t=this._behaviorInstances;if(0===t.length)return;const s={};for(const e of t)s[e.GetBehaviorType().GetJsPropName()]={value:e.GetScriptInterface(),writable:!1};const i=Object.create(Object.prototype,s);e.behaviors={value:i,writable:!1}}DispatchUserScriptEvent(e){if(!this.HasScriptInterface())return;const t=this.GetInterfaceClass();e.instance=t;const s=this._runtime,i=s.IsDebug()&&!s.GetEventSheetManager().IsInEventEngine();i&&$I.StartMeasuringScriptTime(),t.dispatchEvent(e),i&&$I.AddScriptTime()}}}{const hv=self.C3,uv=new Map;hv.SceneGraphInfo=class extends hv.DefendedBase{constructor(e){super(),this._owner=e,this._parent=null,this._children=[],this._startWidth=e.GetWidth(),this._startHeight=e.GetHeight(),this._startScaleX=1,this._startScaleY=1,this._parentStartAngle=0,this._ownOpacity=1,this._startOpacity=e.GetOpacity(),this._tmpSceneGraphChildren=null,this._tmpSceneGraphChildrenIndexes=null,this._indexInParent=NaN,this._originalSizeKnown=!1,this._originalWidth=NaN,this._originalHeight=NaN,this._on_instance_create=t=>{if(t.instance!==this._parent.GetInstance())return;e.GetRuntime().Dispatcher().removeEventListener("instancecreate",this._on_instance_create);const s=this._parent.GetInstance().GetSdkInstance();this._originalSizeKnown=!!s.IsOriginalSizeKnown(),this._originalWidth=this._originalSizeKnown?s.GetOriginalWidth():NaN,this._originalHeight=this._originalSizeKnown?s.GetOriginalHeight():NaN}}Release(){this._parent=null,this._tmpSceneGraphChildren=null,this._tmpSceneGraphChildrenIndexes=null,this._indexInParent=NaN,this._originalSizeKnown=!1,this._originalWidth=NaN,this._originalHeight=NaN,hv.clearArray(this._children)}SetParent(e){if(this._ownOpacity=this._owner.GetOpacity(),this._startOpacity=this._ownOpacity,this._parent=e,this._parentStartAngle=e?e.GetAngle():0,this._parent){const e=this._owner.GetRuntime();if(this._parent.GetInstance().GetPlugin().GetSdkVersion()<2){const t=this._parent.GetInstance().GetSdkInstance();t?(this._originalSizeKnown=!!t.IsOriginalSizeKnown(),this._originalWidth=this._originalSizeKnown?t.GetOriginalWidth():NaN,this._originalHeight=this._originalSizeKnown?t.GetOriginalHeight():NaN):this._parent.GetInstance().IsDestroyed()||e.Dispatcher().addEventListener("instancecreate",this._on_instance_create)}else this._originalSizeKnown=!1,this._originalWidth=NaN,this._originalHeight=NaN}else this._originalSizeKnown=!1,this._originalWidth=NaN,this._originalHeight=NaN}GetParent(){return this._parent}HasChildren(){return this._children.length>0}GetChildren(){return this._children}_MaybeSortChildren(){this.HasChildren()&&1!==this._children.length&&(this._tmpSceneGraphChildrenIndexes?this._children.sort((e,t)=>{const s=this._tmpSceneGraphChildrenIndexes.get(e.GetInstance()),i=this._tmpSceneGraphChildrenIndexes.get(t.GetInstance());return hv.IsFiniteNumber(s)&&hv.IsFiniteNumber(i)?s-i:0}):this._children.sort((e,t)=>{const s=e._GetSceneGraphInfo()._GetIndexInParent(),i=t._GetSceneGraphInfo()._GetIndexInParent();return hv.IsFiniteNumber(s)&&hv.IsFiniteNumber(i)?s-i:0}))}_GetIndexInParent(){return this._indexInParent}GetStartScaleX(){return this._startScaleX}SetStartScaleX(e){this._startScaleX=e}GetStartScaleY(){return this._startScaleY}SetStartScaleY(e){this._startScaleY=e}GetStartOpacity(){return this._startOpacity}GetOwnOpacity(){return this._ownOpacity}SetOwnOpacity(e){this._ownOpacity=e}_GetStartWidth(){return 0===this._startWidth?Number.EPSILON:this._startWidth}_GetStartHeight(){return 0===this._startHeight?Number.EPSILON:this._startHeight}GetParentScaleX(){if(this._owner.GetTransformWithParentWidth()){const e=this._parent;let t=e.GetWidth(),s=e._GetSceneGraphInfo()._GetStartWidth();return 0===t&&(t=Number.EPSILON),s===Number.EPSILON&&t===Number.EPSILON?1:s===Number.EPSILON&&t!==Number.EPSILON&&this._originalSizeKnown?1+t/this._originalWidth:t/s}return 1}GetParentScaleY(){if(this._owner.GetTransformWithParentHeight()){const e=this._parent;let t=e.GetHeight(),s=e._GetSceneGraphInfo()._GetStartHeight();return 0===t&&(t=Number.EPSILON),s===Number.EPSILON&&t===Number.EPSILON?1:s===Number.EPSILON&&t!==Number.EPSILON&&this._originalSizeKnown?1+t/this._originalHeight:t/s}return 1}GetParentStartAngle(){return 0}_SaveToJsonProperties(){return{sw:this._startWidth,sh:this._startHeight,sx:this._startScaleX,sy:this._startScaleY,psa:this._parentStartAngle,oo:this._ownOpacity,so:this._startOpacity,pi:this._owner.GetInstance().GetIndexInParent()}}_SaveToJson(e,t=null){const s=this._SaveToJsonProperties();return t&&t.selfOnly?Object.assign(s,{p:null,c:[]}):Object.assign(s,{p:this._GetParentJson(e),c:this._GetChildrenJson(e)})}_GetFlagsString(e){let t="";return e.GetTransformWithParentX()&&(t+="x"),e.GetTransformWithParentY()&&(t+="y"),e.GetTransformWithParentWidth()&&(t+="w"),e.GetTransformWithParentHeight()&&(t+="h"),e.GetTransformWithParentAngle()&&(t+="a"),e.GetTransformWithParentZElevation()&&(t+="z"),e.GetDestroyWithParent()&&(t+="d"),e.GetTransformWithParentOpacity()&&(t+="o"),e.GetTransformWithParentVisibility()&&(t+="v"),t}_GetParentJson(e){return this._parent?!this._parent.GetInstance()||this._parent.GetInstance().IsDestroyed()?null:this._GetInstanceJson(this._parent,this._owner,e):null}_GetChildrenJson(e){return this._children.map(t=>this._GetInstanceJson(t,t,e)).filter(e=>e)}_GetInstanceJson(e,t,s){const i=e.GetInstance();if(i&&i.IsDestroyed())return null;const r={};return r.uid=i.GetUID(),r.f=this._GetFlagsString(t),r.offsets=t._SaveSceneGraphPropertiesToJson(),r.data=hv.SceneGraphInfo.GetSceneGraphInstanceDataFromInstance(i),r.oci=i.GetObjectClass().GetIndex(),"state"===s?(r.inst=i.SaveToJson("full",{selfOnly:!0}),r.instIndex=NaN):(r.instIndex=i.GetObjectClass().GetInstances().indexOf(i),r.inst=null),r}_LoadFromJson(e){this._startWidth=e.sw,this._startHeight=e.sh,this._startScaleX=e.sx,this._startScaleY=e.sy,this._parentStartAngle=e.psa,this._ownOpacity=e.oo,this._startOpacity=e.so,this._indexInParent=hv.IsFiniteNumber(e.pi)?e.pi:NaN}_SetTmpSceneGraphChildren(e,t,s,i){if(!e&&!t)if(i?.setFromJson){if(this._tmpSceneGraphChildren)for(const e of this._tmpSceneGraphChildren)e.IsDestroyed()||e.HasParent()||e.GetRuntime().DestroyInstance(e)}else if(this._tmpSceneGraphChildren)for(const e of this._tmpSceneGraphChildren)if(s.c&&s.c.length){if(!s.c.some(t=>t.uid===e.GetUID()))continue;e.IsDestroyed()||e.HasParent()||e.GetRuntime().DestroyInstance(e)}this._tmpSceneGraphChildren=e,this._tmpSceneGraphChildrenIndexes=t}_GetInstanceByUID(e){const t=this._owner.GetRuntime();return uv.has(e)?uv.get(e):t.GetInstanceByUID(e)}_OnAfterLoad(e,t){const s=this._owner,i=s.GetRuntime(),r=t?.processedWorldInfo??new Set;if(e.p&&!this._parent){const n=e.p.uid,a=this._GetInstanceByUID(n);if(a){const n=a.GetWorldInfo();a.HasChild(s.GetInstance())?this._parent=n:(a.HasChildWithUID(s.GetInstance().GetUID())?(i.DestroyInstance(s.GetInstance()),i._RemoveInstanceFromUIDMap(s.GetInstance().GetUID()),uv.delete(s.GetInstance().GetUID())):a.AddChild(s.GetInstance(),this._GetFlagsObj(e.p.f)),r.has(s)||(s._LoadSceneGraphPropertiesFromJson(e.p.offsets),this._LoadInstancePropertiesFromJson(a,e.p,t),this._UpdateUIDInstanceMap(a,a.GetUID(),s.GetRuntime(),t)),r.add(s),a.GetWorldInfo()._GetSceneGraphInfo()._MaybeSortChildren())}else if(hv.IsFiniteNumber(e.p.oci)){const r=i.CreateInstance(i.GetObjectClassByIndex(e.p.oci),s.GetLayer(),0,0,!0);if(r){const n=this._GetInstanceData(e.p,i);n&&r.LoadFromJson(n);const a=r.GetWorldInfo(),o=!!t?.setFromJson;a.GetLayer().SortAndAddInstancesByZIndex(r,!1,o),r.AddChild(s.GetInstance(),this._GetFlagsObj(e.p.f)),uv.set(r.GetUID(),r),this._UpdateUIDInstanceMap(r,r.GetUID(),i,t),r.GetWorldInfo()._GetSceneGraphInfo()._MaybeSortChildren()}}}const n=[];for(const t of e.c){const e=t.uid,s=this._GetInstanceByUID(e);s&&n.push(s)}let a=0;for(const o of e.c){const l=o.uid,h=this._GetInstanceByUID(l);if(h){if(this._tmpSceneGraphChildren){if(this._tmpSceneGraphChildren.includes(h)){const i=h;if(i.GetObjectClass()!==h.GetObjectClass()){a++;continue}if(i.IsDestroyed()){a++;continue}const o=e.c[a];if(!t?.setFromJson&&this._HasAllChildrenOfType(i,n,s)){if(s.GetInstance().GetChildAt(a)){const n=i.GetObjectClass().GetIndex(),l=o.oci,h=s.GetInstance().GetChildAt(a).GetObjectClass().GetIndex();if(n!==l||l!==h){this._RefreshAllChildren(e.c,s,r,t);break}this._UpdateInstance(a,o,s,r,t)}else this._UpdateInstance(a,o,s,r,t);a++;continue}if(i.HasParent()&&i.GetParent()!==s.GetInstance()){const e=this._CreateNewChildInstance(o,t);this._AddAndSetChildInstance(e,o,r,t),a++;continue}this._AddAndSetChildInstance(i.GetWorldInfo(),o,r,t,!0),a++;continue}if(this._tmpSceneGraphChildren[a]){const i=this._tmpSceneGraphChildren[a];if(i.GetObjectClass()!==h.GetObjectClass()){a++;continue}if(i.IsDestroyed()){a++;continue}const o=e.c[a];if(!t?.setFromJson&&this._HasAllChildrenOfType(i,n,s)){if(s.GetInstance().GetChildAt(a)){const n=i.GetObjectClass().GetIndex(),l=o.oci,h=s.GetInstance().GetChildAt(a).GetObjectClass().GetIndex();if(n!==l||l!==h){this._RefreshAllChildren(e.c,s,r,t);break}this._UpdateInstance(a,o,s,r,t)}else this._UpdateInstance(a,o,s,r,t);a++;continue}if(i.HasParent()&&i.GetParent()!==s.GetInstance()){const e=this._CreateNewChildInstance(o,t);this._AddAndSetChildInstance(e,o,r,t),a++;continue}this._AddAndSetChildInstance(i.GetWorldInfo(),o,r,t,!0),a++;continue}}const i=h.GetObjectClass();if(this._GetInstancesOfObjectClassCount(n,i)===s.GetInstance().GetChildrenOfObjectClass(i).length){for(const e of s.GetInstance().GetChildren()){if(e.GetObjectClass()!==i)continue;const s=e.GetWorldInfo();if(s&&!r.has(s)){r.add(s),s._LoadSceneGraphPropertiesFromJson(o.offsets),this._LoadInstancePropertiesFromJson(e,o,t);break}}a++;continue}if(h.HasParent()&&h.GetParent()!==s.GetInstance()){const e=this._CreateNewChildInstance(o,t);this._AddAndSetChildInstance(e,o,r,t),a++;continue}this._AddAndSetChildInstance(h.GetWorldInfo(),o,r,t)}else if(this._tmpSceneGraphChildren&&this._tmpSceneGraphChildren[a]){const l=this._tmpSceneGraphChildren[a],h=i.GetObjectClassByIndex(this._GetObjectClassIndex(o));if(l.GetObjectClass()!==h){a++;continue}if(l.IsDestroyed()){a++;continue}const u=e.c[a];if(!t?.setFromJson&&this._HasAllChildrenOfType(l,n,s)){if(s.GetInstance().GetChildAt(a)){const i=l.GetObjectClass().GetIndex(),n=u.oci,o=s.GetInstance().GetChildAt(a).GetObjectClass().GetIndex();if(i!==n||n!==o){this._RefreshAllChildren(e.c,s,r,t);break}this._UpdateInstance(a,u,s,r,t)}else this._UpdateInstance(a,u,s,r,t);a++;continue}if(l.HasParent()&&l.GetParent()!==s.GetInstance()){const e=this._CreateNewChildInstance(u,t);this._AddAndSetChildInstance(e,u,r,t),a++;continue}this._AddAndSetChildInstance(l.GetWorldInfo(),u,r,t)}else{const e=this._CreateNewChildInstance(o,t);this._AddAndSetChildInstance(e,o,r,t)}a++}}_RefreshAllChildren(e,t,s,i){const r=t.GetRuntime();for(const e of t.GetInstance().children())e&&!e.IsDestroyed()&&(r.DestroyInstance(e),r._RemoveInstanceFromUIDMap(e.GetUID()),uv.delete(e.GetUID()));this._tmpSceneGraphChildren&&(this._tmpSceneGraphChildren=[]),this._tmpSceneGraphChildrenIndexes&&(this._tmpSceneGraphChildrenIndexes=new WeakMap),Object.assign({},i,{assignZIndex:!1});for(const t of e){const e=this._CreateNewChildInstance(t,i);this._AddAndSetChildInstance(e,t,s,i),this._tmpSceneGraphChildren.push(e.GetInstance()),this._tmpSceneGraphChildrenIndexes.set(e.GetInstance(),this._tmpSceneGraphChildren.length-1)}t._GetSceneGraphInfo()._MaybeSortChildren()}_HasAllChildrenOfType(e,t,s){const i=e.GetObjectClass();return this._GetInstancesOfObjectClassCount(t,i)===s.GetInstance().GetChildrenOfObjectClass(i).length}_UpdateInstance(e,t,s,i,r){const n=s.GetInstance().GetChildAt(e);if(!n)return;const a=n.GetWorldInfo();a&&(i.has(a)||(a._LoadSceneGraphPropertiesFromJson(t.offsets),this._LoadInstancePropertiesFromJson(n,t,r)),i.add(a))}_GetFlagsObj(e){const t={};return t.transformX=e.includes("x"),t.transformY=e.includes("y"),t.transformWidth=e.includes("w"),t.transformHeight=e.includes("h"),t.transformAngle=e.includes("a"),t.transformZElevation=e.includes("z"),t.destroyWithParent=e.includes("d"),t.transformOpacity=e.includes("o"),t.transformVisibility=e.includes("v"),t}_GetObjectClassIndex(e){return hv.IsFiniteNumber(e.oci)?e.oci:e[1]}_CreateNewChildInstance(e,t){if(!hv.IsFiniteNumber(e.oci))return;const s=this._owner,i=s.GetRuntime();let r;const n=!t.hasOwnProperty("createHierarchy")||t.createHierarchy;if(r=e.data?i.CreateInstanceFromData(e.data,s.GetLayer(),!1,0,0,!1,n):i.CreateInstance(i.GetObjectClassByIndex(e.oci),s.GetLayer(),0,0,n),!r)return;const a=this._GetInstanceData(e,i);a&&r.LoadFromJson(a);const o=r.GetWorldInfo(),l=!!t?.setFromJson;return o.GetLayer().SortAndAddInstancesByZIndex(r,!0,l),o}_UpdateUIDInstanceMap(e,t,s,i){if(this._GetInstanceByUID(t)&&!i?.setFromJson){const i=this._GetInstanceByUID(t);i!==e&&s.DestroyInstance(i)}s._RemoveInstanceFromUIDMap(t),s._MapInstanceByUID(t,e)}_AddAndSetChildInstance(e,t,s,i,r=!0){const n=this._owner,a=n.AddChild(e,this._GetFlagsObj(t.f));a&&r?(s.has(e)||(e._LoadSceneGraphPropertiesFromJson(t.offsets),this._LoadInstancePropertiesFromJson(e.GetInstance(),t,i)),s.add(e)):a&&(uv.set(e.GetInstance().GetUID(),e.GetInstance()),this._UpdateUIDInstanceMap(e.GetInstance(),t.uid,n.GetRuntime(),i)),this._MaybeSortChildren()}_LoadInstancePropertiesFromJson(e,t,s){let i=this._GetInstanceData(t,this._owner.GetRuntime());if(!i)return;const r=!s.hasOwnProperty("clearChildren")||s.clearChildren,n=!s.hasOwnProperty("assignZIndex")||s.assignZIndex,a=e.GetRuntime();if(uv.set(e.GetUID(),e),i=JSON.parse(JSON.stringify(i)),r&&e.GetUID()!==i.uid){for(const t of e.children())t&&!t.IsDestroyed()&&(a.DestroyInstance(t),a._RemoveInstanceFromUIDMap(t.GetUID()),uv.delete(t.GetUID()));if(i.w?.sgi&&i.w.sgi.c?.length)for(const t of i.w.sgi.c){const i=Object.assign({},s,{clearChildren:!1,createHierarchy:!1}),r=this._CreateNewChildInstance(t,i);uv.set(r.GetInstance().GetUID(),r.GetInstance()),e.AddChild(r.GetInstance(),this._GetFlagsObj(t.f)),r._LoadSceneGraphPropertiesFromJson(t.offsets),this._LoadInstancePropertiesFromJson(r.GetInstance(),t,i)}}const o=i.w?.zi,l=i.w?.l;i.w=null,e.LoadFromJson(i),s?.setFromJson||(hv.IsFiniteNumber(o)&&n&&e.GetWorldInfo()._SetZIndex(o),hv.IsFiniteNumber(l)&&e.MoveToLayerWithSID(l)),this._UpdateUIDInstanceMap(e,i.uid,a,s)}_GetInstancesOfObjectClassCount(e,t){return e.filter(e=>e.GetObjectClass().GetName()===t.GetName()).length}_GetInstanceData(e,t){if(hv.IsFiniteNumber(e.instIndex)){const s=t.GetObjectClassByIndex(e.oci)._GetLoadInstancesJson();return s?s[e.instIndex]:null}return hv.IsString(e.inst)?JSON.parse(e.inst):e.inst?e.inst:void 0}static GetSceneGraphInstanceDataFromInstance(e){let t=e.GetWorldInfo().GetLayer().GetInitialInstanceData(e.GetUID());if(!t)return null;t=JSON.parse(JSON.stringify(t));const s=[];for(const t of[...e.GetChildren()]){const e=t.GetWorldInfo();s.push([e.GetLayout().GetSID(),e.GetLayer().GetIndex(),t.GetUID(),hv.SceneGraphInfo._GetFlagsNumber(e),t.GetObjectClass().IsInContainer()?1:0,e.GetZIndex(),hv.SceneGraphInfo.GetSceneGraphInstanceDataFromInstance(t)])}return hv.IsArray(t[0][14])?t[0][14][1]=s:(t[0][14]=[],t[0][14][0]=hv.SceneGraphInfo._GetDefaultFlagsNumber(),t[0][14][1]=s,t[0][14][2]=e.GetWorldInfo().GetZIndex()),t}static _GetFlagsNumber(e){let t=0;return t|=Number(e.GetTransformWithParentVisibility())<<8,t|=Number(e.GetTransformWithParentOpacity())<<7,t|=Number(e.GetTransformWithParentZElevation())<<6,t|=Number(e.GetDestroyWithParent())<<5,t|=Number(e.GetTransformWithParentAngle())<<4,t|=Number(e.GetTransformWithParentHeight())<<3,t|=Number(e.GetTransformWithParentWidth())<<2,t|=Number(e.GetTransformWithParentY())<<1,t|=0|Number(e.GetTransformWithParentX()),t}static _GetDefaultFlagsNumber(e){let t=0;return t|=256,t|=128,t|=64,t|=32,t|=16,t|=8,t|=4,t|=2,t|=1,511}static ClearUpdatedInstances(){uv.clear()}}}{const cv=self.C3,dv=self.glMatrix,pv=dv.vec3,_v=dv.vec4,mv=cv.New(cv.Rect),fv=cv.New(cv.Quad),gv=cv.New(cv.Event,"bboxchange",!1),yv=cv.New(cv.Color,0,0,0,0),Sv=cv.New(cv.CollisionPoly),Tv=cv.New(cv.Color,1,1,1,1),xv=cv.New(cv.Rect,0,0,-1,-1),bv=cv.New(cv.Rect,0,0,-1,-1),Gv=new Set(["absolute","relative"]),Iv=[];let vv=!0;const Cv=1,wv=2,Av=4,Rv=8,Pv=16,Mv=32,Ev=64,Dv=128,Nv=256,Fv=512,Ov=1024,Bv=2048,Lv=4096,kv=8192,Vv=16384,Uv=32768,Wv=1<<22,Hv=1<<23,zv=12647936,jv=65536,Yv=1<<17,qv=1<<18,Xv=1<<19,$v=1<<20,Kv=1<<21,Jv=1<<24,Qv=26,Zv=31<<26,eC=new WeakMap,tC=new WeakMap;cv.WorldInfo=class extends cv.DefendedBase{constructor(e,t){super(),this._inst=e,this._objectClass=e.GetObjectClass(),this._runtime=e.GetRuntime(),this._layer=t,this._objectClass._OnWorldInstanceLayerChanged(this,null,t),this._zIndex=-1,this._htmlZIndex=-1,this._flags=196635,this._objectClass.GetPlugin().IsRotatable()&&(this._flags|=128),this._x=NaN,this._y=NaN,this._zElevation=NaN,this._w=NaN,this._h=NaN,this._depth=NaN,this._a=NaN,this._sinA=NaN,this._cosA=NaN,this._ox=NaN,this._oy=NaN,this._boundingBox=cv.New(cv.Rect),this._boundingQuad=cv.New(cv.Quad),this._collisionCells=bv,this._renderCells=xv,this._sourceCollisionPoly=null,this._transformedPolyInfo=null,this._solidFilterTags=null,this._color=Tv,this._colorPremultiplied=Tv,this._stateGroup=null,this._instanceEffectList=null,this._inst.GetObjectClass().UsesEffects()&&(this._instanceEffectList=cv.New(cv.InstanceEffectList,this._inst,this)),this._sceneGraphInfo=null,this._tmpSceneGraphChildren=null,this._tmpSceneGraphChildrenIndexes=null,this._tmpHierarchyPosition=-1,this._meshInfo=null}_MarkDestroyed(){this._flags|=256}Release(){if(this._objectClass._OnWorldInstanceLayerChanged(this,this._layer,null),this._stateGroup&&(this._runtime.GetRenderer().ReleaseStateGroup(this._stateGroup),this._stateGroup=null),this._sourceCollisionPoly=null,this._transformedPolyInfo&&(this._transformedPolyInfo.poly.Release(),this._transformedPolyInfo=null),this._solidFilterTags&&(this._solidFilterTags.clear(),this._solidFilterTags=null),this.ReleaseMesh(),this._instanceEffectList&&this._instanceEffectList.Release(),this.HasParent()&&this.GetParent().RemoveChild(this),this.HasChildren()){const e=[...this.GetChildren()];for(const t of e)this.RemoveChild(t)}this._ReleaseSceneGraphInfo(),this._ReleaseTmpSceneGraphInfo(),eC.delete(this),tC.delete(this),this._inst=null,this._objectClass=null,this._runtime=null,this._layer=null}Init(e){if(vv=!1,this.SetXY(e[0],e[1]),this.SetZElevation(e[2]),this.SetSize(e[3],e[4]),this._depth=0,this.IsRotatable()?this.SetAngle(e[6]):this._a=0,yv.setFromJSON(e[7]),this._SetColor(yv),this.SetOriginX(e[8]),this.SetOriginY(e[9]),this.SetBlendMode(e[10]),this._instanceEffectList&&this._instanceEffectList._LoadEffectParameters(e[12]),e[14]&&eC.set(this,{childrenData:e[14][1],zIndexData:e[14][2]}),e[15]){const t=e[15];this.CreateMesh(t[0],t[1]);const s=this.GetSourceMesh(),i=t[2];for(let e=0,t=i.length;e<t;++e){const t=i[e];for(let i=0,r=t.length;i<r;++i){const r=t[i],n=s.GetMeshPointAt(i,e);n.SetX(r[0]),n.SetY(r[1]),n.SetZElevation(r[2]),n.SetU(r[3]),n.SetV(r[4])}}}if(e[16]){const t=e[16][0],s=e[16][1],i=!!s,r=!i,n=this._runtime.GetTemplateManager();i&&n&&n.MapInstanceToTemplateName(this.GetInstance(),s),r&&n&&n.MapInstanceToTemplateName(this.GetInstance(),t)}vv=!0,this._UpdateRendererStateGroup()}InitNoData(){this._x=0,this._y=0,this._zElevation=0,this._w=0,this._h=0,this._depth=0,this._a=0,this._sinA=0,this._cosA=1,this._ox=0,this._oy=0,this._UpdateRendererStateGroup()}GetRuntime(){return this._runtime}GetObjectClass(){return this._objectClass}GetInstance(){return this._inst}_GetParentOffsetAngle(){return this.GetTransformWithParentAngle()?this._MaybeReflectAngleForMirrorFlip(this.GetParent()._GetAngleNoReflect()-this._sceneGraphInfo.GetParentStartAngle()):0}SetX(e){if(e=+e,this.GetTransformWithParentX()){const t=this._sceneGraphInfo,s=e-this.GetX(),i=-this._GetParentOffsetAngle();0===i?this._x+=s/t.GetParentScaleX():(this._x+=Math.cos(i)*s/t.GetParentScaleX(),this.GetTransformWithParentY()&&(this._y+=Math.sin(i)*s/t.GetParentScaleY()))}else this._x=e}OffsetX(e,t=!1){e=+e,t?this._x+=e:this.GetTransformWithParentX()?this.SetX(this.GetX()+e):this._x+=e}GetX(){if(this.GetTransformWithParentX()){let e=this._x;const t=this._sceneGraphInfo,s=this.GetParent(),i=this._GetParentOffsetAngle();return 0===i?e*=t.GetParentScaleX():(e=e*t.GetParentScaleX()*Math.cos(i),this.GetTransformWithParentY()&&(e-=this._y*t.GetParentScaleY()*Math.sin(i))),s.GetX()+e}return this._x}SetY(e){if(e=+e,this.GetTransformWithParentY()){const t=this._sceneGraphInfo,s=e-this.GetY(),i=-this._GetParentOffsetAngle();0===i?this._y+=s/t.GetParentScaleY():(this.GetTransformWithParentX()&&(this._x-=Math.sin(i)*s/t.GetParentScaleX()),this._y+=Math.cos(i)*s/t.GetParentScaleY())}else this._y=e}OffsetY(e,t=!1){e=+e,t?this._y+=e:this.GetTransformWithParentY()?this.SetY(this.GetY()+e):this._y+=e}GetY(){if(this.GetTransformWithParentY()){let e=this._y;const t=this._sceneGraphInfo,s=this.GetParent(),i=this._GetParentOffsetAngle();return 0===i?e*=t.GetParentScaleY():(e=e*t.GetParentScaleY()*Math.cos(i),this.GetTransformWithParentX()&&(e+=this._x*t.GetParentScaleX()*Math.sin(i))),s.GetY()+e}return this._y}SetXY(e,t){if(e=+e,t=+t,this.GetTransformWithParentXOrY()){const s=this.GetTransformWithParentX(),i=this.GetTransformWithParentY(),r=this._sceneGraphInfo,n=e-this.GetX(),a=t-this.GetY(),o=-this._GetParentOffsetAngle();if(0===o)s?this._x+=n/r.GetParentScaleX():this._x=e,i?this._y+=a/r.GetParentScaleY():this._y=t;else{const l=Math.sin(o),h=Math.cos(o);s?this._x+=i?(h*n-l*a)/r.GetParentScaleX():h*n/r.GetParentScaleX():this._x=e,i?this._y+=s?(l*n+h*a)/r.GetParentScaleY():h*a/r.GetParentScaleY():this._y=t}}else this._x=e,this._y=t}GetXY(){return[this.GetX(),this.GetY()]}OffsetXY(e,t){e=+e,t=+t,this.GetTransformWithParentXOrY()?this.SetXY(this.GetX()+e,this.GetY()+t):(this._x+=e,this._y+=t)}EqualsXY(e,t){return this.GetX()===e&&this.GetY()===t}SetZElevation(e){if(e=+e,this.GetTransformWithParentZElevation()&&(e-=this.GetParent().GetZElevation()),this._zElevation===e)return;this._zElevation=e,this._UpdateZElevation();const t=this.GetLayer();0!==this._zElevation&&t._SetAnyInstanceZElevated(),t.SetZIndicesChanged(this)}_UpdateZElevation(){if(this._UpdateRendererStateGroup(),this.HasChildren()){const e=this.GetChildren();for(let t=0,s=e.length;t<s;t++){const s=e[t];s.GetTransformWithParentZElevation()&&s._UpdateZElevation()}}}OffsetZElevation(e){this.SetZElevation(this.GetZElevation()+e)}GetZElevation(){return this.GetTransformWithParentZElevation()?this.GetParent().GetZElevation()+this._zElevation:this._zElevation}GetTotalZElevation(){return this.GetLayer().GetZElevation()+this.GetZElevation()}IsOriginalSizeKnown(){return this.GetInstance().GetPlugin().GetSdkVersion()<2&&this.GetInstance().GetSdkInstance().IsOriginalSizeKnown()}SetWidth(e){if(e=+e,this.GetTransformWithParentWidth()){const t=this.GetWidth();0===t?this._w=Number.EPSILON:this._w*=e/t}else this._w=e;this._MarkSinCosAngleChanged()}OffsetWidth(e,t){e=+e,t?this._w+=e:this.GetTransformWithParentWidth()?this.SetWidth(this.GetWidth()+e):this._w+=e,this._MarkSinCosAngleChanged()}GetWidth(){if(this.GetTransformWithParentWidth()){const e=this.GetParent(),t=e.GetWidth();return e._GetSceneGraphInfo()._GetStartWidth()===Number.EPSILON?(this._GetSceneGraphInfo()._GetStartWidth()+t)*this._w:t*this._w}return this._w}SetHeight(e){if(e=+e,this.GetTransformWithParentHeight()){const t=this.GetHeight();0===t?this._h=Number.EPSILON:this._h*=e/t}else this._h=e;this._MarkSinCosAngleChanged()}OffsetHeight(e,t){e=+e,t?this._h+=e:this.GetTransformWithParentHeight()?this.SetHeight(this.GetHeight()+e):this._h+=e,this._MarkSinCosAngleChanged()}GetHeight(){if(this.GetTransformWithParentHeight()){const e=this.GetParent(),t=e.GetHeight();return e._GetSceneGraphInfo()._GetStartHeight()===Number.EPSILON?(this._GetSceneGraphInfo()._GetStartHeight()+t)*this._h:t*this._h}return this._h}SetSize(e,t){if(e=+e,t=+t,this.GetTransformWithParentWidth()){const t=this.GetWidth();0===t?this._w=Number.EPSILON:this._w*=e/t}else this._w=e;if(this.GetTransformWithParentHeight()){const e=this.GetHeight();0===e?this._h=Number.EPSILON:this._h*=t/e}else this._h=t;this._MarkSinCosAngleChanged()}GetSize(){return[this.GetWidth(),this.GetHeight()]}GetDepth(){return this._depth}SetDepth(e){if(e<0)throw new RangeError("invalid depth");this._depth=e}GetSceneGraphScale(){if(this.HasParent()){const e=this._sceneGraphInfo;return Math.min(e.GetParentScaleX(),e.GetParentScaleY())}return 1}IsRotatable(){return!!(128&this._flags)}SetAngle(e){e=+e,this.IsRotatable()&&(this.GetTransformWithParentAngle()&&(e-=this.GetParent().GetAngle()),e=cv.clampAngle(e),this._a!==e&&(this._a=e,this._MarkSinCosAngleChanged()))}OffsetAngle(e){0!==(e=+e)&&this.IsRotatable()&&(this._a=cv.clampAngle(this._a+e),this._MarkSinCosAngleChanged())}_MarkSinCosAngleChanged(){if(this._flags|=262144,this.HasChildren()){const e=this.GetChildren();for(let t=0,s=e.length;t<s;t++)e[t]._MarkSinCosAngleChanged()}}GetAngle(){return this.GetTransformWithParentAngle()&&this.IsRotatable()?this._MaybeReflectAngleForMirrorFlip(cv.clampAngle(this.GetParent()._GetAngleNoReflect()+this._a)):this._a}_GetAngleNoReflect(){return this.GetTransformWithParentAngle()&&this.IsRotatable()?cv.clampAngle(this.GetParent()._GetAngleNoReflect()+this._a):this._a}_MaybeReflectAngleForMirrorFlip(e){return this.GetTransformWithParentWidth()&&this.GetTopParent().GetWidth()<0&&(e=cv.clampAngle(cv.angleReflect(e,this.GetTopParent().GetAngle()+Math.PI))),this.GetTransformWithParentHeight()&&this.GetTopParent().GetHeight()<0&&(e=cv.angleReflect(e,this.GetTopParent().GetAngle())),e}_NeedsReflectAngleForMirrorOrFlip(){const e=this.GetParent();return!!(this.GetTransformWithParentWidth()&&e.GetWidth()<0)||!!(this.GetTransformWithParentHeight()&&e.GetHeight()<0)}_NeedsReflectAngleForMirrorAndFlip(){const e=this.GetParent();return!!(this.GetTransformWithParentWidth()&&e.GetWidth()<0&&this.GetTransformWithParentHeight()&&e.GetHeight()<0)}_MaybeUpdateSinCosAngle(){const e=this._flags;if(!(262144&e))return;const t=this.GetAngle();this._sinA=Math.sin(t),this._cosA=Math.cos(t),this._flags=-262145&e}GetSinAngle(){return this._MaybeUpdateSinCosAngle(),this._sinA}GetCosAngle(){return this._MaybeUpdateSinCosAngle(),this._cosA}SetOriginX(e){this._ox=+e}OffsetOriginX(e){this._ox+=+e}GetOriginX(){return this._ox}SetOriginY(e){this._oy=+e}OffsetOriginY(e){this._oy+=+e}GetOriginY(){return this._oy}_SetColor(e){this._color.equals(e)||(this._color===Tv?(this._color=cv.New(cv.Color,e),this._colorPremultiplied=cv.New(cv.Color,e),this._colorPremultiplied.premultiply()):e.equalsRgba(1,1,1,1)?(this._color=Tv,this._colorPremultiplied=Tv):(this._color.set(e),this._colorPremultiplied.set(e),this._colorPremultiplied.premultiply()),this._UpdateRendererStateGroup())}SetOpacity(e){if(e=cv.clamp(+e,0,1),this.GetTransformWithParentOpacity()){if(this._GetSceneGraphInfo().GetOwnOpacity()===e)return;this._GetSceneGraphInfo().SetOwnOpacity(e),e=this.GetOpacity()}else if(this._color.a===e)return;this._SetColorWithOpacity(e)}_SetOpacityOfChildren(){if(!this.HasChildren())return;const e=this.GetChildren();for(let t=0,s=e.length;t<s;t++){const s=e[t];s._SetColorWithOpacity(s.GetOpacity())}}_SetColorWithOpacity(e){yv.copyRgb(this._color),yv.a=e,this._SetColor(yv),this._SetOpacityOfChildren()}OffsetOpacity(e){this.GetTransformWithParentOpacity()?this.SetOpacity(this._GetSceneGraphInfo().GetOwnOpacity()+e):this.SetOpacity(this.GetOpacity()+e)}GetOpacity(){return this.GetTransformWithParentOpacity()?this.GetParent().GetOpacity()*this._GetSceneGraphInfo().GetOwnOpacity():this._color.a}SetUnpremultipliedColor(e){this._color.equalsIgnoringAlpha(e)||(yv.copyRgb(e),yv.a=this.GetOpacity(),this._SetColor(yv))}SetUnpremultipliedColorRGB(e,t,s){yv.setRgb(e,t,s),this.SetUnpremultipliedColor(yv)}OffsetUnpremultipliedColorRGB(e,t,s){0===e&&0===t&&0===s||(yv.copyRgb(this._color),yv.r+=e,yv.g+=t,yv.b+=s,this.SetUnpremultipliedColor(yv))}GetUnpremultipliedColor(){return this._color}GetPremultipliedColor(){return this._colorPremultiplied}GetDestroyWithParent(){return!!(512&this._flags)}SetDestroyWithParent(e){this._SetFlag(512,e)}GetTransformWithParentX(){return!!(1024&this._flags)}SetTransformWithParentX(e){this._SetFlag(1024,e)}GetTransformWithParentY(){return!!(2048&this._flags)}GetTransformWithParentXOrY(){return!!(3072&this._flags)}SetTransformWithParentY(e){this._SetFlag(2048,e)}GetTransformWithParentWidth(){return!!(4096&this._flags)}SetTransformWithParentWidth(e){this._SetFlag(4096,e)}GetTransformWithParentHeight(){return!!(8192&this._flags)}SetTransformWithParentHeight(e){this._SetFlag(8192,e)}GetTransformWithParentAngle(){return!!(16384&this._flags)}SetTransformWithParentAngle(e){this._SetFlag(16384,e)}GetTransformWithParentZElevation(){return!!(32768&this._flags)}SetTransformWithParentZElevation(e){this._SetFlag(32768,e)}GetTransformWithParentOpacity(){return!!(4194304&this._flags)}SetTransformWithParentOpacity(e){this._SetFlag(4194304,e)}GetTransformWithParentVisibility(){return!!(8388608&this._flags)}SetTransformWithParentVisibility(e){this._SetFlag(8388608,e)}_ClearAllSceneGraphFlags(){this._flags&=-12647937}AddChild(e,t){if(e===this)return!1;if(e.HasParent())return!1;if(this._HasChildRecursive(e))return!1;if(this._HasAnyParent(e))return!1;const s=e.GetX(),i=e.GetY(),r=e.GetWidth(),n=e.GetHeight(),a=e.GetAngle(),o=e.GetZElevation(),l=e.GetOpacity();e._SetParent(this),e.SetTransformWithParentX(t.transformX),e.SetTransformWithParentY(t.transformY),e.SetTransformWithParentWidth(t.transformWidth),e.SetTransformWithParentHeight(t.transformHeight),e.SetTransformWithParentAngle(t.transformAngle),e.SetTransformWithParentZElevation(t.transformZElevation),e.SetTransformWithParentOpacity(t.transformOpacity),e.SetTransformWithParentVisibility(t.transformVisibility),e.SetDestroyWithParent(t.destroyWithParent);const h=s-this.GetX(),u=i-this.GetY(),c=-this.GetAngle(),d=Math.cos(c),p=Math.sin(c);if(t.transformX&&(t.transformAngle?e._x=h*d-u*p:e._x=h,t.transformWidth)){const t=this.GetWidth()/this._sceneGraphInfo._GetStartWidth();0!==t&&(e._x/=t)}if(t.transformY&&(t.transformAngle?e._y=h*p+u*d:e._y=u,t.transformHeight)){const t=this.GetHeight()/this._sceneGraphInfo._GetStartHeight();0!==t&&(e._y/=t)}if(t.transformWidth){const t=this.GetWidth();0===t||t===Number.EPSILON?(e._w=1,e._sceneGraphInfo.SetStartScaleX(1)):(e._w=r/this.GetWidth(),e._sceneGraphInfo.SetStartScaleX(e._w))}if(t.transformHeight){const t=this.GetHeight();0===t||t===Number.EPSILON?(e._h=1,e._sceneGraphInfo.SetStartScaleY(1)):(e._h=n/this.GetHeight(),e._sceneGraphInfo.SetStartScaleY(e._h))}return t.transformAngle&&(e._a=a-this.GetAngle()),t.transformZElevation&&(e._zElevation=o-this.GetZElevation()),t.transformOpacity&&e._sceneGraphInfo.SetOwnOpacity(l),t.transformVisibility&&e.SetVisible(this.IsVisible()),this._AddChildToSceneGraphInfo(e),this.SetBboxChanged(),this._SetOpacityOfChildren(),!0}RemoveChild(e){if(e.GetParent()!==this)return;const t=e.GetX(),s=e.GetY(),i=e.GetWidth(),r=e.GetHeight(),n=e.GetAngle(),a=e.GetZElevation(),o=e.GetOpacity();e._SetParent(null),e._ClearAllSceneGraphFlags(),e.SetXY(t,s),e.SetSize(i,r),e.SetAngle(n),e.SetZElevation(a),e.SetOpacity(o),this._RemoveChildFromSceneGraphInfo(e),this.SetBboxChanged()}GetTmpHierarchyPosition(){return this._tmpHierarchyPosition}_ResetAllSceneGraphState(){this._BuildTmpSceneGraphData();const e=[...this.children()];for(const t of e)this.RemoveChild(t);const t=this.GetParent();t&&t.RemoveChild(this),this._ClearAllSceneGraphFlags()}_BuildTmpSceneGraphData(){if(this._SetTmpHierarchyPosition(),!this._tmpSceneGraphChildren){const e=[...this.children()];e.length&&(this._tmpSceneGraphChildren=[],this._tmpSceneGraphChildrenIndexes=new WeakMap);let t=0;for(const s of e){const e=s.GetInstance();this._tmpSceneGraphChildren.push(e),this._tmpSceneGraphChildrenIndexes.set(e,t),t++}}const e=this.GetParent();e&&e._BuildTmpSceneGraphData()}_SetTmpHierarchyPosition(){if(-1!==this._tmpHierarchyPosition)return;const e=[...this.parents()];this._tmpHierarchyPosition=e.length;for(const t of e)t._SetTmpHierarchyPosition();const t=[...this.children()];for(const e of t)e._SetTmpHierarchyPosition()}_ReleaseTmpSceneGraphInfo(){this._tmpSceneGraphChildren&&(this._tmpSceneGraphChildren.length=0),this._tmpSceneGraphChildren=null,this._tmpSceneGraphChildrenIndexes=null;const e=this.GetParent();e&&e._ReleaseTmpSceneGraphInfo(),this._tmpHierarchyPosition=-1}HasParent(){return null!==this.GetParent()}GetParent(){const e=this._sceneGraphInfo;return null!==e?e.GetParent():null}GetTopParent(){let e=this;for(;e.HasParent();)e=e.GetParent();return e}*parents(){let e=this.GetParent();for(;e;)yield e,e=e.GetParent()}HasChild(e){return this.GetChildren().includes(e)}HasChildren(){const e=this._sceneGraphInfo;return null!==e&&e.HasChildren()}GetChildren(){const e=this._sceneGraphInfo;return null!==e?e.GetChildren():Iv}children(){return this.GetChildren()}*allChildren(){for(const e of this.children())yield e,yield*e.allChildren()}GetChildCount(){return this.GetChildren().length}GetAllChildCount(){return[...this.allChildren()].length}GetChildAt(e){const t=this.GetChildren();return(e=Math.floor(+e))<0||e>=t.length?null:t[e]}GetChildIndex(e){if(!e)return NaN;const t=this.GetChildren();if(!t)return NaN;for(let s=0;s<t.length;s++)if(e===t[s])return s;return NaN}_CreateSceneGraphInfo(e){this._sceneGraphInfo||(this._sceneGraphInfo=cv.New(cv.SceneGraphInfo,this)),e&&this._sceneGraphInfo.SetParent(e)}_GetSceneGraphInfo(){return this._sceneGraphInfo}_ReleaseSceneGraphInfo(){this._sceneGraphInfo&&(this._sceneGraphInfo.Release(),this._sceneGraphInfo=null)}_SetParent(e){e?(e._CreateSceneGraphInfo(null),this._CreateSceneGraphInfo(e)):(this._sceneGraphInfo&&this._sceneGraphInfo.SetParent(null),this.HasChildren()||this._ReleaseSceneGraphInfo())}_HasAnyParent(e){if(!this.HasParent())return!1;const t=this.GetParent();return t===e||t._HasAnyParent(e)}_HasChildRecursive(e){if(this.HasChild(e))return!0;for(const t of this.GetChildren())if(t._HasChildRecursive(e))return!0;return!1}_AddChildToSceneGraphInfo(e){this._sceneGraphInfo.GetChildren().push(e)}_RemoveChildFromSceneGraphInfo(e){const t=this._sceneGraphInfo.GetChildren(),s=t.indexOf(e);-1!==s&&t.splice(s,1),0!==t.length||this.HasParent()||this._ReleaseSceneGraphInfo(),e.HasChildren()||e._ReleaseSceneGraphInfo()}GetSceneGraphChildrenExportData(){const e=eC.get(this);return e?e.childrenData:null}GetSceneGraphZIndexExportData(){const e=eC.get(this);return e?e.zIndexData:NaN}GetSceneGraphZIndex(){const e=tC.get(this);return cv.IsFiniteNumber(e)?e:NaN}SetSceneGraphZIndex(e){tC.set(this,e)}SetUsePointsShaderProgram(){this._SetFlag(524288,!0),this._UpdateRendererStateGroup()}_UpdateRendererStateGroup(){if(!vv)return;const e=this._runtime.GetRenderer();let t;this._stateGroup&&e.ReleaseStateGroup(this._stateGroup),t=524288&this._flags?e.GetPointsRenderingProgram()||"<point>":e.GetTextureFillShaderProgram()||"<default>",this._stateGroup=e.AcquireStateGroup(t,this.GetBlendMode(),this._colorPremultiplied,this.GetZElevation(),this.IsBackFaceCulling()?1:0,0)}GetRendererStateGroup(){return this._stateGroup}HasDefaultColor(){return this._color===Tv}SetBlendMode(e){if((e|=0)<0||e>31)throw new RangeError("invalid blend mode");this.GetBlendMode()!==e&&(this._flags=-2080374785&this._flags|e<<26,this._UpdateRendererStateGroup())}GetBlendMode(){return(2080374784&this._flags)>>26}_SetLayer(e,t){const s=t&&this._layer!==e;s&&this._RemoveFromRenderCells(),this._objectClass._OnWorldInstanceLayerChanged(this,this._layer,e),this._layer=e,s&&this._UpdateRenderCell(),0!==this.GetZElevation()&&this._layer._SetAnyInstanceZElevated()}GetLayer(){return this._layer}GetLayout(){return this.GetLayer().GetLayout()}_SetZIndex(e){this._zIndex=0|e}GetZIndex(){return this._layer._UpdateZIndices(),this._zIndex}_SetHTMLZIndex(e){this._htmlZIndex=0|e}GetHTMLZIndex(){return this._layer._UpdateHTMLZIndices(),this._htmlZIndex}_GetLastCachedZIndex(){return this._zIndex}_SetFlag(e,t){t?this._flags|=e:this._flags&=~e}IsVisible(){return!!(1&this._flags)}SetVisible(e){if(this._SetFlag(1,e),this.HasChildren())for(const t of this.GetChildren())t.GetTransformWithParentVisibility()&&t.SetVisible(e)}IsCollisionEnabled(){return!!(8&this._flags)}SetCollisionEnabled(e){e=!!e,this.IsCollisionEnabled()!==e&&(this._SetFlag(8,e),e?this.SetBboxChanged():this._RemoveFromCollisionCells())}SetSolidCollisionFilter(e,t){if(this._SetFlag(32,e),this._solidFilterTags&&this._solidFilterTags.clear(),t.trim()){this._solidFilterTags||(this._solidFilterTags=new Set);for(const e of t.split(" "))e&&this._solidFilterTags.add(e.toLowerCase())}else this._solidFilterTags=null}IsSolidCollisionAllowed(e){const t=!!(32&this._flags),s=this._solidFilterTags;if(!e||!s)return!t;for(const i of s)if(e.has(i))return t;return!t}SetBboxChanged(){if(this._flags|=65554,this._objectClass._SetAnyCollisionCellChanged(!0),this._runtime.UpdateRender(),this._layer.UsesRenderCells()&&(this.CalculateBbox(this._boundingBox,this._boundingQuad,!0),this._flags&=-3,this._UpdateRenderCell()),4&this._flags&&this._inst.Dispatcher().dispatchEvent(gv),null!==this._sceneGraphInfo){const e=this._sceneGraphInfo.GetChildren();for(let t=0,s=e.length;t<s;++t)e[t].SetBboxChanged()}}CalculateBbox(e,t,s){const i=this.GetX(),r=this.GetY(),n=this.GetWidth(),a=this.GetHeight(),o=this.GetAngle();e.setWH(i-this._ox*n,r-this._oy*a,n,a),s&&this.HasMesh()&&this._ExpandBboxForMesh(e),0===o?t.setFromRect(e):(e.offset(-i,-r),t.setFromRotatedRectPrecalc(e,this.GetSinAngle(),this.GetCosAngle()),t.offset(i,r),t.getBoundingBox(e)),e.normalize()}_UpdateBbox(){const e=this._flags;2&e&&(this.CalculateBbox(this._boundingBox,this._boundingQuad,!0),this._flags=-3&e)}GetBoundingBox(){return this._UpdateBbox(),this._boundingBox}GetBoundingQuad(){return this._UpdateBbox(),this._boundingQuad}PixelRoundQuad(e){const t=this.GetX(),s=this.GetY(),i=Math.round(t)-t,r=Math.round(s)-s;return 0===i&&0===r?e:(fv.copy(e),fv.offset(i,r),fv)}OverwriteBoundingBox(e){this._boundingBox.copy(e),this._boundingQuad.setFromRect(this._boundingBox),this._flags&=-3,this._UpdateCollisionCell(),this._UpdateRenderCell()}SetBboxChangeEventEnabled(e){this._SetFlag(4,e)}IsBboxChangeEventEnabled(){return!!(4&this._flags)}IsInViewport(e,t,s){return t&&0!==this.GetDepth()?this.IsInViewport3D(this.GetLayer()._GetViewFrustum()):0===this.GetZElevation()||s?e.intersectsRect(this.GetBoundingBox()):this._IsInViewport_ZElevated()}_IsInViewport_ZElevated(){const e=this.GetLayer(),t=this.GetTotalZElevation();return!(t>=e.Get2DCameraZ())&&(e.GetViewportForZ(t,mv),mv.intersectsRect(this.GetBoundingBox()))}IsInViewport3D(e){const t=this.GetBoundingBox(),s=t.getLeft(),i=t.getRight(),r=t.getTop(),n=t.getBottom(),a=this.GetTotalZElevation(),o=a+this.GetDepth();return e.ContainsAABB(s,r,a,i,n,o)}IsInViewport2(){const e=this.GetLayer();if(e.Has3DCamera())return this.IsInViewport3D(e._GetViewFrustum());{const t=e.GetLayout();return this.IsInViewport(e.GetViewport(),t.HasVanishingPointOutsideViewport(),t.IsOrthographicProjection())}}_SetDrawBackFaceOnly(e){this._SetFlag(1048576,e)}_SetDrawNonBackFacesOnly(e){this._SetFlag(2097152,e)}IsDrawBackFaceOnly(){return!!(1048576&this._flags)}IsDrawNonBackFacesOnly(){return!!(2097152&this._flags)}SetBackFaceCulling(e){(e=!!e)!==this.IsBackFaceCulling()&&(this._SetFlag(16777216,e),this._UpdateRendererStateGroup())}IsBackFaceCulling(){return!!(16777216&this._flags)}SetSourceCollisionPoly(e){this._sourceCollisionPoly=e,this._DiscardTransformedCollisionPoly(),this.HasMesh()&&(this._meshInfo.meshPoly=null)}GetSourceCollisionPoly(){return this._sourceCollisionPoly}HasOwnCollisionPoly(){return null!==this._sourceCollisionPoly||this.HasMesh()}GetTransformedCollisionPoly(){return this._GetCustomTransformedCollisionPolyPrecalc(this.GetWidth(),this.GetHeight(),this.GetAngle(),this.GetSinAngle(),this.GetCosAngle())}GetCustomTransformedCollisionPoly(e,t,s){let i=0,r=1;return 0!==s&&(i=Math.sin(s),r=Math.cos(s)),this._GetCustomTransformedCollisionPolyPrecalc(e,t,s,i,r)}_GetCustomTransformedCollisionPolyPrecalc(e,t,s,i,r){let n=this._transformedPolyInfo;null===n&&(n={poly:cv.New(cv.CollisionPoly),width:NaN,height:NaN,angle:NaN},this._transformedPolyInfo=n);const a=n.poly;if(n.width===e&&n.height===t&&n.angle===s)return a;const o=this._sourceCollisionPoly;if(this.HasMesh()){const s=this.GetOriginX(),n=this.GetOriginY(),l=this.GetSourceMesh();let h=this._meshInfo.meshPoly;h||(o?(Sv.copy(o),Sv.offset(s,n)):Sv.setDefaultPoints(),h=l.InsertPolyMeshVertices(Sv),this._meshInfo.meshPoly=h),l.TransformCollisionPoly(h,a),a.offset(-s,-n),a.transformPrecalc(e,t,i,r)}else o?(a.copy(o),a.transformPrecalc(e,t,i,r)):a.setFromQuad(this.GetBoundingQuad(),-this.GetX(),-this.GetY());return n.width=e,n.height=t,n.angle=s,a}_DiscardTransformedCollisionPoly(){this.SetPhysicsBodyChanged(!0);const e=this._transformedPolyInfo;null!==e&&(e.width=NaN)}CreateMesh(e,t){if(e=Math.floor(e),t=Math.floor(t),!this.GetInstance().GetPlugin().SupportsMesh())throw new Error("object does not support mesh");this.ReleaseMesh(),this._meshInfo={sourceMesh:cv.New(cv.Gfx.Mesh,e,t),transformedMesh:cv.New(cv.Gfx.Mesh,e,t),meshPoly:null}}HasMesh(){return null!==this._meshInfo}GetSourceMesh(){if(!this.HasMesh())throw new Error("no mesh");return this._meshInfo.sourceMesh}GetTransformedMesh(){if(!this.HasMesh())throw new Error("no mesh");return this._meshInfo.transformedMesh}SetMeshChanged(e){this._SetFlag(65536,e)}IsMeshChanged(){return!!(65536&this._flags)}SetPhysicsBodyChanged(e){this._SetFlag(131072,e)}IsPhysicsBodyChanged(){return!!(131072&this._flags)}_ExpandBboxForMesh(e){const t=this._meshInfo.sourceMesh,s=Math.min(t.GetMinX(),0),i=Math.min(t.GetMinY(),0),r=Math.max(t.GetMaxX(),1),n=Math.max(t.GetMaxY(),1),a=e.width(),o=e.height();e.offsetLeft(s*a),e.offsetTop(i*o),e.offsetRight((r-1)*a),e.offsetBottom((n-1)*o),this._depth=t.GetMaxZ()}ReleaseMesh(){this._meshInfo&&(this._meshInfo.sourceMesh.Release(),this._meshInfo.transformedMesh.Release(),this._meshInfo=null,this._DiscardTransformedCollisionPoly())}SetMeshPoint(e,t,s){e=Math.floor(e),t=Math.floor(t);const i=s.mode||"absolute";if(!Gv.has(i))throw new Error("invalid mode");const r="relative"===i;let n=s.x,a=s.y;const o=s.zElevation;let l="number"==typeof s.u?s.u:r?0:-1,h="number"==typeof s.v?s.v:r?0:-1;if(!this.HasMesh())return!1;const u=this.GetSourceMesh(),c=u.GetMeshPointAt(e,t);if(null===c)return!1;let d=!1;return"number"==typeof o&&c.GetZElevation()!==o&&(c.SetZElevation(o),d=!0),r&&(n+=e/(u.GetHSize()-1),a+=t/(u.GetVSize()-1)),-1!==l||r?(r&&(l+=e/(u.GetHSize()-1)),l=cv.clamp(l,0,1)):l=c.GetU(),-1!==h||r?(r&&(h+=t/(u.GetVSize()-1)),h=cv.clamp(h,0,1)):h=c.GetV(),c.GetX()===n&&c.GetY()===a&&c.GetU()===l&&c.GetV()===h?d:(c.SetX(n),c.SetY(a),c.SetU(l),c.SetV(h),this._DiscardTransformedCollisionPoly(),!0)}HasTilemap(){return this._inst.HasTilemap()}ContainsPoint(e,t){return!!this.GetBoundingBox().containsPoint(e,t)&&!!this.GetBoundingQuad().containsPoint(e,t)&&(this.HasTilemap()?this._inst.GetSdkInstance().TestPointOverlapTile(e,t):!this.HasOwnCollisionPoly()||this.GetTransformedCollisionPoly().containsPoint(e-this.GetX(),t-this.GetY()))}_IsCollisionCellChanged(){return!!(16&this._flags)}_UpdateCollisionCell(){if(!this._IsCollisionCellChanged()||!this.IsCollisionEnabled()||256&this._flags)return;const e=this.GetBoundingBox(),t=this._objectClass._GetCollisionCellGrid(),s=this._collisionCells;if(mv.set(t.XToCell(e.getLeft()),t.YToCell(e.getTop()),t.XToCell(e.getRight()),t.YToCell(e.getBottom())),s.equals(mv))return;const i=this._inst;s===bv?(t.Update(i,null,mv),this._collisionCells=cv.New(cv.Rect,mv)):(t.Update(i,s,mv),s.copy(mv)),this._flags&=-17}_SetCollisionCellChanged(){this._flags|=16}_RemoveFromCollisionCells(){const e=this._collisionCells;e!==bv&&(this._objectClass._GetCollisionCellGrid().Update(this._inst,e,null),this._collisionCells=bv)}_UpdateRenderCell(){const e=this.GetLayer();if(!e.UsesRenderCells()||256&this._flags)return;const t=e.GetRenderGrid(),s=this.GetBoundingBox(),i=this._renderCells;if(mv.set(t.XToCell(s.getLeft()),t.YToCell(s.getTop()),t.XToCell(s.getRight()),t.YToCell(s.getBottom())),i.equals(mv))return;const r=this._inst;i===xv?(t.Update(r,null,mv),this._renderCells=cv.New(cv.Rect,mv)):(t.Update(r,i,mv),i.copy(mv)),e.SetRenderListStale()}_RemoveFromRenderCells(){const e=this._renderCells;e!==xv&&(this.GetLayer().GetRenderGrid().Update(this._inst,e,null),this._renderCells=xv)}GetRenderCellRange(){return this._renderCells}ZOrderMoveToTop(){const e=this._inst,t=this._layer,s=t._GetInstances();s.length&&s.at(-1)===e||(t._RemoveInstance(e,!1),t._AddInstance(e,!1),this._runtime.UpdateRender())}ZOrderMoveToBottom(){const e=this._inst,t=this._layer,s=t._GetInstances();s.length&&s[0]===e||(t._RemoveInstance(e,!1),t._PrependInstance(e,!1),this._runtime.UpdateRender())}ZOrderMoveToLayer(e){const t=this._inst,s=this._layer;if(s.GetLayout()!==e.GetLayout())throw new Error("layer from different layout");e!==s&&(s._RemoveInstance(t,!0),this._SetLayer(e),e._AddInstance(t,!0),this._runtime.UpdateRender())}ZOrderMoveAdjacentToInstance(e,t){const s=this._inst;let i=!1;const r=this._layer;if(e.GetUID()===s.GetUID())return;const n=e.GetWorldInfo();if(!n)throw new Error("expected world instance");const a=n.GetLayer();r.GetIndex()!==a.GetIndex()&&(r._RemoveInstance(s,!0),this._SetLayer(a),a._AddInstance(s,!0),i=!0);const o=a.MoveInstanceAdjacent(s,e,!!t);(i||o)&&this._runtime.UpdateRender()}GetInstanceEffectList(){return this._instanceEffectList}_SetHasAnyActiveEffect(e){this._SetFlag(64,e)}HasAnyActiveEffect(){return!!(64&this._flags)}_SaveToJson(e,t=null){const s={x:this.GetX(),y:this.GetY(),w:this.GetWidth(),h:this.GetHeight(),l:this.GetLayer().GetSID(),zi:this.GetZIndex()};0!==this.GetZElevation()&&(s.ze=this.GetZElevation()),0!==this.GetAngle()&&(s.a=this._GetAngleNoReflect()),this.HasDefaultColor()||(s.c=this._color.toJSON()),.5!==this.GetOriginX()&&(s.oX=this.GetOriginX()),.5!==this.GetOriginY()&&(s.oY=this.GetOriginY()),0!==this.GetBlendMode()&&(s.bm=this.GetBlendMode()),this.IsVisible()||(s.v=this.IsVisible()),this.IsCollisionEnabled()||(s.ce=this.IsCollisionEnabled()),this.IsBboxChangeEventEnabled()&&(s.be=this.IsBboxChangeEventEnabled()),this._instanceEffectList&&(s.fx=this._instanceEffectList._SaveToJson());const i=!!(32&this._flags);return i&&(s.sfi=i),this._solidFilterTags&&(s.sft=[...this._solidFilterTags].join(" ")),this._sceneGraphInfo&&"visual-state"!==e&&(s.sgi=this._sceneGraphInfo._SaveToJson(e,t),eC.has(this)&&(s.sgcd=eC.get(this).childrenData,s.sgzid=eC.get(this).zIndexData)),this.HasMesh()&&(s.mesh=this.GetSourceMesh().SaveToJson()),s}_SaveSceneGraphPropertiesToJson(){return{x:this._x,y:this._y,z:this._zElevation,w:this._w,h:this._h,a:this._a,sgi:this._GetSceneGraphInfo()?this._GetSceneGraphInfo()._SaveToJsonProperties():null}}_LoadSceneGraphPropertiesFromJson(e){e&&(this._x=e.x,this._y=e.y,this._zElevation=e.z,this._w=e.w,this._h=e.h,this._a=e.a,e.sgi&&this._GetSceneGraphInfo()&&this._GetSceneGraphInfo()._LoadFromJson(e.sgi),this._MarkSinCosAngleChanged(),this.SetBboxChanged())}_SetupSceneGraphConnectionsOnChangeOfLayout(){this._ReleaseTmpSceneGraphInfo(),this._ResetAllSceneGraphState(),this._CreateSceneGraphInfo(null),this._sceneGraphInfo&&this._sceneGraphInfo._SetTmpSceneGraphChildren(this._tmpSceneGraphChildren,this._tmpSceneGraphChildrenIndexes)}_OnBeforeLoad(e){"visual-state"!==e&&this._ResetAllSceneGraphState()}_OnAfterLoad(e,t="full",s=null){if(e.hasOwnProperty("sgi")&&"visual-state"!==t){if(256&this._flags)return;this._sceneGraphInfo._OnAfterLoad(e.sgi,s)}}_OnAfterLoad2(e,t="full",s=null){if("visual-state"!==t)if(256&this._flags)this._ReleaseTmpSceneGraphInfo();else{if(e.hasOwnProperty("sgi"))this._sceneGraphInfo._SetTmpSceneGraphChildren(null,null,e.sgi,s);else if(s?.setFromJson&&this._tmpSceneGraphChildren)for(const e of this._tmpSceneGraphChildren)e.IsDestroyed()||this._runtime.DestroyInstance(e);this._ReleaseTmpSceneGraphInfo(),this.SetBboxChanged()}}_LoadFromJson(e,t,s=null){if(vv=!1,this.SetX(e.x),this.SetY(e.y),this.SetWidth(e.w),this.SetHeight(e.h),this._SetZIndex(e.zi),this.SetZElevation(e.hasOwnProperty("ze")?e.ze:0),this.SetAngle(e.hasOwnProperty("a")?e.a:0),e.hasOwnProperty("c")?yv.setFromJSON(e.c):e.hasOwnProperty("o")?(yv.copyRgb(this._color),yv.a=e.o):yv.setRgba(1,1,1,1),this._SetColor(yv),this.SetOriginX(e.hasOwnProperty("oX")?e.oX:.5),this.SetOriginY(e.hasOwnProperty("oY")?e.oY:.5),this.SetBlendMode(e.hasOwnProperty("bm")?e.bm:0),this.SetVisible(!e.hasOwnProperty("v")||e.v),this.SetCollisionEnabled(!e.hasOwnProperty("ce")||e.ce),this.SetBboxChangeEventEnabled(!!e.hasOwnProperty("be")&&e.be),this.SetSolidCollisionFilter(!!e.hasOwnProperty("sfi")&&e.sfi,e.hasOwnProperty("sft")?e.sft:""),this._instanceEffectList&&e.hasOwnProperty("fx")&&this._instanceEffectList._LoadFromJson(e.fx),e.hasOwnProperty("sgi")&&"visual-state"!==t){this._CreateSceneGraphInfo(null);const t=this._sceneGraphInfo,s=e.sgi;t._LoadFromJson(s),t._SetTmpSceneGraphChildren(this._tmpSceneGraphChildren,this._tmpSceneGraphChildrenIndexes),this._SetSceneGraphExportData(e.sgcd,e.sgzid)}if(e.hasOwnProperty("mesh")){const t=e.mesh;this.CreateMesh(t.cols,t.rows),this.GetSourceMesh().LoadFromJson(t)}else this.ReleaseMesh();this.SetBboxChanged(),vv=!0,this._UpdateRendererStateGroup(),"visual-state"!==t&&this._runtime.AddInstanceNeedingAfterLoad(this.GetInstance(),e)}_SetSceneGraphExportData(e,t){e&&cv.IsFiniteNumber(t)&&eC.set(this,{childrenData:e,zIndexData:t})}}}{const sC=self.C3;sC.BehaviorType=class extends sC.DefendedBase{constructor(e,t){super();const s=e.GetRuntime(),i=s.GetObjectReference(t[1]);s.GetAddonManager()._DelayCreateBehavior(i),this._runtime=s,this._objectClass=e,this._behavior=sC.AddonManager.GetBehaviorByConstructorFunction(i),this._sdkType=null,this._iBehaviorType=null,this._instSdkCtor=i.Instance,this._sid=t[2],this._name=t[0],this._jsPropName=this._runtime.GetJsPropName(t[3]);const r=this._behavior.GetSdkVersion();if(r<2&&(this._sdkType=sC.New(i.Type,this),!(this._sdkType instanceof sC.SDKBehaviorTypeBase)))throw new Error("v1 sdk type must derive from SDKBehaviorBase");if(sC.AddonManager._PushInitObject(this,r),r>=2){const e=i.Type??globalThis.ISDKBehaviorTypeBase;if(this._iBehaviorType=new e,!(this._iBehaviorType instanceof globalThis.ISDKBehaviorTypeBase))throw new Error("script interface class must derive from ISDKBehaviorTypeBase")}else this._iBehaviorType=new globalThis.IBehaviorType;sC.AddonManager._PopInitObject(r),this.OnCreate()}static Create(e,t){return sC.New(sC.BehaviorType,e,t)}Release(){this._runtime=null,this._behavior=null,this._sdkType&&(this._sdkType.Release(),this._sdkType=null),this._instSdkCtor=null}GetSdkType(){return this._sdkType}OnCreate(){this._sdkType?this._sdkType.OnCreate():this._iBehaviorType&&this._iBehaviorType._onCreate()}GetRuntime(){return this._runtime}GetObjectClass(){return this._objectClass}GetBehavior(){return this._behavior}GetInstanceSdkCtor(){return this._instSdkCtor}GetName(){return this._name}GetSID(){return this._sid}GetIBehaviorType(){return this._iBehaviorType}GetJsPropName(){return this._jsPropName}}}{const iC=self.C3,rC=self.IBehaviorInstance;iC.BehaviorInstance=class extends iC.DefendedBase{constructor(e){super(),this._runtime=e.runtime,this._behaviorType=e.behaviorType,this._behavior=this._behaviorType.GetBehavior(),this._inst=e.instance,this._index=e.index,this._sdkInst=null,this._iScriptInterface=null,this._behavior._AddInstance(this._inst)}Release(){this._iScriptInterface&&(this._iScriptInterface._release(),this._iScriptInterface=null),this._behavior._RemoveInstance(this._inst),this._sdkInst&&(this._sdkInst.Release(),this._sdkInst=null),this._runtime=null,this._behaviorType=null,this._behavior=null,this._inst=null}_CreateSdkInstance(e){if(this._sdkInst)throw new Error("already got sdk instance");if(this.GetBehavior().GetSdkVersion()<2){if(this._sdkInst=iC.New(this._behaviorType.GetInstanceSdkCtor(),this,e),!(this._sdkInst instanceof iC.SDKBehaviorInstanceBase))throw new Error("v1 sdk type must derive from SDKBehaviorInstanceBase")}else{const t=this.GetBehavior().GetScriptInterfaceClass();this._InitScriptInterface(t.Instance,e)}}GetSdkInstance(){return this._sdkInst??this._iScriptInterface}GetObjectInstance(){return this._inst}GetRuntime(){return this._runtime}GetBehaviorType(){return this._behaviorType}GetBehavior(){return this._behavior}_GetIndex(){return this._index}PostCreate(){this._sdkInst?this._sdkInst.PostCreate():this._iScriptInterface._postCreate()}OnSpriteFrameChanged(e,t){this._sdkInst&&this._sdkInst.OnSpriteFrameChanged(e,t)}_GetDebuggerProperties(){return this._sdkInst?this._sdkInst.GetDebuggerProperties():this._iScriptInterface._getDebuggerProperties()}SaveToJson(e="full"){return this._sdkInst?this._sdkInst.SaveToJson(e):this._iScriptInterface._saveToJson(e)}LoadFromJson(e,t="full"){if(this._sdkInst)return this._sdkInst.LoadFromJson(e,t);this._iScriptInterface._loadFromJson(e,t)}static SortByTickSequence(e,t,s){const i=globalThis.ISDKBehaviorInstanceBase;let r,n;r=t instanceof i?e._UnwrapScriptInterface(t):t.GetBehaviorInstance(),n=s instanceof i?e._UnwrapScriptInterface(s):s.GetBehaviorInstance();const a=r.GetObjectInstance(),o=n.GetObjectInstance(),l=a.GetObjectClass().GetIndex(),h=o.GetObjectClass().GetIndex();if(l!==h)return l-h;const u=a.GetPUID(),c=o.GetPUID();return u!==c?u-c:r._GetIndex()-n._GetIndex()}_InitScriptInterface(e,t){const s=rC,i=e??this._sdkInst.GetScriptInterfaceClass(),r=i||s,n=this.GetBehavior().GetSdkVersion();if(iC.AddonManager._PushInitObject(this,n),iC.AddonManager._PushInitProperties(t),this._iScriptInterface=new r,iC.AddonManager._PopInitProperties(),iC.AddonManager._PopInitObject(n),i&&!(this._iScriptInterface instanceof s))throw new TypeError(`script interface class '${i.name}' does not extend the right base class '${s.name}'`);return this._iScriptInterface}GetScriptInterface(){return this._iScriptInterface||this._InitScriptInterface()}HasScriptInterface(){return!!this._iScriptInterface}}}{const nC=self.C3;nC.EffectList=class extends nC.DefendedBase{constructor(e,t){super(),this._owner=e,this._allEffectTypes=[],this._activeEffectTypes=[],this._effectTypesByName=new Map,this._effectParams=[],this._effectParamBuffers=[],this._allInstanceEffectLists=new Set,this._preservesOpaqueness=!0;for(const e of t){const t=nC.New(nC.EffectType,this,e,this._allEffectTypes.length);this._allEffectTypes.push(t),this._effectTypesByName.set(t.GetName().toLowerCase(),t),e.length>=3&&this._effectParams.push(this._LoadSingleEffectParameters(t,e[2]))}this.GetRuntime()._AddEffectList(this)}Release(){this.GetRuntime()._RemoveEffectList(this);for(const e of this._effectParamBuffers)e.Release();nC.clearArray(this._effectParamBuffers),nC.clearArray(this._allEffectTypes),nC.clearArray(this._activeEffectTypes),this._effectTypesByName.clear(),nC.clearArray(this._effectParams),this._owner=null}_AddInstanceEffectList(e){this._allInstanceEffectLists.add(e)}_RemoveInstanceEffectList(e){this._allInstanceEffectLists.delete(e)}_InitRenderer(e){e.IsWebGPU()&&(this._effectParamBuffers=this._allEffectTypes.map(e=>{const t=e.GetShaderProgram();return t.GetCustomParametersByteSize()>0?nC.New(nC.Gfx.WebGPUEffectCustomParamsBuffer,t):null}),this._UpdateAllEffectParamBuffers());for(const t of this._allInstanceEffectLists)t._InitRenderer(e)}PrependEffectTypes(e){if(e.length){this._allEffectTypes=e.concat(this._allEffectTypes);for(const t of e)this._effectTypesByName.set(t.GetName().toLowerCase(),t);for(let e=0,t=this._allEffectTypes.length;e<t;++e)this._allEffectTypes[e]._SetIndex(e)}}_LoadSingleEffectParameters(e,t){e.SetActive(t[0]);const s=t.slice(1);for(let e=0,t=s.length;e<t;++e){const t=s[e];if(Array.isArray(t)){const i=nC.New(nC.Color);i.setFromJSON(t),s[e]=i}}return s}GetOwner(){return this._owner}GetRuntime(){return this._owner.GetRuntime()}UpdateActiveEffects(){nC.clearArray(this._activeEffectTypes);let e=!0;for(const t of this._allEffectTypes)t.IsActive()&&(this._activeEffectTypes.push(t),t.GetShaderProgram().PreservesOpaqueness()||(e=!1));this._preservesOpaqueness=e}GetAllEffectTypes(){return this._allEffectTypes}HasAnyEffectType(){return this._allEffectTypes.length>0}GetEffectTypeByName(e){return this._effectTypesByName.get(e.toLowerCase())||null}GetEffectTypeByIndex(e){if((e=Math.floor(+e))<0||e>=this._allEffectTypes.length)throw new RangeError("invalid effect type index");return this._allEffectTypes[e]}IsEffectIndexActive(e){return this.GetEffectTypeByIndex(e).IsActive()}SetEffectIndexActive(e,t){this.GetEffectTypeByIndex(e).SetActive(t)}GetActiveEffectTypes(){return this._activeEffectTypes}HasAnyActiveEffect(){return this._activeEffectTypes.length>0}PreservesOpaqueness(){return this._preservesOpaqueness}GetEffectParametersForIndex(e){return this._effectParams[e]}_GetEffectChainShaderParametersForIndex(e){return e<this._effectParamBuffers.length?this._effectParamBuffers[e]:this._effectParams[e]}GetEffectParameter(e,t){if(e<0||e>=this._effectParams.length)return null;const s=this._effectParams[e];return t<0||t>=s.length?null:s[t]}SetEffectParameter(e,t,s){if(e<0||e>=this._effectParams.length)return!1;const i=this._effectParams[e];if(t<0||t>=i.length)return!1;const r=i[t];if(r instanceof nC.Color){if(r.equalsIgnoringAlpha(s))return!1;r.copyRgb(s)}else{if(r===s)return!1;i[t]=s}return e<this._effectParamBuffers.length&&this._effectParamBuffers[e].SetParameterValue(t,s),!0}_UpdateAllEffectParamBuffers(){const e=this._effectParams,t=this._effectParamBuffers;for(let s=0,i=Math.min(e.length,t.length);s<i;++s){const i=t[s],r=e[s];for(let e=0,t=r.length;e<t;++e)i.SetParameterValue(e,r[e])}}static SaveFxParamToJson(e){return e&&e instanceof nC.Color?{t:"color",v:e.toJSON()}:e}static LoadFxParamFromJson(e){if(null===e)return NaN;if("object"==typeof e){if("color"===e.t){const t=nC.New(nC.Color);return t.setFromJSON(e.v),t}throw new Error("invalid effect parameter type")}return e}static SaveFxParamsToJson(e){return e.map(nC.EffectList.SaveFxParamToJson)}static LoadFxParamsFromJson(e){return e.map(nC.EffectList.LoadFxParamFromJson)}SaveToJson(){return this._allEffectTypes.map(e=>({name:e.GetName(),active:e.IsActive(),params:nC.EffectList.SaveFxParamsToJson(this._effectParams[e.GetIndex()])}))}LoadFromJson(e){for(const t of e){const e=this.GetEffectTypeByName(t.name);e&&(e.SetActive(t.active),this._effectParams[e.GetIndex()]=nC.EffectList.LoadFxParamsFromJson(t.params))}this.UpdateActiveEffects(),this._UpdateAllEffectParamBuffers()}}}{const aC=self.C3;aC.EffectType=class extends aC.DefendedBase{constructor(e,t,s){super(),this._effectList=e,this._id=t[0],this._name=t[1],this._index=s,this._shaderProgram=null,this._isActive=!0}Release(){this._effectList=null,this._shaderProgram=null}Clone(e){const t=aC.New(aC.EffectType,e,[this._id,this._name],-1);return t._shaderProgram=this._shaderProgram,t._isActive=this._isActive,t}_InitRenderer(e){const t=e.GetShaderProgramByName(this._id);if(!t)throw new Error("failed to find shader program '"+this._id+"'");this._shaderProgram=t}GetEffectList(){return this._effectList}GetName(){return this._name}_SetIndex(e){this._index=e}GetIndex(){return this._index}GetOwner(){return this._effectList.GetOwner()}GetRuntime(){return this._effectList.GetRuntime()}SetActive(e){this._isActive=!!e}IsActive(){return this._isActive}GetShaderProgram(){return this._shaderProgram}GetDefaultParameterValues(){const e=[];for(let t=0,s=this._shaderProgram.GetParameterCount();t<s;++t){const s=this._shaderProgram.GetParameterType(t);if("float"===s||"percent"===s)e.push(0);else{if("color"!==s)throw new TypeError("unknown effect parameter type");e.push(aC.New(aC.Color,1,1,1,1))}}return e}}}{const oC=self.C3;oC.InstanceEffectList=class extends oC.DefendedBase{constructor(e,t){super(),this._inst=e,this._wi=t,this._effectList=e.GetObjectClass().GetEffectList(),this._needsRebuildSteps=!0,this._wasDefaultColor=!0,this._was3D=!1,this._wasRotatedOrNegativeSize=!1,this._wasTexRotated=!1,this._wasMustPreDraw=!1,this._effectChain=oC.New(oC.Gfx.EffectChain,e.GetRuntime().GetCanvasManager().GetEffectChainManager(),{drawContent:(e,t)=>{const s=t.GetContentObject(),i=s.GetWorldInfo();e.SetColor(i.GetPremultipliedColor()),e.SetCurrentZ(i.GetTotalZElevation()),s.Draw(e),e.SetCurrentZ(0)},getSourceTextureInfo:e=>{const t=e.GetCurrentTexRect(),[s,i]=e.GetCurrentSurfaceSize();return{srcTexRect:t,srcWidth:s,srcHeight:i}},getShaderParameters:e=>this._GetEffectChainShaderParametersForIndex(e)}),this._activeEffectFlags=[],this._activeEffectTypes=[],this._preservesOpaqueness=!0,this._effectParams=[],this._effectParamBuffers=[],this._InitRenderer(e.GetRuntime().GetRenderer());for(let e=0,t=this._effectList.GetAllEffectTypes().length;e<t;++e)this._activeEffectFlags.push(!0);this.UpdateActiveEffects(),this._effectList._AddInstanceEffectList(this)}Release(){this._effectList._RemoveInstanceEffectList(this);for(const e of this._effectParamBuffers)e&&e.Release();oC.clearArray(this._effectParamBuffers),this._effectChain.Release(),this._effectChain=null,oC.clearArray(this._activeEffectFlags),oC.clearArray(this._activeEffectTypes),oC.clearArray(this._effectParams),this._inst=null,this._effectList=null}_InitRenderer(e){e.IsWebGPU()&&(this._effectParamBuffers=this._effectList.GetAllEffectTypes().map(e=>{const t=e.GetShaderProgram();return t.GetCustomParametersByteSize()>0?oC.New(oC.Gfx.WebGPUEffectCustomParamsBuffer,t):null}))}_LoadEffectParameters(e){let t=0;for(const s of e)this._effectParams.push(this._LoadSingleEffectParameters(t,s)),++t;this._UpdateAllEffectParamBuffers(),this.UpdateActiveEffects()}_LoadSingleEffectParameters(e,t){this._activeEffectFlags[e]=t[0];const s=t.slice(1);for(let e=0,t=s.length;e<t;++e){const t=s[e];if(Array.isArray(t)){const i=oC.New(oC.Color);i.setFromJSON(t),s[e]=i}}return s}LoadDefaultEffectParameters(){for(const e of this._effectList.GetAllEffectTypes())this._effectParams.push(e.GetDefaultParameterValues());this._UpdateAllEffectParamBuffers()}GetOwner(){return this._owner}GetEffectList(){return this._effectList}GetEffectChain(){return this._MaybeRebuildEffectChainSteps(),this._effectChain}GetRuntime(){return this._inst.GetRuntime()}UpdateActiveEffects(){oC.clearArray(this._activeEffectTypes);const e=this._wi,t=this._effectList.GetAllEffectTypes(),s=this._activeEffectTypes,i=this._activeEffectFlags;let r=!0;for(let e=0,n=t.length;e<n;++e)if(i[e]){const i=t[e];s.push(i),i.GetShaderProgram().PreservesOpaqueness()||(r=!1)}this._preservesOpaqueness=r,e._SetHasAnyActiveEffect(!!s.length),this._needsRebuildSteps=!0}_MaybeRebuildEffectChainSteps(){const e=this._inst,t=this._wi,s=t.HasDefaultColor(),i=e.GetPlugin().Is3D(),r=0!==t.GetAngle()||0!==t.GetLayer().GetAngle()||t.GetWidth()<0||t.GetHeight()<0,n=e.IsCurrentTexRotated(),a=e.MustPreDraw();(this._needsRebuildSteps||s!==this._wasDefaultColor||i!==this._was3D||r!==this._wasRotatedOrNegativeSize||n!==this._wasTexRotated||a!==this._wasMustPreDraw||this._effectChain.NeedsRebuild())&&(this._effectChain.BuildSteps(this._activeEffectTypes.map(e=>e.GetShaderProgram()),{indexMap:this._activeEffectTypes.map(e=>e.GetIndex()),forcePreDraw:!s||a,is3D:i,isSourceTextureRotated:n,isRotatedOrNegativeSizeInstance:r}),this._needsRebuildSteps=!1,this._wasDefaultColor=s,this._was3D=i,this._wasRotatedOrNegativeSize=r,this._wasTexRotated=n,this._wasMustPreDraw=a)}GetActiveEffectTypes(){return this._activeEffectTypes}GetEffectParametersForIndex(e){return this._effectParams[e]}_GetEffectChainShaderParametersForIndex(e){return e<this._effectParamBuffers.length?this._effectParamBuffers[e]:this._effectParams[e]}GetEffectParameter(e,t){if(e<0||e>=this._effectParams.length)return null;const s=this._effectParams[e];return t<0||t>=s.length?null:s[t]}SetEffectParameter(e,t,s){if(e<0||e>=this._effectParams.length)return!1;const i=this._effectParams[e];if(t<0||t>=i.length)return!1;const r=i[t];if(r instanceof oC.Color){if(r.equalsIgnoringAlpha(s))return!1;r.copyRgb(s)}else{if(r===s)return!1;i[t]=s}return e<this._effectParamBuffers.length&&this._effectParamBuffers[e].SetParameterValue(t,s),!0}_UpdateAllEffectParamBuffers(){const e=this._effectParams,t=this._effectParamBuffers;for(let s=0,i=t.length;s<i;++s){const i=t[s],r=e[s];for(let e=0,t=r.length;e<t;++e)i.SetParameterValue(e,r[e])}}PreservesOpaqueness(){return this._preservesOpaqueness}HasAnyActiveBackgroundBlendingEffect(){return this._activeEffectTypes.some(e=>e.GetShaderProgram().BlendsBackground())}IsEffectIndexActive(e){return this._activeEffectFlags[e]}SetEffectIndexActive(e,t){this._activeEffectFlags[e]=!!t}GetAllEffectTypes(){return this._effectList.GetAllEffectTypes()}_SaveToJson(){return this._effectList.GetAllEffectTypes().map(e=>({name:e.GetName(),active:this._activeEffectFlags[e.GetIndex()],params:oC.EffectList.SaveFxParamsToJson(this._effectParams[e.GetIndex()])}))}_LoadFromJson(e){for(const t of e){const e=this._effectList.GetEffectTypeByName(t.name);e&&(this._activeEffectFlags[e.GetIndex()]=t.active,this._effectParams[e.GetIndex()]=oC.EffectList.LoadFxParamsFromJson(t.params))}this.UpdateActiveEffects(),this._UpdateAllEffectParamBuffers()}}}{const lC=self.C3,hC=[],uC=[],cC=[],dC=lC.New(lC.CollisionPoly),pC=lC.New(lC.CollisionPoly),_C=lC.New(lC.Quad),mC=lC.New(lC.Rect),fC=lC.New(lC.Rect);let gC=null,yC=null,SC=null;lC.CollisionEngine=class extends lC.DefendedBase{constructor(e){super(),this._runtime=e,this._collisionCellWidth=0,this._collisionCellHeight=0,this._registeredCollisions=[],this._collisionCheckCount=0,this._collisionCheckSec=0,this._polyCheckCount=0,this._polyCheckSec=0,this._iCollisionEngine=new self.ICollisionEngine(this)}Release(){this._runtime=null}GetRuntime(){return this._runtime}GetICollisionEngine(){return this._iCollisionEngine}_Update1sStats(){this._collisionCheckSec=this._collisionCheckCount,this._collisionCheckCount=0,this._polyCheckSec=this._polyCheckCount,this._polyCheckCount=0}Get1secCollisionChecks(){return this._collisionCheckSec}Get1secPolyChecks(){return this._polyCheckSec}RegisterCollision(e,t){const s=e.GetWorldInfo(),i=t.GetWorldInfo();s&&i&&s.IsCollisionEnabled()&&i.IsCollisionEnabled()&&this._registeredCollisions.push([e,t])}AddRegisteredCollisionCandidates(e,t,s){for(const[i,r]of this._registeredCollisions){let n=null;if(e===i)n=r;else{if(e!==r)continue;n=i}n.BelongsToObjectClass(t)&&(s.includes(n)||s.push(n))}}CheckRegisteredCollision(e,t){if(!this._registeredCollisions.length)return!1;for(const[s,i]of this._registeredCollisions)if(e===s&&t===i||e===i&&t===s)return!0;return!1}ClearRegisteredCollisions(){lC.clearArray(this._registeredCollisions)}TestOverlap(e,t){if(!e||!t||e===t)return!1;const s=e.GetWorldInfo(),i=t.GetWorldInfo();if(!s.IsCollisionEnabled()||!i.IsCollisionEnabled())return!1;this._collisionCheckCount++;const r=s.GetLayer(),n=i.GetLayer();return r.IsTransformCompatibleWith(n)?this._TestOverlap_SameLayers(s,i):this._TestOverlap_DifferentLayers(s,i)}_TestOverlap_SameLayers(e,t){if(!e.GetBoundingBox().intersectsRect(t.GetBoundingBox()))return!1;if(this._polyCheckCount++,!e.GetBoundingQuad().intersectsQuad(t.GetBoundingQuad()))return!1;if(e.HasTilemap()&&t.HasTilemap())return!1;if(e.HasTilemap())return this.TestTilemapOverlap(e,t);if(t.HasTilemap())return this.TestTilemapOverlap(t,e);if(!e.HasOwnCollisionPoly()&&!t.HasOwnCollisionPoly())return!0;const s=e.GetTransformedCollisionPoly(),i=t.GetTransformedCollisionPoly();return s.intersectsPoly(i,t.GetX()-e.GetX(),t.GetY()-e.GetY())}_TestOverlap_DifferentLayers(e,t){const s=e.HasTilemap(),i=t.HasTilemap();if(s&&!i)return this.TestTilemapOverlapDifferentLayers(e,t);if(i&&!s)return this.TestTilemapOverlapDifferentLayers(t,e);if(i||s)return!1;{const s=e.GetLayer(),i=t.GetLayer();dC.copy(e.GetTransformedCollisionPoly()),pC.copy(t.GetTransformedCollisionPoly());const r=dC.pointsArr();for(let t=0,i=r.length;t<i;t+=2){const i=t+1,n=r[t],a=r[i],[o,l]=s.LayerToCanvasCss(n+e.GetX(),a+e.GetY());r[t]=o,r[i]=l}const n=pC.pointsArr();for(let e=0,s=n.length;e<s;e+=2){const s=e+1,r=n[e],a=n[s],[o,l]=i.LayerToCanvasCss(r+t.GetX(),a+t.GetY());n[e]=o,n[s]=l}return dC.setBboxChanged(),pC.setBboxChanged(),this._polyCheckCount++,dC.intersectsPoly(pC,0,0)}}TestTilemapOverlapDifferentLayers(e,t){const s=e.GetLayer(),i=t.GetLayer();gC||(gC=lC.New(lC.CollisionPoly)),yC||(yC=lC.New(lC.Rect)),SC||(SC=lC.New(lC.Quad));const r=t.GetX(),n=t.GetY(),[a,o]=i.LayerToCanvasCss(r,n),[l,h]=s.CanvasCssToLayer(a,o),u=l-r,c=h-n;if(yC.copy(t.GetBoundingBox()),yC.offset(u,c),!e.GetBoundingBox().intersectsRect(yC))return!1;if(SC.copy(t.GetBoundingQuad()),SC.offset(u,c),this._polyCheckCount++,!e.GetBoundingQuad().intersectsQuad(SC))return!1;gC.copy(t.GetTransformedCollisionPoly());const d=gC.pointsArr();for(let e=0,t=d.length;e<t;e+=2){const t=e+1;d[e]+=u,d[t]+=c}return gC.setBboxChanged(),this.TestTilemapOverlap(e,t,l,h,gC,yC,SC)}TestTilemapOverlap(e,t,s,i,r,n,a){const o=void 0!==n?n:t.GetBoundingBox(),l=e.GetX(),h=e.GetY(),u=e.GetInstance().GetSdkInstance(),c=void 0!==s?s:t.GetX(),d=void 0!==i?i:t.GetY(),p=t.HasOwnCollisionPoly(),_=void 0!==a?a:t.GetBoundingQuad(),m=uC;u.GetCollisionRectCandidates(o,m);for(let e=0,s=m.length;e<s;++e){const s=m[e],i=s.GetRect();if(this._collisionCheckCount++,o.intersectsRectOffset(i,l,h)&&(_C.setFromRect(i),_C.offset(l,h),_C.intersectsQuad(_)))if(p){const e=void 0!==r?r:t.GetTransformedCollisionPoly();let n=c,a=d;void 0!==r&&(n=t.GetX(),a=t.GetY());const o=s.GetPoly();if(o){if(this._polyCheckCount++,o.intersectsPoly(e,n-(l+i.getLeft()),a-(h+i.getTop())))return lC.clearArray(m),!0}else if(dC.setFromQuad(_C,0,0),dC.intersectsPoly(e,n,a))return lC.clearArray(m),!0}else{const e=s.GetPoly();if(!e)return lC.clearArray(m),!0;if(dC.setFromQuad(_,0,0),e.intersectsPoly(dC,-(l+i.getLeft()),-(h+i.getTop())))return lC.clearArray(m),!0}}return lC.clearArray(m),!1}TestAndSelectCanvasPointOverlap(e,t,s){const i=e.GetCurrentSol(),r=this._runtime.GetCurrentEvent();if(!r)throw new Error("cannot call outside event");const n=r.IsOrBlock(),a=new lC.LayerStateCache;if(i.IsSelectAll()){s||(i._SetSelectAll(!1),lC.clearArray(i._GetOwnInstances())),n&&lC.clearArray(i._GetOwnElseInstances());for(const r of e.GetInstances()){const e=r.GetWorldInfo(),o=e.GetLayer();let l=!1;if(a.IsInteractive(o)&&e.IsInViewport2()&&(l=t.some(([t,s])=>{const[i,r]=a.CanvasCssToLayer(o,t,s,e.GetTotalZElevation());return e.ContainsPoint(i,r)})),l){if(s)return!1;i._PushInstance(r)}else n&&i._PushElseInstance(r)}}else{let e,o=!1;n&&!r.IsFirstConditionOfType(this._runtime.GetCurrentCondition())?this._runtime.IsCurrentConditionFirst()&&!i._GetOwnElseInstances().length&&i._GetOwnInstances().length?e=i._GetOwnInstances():(e=i._GetOwnElseInstances(),o=!0):e=i._GetOwnInstances();let l=0;for(let r=0,h=e.length;r<h;++r){const h=e[r],u=h.GetWorldInfo(),c=u.GetLayer();let d=!1;if(a.IsInteractive(c)&&u.IsInViewport2()&&(d=t.some(([e,t])=>{const[s,i]=a.CanvasCssToLayer(c,e,t,u.GetTotalZElevation());return u.ContainsPoint(s,i)})),d){if(s)return!1;o?i._PushInstance(h):e[l++]=h}else o?e[l++]=h:n&&i._PushElseInstance(h)}s||(e.length=l)}return e.ApplySolToContainer(),a.Release(),!!s||i.HasAnyInstances()}_ObjectClassCanUseCollisionCells(e,t){if(!e)return!0;for(const s of t.layersHasInstancesOn())if(!e.IsTransformCompatibleWith(s))return!1;return!0}GetCollisionCandidates(e,t,s,i){if(t.IsFamily())for(const r of t.GetFamilyMembers())this._ObjectClassCanUseCollisionCells(e,r)?(r._UpdateAllCollisionCells(),r._GetCollisionCellGrid().QueryRange(s,i)):lC.appendArray(i,r.GetInstances());else this._ObjectClassCanUseCollisionCells(e,t)?(t._UpdateAllCollisionCells(),t._GetCollisionCellGrid().QueryRange(s,i)):lC.appendArray(i,t.GetInstances())}GetObjectClassesCollisionCandidates(e,t,s,i){for(const r of t)this.GetCollisionCandidates(e,r,s,i)}GetSolidCollisionCandidates(e,t,s){const i=this._runtime.GetSolidBehavior();i&&this.GetObjectClassesCollisionCandidates(e,i.GetObjectClasses(),t,s)}GetJumpthruCollisionCandidates(e,t,s){const i=this._runtime.GetJumpthruBehavior();i&&this.GetObjectClassesCollisionCandidates(e,i.GetObjectClasses(),t,s)}IsSolidCollisionAllowed(e,t){return e._IsSolidEnabled()&&(!t||t.GetWorldInfo().IsSolidCollisionAllowed(e.GetSavedDataMap().get("solidTags")))}TestOverlapSolid(e){const t=e.GetWorldInfo();this.GetSolidCollisionCandidates(t.GetLayer(),t.GetBoundingBox(),hC);for(const t of hC)if(this.IsSolidCollisionAllowed(t,e)&&this.TestOverlap(e,t))return lC.clearArray(hC),t;return lC.clearArray(hC),null}TestRectOverlapSolid(e,t){this.GetSolidCollisionCandidates(null,e,hC);for(const s of hC)if(this.IsSolidCollisionAllowed(s,t)&&this.TestRectOverlap(e,s))return lC.clearArray(hC),s;return lC.clearArray(hC),null}TestOverlapJumpthru(e,t){let s=null;t&&(s=cC,lC.clearArray(s));const i=e.GetWorldInfo();this.GetJumpthruCollisionCandidates(i.GetLayer(),i.GetBoundingBox(),hC);for(const i of hC)if(i._IsJumpthruEnabled()&&this.TestOverlap(e,i)){if(!t)return lC.clearArray(hC),i;s.push(i)}return lC.clearArray(hC),s}PushOut(e,t,s,i,r){i=i||50;const n=e.GetWorldInfo(),a=n.GetX(),o=n.GetY();for(let l=0;l<i;++l)if(n.SetXY(a+t*l,o+s*l),n.SetBboxChanged(),!this.TestOverlap(e,r))return!0;return n.SetXY(a,o),n.SetBboxChanged(),!1}PushOutSolid(e,t,s,i,r,n){i=i||50;const a=e.GetWorldInfo(),o=a.GetX(),l=a.GetY();let h=null,u=null;for(let c=0;c<i;++c)if(a.SetXY(o+t*c,l+s*c),a.SetBboxChanged(),!this.TestOverlap(e,h))if(h=this.TestOverlapSolid(e),h)u=h;else if(r&&(h=n?this.TestOverlap(e,n)?n:null:this.TestOverlapJumpthru(e),h&&(u=h)),!h)return u&&this.PushInFractional(e,t,s,u,16,!0),!0;return a.SetXY(o,l),a.SetBboxChanged(),!1}PushOutSolidAxis(e,t,s,i){i=i||50;const r=e.GetWorldInfo(),n=r.GetX(),a=r.GetY();let o=null,l=null;for(let h=0;h<i;++h)for(let i=0;i<2;++i){const u=2*i-1;if(r.SetXY(n+t*h*u,a+s*h*u),r.SetBboxChanged(),!this.TestOverlap(e,o)){if(o=this.TestOverlapSolid(e),!o)return l&&this.PushInFractional(e,t*u,s*u,l,16,!0),!0;l=o}}return r.SetXY(n,a),r.SetBboxChanged(),!1}PushInFractional(e,t,s,i,r,n){let a=2,o=!1,l=!1;const h=e.GetWorldInfo();let u=h.GetX(),c=h.GetY();for(;a<=r;){const r=1/a;a*=2,h.OffsetXY(t*r*(o?1:-1),s*r*(o?1:-1)),h.SetBboxChanged(),this.TestOverlap(e,i)||n&&this.TestOverlapSolid(e)?(o=!0,l=!0):(o=!1,l=!1,u=h.GetX(),c=h.GetY())}l&&(h.SetXY(u,c),h.SetBboxChanged())}PushOutSolidNearest(e,t=100){let s=0;const i=e.GetWorldInfo(),r=i.GetX(),n=i.GetY();let a=0,o=this.TestOverlapSolid(e);if(!o)return!0;for(;s<=t;){let t=0,l=0;switch(a){case 0:t=0,l=-1,s++;break;case 1:t=1,l=-1;break;case 2:t=1,l=0;break;case 3:t=1,l=1;break;case 4:t=0,l=1;break;case 5:t=-1,l=1;break;case 6:t=-1,l=0;break;case 7:t=-1,l=-1}if(a=(a+1)%8,i.SetXY(Math.floor(r+t*s),Math.floor(n+l*s)),i.SetBboxChanged(),!this.TestOverlap(e,o)&&(o=this.TestOverlapSolid(e),!o))return!0}return i.SetXY(r,n),i.SetBboxChanged(),!1}CalculateBounceAngle(e,t,s,i){const r=e.GetWorldInfo(),n=r.GetX(),a=r.GetY(),o=Math.max(10,lC.distanceTo(t,s,n,a)),l=lC.angleTo(t,s,n,a),h=i||this.TestOverlapSolid(e);if(!h)return lC.clampAngle(l+Math.PI);let u=h,c=0,d=0;const p=lC.toRadians(5);let _;for(_=1;_<36;++_){const n=l-_*p;if(r.SetXY(t+Math.cos(n)*o,s+Math.sin(n)*o),r.SetBboxChanged(),!this.TestOverlap(e,u)&&(u=i?null:this.TestOverlapSolid(e),!u)){c=n;break}}for(36===_&&(c=lC.clampAngle(l+Math.PI)),u=h,_=1;_<36;++_){const n=l+_*p;if(r.SetXY(t+Math.cos(n)*o,s+Math.sin(n)*o),r.SetBboxChanged(),!this.TestOverlap(e,u)&&(u=i?null:this.TestOverlapSolid(e),!u)){d=n;break}}if(36===_&&(d=lC.clampAngle(l+Math.PI)),r.SetXY(n,a),r.SetBboxChanged(),d===c)return d;const m=lC.angleDiff(d,c)/2;let f;f=lC.angleClockwise(d,c)?lC.clampAngle(c+m+Math.PI):lC.clampAngle(d+m);const g=Math.cos(l),y=Math.sin(l),S=Math.cos(f),T=Math.sin(f),x=g*S+y*T,b=g-2*x*S,G=y-2*x*T;return lC.angleTo(0,0,b,G)}TestSegmentOverlap(e,t,s,i,r){if(!r)return!1;const n=r.GetWorldInfo();return!!n.IsCollisionEnabled()&&(this._collisionCheckCount++,mC.set(Math.min(e,s),Math.min(t,i),Math.max(e,s),Math.max(t,i)),!!n.GetBoundingBox().intersectsRect(mC)&&(r.HasTilemap()?this._TestSegmentOverlapTilemap(e,t,s,i,r,n):(this._polyCheckCount++,!!n.GetBoundingQuad().intersectsSegment(e,t,s,i)&&(!n.HasOwnCollisionPoly()||n.GetTransformedCollisionPoly().intersectsSegment(n.GetX(),n.GetY(),e,t,s,i)))))}_TestSegmentOverlapTilemap(e,t,s,i,r,n){const a=n.GetX(),o=n.GetY(),l=r.GetSdkInstance(),h=uC;fC.set(e,t,s,i),fC.normalize(),l.GetCollisionRectCandidates(fC,h);for(let r=0,n=h.length;r<n;++r){const n=h[r],l=n.GetRect();if(this._collisionCheckCount++,mC.intersectsRectOffset(l,a,o)&&(_C.setFromRect(l),_C.offset(a,o),_C.intersectsSegment(e,t,s,i))){const r=n.GetPoly();if(!r)return lC.clearArray(h),!0;if(this._polyCheckCount++,r.intersectsSegment(a+l.getLeft(),o+l.getTop(),e,t,s,i))return lC.clearArray(h),!0}}return lC.clearArray(h),!1}TestRectOverlap(e,t){if(!t)return!1;const s=t.GetWorldInfo();if(!s.IsCollisionEnabled())return!1;if(this._collisionCheckCount++,!s.GetBoundingBox().intersectsRect(e))return!1;if(t.HasTilemap())return this._TestRectOverlapTilemap(e,t,s);if(this._polyCheckCount++,_C.setFromRect(e),!s.GetBoundingQuad().intersectsQuad(_C))return!1;if(!s.HasOwnCollisionPoly())return!0;const i=dC;i.setFromRect(e,s.GetX(),s.GetY());const r=s.GetTransformedCollisionPoly();return i.intersectsPoly(r,0,0)}_TestRectOverlapTilemap(e,t,s){const i=s.GetX(),r=s.GetY(),n=t.GetSdkInstance(),a=uC;n.GetCollisionRectCandidates(e,a);for(let t=0,s=a.length;t<s;++t){const s=a[t],n=s.GetRect();if(this._collisionCheckCount++,e.intersectsRectOffset(n,i,r)){const t=s.GetPoly();if(!t)return lC.clearArray(a),!0;if(this._polyCheckCount++,dC.setFromRect(e,0,0),t.intersectsPoly(dC,-(i+n.getLeft()),-(r+n.getTop())))return lC.clearArray(a),!0}}return lC.clearArray(a),!1}TestRayIntersectsInstance(e,t){if(!e)return;const s=e.GetWorldInfo();s.IsCollisionEnabled()&&(this._collisionCheckCount++,s.GetBoundingBox().intersectsRect(t.rect)&&(e.HasTilemap()?this._TestRayIntersectsTilemap(e,s,t):(this._polyCheckCount++,s.HasOwnCollisionPoly()?t.TestInstancePoly(e,s.GetX(),s.GetY(),s.GetTransformedCollisionPoly()):t.TestInstanceQuad(e,s.GetBoundingQuad()))))}_TestRayIntersectsTilemap(e,t,s){const i=t.GetX(),r=t.GetY(),n=uC;e.GetSdkInstance().GetCollisionRectCandidates(s.rect,n);for(let a=0,o=n.length;a<o;a++){const o=n[a],l=o.GetRect();if(this._collisionCheckCount++,s.rect.intersectsRectOffset(l,i,r)){const n=o.GetPoly();this._polyCheckCount++,n?s.TestInstancePoly(e,i+l.getLeft(),r+l.getTop(),n):s.TestInstanceRect(e,t.GetX(),t.GetY(),l)}}lC.clearArray(n)}SetCollisionCellSize(e,t){if(e===this._collisionCellWidth&&t===this._collisionCellHeight)return;this._collisionCellWidth=e,this._collisionCellHeight=t;const s=this._runtime.GetAllObjectClasses();for(const i of s)if(i.IsWorldType()){for(const e of i.instancesIncludingPendingCreate())e.GetWorldInfo()._RemoveFromCollisionCells();i._GetCollisionCellGrid().SetCellSize(e,t),i._SetAnyCollisionCellChanged();for(const e of i.instancesIncludingPendingCreate()){const t=e.GetWorldInfo();t._SetCollisionCellChanged(),t._UpdateCollisionCell()}}}GetCollisionCellSize(){return[this._collisionCellWidth,this._collisionCellHeight]}_InitCollisionCellSize(e,t){this._collisionCellWidth=e,this._collisionCellHeight=t}}}{const TC=self.C3;TC.SparseGrid=class extends TC.DefendedBase{constructor(e,t){super(),this._cellWidth=e,this._cellHeight=t,this._cells=TC.New(TC.PairMap)}Release(){this._cells.Release(),this._cells=null}SetCellSize(e,t){if(!this._cells.IsEmpty())throw new Error("grid not empty");this._cellWidth=e,this._cellHeight=t}GetCell(e,t,s){let i=this._cells.Get(e,t);return i||(s?(i=TC.New(TC.GridCell,this,e,t),this._cells.Set(e,t,i),i):null)}XToCell(e){const t=Math.floor(e/this._cellWidth);return isFinite(t)?t:0}YToCell(e){const t=Math.floor(e/this._cellHeight);return isFinite(t)?t:0}Update(e,t,s){if(t)for(let i=t.getLeft(),r=t.getRight();i<=r;++i)for(let r=t.getTop(),n=t.getBottom();r<=n;++r){if(s&&s.containsPoint(i,r))continue;const t=this.GetCell(i,r,!1);t&&(t.Remove(e),t.IsEmpty()&&this._cells.Delete(i,r))}if(s)for(let i=s.getLeft(),r=s.getRight();i<=r;++i)for(let r=s.getTop(),n=s.getBottom();r<=n;++r)t&&t.containsPoint(i,r)||this.GetCell(i,r,!0).Insert(e)}QueryRange(e,t){let s=this.XToCell(e.getLeft());const i=this.YToCell(e.getTop()),r=this.XToCell(e.getRight()),n=this.YToCell(e.getBottom());if(isFinite(r)&&isFinite(n))for(;s<=r;++s)for(let e=i;e<=n;++e){const i=this.GetCell(s,e,!1);i&&i.Dump(t)}}}}{const xC=self.C3;xC.GridCell=class extends xC.DefendedBase{constructor(e,t,s){super(),this._grid=e,this._x=t,this._y=s,this._instances=xC.New(xC.ArraySet)}Release(){this._instances.Release(),this._instances=null,this._grid=null}IsEmpty(){return this._instances.IsEmpty()}Insert(e){this._instances.Add(e)}Remove(e){this._instances.Delete(e)}Dump(e){xC.appendArray(e,this._instances.GetArray())}}}{const bC=self.C3,GC=1e-6,IC=2;bC.Ray=class{constructor(){this.x1=0,this.y1=0,this.x2=0,this.y2=0,this.dx=0,this.dy=0,this.rect=new bC.Rect,this.hitFraction=2,this.hitUid=null,this.hitNormal=0,this.hitNormalDx=0,this.hitNormalDy=0,this.hitX=0,this.hitY=0,this.distance=0,this.normalX=1,this.normalY=0,this.reflectionX=1,this.reflectionY=0}DidCollide(){return this.hitFraction<1.000001}Reset(){this.hitFraction=2}Set(e,t,s,i){return this.x1=e,this.y1=t,this.x2=s,this.y2=i,this.dx=s-e,this.dy=i-t,this.rect.set(e,t,s,i),this.rect.normalize(),this.hitFraction=2,this.hitUid=null,this.hitNormal=0,this.hitNormalDx=0,this.hitNormalDy=0,this.hitX=0,this.hitY=0,this.distance=0,this.normalX=1,this.normalY=0,this.reflectionX=1,this.reflectionY=0,this}Complete(){if(!1===this.DidCollide())return;const e=this.dx*this.hitFraction,t=this.dy*this.hitFraction,s=bC.hypot2DFast(e,t),i=e/s,r=t/s;this.distance=s-GC,this.hitX=this.x1+i*this.distance,this.hitY=this.y1+r*this.distance,this.hitNormal=Math.atan2(this.hitNormalDy,this.hitNormalDx)+Math.PI/2,this.normalX=Math.cos(this.hitNormal),this.normalY=Math.sin(this.hitNormal);const n=i*this.normalX+r*this.normalY;if(this.reflectionX=i-2*this.normalX*n,this.reflectionY=r-2*this.normalY*n,n>0){const e=Math.PI;this.hitNormal=bC.clampAngle(this.hitNormal+e),this.normalX=-this.normalX,this.normalY=-this.normalY}}TestInstanceSegment(e,t,s,i,r){const n=bC.rayIntersect(this.x1,this.y1,this.x2,this.y2,t,s,i,r);n>=0&&n<this.hitFraction&&(this.hitFraction=n,this.hitUid=e.GetUID(),this.hitNormalDx=t-i,this.hitNormalDy=s-r)}TestInstanceRect(e,t,s,i){const r=t+i.getLeft(),n=t+i.getRight(),a=s+i.getTop(),o=s+i.getBottom();this.TestInstanceSegment(e,r,a,n,a),this.TestInstanceSegment(e,n,a,n,o),this.TestInstanceSegment(e,n,o,r,o),this.TestInstanceSegment(e,r,o,r,a)}TestInstanceQuad(e,t){const s=t.getTlx(),i=t.getTly(),r=t.getTrx(),n=t.getTry(),a=t.getBrx(),o=t.getBry(),l=t.getBlx(),h=t.getBly();this.TestInstanceSegment(e,s,i,r,n),this.TestInstanceSegment(e,r,n,a,o),this.TestInstanceSegment(e,a,o,l,h),this.TestInstanceSegment(e,l,h,s,i)}TestInstancePoly(e,t,s,i){const r=i.pointsArr();for(let i=0,n=r.length;i<n;i+=2){const a=(i+2)%n,o=r[i]+t,l=r[i+1]+s,h=r[a]+t,u=r[a+1]+s;this.TestInstanceSegment(e,o,l,h,u)}}}}{const vC=self.C3;vC.LayerStateCache=class{constructor(){this._layerCache=new Map}Release(){for(const e of this._layerCache.values())e.layerPts.Clear();this._layerCache.clear()}_GetLayerCache(e){let t=this._layerCache.get(e);return void 0===t&&(t={isInteractive:null,layerPts:new vC.PairMap},this._layerCache.set(e,t)),t}IsInteractive(e){const t=this._GetLayerCache(e);return null===t.isInteractive&&(t.isInteractive=e.IsSelfAndParentsInteractive()),t.isInteractive}CanvasCssToLayer(e,t,s,i){if(0!==i)return e.CanvasCssToLayer(t,s,i);const r=this._GetLayerCache(e);let n=r.layerPts.Get(t,s);return void 0===n&&(n=e.CanvasCssToLayer(t,s,i),r.layerPts.Set(t,s,n)),n}}}{const CC=self.C3,wC=new Set(["off","crop","scale-inner","scale-outer","letterbox-scale","letterbox-integer-scale"]),AC=new Set(["high","low"]),RC=self.glMatrix,PC=RC.mat4,MC=RC.vec3,EC=PC.create(),DC=300,NC=200,FC=120,OC=8,BC=CC.New(CC.Quad),LC=CC.New(CC.Rect),kC=3e3,VC=200,UC=300;CC.CanvasManager=class extends CC.DefendedBase{constructor(e){super(),this._runtime=e,this._canvasLayers=[],this._isWebGPUEnabled=!1,this._webglRenderer=null,this._webgpuRenderer=null,this._iRenderer=null,this._gpuPreference="high-performance",this._isLimitedToWebGL1=!1,this._multitexturingMode="auto",this._windowInnerWidth=0,this._windowInnerHeight=0,this._cssDisplayMode="",this._canvasCssWidth=0,this._canvasCssHeight=0,this._canvasDeviceWidth=0,this._canvasDeviceHeight=0,this._canvasCssOffsetX=0,this._canvasCssOffsetY=0,this._zAxisScale="normalized",this._initFieldOfView=0,this._zNear=1,this._zFar=1e4,this._enableMipmaps=!0,this._textureAnisotropy=0,this._drawWidth=0,this._drawHeight=0,this._fullscreenMode="letterbox-scale",this._documentFullscreenMode="letterbox-scale",this._deviceTransformOffX=0,this._deviceTransformOffY=0,this._defaultProjectionMatrix=PC.create(),this._wantFullscreenScalingQuality="high",this._fullscreenScalingQuality=this._wantFullscreenScalingQuality,this._isDocumentFullscreen=!1,this._availableAdditionalRenderTargets=[],this._usedAdditionalRenderTargets=new Set,this._shaderData=self.C3_Shaders,this._effectChainManager=CC.New(CC.Gfx.EffectChainManager,{getDrawSize:()=>[this.GetDrawWidth(),this.GetDrawHeight()],getRenderTarget:()=>this.GetEffectCompositorRenderTarget(),releaseRenderTarget:e=>this.ReleaseEffectCompositorRenderTarget(e),getTime:()=>this.GetRuntime().GetGameTime(),redraw:()=>this.GetRuntime().UpdateRender()}),this._gpuTimeStartFrame=0,this._gpuTimeEndFrame=0,this._gpuLastUtilisation=NaN,this._gpuFrameTimingsBuffer=null,this._layersGpuProfile=new Map,this._gpuCurUtilisation=NaN,this._webgpuFrameTimings=new Map,this._snapshotFormat="",this._snapshotQuality=1,this._snapshotArea=CC.New(CC.Rect),this._snapshotUrl="",this._snapshotPromise=null,this._snapshotResolve=null,this._isPastingToDrawingCanvas=0,this._loaderStartTime=0,this._rafId=-1,this._loadingProgress=0,this._loadingprogress_handler=e=>this._loadingProgress=e.progress,this._percentText=null,this._splashTextures={logo:null,powered:null,website:null},this._splashFrameNumber=0,this._splashFadeInFinishTime=0,this._splashFadeOutStartTime=0,this._splashState="fade-in",this._splashDoneResolve=null,this._splashDonePromise=new Promise(e=>this._splashDoneResolve=e)}_SetGPUPowerPreference(e){this._gpuPreference=e}_SetWebGPUEnabled(e){this._isWebGPUEnabled=!!e}_SetZAxisScale(e){this._zAxisScale=e}GetZAxisScale(){return this._zAxisScale}_SetInitFieldOfView(e){this._initFieldOfView=e}_SetZDistances(e,t){this._zNear=e,this._zFar=t}_SetLimitedToWebGL1(e){this._isLimitedToWebGL1=!!e}_SetMultitexturingMode(e){this._multitexturingMode=e}async CreateCanvas(e){let t=e.canvas;this._canvasLayers.push({canvas:t,ctx:null}),this._runtime.AddDOMComponentMessageHandler("runtime","window-resize",e=>this._OnWindowResize(e)),this._runtime.AddDOMComponentMessageHandler("runtime","fullscreenchange",e=>this._OnFullscreenChange(e)),this._runtime.AddDOMComponentMessageHandler("runtime","fullscreenerror",e=>this._OnFullscreenError(e)),t.addEventListener("webglcontextlost",e=>this._OnWebGLContextLost(e)),t.addEventListener("webglcontextrestored",e=>this._OnWebGLContextRestored(e)),this._isDocumentFullscreen=!!e.isFullscreen,this._cssDisplayMode=e.cssDisplayMode;const s=navigator.gpu&&this._isWebGPUEnabled;let i=!1;if(s)try{await this._InitWebGPUContext(!0)}catch(e){this._MaybeLogRendererError("WebGPU",e),this._webgpuRenderer=null}if(!this.GetRenderer())try{await this._InitWebGLContext(!0)}catch(e){this._MaybeLogRendererError("WebGL",e),this._webglRenderer=null}if(this.GetRenderer()||(i=!0),!this.GetRenderer()&&s)try{await this._InitWebGPUContext(!1)}catch(e){this._MaybeLogRendererError("WebGPU",e),this._webgpuRenderer=null}if(!this.GetRenderer())try{await this._InitWebGLContext(!1)}catch(e){this._MaybeLogRendererError("WebGL",e),this._webglRenderer=null}const r=this.GetRenderer();if(!r)throw new Error("failed to acquire a renderer - check WebGL or WebGPU is supported");r.SetHasMajorPerformanceCaveat(i),this._webgpuRenderer&&(this._webgpuRenderer.ondevicelost=()=>this._OnWebGPUDeviceLost(),this._webgpuRenderer.ondevicerestored=()=>this._OnWebGPUDeviceRestored()),"normalized"===this._zAxisScale?r.SetZAxisScaleNormalized():(r.SetZAxisScaleRegular(),r.SetFovY(this._initFieldOfView)),this.SetSize(e.windowInnerWidth,e.windowInnerHeight,!0),await this._InitRenderer()}_MaybeLogRendererError(e,t){t&&"string"==typeof t.message&&t.message.startsWith("renderer-unavailable")||console.error(`Error creating ${e} renderer: `,t)}async _InitWebGPUContext(e){const t={nearZ:this._zNear,farZ:this._zFar};let s=!0;"no"===this._multitexturingMode?s=!1:"auto"===this._multitexturingMode&&(s=CC.Platform.IsDesktop);const i={powerPreference:this._gpuPreference,depth:this._runtime.Uses3DFeatures(),failIfMajorPerformanceCaveat:e,usesBackgroundBlending:this._runtime.UsesAnyBackgroundBlending(),canSampleBackbuffer:this._runtime.UsesAnyCrossSampling(),canSampleDepth:this._runtime.UsesAnyDepthSampling(),isMultiTexturingAllowed:s};this._webgpuRenderer=CC.New(CC.Gfx.WebGPURenderer,t),await this._webgpuRenderer.Create(this._canvasLayers[0].canvas,i)}async _InitWebGLContext(e){const t={alpha:!0,powerPreference:this._gpuPreference,enableGpuProfiling:"xbox-uwp-webview2"!==this._runtime.GetExportType(),depth:this._runtime.Uses3DFeatures(),canSampleDepth:this._runtime.UsesAnyDepthSampling(),failIfMajorPerformanceCaveat:e,nearZ:this._zNear,farZ:this._zFar};this._isLimitedToWebGL1&&(t.maxWebGLVersion=1),this._webglRenderer=CC.New(CC.Gfx.WebGLRenderer,this._canvasLayers[0].canvas,t),await this._webglRenderer.InitState()}async _InitWebGPU(){if(this._shaderData){const e=[];for(const[t,s]of Object.entries(this._shaderData)){s.src=s.wgsl;const i=CC.Gfx.WebGPUShaderProgram.GetDefaultVertexShaderSource(this._webgpuRenderer.IsColorDataF16());e.push(this._webgpuRenderer.CreateShaderProgram(Object.assign({vertexSrc:i,name:t},s)))}await Promise.all(e)}}async _InitWebGL(){if(this._shaderData){const e=[];for(const[t,s]of Object.entries(this._shaderData)){let i;if(s.glslWebGL2&&this._webglRenderer.GetWebGLVersionNumber()>=2)s.src=s.glslWebGL2,i=CC.Gfx.WebGLShaderProgram.GetDefaultVertexShaderSource_WebGL2();else{if(!s.glsl)throw new Error(`shader '${t}' does not support WebGL 1`);s.src=s.glsl,i=CC.Gfx.WebGLShaderProgram.GetDefaultVertexShaderSource()}e.push(this._webglRenderer.CreateShaderProgram(Object.assign({vertexSrc:i,name:t},s)))}await Promise.all(e),this._webglRenderer.ResetLastProgram(),this._webglRenderer.SetTextureFillMode()}this._webglRenderer.SupportsGPUProfiling()&&(this._gpuFrameTimingsBuffer=CC.New(CC.Gfx.WebGLQueryResultBuffer,this._webglRenderer))}async _InitRenderer(){this._webgpuRenderer?await this._InitWebGPU():this._webglRenderer&&await this._InitWebGL();const e=this.GetRenderer();e.SetMipmapsEnabled(this._enableMipmaps),e.SupportsGPUProfiling()&&(this._gpuLastUtilisation=0);for(const t of this._runtime._GetAllEffectLists()){for(const s of t.GetAllEffectTypes())s._InitRenderer(e);t._InitRenderer(e),t.UpdateActiveEffects()}this._iRenderer=new self.IRenderer(this._runtime,e)}Release(){this._runtime=null,this._webglRenderer=null,this._canvasLayers.length=0}IsInWorker(){return this._runtime.IsInWorker()}_OnWindowResize(e){const t=this._runtime;if(t.IsExportToVideo())return;const s=e.devicePixelRatio;this.IsInWorker()&&(self.devicePixelRatio=s),t._SetDevicePixelRatio(s),this._isDocumentFullscreen=!!e.isFullscreen,this._cssDisplayMode=e.cssDisplayMode,this.SetSize(e.innerWidth,e.innerHeight),t.UpdateRender();const i=new CC.Event("window-resize");i.data=e,t.Dispatcher().dispatchEventAndWaitAsyncSequential(i);const r=new CC.Event("resize");r.cssWidth=this.GetCssWidth(),r.cssHeight=this.GetCssHeight(),r.deviceWidth=this.GetDeviceWidth(),r.deviceHeight=this.GetDeviceHeight(),t.DispatchUserScriptEvent(r),this._runtime.GetCurrentLayout()?.BoundScrolling(),t.IsDebug()&&(t.HitBreakpoint()||self.C3Debugger.IsDebuggerPaused())&&t.Render()}_OnFullscreenChange(e){this._isDocumentFullscreen=!!e.isFullscreen,this.SetSize(e.innerWidth,e.innerHeight,!0),this._runtime.UpdateRender()}_OnFullscreenError(e){this._isDocumentFullscreen=!!e.isFullscreen,this.SetSize(e.innerWidth,e.innerHeight,!0),this._runtime.UpdateRender()}SetSize(e,t,s=!1){if(e=Math.floor(e),t=Math.floor(t),e<=0||t<=0)throw new Error("invalid size");if(this._windowInnerWidth===e&&this._windowInnerHeight===t&&!s)return;this._windowInnerWidth=e,this._windowInnerHeight=t;const i=this.GetCurrentFullscreenMode();"letterbox-scale"===i?this._CalculateLetterboxScale(e,t):"letterbox-integer-scale"===i?this._CalculateLetterboxIntegerScale(e,t):"off"===i?this._CalculateFixedSizeCanvas(e,t):this._CalculateFullsizeCanvas(e,t),this._UpdateFullscreenScalingQuality(i);for(const{canvas:e}of this._canvasLayers)e.width=this._canvasDeviceWidth,e.height=this._canvasDeviceHeight;this._runtime.PostComponentMessageToDOM("canvas","update-size",{marginLeft:this._canvasCssOffsetX,marginTop:this._canvasCssOffsetY,styleWidth:this._canvasCssWidth,styleHeight:this._canvasCssHeight,displayScale:this.GetDisplayScale()});const r=this.GetRenderer();r.SetSize(this._canvasDeviceWidth,this._canvasDeviceHeight,!0);for(const e of this._availableAdditionalRenderTargets)r.DeleteRenderTarget(e);CC.clearArray(this._availableAdditionalRenderTargets),this.UpdateDefaultProjectionMatrix();const n=this._runtime.GetLayoutManager();n.SetAllLayerProjectionChanged(),n.SetAllLayerMVChanged()}UpdateDefaultProjectionMatrix(){this.GetRenderer().CalculatePerspectiveMatrix(this._defaultProjectionMatrix,this.GetDrawWidth()/this.GetDrawHeight())}GetDefaultProjectionMatrix(){return this._defaultProjectionMatrix}_CalculateLetterboxScale(e,t){const s=this._runtime.GetDevicePixelRatio(),i=this._runtime.GetOriginalViewportWidth(),r=this._runtime.GetOriginalViewportHeight(),n=i/r;if(e/t>n){const s=t*n;this._canvasCssWidth=Math.round(s),this._canvasCssHeight=t,this._canvasCssOffsetX=Math.floor((e-this._canvasCssWidth)/2),this._canvasCssOffsetY=0}else{const s=e/n;this._canvasCssWidth=e,this._canvasCssHeight=Math.round(s),this._canvasCssOffsetX=0,this._canvasCssOffsetY=Math.floor((t-this._canvasCssHeight)/2)}this._canvasDeviceWidth=Math.round(this._canvasCssWidth*s),this._canvasDeviceHeight=Math.round(this._canvasCssHeight*s),this._runtime.SetViewportSize(i,r)}_CalculateLetterboxIntegerScale(e,t){const s=this._runtime.GetDevicePixelRatio();1!==s&&(e+=1,t+=1);const i=this._runtime.GetOriginalViewportWidth(),r=this._runtime.GetOriginalViewportHeight(),n=i/r;let a;a=e/t>n?t*n*s/i:e/n*s/r,a>1?a=Math.floor(a):a<1&&(a=1/Math.ceil(1/a)),this._canvasDeviceWidth=Math.round(i*a),this._canvasDeviceHeight=Math.round(r*a),this._canvasCssWidth=this._canvasDeviceWidth/s,this._canvasCssHeight=this._canvasDeviceHeight/s,this._canvasCssOffsetX=Math.max(Math.floor((e-this._canvasCssWidth)/2),0),this._canvasCssOffsetY=Math.max(Math.floor((t-this._canvasCssHeight)/2),0),this._runtime.SetViewportSize(i,r)}_CalculateFullsizeCanvas(e,t){const s=this._runtime.GetDevicePixelRatio();this._canvasCssWidth=e,this._canvasCssHeight=t,this._canvasDeviceWidth=Math.round(this._canvasCssWidth*s),this._canvasDeviceHeight=Math.round(this._canvasCssHeight*s),this._canvasCssOffsetX=0,this._canvasCssOffsetY=0;const i=this.GetDisplayScale();this._runtime.SetViewportSize(this._canvasCssWidth/i,this._canvasCssHeight/i)}_CalculateFixedSizeCanvas(e,t){const s=this._runtime.GetDevicePixelRatio();this._canvasCssWidth=this._runtime.GetViewportWidth(),this._canvasCssHeight=this._runtime.GetViewportHeight(),this._canvasDeviceWidth=Math.round(this._canvasCssWidth*s),this._canvasDeviceHeight=Math.round(this._canvasCssHeight*s),this.IsDocumentFullscreen()?(this._canvasCssOffsetX=Math.floor((e-this._canvasCssWidth)/2),this._canvasCssOffsetY=Math.floor((t-this._canvasCssHeight)/2)):(this._canvasCssOffsetX=0,this._canvasCssOffsetY=0),this._runtime.SetViewportSize(this._runtime.GetViewportWidth(),this._runtime.GetViewportHeight())}_UpdateFullscreenScalingQuality(e){if("high"===this._wantFullscreenScalingQuality)this._drawWidth=this._canvasDeviceWidth,this._drawHeight=this._canvasDeviceHeight,this._fullscreenScalingQuality="high";else{let t,s;if("off"===this.GetCurrentFullscreenMode()?(t=this._runtime.GetViewportWidth(),s=this._runtime.GetViewportHeight()):(t=this._runtime.GetOriginalViewportWidth(),s=this._runtime.GetOriginalViewportHeight()),this._canvasDeviceWidth<t||this._canvasDeviceHeight<s)this._drawWidth=this._canvasDeviceWidth,this._drawHeight=this._canvasDeviceHeight,this._fullscreenScalingQuality="high";else if(this._drawWidth=t,this._drawHeight=s,this._fullscreenScalingQuality="low","scale-inner"===e){const e=t/s,i=this._windowInnerWidth/this._windowInnerHeight;i<e?this._drawWidth=this._drawHeight*i:i>e&&(this._drawHeight=this._drawWidth/i)}else if("scale-outer"===e){const e=t/s,i=this._windowInnerWidth/this._windowInnerHeight;i>e?this._drawWidth=this._drawHeight*i:i<e&&(this._drawHeight=this._drawWidth/i)}}}GetRuntime(){return this._runtime}GetMainCanvas(){return this._canvasLayers[0].canvas}GetEffectChainManager(){return this._effectChainManager}IsDocumentFullscreen(){return this._isDocumentFullscreen}GetCssDisplayMode(){return this._cssDisplayMode}SetFullscreenMode(e){if(!wC.has(e))throw new Error("invalid fullscreen mode");this._fullscreenMode=e;const t=this._runtime.GetLayoutManager();t.SetAllLayerProjectionChanged(),t.SetAllLayerMVChanged()}GetFullscreenMode(){return this._fullscreenMode}SetDocumentFullscreenMode(e){if(!wC.has(e))throw new Error("invalid fullscreen mode");this._documentFullscreenMode=e;const t=this._runtime.GetLayoutManager();t.SetAllLayerProjectionChanged(),t.SetAllLayerMVChanged()}GetDocumentFullscreenMode(){return this._documentFullscreenMode}GetCurrentFullscreenMode(){return this.IsDocumentFullscreen()?this.GetDocumentFullscreenMode():this.GetFullscreenMode()}SetFullscreenScalingQuality(e){if(!AC.has(e))throw new Error("invalid fullscreen scaling quality");this._wantFullscreenScalingQuality=e,this._runtime.GetLayoutManager().SetAllLayerProjectionChanged()}GetSetFullscreenScalingQuality(){return this._wantFullscreenScalingQuality}GetCurrentFullscreenScalingQuality(){return this._fullscreenScalingQuality}static _FullscreenModeNumberToString(e){switch(e){case 0:return"off";case 1:return"crop";case 2:return"scale-inner";case 3:return"scale-outer";case 4:return"letterbox-scale";case 5:return"letterbox-integer-scale";default:throw new Error("invalid fullscreen mode")}}GetLastWidth(){return this._windowInnerWidth}GetLastHeight(){return this._windowInnerHeight}GetDrawWidth(){return this._drawWidth}GetDrawHeight(){return this._drawHeight}SetMipmapsEnabled(e){this._enableMipmaps=!!e}_SetTextureAnisotropy(e){this._textureAnisotropy=e}GetTextureAnisotropy(){return this._textureAnisotropy}IsRendererContextLost(){return this.GetRenderer().IsContextLost()}_OnWebGLContextLost(e){console.log("[Construct] WebGL context lost"),e.preventDefault(),this._availableAdditionalRenderTargets=[],this._usedAdditionalRenderTargets.clear(),this._effectChainManager.OnContextLost(),this._webglRenderer.OnContextLost(),this._runtime._OnRendererContextLost()}_OnWebGPUDeviceLost(){console.log("[Construct] WebGPU device lost"),this._availableAdditionalRenderTargets=[],this._usedAdditionalRenderTargets.clear(),this._effectChainManager.OnContextLost(),this._runtime._OnRendererContextLost()}async _OnWebGLContextRestored(e){await this._webglRenderer.OnContextRestored(),await this._InitRenderer(),await this._runtime._OnRendererContextRestored(),console.log("[Construct] WebGL context restored")}async _OnWebGPUDeviceRestored(){await this._InitRenderer(),await this._runtime._OnRendererContextRestored(),console.log("[Construct] WebGPU device restored")}GetWebGLRenderer(){return this._webglRenderer}GetWebGPURenderer(){return this._webgpuRenderer}GetRenderer(){return this._webgpuRenderer||this._webglRenderer}GetIRenderer(){return this._iRenderer}GetRendererString(){let e="";return e=this._runtime.GetWebGPURenderer()?"webgpu":"webgl"+this._runtime.GetWebGLRenderer().GetWebGLVersionNumber(),this._runtime.GetRenderer().HasMajorPerformanceCaveat()&&(e+="-software"),e}GetRendererDetailString(){return this._runtime.GetWebGPURenderer()?this._runtime.GetWebGPURenderer().GetAdapterInfoString():this._runtime.GetWebGLRenderer().GetUnmaskedRenderer()}GetRenderScale(){return"low"===this._fullscreenScalingQuality?1/this._runtime.GetDevicePixelRatio():this.GetDisplayScale()}GetDisplayScale(){const e=this.GetCurrentFullscreenMode();if("off"===e||"crop"===e)return 1;const t=this._runtime.GetOriginalViewportWidth(),s=this._runtime.GetOriginalViewportHeight(),i=t/s,r=this._canvasDeviceWidth/this._canvasDeviceHeight;return"scale-inner"!==e&&r>i||"scale-inner"===e&&r<i?this._canvasCssHeight/s:this._canvasCssWidth/t}GetEffectLayerScaleParam(){return"low"===this.GetCurrentFullscreenScalingQuality()?1:this.GetDisplayScale()}GetEffectDevicePixelRatioParam(){return"low"===this.GetCurrentFullscreenScalingQuality()?1:this._runtime.GetDevicePixelRatio()}SetDeviceTransformOffset(e,t){this._deviceTransformOffX=e,this._deviceTransformOffY=t}SetDeviceTransform(e,t,s,i=!0){t=t||this._drawWidth,s=s||this._drawHeight;const r=t/2+this._deviceTransformOffX,n=s/2+this._deviceTransformOffY;if(i){let i=this.GetDefaultProjectionMatrix();t===this._drawWidth&&s===this._drawHeight||(e.CalculatePerspectiveMatrix(EC,t/s),i=EC),e.SetProjectionMatrix(i)}const a=e.CalculateLookAtModelView2(r,n,e.GetDefaultCameraZ(s),r,n,0,s);e.SetModelViewMatrix(a)}SetCssTransform(e,t=!0){const s=this.GetCssWidth(),i=this.GetCssHeight(),r=s/2,n=i/2;t&&e.SetProjectionMatrix(this.GetDefaultProjectionMatrix());const a=e.CalculateLookAtModelView2(r,n,e.GetDefaultCameraZ(i),r,n,0,i);e.SetModelViewMatrix(a)}GetDeviceWidth(){return this._canvasDeviceWidth}GetDeviceHeight(){return this._canvasDeviceHeight}GetCssWidth(){return this._canvasCssWidth}GetCssHeight(){return this._canvasCssHeight}GetCanvasClientX(){return this._canvasCssOffsetX}GetCanvasClientY(){return this._canvasCssOffsetY}GetHTMLLayerCount(){return this._canvasLayers.length}_CanUseImageBitmapRenderingContext(){return"undefined"!=typeof OffscreenCanvas&&this.GetMainCanvas()instanceof OffscreenCanvas&&("Chromium"!==CC.Platform.BrowserEngine||CC.Platform.BrowserVersionNumber>=124)}async SetHTMLLayerCount(e,t=!1){if(e<1)throw new Error("invalid HTML layer count");if(this._canvasLayers.length===e)return;const s={count:e,layersDomState:this._runtime.GetLayoutManager().GetMainRunningLayout()._GetRootLayers().filter(e=>e.IsHTMLElementsLayer()).map(e=>e._GetHTMLLayerDOMState()),immediate:t,marginLeft:this._canvasCssOffsetX,marginTop:this._canvasCssOffsetY,styleWidth:this._canvasCssWidth,styleHeight:this._canvasCssHeight};let i;if(i=this.IsInWorker()?await this._runtime.PostComponentMessageToDOMAsync("canvas","set-html-layer-count",s):self.c3_runtimeInterface._OnSetHTMLLayerCount(s),e<this._canvasLayers.length)this._canvasLayers.length=e;else for(const e of i.addedCanvases){e.width=this._canvasDeviceWidth,e.height=this._canvasDeviceHeight;const t=this._CanUseImageBitmapRenderingContext()?"bitmaprenderer":"2d",s=e.getContext(t);if(!s)throw new Error(`failed to acquire '${t}' canvas context`);this._canvasLayers.push({canvas:e,ctx:s})}this._runtime.UpdateRender()}BlitMainCanvasToHTMLLayerCanvas(e){if(e>=this._canvasLayers.length)return;const t=this.GetMainCanvas(),s=this._canvasLayers[e].ctx;this._CanUseImageBitmapRenderingContext()?s.transferFromImageBitmap(t.transferToImageBitmap()):(s.globalCompositeOperation="copy",s.drawImage(t,0,0))}GetAdditionalRenderTarget(e){e.depth=this._runtime.Uses3DFeatures();const t=this._availableAdditionalRenderTargets,s=t.findIndex(t=>t.IsCompatibleWithOptions(e));let i;return-1!==s?(i=t[s],t.splice(s,1)):i=this.GetRenderer().CreateRenderTarget(e),this._usedAdditionalRenderTargets.add(i),i}ReleaseAdditionalRenderTarget(e){if(!this._usedAdditionalRenderTargets.has(e))throw new Error("render target not in use");this._usedAdditionalRenderTargets.delete(e),this._availableAdditionalRenderTargets.push(e)}GetEffectCompositorRenderTarget(){const e={sampling:this._runtime.GetSampling()};return"low"===this.GetCurrentFullscreenScalingQuality()&&(e.width=this.GetDrawWidth(),e.height=this.GetDrawHeight()),this.GetAdditionalRenderTarget(e)}ReleaseEffectCompositorRenderTarget(e){this.ReleaseAdditionalRenderTarget(e)}*activeLayersGpuProfiles(){for(const e of this._runtime.GetLayoutManager().runningLayouts())for(const t of e.GetLayers()){const e=this._layersGpuProfile.get(t);e&&(yield e)}}GetLayerTimingsBuffer(e){if(!this.GetRenderer().SupportsGPUProfiling())return null;let t=this._layersGpuProfile.get(e);return t||(t={layer:e,name:e.GetName(),timingsBuffer:CC.New(CC.Gfx.WebGLQueryResultBuffer,this._webglRenderer),curUtilisation:0,lastTotalUtilisation:0,lastSelfUtilisation:0},this._layersGpuProfile.set(e,t)),t.timingsBuffer}_Update1sFrameRange(){const e=this.GetRenderer();if(e.SupportsGPUProfiling()&&0===this._gpuTimeEndFrame){this._gpuTimeEndFrame=e.GetFrameNumber(),this._gpuCurUtilisation=NaN;for(const e of this.activeLayersGpuProfiles())e.curUtilisation=NaN}}_UpdateTick(){this._webglRenderer&&this._webglRenderer.SupportsGPUProfiling()&&this._UpdateTick_WebGL(),this._webgpuRenderer&&this._webgpuRenderer.SupportsGPUProfiling()&&this._UpdateTick_WebGPU()}_UpdateTick_WebGL(){if(isNaN(this._gpuCurUtilisation)&&(this._gpuCurUtilisation=this._gpuFrameTimingsBuffer.GetFrameRangeResultSum(this._gpuTimeStartFrame,this._gpuTimeEndFrame),!isNaN(this._gpuCurUtilisation))){if(this._runtime.IsDebug())for(const e of this.activeLayersGpuProfiles())if(e.curUtilisation=e.timingsBuffer.GetFrameRangeResultSum(this._gpuTimeStartFrame,this._gpuTimeEndFrame),isNaN(e.curUtilisation))return;if(this._gpuFrameTimingsBuffer.DeleteAllBeforeFrameNumber(this._gpuTimeEndFrame),this._gpuLastUtilisation=Math.min(this._gpuCurUtilisation,1),this._runtime.IsDebug()){const e=new Map;for(const t of this.activeLayersGpuProfiles())t.timingsBuffer.DeleteAllBeforeFrameNumber(this._gpuTimeEndFrame),t.lastTotalUtilisation=Math.min(t.curUtilisation,1),e.set(t.layer,t.lastTotalUtilisation);for(const t of this.activeLayersGpuProfiles()){const s=t.layer,i=(e.get(s)||0)-s.GetSubLayers().reduce((t,s)=>t+(e.get(s)||0),0);t.lastSelfUtilisation=CC.clamp(i,0,1)}const t=this._runtime.GetMainRunningLayout(),s=this._gpuLastUtilisation-t._GetRootLayers().reduce((t,s)=>t+(e.get(s)||0),0);self.C3Debugger.UpdateGPUProfile(CC.clamp(s,0,1),this._gpuLastUtilisation,[...this.activeLayersGpuProfiles()])}this._gpuTimeStartFrame=this._gpuTimeEndFrame,this._gpuTimeEndFrame=0}}GetGPUFrameTimingsBuffer(){return this._gpuFrameTimingsBuffer}_UpdateTick_WebGPU(){if(0===this._gpuTimeEndFrame)return;for(let e=this._gpuTimeStartFrame;e<this._gpuTimeEndFrame;++e){const t=this._webgpuFrameTimings.get(e);if(t&&!t.HasResult())return}const e=this._runtime.GetMainRunningLayout(),t=CC.MakeFilledArray(e.GetLayerCount()+1,0);let s=0;for(let e=this._gpuTimeStartFrame;e<this._gpuTimeEndFrame;++e){const i=this._webgpuFrameTimings.get(e);if(!i)continue;const r=i.GetResult();let n=BigInt(0),a=BigInt(0);const o=BigInt(0);for(let e=0,s=Math.min(t.length,r.length/2);e<s;++e){const s=r[2*e],i=r[2*e+1];s!==o&&(n===o||s<n)&&(n=s),i>a&&(a=i);const l=Number(i-s)/1e9;t[e]+=l}s+=Number(a-n)/1e9}if(this._gpuLastUtilisation=CC.clamp(s,0,1),this._runtime.IsDebug()){const s=e.GetLayers(),i=new Map;for(let e=0,r=Math.min(s.length,t.length-1);e<r;++e){const r=t[e+1];i.set(s[e],r)}const r=[],n=new Map;for(const[e,t]of i){const s=[...e.selfAndAllSubLayers()].reduce((e,t)=>e+(i.get(t)||0),0);n.set(e,s),r.push({name:e.GetName(),lastSelfUtilisation:CC.clamp(t,0,1),lastTotalUtilisation:CC.clamp(s,0,1)})}const a=this._gpuLastUtilisation-e._GetRootLayers().reduce((e,t)=>e+(n.get(t)||0),0);self.C3Debugger.UpdateGPUProfile(CC.clamp(a,0,1),this._gpuLastUtilisation,r)}for(let e=this._gpuTimeStartFrame;e<this._gpuTimeEndFrame;++e)this._webgpuFrameTimings.delete(e);this._gpuTimeStartFrame=this._gpuTimeEndFrame,this._gpuTimeEndFrame=0}_AddWebGPUFrameTiming(e){this._webgpuFrameTimings.set(this._webgpuRenderer.GetFrameNumber(),e)}GetGPUUtilisation(){return this._gpuLastUtilisation}SnapshotCanvas(e,t,s,i,r,n){return this._snapshotFormat=e,this._snapshotQuality=t,this._snapshotArea.setWH(s,i,r,n),this._snapshotPromise||(this._snapshotPromise=new Promise(e=>{this._snapshotResolve=e})),this._snapshotPromise}_MaybeTakeSnapshot(){if(!this._snapshotFormat)return;let e=this.GetMainCanvas();const t=this._snapshotArea,s=CC.clamp(Math.floor(t.getLeft()),0,e.width),i=CC.clamp(Math.floor(t.getTop()),0,e.height);let r=t.width();r=0===r?e.width-s:CC.clamp(Math.floor(r),0,e.width-s);let n=t.height();if(n=0===n?e.height-i:CC.clamp(Math.floor(n),0,e.height-i),(0!==s||0!==i||r!==e.width||n!==e.height)&&r>0&&n>0){const t=CC.CreateCanvas(r,n);t.getContext("2d").drawImage(e,s,i,r,n,0,0,r,n),e=t}CC.CanvasToBlob(e,this._snapshotFormat,this._snapshotQuality).then(e=>{this._snapshotUrl&&URL.revokeObjectURL(this._snapshotUrl),this._snapshotUrl=URL.createObjectURL(e),this._snapshotPromise=null,this._snapshotResolve(e)}),this._snapshotFormat="",this._snapshotQuality=1}GetCanvasSnapshotUrl(){return this._snapshotUrl}SetIsPastingToDrawingCanvas(e){e?this._isPastingToDrawingCanvas++:this._isPastingToDrawingCanvas--}IsPastingToDrawingCanvas(){return this._isPastingToDrawingCanvas>0}InitLoadingScreen(e){const t=this.GetRenderer();if(2===e)this._percentText=CC.New(CC.Gfx.RendererText,this.GetRenderer()),this._percentText.SetFontName("Arial"),this._percentText.SetFontSize(16),this._percentText.SetHorizontalAlignment("center"),this._percentText.SetVerticalAlignment("center"),this._percentText.SetSize(300,200);else if(0===e){const e=this._runtime.GetLoadingLogoAsset();e&&e.LoadStaticTexture(t).catch(e=>console.warn("[C3 runtime] Failed to create texture for loading logo: ",e))}else 4===e&&(this._LoadSvgSplashImage("splash-images/splash-logo.svg").then(e=>{"done"===this._splashState?t.DeleteTexture(e):this._splashTextures.logo=e}).catch(e=>console.warn("Failed to load splash image: ",e)),this._LoadBitmapSplashImage("splash-images/splash-poweredby-512.png").then(e=>{"done"===this._splashState?t.DeleteTexture(e):this._splashTextures.powered=e}).catch(e=>console.warn("Failed to load splash image: ",e)),this._LoadBitmapSplashImage("splash-images/splash-website-512.png").then(e=>{"done"===this._splashState?t.DeleteTexture(e):this._splashTextures.website=e}).catch(e=>console.warn("Failed to load splash image: ",e)))}async _LoadSvgSplashImage(e){e=new URL(e,this._runtime.GetRuntimeBaseURL()).toString();const t=await CC.FetchBlob(e),s=await this._runtime.RasterSvgImage(t,2048,2048);return await this.GetRenderer().CreateStaticTextureAsync(s,{mipMapQuality:"high"})}async _LoadBitmapSplashImage(e){e=new URL(e,this._runtime.GetRuntimeBaseURL()).toString();const t=await CC.FetchBlob(e);return await this.GetRenderer().CreateStaticTextureAsync(t,{mipMapQuality:"high"})}HideCordovaSplashScreen(){this._runtime.PostComponentMessageToDOM("runtime","hide-cordova-splash")}StartLoadingScreen(){this._loaderStartTime=Date.now(),this._runtime.Dispatcher().addEventListener("loadingprogress",this._loadingprogress_handler),this._rafId=requestAnimationFrame(()=>this._DrawLoadingScreen()),3!==this._runtime.GetLoaderStyle()&&this.HideCordovaSplashScreen()}async EndLoadingScreen(){const e=this.GetRenderer();this._loadingProgress=1;const t=this._runtime.GetLoaderStyle();4===t&&await this._splashDonePromise,this._splashDoneResolve=null,this._splashDonePromise=null,-1!==this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=-1),this._runtime.Dispatcher().removeEventListener("loadingprogress",this._loadingprogress_handler),this._loadingprogress_handler=null,this._percentText&&(this._percentText.Release(),this._percentText=null),this._runtime.ReleaseLoadingLogoAsset(),e.Start(),this._splashTextures.logo&&(e.DeleteTexture(this._splashTextures.logo),this._splashTextures.logo=null),this._splashTextures.powered&&(e.DeleteTexture(this._splashTextures.powered),this._splashTextures.powered=null),this._splashTextures.website&&(e.DeleteTexture(this._splashTextures.website),this._splashTextures.website=null),e.ClearRgba(0,0,0,0),e.Finish(),this._splashState="done",this._gpuTimeStartFrame=e.GetFrameNumber(),3===t&&this.HideCordovaSplashScreen()}_DrawLoadingScreen(){if(-1===this._rafId)return;const e=this.GetRenderer();e.Start(),this._rafId=-1;const t=this._runtime.GetAssetManager().HasHadErrorLoading(),s=this._runtime.GetLoaderStyle();if(3!==s&&(this.SetCssTransform(e),e.ClearRgba(0,0,0,0),e.ResetColor(),e.SetTextureFillMode(),e.SetTexture(null)),0===s)this._DrawProgressBarAndLogoLoadingScreen(t);else if(1===s)this._DrawProgressBarLoadingScreen(t,120,0);else if(2===s)this._DrawPercentTextLoadingScreen(t);else if(3===s)CC.noop();else{if(4!==s)throw new Error("invalid loader style");this._DrawSplashLoadingScreen(t)}e.Finish(),this._rafId=requestAnimationFrame(()=>this._DrawLoadingScreen())}_DrawPercentTextLoadingScreen(e){e?this._percentText.SetColorRgb(1,0,0):this._percentText.SetColorRgb(.6,.6,.6),this._percentText.SetText(Math.round(100*this._loadingProgress)+"%");const t=this._canvasCssWidth/2,s=this._canvasCssHeight/2;BC.setRect(t-150,s-100,t+150,s+100);const i=this.GetRenderer();i.SetTexture(this._percentText.GetTexture()),i.Quad3(BC,this._percentText.GetTexRect())}_DrawProgressBarLoadingScreen(e,t,s){const i=this.GetRenderer();i.SetColorFillMode(),e?i.SetColorRgba(1,0,0,1):i.SetColorRgba(.118,.565,1,1);const r=this._canvasCssWidth/2,n=this._canvasCssHeight/2,a=t/2;LC.setWH(r-a,n-4+s,Math.floor(t*this._loadingProgress),8),i.Rect(LC),LC.setWH(r-a,n-4+s,t,8),LC.offset(-.5,-.5),LC.inflate(.5,.5),i.SetColorRgba(0,0,0,1),i.LineRect2(LC),LC.inflate(1,1),i.SetColorRgba(1,1,1,1),i.LineRect2(LC)}_DrawProgressBarAndLogoLoadingScreen(e){const t=this.GetRenderer(),s=this._runtime.GetLoadingLogoAsset();if(!s)return void this._DrawProgressBarLoadingScreen(e,120,0);const i=s.GetTexture();if(!i)return void this._DrawProgressBarLoadingScreen(e,120,0);const r=i.GetWidth(),n=i.GetHeight(),a=this._canvasCssWidth/2,o=this._canvasCssHeight/2,l=r/2,h=n/2;BC.setRect(a-l,o-h,a+l,o+h),t.SetTexture(i),t.Quad(BC),this._DrawProgressBarLoadingScreen(e,r,h+16)}_DrawSplashLoadingScreen(e){const t=this.GetRenderer(),s=this._splashTextures.logo,i=this._splashTextures.powered,r=this._splashTextures.website,n=Date.now();0===this._splashFrameNumber&&(this._loaderStartTime=n);const a=this._runtime.IsPreview()||this._runtime.IsFBInstantAvailable()&&!this._runtime.IsCordova(),o=a?0:200,l=a?0:3e3;let h=1;"fade-in"===this._splashState?h=Math.min((n-this._loaderStartTime)/300,1):"fade-out"===this._splashState&&(h=Math.max(1-(n-this._splashFadeOutStartTime)/300,0)),t.SetColorFillMode(),t.SetColorRgba(.231*h,.251*h,.271*h,h),LC.set(0,0,this._canvasCssWidth,this._canvasCssHeight),t.Rect(LC);const u=Math.ceil(this._canvasCssWidth),c=Math.ceil(this._canvasCssHeight);let d,p;this._canvasCssHeight>256?(t.SetColorRgba(.302*h,.334*h,.365*h,h),d=u,p=Math.max(.005*c,2),LC.setWH(0,.8*c-p/2,d,p),t.Rect(LC),e?t.SetColorRgba(h,0,0,h):t.SetColorRgba(.161*h,.953*h,.816*h,h),d=u*this._loadingProgress,LC.setWH(.5*u-d/2,.8*c-p/2,d,p),t.Rect(LC),t.SetColorRgba(h,h,h,h),t.SetTextureFillMode(),i&&(d=1.5*CC.clamp(.22*c,105,.6*u),p=d/8,LC.setWH(.5*u-d/2,.2*c-p/2,d,p),t.SetTexture(i),t.Rect(LC)),s&&(d=Math.min(.395*c,.95*u),p=d,LC.setWH(.5*u-d/2,.485*c-p/2,d,p),t.SetTexture(s),t.Rect(LC)),r&&(d=1.5*CC.clamp(.22*c,105,.6*u),p=d/8,LC.setWH(.5*u-d/2,.868*c-p/2,d,p),t.SetTexture(r),t.Rect(LC))):(t.SetColorRgba(.302*h,.334*h,.365*h,h),d=u,p=Math.max(.005*c,2),LC.setWH(0,.85*c-p/2,d,p),t.Rect(LC),e?t.SetColorRgba(h,0,0,h):t.SetColorRgba(.161*h,.953*h,.816*h,h),d=u*this._loadingProgress,LC.setWH(.5*u-d/2,.85*c-p/2,d,p),t.Rect(LC),t.SetColorRgba(h,h,h,h),t.SetTextureFillMode(),s&&(d=.55*c,p=d,LC.setWH(.5*u-d/2,.45*c-p/2,d,p),t.SetTexture(s),t.Rect(LC))),this._splashFrameNumber++,"fade-in"===this._splashState&&n-this._loaderStartTime>=300&&this._splashFrameNumber>=2&&(this._splashState="wait",this._splashFadeInFinishTime=n),"wait"===this._splashState&&n-this._splashFadeInFinishTime>=l&&this._loadingProgress>=1&&(this._splashState="fade-out",this._splashFadeOutStartTime=n),("fade-out"===this._splashState&&n-this._splashFadeOutStartTime>=300+o||a&&this._loadingProgress>=1&&n-this._loaderStartTime<500)&&this._splashDoneResolve()}}}{const WC=self.C3,HC=self.C3Debugger,zC=self.assert,jC=self.ISDKBehaviorInstanceBase,YC={messagePort:null,runtimeBaseUrl:"",headless:!1,hasDom:!0,isInWorker:!1,useAudio:!0,exportType:""};let qC=!0;WC.Runtime=class extends WC.DefendedBase{constructor(e){e=Object.assign({},YC,e),super(),this._messagePort=e.messagePort,this._runtimeBaseUrl=e.runtimeBaseUrl,this._previewUrl=e.previewUrl,this._isHeadless=!!e.headless,this._hasDom=!!e.hasDom,this._isInWorker=!!e.isInWorker,qC=e.ife,this._useAudio=!!e.useAudio,this._exportType=e.exportType,this._isNWjs=e.isNWjs,this._isiOSCordova=!!e.isiOSCordova,this._isiOSWebView=!!e.isiOSWebView,this._isWindowsWebView2=!!e.isWindowsWebView2,this._isAnyWebView2Wrapper=!!e.isAnyWebView2Wrapper,this._isFBInstantAvailable=!!e.isFBInstantAvailable,this._isDebug=!("preview"!==this._exportType||!e.isDebug),this._breakpointsEnabled=this._isDebug,this._isDebugging=this._isDebug,this._debuggingDisabled=0,this._additionalLoadPromises=[],this._additionalCreatePromises=[],this._isUsingCreatePromises=!1,this._projectName="",this._projectVersion="",this._projectUniqueId="",this._appId="",this._exportTimestamp=0,this._originalViewportWidth=0,this._originalViewportHeight=0,this._devicePixelRatio=self.devicePixelRatio,this._parallaxXorigin=0,this._parallaxYorigin=0,this._viewportWidth=0,this._viewportHeight=0,this._loaderStyle=0,this._usesLoaderLayout=!1,this._isLoading=!0,this._usesAnyBackgroundBlending=!1,this._usesAnyCrossSampling=!1,this._usesAnyDepthSampling=!1,this._loadingLogoAsset=null,this._assetManager=WC.New(WC.AssetManager,this,e),this._layoutManager=WC.New(WC.LayoutManager,this),this._eventSheetManager=WC.New(WC.EventSheetManager,this),this._addonManager=WC.New(WC.AddonManager,this,e.wrapperComponentIds),this._collisionEngine=WC.New(WC.CollisionEngine,this),this._timelineManager=WC.New(WC.TimelineManager,this),this._transitionManager=WC.New(WC.TransitionManager,this),this._templateManager=WC.New(WC.TemplateManager,this),this._flowchartManager=WC.New(WC.FlowchartManager,this),this._textIconManager=WC.New(WC.TextIconManager,{getIconSetMeta:e=>this._GetTextIconSetMeta(e),getIconSetContent:e=>this._GetTextIconSetContent(e)}),this._iconChangeHandlers=new Map,this._allObjectClasses=[],this._objectClassesByName=new Map,this._objectClassesBySid=new Map,this._familyCount=0,this._allContainers=[],this._allEffectLists=new Set,this._currentLayoutStack=[],this._instancesPendingCreate=[],this._instancesPendingDestroy=new Map,this._hasPendingInstances=!1,this._isFlushingPendingInstances=!1,this._objectCount=0,this._nextUid=0,this._instancesByUid=new Map,this._instancesPendingRelease=new Set,this._instancesPendingReleaseAffectedObjectClasses=new Set,this._objectReferenceTable=[],this._jsPropNameTable=[],this._canvasManager=null,this._uses3dFeatures=!1,this._framerateMode="vsync",this._sampling="trilinear",this._isPixelRoundingEnabled=!1,this._needRender=!0,this._pauseOnBlur=!1,this._isPausedOnBlur=!1,this._exportToVideo=null,this._tickCallbacks={normal:e=>{this._rafId=-1,this._ruafId=-1,this.Tick(e)},tickOnly:e=>{this._ruafId=-1,this.Tick(e,!1,"skip-render")},renderOnly:()=>{this._rafId=-1,this.Render()}},this._rafId=-1,this._ruafId=-1,this._tickCount=0,this._tickCountNoSave=0,this._hasStarted=!1,this._isInTick=!1,this._hasStartedTicking=!1,this._isLayoutFirstTick=!0,this._isAutoSuspendEnabled=!0,this._isPageVisibilitySuspended=!1,this._suspendCount=0,this._scheduleTriggersThrottle=new WC.PromiseThrottle(1),this._randomNumberCallback=()=>Math.random(),this._startTime=0,this._lastTickTime=0,this._dtRaw=0,this._dt1=0,this._dt=0,this._timeScale=1,this._maxDt=1/30,this._minDt=0,this._gameTime=WC.New(WC.KahanSum),this._gameTimeRaw=WC.New(WC.KahanSum),this._wallTime=WC.New(WC.KahanSum),this._instanceTimes=new Map,this._fpsFrameCount=-1,this._fpsLastTime=0,this._fps=0,this._tpsTickCount=-1,this._tps=0,this._mainThreadTimeCounter=0,this._mainThreadTime=0,this._isLoadingState=!1,this._saveToSlotName="",this._saveToJsonString=!1,this._loadFromSlotName="",this._loadFromJson=null,this._lastSaveJson="",this._projectStorage=null,this._savegamesStorage=null,this._dispatcher=WC.New(WC.Event.Dispatcher),this._domEventHandlers=new Map,this._pendingResponsePromises=new Map,this._nextDomResponseId=0,this._didRequestDeviceOrientationEvent=!1,this._didRequestDeviceMotionEvent=!1,this._isReadyToHandleEvents=!1,this._waitingToHandleEvents=[],this._eventObjects={pretick:WC.New(WC.Event,"pretick",!1),tick:WC.New(WC.Event,"tick",!1),tick2:WC.New(WC.Event,"tick2",!1),instancecreate:WC.New(WC.Event,"instancecreate",!1),instancedestroy:WC.New(WC.Event,"instancedestroy",!1),beforelayoutchange:WC.New(WC.Event,"beforelayoutchange",!1),layoutchange:WC.New(WC.Event,"layoutchange",!1)},this._eventObjects.instancecreate.instance=null,this._eventObjects.instancedestroy.instance=null,this._userScriptDispatcher=WC.New(WC.Event.Dispatcher),this._userScriptEventObjects=null;const t=(e,t)=>WC.BehaviorInstance.SortByTickSequence(this,e,t);this._behInstsToTick=WC.New(WC.RedBlackSet,t),this._behInstsToPostTick=WC.New(WC.RedBlackSet,t),this._behInstsToTick2=WC.New(WC.RedBlackSet,t),this._jobScheduler=WC.New(WC.JobSchedulerRuntime,this,e.jobScheduler),e.canvas&&(this._canvasManager=WC.New(WC.CanvasManager,this)),this._messagePort.onmessage=e=>this._OnMessageFromDOM(e.data),this.AddDOMComponentMessageHandler("runtime","visibilitychange",e=>this._OnVisibilityChange(e)),this.AddDOMComponentMessageHandler("runtime","wrapper-extension-message",e=>this._OnWrapperExtensionMessage(e)),this.AddDOMComponentMessageHandler("runtime","get-remote-preview-status-info",()=>this._GetRemotePreviewStatusInfo()),this.AddDOMComponentMessageHandler("runtime","js-invoke-function",e=>this._InvokeFunctionFromJS(e)),this.AddDOMComponentMessageHandler("runtime","go-to-last-error-script",self.goToLastErrorScript),this.AddDOMComponentMessageHandler("runtime","offline-audio-render-completed",e=>this._OnOfflineAudioRenderCompleted(e)),this._dispatcher.addEventListener("window-blur",e=>this._OnWindowBlur(e)),this._dispatcher.addEventListener("window-focus",()=>this._OnWindowFocus()),this._timelineManager.AddRuntimeListeners(),this._templateManager.AddRuntimeListeners(),this._iRuntime=null,this._interfaceMap=new WeakMap,this._commonScriptInterfaces={keyboard:null,mouse:null,touch:null,timelineController:null},this._instancesNeedingAfterLoadMap=new WeakMap,this._instancesNeedingAfterLoadArray=[]}static Create(e){return WC.New(WC.Runtime,e)}Release(){WC.clearArray(this._allObjectClasses),this._objectClassesByName.clear(),this._objectClassesBySid.clear(),this._layoutManager.Release(),this._layoutManager=null,this._eventSheetManager.Release(),this._eventSheetManager=null,this._addonManager.Release(),this._addonManager=null,this._assetManager.Release(),this._assetManager=null,this._collisionEngine.Release(),this._collisionEngine=null,this._timelineManager.Release(),this._timelineManager=null,this._transitionManager.Release(),this._transitionManager=null,this._templateManager.Release(),this._templateManager=null,this._flowchartManager.Release(),this._flowchartManager=null,this._textIconManager.Release(),this._textIconManager=null,this._canvasManager&&(this._canvasManager.Release(),this._canvasManager=null),this._dispatcher.Release(),this._dispatcher=null,this._tickEvent=null}_OnMessageFromDOM(e){const t=e.type;if("event"===t)this._OnEventFromDOM(e);else{if("result"!==t)throw new Error(`unknown message '${t}'`);this._OnResultFromDOM(e)}}_OnEventFromDOM(e){if(!this._isReadyToHandleEvents)return void this._waitingToHandleEvents.push(e);const t=e.component,s=e.handler,i=e.data,r=e.dispatchOpts,n=!(!r||!r.dispatchRuntimeEvent),a=!(!r||!r.dispatchUserScriptEvent),o=e.responseId;if("runtime"===t){if(n){const e=new WC.Event(s);e.data=i,this._dispatcher.dispatchEventAndWaitAsyncSequential(e)}if(a){const e=new WC.Event(s,!0);for(const[t,s]of Object.entries(i))e[t]=s;this.DispatchUserScriptEvent(e)}}const l=this._domEventHandlers.get(t);if(!l)return void(n||a||console.warn(`[Runtime] No DOM event handlers for component '${t}'`));const h=l.get(s);if(!h)return void(n||a||console.warn(`[Runtime] No DOM handler '${s}' for component '${t}'`));let u=null;try{u=h(i)}catch(e){return console.error(`Exception in '${t}' handler '${s}':`,e),void(null!==o&&this._PostResultToDOM(o,!1,""+e))}null!==o&&(u&&u.then?u.then(e=>this._PostResultToDOM(o,!0,e)).catch(e=>{console.error(`Rejection from '${t}' handler '${s}':`,e),this._PostResultToDOM(o,!1,""+e)}):this._PostResultToDOM(o,!0,u))}_PostResultToDOM(e,t,s){this._messagePort.postMessage({type:"result",responseId:e,isOk:t,result:s})}_OnResultFromDOM(e){const t=e.responseId,s=e.isOk,i=e.result,r=this._pendingResponsePromises.get(t);s?r.resolve(i):r.reject(i),this._pendingResponsePromises.delete(t)}AddDOMComponentMessageHandler(e,t,s){let i=this._domEventHandlers.get(e);if(i||(i=new Map,this._domEventHandlers.set(e,i)),i.has(t))throw new Error(`[Runtime] Component '${e}' already has handler '${t}'`);i.set(t,s)}PostComponentMessageToDOM(e,t,s,i){this._messagePort.postMessage({type:"event",component:e,handler:t,data:s,responseId:null},i)}PostComponentMessageToDOMAsync(e,t,s,i){const r=this._nextDomResponseId++,n=new Promise((e,t)=>{this._pendingResponsePromises.set(r,{resolve:e,reject:t})});return this._messagePort.postMessage({type:"event",component:e,handler:t,data:s,responseId:r},i),n}SendWrapperExtensionMessage(e,t,s,i=-1){this.PostComponentMessageToDOM("runtime","send-wrapper-extension-message",{componentId:e,messageId:t,params:s,asyncId:i})}SendWrapperExtensionMessageAsync(e,t,s){const i=this._nextDomResponseId++,r=new Promise((e,t)=>{this._pendingResponsePromises.set(i,{resolve:e,reject:t})});return this.SendWrapperExtensionMessage(e,t,s,i),r}_OnWrapperExtensionMessage(e){if(-1!==e.asyncId){const t=e.asyncId;this._pendingResponsePromises.get(t).resolve(e.params),this._pendingResponsePromises.delete(t)}else this._OnEventFromDOM({component:"wrapper-extension:"+e.componentId,handler:e.messageId,data:e.params,responseId:null})}AddWrapperExtensionMessageHandler(e,t,s){this.AddDOMComponentMessageHandler("wrapper-extension:"+e,t,s)}HasWrapperComponentId(e){return this._addonManager.HasWrapperComponentId(e)}PostToDebugger(e){if(!this.IsDebug())throw new Error("not in debug mode");this.PostComponentMessageToDOM("runtime","post-to-debugger",e)}async Init(e){WC.CommonACES_SetRuntime(this),this.IsDebug()?await HC.Init(this):self.C3Debugger&&self.C3Debugger.InitPreview(this);const t=await this._assetManager.FetchJson("data.json");if(await this._LoadDataJson(t),await this._InitialiseCanvas(e),this.IsPreview()||console.info("%cMade with Construct, the game and animation creation tool. Visit: https://www.construct.net","font-weight: bold"),this.GetWebGLRenderer()){const e=this.GetWebGLRenderer();console.info(`[C3 runtime] Hosted in ${this.IsInWorker()?"worker":"DOM"}, rendering with WebGL ${e.GetWebGLVersionNumber()} [${e.GetUnmaskedRenderer()}]`)}else this.GetWebGPURenderer()&&console.info(`[C3 runtime] Hosted in ${this.IsInWorker()?"worker":"DOM"}, rendering with WebGPU [${this.GetWebGPURenderer().GetAdapterInfoString()}]`);this.GetRenderer().HasMajorPerformanceCaveat()&&console.warn("[C3 runtime] The renderer indicates a major performance caveat. Software rendering may be in use. This can result in significantly degraded performance."),this._isReadyToHandleEvents=!0;for(const e of this._waitingToHandleEvents)this._OnEventFromDOM(e);WC.clearArray(this._waitingToHandleEvents),this._canvasManager&&this._canvasManager.StartLoadingScreen();for(const t of e.runOnStartupFunctions)this._additionalLoadPromises.push(this._RunOnStartupFunction(t));if(await Promise.all([this._assetManager.WaitForAllToLoad(),...this._additionalLoadPromises]),WC.clearArray(this._additionalLoadPromises),!this._assetManager.HasHadErrorLoading())return this._canvasManager&&await this._canvasManager.EndLoadingScreen(),await this._dispatcher.dispatchEventAndWaitAsync(new WC.Event("beforeruntimestart")),await this.Start(),this._messagePort.postMessage({type:"runtime-ready"}),this;this._canvasManager&&this._canvasManager.HideCordovaSplashScreen()}async _RunOnStartupFunction(e){try{await e(this._iRuntime)}catch(e){console.error("[C3 runtime] Error in runOnStartup function: ",e)}}async _LoadDataJson(e){const t=e.project;this._projectName=t[0],this._projectVersion=t[16],this._projectUniqueId=t[31],this._appId=t[38],this._exportTimestamp=t[36];const s=t[39]||"loading-logo.png";this._isPixelRoundingEnabled=!!t[9],this._originalViewportWidth=this._viewportWidth=t[10],this._originalViewportHeight=this._viewportHeight=t[11],this._collisionEngine._InitCollisionCellSize(this._originalViewportWidth,this._originalViewportHeight),this._parallaxXorigin=this._originalViewportWidth/2,this._parallaxYorigin=this._originalViewportHeight/2,this._framerateMode=t[37],this._uses3dFeatures=!!t[40],this._sampling=t[14],this._usesAnyBackgroundBlending=t[15],this._usesAnyCrossSampling=t[42],this._usesAnyDepthSampling=t[17],this._usesLoaderLayout=!!t[18],this._loaderStyle=t[19],this._nextUid=t[21],this._pauseOnBlur=t[22];const i=this._assetManager;if(i._SetFileStructure(t[45]),i._SetAudioFiles(t[7],t[25]),i._SetMediaSubfolder(t[8]),i._SetFontsSubfolder(t[32]),i._SetIconsSubfolder(t[28]),i._SetWebFonts(t[29]),0===this._loaderStyle){let e="";e="flat"===i.GetFileStructure()?i.GetIconsSubfolder()+s:s,e&&(this._loadingLogoAsset=i.LoadImage({url:e}))}this._canvasManager&&(this._canvasManager.SetFullscreenMode(WC.CanvasManager._FullscreenModeNumberToString(t[12])),this._canvasManager.SetFullscreenScalingQuality(t[23]?"high":"low"),this._canvasManager.SetMipmapsEnabled(0!==t[24]),this._canvasManager._SetGPUPowerPreference(t[34]),this._canvasManager._SetTextureAnisotropy(t[41]),this._canvasManager._SetWebGPUEnabled(t[13]),this._canvasManager._SetZAxisScale(t[30]),this._canvasManager._SetZDistances(t[46],t[47]),this._canvasManager._SetInitFieldOfView(t[26]),this._canvasManager._SetLimitedToWebGL1(t[48]),this._canvasManager._SetMultitexturingMode(t[50]));const r=t[43];r&&await this._LoadExportToVideoData(r),this._InitScriptInterfaces(),this._addonManager.CreateSystemPlugin(),this._objectReferenceTable=self.C3_GetObjectRefTable();const n=t[2];for(const e of n[1])this._addonManager.CreateBehavior(e);for(const e of n[0])this._addonManager.CreatePlugin(e);this._objectReferenceTable=self.C3_GetObjectRefTable(),this._LoadJsPropNameTable(),this._addonManager._InitAddonScriptInterfaces();for(const e of t[3]){const t=WC.ObjectClass.Create(this,this._allObjectClasses.length,e);this._allObjectClasses.push(t),this._objectClassesByName.set(t.GetName().toLowerCase(),t),this._objectClassesBySid.set(t.GetSID(),t)}for(const e of t[4])this._allObjectClasses[e[0]]._LoadFamily(e);for(const e of t[27]){const t=e.map(e=>this._allObjectClasses[e]);this._allContainers.push(WC.New(WC.Container,this,t))}this._InitObjectsScriptInterface();for(const e of this._allObjectClasses)e._OnAfterCreate();for(const e of t[5])this._layoutManager.Create(e);const a=t[1];if(a){const e=this._layoutManager.GetLayoutByName(a);e&&this._layoutManager.SetFirstLayout(e)}for(const e of t[35])this._transitionManager.Create(e);for(const e of t[33])this._timelineManager.Create(e);for(const e of t[44])this._templateManager.Create(e);this._templateManager.HasTemplates()||(this._templateManager.Release(),this._templateManager=null);for(const e of t[49])this._flowchartManager.Create(e);this._flowchartManager.HasFlowcharts()||(this._flowchartManager.Release(),this._flowchartManager=null);for(const e of t[6])this._eventSheetManager.Create(e);this._eventSheetManager._PostInit(),this._InitGlobalVariableScriptInterface(),WC.clearArray(this._objectReferenceTable),this.FlushPendingInstances();let o="any";const l=t[20];1===l?o="portrait":2===l&&(o="landscape"),this.PostComponentMessageToDOM("runtime","set-target-orientation",{targetOrientation:o})}async _LoadExportToVideoData(e){const t=e.format;"image-sequence"===t?this._exportToVideo=new self.C3ExportToImageSequence(this,e):"image-sequence-gif"===t?this._exportToVideo=new self.C3ExportToGIF(this,e):"webm"===t?this._exportToVideo=new self.C3ExportToWebMVideo(this,e):"mp4"===t&&(this._exportToVideo=new self.C3ExportToMP4Video(this,e)),this._framerateMode="unlimited-frame",this._canvasManager.SetFullscreenMode("off"),this._devicePixelRatio=1,self.devicePixelRatio=1,await this.PostComponentMessageToDOMAsync("runtime","set-exporting-to-video",{message:this._exportToVideo.GetExportingMessageForPercent(0),duration:this._exportToVideo.GetDuration()})}GetLoaderStyle(){return this._loaderStyle}IsExportToVideo(){return null!==this._exportToVideo}GetExportVideoDuration(){return this._exportToVideo.GetDuration()}GetExportVideoFramerate(){return this._exportToVideo.GetFramerate()}_InitExportToVideo(){return this._exportToVideo.Init({width:this._canvasManager.GetDeviceWidth(),height:this._canvasManager.GetDeviceHeight()})}_ExportToVideoAddFrame(){const e=this._tickCount/this.GetExportVideoFramerate();return this._exportToVideo.AddFrame(this._canvasManager.GetMainCanvas(),e)}_ExportToVideoAddKeyframe(){this._exportToVideo&&this._exportToVideo.AddKeyframe()}_OnOfflineAudioRenderCompleted(e){this._exportToVideo.OnOfflineAudioRenderCompleted(e)}_ExportToVideoFinish(){return this._exportToVideo.Finish()}IsFBInstantAvailable(){return this._isFBInstantAvailable}IsLoading(){return this._isLoading}AddLoadPromise(e){this._additionalLoadPromises.push(e)}SetUsingCreatePromises(e){this._isUsingCreatePromises=!!e}AddCreatePromise(e){this._isUsingCreatePromises&&this._additionalCreatePromises.push(e)}GetCreatePromises(){return this._additionalCreatePromises}_GetNextFamilyIndex(){return this._familyCount++}GetFamilyCount(){return this._familyCount}_AddEffectList(e){this._allEffectLists.add(e)}_RemoveEffectList(e){this._allEffectLists.delete(e)}_GetAllEffectLists(){return this._allEffectLists}async _InitialiseCanvas(e){this._canvasManager&&(await this._canvasManager.CreateCanvas(e),this._canvasManager.InitLoadingScreen(this._loaderStyle))}async Start(){this._hasStarted=!0,this._startTime=Date.now();let e=null;const t=new Promise(t=>e=t);if(this._usesLoaderLayout){for(const e of this._allObjectClasses)e.IsFamily()||e.IsOnLoaderLayout()||!e.IsWorldType()||e.OnCreate();(async()=>{await this._assetManager.WaitForAllToLoad(),await t,this._isLoading=!1,this._OnLoadFinished()})()}else this._isLoading=!1;this._assetManager.SetInitialLoadFinished(),this.IsDebug()&&HC.RuntimeInit(qC);for(const e of this._layoutManager.GetAllLayouts())e._CreateGlobalNonWorlds();this.IsExportToVideo()&&await this._InitExportToVideo();const s=this._layoutManager.GetFirstLayout();await s._Load(null,this.GetRenderer()),await s._StartRunning(!0),this._fpsLastTime=performance.now(),e(),this._usesLoaderLayout||this._OnLoadFinished(),(await this.PostComponentMessageToDOMAsync("runtime","before-start-ticking")).isSuspended&&!this.IsExportToVideo()?(this._suspendCount++,this._isPageVisibilitySuspended=!0):this.Tick()}_OnLoadFinished(){this.Trigger(WC.Plugins.System.Cnds.OnLoadFinished,null,null),this.PostComponentMessageToDOM("runtime","register-sw")}GetObjectReference(e){e=Math.floor(e);const t=this._objectReferenceTable;if(e<0||e>=t.length)throw new Error("invalid object reference");return t[e]}_LoadJsPropNameTable(){for(const e of self.C3_JsPropNameTable){const t=WC.first(Object.keys(e));this._jsPropNameTable.push(t)}}GetJsPropName(e){e=Math.floor(e);const t=this._jsPropNameTable;if(e<0||e>=t.length)throw new Error("invalid prop reference");return t[e]}HasDOM(){return this._hasDom}IsHeadless(){return this._isHeadless}IsInWorker(){return this._isInWorker}GetRuntimeBaseURL(){return this._runtimeBaseUrl}GetPreviewURL(){return this._previewUrl}GetEventSheetManager(){return this._eventSheetManager}GetEventStack(){return this._eventSheetManager.GetEventStack()}GetCurrentEventStackFrame(){return this._eventSheetManager.GetCurrentEventStackFrame()}GetCurrentEvent(){return this._eventSheetManager.GetCurrentEvent()}GetCurrentCondition(){return this._eventSheetManager.GetCurrentCondition()}IsCurrentConditionFirst(){return 0===this.GetCurrentEventStackFrame().GetConditionIndex()}GetCurrentAction(){return this._eventSheetManager.GetCurrentAction()}GetAddonManager(){return this._addonManager}GetSystemPlugin(){return this._addonManager.GetSystemPlugin()}GetObjectClassByIndex(e){if((e=Math.floor(e))<0||e>=this._allObjectClasses.length)throw new RangeError("invalid index");return this._allObjectClasses[e]}GetObjectClassByName(e){return this._objectClassesByName.get(e.toLowerCase())||null}GetObjectClassBySID(e){return this._objectClassesBySid.get(e)||null}GetSingleGlobalObjectClassByCtor(e){const t=WC.AddonManager.GetPluginByConstructorFunction(e);return t?t.GetSingleGlobalObjectClass():null}GetAllObjectClasses(){return this._allObjectClasses}*allInstances(){for(const e of this._allObjectClasses)e.IsFamily()||(yield*e.instances())}Dispatcher(){return this._dispatcher}UserScriptDispatcher(){return this._userScriptDispatcher}DispatchUserScriptEvent(e){e.runtime=this.GetIRuntime();const t=this.IsDebug()&&!this._eventSheetManager.IsInEventEngine();t&&HC.StartMeasuringScriptTime(),this._userScriptDispatcher.dispatchEvent(e),t&&HC.AddScriptTime()}DispatchUserScriptEventAsyncWait(e){return e.runtime=this.GetIRuntime(),this._userScriptDispatcher.dispatchEventAndWaitAsync(e)}GetOriginalViewportWidth(){return this._originalViewportWidth}GetOriginalViewportHeight(){return this._originalViewportHeight}SetOriginalViewportSize(e,t){if(this._originalViewportWidth===e&&this._originalViewportHeight===t)return;this._originalViewportWidth=e,this._originalViewportHeight=t;const s=this.GetLayoutManager();s.SetAllLayerProjectionChanged(),s.SetAllLayerMVChanged()}GetViewportWidth(){return this._viewportWidth}GetViewportHeight(){return this._viewportHeight}SetViewportSize(e,t){if(this._viewportWidth===e&&this._viewportHeight===t)return;this._viewportWidth=e,this._viewportHeight=t;const s=this.GetLayoutManager();s.SetAllLayerProjectionChanged(),s.SetAllLayerMVChanged()}_SetDevicePixelRatio(e){this.IsExportToVideo()||(this._devicePixelRatio=e)}GetDevicePixelRatio(){return this._devicePixelRatio}GetParallaxXOrigin(){return this._parallaxXorigin}GetParallaxYOrigin(){return this._parallaxYorigin}GetCanvasManager(){return this._canvasManager}GetDrawWidth(){return this._canvasManager?this._canvasManager.GetDrawWidth():this._viewportWidth}GetDrawHeight(){return this._canvasManager?this._canvasManager.GetDrawHeight():this._viewportHeight}GetRenderScale(){return this._canvasManager?this._canvasManager.GetRenderScale():1}GetDisplayScale(){return this._canvasManager?this._canvasManager.GetDisplayScale():1}GetEffectLayerScaleParam(){return this._canvasManager?this._canvasManager.GetEffectLayerScaleParam():1}GetEffectDevicePixelRatioParam(){return this._canvasManager?this._canvasManager.GetEffectDevicePixelRatioParam():1}GetCanvasClientX(){return this._canvasManager?this._canvasManager.GetCanvasClientX():0}GetCanvasClientY(){return this._canvasManager?this._canvasManager.GetCanvasClientY():0}GetCanvasCssWidth(){return this._canvasManager?this._canvasManager.GetCssWidth():0}GetCanvasCssHeight(){return this._canvasManager?this._canvasManager.GetCssHeight():0}GetFullscreenMode(){return this._canvasManager?this._canvasManager.GetFullscreenMode():"off"}GetAdditionalRenderTarget(e){return this._canvasManager?this._canvasManager.GetAdditionalRenderTarget(e):null}ReleaseAdditionalRenderTarget(e){this._canvasManager&&this._canvasManager.ReleaseAdditionalRenderTarget(e)}UsesAnyBackgroundBlending(){return this._usesAnyBackgroundBlending}UsesAnyCrossSampling(){return this._usesAnyCrossSampling}UsesAnyDepthSampling(){return this._usesAnyDepthSampling}GetGPUUtilisation(){return this._canvasManager?this._canvasManager.GetGPUUtilisation():NaN}IsLinearSampling(){return"nearest"!==this.GetSampling()}GetFramerateMode(){return this._framerateMode}_SetFramerateMode(e){this._framerateMode!==e&&(this._framerateMode=e,-1===this._rafId&&-1===this._ruafId||(this._CancelAnimationFrame(),this._RequestAnimationFrame()))}GetSampling(){return this._sampling}UsesLoaderLayout(){return this._usesLoaderLayout}GetLoadingLogoAsset(){return this._loadingLogoAsset}ReleaseLoadingLogoAsset(){this._loadingLogoAsset&&(this._loadingLogoAsset.ReleaseTexture(),this._loadingLogoAsset.Release(),this._loadingLogoAsset=null)}GetLayoutManager(){return this._layoutManager}GetMainRunningLayout(){return this._layoutManager.GetMainRunningLayout()}GetTimelineManager(){return this._timelineManager}GetTransitionManager(){return this._transitionManager}GetTemplateManager(){return this._templateManager}GetFlowchartManager(){return this._flowchartManager}GetAssetManager(){return this._assetManager}LoadImage(e){return this._assetManager.LoadImage(e)}CreateInstance(e,t,s,i,r,n){if(n&&this._templateManager){if(e instanceof WC.ObjectClass&&e.IsFamily()){const a=e.GetFamilyMembers(),o=Math.floor(this.Random()*a.length);return this.CreateInstance(a[o],t,s,i,r,n)}const a=this._templateManager.GetTemplateData(e,n);if(a){const e=this.CreateInstanceFromData(a,t,!1,s,i,!1,r,void 0,r);return this._templateManager.MapInstanceToTemplateName(e,n),e}}return this.CreateInstanceFromData(e,t,!1,s,i,!1,r,void 0,r)}CreateInstanceFromData(e,t,s,i,r,n,a,o,l){let h=null,u=null;if(e instanceof WC.ObjectClass){if(u=e,u.IsFamily()){const e=u.GetFamilyMembers();u=e[Math.floor(this.Random()*e.length)]}h=u.GetDefaultInstanceData()}else h=e,u=this.GetObjectClassByIndex(h[1]);const c=u.GetPlugin().IsWorldType();if(this._isLoading&&c&&!u.IsOnLoaderLayout())return null;const d=t;let p;c||(t=null),p=s&&!n&&h&&!this._instancesByUid.has(h[2])?h[2]:this._nextUid++;const _=h?h[0]:null,m=WC.New(WC.Instance,{runtime:this,objectType:u,layer:t,worldData:_,instVarData:h?h[3]:null,uid:p,tags:h?h[6]:null});this._instancesByUid.set(p,m);let f=null;if(c&&(f=m.GetWorldInfo(),void 0!==i&&void 0!==r&&(f.SetX(i),f.SetY(r)),u._SetAnyCollisionCellChanged(!0)),t&&(l||t._AddInstance(m,!0),t.GetLayout().MaybeLoadTexturesFor(u)),this._objectCount++,u.IsInContainer()&&!s&&!n){const e=new Set;for(const t of u.GetContainer().objectTypes()){if(t===u)continue;const s=this._MaybeGetChildInstanceForObjectTypeData(t,f,e);if(s){const e=this.CreateInstanceFromData(s,d,!1,f?f.GetX():i,f?f.GetY():r,!0,!1,void 0,l);m._AddSibling(e)}else{const e=this.CreateInstanceFromData(t,d,!1,f?f.GetX():i,f?f.GetY():r,!0,!1,void 0,l);m._AddSibling(e)}}for(const e of m.siblings()){e._AddSibling(m);for(const t of m.siblings())e!==t&&e._AddSibling(t)}}if(c&&!s&&a&&this._CreateChildInstancesFromData(m,_,f,t,i,r,l),u.IsInContainer()&&!s&&!n&&a)for(const e of m.siblings()){const s=e.GetWorldInfo();if(!s)continue;const i=e.GetPlugin(),r=e.GetObjectClass().GetDefaultInstanceData()[0];i.IsWorldType()?this._CreateChildInstancesFromData(e,r,s,t,s.GetX(),s.GetY(),l):this._CreateChildInstancesFromData(e,r,s,t,void 0,void 0,l)}if(!n&&a){void 0===i&&(i=_[0]),void 0===r&&(r=_[1]);const e=f.GetTopParent(),t=i-f.GetX()+e.GetX(),s=r-f.GetY()+e.GetY();e.SetXY(t,s)}u._SetIIDsStale();const g=h?WC.cloneArray(h[5]):null,y=h?h[4].map(e=>WC.cloneArray(e)):null,S=c&&_&&_[13];if(S&&m._SetHasTilemap(),m._CreateSdkInstance(g,y),S){const e=_[13];m.GetSdkInstance().LoadTilemapData(e[2],e[0],e[1])}this._instancesPendingCreate.push(m),this._hasPendingInstances=!0,this.IsDebug()&&HC.InstanceCreated(m);const T=this._eventObjects.instancecreate;return T.instance=m,this._dispatcher.dispatchEvent(T),m}_GetInstanceData(e){const t=e[0],s=e[1],i=e[2],r=e[6];return r||this._layoutManager.GetLayoutBySID(t).GetLayer(s).GetInitialInstanceData(i)}_MaybeGetChildInstanceForObjectTypeData(e,t,s){const i=t?.GetSceneGraphChildrenExportData()??[];for(const t of i){const i=this._GetInstanceData(t),r=!!t[4],n=this.GetObjectClassByIndex(i[1]);if(!s.has(i)&&e===n&&r)return s.add(i),i}}_CreateChildInstancesFromData(e,t,s,i,r,n,a){const o=s.GetSceneGraphZIndexExportData(),l=s.GetSceneGraphChildrenExportData();if(e.GetWorldInfo().SetSceneGraphZIndex(o),!l)return;void 0===r&&(r=t[0]),void 0===n&&(n=t[1]);const h=new Set,u=t[0],c=t[1];for(const t of l){const s=t[0],o=t[1],l=t[2],d=t[3],p=!!t[4],_=t[5],m=t[6];let f;f=m||this._layoutManager.GetLayoutBySID(s).GetLayer(o).GetInitialInstanceData(l);const g=this.GetObjectClassByIndex(f[1]),y=e.HasSibling(g),S=h.has(g);if(y&&!S&&p){const t=e.GetSibling(g);t.GetWorldInfo().Init(f[0]);const s=r+f[0][0]-u,i=n+f[0][1]-c;t.GetWorldInfo().SetXY(s,i),t.GetWorldInfo().SetSceneGraphZIndex(_),e.AddChild(t,{transformX:!!(1&d),transformY:!!(d>>1&1),transformWidth:!!(d>>2&1),transformHeight:!!(d>>3&1),transformAngle:!!(d>>4&1),destroyWithParent:!!(d>>5&1),transformZElevation:!!(d>>6&1),transformOpacity:!!(d>>7&1),transformVisibility:!!(d>>8&1)}),h.add(g)}else{const t=r+f[0][0]-u,s=n+f[0][1]-c,o=this.CreateInstanceFromData(f,i,!1,t,s,!1,!0,e,a);o.GetWorldInfo().SetSceneGraphZIndex(_),e.AddChild(o,{transformX:!!(1&d),transformY:!!(d>>1&1),transformWidth:!!(d>>2&1),transformHeight:!!(d>>3&1),transformAngle:!!(d>>4&1),destroyWithParent:!!(d>>5&1),transformZElevation:!!(d>>6&1),transformOpacity:!!(d>>7&1),transformVisibility:!!(d>>8&1)})}}}DestroyInstance(e){if(this._instancesPendingRelease.has(e))return;const t=e.GetObjectClass();let s=this._instancesPendingDestroy.get(t);if(s){if(s.has(e))return;s.add(e)}else s=new Set,s.add(e),this._instancesPendingDestroy.set(t,s);if(this.IsDebug()&&HC.InstanceDestroyed(e),e._MarkDestroyed(),this._hasPendingInstances=!0,e.IsInContainer())for(const t of e.siblings())this.DestroyInstance(t);for(const t of e.children())t.GetDestroyWithParent()&&this.DestroyInstance(t);if(!this._layoutManager.IsEndingLayout()&&!this._isLoadingState){const t=this.GetEventSheetManager();t.BlockFlushingInstances(!0),e._TriggerOnDestroyed(),t.BlockFlushingInstances(!1)}e._FireDestroyedScriptEvents(this._layoutManager.IsEndingLayout())}FlushPendingInstances(){this._hasPendingInstances&&(this._isFlushingPendingInstances=!0,this._FlushInstancesPendingCreate(),this._FlushInstancesPendingDestroy(),this._isFlushingPendingInstances=!1,this._hasPendingInstances=!1,this.UpdateRender())}_FlushInstancesPendingCreate(){for(const e of this._instancesPendingCreate){const t=e.GetObjectClass();t._AddInstance(e);for(const s of t.GetFamilies())s._AddInstance(e),s._SetIIDsStale()}WC.clearArray(this._instancesPendingCreate)}_FlushInstancesPendingDestroy(){this._dispatcher.SetDelayRemoveEventsEnabled(!0);for(const[e,t]of this._instancesPendingDestroy.entries())this._FlushInstancesPendingDestroyForObjectClass(e,t),t.clear();this._instancesPendingDestroy.clear(),this._dispatcher.SetDelayRemoveEventsEnabled(!1)}_FlushInstancesPendingDestroyForObjectClass(e,t){for(const e of t){const t=this._eventObjects.instancedestroy;t.instance=e,this._dispatcher.dispatchEvent(t),this._instancesByUid.delete(e.GetUID()),this._instanceTimes.delete(e);const s=e.GetWorldInfo();s&&(s._RemoveFromCollisionCells(),s._RemoveFromRenderCells(),s._MarkDestroyed()),this._instancesPendingRelease.add(e),this._objectCount--}WC.arrayRemoveAllInSet(e.GetInstances(),t),e._SetIIDsStale(),this._instancesPendingReleaseAffectedObjectClasses.add(e);for(const s of e.GetFamilies())WC.arrayRemoveAllInSet(s.GetInstances(),t),s._SetIIDsStale(),this._instancesPendingReleaseAffectedObjectClasses.add(s);if(e.GetPlugin().IsWorldType()){const e=new Set([...t].map(e=>e.GetWorldInfo().GetLayer()));for(const s of e)s._RemoveAllInstancesInSet(t)}}_GetInstancesPendingCreate(){return this._instancesPendingCreate}*instancesPendingCreateForObjectClass(e){for(const t of this._GetInstancesPendingCreate())e.IsFamily()?t.GetObjectClass().BelongsToFamily(e)&&(yield t):t.GetObjectClass()===e&&(yield t)}_GetNewUID(){return this._nextUid++}_MapInstanceByUID(e,t){this._instancesByUid.set(e,t)}_SetAutoSuspendEnabled(e){e=!!e,this._isAutoSuspendEnabled!==e&&(this._isAutoSuspendEnabled=!!e,this._isAutoSuspendEnabled&&this._isPageVisibilitySuspended&&(this.SetSuspended(!1),this._isPageVisibilitySuspended=!1))}_IsAutoSuspendEnabled(){return this._isAutoSuspendEnabled}_OnRendererContextLost(){this._dispatcher.dispatchEvent(WC.New(WC.Event,"renderercontextlost")),this.SetSuspended(!0);for(const e of this._allObjectClasses)!e.IsFamily()&&e.HasLoadedTextures()&&e.ReleaseTextures();const e=this.GetMainRunningLayout();e&&e._OnRendererContextLost(),WC.ImageInfo.OnRendererContextLost(),WC.ImageAsset.OnRendererContextLost()}async _OnRendererContextRestored(){await this.GetMainRunningLayout()._Load(null,this.GetRenderer()),this._dispatcher.dispatchEvent(WC.New(WC.Event,"renderercontextrestored")),this.SetSuspended(!1),this.UpdateRender()}_OnVisibilityChange(e){if(!this._isAutoSuspendEnabled)return;const t=e.hidden;this.SetSuspended(t),this._isPageVisibilitySuspended=t,t||this.UpdateRender()}_OnWindowBlur(e){this.IsPreview()&&this._pauseOnBlur&&!WC.Platform.IsMobile&&(e.data.parentHasFocus||(this.SetSuspended(!0),this._isPausedOnBlur=!0))}_OnWindowFocus(){this._isPausedOnBlur&&(this.SetSuspended(!1),this._isPausedOnBlur=!1)}_RequestAnimationFrame(){const e=this._tickCallbacks;"vsync"===this._framerateMode?-1===this._rafId&&(this._rafId=self.requestAnimationFrame(e.normal)):"unlimited-tick"===this._framerateMode?(-1===this._ruafId&&(this._ruafId=WC.RequestUnlimitedAnimationFrame(e.tickOnly)),-1===this._rafId&&(this._rafId=self.requestAnimationFrame(e.renderOnly))):-1===this._ruafId&&(this._ruafId=WC.RequestUnlimitedAnimationFrame(e.normal))}_CancelAnimationFrame(){-1!==this._rafId&&(self.cancelAnimationFrame(this._rafId),this._rafId=-1),-1!==this._ruafId&&(WC.CancelUnlimitedAnimationFrame(this._ruafId),this._ruafId=-1)}IsSuspended(){return this._suspendCount>0}SetSuspended(e){if(this.IsExportToVideo())return;const t=this.IsSuspended();this._suspendCount+=e?1:-1,this._suspendCount<0&&(this._suspendCount=0);const s=this.IsSuspended();if(!t&&s)console.log("[Construct] Suspending"),this._CancelAnimationFrame(),this._dispatcher.dispatchEvent(WC.New(WC.Event,"suspend")),this.DispatchUserScriptEvent(WC.New(WC.Event,"suspend")),this.Trigger(WC.Plugins.System.Cnds.OnSuspend,null,null);else if(t&&!s){console.log("[Construct] Resuming");const e=performance.now();this._lastTickTime=e,this._fpsLastTime=e,this._fpsFrameCount=0,this._fps=0,this._tpsTickCount=0,this._tps=0,this._mainThreadTime=0,this._mainThreadTimeCounter=0,this._dispatcher.dispatchEvent(WC.New(WC.Event,"resume")),this.DispatchUserScriptEvent(WC.New(WC.Event,"resume")),this.Trigger(WC.Plugins.System.Cnds.OnResume,null,null),this.HitBreakpoint()||this.Tick(e)}}_AddBehInstToTick(e){this._behInstsToTick.Add(e)}_AddBehInstToPostTick(e){this._behInstsToPostTick.Add(e)}_AddBehInstToTick2(e){this._behInstsToTick2.Add(e)}_RemoveBehInstToTick(e){this._behInstsToTick.Remove(e)}_RemoveBehInstToPostTick(e){this._behInstsToPostTick.Remove(e)}_RemoveBehInstToTick2(e){this._behInstsToTick2.Remove(e)}_CallBehaviorTickMethod(e,t){const s=t?performance.now():0;let i;return e instanceof jC?(i=e._tick(),t&&HC.AddIndividualBehaviorTickTime(e.behavior,performance.now()-s)):(i=e.Tick(),t&&HC.AddIndividualBehaviorTickTime(e.GetBehavior(),performance.now()-s)),i}_BehaviorTick(){const e=this.IsDebug();this._behInstsToTick.SetQueueingEnabled(!0);for(const t of this._behInstsToTick)this._CallBehaviorTickMethod(t,e);this._behInstsToTick.SetQueueingEnabled(!1)}_CallBehaviorPostTickMethod(e,t){const s=t?performance.now():0;let i;return e instanceof jC?(i=e._postTick(),t&&HC.AddIndividualBehaviorTickTime(e.behavior,performance.now()-s)):(i=e.PostTick(),t&&HC.AddIndividualBehaviorTickTime(e.GetBehavior(),performance.now()-s)),i}_BehaviorPostTick(){const e=this.IsDebug();this._behInstsToPostTick.SetQueueingEnabled(!0);for(const t of this._behInstsToPostTick)this._CallBehaviorPostTickMethod(t,e);this._behInstsToPostTick.SetQueueingEnabled(!1)}_CallBehaviorTick2Method(e,t){const s=t?performance.now():0;let i;return e instanceof jC?(i=e._tick2(),t&&HC.AddIndividualBehaviorTickTime(e.behavior,performance.now()-s)):(i=e.Tick2(),t&&HC.AddIndividualBehaviorTickTime(e.GetBehavior(),performance.now()-s)),i}_BehaviorTick2(){const e=this.IsDebug();this._behInstsToTick2.SetQueueingEnabled(!0);for(const t of this._behInstsToTick2)this._CallBehaviorTick2Method(t,e);this._behInstsToTick2.SetQueueingEnabled(!1)}*_DebugBehaviorTick(){const e=this.IsDebug();this._behInstsToTick.SetQueueingEnabled(!0);for(const t of this._behInstsToTick){const s=this._CallBehaviorTickMethod(t,e);WC.IsIterator(s)&&(yield*s)}this._behInstsToTick.SetQueueingEnabled(!1)}*_DebugBehaviorPostTick(){const e=this.IsDebug();this._behInstsToPostTick.SetQueueingEnabled(!0);for(const t of this._behInstsToPostTick){const s=this._CallBehaviorPostTickMethod(t,e);WC.IsIterator(s)&&(yield*s)}this._behInstsToPostTick.SetQueueingEnabled(!1)}*_DebugBehaviorTick2(){const e=this.IsDebug();this._behInstsToTick2.SetQueueingEnabled(!0);for(const t of this._behInstsToTick2){const s=this._CallBehaviorTick2Method(t,e);WC.IsIterator(s)&&(yield*s)}this._behInstsToTick2.SetQueueingEnabled(!1)}async Tick(e,t,s){this._hasStartedTicking=!0;const i="background-wake"===s,r="background-wake"!==s&&"skip-render"!==s,n=this.GetLayoutManager(),a=this.GetCanvasManager();if(!this._hasStarted||this.IsSuspended()&&!t&&!i)return;const o=performance.now();this._isInTick=!0,this._MeasureDt(e||0),this._tpsTickCount++,this._ReleasePendingInstances();const l=this.Step_BeforePreTick();this.IsDebugging()&&await l;const h=this._dispatcher.dispatchEventAndWait_AsyncOptional(this._eventObjects.pretick);h instanceof Promise&&await h,this.DispatchUserScriptEvent(this._userScriptEventObjects.pretick);const u=this.Step_AfterPreTick();this.IsDebugging()&&await u,this._NeedsHandleSaveOrLoad()&&await this._HandleSaveOrLoad(),n.IsPendingChangeMainLayout()&&await this._MaybeChangeLayout();const c=this.Step_RunEventsEtc();this.IsDebugging()&&await c;const d=n.GetMainRunningLayout(),p=d._GetPendingSetHTMLLayerCount();let _=!1;if(-1!==p&&(d._ResetPendingHTMLLayerCount(),a.GetHTMLLayerCount()!==p)){const e=this.GetCanvasManager().SetHTMLLayerCount(p);this.IsInWorker()&&(_=!0,await e)}this.PostComponentMessageToDOM("canvas","update-html-layer-dom-state",{layersDomState:d._GetRootLayers().filter(e=>e.IsHTMLElementsLayer()).map(e=>e._GetHTMLLayerDOMState())}),r&&this.Render(),_&&this.PostComponentMessageToDOM("canvas","cleanup-html-layers"),this.IsExportToVideo()&&(await this._ExportToVideoAddFrame(),this.GetGameTime()>=this.GetExportVideoDuration())?this._ExportToVideoFinish():(this.IsSuspended()||i||this._RequestAnimationFrame(),this._tickCount++,this._tickCountNoSave++,this._isInTick=!1,this._mainThreadTimeCounter+=performance.now()-o)}async Step_BeforePreTick(){const e=this._eventSheetManager,t=this.IsDebug();this.FlushPendingInstances(),e.BlockFlushingInstances(!0),this.PushCurrentLayout(this.GetMainRunningLayout()),t&&HC.StartMeasuringTime(),this.IsDebugging()?await e.DebugRunScheduledWaits():e.RunScheduledWaits(),t&&HC.AddEventsTime(),this.PopCurrentLayout(),e.BlockFlushingInstances(!1),this.FlushPendingInstances(),e.BlockFlushingInstances(!0)}async Step_AfterPreTick(){const e=this._eventSheetManager,t=this.IsDebug(),s=this.IsDebugging(),i=this._dispatcher,r=this._eventObjects,n=this._userScriptEventObjects;t&&HC.StartMeasuringTime(),s?await this.DebugIterateAndBreak(this._DebugBehaviorTick()):this._BehaviorTick(),s?await this.DebugIterateAndBreak(this._DebugBehaviorPostTick()):this._BehaviorPostTick(),t&&HC.AddBehaviorTotalTickTime(),t&&HC.StartMeasuringTime(),s?await this.DebugFireGeneratorEventAndBreak(r.tick):i.dispatchEvent(r.tick),t&&HC.AddPluginTotalTickTime(),e.BlockFlushingInstances(!1),this.DispatchUserScriptEvent(n.tick)}async Step_RunEventsEtc(){const e=this._eventSheetManager,t=this._dispatcher,s=this._eventObjects,i=this._userScriptEventObjects,r=this.IsDebug(),n=this.IsDebugging();r&&HC.StartMeasuringTime(),n?await e.DebugRunEvents(this._layoutManager):e.RunEvents(this._layoutManager),r&&HC.AddEventsTime(),this._collisionEngine.ClearRegisteredCollisions(),this._ReleasePendingInstances(),this._isLayoutFirstTick=!1,e.BlockFlushingInstances(!0),r&&HC.StartMeasuringTime(),n?await this.DebugIterateAndBreak(this._DebugBehaviorTick2()):this._BehaviorTick2(),r&&HC.AddBehaviorTotalTickTime(),r&&HC.StartMeasuringTime(),n?await this.DebugFireGeneratorEventAndBreak(s.tick2):t.dispatchEvent(s.tick2),r&&HC.AddPluginTotalTickTime(),e.BlockFlushingInstances(!1),this.DispatchUserScriptEvent(i.tick2),n&&await e.RunQueuedDebugTriggersAsync(),this.FlushPendingInstances(),this._ReleasePendingInstances()}_ReleasePendingInstances(){if(0===this._instancesPendingRelease.size)return;const e=this._dispatcher;e.SetDelayRemoveEventsEnabled(!0);for(const e of this._instancesPendingReleaseAffectedObjectClasses)e.GetSolStack().RemoveInstances(this._instancesPendingRelease);this._instancesPendingReleaseAffectedObjectClasses.clear(),this._eventSheetManager._OnInstancesReleased(this._instancesPendingRelease);for(const e of this._instancesPendingRelease)e.Release();this._instancesPendingRelease.clear(),e.SetDelayRemoveEventsEnabled(!1)}async _MaybeChangeLayout(){const e=this.GetLayoutManager();let t=0;for(;e.IsPendingChangeMainLayout()&&t++<10;)await this._DoChangeLayout(e.GetPendingChangeMainLayout())}_MeasureDt(e){let t=0;this.IsExportToVideo()?(t=1/this.GetExportVideoFramerate(),this._dtRaw=t,this._dt1=t):0!==this._lastTickTime&&(t=Math.max(e-this._lastTickTime,0)/1e3,t>.5&&(t=0),this._dtRaw=t,this._dt1=WC.clamp(t,this._minDt,this._maxDt)),this._lastTickTime=e,this._dt=this._dt1*this._timeScale,this._gameTime.Add(this._dt),this._gameTimeRaw.Add(t*this._timeScale),this._wallTime.Add(this._dt1);for(const[e,t]of this._instanceTimes)t.Add(this._dt1*e.GetTimeScale());this._canvasManager&&this._canvasManager._UpdateTick(),e-this._fpsLastTime>=1e3&&(this._fpsLastTime+=1e3,e-this._fpsLastTime>=1e3&&(this._fpsLastTime=e),this._fps=this._fpsFrameCount,this._fpsFrameCount=0,this._tps=this._tpsTickCount,this._tpsTickCount=0,this._mainThreadTime=Math.min(this._mainThreadTimeCounter/1e3,1),this._mainThreadTimeCounter=0,this._canvasManager&&this._canvasManager._Update1sFrameRange(),this._collisionEngine._Update1sStats(),this.IsDebug()&&HC.Update1sPerfStats())}_SetTrackingInstanceTime(e,t){if(t){if(!this._instanceTimes.has(e)){const t=WC.New(WC.KahanSum);t.Copy(this._gameTime),this._instanceTimes.set(e,t)}}else this._instanceTimes.delete(e)}_GetInstanceGameTime(e){const t=this._instanceTimes.get(e);return t?t.Get():this.GetGameTime()}async _DoChangeLayout(e){const t=this._dispatcher,s=this.GetLayoutManager().GetMainRunningLayout();await s._StopRunning(),s._Unload(e,this.GetRenderer()),s===e&&this._eventSheetManager.ClearAllScheduledWaits(),this._collisionEngine.ClearRegisteredCollisions(),this._ReleasePendingInstances(),t.dispatchEvent(this._eventObjects.beforelayoutchange),WC.Asyncify.SetHighThroughputMode(!0),await e._Load(s,this.GetRenderer()),WC.Asyncify.SetHighThroughputMode(!1),await e._StartRunning(!1),t.dispatchEvent(this._eventObjects.layoutchange),this.UpdateRender(),this._isLayoutFirstTick=!0,this.FlushPendingInstances(),this._ExportToVideoAddKeyframe()}UpdateRender(){this._needRender=!0}GetWebGLRenderer(){return this._canvasManager?this._canvasManager.GetWebGLRenderer():null}GetWebGPURenderer(){return this._canvasManager?this._canvasManager.GetWebGPURenderer():null}GetRenderer(){return this._canvasManager?this._canvasManager.GetRenderer():null}Render(){const e=this._canvasManager;if(!e||e.IsRendererContextLost())return;const t=this.GetRenderer(),s=t.SupportsGPUProfiling(),i=s&&t.IsWebGL(),r=s&&t.IsWebGPU();if(i&&t.CheckForQueryResults(),!this._needRender&&!this.IsExportToVideo())return void t.IncrementFrameNumber();const n=this._layoutManager.GetMainRunningLayout();this._fpsFrameCount++,t.Start();const a=this.IsDebug();a&&HC.StartMeasuringTime(),this._needRender=!1;let o=null;i&&(o=e.GetGPUFrameTimingsBuffer().AddTimeElapsedQuery(),t.StartQuery(o));let l=null;r&&(l=t.StartFrameTiming(2*(1+n.GetLayerCount())),t.StartMeasuringRenderPassTime(0,1)),this.Uses3DFeatures()&&"low"===e.GetCurrentFullscreenScalingQuality()?t.SetFixedSizeDepthBuffer(e.GetDrawWidth(),e.GetDrawHeight()):t.SetAutoSizeDepthBuffer(),this._Render(this.GetRenderer(),n),o&&t.EndQuery(o),r&&(t.StopMeasuringRenderPassTime(),this._canvasManager._AddWebGPUFrameTiming(l)),t.Finish(),a&&(HC.AddDrawCallsTime(),HC.UpdateInspectHighlight()),e&&e._MaybeTakeSnapshot()}_NeedsHTMLLayerCompositing(e){return"low"===this.GetCanvasManager().GetCurrentFullscreenScalingQuality()||e.IsWebGL()&&(this.UsesAnyBackgroundBlending()||this.Uses3DFeatures())}_Render(e,t){e.SetTextureFillMode(),e.SetAlphaBlend(),e.ResetCullState(),e.SetColorRgba(1,1,1,1),e.SetRenderTarget(null),e.SetTexture(null),e.SetDepthEnabled(this.Uses3DFeatures()),this._NeedsHTMLLayerCompositing(e)&&t._MaybeStartDrawToOwnTexture(e);const s=t.GetHTMLLayerCount();for(let i=1;i<s;++i)t.DrawForHTMLLayerIndex(e,i),e.IsWebGPU()&&e.Restart();this._NeedsHTMLLayerCompositing(e)||t._MaybeStartDrawToOwnTexture(e),t.DrawMain(e)}Trigger(e,t,s){if(!this._hasStarted)return!1;const i=!this._isInTick&&!this._eventSheetManager.IsInTrigger();let r=0;i&&(r=performance.now());const n=this.IsDebug();n&&this.SetDebuggingEnabled(!1);const a=this._eventSheetManager._Trigger(this._layoutManager,e,t,s);if(i){const e=performance.now()-r;this._mainThreadTimeCounter+=e,n&&HC.AddTriggersTime(e)}return n&&this.SetDebuggingEnabled(!0),a}DebugTrigger(e,t,s){if(!this.IsDebugging())return this.Trigger(e,t,s);if(this.HitBreakpoint())throw new Error("called DebugTrigger() while stopped on breakpoint");if(!this._isInTick&&!this._eventSheetManager.IsInTrigger())throw new Error("called DebugTrigger() outside of event code - use TriggerAsync() instead");return this._eventSheetManager._DebugTrigger(this._layoutManager,e,t,s)}async TriggerAsync(e,t,s){if(!this.IsDebugging())return this.Trigger(e,t,s);if(!this._hasStarted)return!1;if(this.HitBreakpoint())return this._eventSheetManager.QueueDebugTrigger(e,t,s);if(!this.GetMainRunningLayout())return this._eventSheetManager.QueueTrigger(e,t,s);const i=performance.now(),r=this._eventSheetManager._DebugTrigger(this._layoutManager,e,t,s);let n=r.next();for(;!n.done;)await this.DebugBreak(n.value),n=r.next();return this.IsSuspended()||this._eventSheetManager.IsInTrigger()||(await this._eventSheetManager.RunQueuedDebugTriggersAsync(),this._hasStartedTicking&&!this._isInTick&&this._RequestAnimationFrame()),this._mainThreadTimeCounter+=performance.now()-i,n.value}FastTrigger(e,t,s){const i=this.IsDebug();i&&this.SetDebuggingEnabled(!1);const r=this._eventSheetManager._FastTrigger(this._layoutManager,e,t,s);return i&&this.SetDebuggingEnabled(!0),r}DebugFastTrigger(e,t,s){return this._eventSheetManager._DebugFastTrigger(this._layoutManager,e,t,s)}ScheduleTriggers(e){return this._scheduleTriggersThrottle.Add(e)}PushCurrentLayout(e){this._currentLayoutStack.push(e)}PopCurrentLayout(){if(!this._currentLayoutStack.length)throw new Error("layout stack empty");this._currentLayoutStack.pop()}GetCurrentLayout(){return this._currentLayoutStack.length?this._currentLayoutStack.at(-1):this.GetMainRunningLayout()}GetDt(e){return e&&-1!==e.GetTimeScale()?this._dt1*e.GetTimeScale():this._dt}_GetDtFast(){return this._dt}GetDt1(){return this._dt1}GetDtRaw(){return this._dtRaw}GetTimeScale(){return this._timeScale}SetTimeScale(e){(isNaN(e)||e<0)&&(e=0),this._timeScale=e}SetMinDt(e){this._minDt=Math.max(e,0)}GetMinDt(){return this._minDt}SetMaxDt(e){this._maxDt=Math.max(e,0)}GetMaxDt(){return this._maxDt}GetFramesPerSecond(){return this._fps}GetTicksPerSecond(){return this._tps}GetMainThreadTime(){return this._mainThreadTime}GetStartTime(){return this._startTime}GetGameTime(){return this._gameTime.Get()}GetGameTimeRaw(){return this._gameTimeRaw.Get()}GetWallTime(){return this._wallTime.Get()}GetTickCount(){return this._tickCount}GetTickCountNoSave(){return this._tickCountNoSave}GetObjectCount(){return this._objectCount}GetProjectName(){return this._projectName}GetProjectVersion(){return this._projectVersion}GetProjectUniqueId(){return this._projectUniqueId}GetAppId(){return this._appId}GetExportTimestamp(){return this._exportTimestamp}GetInstanceByUID(e){if(this._isLoadingState)throw new Error("cannot call while loading state - wait until afterload event");return this._instancesByUid.get(e)||null}_RemoveInstanceFromUIDMap(e){if(this._isLoadingState)throw new Error("cannot call while loading state - wait until afterload event");this._instancesByUid.delete(e)}_RefreshUidMap(){this._instancesByUid.clear();for(const e of this._allObjectClasses)if(!e.IsFamily())for(const t of e.GetInstances())this._instancesByUid.set(t.GetUID(),t)}IsPreview(){return"preview"===this._exportType}IsDebug(){return this._isDebug}GetExportType(){return this._exportType}IsNWjs(){return"nwjs"===this.GetExportType()||this._isNWjs}IsCordova(){return"cordova"===this._exportType}IsAndroidWebView(){return"Android"===WC.Platform.OS&&("cordova"===this._exportType||"playable-ad-single-file"===this._exportType||"playable-ad-zip"===this._exportType||"instant-games"===this._exportType)}IsiOSCordova(){return this._isiOSCordova}IsiOSWebView(){return this._isiOSWebView}IsWindowsWebView2(){return this._isWindowsWebView2}IsAnyWebView2Wrapper(){return this._isAnyWebView2Wrapper}GetCollisionEngine(){return this._collisionEngine}GetSolidBehavior(){return this._addonManager.GetSolidBehavior()}GetJumpthruBehavior(){return this._addonManager.GetJumpthruBehavior()}Uses3DFeatures(){return this._uses3dFeatures}GetZScaleFactor(){return this.GetRenderer().GetZAxisScaleFactor(this.GetViewportHeight())}GetDefaultCameraZ(e){return this.GetRenderer().GetDefaultCameraZ(e||this.GetViewportHeight())}IsLayoutFirstTick(){return this._isLayoutFirstTick}SetPixelRoundingEnabled(e){e=!!e,this._isPixelRoundingEnabled!==e&&(this._isPixelRoundingEnabled=e,this.GetLayoutManager().SetAllLayerMVChanged(),this.UpdateRender())}IsPixelRoundingEnabled(){return this._isPixelRoundingEnabled}GetTextIconSet(e){if(!this._iconChangeHandlers.has(e)){const t=()=>this.DeleteTextIconSet(e);this._iconChangeHandlers.set(e,t),e.Dispatcher().addEventListener("animationframeimagechange",t)}const t=this._textIconManager.GetIconSet(e);return t.HasLoaded()||t.LoadContent().then(()=>this.UpdateRender()),t}DeleteTextIconSet(e){this._textIconManager.DeleteIconSet(e)}_GetTextIconSetMeta(e){const t=[];for(const s of e.GetAnimations())for(const e of s.GetFrames()){const s=e.GetImageInfo();t.push({source:e,width:s.GetWidth(),height:s.GetHeight(),tag:e.GetTag()})}return{icons:t}}async _GetTextIconSetContent(e){const t=WC.New(WC.PromiseThrottle),s=[],i=new Map;for(const r of e.GetAnimations())for(const e of r.GetFrames()){const r=e.GetImageInfo().GetImageAsset();i.has(r)||(i.set(r,null),s.push(t.Add(async()=>{const e=await r.LoadToDrawable();i.set(r,e)})))}await Promise.all(s);const r=[];for(const s of e.GetAnimations())for(const e of s.GetFrames())r.push(t.Add(async()=>{const t=e.GetImageInfo(),s=i.get(t.GetImageAsset()),r=await t.ExtractImageToCanvas(s);return{drawable:await createImageBitmap(r)}}));const n=await Promise.all(r);for(const e of i.values())e instanceof ImageBitmap&&e.close&&e.close();return{icons:n}}SaveToSlot(e){this._saveToSlotName=e,this._saveToJsonString=!1}SaveToJsonString(){this._saveToSlotName="",this._saveToJsonString=!0}LoadFromSlot(e){this._loadFromSlotName=e}LoadFromJsonString(e){this._loadFromJson=e}GetLastSaveJsonString(){return this._lastSaveJson}_NeedsHandleSaveOrLoad(){return!!(this._saveToSlotName||this._saveToJsonString||this._loadFromSlotName||null!==this._loadFromJson)}async _HandleSaveOrLoad(){if(this._saveToSlotName&&(this.FlushPendingInstances(),await this._DoSaveToSlot(this._saveToSlotName),this._ClearSaveOrLoad()),this._loadFromSlotName&&(await this._DoLoadFromSlot(this._loadFromSlotName),this._ClearSaveOrLoad(),this.IsDebug()&&HC.StepIfPausedInDebugger()),this._saveToJsonString){const e=await this._SaveToJsonString();this._lastSaveJson=e,await this.TriggerAsync(WC.Plugins.System.Cnds.OnSaveComplete,null),this._lastSaveJson="",this._ClearSaveOrLoad()}if(null!==this._loadFromJson){this.FlushPendingInstances();try{await this._DoLoadFromJsonString(this._loadFromJson),this._lastSaveJson=this._loadFromJson,await this.TriggerAsync(WC.Plugins.System.Cnds.OnLoadComplete,null),this._lastSaveJson=""}catch(e){console.error("[Construct] Failed to load state from JSON string: ",e),await this.TriggerAsync(WC.Plugins.System.Cnds.OnLoadFailed,null)}this._ClearSaveOrLoad()}}_ClearSaveOrLoad(){this._saveToSlotName="",this._saveToJsonString=!1,this._loadFromSlotName="",this._loadFromJson=null}_GetProjectStorage(){return this._projectStorage||(this._projectStorage=localforage.createInstance({name:"c3-localstorage-"+this.GetProjectUniqueId(),description:this.GetProjectName()})),this._projectStorage}_GetSavegamesStorage(){return this._savegamesStorage||(this._savegamesStorage=localforage.createInstance({name:"c3-savegames-"+this.GetProjectUniqueId(),description:this.GetProjectName()})),this._savegamesStorage}async _DoSaveToSlot(e){const t=await this._SaveToJsonString();try{await this._GetSavegamesStorage().setItem(e,t),console.log("[Construct] Saved state to storage ("+t.length+" chars)"),this._lastSaveJson=t,await this.TriggerAsync(WC.Plugins.System.Cnds.OnSaveComplete,null),this._lastSaveJson=""}catch(e){console.error("[Construct] Failed to save state to storage: ",e),await this.TriggerAsync(WC.Plugins.System.Cnds.OnSaveFailed,null)}}async _DoLoadFromSlot(e){try{const t=await this._GetSavegamesStorage().getItem(e);if(!t)throw new Error("empty slot");console.log("[Construct] Loaded state from storage ("+t.length+" chars)"),await this._DoLoadFromJsonString(t),this._lastSaveJson=t,await this.TriggerAsync(WC.Plugins.System.Cnds.OnLoadComplete,null),this._lastSaveJson=""}catch(e){console.error("[Construct] Failed to load state from storage: ",e),await this.TriggerAsync(WC.Plugins.System.Cnds.OnLoadFailed,null)}}async _SaveToJsonString(){const e={c3save:!0,version:1,rt:{time:this.GetGameTime(),timeRaw:this.GetGameTimeRaw(),walltime:this.GetWallTime(),timescale:this.GetTimeScale(),tickcount:this.GetTickCount(),next_uid:this._nextUid,running_layout:this.GetMainRunningLayout().GetSID(),start_time_offset:Date.now()-this._startTime},types:{},layouts:{},events:this._eventSheetManager._SaveToJson(),timelines:this._timelineManager._SaveToJson(),user_script_data:null};for(const t of this._allObjectClasses)t.IsFamily()||t.HasNoSaveBehavior()||(e.types[t.GetSID().toString()]=t._SaveToJson());for(const t of this._layoutManager.GetAllLayouts())e.layouts[t.GetSID().toString()]=t._SaveToJson();const t=this._CreateUserScriptEvent("save");return t.saveData=null,await this.DispatchUserScriptEventAsyncWait(t),e.user_script_data=t.saveData,JSON.stringify(e)}IsLoadingState(){return this._isLoadingState}async _DoLoadFromJsonString(e){const t=this.GetLayoutManager(),s=JSON.parse(e);if(s.c2save)throw new Error("C2 saves are incompatible with C3 runtime");if(!s.c3save)throw new Error("not valid C3 save data");if(s.version>1)throw new Error("C3 save data from future version");this.ClearIntancesNeedingAfterLoad(),this._dispatcher.dispatchEvent(WC.New(WC.Event,"beforeload"));for(const e of this.allInstances())e.GetObjectClass().HasNoSaveBehavior()||e._OnBeforeLoad();const i=s.rt;this._gameTime.Set(i.time),i.hasOwnProperty("timeRaw")&&this._gameTimeRaw.Set(i.timeRaw),this._wallTime.Set(i.walltime),this._timeScale=i.timescale,this._tickCount=i.tickcount,this._startTime=Date.now()-i.start_time_offset;const r=i.running_layout;this._isLoadingState=!0;let n=!1;if(r!==this.GetMainRunningLayout().GetSID()){const e=t.GetLayoutBySID(r);if(!e)return;await this._DoChangeLayout(e),n=!0}for(const[e,i]of Object.entries(s.layouts)){const s=parseInt(e,10),r=t.GetLayoutBySID(s);r&&r._LoadFromJson(i)}const a=new Set;for(const[e,t]of Object.entries(s.types)){const s=parseInt(e,10),i=this.GetObjectClassBySID(s);!i||i.IsFamily()||i.HasNoSaveBehavior()||i._LoadFromJson(t,a)}for(const e of this._layoutManager.GetAllLayouts())for(const t of e.allLayers())t._LoadFromJsonAfterInstances();if(this.FlushPendingInstances(),this._RefreshUidMap(),this._isLoadingState=!1,n){for(const e of this.allInstances())e.SetupInitialSceneGraphConnections();for(const[e,t]of Object.entries(s.types)){const s=parseInt(e,10),i=this.GetObjectClassBySID(s);!i||i.IsFamily()||i.HasNoSaveBehavior()||i._SetupSceneGraphConnectionsOnChangeOfLayout(t)}}this._nextUid=i.next_uid,this._eventSheetManager._LoadFromJson(s.events);for(const e of this._allObjectClasses)if(!e.IsFamily()&&e.IsInContainer())for(const t of e.GetInstances()){const s=t.GetIID();t._ClearSiblings();for(const i of e.GetContainer().objectTypes()){if(i===e)continue;const r=i.GetInstances();if(s<0||s>=r.length)throw new Error("missing sibling instance");t._AddSibling(r[s])}}this._timelineManager._LoadFromJson(s.timelines),t.SetAllLayerProjectionChanged(),t.SetAllLayerMVChanged();for(const e of a)e._OnCreatedForLoadingSavegame();this.DoAfterLoad(),this._dispatcher.dispatchEvent(WC.New(WC.Event,"afterload")),this.DispatchUserScriptEvent(this._CreateUserScriptEvent("afterload"));for(const[e,t]of Object.entries(s.types)){const t=parseInt(e,10),s=this.GetObjectClassBySID(t);s&&s._ClearLoadInstancesJson()}const o=this._CreateUserScriptEvent("load");o.saveData=s.user_script_data,await this.DispatchUserScriptEventAsyncWait(o),this.UpdateRender()}SortOnTmpHierarchyPosition(e,t){return t.GetWorldInfo().GetTmpHierarchyPosition()-e.GetWorldInfo().GetTmpHierarchyPosition()}AddInstanceNeedingAfterLoad(e,t){e.GetWorldInfo()&&(this._instancesNeedingAfterLoadMap.has(e)||(this._instancesNeedingAfterLoadMap.set(e,t),this._instancesNeedingAfterLoadArray.push(e)))}ClearIntancesNeedingAfterLoad(){this._instancesNeedingAfterLoadMap=new WeakMap,WC.clearArray(this._instancesNeedingAfterLoadArray),WC.SceneGraphInfo.ClearUpdatedInstances()}DoAfterLoad(e="full",t=null){this._instancesNeedingAfterLoadArray.sort(this.SortOnTmpHierarchyPosition),t||(t={}),t.processedWorldInfo=new Set;const s=this._instancesNeedingAfterLoadArray.length;for(const s of this._instancesNeedingAfterLoadArray)s._OnAfterLoad(this._instancesNeedingAfterLoadMap.get(s),e,t);for(const s of this._instancesNeedingAfterLoadArray)s._OnAfterLoad2(this._instancesNeedingAfterLoadMap.get(s),e,t);if(this.ClearIntancesNeedingAfterLoad(),s){this.FlushPendingInstances(),this._RefreshUidMap();for(const e of this._layoutManager.GetAllLayouts())for(const t of e.allLayers())t._SortInstancesByLastCachedZIndex(),t.SetZIndicesChanged()}}async AddJobWorkerScripts(e){const t=await Promise.all(e.map(async e=>{if(this.IsCordova()&&this._assetManager.IsFileProtocol()||"playable-ad-single-file"===this.GetExportType()){const t=await this._assetManager.FetchBlob(e);return URL.createObjectURL(t)}return new URL(e,location.href).toString()}));this._jobScheduler.ImportScriptsToJobWorkers(t)}AddJobWorkerBlob(e,t){this._jobScheduler.SendBlobToJobWorkers(e,t)}AddJobWorkerBuffer(e,t){this._jobScheduler.SendBufferToJobWorkers(e,t)}AddJob(e,t,s,i){return this._jobScheduler.AddJob(e,t,s,null,null,i)}BroadcastJob(e,t,s,i){return this._jobScheduler.BroadcastJob(e,t,s,i)}GetMaxNumJobWorkers(){return this._jobScheduler.GetMaxNumWorkers()}InvokeDownload(e,t){this.PostComponentMessageToDOM("runtime","invoke-download",{url:e,filename:t})}async RasterSvgImage(e,t,s,i,r,n){if(i=i||t,r=r||s,this.IsInWorker())return(await this.PostComponentMessageToDOMAsync("runtime","raster-svg-image",{blob:e,imageWidth:t,imageHeight:s,surfaceWidth:i,surfaceHeight:r,imageBitmapOpts:n})).imageBitmap;{const a=await self.C3_RasterSvgImageBlob(e,t,s,i,r);return n?await self.createImageBitmap(a,n):a}}async GetSvgImageSize(e){return this.IsInWorker()?await this.PostComponentMessageToDOMAsync("runtime","get-svg-image-size",{blob:e}):await self.C3_GetSvgImageSize(e)}RequestDeviceOrientationEvent(){this._didRequestDeviceOrientationEvent||(this._didRequestDeviceOrientationEvent=!0,this.PostComponentMessageToDOM("runtime","enable-device-orientation"))}RequestDeviceMotionEvent(){this._didRequestDeviceMotionEvent||(this._didRequestDeviceMotionEvent=!0,this.PostComponentMessageToDOM("runtime","enable-device-motion"))}Random(){return this._randomNumberCallback()}SetRandomNumberGeneratorCallback(e){this._randomNumberCallback=e}_GetRemotePreviewStatusInfo(){const e=this.GetRenderer();return{fps:this.GetFramesPerSecond(),tps:this.GetTicksPerSecond(),cpu:this.GetMainThreadTime(),gpu:this.GetGPUUtilisation(),layout:this.GetMainRunningLayout()?this.GetMainRunningLayout().GetName():"",renderer:e.IsWebGL()?e.GetUnmaskedRenderer():e.GetAdapterInfoString()}}HitBreakpoint(){return!!this.IsDebug()&&HC.HitBreakpoint()}DebugBreak(e){return this.IsDebugging()?HC.DebugBreak(e):Promise.resolve()}DebugBreakNext(){return!!this.IsDebugging()&&HC.BreakNext()}SetDebugBreakpointsEnabled(e){this._breakpointsEnabled=!!e,this._UpdateDebuggingFlag()}AreDebugBreakpointsEnabled(){return this._breakpointsEnabled}IsDebugging(){return this._isDebugging}SetDebuggingEnabled(e){e?this._debuggingDisabled--:this._debuggingDisabled++,this._UpdateDebuggingFlag()}_UpdateDebuggingFlag(){this._isDebugging=this.IsDebug()&&this._breakpointsEnabled&&0===this._debuggingDisabled}IsCPUProfiling(){return this.IsDebug()&&HC.IsCPUProfiling()}IsGPUProfiling(){return this.IsDebug()&&this.GetRenderer().SupportsGPUProfiling()&&HC.IsGPUProfiling()}async DebugIterateAndBreak(e){if(e)for(const t of e)await this.DebugBreak(t)}DebugFireGeneratorEventAndBreak(e){return this.DebugIterateAndBreak(this._dispatcher.dispatchGeneratorEvent(e))}_InvokeFunctionFromJS(e){return this._eventSheetManager._InvokeFunctionFromJS(e.name,e.params)}_GetHTMLLayerWrapElement(e){if(this.IsInWorker())throw new Error("not supported in worker mode");return self.c3_runtimeInterface._GetHTMLWrapElement(e)}GetIRuntime(){return this._iRuntime}_CreateUserScriptEvent(e){const t=WC.New(WC.Event,e,!1);return t.runtime=this._iRuntime,t}_InitScriptInterfaces(){this._iRuntime=new self.IRuntime(this),this._userScriptEventObjects={pretick:this._CreateUserScriptEvent("pretick"),tick:this._CreateUserScriptEvent("tick"),tick2:this._CreateUserScriptEvent("tick2")}}_InitObjectsScriptInterface(){const e={};for(const t of this._allObjectClasses)e[t.GetJsPropName()]={value:t.GetIObjectClass(),enumerable:!0,writable:!1};this._iRuntime._InitObjects(e)}_InitGlobalVariableScriptInterface(){const e={};for(const t of this.GetEventSheetManager().GetAllGlobalVariables())e[t.GetJsPropName()]=t._GetScriptInterfaceDescriptor();this._iRuntime._InitGlobalVars(e)}_GetCommonScriptInterfaces(){return this._commonScriptInterfaces}_MapScriptInterface(e,t){this._interfaceMap.set(e,t)}_UnwrapScriptInterface(e){return this._interfaceMap.get(e)}_UnwrapIObjectClass(e){if(!(e instanceof self.IObjectClass))throw new TypeError("expected IObjectClass");const t=this._UnwrapScriptInterface(e);if(!(t&&t instanceof WC.ObjectClass))throw new Error("invalid IObjectClass");return t}_UnwrapIInstance(e){if(!(e instanceof self.IInstance))throw new TypeError("expected IInstance");const t=this._UnwrapScriptInterface(e);if(!(t&&t instanceof WC.Instance))throw new Error("invalid IInstance");return t}_UnwrapIWorldInstance(e){if(!(e instanceof self.IWorldInstance))throw new TypeError("expected IWorldInstance");const t=this._UnwrapScriptInterface(e);if(!(t&&t instanceof WC.Instance))throw new Error("invalid IInstance");return t}},self.C3_CreateRuntime=WC.Runtime.Create,self.C3_InitRuntime=(e,t)=>e.Init(t)}{const XC=self.C3;XC.JobSchedulerRuntime=class extends XC.DefendedBase{constructor(e,t){super(),this._runtime=e,this._jobPromises=new Map,this._nextJobId=0,this._inputPort=t.inputPort,t.outputPort.onmessage=e=>this._OnJobWorkerMessage(e),this._maxNumWorkers=t.maxNumWorkers,this._jobWorkerCount=1,this._isCreatingWorker=!1,this._hadErrorCreatingWorker=!1}GetMaxNumWorkers(){return this._maxNumWorkers}ImportScriptsToJobWorkers(e){this._inputPort.postMessage({type:"_import_scripts",scripts:e})}SendBlobToJobWorkers(e,t){this._inputPort.postMessage({type:"_send_blob",blob:e,id:t})}SendBufferToJobWorkers(e,t){this._inputPort.postMessage({type:"_send_buffer",buffer:e,id:t},[e])}AddJob(e,t,s,i,r,n){if(s||(s=[]),"number"==typeof n&&(n=Math.floor(n))<=0)throw new Error("invalid maxWorkerNum");const a=this._nextJobId++,o={type:e,isBroadcast:!1,maxWorkerNum:n,jobId:a,params:t,transferables:s},l=new Promise((e,t)=>{this._jobPromises.set(a,{resolve:e,progress:i,reject:t,cancelled:!1,maxWorkerNum:n})});return r&&r.SetAction(()=>this._CancelJob(a)),this._inputPort.postMessage(o,s),this._MaybeCreateExtraWorker(),l}BroadcastJob(e,t,s,i){if(s||(s=[]),"number"==typeof i&&(i=Math.floor(i))<=0)throw new Error("invalid maxWorkerNum");const r={type:e,isBroadcast:!0,maxWorkerNum:i,jobId:this._nextJobId++,params:t,transferables:s};this._inputPort.postMessage(r,s)}_CancelJob(e){const t=this._jobPromises.get(e);t&&(t.cancelled=!0,t.resolve=null,t.progress=null,t.reject=null,this._inputPort.postMessage({type:"_cancel",jobId:e}))}_OnJobWorkerMessage(e){const t=e.data,s=t.type,i=t.jobId;switch(s){case"result":this._OnJobResult(i,t.result);break;case"progress":this._OnJobProgress(i,t.progress);break;case"error":this._OnJobError(i,t.error);break;case"ready":this._OnJobWorkerReady();break;default:throw new Error(`unknown message from worker '${s}'`)}}_OnJobResult(e,t){const s=this._jobPromises.get(e);if(!s)throw new Error("invalid job ID");s.cancelled||s.resolve(t),this._jobPromises.delete(e)}_OnJobProgress(e,t){const s=this._jobPromises.get(e);if(!s)throw new Error("invalid job ID");!s.cancelled&&s.progress&&s.progress(t)}_OnJobError(e,t){const s=this._jobPromises.get(e);if(!s)throw new Error("invalid job ID");s.cancelled||s.reject(t),this._jobPromises.delete(e)}_OnJobWorkerReady(){this._isCreatingWorker&&(this._isCreatingWorker=!1,this._jobWorkerCount++,this._jobWorkerCount<this._maxNumWorkers?this._MaybeCreateExtraWorker():this._inputPort.postMessage({type:"_no_more_workers"}))}_GetWorkerCountNeededForPendingJobs(){let e=0;const t=[...this._jobPromises.values()].sort((e,t)=>(e.maxWorkerNum||1/0)-(t.maxWorkerNum||1/0));for(const s of t)e<(s.maxWorkerNum||1/0)&&e++;return e}async _MaybeCreateExtraWorker(){if(!(this._jobWorkerCount>=this._maxNumWorkers||this._isCreatingWorker||this._hadErrorCreatingWorker||this._GetWorkerCountNeededForPendingJobs()<=this._jobWorkerCount))try{this._isCreatingWorker=!0,(await this._runtime.PostComponentMessageToDOMAsync("runtime","create-job-worker")).outputPort.onmessage=e=>this._OnJobWorkerMessage(e)}catch(e){this._hadErrorCreatingWorker=!0,this._isCreatingWorker=!1,console.error(`[Construct] Failed to create job worker; stopping creating any more (created ${this._jobWorkerCount} so far)`,e)}}}}self.C3_Shaders={},self.C3_Shaders.glowhorizontal={glsl:"varying mediump vec2 vTex;\nuniform mediump sampler2D samplerFront;\nuniform mediump vec2 pixelSize;\nuniform mediump float intensity;\nvoid main(void)\n{\nmediump vec4 sum = vec4(0.0);\nmediump float pixelWidth = pixelSize.x;\nmediump float halfPixelWidth = pixelWidth / 2.0;\nsum += texture2D(samplerFront, vTex - vec2(pixelWidth * 7.0 + halfPixelWidth, 0.0)) * 0.06;\nsum += texture2D(samplerFront, vTex - vec2(pixelWidth * 5.0 + halfPixelWidth, 0.0)) * 0.10;\nsum += texture2D(samplerFront, vTex - vec2(pixelWidth * 3.0 + halfPixelWidth, 0.0)) * 0.13;\nsum += texture2D(samplerFront, vTex - vec2(pixelWidth * 1.0 + halfPixelWidth, 0.0)) * 0.16;\nmediump vec4 front = texture2D(samplerFront, vTex);\nsum += front * 0.10;\nsum += texture2D(samplerFront, vTex + vec2(pixelWidth * 1.0 + halfPixelWidth, 0.0)) * 0.16;\nsum += texture2D(samplerFront, vTex + vec2(pixelWidth * 3.0 + halfPixelWidth, 0.0)) * 0.13;\nsum += texture2D(samplerFront, vTex + vec2(pixelWidth * 5.0 + halfPixelWidth, 0.0)) * 0.10;\nsum += texture2D(samplerFront, vTex + vec2(pixelWidth * 7.0 + halfPixelWidth, 0.0)) * 0.06;\ngl_FragColor = mix(front, max(front, sum), intensity);\n}",glslWebGL2:"",wgsl:"%%SAMPLERFRONT_BINDING%% var samplerFront : sampler;\n%%TEXTUREFRONT_BINDING%% var textureFront : texture_2d<f32>;\nstruct ShaderParams {\nintensity : f32\n};\n%%SHADERPARAMS_BINDING%% var<uniform> shaderParams : ShaderParams;\n%%C3_UTILITY_FUNCTIONS%%\n%%FRAGMENTINPUT_STRUCT%%\n%%FRAGMENTOUTPUT_STRUCT%%\n@fragment\nfn main(input : FragmentInput) -> FragmentOutput\n{\nvar pixelWidth : f32 = c3_getPixelSize(textureFront).x;\nvar front : vec4<f32> = textureSample(textureFront, samplerFront, input.fragUV);\nvar sum : vec4<f32> =\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(pixelWidth * 7.5, 0.0)) * 0.06 +\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(pixelWidth * 5.5, 0.0)) * 0.10 +\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(pixelWidth * 3.5, 0.0)) * 0.13 +\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(pixelWidth * 1.5, 0.0)) * 0.16 +\nfront * 0.10 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(pixelWidth * 1.5, 0.0)) * 0.16 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(pixelWidth * 3.5, 0.0)) * 0.13 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(pixelWidth * 5.5, 0.0)) * 0.10 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(pixelWidth * 7.5, 0.0)) * 0.06;\nvar output : FragmentOutput;\noutput.color = mix(front, max(front, sum), shaderParams.intensity);\nreturn output;\n}",blendsBackground:!1,usesDepth:!1,extendBoxHorizontal:8,extendBoxVertical:0,crossSampling:!1,mustPreDraw:!1,preservesOpaqueness:!1,supports3dDirectRendering:!1,animated:!1,parameters:[["intensity",0,"percent"]]},self.C3_Shaders.glowvertical={glsl:"varying mediump vec2 vTex;\nuniform mediump sampler2D samplerFront;\nuniform mediump vec2 pixelSize;\nuniform mediump float intensity;\nvoid main(void)\n{\nmediump vec4 sum = vec4(0.0);\nmediump float pixelHeight = pixelSize.y;\nmediump float halfPixelHeight = pixelHeight / 2.0;\nsum += texture2D(samplerFront, vTex - vec2(0.0, pixelHeight * 7.0 + halfPixelHeight)) * 0.06;\nsum += texture2D(samplerFront, vTex - vec2(0.0, pixelHeight * 5.0 + halfPixelHeight)) * 0.10;\nsum += texture2D(samplerFront, vTex - vec2(0.0, pixelHeight * 3.0 + halfPixelHeight)) * 0.13;\nsum += texture2D(samplerFront, vTex - vec2(0.0, pixelHeight * 1.0 + halfPixelHeight)) * 0.16;\nmediump vec4 front = texture2D(samplerFront, vTex);\nsum += front * 0.10;\nsum += texture2D(samplerFront, vTex + vec2(0.0, pixelHeight * 1.0 + halfPixelHeight)) * 0.16;\nsum += texture2D(samplerFront, vTex + vec2(0.0, pixelHeight * 3.0 + halfPixelHeight)) * 0.13;\nsum += texture2D(samplerFront, vTex + vec2(0.0, pixelHeight * 5.0 + halfPixelHeight)) * 0.10;\nsum += texture2D(samplerFront, vTex + vec2(0.0, pixelHeight * 7.0 + halfPixelHeight)) * 0.06;\ngl_FragColor = mix(front, max(front, sum), intensity);\n}",glslWebGL2:"",wgsl:"%%SAMPLERFRONT_BINDING%% var samplerFront : sampler;\n%%TEXTUREFRONT_BINDING%% var textureFront : texture_2d<f32>;\nstruct ShaderParams {\nintensity : f32\n};\n%%SHADERPARAMS_BINDING%% var<uniform> shaderParams : ShaderParams;\n%%C3_UTILITY_FUNCTIONS%%\n%%FRAGMENTINPUT_STRUCT%%\n%%FRAGMENTOUTPUT_STRUCT%%\n@fragment\nfn main(input : FragmentInput) -> FragmentOutput\n{\nvar pixelHeight : f32 = c3_getPixelSize(textureFront).y;\nvar front : vec4<f32> = textureSample(textureFront, samplerFront, input.fragUV);\nvar sum : vec4<f32> =\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(0.0, pixelHeight * 7.5)) * 0.06 +\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(0.0, pixelHeight * 5.5)) * 0.10 +\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(0.0, pixelHeight * 3.5)) * 0.13 +\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(0.0, pixelHeight * 1.5)) * 0.16 +\nfront * 0.10 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(0.0, pixelHeight * 1.5)) * 0.16 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(0.0, pixelHeight * 3.5)) * 0.13 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(0.0, pixelHeight * 5.5)) * 0.10 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(0.0, pixelHeight * 7.5)) * 0.06;\nvar output : FragmentOutput;\noutput.color = mix(front, max(front, sum), shaderParams.intensity);\nreturn output;\n}",blendsBackground:!1,usesDepth:!1,extendBoxHorizontal:0,extendBoxVertical:8,crossSampling:!1,mustPreDraw:!1,preservesOpaqueness:!1,supports3dDirectRendering:!1,animated:!1,parameters:[["intensity",0,"percent"]]},self.C3_Shaders.brightness={glsl:"varying mediump vec2 vTex;\nuniform lowp sampler2D samplerFront;\nuniform lowp float brightness;\nvoid main(void)\n{\nlowp vec4 front = texture2D(samplerFront, vTex);\nlowp float a = front.a;\nif (a != 0.0)\nfront.rgb /= front.a;\nfront.rgb += (brightness - 1.0);\nfront.rgb *= a;\ngl_FragColor = front;\n}",glslWebGL2:"",wgsl:"%%SAMPLERFRONT_BINDING%% var samplerFront : sampler;\n%%TEXTUREFRONT_BINDING%% var textureFront : texture_2d<f32>;\nstruct ShaderParams {\nbrightness : f32\n};\n%%SHADERPARAMS_BINDING%% var<uniform> shaderParams : ShaderParams;\n%%C3_UTILITY_FUNCTIONS%%\n%%FRAGMENTINPUT_STRUCT%%\n%%FRAGMENTOUTPUT_STRUCT%%\n@fragment\nfn main(input : FragmentInput) -> FragmentOutput\n{\nvar front : vec4<f32> = c3_unpremultiply(textureSample(textureFront, samplerFront, input.fragUV));\nvar output : FragmentOutput;\noutput.color = vec4<f32>((front.rgb + (shaderParams.brightness - 1.0)) * front.a, front.a);\nreturn output;\n}",blendsBackground:!1,usesDepth:!1,extendBoxHorizontal:0,extendBoxVertical:0,crossSampling:!1,mustPreDraw:!1,preservesOpaqueness:!0,supports3dDirectRendering:!1,animated:!1,parameters:[["brightness",0,"percent"]]},self.C3_Shaders.grayscale={glsl:"varying mediump vec2 vTex;\nuniform lowp sampler2D samplerFront;\nuniform lowp float intensity;\nvoid main(void)\n{\nlowp vec4 front = texture2D(samplerFront, vTex);\nlowp float gray = front.r * 0.299 + front.g * 0.587 + front.b * 0.114;\ngl_FragColor = mix(front, vec4(gray, gray, gray, front.a), intensity);\n}",glslWebGL2:"",wgsl:"%%SAMPLERFRONT_BINDING%% var samplerFront : sampler;\n%%TEXTUREFRONT_BINDING%% var textureFront : texture_2d<f32>;\nstruct ShaderParams {\nintensity : f32\n};\n%%SHADERPARAMS_BINDING%% var<uniform> shaderParams : ShaderParams;\n%%C3_UTILITY_FUNCTIONS%%\n%%FRAGMENTINPUT_STRUCT%%\n%%FRAGMENTOUTPUT_STRUCT%%\n@fragment\nfn main(input : FragmentInput) -> FragmentOutput\n{\nvar front : vec4<f32> = textureSample(textureFront, samplerFront, input.fragUV);\nvar gray : f32 = c3_grayscale(front.rgb);\nvar output : FragmentOutput;\noutput.color = mix(front, vec4<f32>(gray, gray, gray, front.a), shaderParams.intensity);\nreturn output;\n}",blendsBackground:!1,usesDepth:!1,extendBoxHorizontal:0,extendBoxVertical:0,crossSampling:!1,mustPreDraw:!1,preservesOpaqueness:!0,supports3dDirectRendering:!1,animated:!1,parameters:[["intensity",0,"percent"]]},self.C3_Shaders.blurhorizontal={glsl:"varying mediump vec2 vTex;\nuniform mediump sampler2D samplerFront;\nuniform mediump vec2 pixelSize;\nuniform mediump float intensity;\nvoid main(void)\n{\nmediump vec4 sum = vec4(0.0);\nmediump float pixelWidth = pixelSize.x;\nmediump float halfPixelWidth = pixelWidth / 2.0;\nsum += texture2D(samplerFront, vTex - vec2(pixelWidth * 7.0 + halfPixelWidth, 0.0)) * 0.06;\nsum += texture2D(samplerFront, vTex - vec2(pixelWidth * 5.0 + halfPixelWidth, 0.0)) * 0.10;\nsum += texture2D(samplerFront, vTex - vec2(pixelWidth * 3.0 + halfPixelWidth, 0.0)) * 0.13;\nsum += texture2D(samplerFront, vTex - vec2(pixelWidth * 1.0 + halfPixelWidth, 0.0)) * 0.16;\nmediump vec4 front = texture2D(samplerFront, vTex);\nsum += front * 0.10;\nsum += texture2D(samplerFront, vTex + vec2(pixelWidth * 1.0 + halfPixelWidth, 0.0)) * 0.16;\nsum += texture2D(samplerFront, vTex + vec2(pixelWidth * 3.0 + halfPixelWidth, 0.0)) * 0.13;\nsum += texture2D(samplerFront, vTex + vec2(pixelWidth * 5.0 + halfPixelWidth, 0.0)) * 0.10;\nsum += texture2D(samplerFront, vTex + vec2(pixelWidth * 7.0 + halfPixelWidth, 0.0)) * 0.06;\ngl_FragColor = mix(front, sum, intensity);\n}",glslWebGL2:"",wgsl:"%%SAMPLERFRONT_BINDING%% var samplerFront : sampler;\n%%TEXTUREFRONT_BINDING%% var textureFront : texture_2d<f32>;\nstruct ShaderParams {\nintensity : f32\n};\n%%SHADERPARAMS_BINDING%% var<uniform> shaderParams : ShaderParams;\n%%C3_UTILITY_FUNCTIONS%%\n%%FRAGMENTINPUT_STRUCT%%\n%%FRAGMENTOUTPUT_STRUCT%%\n@fragment\nfn main(input : FragmentInput) -> FragmentOutput\n{\nvar pixelWidth : f32 = c3_getPixelSize(textureFront).x;\nvar front : vec4<f32> = textureSample(textureFront, samplerFront, input.fragUV);\nvar sum : vec4<f32> =\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(pixelWidth * 7.5, 0.0)) * 0.06 +\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(pixelWidth * 5.5, 0.0)) * 0.10 +\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(pixelWidth * 3.5, 0.0)) * 0.13 +\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(pixelWidth * 1.5, 0.0)) * 0.16 +\nfront * 0.10 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(pixelWidth * 1.5, 0.0)) * 0.16 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(pixelWidth * 3.5, 0.0)) * 0.13 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(pixelWidth * 5.5, 0.0)) * 0.10 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(pixelWidth * 7.5, 0.0)) * 0.06;\nvar output : FragmentOutput;\noutput.color = mix(front, sum, shaderParams.intensity);\nreturn output;\n}",blendsBackground:!1,usesDepth:!1,extendBoxHorizontal:8,extendBoxVertical:0,crossSampling:!1,mustPreDraw:!1,preservesOpaqueness:!1,supports3dDirectRendering:!1,animated:!1,parameters:[["intensity",0,"percent"]]},self.C3_Shaders.blurvertical={glsl:"varying mediump vec2 vTex;\nuniform mediump sampler2D samplerFront;\nuniform mediump vec2 pixelSize;\nuniform mediump float intensity;\nvoid main(void)\n{\nmediump vec4 sum = vec4(0.0);\nmediump float pixelHeight = pixelSize.y;\nmediump float halfPixelHeight = pixelHeight / 2.0;\nsum += texture2D(samplerFront, vTex - vec2(0.0, pixelHeight * 7.0 + halfPixelHeight)) * 0.06;\nsum += texture2D(samplerFront, vTex - vec2(0.0, pixelHeight * 5.0 + halfPixelHeight)) * 0.10;\nsum += texture2D(samplerFront, vTex - vec2(0.0, pixelHeight * 3.0 + halfPixelHeight)) * 0.13;\nsum += texture2D(samplerFront, vTex - vec2(0.0, pixelHeight * 1.0 + halfPixelHeight)) * 0.16;\nmediump vec4 front = texture2D(samplerFront, vTex);\nsum += front * 0.10;\nsum += texture2D(samplerFront, vTex + vec2(0.0, pixelHeight * 1.0 + halfPixelHeight)) * 0.16;\nsum += texture2D(samplerFront, vTex + vec2(0.0, pixelHeight * 3.0 + halfPixelHeight)) * 0.13;\nsum += texture2D(samplerFront, vTex + vec2(0.0, pixelHeight * 5.0 + halfPixelHeight)) * 0.10;\nsum += texture2D(samplerFront, vTex + vec2(0.0, pixelHeight * 7.0 + halfPixelHeight)) * 0.06;\ngl_FragColor = mix(front, sum, intensity);\n}",glslWebGL2:"",wgsl:"%%SAMPLERFRONT_BINDING%% var samplerFront : sampler;\n%%TEXTUREFRONT_BINDING%% var textureFront : texture_2d<f32>;\nstruct ShaderParams {\nintensity : f32\n};\n%%SHADERPARAMS_BINDING%% var<uniform> shaderParams : ShaderParams;\n%%C3_UTILITY_FUNCTIONS%%\n%%FRAGMENTINPUT_STRUCT%%\n%%FRAGMENTOUTPUT_STRUCT%%\n@fragment\nfn main(input : FragmentInput) -> FragmentOutput\n{\nvar pixelHeight : f32 = c3_getPixelSize(textureFront).y;\nvar front : vec4<f32> = textureSample(textureFront, samplerFront, input.fragUV);\nvar sum : vec4<f32> =\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(0.0, pixelHeight * 7.5)) * 0.06 +\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(0.0, pixelHeight * 5.5)) * 0.10 +\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(0.0, pixelHeight * 3.5)) * 0.13 +\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(0.0, pixelHeight * 1.5)) * 0.16 +\nfront * 0.10 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(0.0, pixelHeight * 1.5)) * 0.16 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(0.0, pixelHeight * 3.5)) * 0.13 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(0.0, pixelHeight * 5.5)) * 0.10 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(0.0, pixelHeight * 7.5)) * 0.06;\nvar output : FragmentOutput;\noutput.color = mix(front, sum, shaderParams.intensity);\nreturn output;\n}",blendsBackground:!1,usesDepth:!1,extendBoxHorizontal:0,extendBoxVertical:8,crossSampling:!1,mustPreDraw:!1,preservesOpaqueness:!1,supports3dDirectRendering:!1,animated:!1,parameters:[["intensity",0,"percent"]]},self.C3_Shaders.water={glsl:"#ifdef GL_FRAGMENT_PRECISION_HIGH\n#define highmedp highp\n#else\n#define highmedp mediump\n#endif\nvarying mediump vec2 vTex;\nuniform lowp sampler2D samplerFront;\nuniform mediump vec2 srcStart;\nuniform mediump vec2 srcEnd;\nprecision mediump float;\nuniform highmedp float seconds;\nuniform mediump vec2 pixelSize;\nconst float PI = 3.1415926535897932;\nuniform float speed;\nuniform float speed_x;\nuniform float speed_y;\nuniform float intensity;\nconst float steps = 8.0;\nuniform float frequency;\nuniform float angle; // better when a prime\nuniform float delta;\nuniform float intence;\nuniform float emboss;\nfloat col(vec2 coord)\n{\nfloat delta_theta = 2.0 * PI / angle;\nfloat col = 0.0;\nfloat theta = 0.0;\nfor (float i = 0.0; i < steps; i++)\n{\nvec2 adjc = coord;\ntheta = delta_theta*i;\nadjc.x += cos(theta)*seconds*speed + seconds * speed_x;\nadjc.y -= sin(theta)*seconds*speed - seconds * speed_y;\ncol = col + cos( (adjc.x*cos(theta) - adjc.y*sin(theta))*frequency)*intensity;\n}\nreturn cos(col);\n}\nvoid main(void)\n{\nmediump vec2 tex = (vTex - srcStart) / (srcEnd - srcStart);\nvec2 p = tex, c1 = p, c2 = p;\nfloat cc1 = col(c1);\nc2.x += (1.0 / pixelSize.x) / delta;\nfloat dx = emboss*(cc1-col(c2))/delta;\nc2.x = p.x;\nc2.y += (1.0 / pixelSize.y) / delta;\nfloat dy = emboss*(cc1-col(c2))/delta;\nc1.x += dx;\nc1.y = -(c1.y+dy);\nfloat alpha = 1.+dot(dx,dy)*intence;\nc1.y = -c1.y;\nc1 = clamp(c1, 0.0, 1.0);\ngl_FragColor = texture2D(samplerFront, mix(srcStart, srcEnd, c1)) * alpha;\n}",glslWebGL2:"",wgsl:"%%SAMPLERFRONT_BINDING%% var samplerFront : sampler;\n%%TEXTUREFRONT_BINDING%% var textureFront : texture_2d<f32>;\nstruct ShaderParams {\nspeed : f32,\nspeed_x : f32,\nspeed_y : f32,\nintensity : f32,\nfrequency : f32,\nangle : f32,\ndelta : f32,\nintence : f32,\nemboss : f32\n};\n%%SHADERPARAMS_BINDING%% var<uniform> shaderParams : ShaderParams;\n%%C3PARAMS_STRUCT%%\n%%C3_UTILITY_FUNCTIONS%%\n%%FRAGMENTINPUT_STRUCT%%\n%%FRAGMENTOUTPUT_STRUCT%%\nconst pi : f32 = 3.1415926535897932;\nconst steps = 8.0;\nfn col(coord : vec2<f32>) -> f32\n{\nvar delta_theta : f32 = 2.0 * pi / shaderParams.angle;\nvar col : f32 = 0.0;\nvar theta : f32 = 0.0;\nfor (var i : f32 = 0.0; i < steps; i = i + 1.0)\n{\nvar adjc : vec2<f32> = coord;\ntheta = delta_theta * i;\nadjc.x = adjc.x + cos(theta) * c3Params.seconds * shaderParams.speed + c3Params.seconds * shaderParams.speed_x;\nadjc.y = adjc.y - (sin(theta) * c3Params.seconds * shaderParams.speed - c3Params.seconds * shaderParams.speed_y);\ncol = col + cos((adjc.x * cos(theta) - adjc.y * sin(theta)) * shaderParams.frequency) * shaderParams.intensity;\n}\nreturn cos(col);\n}\n@fragment\nfn main(input : FragmentInput) -> FragmentOutput\n{\nvar texSize : vec2<f32> = vec2<f32>(textureDimensions(textureFront));\nvar tex : vec2<f32> = c3_srcToNorm(input.fragUV);\nvar p : vec2<f32> = tex;\nvar c1 : vec2<f32> = tex;\nvar c2 : vec2<f32> = tex;\nvar cc1 : f32 = col(c1);\nc2.x = c2.x + texSize.x / shaderParams.delta;\nvar dx : f32 = shaderParams.emboss * (cc1 - col(c2)) / shaderParams.delta;\nc2.x = p.x;\nc2.y = c2.y + texSize.y / shaderParams.delta;\nvar dy : f32 = shaderParams.emboss * (cc1 - col(c2)) / shaderParams.delta;\nc1.x = c1.x + dx;\nc1.y = -(c1.y + dy);\nvar alpha : f32 = 1.0 + dx * dy * shaderParams.intence;\nc1.y = -c1.y;\nc1 = c3_clamp2(c1, 0.0, 1.0);\nvar output : FragmentOutput;\noutput.color = textureSample(textureFront, samplerFront, mix(c3Params.srcStart, c3Params.srcEnd, c1)) * alpha;\nreturn output;\n}",blendsBackground:!1,usesDepth:!1,extendBoxHorizontal:40,extendBoxVertical:40,crossSampling:!1,mustPreDraw:!1,preservesOpaqueness:!1,supports3dDirectRendering:!1,animated:!0,parameters:[["speed",0,"percent"],["speed_x",0,"percent"],["speed_y",0,"percent"],["intensity",0,"float"],["frequency",0,"float"],["angle",0,"float"],["delta",0,"float"],["intence",0,"float"],["emboss",0,"percent"]]};{let $C=function(e,t){const s=e[1],i=t[1];if("number"==typeof s&&"number"==typeof i)return s-i;{const e=""+s,t=""+i;return e<t?-1:e>t?1:0}};ForEachOrdered_SortInstances=$C;const KC=self.C3;let JC=null,QC="",ZC="",ew=[],tw="",sw="",iw="";const rw=KC.New(KC.ArrayStack);KC.Plugins.System=class extends KC.SDKPluginBase{constructor(e){super(e),this._loopStack=this._runtime.GetEventSheetManager().GetLoopStack(),this._eventStack=this._runtime.GetEventSheetManager().GetEventStack(),this._imagesLoadingTotal=0,this._imagesLoadingComplete=0,this._functionMaps=new Map}Release(){super.Release()}UpdateRender(){this._runtime.UpdateRender()}Trigger(e){this._runtime.Trigger(e,null,null)}GetRegex(e,t){return JC&&e===QC&&t===ZC||(JC=new RegExp(e,t),QC=e,ZC=t),JC.lastIndex=0,JC}GetRegexMatches(e,t,s){if(e===tw&&t===sw&&s===iw)return ew;const i=this.GetRegex(t,s);return ew=e.match(i),tw=e,sw=t,iw=s,ew}async _LoadTexturesForObjectClasses(e,t){if(!t.length)return;this._imagesLoadingTotal+=t.length;const s=[];for(const i of t)s.push(e.MaybeLoadTexturesFor(i));await KC.PromiseAllWithProgress(s,()=>{this._imagesLoadingComplete++}),this._imagesLoadingComplete++,this._imagesLoadingComplete===this._imagesLoadingTotal&&(this._imagesLoadingComplete=0,this._imagesLoadingTotal=0,this._runtime.Trigger(KC.Plugins.System.Cnds.OnImageLoadingComplete,null,null))}GetImageLoadingProgress(){return 0===this._imagesLoadingTotal?1:this._imagesLoadingComplete/this._imagesLoadingTotal}_UnloadTexturesForObjectClasses(e,t){for(const s of t)0===s.GetInstanceCount()&&e.MaybeUnloadTexturesFor(s)}_GetForEachStack(){return rw}_Repeat(e){const t=this._runtime.GetEventSheetManager(),s=t.GetEventStack(),i=s.GetCurrentStackFrame(),r=i.GetCurrentEvent(),n=r.GetSolModifiers(),a=i.IsSolModifierAfterCnds(),o=s.Push(r),l=t.GetLoopStack(),h=l.Push();if(h.SetEnd(e),a)for(let s=0;s<e&&!h.IsStopped();++s)t.PushCopySol(n),h.SetIndex(s),r.Retrigger(i,o),t.PopSol(n);else for(let t=0;t<e&&!h.IsStopped();++t)h.SetIndex(t),r.Retrigger(i,o);return s.Pop(),l.Pop(),!1}*_DebugRepeat(e){const t=this._runtime.GetEventSheetManager(),s=t.GetEventStack(),i=s.GetCurrentStackFrame(),r=i.GetCurrentEvent(),n=r.GetSolModifiers(),a=i.IsSolModifierAfterCnds(),o=s.Push(r),l=t.GetLoopStack(),h=l.Push();if(h.SetEnd(e),a)for(let s=0;s<e&&!h.IsStopped();++s)t.PushCopySol(n),h.SetIndex(s),yield*r.DebugRetrigger(i,o),t.PopSol(n);else for(let t=0;t<e&&!h.IsStopped();++t)h.SetIndex(t),yield*r.DebugRetrigger(i,o);return s.Pop(),l.Pop(),!1}_While(){const e=this._runtime.GetEventSheetManager(),t=e.GetEventStack(),s=t.GetCurrentStackFrame(),i=s.GetCurrentEvent(),r=i.GetSolModifiers(),n=s.IsSolModifierAfterCnds(),a=t.Push(i),o=e.GetLoopStack(),l=o.Push();if(n)for(let t=0;!l.IsStopped();++t)e.PushCopySol(r),l.SetIndex(t),i.Retrigger(s,a)||l.Stop(),e.PopSol(r);else for(let e=0;!l.IsStopped();++e)l.SetIndex(e),i.Retrigger(s,a)||l.Stop();return t.Pop(),o.Pop(),!1}*_DebugWhile(){const e=this._runtime.GetEventSheetManager(),t=e.GetEventStack(),s=t.GetCurrentStackFrame(),i=s.GetCurrentEvent(),r=i.GetSolModifiers(),n=s.IsSolModifierAfterCnds(),a=t.Push(i),o=e.GetLoopStack(),l=o.Push();if(n)for(let t=0;!l.IsStopped();++t)e.PushCopySol(r),l.SetIndex(t),(yield*i.DebugRetrigger(s,a))||l.Stop(),e.PopSol(r);else for(let e=0;!l.IsStopped();++e)l.SetIndex(e),(yield*i.DebugRetrigger(s,a))||l.Stop();return t.Pop(),o.Pop(),!1}_For(e,t,s){const i=this._runtime.GetEventSheetManager(),r=i.GetEventStack(),n=r.GetCurrentStackFrame(),a=n.GetCurrentEvent(),o=a.GetSolModifiers(),l=n.IsSolModifierAfterCnds(),h=r.Push(a),u=i.GetLoopStack(),c=u.Push();if(c.SetName(e),c.SetEnd(s),s<t)if(l)for(let e=t;e>=s&&!c.IsStopped();--e)i.PushCopySol(o),c.SetIndex(e),a.Retrigger(n,h),i.PopSol(o);else for(let e=t;e>=s&&!c.IsStopped();--e)c.SetIndex(e),a.Retrigger(n,h);else if(l)for(let e=t;e<=s&&!c.IsStopped();++e)i.PushCopySol(o),c.SetIndex(e),a.Retrigger(n,h),i.PopSol(o);else for(let e=t;e<=s&&!c.IsStopped();++e)c.SetIndex(e),a.Retrigger(n,h);return r.Pop(),u.Pop(),!1}*_DebugFor(e,t,s){const i=this._runtime.GetEventSheetManager(),r=i.GetEventStack(),n=r.GetCurrentStackFrame(),a=n.GetCurrentEvent(),o=a.GetSolModifiers(),l=n.IsSolModifierAfterCnds(),h=r.Push(a),u=i.GetLoopStack(),c=u.Push();if(c.SetName(e),c.SetEnd(s),s<t)if(l)for(let e=t;e>=s&&!c.IsStopped();--e)i.PushCopySol(o),c.SetIndex(e),yield*a.DebugRetrigger(n,h),i.PopSol(o);else for(let e=t;e>=s&&!c.IsStopped();--e)c.SetIndex(e),yield*a.DebugRetrigger(n,h);else if(l)for(let e=t;e<=s&&!c.IsStopped();++e)i.PushCopySol(o),c.SetIndex(e),yield*a.DebugRetrigger(n,h),i.PopSol(o);else for(let e=t;e<=s&&!c.IsStopped();++e)c.SetIndex(e),yield*a.DebugRetrigger(n,h);return r.Pop(),u.Pop(),!1}_ForEach(e){const t=e.GetCurrentSol(),s=t.GetInstances();if(0===s.length)return!1;const i=this._runtime.GetEventSheetManager(),r=i.GetEventStack(),n=r.GetCurrentStackFrame(),a=n.GetCurrentEvent(),o=a.GetSolModifiers(),l=n.IsSolModifierAfterCnds(),h=r.Push(a),u=i.GetLoopStack(),c=u.Push(),d=e.IsInContainer(),p=rw.Push();if(KC.shallowAssignArray(p,s),c.SetEnd(p.length),l)for(let t=0,s=p.length;t<s&&!c.IsStopped();++t){i.PushCopySol(o);const s=p[t];e.GetCurrentSol().SetSinglePicked(s),d&&s.SetSiblingsSinglePicked(),c.SetIndex(t),a.Retrigger(n,h),i.PopSol(o)}else{t._SetSelectAll(!1);const e=t._GetOwnInstances();KC.clearArray(e),e.push(null);for(let t=0,s=p.length;t<s&&!c.IsStopped();++t){const s=p[t];e[0]=s,d&&s.SetSiblingsSinglePicked(),c.SetIndex(t),a.Retrigger(n,h)}}return r.Pop(),u.Pop(),KC.clearArray(p),rw.Pop(),!1}*_DebugForEach(e){const t=e.GetCurrentSol(),s=t.GetInstances();if(0===s.length)return!1;const i=this._runtime.GetEventSheetManager(),r=i.GetEventStack(),n=r.GetCurrentStackFrame(),a=n.GetCurrentEvent(),o=a.GetSolModifiers(),l=n.IsSolModifierAfterCnds(),h=r.Push(a),u=i.GetLoopStack(),c=u.Push(),d=e.IsInContainer(),p=rw.Push();if(KC.shallowAssignArray(p,s),c.SetEnd(p.length),l)for(let t=0,s=p.length;t<s&&!c.IsStopped();++t){i.PushCopySol(o);const s=p[t];e.GetCurrentSol().SetSinglePicked(s),d&&s.SetSiblingsSinglePicked(),c.SetIndex(t),yield*a.DebugRetrigger(n,h),i.PopSol(o)}else{t._SetSelectAll(!1);const e=t._GetOwnInstances();KC.clearArray(e),e.push(null);for(let t=0,s=p.length;t<s&&!c.IsStopped();++t){const s=p[t];e[0]=s,d&&s.SetSiblingsSinglePicked(),c.SetIndex(t),yield*a.DebugRetrigger(n,h)}}return r.Pop(),u.Pop(),KC.clearArray(p),rw.Pop(),!1}_ForEachOrdered(e,t){const s=e.GetCurrentSol(),i=s.GetInstances();if(0===i.length)return!1;const r=this._runtime.GetEventSheetManager(),n=r.GetEventStack(),a=r.GetCurrentCondition(),o=n.GetCurrentStackFrame(),l=o.GetCurrentEvent(),h=l.GetSolModifiers(),u=o.IsSolModifierAfterCnds(),c=n.Push(l),d=r.GetLoopStack(),p=d.Push(),_=e.IsInContainer(),m=rw.Push();KC.clearArray(m),p.SetEnd(i.length);for(let e=0,t=i.length;e<t;++e)m.push([i[e],a.ReevaluateParameter(1,e)]);if(m.sort($C),1===t&&m.reverse(),u)for(let t=0,s=m.length;t<s&&!p.IsStopped();++t){r.PushCopySol(h);const s=m[t][0];e.GetCurrentSol().SetSinglePicked(s),_&&s.SetSiblingsSinglePicked(),p.SetIndex(t),l.Retrigger(o,c),r.PopSol(h)}else{s._SetSelectAll(!1);const e=s._GetOwnInstances();KC.clearArray(e),e.push(null);for(let t=0,s=m.length;t<s&&!p.IsStopped();++t){const s=m[t][0];e[0]=s,_&&s.SetSiblingsSinglePicked(),p.SetIndex(t),l.Retrigger(o,c)}}return n.Pop(),d.Pop(),KC.clearArray(m),rw.Pop(),!1}*_DebugForEachOrdered(e,t){const s=e.GetCurrentSol(),i=s.GetInstances();if(0===i.length)return!1;const r=this._runtime.GetEventSheetManager(),n=r.GetEventStack(),a=r.GetCurrentCondition(),o=n.GetCurrentStackFrame(),l=o.GetCurrentEvent(),h=l.GetSolModifiers(),u=o.IsSolModifierAfterCnds(),c=n.Push(l),d=r.GetLoopStack(),p=d.Push(),_=e.IsInContainer(),m=rw.Push();KC.clearArray(m),p.SetEnd(i.length);for(let e=0,t=i.length;e<t;++e)m.push([i[e],a.ReevaluateParameter(1,e)]);if(m.sort($C),1===t&&m.reverse(),u)for(let t=0,s=m.length;t<s&&!p.IsStopped();++t){r.PushCopySol(h);const s=m[t][0];e.GetCurrentSol().SetSinglePicked(s),_&&s.SetSiblingsSinglePicked(),p.SetIndex(t),yield*l.DebugRetrigger(o,c),r.PopSol(h)}else{s._SetSelectAll(!1);const e=s._GetOwnInstances();KC.clearArray(e),e.push(null);for(let t=0,s=m.length;t<s&&!p.IsStopped();++t){const s=m[t][0];e[0]=s,_&&s.SetSiblingsSinglePicked(),p.SetIndex(t),yield*l.DebugRetrigger(o,c)}}return n.Pop(),d.Pop(),KC.clearArray(m),rw.Pop(),!1}_GetFunctionMap(e,t){let s=this._functionMaps.get(e);return s||(t?(s={defaultFunc:null,strMap:new Map},this._functionMaps.set(e,s),s):null)}_DoCallMappedFunction(e,t,s,i,r){t.GetEventBlock().RunAsMappedFunctionCall(s,t.IsCopyPicked()),i&&e.PopSol(r)}*_DebugDoCallMappedFunction(e,t,s,i,r){yield*t.GetEventBlock().DebugRunAsMappedFunctionCall(s,t.IsCopyPicked()),i&&e.PopSol(r)}}}{const aw=self.C3;aw.Plugins.System.Type=class extends aw.DefendedBase{constructor(e){super(),this._objectClass=e,this._runtime=e.GetRuntime(),this._plugin=e.GetPlugin()}OnCreate(){}Release(){this._objectClass=null,this._runtime=null,this._plugin=null}}}{const ow=self.C3;ow.Plugins.System.Instance=class extends ow.DefendedBase{constructor(e,t){super(),this._inst=e,this._objectClass=this._inst.GetObjectClass(),this._sdkType=this._objectClass.GetSdkType(),this._runtime=this._inst.GetRuntime()}Release(){this._inst=null,this._objectClass=null,this._sdkType=null,this._runtime=null}}}{const lw=self.C3,hw=[];lw.Plugins.System.Cnds={EveryTick:()=>!0,OnLayoutStart:()=>!0,OnLayoutEnd:()=>!0,OnSuspend:()=>!0,OnResume:()=>!0,IsSuspended(){return this._runtime.IsSuspended()},Else(){const e=this._runtime.GetCurrentEventStackFrame();return!e.GetElseBranchRan()&&!e.GetLastEventTrue()},TriggerOnce(){const e=this._runtime.GetCurrentCondition().GetSavedDataMap();let t=e.get("TriggerOnce_lastTick");void 0===t&&(t=-1,e.set("TriggerOnce_lastTick",-1));const s=this._runtime.GetTickCount();return e.set("TriggerOnce_lastTick",s),this._runtime.IsLayoutFirstTick()||t!==s-1},Every(e){const t=this._runtime.GetCurrentCondition().GetSavedDataMap(),s=t.get("Every_lastTime")||0,i=this._runtime.GetGameTime();t.has("Every_seconds")||t.set("Every_seconds",e);const r=t.get("Every_seconds");return i>=s+r?(t.set("Every_lastTime",s+r),i>=t.get("Every_lastTime")+.04&&t.set("Every_lastTime",i),t.set("Every_seconds",e),!0):(i<s-.1&&t.set("Every_lastTime",i),!1)},IsGroupActive(e){const t=this._runtime.GetEventSheetManager().GetEventGroupByName(e);return t&&t.IsGroupActive()},IsPreview(){return this._runtime.IsPreview()},IsMobile:()=>lw.Platform.IsMobile,OnLoadFinished:()=>!0,OnCanvasSnapshot:()=>!0,EffectsSupported:()=>!0,OnSaveComplete:()=>!0,OnSaveFailed:()=>!0,OnLoadComplete:()=>!0,OnLoadFailed:()=>!0,ObjectUIDExists(e){return!!this._runtime.GetInstanceByUID(e)},IsOnPlatform(e){switch(e){case 0:return"browser"===lw.Platform.Context;case 1:return"iOS"===lw.Platform.OS;case 2:return"Android"===lw.Platform.OS;case 8:return"cordova"===lw.Platform.Context;case 9:return"scirra-arcade"===this._runtime.GetExportType();case 10:return"nwjs"===lw.Platform.Context;case 13:return"windows-uwp"===this._runtime.GetExportType();default:return!1}},RegexTest(e,t,s){return this.GetRegex(t,s).test(e)},Compare:(e,t,s)=>lw.compare(e,t,s),CompareBetween:(e,t,s)=>e>=t&&e<=s,CompareVar:(e,t,s)=>lw.compare(e.GetValue(),t,s),CompareBoolVar:e=>!!e.GetValue(),CompareTime(e,t){const s=this._runtime.GetGameTime();if(0===e){const e=this._runtime.GetCurrentCondition().GetSavedDataMap();return!e.get("CompareTime_executed")&&s>=t&&(e.set("CompareTime_executed",!0),!0)}return lw.compare(s,e,t)},IsNaN:e=>isNaN(e),AngleWithin:(e,t,s)=>lw.angleDiff(lw.toRadians(e),lw.toRadians(s))<=lw.toRadians(t),IsClockwiseFrom:(e,t)=>lw.angleClockwise(lw.toRadians(e),lw.toRadians(t)),IsBetweenAngles(e,t,s){let i=lw.toRadians(e),r=lw.toRadians(t),n=lw.toRadians(s);return lw.angleClockwise(n,r)?lw.angleClockwise(i,r)&&!lw.angleClockwise(i,n):!(!lw.angleClockwise(i,r)&&lw.angleClockwise(i,n))},IsValueType:(e,t)=>"number"==typeof e?0===t:1===t,EvaluateExpression:e=>!!e,OnSignal(e){return e.toLowerCase()===this._runtime.GetEventSheetManager().GetCurrentSignalTag()},PickByComparison(e,t,s,i){if(!e)return!1;const r=this._GetForEachStack(),n=r.Push(),a=e.GetCurrentSol();lw.shallowAssignArray(n,a.GetInstances()),a.IsSelectAll()&&lw.clearArray(a._GetOwnElseInstances());const o=this._runtime.GetCurrentCondition();let l=0;for(let e=0,r=n.length;e<r;++e){const r=n[e];n[l]=r,t=o.ReevaluateParameter(1,e),i=o.ReevaluateParameter(3,e),lw.compare(t,s,i)?++l:a._PushElseInstance(r)}lw.truncateArray(n,l),a.SetArrayPicked(n);const h=!!n.length;return lw.clearArray(n),r.Pop(),e.ApplySolToContainer(),h},PickByEvaluate(e,t){if(!e)return!1;const s=this._GetForEachStack(),i=s.Push(),r=e.GetCurrentSol();lw.shallowAssignArray(i,r.GetInstances()),r.IsSelectAll()&&lw.clearArray(r._GetOwnElseInstances());const n=this._runtime.GetCurrentCondition();let a=0;for(let e=0,t=i.length;e<t;++e){const t=i[e];i[a]=t,n.ReevaluateParameter(1,e)?++a:r._PushElseInstance(t)}lw.truncateArray(i,a),r.SetArrayPicked(i);const o=!!i.length;return lw.clearArray(i),s.Pop(),e.ApplySolToContainer(),o},PickByHighestLowestValue(e,t,s){if(!e)return!1;const i=e.GetCurrentSol(),r=i.GetInstances();if(0===r.length)return!1;const n=this._runtime.GetCurrentCondition();let a=null,o=0;for(let e=0,i=r.length;e<i;++e){const i=r[e];s=n.ReevaluateParameter(2,e),(null===a||0===t&&s<o||1===t&&s>o)&&(o=s,a=i)}return i.PickOne(a),e.ApplySolToContainer(),!0},PickNth(e,t){if(!e)return!1;const s=e.GetCurrentSol(),i=s.GetInstances();if((t=Math.floor(t))>=i.length)return!1;const r=i[t];return s.PickOne(r),e.ApplySolToContainer(),!0},PickRandom(e){if(!e)return!1;const t=e.GetCurrentSol(),s=t.GetInstances(),i=Math.floor(this._runtime.Random()*s.length);if(i>=s.length)return!1;const r=s[i];return t.PickOne(r),e.ApplySolToContainer(),!0},PickAll:e=>!!e&&(!!e.GetInstanceCount()&&(e.GetCurrentSol()._SetSelectAll(!0),e.ApplySolToContainer(),!0)),PickOverlappingPoint(e,t,s){if(!e)return!1;const i=e.GetCurrentSol(),r=i.GetInstances(),n=this._runtime.GetCurrentEvent().IsOrBlock(),a=this._runtime.GetCurrentCondition().IsInverted();i.IsSelectAll()?(lw.shallowAssignArray(hw,r),i.ClearArrays(),i._SetSelectAll(!1)):n?(lw.shallowAssignArray(hw,i._GetOwnElseInstances()),lw.clearArray(i._GetOwnElseInstances())):(lw.shallowAssignArray(hw,i._GetOwnInstances()),lw.clearArray(i._GetOwnInstances()));for(let e=0,r=hw.length;e<r;++e){const r=hw[e];lw.xor(r.GetWorldInfo().ContainsPoint(t,s),a)?i._PushInstance(r):i._PushElseInstance(r)}return e.ApplySolToContainer(),lw.xor(!!i._GetOwnInstances().length,a)},PickLastCreated(e){if(!e)return!1;const t=e.IsFamily();let s=null;const i=this._runtime._GetInstancesPendingCreate();for(let r=i.length-1;r>=0;--r){const n=i[r];if(t){if(n.GetObjectClass().BelongsToFamily(e)){s=n;break}}else if(n.GetObjectClass()===e){s=n;break}}if(!s){const t=e.GetInstances();t.length&&(s=t.at(-1))}return!!s&&(e.GetCurrentSol().PickOne(s),e.ApplySolToContainer(),!0)},Repeat(e){return this._runtime.IsDebugging()?this._DebugRepeat(e):this._Repeat(e)},While(){return this._runtime.IsDebugging()?this._DebugWhile():this._While()},For(e,t,s){return this._runtime.IsDebugging()?this._DebugFor(e,t,s):this._For(e,t,s)},ForEach(e){return this._runtime.IsDebugging()?this._DebugForEach(e):this._ForEach(e)},ForEachOrdered(e,t,s){return this._runtime.IsDebugging()?this._DebugForEachOrdered(e,s):this._ForEachOrdered(e,s)},LayerVisible:e=>!!e&&e.IsVisible(),LayerInteractive:e=>!!e&&e.IsSelfAndParentsInteractive(),LayerIsHTML:e=>!!e&&e.IsHTMLElementsLayer(),LayerEmpty:e=>!!e&&!e.GetInstanceCount(),LayerCmpOpacity:(e,t,s)=>!!e&&lw.compare(100*e.GetOpacity(),t,s),LayerNameExists(e){const t=this._runtime.GetMainRunningLayout();return!!t&&t.HasLayerByName(e)},OnImageLoadingComplete:()=>!0,IsLoadingImages(){return this._imagesLoadingTotal>0},TemplateExists(e,t){const s=this._runtime.GetTemplateManager();return!!s&&!!t&&!!s.GetTemplateData(e,t)}}}{let uw=function(e,t){const s=e[0]-t[0];return 0!==s?s:e[1]-t[1]},cw=function(e,t){return e[1]-t[1]};SortZOrderList=uw,SortInstancesByValue=cw;const dw=self.C3,pw=[],_w=[],mw=dw.New(dw.Rect),fw=dw.New(dw.Color),gw=[];dw.Plugins.System.Acts={SetVar(e,t){e.SetValue(t)},AddVar(e,t){e.IsNumber()&&"number"!=typeof t&&(t=parseFloat(t)),e.SetValue(e.GetValue()+t)},SubVar(e,t){e.IsNumber()&&e.SetValue(e.GetValue()-t)},SetBoolVar(e,t){e.SetValue(!!t)},ToggleBoolVar(e){e.SetValue(!e.GetValue())},ResetEventVar(e){e.SetValue(e.GetInitialValue())},ResetGlobals(e){this._runtime.GetEventSheetManager().ResetAllGlobalsToInitialValue(e)},CreateObject(e,t,s,i,r,n){if(!e||!t)return;const a=this._runtime.CreateInstance(e,t,s,i,r,n);if(!a)return;r&&t.SortAndAddInstancesByZIndex(a);const o=this._runtime.GetEventSheetManager();o.BlockFlushingInstances(!0),a._TriggerOnCreatedOnSelfAndRelated(),o.BlockFlushingInstances(!1);const l=new Map;a.CollectInstancesToPick(l,e,r);for(const[e,t]of l)e.GetCurrentSol().SetSetPicked(t)},CreateObjectByName(e,t,s,i,r,n){if(!e||!t)return;const a=this._runtime.GetObjectClassByName(e);a&&dw.Plugins.System.Acts.CreateObject.call(this,a,t,s,i,r,n)},RecreateInitialObjects(e,t,s,i,r,n,a,o,l,h,u){if(!e)return;const c=this._runtime.GetCurrentLayout();let d=c;if(n){const e=this._runtime.GetLayoutManager().GetLayoutByName(n);if(!e)return;d=e}let p=null;if(("number"!=typeof a||a>=0)&&(p=d.GetLayer(a),!p))return;let _=null;if(("number"!=typeof o||o>=0)&&(_=c.GetLayer(o),!_))return;mw.set(t,s,i,r);const m=d.RecreateInitialObjects(e,mw,p,_,l,h,u);e.GetCurrentSol().SetArrayPicked(m),e.ApplySolToContainer()},StopLoop(){const e=this._loopStack;e.IsInLoop()&&e.GetCurrent().Stop()},SetGroupActive(e,t){const s=this._runtime.GetEventSheetManager().GetEventGroupByName(e);s&&(0===t?s.SetGroupActive(!1):1===t?s.SetGroupActive(!0):s.SetGroupActive(!s.IsGroupActive()))},SetTimescale(e){this._runtime.SetTimeScale(e)},SetObjectTimescale(e,t){if(t<0&&(t=0),!e)return;const s=e.GetCurrentSol().GetInstances();for(const e of s)e.SetTimeScale(t)},RestoreObjectTimescale(e){if(!e)return;const t=e.GetCurrentSol().GetInstances();for(const e of t)e.RestoreTimeScale()},Wait(e,t){if(e<0)return;const s=this._runtime.GetEventSheetManager().AddScheduledWait();return t?s.InitTimer(e):s.InitWallTimer(e),!0},WaitForSignal(e){return this._runtime.GetEventSheetManager().AddScheduledWait().InitSignal(e),!0},WaitForPreviousActions(){const e=this._runtime.GetEventSheetManager();return e.AddScheduledWait().InitPromise(e.GetPromiseForAllAsyncActions()),!0},Signal(e){this._runtime.GetEventSheetManager().Signal(e)},async SnapshotCanvas(e,t,s,i,r,n){const a=this._runtime.GetCanvasManager();a&&(this.UpdateRender(),await a.SnapshotCanvas(0===e?"image/png":"image/jpeg",t/100,s,i,r,n),await this._runtime.TriggerAsync(dw.Plugins.System.Cnds.OnCanvasSnapshot,null))},SetCanvasSize(e,t){if(e<=0||t<=0)return;this._runtime.SetViewportSize(e,t),this._runtime.GetCurrentLayout().BoundScrolling();const s=this._runtime.GetCanvasManager();s&&("off"===s.GetCurrentFullscreenMode()||this._runtime.SetOriginalViewportSize(e,t),s.SetSize(s.GetLastWidth(),s.GetLastHeight(),!0),this._runtime.UpdateRender())},SetFullscreenQuality(e){const t=this._runtime.GetCanvasManager();t&&"off"!==t.GetCurrentFullscreenMode()&&(t.SetFullscreenScalingQuality(0!==e?"high":"low"),t.SetSize(t.GetLastWidth(),t.GetLastHeight(),!0))},SaveState(e){this._runtime.SaveToSlot(e)},SaveStateJSON(){this._runtime.SaveToJsonString()},LoadState(e){this._runtime.LoadFromSlot(e)},LoadStateJSON(e){this._runtime.LoadFromJsonString(e)},SetHalfFramerateMode(e){},ResetPersisted(){for(const e of this._runtime.GetLayoutManager().GetAllLayouts())e.ResetPersistData()},SetPixelRounding(e){this._runtime.SetPixelRoundingEnabled(0!==e)},SetFramerateMinMax(e,t){this._runtime.SetMaxDt(1/e),this._runtime.SetMinDt(1/t)},SetDeltaTimeMinMax(e,t){this._runtime.SetMinDt(e),this._runtime.SetMaxDt(t)},SetFramerateMode(e){this._runtime._SetFramerateMode(["vsync","unlimited-tick","unlimited-frame"][e])},SortZOrderByInstVar(e,t){if(!e)return;const s=e.GetCurrentSol().GetInstances(),i=pw,r=_w,n=this._runtime.GetCurrentLayout(),a=e.IsFamily(),o=e.GetFamilyIndex();for(let e=0,n=s.length;e<n;++e){const n=s[e],l=n.GetWorldInfo();if(!l)continue;let h;h=a?n.GetInstanceVariableValue(t+n.GetObjectClass().GetFamilyInstanceVariableOffset(o)):n.GetInstanceVariableValue(t),i.push([l.GetLayer().GetIndex(),l.GetZIndex()]),r.push([n,h])}if(!i.length)return;i.sort(uw),r.sort(cw);let l=!1;for(let e=0,t=i.length;e<t;++e){const t=r[e][0],s=n.GetLayerByIndex(i[e][0]),a=i[e][1],o=s._GetInstances();o[a]!==t&&(o[a]=t,t.GetWorldInfo()._SetLayer(s,!0),s.SetZIndicesChanged(t),l=!0)}l&&this._runtime.UpdateRender(),dw.clearArray(pw),dw.clearArray(_w)},SetCollisionCellSize(e,t){e=Math.floor(e),t=Math.floor(t),e<=0||t<=0||!Number.isFinite(e)||!Number.isFinite(t)||this._runtime.GetCollisionEngine().SetCollisionCellSize(e,t)},GoToLayout(e){if(this._runtime.IsLoading())return;const t=this._runtime.GetLayoutManager();t.IsPendingChangeMainLayout()||t.ChangeMainLayout(e)},GoToLayoutByName(e){if(this._runtime.IsLoading())return;const t=this._runtime.GetLayoutManager();if(t.IsPendingChangeMainLayout())return;const s=t.GetLayoutByName(e);s&&t.ChangeMainLayout(s)},NextPrevLayout(e){if(this._runtime.IsLoading())return;const t=this._runtime.GetLayoutManager();if(t.IsPendingChangeMainLayout())return;const s=t.GetAllLayouts(),i=s.indexOf(t.GetMainRunningLayout());if(e&&0===i)return;if(!e&&i===s.length-1)return;const r=s[i+(e?-1:1)];t.ChangeMainLayout(r)},RestartLayout(){if(this._runtime.IsLoading())return;const e=this._runtime.GetLayoutManager();e.IsPendingChangeMainLayout()||(e.ChangeMainLayout(e.GetMainRunningLayout()),this._runtime.GetEventSheetManager().ResetAllGroupsInitialActivation())},SetLayerVisible(e,t){e&&e.SetVisible(t)},SetLayerInteractive(e,t){e&&e.SetInteractive(t)},SetLayerHTML(e,t){e&&e.SetIsHTMLElementsLayer(t)},SetLayerOpacity(e,t){e&&e.SetOpacity(t/100)},SetLayerScale(e,t){e&&e.SetOwnScale(t)},SetLayerScaleRate(e,t){e&&e.SetScaleRate(t)},SetLayerAngle(e,t){e&&e.SetAngle(dw.toRadians(+t))},SetLayerScroll(e,t,s){e&&(e.SetOwnScrollPositionEnabled(!0),e.SetScrollX(t),e.SetScrollY(s))},RestoreLayerScroll(e){e&&e.SetOwnScrollPositionEnabled(!1)},SetLayerParallax(e,t,s){e&&e.SetParallax(t/100,s/100)},SetLayerZElevation(e,t){e&&e.SetZElevation(+t)},SetLayerRenderingMode(e,t){e&&e.SetRenderAs3D(1===t)},SetLayerBackground(e,t){if(!e)return;fw.setFromRgbValue(t),fw.clamp();const s=e.GetBackgroundColor();s.equalsIgnoringAlpha(fw)||(s.copyRgb(fw),this.UpdateRender())},SetLayerTransparent(e,t){e&&e.SetTransparent(t)},SetLayerBlendMode(e,t){e&&e.SetBlendMode(t)},SetLayerEffectEnabled(e,t,s){if(!e)return;const i=e.GetEffectList().GetEffectTypeByName(s);if(!i)return;const r=1===t;i.IsActive()!==r&&(i.SetActive(r),e.UpdateActiveEffects(),this._runtime.UpdateRender())},SetLayerEffectParam(e,t,s,i){if(!e)return;const r=e.GetEffectList(),n=r.GetEffectTypeByName(t);if(!n)return;s=Math.floor(s);const a=n.GetShaderProgram().GetParameterType(s);a&&("color"===a?(fw.setFromRgbValue(i),i=fw):"percent"===a&&(i/=100),r.SetEffectParameter(n.GetIndex(),s,i)&&n.IsActive()&&this._runtime.UpdateRender())},SetLayerForceOwnTexture(e,t){e&&e.SetForceOwnTexture(t)},SetLayoutScale(e){this._runtime.GetCurrentLayout().SetScale(+e)},SetLayoutAngle(e){this._runtime.GetCurrentLayout().SetAngle(dw.toRadians(+e))},SetLayoutEffectEnabled(e,t){const s=this._runtime.GetCurrentLayout(),i=s.GetEffectList().GetEffectTypeByName(t);if(!i)return;const r=1===e;i.IsActive()!==r&&(i.SetActive(r),s.UpdateActiveEffects(),this._runtime.UpdateRender())},SetLayoutEffectParam(e,t,s){const i=this._runtime.GetCurrentLayout().GetEffectList(),r=i.GetEffectTypeByName(e);if(!r)return;t=Math.floor(t);const n=r.GetShaderProgram().GetParameterType(t);n&&("color"===n?(fw.setFromRgbValue(s),s=fw):"percent"===n&&(s/=100),i.SetEffectParameter(r.GetIndex(),t,s)&&r.IsActive()&&this._runtime.UpdateRender())},SetLayoutVanishingPoint(e,t){this._runtime.GetCurrentLayout().SetVanishingPointXY(e/100,t/100)},SetLayoutProjection(e){const t=this._runtime.GetCurrentLayout();0===e?t.SetPerspectiveProjection():t.SetOrthographicProjection()},ScrollX(e){this._runtime.GetCurrentLayout().SetScrollX(e)},ScrollY(e){this._runtime.GetCurrentLayout().SetScrollY(e)},Scroll(e,t){const s=this._runtime.GetCurrentLayout();s.SetScrollX(e),s.SetScrollY(t)},ScrollToObject(e){if(!e)return;const t=e.GetFirstPicked();if(!t)return;const s=t.GetWorldInfo();if(!s)return;const i=this._runtime.GetCurrentLayout();i.SetScrollX(s.GetX()),i.SetScrollY(s.GetY())},AddLayer(e,t,s){const i=this._runtime.GetCurrentLayout();try{i.AddLayer(e,t,s)}catch(e){console.warn("[Construct] Cannot add layer: ",e)}},MoveLayer(e,t,s){if(!e)return;const i=this._runtime.GetCurrentLayout();try{i.MoveLayer(e,t,s)}catch(e){console.warn("[Construct] Cannot move layer: ",e)}},RemoveLayer(e){e&&this._runtime.GetCurrentLayout().RemoveLayer(e)},RemoveAllDynamicLayers(){this._runtime.GetCurrentLayout().RemoveAllDynamicLayers()},async LoadObjectTextures(e){const t=this._runtime.GetMainRunningLayout();if(!t||!e||this._runtime.IsLoading())return;const s=e.IsFamily()?e.GetFamilyMembers():[e];await this._LoadTexturesForObjectClasses(t,s)},async LoadObjectTexturesByName(e){await dw.Plugins.System.Acts.LoadObjectTextures.call(this,this._runtime.GetObjectClassByName(e))},UnloadObjectTextures(e){const t=this._runtime.GetMainRunningLayout();if(!t||!e)return;const s=e.IsFamily()?e.GetFamilyMembers():[e];this._UnloadTexturesForObjectClasses(t,s)},UnloadObjectTexturesByName(e){dw.Plugins.System.Acts.UnloadObjectTextures.call(this,this._runtime.GetObjectClassByName(e))},UnloadUnusedTextures(){const e=this._runtime.GetMainRunningLayout();if(!e)return;const t=e._GetTextureLoadedObjectTypes();this._UnloadTexturesForObjectClasses(e,t)},async LoadLayoutTextures(e){const t=this._runtime.GetMainRunningLayout();e&&t&&!this._runtime.IsLoading()&&await this._LoadTexturesForObjectClasses(t,e._GetInitialObjectClasses())},async LoadLayoutTexturesByName(e){const t=this._runtime.GetMainRunningLayout(),s=this._runtime.GetLayoutManager().GetLayoutByName(e);s&&t&&!this._runtime.IsLoading()&&await this._LoadTexturesForObjectClasses(t,s._GetInitialObjectClasses())},SetFunctionReturnValue(e){const t=this._eventStack.GetCurrentExpFuncStackFrame();if(t)switch(t.GetFunctionReturnType()){case 1:"number"==typeof e&&t.SetFunctionReturnValue(e);break;case 2:"string"==typeof e&&t.SetFunctionReturnValue(e);break;case 3:t.SetFunctionReturnValue(e)}},MapFunction(e,t,s){const i=this._GetFunctionMap(e.toLowerCase(),!0),r=i.strMap,n=t.toLowerCase();r.has(n)&&console.warn(`[Construct] Function map '${e}' string '${t}' already in map; overwriting entry`);const a=dw.first(r.values())||i.defaultFunc;a&&0!==a.GetReturnType()!=(0!==s.GetReturnType())?console.error(`[Construct] Function map '${e}' string '${t}' function return type not compatible with other functions in the map; entry ignored`):r.set(n,s)},MapFunctionDefault(e,t){const s=this._GetFunctionMap(e.toLowerCase(),!0);s.defaultFunc&&console.warn(`[Construct] Function map '${e}' already has a default; overwriting entry`);const i=dw.first(s.strMap.values())||s.defaultFunc;i&&0!==i.GetReturnType()!=(0!==t.GetReturnType())?console.error(`[Construct] Function map '${e}' default: function return type not compatible with other functions in the map; entry ignored`):s.defaultFunc=t},CallMappedFunction(e,t,s){const i=this._runtime,r=i.IsDebugging()?gw:null;s=Math.floor(s);const n=this._GetFunctionMap(e.toLowerCase(),!1);if(!n)return console.warn(`[Construct] Call mapped function: map name '${e}' not found; call ignored`),r;let a=n.strMap.get(t.toLowerCase());if(!a){if(!n.defaultFunc)return console.warn(`[Construct] Call mapped function: no function associated with map '${e}' string '${t}'; call ignored (consider setting a default)`),r;a=n.defaultFunc,s=0}if(!a.IsEnabled())return r;if(0!==a.GetReturnType())return console.warn(`[Construct] Call mapped function: map '${e}' string '${t}' has a return type so cannot be called`),r;const o=i.GetEventSheetManager(),l=o.GetCurrentEvent(),h=l.GetSolModifiersIncludingParents(),u=h.length>0;u&&(a.IsCopyPicked()?o.PushCopySol(h):o.PushCleanSol(h));const c=[],d=o.FindFirstFunctionBlockParent(l);if(d){const e=d.GetFunctionParameters();for(let t=s,i=e.length;t<i;++t)c.push(e[t].GetValue())}const p=a.GetFunctionParameters();for(let e=c.length,t=p.length;e<t;++e)c.push(p[e].GetInitialValue());return i.IsDebugging()?this._DebugDoCallMappedFunction(o,a,c,u,h):this._DoCallMappedFunction(o,a,c,u,h)}}}{const yw=self.C3;yw.Plugins.System.Exps={int:function(e){return"string"==typeof e&&(e=parseInt(e,10),isNaN(e)&&(e=0)),Math.floor(e)},float:function(e){return"string"==typeof e&&(e=parseFloat(e),isNaN(e)&&(e=0)),e},str:e=>e.toString(),len:e=>"string"==typeof e?e.length:0,random(e,t){return void 0===t?this._runtime.Random()*e:this._runtime.Random()*(t-e)+e},choose(...e){return e[Math.floor(this._runtime.Random()*e.length)]},chooseindex:(e,...t)=>("number"!=typeof e&&(e=0),t[e=yw.clamp(Math.floor(e),0,t.length-1)]),pi:()=>Math.PI,infinity:()=>1/0,sqrt:e=>Math.sqrt(e),abs:e=>Math.abs(e),round:e=>Math.round(e),roundtodp(e,t){t=Math.max(Math.floor(t),0);const s=Math.pow(10,t);return Math.round((e+Number.EPSILON)*s)/s},floor:e=>Math.floor(e),ceil:e=>Math.ceil(e),sign:e=>Math.sign(e),sin:e=>Math.sin(yw.toRadians(e)),cos:e=>Math.cos(yw.toRadians(e)),tan:e=>Math.tan(yw.toRadians(e)),asin:e=>yw.toDegrees(Math.asin(e)),acos:e=>yw.toDegrees(Math.acos(e)),atan:e=>yw.toDegrees(Math.atan(e)),exp:e=>Math.exp(e),ln:e=>Math.log(e),log10:e=>Math.log10(e),max(...e){let t=e[0];"number"!=typeof t&&(t=0);for(let s=1,i=e.length;s<i;++s){let i=e[s];"number"==typeof i&&t<i&&(t=i)}return t},min(...e){let t=e[0];"number"!=typeof t&&(t=0);for(let s=1,i=e.length;s<i;++s){let i=e[s];"number"==typeof i&&t>i&&(t=i)}return t},clamp:(e,t,s)=>yw.clamp(e,t,s),distance:(e,t,s,i)=>yw.distanceTo(e,t,s,i),angle:(e,t,s,i)=>yw.toDegrees(yw.angleTo(e,t,s,i)),lerp:(e,t,s)=>yw.lerp(e,t,s),unlerp:(e,t,s)=>yw.unlerp(e,t,s),qarp:(e,t,s,i)=>yw.qarp(e,t,s,i),cubic:(e,t,s,i,r)=>yw.cubic(e,t,s,i,r),cosp:(e,t,s)=>yw.cosp(e,t,s),anglediff:(e,t)=>yw.toDegrees(yw.angleDiff(yw.toRadians(e),yw.toRadians(t))),anglelerp:(e,t,s)=>yw.toDegrees(yw.angleLerp(yw.toRadians(e),yw.toRadians(t),s)),anglerotate:(e,t,s)=>yw.toDegrees(yw.angleRotate(yw.toRadians(e),yw.toRadians(t),yw.toRadians(s))),setbit:(e,t,s)=>(e|=0)&~(1<<(t|=0))|(s=0!==s?1:0)<<t,togglebit:(e,t)=>(e|=0)^1<<t,getbit:(e,t)=>(e|=0)&1<<(t|=0)?1:0,newline:()=>"\n",uppercase:e=>"string"==typeof e?e.toUpperCase():"",lowercase:e=>"string"==typeof e?e.toLowerCase():"",left:(e,t)=>"string"==typeof e?e.substr(0,t):"",mid:(e,t,s)=>"string"!=typeof e?"":s<0?e.substr(t):e.substr(t,s),right:(e,t)=>"string"==typeof e?e.substr(Math.max(e.length-t,0)):"",trim:e=>"string"==typeof e?e.trim():"",tokenat(e,t,s){if("string"!=typeof e||"string"!=typeof s)return"";let i=e.split(s);return(t=Math.floor(t))<0||t>=i.length?"":i[t]},tokencount:(e,t)=>"string"==typeof e&&"string"==typeof t&&e.length?e.split(t).length:0,find:(e,t)=>"string"==typeof e&&"string"==typeof t?e.search(new RegExp(yw.EscapeRegex(t),"i")):-1,findcase:(e,t)=>"string"==typeof e&&"string"==typeof t?e.search(new RegExp(yw.EscapeRegex(t),"")):-1,replace:(e,t,s)=>"string"==typeof e&&"string"==typeof t&&"string"==typeof s?e.replace(new RegExp(yw.EscapeRegex(t),"gi"),s):"string"==typeof e?e:"",stringsub(e,...t){let s=e;for(let e=0,i=t.length;e<i;++e)s=s.replaceAll(`{${e}}`,t[e].toString());return s},regexsearch(e,t,s){const i=this.GetRegex(t,s);return e?e.search(i):-1},regexreplace(e,t,s,i){const r=this.GetRegex(t,s);return e?e.replace(r,i):""},regexmatchcount(e,t,s){const i=this.GetRegexMatches(e.toString(),t,s);return i?i.length:0},regexmatchat(e,t,s,i){i=Math.floor(i);const r=this.GetRegexMatches(e.toString(),t,s);return!r||i<0||i>=r.length?"":r[i]},zeropad(e,t){let s=e<0?"-":"";e<0&&(e=-e);const i=t-e.toString().length;return s+="0".repeat(Math.max(i,0)),s+e.toString()},urlencode:e=>encodeURIComponent(e),urldecode:e=>decodeURIComponent(e),dt(){return this._runtime._GetDtFast()},wallclockdt(){return this._runtime.GetDt1()},timescale(){return this._runtime.GetTimeScale()},wallclocktime(){return(Date.now()-this._runtime.GetStartTime())/1e3},unixtime:()=>Date.now(),time(){return this._runtime.GetGameTime()},tickcount(){return this._runtime.GetTickCount()},objectcount(){return this._runtime.GetObjectCount()},fps(){return this._runtime.GetFramesPerSecond()},cpuutilisation(){return this._runtime.GetMainThreadTime()},gpuutilisation(){return this._runtime.GetGPUUtilisation()},windowwidth(){return this._runtime.GetCanvasManager().GetDeviceWidth()},windowheight(){return this._runtime.GetCanvasManager().GetDeviceHeight()},originalwindowwidth(){return this._runtime.GetOriginalViewportWidth()},originalwindowheight(){return this._runtime.GetOriginalViewportHeight()},originalviewportwidth(){return this._runtime.GetOriginalViewportWidth()},originalviewportheight(){return this._runtime.GetOriginalViewportHeight()},scrollx(){return this._runtime.GetCurrentLayout().GetScrollX()},scrolly(){return this._runtime.GetCurrentLayout().GetScrollY()},layoutname(){return this._runtime.GetCurrentLayout().GetName()},layoutscale(){return this._runtime.GetCurrentLayout().GetScale()},layoutangle(){return yw.toDegrees(this._runtime.GetCurrentLayout().GetAngle())},layoutwidth(){return this._runtime.GetCurrentLayout().GetWidth()},layoutheight(){return this._runtime.GetCurrentLayout().GetHeight()},vanishingpointx(){return 100*this._runtime.GetCurrentLayout().GetVanishingPointX()},vanishingpointy(){return 100*this._runtime.GetCurrentLayout().GetVanishingPointY()},viewportleft(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetViewport3D().getLeft():0},viewporttop(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetViewport3D().getTop():0},viewportright(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetViewport3D().getRight():0},viewportbottom(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetViewport3D().getBottom():0},viewportwidth(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetViewport3D().width():0},viewportheight(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetViewport3D().height():0},viewportmidx(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);if(t){const e=t.GetViewport3D();return(e.getLeft()+e.getRight())/2}return 0},viewportmidy(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);if(t){const e=t.GetViewport3D();return(e.getTop()+e.getBottom())/2}return 0},canvastolayerx(e,t,s){const i=this._runtime.GetCurrentLayout().GetLayer(e);return i?i.CanvasCssToLayer(t,s)[0]:0},canvastolayery(e,t,s){const i=this._runtime.GetCurrentLayout().GetLayer(e);return i?i.CanvasCssToLayer(t,s)[1]:0},layertocanvasx(e,t,s){const i=this._runtime.GetCurrentLayout().GetLayer(e);return i?i.LayerToCanvasCss(t,s)[0]:0},layertocanvasy(e,t,s){const i=this._runtime.GetCurrentLayout().GetLayer(e);return i?i.LayerToCanvasCss(t,s)[1]:0},layertolayerx(e,t,s,i){const r=this._runtime.GetCurrentLayout(),n=r.GetLayer(e),a=r.GetLayer(t);if(!n||!a||n===a)return s;const[o,l]=n.LayerToCanvasCss(s,i);return a.CanvasCssToLayer(o,l)[0]},layertolayery(e,t,s,i){const r=this._runtime.GetCurrentLayout(),n=r.GetLayer(e),a=r.GetLayer(t);if(!n||!a||n===a)return i;const[o,l]=n.LayerToCanvasCss(s,i);return a.CanvasCssToLayer(o,l)[1]},layerscale(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetOwnScale():0},layerangle(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?yw.toDegrees(t.GetOwnAngle()):0},layeropacity(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?100*t.GetOpacity():0},layerscalerate(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetScaleRate():0},layerscrollx(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetScrollX():0},layerscrolly(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetScrollY():0},layerparallaxx(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?100*t.GetParallaxX():0},layerparallaxy(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?100*t.GetParallaxY():0},layerzelevation(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetZElevation():0},layerindex(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetIndex():-1},canvassnapshot(){const e=this._runtime.GetCanvasManager();return e?e.GetCanvasSnapshotUrl():""},loopindex(e){const t=this._loopStack;if(!t.IsInLoop())return 0;if(e){const s=t.FindByName(e);return s?s.GetIndex():0}return t.GetCurrent().GetIndex()},savestatejson(){return this._runtime.GetLastSaveJsonString()},callmapped(e,t,...s){const i=this._GetFunctionMap(e.toLowerCase(),!1);if(!i)return console.warn(`[Construct] Call mapped function: map name '${e}' not found; returning 0`),0;let r=i.strMap.get(t.toLowerCase());if(!r){if(!i.defaultFunc)return console.warn(`[Construct] Call mapped function: no function associated with map '${e}' string '${t}'; returning 0 (consider setting a default)`),0;r=i.defaultFunc}const n=r.GetReturnType(),a=r.GetDefaultReturnValue();if(0===n)return console.warn(`[Construct] Call mapped function: map '${e}' string '${t}' has no return type so cannot be called from an expression; returning 0`),0;if(!r.IsEnabled())return a;const o=this._runtime.GetEventSheetManager(),l=o.GetCurrentEvent().GetSolModifiersIncludingParents(),h=l.length>0;h&&(r.IsCopyPicked()?o.PushCopySol(l):o.PushCleanSol(l));const u=r.GetFunctionParameters();for(let e=s.length,t=u.length;e<t;++e)s.push(u[e].GetInitialValue());const c=r.GetEventBlock(),d=c.RunAsExpressionFunctionCall(c.GetSolModifiersIncludingParents(),r.IsCopyPicked(),n,a,...s);return h&&o.PopSol(l),d},loadingprogress(){return this._runtime.GetAssetManager().GetLoadProgress()},imageloadingprogress(){return this.GetImageLoadingProgress()},renderer(){return this._runtime.GetWebGPURenderer()?"webgpu":"webgl"},rendererdetail(){return this._runtime.GetWebGPURenderer()?this._runtime.GetWebGPURenderer().GetAdapterInfoString():this._runtime.GetWebGLRenderer().GetUnmaskedRenderer()},imagememoryusage(){let e=this._runtime.GetRenderer().GetEstimatedTextureMemoryUsage();return Math.round(100*e/1048576)/100},rgb:(e,t,s)=>yw.PackRGB(e,t,s),rgbex:(e,t,s)=>yw.PackRGBEx(e/100,t/100,s/100),rgba:(e,t,s,i)=>yw.PackRGBAEx(e/100,t/100,s/100,i/100),rgbex255:(e,t,s)=>yw.PackRGBEx(e/255,t/255,s/255),rgba255:(e,t,s,i)=>yw.PackRGBAEx(e/255,t/255,s/255,i/255),projectname(){return this._runtime.GetProjectName()},projectversion(){return this._runtime.GetProjectVersion()},projectid(){return this._runtime.GetAppId()},projectuniqueid(){return this._runtime.GetProjectUniqueId()},currenteventsheetname(){return this._runtime.GetCurrentEvent().GetEventSheet().GetName()},currenteventnumber(){return this._runtime.GetCurrentEvent().GetDisplayNumber()}}}{const Sw=self.C3;Sw.Plugins.AJAX=class extends Sw.SDKPluginBase{constructor(e){super(e)}Release(){super.Release()}}}{const Tw=self.C3;Tw.Plugins.AJAX.Type=class extends Tw.SDKTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const xw=self.C3;xw.Plugins.AJAX.Instance=class extends xw.SDKInstanceBase{constructor(e,t){if(super(e),this._lastData="",this._lastStatusCode=0,this._curTag="",this._progress=0,this._timeout=-1,this._nextRequestHeaders=new Map,this._nextReponseBinaryData=null,this._nextRequestOverrideMimeType="",this._nextRequestWithCredentials=!1,this._nwjsFs=null,this._nwjsPath=null,this._nwjsAppFolder=null,this._isNWjs=this._runtime.IsNWjs(),this._isNWjs){this._nwjsFs=__require("fs"),this._nwjsPath=__require("path");const e=self.process||nw.process;this._nwjsAppFolder=this._nwjsPath.dirname(e.execPath)+"\\"}}Release(){super.Release()}async _TriggerError(e,t,s){console.error(`[Construct] AJAX request to '${t}' (tag '${e}') failed: `,s),this._curTag=e,await this.TriggerAsync(xw.Plugins.AJAX.Cnds.OnAnyError),this._curTag=e,await this.TriggerAsync(xw.Plugins.AJAX.Cnds.OnError)}async _TriggerComplete(e){this._curTag=e,await this.TriggerAsync(xw.Plugins.AJAX.Cnds.OnAnyComplete),this._curTag=e,await this.TriggerAsync(xw.Plugins.AJAX.Cnds.OnComplete)}async _OnProgress(e,t){t.lengthComputable&&(this._progress=t.loaded/t.total,this._curTag=e,await this.TriggerAsync(xw.Plugins.AJAX.Cnds.OnProgress))}async _OnUploadProgress(e,t){t.lengthComputable&&(this._progress=t.loaded/t.total,this._curTag=e,await this.TriggerAsync(xw.Plugins.AJAX.Cnds.OnUploadProgress))}_OnError(e,t,s){if(!this._isNWjs)return void this._TriggerError(e,t,s);const i=this._nwjsFs,r=this._nwjsAppFolder+t;i.existsSync(r)?i.readFile(r,{encoding:"utf8"},(s,i)=>{s?this._TriggerError(e,t,s):(this._lastData=i.replace(/\r\n/g,"\n"),this._TriggerComplete(e))}):this._TriggerError(e,t,s)}async _DoCordovaRequest(e,t){const s=this._runtime.GetAssetManager(),i=this._nextReponseBinaryData;this._nextReponseBinaryData=null;try{if(i){const r=await s.CordovaFetchLocalFileAsArrayBuffer(t);i.SetArrayBufferTransfer(r),this._lastData="",this._lastStatusCode=0,this._TriggerComplete(e)}else{const i=await s.CordovaFetchLocalFileAsText(t);this._lastData=i.replace(/\r\n/g,"\n"),this._lastStatusCode=0,this._TriggerComplete(e)}}catch(s){this._TriggerError(e,t,s)}}_DoRequest(e,t,s,i){return new Promise(r=>{const n=s=>{this._OnError(e,t,s),r()},a=this._nextReponseBinaryData;this._nextReponseBinaryData=null;try{const o=new XMLHttpRequest;o.onreadystatechange=()=>{if(4===o.readyState){if(this._lastData=a?"":(o.responseText||"").replace(/\r\n/g,"\n"),this._lastStatusCode=o.status,o.status>=400)this._TriggerError(e,t,o.status+o.statusText);else{const t=this._lastData.length||a&&o.response instanceof ArrayBuffer;this._isNWjs&&!t||!this._isNWjs&&0===o.status&&!t||(a&&a.SetArrayBufferTransfer(o.response),this._TriggerComplete(e))}r()}},o.onerror=n,o.ontimeout=n,o.onabort=n,o.onprogress=t=>this._OnProgress(e,t),o.upload.onprogress=t=>this._OnUploadProgress(e,t),o.open(s,t),this._timeout>=0&&void 0!==o.timeout&&(o.timeout=this._timeout),o.responseType=a?"arraybuffer":"text",i&&!this._nextRequestHeaders.has("Content-Type")&&("string"!=typeof i?o.setRequestHeader("Content-Type","application/octet-stream"):o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"));for(const[e,t]of this._nextRequestHeaders)try{o.setRequestHeader(e,t)}catch(s){console.error(`[Construct] AJAX: Failed to set header '${e}: ${t}': `,s)}if(this._nextRequestHeaders.clear(),this._nextRequestOverrideMimeType){try{o.overrideMimeType(this._nextRequestOverrideMimeType)}catch(e){console.error("[Construct] AJAX: failed to override MIME type: ",e)}this._nextRequestOverrideMimeType=""}this._nextRequestWithCredentials&&(o.withCredentials=!0,this._nextRequestWithCredentials=!1),i?o.send(i):o.send()}catch(e){n(e)}})}GetDebuggerProperties(){const e="plugins.ajax.debugger";return[{title:e+".title",properties:[{name:e+".last-status-code",value:this._lastStatusCode},{name:e+".last-data",value:this._lastData}]}]}SaveToJson(){return{lastData:this._lastData,lastStatusCode:this._lastStatusCode}}LoadFromJson(e){this._lastData=e.lastData,this._lastStatusCode=e.hasOwnProperty("lastStatusCode")?e.lastStatusCode:0,this._curTag="",this._progress=0}}}{const bw=self.C3;bw.Plugins.AJAX.Cnds={OnComplete(e){return bw.equalsNoCase(this._curTag,e)},OnAnyComplete:()=>!0,OnError(e){return bw.equalsNoCase(this._curTag,e)},OnAnyError:()=>!0,OnProgress(e){return bw.equalsNoCase(this._curTag,e)},OnUploadProgress(e){return bw.equalsNoCase(this._curTag,e)}}}{const Gw=self.C3;Gw.Plugins.AJAX.Acts={async Request(e,t){this._runtime.IsCordova()&&Gw.IsRelativeURL(t)&&this._runtime.GetAssetManager().IsFileProtocol()?await this._DoCordovaRequest(e,t):await this._DoRequest(e,t,"GET",null)},async RequestFile(e,t){this._runtime.IsCordova()&&this._runtime.GetAssetManager().IsFileProtocol()?await this._DoCordovaRequest(e,t):await this._DoRequest(e,t,"GET",null)},async Post(e,t,s,i){await this._DoRequest(e,t,i,s)},async PostBinary(e,t,s,i){if(!s)return;const r=s.GetFirstPicked(this._inst);if(!r)return;const n=r.GetSdkInstance().GetArrayBufferReadOnly();await this._DoRequest(e,t,i,n)},SetTimeout(e){this._timeout=1e3*e},SetHeader(e,t){this._nextRequestHeaders.set(e,t)},SetResponseBinary(e){if(!e)return;const t=e.GetFirstPicked(this._inst);t&&(this._nextReponseBinaryData=t.GetSdkInstance())},OverrideMIMEType(e){this._nextRequestOverrideMimeType=e},SetWithCredentials(e){this._nextRequestWithCredentials=!!e}}}self.C3.Plugins.AJAX.Exps={LastData(){return this._lastData},LastStatusCode(){return this._lastStatusCode},Progress(){return this._progress},Tag(){return this._curTag}};{const Iw=self.C3;Iw.Plugins.Arr=class extends Iw.SDKPluginBase{constructor(e){super(e)}Release(){super.Release()}}}{const vw=self.C3;vw.Plugins.Arr.Type=class extends vw.SDKTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{let Cw=function(e,t,s){if(t<e.length)ww.truncateArray(e,t);else if(t>e.length)if("function"==typeof s)for(let i=e.length;i<t;++i)e.push(s());else for(let i=e.length;i<t;++i)e.push(s)};ResizeArray=Cw;const ww=self.C3,Aw=self.C3X,Rw=self.IInstance;ww.Plugins.Arr.Instance=class extends ww.SDKInstanceBase{constructor(e,t){super(e),this._cx=10,this._cy=1,this._cz=1,this._arr=null,this._forX=[],this._forY=[],this._forZ=[],this._forDepth=-1,t&&(this._cx=t[0],this._cy=t[1],this._cz=t[2]),this._arr=ww.MakeFilledArray(this._cx,()=>ww.MakeFilledArray(this._cy,()=>ww.MakeFilledArray(this._cz,0)))}Release(){this._arr=null,super.Release()}At(e,t,s){return e=Math.floor(e),t=Math.floor(t),s=Math.floor(s),e>=0&&e<this._cx&&t>=0&&t<this._cy&&s>=0&&s<this._cz?this._arr[e][t][s]:0}Set(e,t,s,i){e=Math.floor(e),t=Math.floor(t),s=Math.floor(s),e>=0&&e<this._cx&&t>=0&&t<this._cy&&s>=0&&s<this._cz&&(this._arr[e][t][s]=i)}SetSize(e,t,s){if(e=Math.floor(e),t=Math.floor(t),s=Math.floor(s),e<0&&(e=0),t<0&&(t=0),s<0&&(s=0),this._cx===e&&this._cy===t&&this._cz===s)return;this._cx=e,this._cy=t,this._cz=s;const i=this._arr;Cw(i,e,()=>ww.MakeFilledArray(t,()=>ww.MakeFilledArray(s,0)));for(let r=0;r<e;++r){Cw(i[r],t,()=>ww.MakeFilledArray(s,0));for(let e=0;e<t;++e)Cw(i[r][e],s,0)}}GetWidth(){return this._cx}GetHeight(){return this._cy}GetDepth(){return this._cz}_ShuffleHelper(e,t,s,i,r){for(;t>0;){const n=Math.floor(this._runtime.Random()*t);if(--t,0===e){const e=this.At(t,i,r),s=this.At(n,i,r);this.Set(t,i,r,s),this.Set(n,i,r,e)}else if(1===e){const e=this.At(s,t,r),i=this.At(s,n,r);this.Set(s,t,r,i),this.Set(s,n,r,e)}else if(2===e){const e=this.At(s,i,t),r=this.At(s,i,n);this.Set(s,i,t,r),this.Set(s,i,n,e)}}}GetDebuggerProperties(){const e="plugins.arr.debugger",t="plugins.arr.properties",s=[{title:e+".array-properties.title",properties:[{name:t+".width.name",value:this._cx,onedit:e=>this.SetSize(e,this._cy,this._cz)},{name:t+".height.name",value:this._cy,onedit:e=>this.SetSize(this._cx,e,this._cz)},{name:t+".depth.name",value:this._cz,onedit:e=>this.SetSize(this._cx,this._cy,e)},{name:t+".elements.name",value:this._cx*this._cy*this._cz}]}],i=[];if(1===this._cy&&1===this._cz)for(let e=0;e<this._cx;++e)i.push({name:"$"+e,value:this._arr[e][0][0],onedit:t=>this._arr[e][0][0]=t});else for(let e=0;e<this._cx;++e)i.push({name:"$"+e,value:this._arr[e].toString()});return i.length&&s.push({title:e+".array-data.title",properties:i}),s}GetAsJsonString(){return JSON.stringify({c2array:!0,size:[this._cx,this._cy,this._cz],data:this._arr})}SaveToJson(){return{size:[this._cx,this._cy,this._cz],data:this._arr}}LoadFromJson(e){const t=e.size;this._cx=t[0],this._cy=t[1],this._cz=t[2],this._arr=e.data}_GetForX(){return this._forDepth>=0&&this._forDepth<this._forX.length?this._forX[this._forDepth]:0}_GetForY(){return this._forDepth>=0&&this._forDepth<this._forY.length?this._forY[this._forDepth]:0}_GetForZ(){return this._forDepth>=0&&this._forDepth<this._forZ.length?this._forZ[this._forDepth]:0}GetScriptInterfaceClass(){return self.IArrayInstance}};const Pw=new WeakMap;self.IArrayInstance=class extends Rw{constructor(){super(),Pw.set(this,Rw._GetInitInst().GetSdkInstance())}get width(){return Pw.get(this).GetWidth()}get height(){return Pw.get(this).GetHeight()}get depth(){return Pw.get(this).GetDepth()}setSize(e,t=1,s=1){Aw.RequireFiniteNumber(e),Aw.RequireFiniteNumber(t),Aw.RequireFiniteNumber(s),Pw.get(this).SetSize(e,t,s)}getAt(e,t=0,s=0){return Aw.RequireFiniteNumber(e),Aw.RequireFiniteNumber(t),Aw.RequireFiniteNumber(s),Pw.get(this).At(e,t,s)}setAt(e,t,s=0,i=0){if(Aw.RequireFiniteNumber(t),Aw.RequireFiniteNumber(s),Aw.RequireFiniteNumber(i),"number"!=typeof e&&"string"!=typeof e)throw new TypeError("invalid type");Pw.get(this).Set(t,s,i,e)}}}{let Mw=function(e,t,s,i,r,n){e.PushCopySol(s),n.GetObjectClass().GetCurrentSol().PickOne(n.GetInstance()),t.Retrigger(i,r),e.PopSol(s)};DoForEachTrigger=Mw;const Ew=self.C3;Ew.Plugins.Arr.Cnds={CompareX(e,t,s){return Ew.compare(this.At(e,0,0),t,s)},CompareXY(e,t,s,i){return Ew.compare(this.At(e,t,0),s,i)},CompareXYZ(e,t,s,i,r){return Ew.compare(this.At(e,t,s),i,r)},ArrForEach(e){const t=this._runtime,s=t.GetEventSheetManager(),i=t.GetCurrentEvent(),r=i.GetSolModifiers(),n=t.GetEventStack(),a=n.GetCurrentStackFrame(),o=n.Push(i),l=++this._forDepth,h=this._forX,u=this._forY,c=this._forZ,d=this._cx,p=this._cy,_=this._cz;if(l===this._forX.length?(h.push(0),u.push(0),c.push(0)):(h[l]=0,u[l]=0,c[l]=0),t.SetDebuggingEnabled(!1),0===e)for(let e=0;e<d;++e)for(let t=0;t<p;++t)for(let n=0;n<_;++n)h[l]=e,u[l]=t,c[l]=n,Mw(s,i,r,a,o,this);else if(1===e)for(let e=0;e<d;++e)for(let t=0;t<p;++t)h[l]=e,u[l]=t,Mw(s,i,r,a,o,this);else for(let e=0;e<d;++e)h[l]=e,Mw(s,i,r,a,o,this);return t.SetDebuggingEnabled(!0),this._forDepth--,n.Pop(),!1},CompareCurrent(e,t){return Ew.compare(this.At(this._GetForX(),this._GetForY(),this._GetForZ()),e,t)},Contains(e){const t=this._cx,s=this._cy,i=this._cz,r=this._arr;for(let n=0;n<t;++n)for(let t=0;t<s;++t)for(let s=0;s<i;++s)if(r[n][t][s]===e)return!0;return!1},IsEmpty(){return 0===this._cx||0===this._cy||0===this._cz},CompareSize(e,t,s){let i=0;switch(e){case 0:i=this._cx;break;case 1:i=this._cy;break;case 2:i=this._cz}return Ew.compare(i,t,s)}}}{let Dw=function(e,t){if("number"==typeof e&&"number"==typeof t)return e-t;{const s=e.toString(),i=t.toString();return s<i?-1:s>i?1:0}};CompareValues=Dw;const Nw=self.C3;Nw.Plugins.Arr.Acts={Clear(e){const t=this._cx,s=this._cy,i=this._cz,r=this._arr;for(let n=0;n<t;++n)for(let t=0;t<s;++t)for(let s=0;s<i;++s)r[n][t][s]=e},SetSize(e,t,s){this.SetSize(e,t,s)},SetX(e,t){this.Set(e,0,0,t)},SetXY(e,t,s){this.Set(e,t,0,s)},SetXYZ(e,t,s,i){this.Set(e,t,s,i)},Push(e,t,s){const i=this._cx,r=this._cy,n=this._cz,a=this._arr;if(0===s){const s=Nw.MakeFilledArray(r,()=>Nw.MakeFilledArray(n,t));0===e?a.push(s):a.unshift(s),this._cx++}else if(1===s){for(let s=0;s<i;++s){const i=Nw.MakeFilledArray(n,t);0===e?a[s].push(i):a[s].unshift(i)}this._cy++}else{for(let s=0;s<i;++s)for(let i=0;i<r;++i)0===e?a[s][i].push(t):a[s][i].unshift(t);this._cz++}},Pop(e,t){const s=this._cx,i=this._cy,r=this._cz,n=this._arr;if(0===t){if(0===s)return;0===e?n.pop():n.shift(),this._cx--}else if(1===t){if(0===i)return;for(let t=0;t<s;++t)0===e?n[t].pop():n[t].shift();this._cy--}else{if(0===r)return;for(let t=0;t<s;++t)for(let s=0;s<i;++s)0===e?n[t][s].pop():n[t][s].shift();this._cz--}},Reverse(e){const t=this._cx,s=this._cy,i=this._cz,r=this._arr;if(0!==t&&0!==s&&0!==i)if(0===e)r.reverse();else if(1===e)for(let e=0;e<t;++e)r[e].reverse();else for(let e=0;e<t;++e)for(let t=0;t<s;++t)r[e][t].reverse()},Sort(e){const t=this._cx,s=this._cy,i=this._cz,r=this._arr;if(0!==t&&0!==s&&0!==i)if(0===e)r.sort((e,t)=>Dw(e[0][0],t[0][0]));else if(1===e)for(let e=0;e<t;++e)r[e].sort((e,t)=>Dw(e[0],t[0]));else for(let e=0;e<t;++e)for(let t=0;t<s;++t)r[e][t].sort(Dw)},Sort2(e){const t=this._cx,s=this._cy,i=this._cz,r=this._arr;if(0!==t&&0!==s&&0!==i)if(0===e)r.sort((e,t)=>{for(let i=0;i<s;++i){const s=Dw(e[i][0],t[i][0]);if(0!==s)return s}return 0});else if(1===e)for(let e=0;e<s;++e){const s=[];for(let i=0;i<t;++i)s.push(r[i][e]);s.sort((e,t)=>Dw(e[0],t[0]));for(let i=0;i<t;++i)r[i][e]=s[i]}else if(2===e){const e=[];for(let t=0;t<s;++t)e.push(t);e.sort((e,s)=>{for(let i=0;i<t;++i){const t=Dw(r[i][e],r[i][s]);if(0!==t)return t}return 0});for(let s=0;s<t;++s){let t=[];for(const i of e)t.push(r[s][i]);r[s]=t}}else if(3===e)for(let e=0;e<t;++e)r[e].sort((e,t)=>Dw(e[0],t[0]));else for(let e=0;e<t;++e)for(let t=0;t<s;++t)r[e][t].sort(Dw)},Shuffle(e){const t=this._cx,s=this._cy,i=this._cz;if(0!==t&&0!==s&&0!==i)if(0===e)for(let r=0;r<s;++r)for(let s=0;s<i;++s)this._ShuffleHelper(e,t,0,r,s);else if(1===e)for(let r=0;r<t;++r)for(let t=0;t<i;++t)this._ShuffleHelper(e,s,r,0,t);else for(let r=0;r<t;++r)for(let t=0;t<s;++t)this._ShuffleHelper(e,i,r,t,0)},Delete(e,t){if((e=Math.floor(e))<0)return;const s=this._cx,i=this._cy,r=this._cz,n=this._arr;if(0===t){if(e>=s)return;n.splice(e,1),this._cx--}else if(1===t){if(e>=i)return;for(let t=0;t<s;++t)n[t].splice(e,1);this._cy--}else{if(e>=r)return;for(let t=0;t<s;++t)for(let s=0;s<i;++s)n[t][s].splice(e,1);this._cz--}},Insert(e,t,s){if((t=Math.floor(t))<0)return;const i=this._cx,r=this._cy,n=this._cz,a=this._arr;if(0===s){if(t>i)return;a.splice(t,0,Nw.MakeFilledArray(r,()=>Nw.MakeFilledArray(n,e))),this._cx++}else if(1===s){if(t>r)return;for(let s=0;s<i;++s)a[s].splice(t,0,Nw.MakeFilledArray(n,e));this._cy++}else{if(t>n)return;for(let s=0;s<i;++s)for(let i=0;i<r;++i)a[s][i].splice(t,0,e);this._cz++}},SplitString(e,t,s){const i=e.split(t);this.SetSize(i.length,1,1);for(let e=0,t=i.length;e<t;++e){let t=i[e];0===s?String(Number(t))===t&&(t=Number(t)):2===s&&(t=Number(t)),this.Set(e,0,0,t)}},JSONLoad(e){let t=null;try{t=JSON.parse(e)}catch(e){return void console.error("[Construct] Failed to parse JSON: ",e)}if(!t.c2array)return void console.warn("[Array] Attempted to load JSON that does not appear to be Construct array data - no data loaded");const s=t.size;this._cx=s[0],this._cy=s[1],this._cz=s[2],this._arr=t.data},JSONDownload(e){const t=URL.createObjectURL(new Blob([this.GetAsJsonString()],{type:"application/json"}));this._runtime.InvokeDownload(t,e)}}}self.C3.Plugins.Arr.Exps={At(e,t,s){return this.At(e,t||0,s||0)},Width(){return this._cx},Height(){return this._cy},Depth(){return this._cz},CurX(){return this._GetForX()},CurY(){return this._GetForY()},CurZ(){return this._GetForZ()},CurValue(){return this.At(this._GetForX(),this._GetForY(),this._GetForZ())},Front(){return this.At(0,0,0)},Back(){return this.At(this._cx-1,0,0)},IndexOf(e){const t=this._arr;for(let s=0,i=this._cx;s<i;++s)if(t[s][0][0]===e)return s;return-1},LastIndexOf(e){const t=this._arr;for(let s=this._cx-1;s>=0;--s)if(t[s][0][0]===e)return s;return-1},JoinString(e){let t=[];for(let e=0;e<this._cx;++e)t.push(this.At(e,0,0));return t.join(e)},AsJSON(){return this.GetAsJsonString()}};{const Fw=self.C3;Fw.Plugins.Keyboard=class extends Fw.SDKPluginBase{constructor(e){super(e)}Release(){super.Release()}}}{let Ow=function(){return Lw.GetSingleGlobalInstance().GetSdkInstance()};GetKeyboardSdkInstance=Ow;const Bw=self.C3;self.C3X,Bw.Plugins.Keyboard.Type=class extends Bw.SDKTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}GetScriptInterfaceClass(){return self.IKeyboardObjectType}};let Lw=null;self.IKeyboardObjectType=class extends self.IObjectType{constructor(e){super(e),Lw=e,e.GetRuntime()._GetCommonScriptInterfaces().keyboard=this}isKeyDown(e){const t=Ow();if("string"==typeof e)return t.IsKeyDown(e);if("number"==typeof e)return t.IsKeyCodeDown(e);throw new TypeError("expected string or number")}}}{const kw=self.C3,Vw="keyboard";kw.Plugins.Keyboard.Instance=class extends kw.SDKInstanceBase{constructor(e,t){super(e,Vw),this._keysDownByString=new Set,this._keysDownByWhich=new Set,this._triggerWhich=0,this._triggerString="",this._triggerTypedKey="",this._isKeyboardLockSupported=!1;const s=this.GetRuntime().Dispatcher();this._disposables=new kw.CompositeDisposable(kw.Disposable.From(s,"keydown",e=>this._OnKeyDown(e.data)),kw.Disposable.From(s,"keyup",e=>this._OnKeyUp(e.data)),kw.Disposable.From(s,"window-blur",()=>this._OnWindowOrKeyboardBlur()),kw.Disposable.From(s,"keyboard-blur",()=>this._OnWindowOrKeyboardBlur())),this._runtime.AddLoadPromise(this._Init())}Release(){super.Release()}async _Init(){const e=await this.PostToDOMAsync("init");this._isKeyboardLockSupported=e.isKeyboardLockSupported}_OnKeyDown(e){const t=e.which,s=e.code||t.toString(),i=e.key;this._keysDownByString.has(s)||(this._keysDownByString.add(s),this._keysDownByWhich.add(t),this._triggerString=s,this._triggerWhich=t,this._triggerTypedKey=i,this.Trigger(kw.Plugins.Keyboard.Cnds.OnAnyKey),this.Trigger(kw.Plugins.Keyboard.Cnds.OnKey),this.Trigger(kw.Plugins.Keyboard.Cnds.OnLeftRightKeyPressed),this.Trigger(kw.Plugins.Keyboard.Cnds.OnKeyCode))}_OnKeyUp(e){const t=e.which,s=e.code||t.toString(),i=e.key;this._keysDownByString.delete(s),this._keysDownByWhich.delete(t),this._triggerString=s,this._triggerWhich=t,this._triggerTypedKey=i,this.Trigger(kw.Plugins.Keyboard.Cnds.OnAnyKeyReleased),this.Trigger(kw.Plugins.Keyboard.Cnds.OnKeyReleased),this.Trigger(kw.Plugins.Keyboard.Cnds.OnLeftRightKeyReleased),this.Trigger(kw.Plugins.Keyboard.Cnds.OnKeyCodeReleased)}_OnWindowOrKeyboardBlur(){for(const e of this._keysDownByWhich)this._keysDownByWhich.delete(e),this._triggerWhich=e,this.Trigger(kw.Plugins.Keyboard.Cnds.OnAnyKeyReleased),this.Trigger(kw.Plugins.Keyboard.Cnds.OnKeyReleased),this.Trigger(kw.Plugins.Keyboard.Cnds.OnKeyCodeReleased);this._keysDownByString.clear()}IsKeyDown(e){return this._keysDownByString.has(e)}IsKeyCodeDown(e){return this._keysDownByWhich.has(e)}SaveToJson(){return{tk:this._triggerWhich,tkk:this._triggerTypedKey}}LoadFromJson(e){this._triggerWhich=e.tk,e.hasOwnProperty("tkk")&&(this._triggerTypedKey=e.tkk)}GetDebuggerProperties(){const e="plugins.keyboard";return[{title:e+".name",properties:[{name:e+".debugger.last-key-code",value:this._triggerWhich},{name:e+".debugger.last-key-string",value:kw.Plugins.Keyboard.Exps.StringFromKeyCode(this._triggerWhich)},{name:e+".debugger.last-typed-key",value:this._triggerTypedKey}]}]}}}{const Uw=self.C3,Ww=["ShiftLeft","ShiftRight","ControlLeft","ControlRight","AltLeft","AltRight","MetaLeft","MetaRight"];Uw.Plugins.Keyboard.Cnds={IsKeyDown(e){return this._keysDownByWhich.has(e)},OnKey(e){return this._triggerWhich===e},OnAnyKey:()=>!0,OnAnyKeyReleased:()=>!0,OnKeyReleased(e){return this._triggerWhich===e},IsKeyCodeDown(e){return e=Math.floor(e),this._keysDownByWhich.has(e)},OnKeyCode(e){return this._triggerWhich===e},OnKeyCodeReleased(e){return this._triggerWhich===e},OnLeftRightKeyPressed(e){const t=Ww[e];return this._triggerString===t},OnLeftRightKeyReleased(e){const t=Ww[e];return this._triggerString===t},IsLeftRightKeyDown(e){const t=Ww[e];return this._keysDownByString.has(t)},IsKeyboardLockSupported(){return this._isKeyboardLockSupported},OnKeyboardLocked:()=>!0,OnKeyboardLockError:()=>!0}}{const Hw=self.C3;Hw.Plugins.Keyboard.Acts={async LockKeyboard(e){if(!this._isKeyboardLockSupported)return;let t=[];e&&(t=e.split(",")),(await this.PostToDOMAsync("lock-keyboard",{keysArr:t})).isOk?this.Trigger(Hw.Plugins.Keyboard.Cnds.OnKeyboardLocked):this.Trigger(Hw.Plugins.Keyboard.Cnds.OnKeyboardLockError)},UnlockKeyboard(){this._isKeyboardLockSupported&&this.PostToDOMAsync("unlock-keyboard")}}}{let zw=function(e){switch(e=Math.floor(e)){case 8:return"backspace";case 9:return"tab";case 13:return"enter";case 16:return"shift";case 17:return"control";case 18:return"alt";case 19:return"pause";case 20:return"capslock";case 27:return"esc";case 33:return"pageup";case 34:return"pagedown";case 35:return"end";case 36:return"home";case 37:return"←";case 38:return"↑";case 39:return"→";case 40:return"↓";case 45:return"insert";case 46:return"del";case 91:return"left window key";case 92:return"right window key";case 93:return"select";case 96:return"numpad 0";case 97:return"numpad 1";case 98:return"numpad 2";case 99:return"numpad 3";case 100:return"numpad 4";case 101:return"numpad 5";case 102:return"numpad 6";case 103:return"numpad 7";case 104:return"numpad 8";case 105:return"numpad 9";case 106:return"numpad *";case 107:return"numpad +";case 109:return"numpad -";case 110:return"numpad .";case 111:return"numpad /";case 112:return"F1";case 113:return"F2";case 114:return"F3";case 115:return"F4";case 116:return"F5";case 117:return"F6";case 118:return"F7";case 119:return"F8";case 120:return"F9";case 121:return"F10";case 122:return"F11";case 123:return"F12";case 144:return"numlock";case 145:return"scroll lock";case 186:return";";case 187:return"=";case 188:return",";case 189:return"-";case 190:return".";case 191:return"/";case 192:return"'";case 219:return"[";case 220:return"\\";case 221:return"]";case 222:return"#";case 223:return"`";default:return String.fromCharCode(e)}};StringFromCharCode=zw,self.C3.Plugins.Keyboard.Exps={LastKeyCode(){return this._triggerWhich},StringFromKeyCode:e=>zw(e),TypedKey(){return this._triggerTypedKey}}}{const jw=self.C3;jw.Plugins.AdvancedRandom=class extends jw.SDKPluginBase{constructor(e){super(e)}Release(){super.Release()}}}{let Yw=function(){return Kw.GetSingleGlobalInstance().GetSdkInstance()};GetSdkInstance=Yw;const qw=self.C3,Xw=self.C3X;qw.Plugins.AdvancedRandom.Type=class extends qw.SDKTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}GetScriptInterfaceClass(){return self.IAdvancedRandomObjectType}};const $w=new Set(["rgb","float"]);let Kw=null;self.IAdvancedRandomObjectType=class extends self.IObjectType{constructor(e){super(e),Kw=e}set seed(e){Xw.RequireString(e),Yw()._UpdateSeed(e)}get seed(){return Yw()._GetCurrentSeed()}set octaves(e){Xw.RequireFiniteNumber(e),Yw()._SetOctaves(e)}get octaves(){return Yw()._GetOctaves()}classic2d(e,t){return Xw.RequireNumber(e),Xw.RequireNumber(t),Yw()._GetClassic2d(e,t)}classic3d(e,t,s){return Xw.RequireNumber(e),Xw.RequireNumber(t),Xw.RequireNumber(s),Yw()._GetClassic3d(e,t,s)}billow2d(e,t){return Xw.RequireNumber(e),Xw.RequireNumber(t),Yw()._GetBillow2d(e,t)}billow3d(e,t,s){return Xw.RequireNumber(e),Xw.RequireNumber(t),Xw.RequireNumber(s),Yw()._GetBillow3d(e,t,s)}ridged2d(e,t){return Xw.RequireNumber(e),Xw.RequireNumber(t),Yw()._GetRidged2d(e,t)}ridged3d(e,t,s){return Xw.RequireNumber(e),Xw.RequireNumber(t),Xw.RequireNumber(s),Yw()._GetRidged3d(e,t,s)}cellular2d(e,t){return Xw.RequireNumber(e),Xw.RequireNumber(t),Yw()._GetCellular2d(e,t)}cellular3d(e,t,s){return Xw.RequireNumber(e),Xw.RequireNumber(t),Xw.RequireNumber(s),Yw()._GetCellular3d(e,t,s)}voronoi2d(e,t){return Xw.RequireNumber(e),Xw.RequireNumber(t),Yw()._GetVoronoi2d(e,t)}voronoi3d(e,t,s){return Xw.RequireNumber(e),Xw.RequireNumber(t),Xw.RequireNumber(s),Yw()._GetVoronoi3d(e,t,s)}createGradient(e,t){if(Xw.RequireString(e),!$w.has(t))throw new Error("invalid mode");Yw()._CreateGradient(e,t)}setCurrentGradient(e){Xw.RequireString(e),Yw()._SetGradient(e)}addGradientStop(e,t){Xw.RequireNumber(e),Xw.RequireNumber(t),Yw()._AddGradientStop(e,t)}sampleGradient(e,t){return Xw.RequireOptionalString(e),Xw.RequireNumber(t),e?Yw()._SampleGradientByName(e,t):Yw()._SampleCurrentGradient(t)}createProbabilityTable(e){Xw.RequireString(e),Yw()._CreateProbabilityTable(e)}createProbabilityTableFromJSON(e,t){Xw.RequireString(e),Xw.RequireString(t),Yw()._CreateProbabilityTableFromJSON(e,t)}getProbabilityTableAsJSON(){return Yw()._GetProbabilityTableAsJSON()}setCurrentProbabilityTable(e){Xw.RequireString(e),Yw()._SetProbabilityTable(e)}addProbabilityTableEntry(e,t){if(Xw.RequireNumber(e),"number"!=typeof t&&"string"!=typeof t)throw new TypeError("invalid value");Yw()._AddProbabilityEntry(e,t)}removeProbabilityTableEntry(e,t){if(Xw.RequireNumber(e),"number"!=typeof t&&"string"!=typeof t)throw new TypeError("invalid value");Yw()._RemoveProbabilityEntry(e,t)}sampleProbabilityTable(e){return Xw.RequireOptionalString(e),e?Yw()._SampleProbabilityTableByName(e):Yw()._SampleCurrentProbabilityTable()}createPermutationTable(e,t){Xw.RequireFiniteNumber(e),Xw.RequireNumber(t),Yw()._CreatePermutationTable(e,t)}shufflePermutationTable(){Yw()._ShufflePermutationTable()}getPermutation(e){return Xw.RequireFiniteNumber(e),Yw()._GetPermutation(e)}}}{let Jw=function(e,t){let s=e.length;for(;s>0;){const i=Math.floor(t(0,s--)),r=e[s];e[s]=e[i],e[i]=r}return e};shuffle=Jw;const Qw=self.C3;class Zw{constructor(e,t){this.mode=e,this.name=t,this.stops=[]}GetName(){return this.name}AddStop(e,t){switch(this.mode){case"rgb":t=this._CreateStopRGB(t);break;case"float":t=this._CreateStopFloat(t)}let s=this.stops.length;for(;s--;)if(e>this.stops[s][0])return void this.stops.splice(s+1,0,[e,t]);this.stops.push([e,t])}_CreateStopFloat(e){return[e]}_CreateStopRGB(e){return[e,Qw.GetRValue(e),Qw.GetGValue(e),Qw.GetBValue(e),Qw.GetAValue(e)]}_SampleFloat(e,t,s){return Qw.lerp(e[0],t[0],s)}_SampleRGB(e,t,s){return Qw.PackRGBAEx(Qw.lerp(e[1],t[1],s),Qw.lerp(e[2],t[2],s),Qw.lerp(e[3],t[3],s),Qw.lerp(e[4],t[4],s))}Sample(e){const t=this.stops,s=t[0],i=t.length,r=t[i-1];if(e<s[0])return s[1][0];if(e>r[0])return r[1][0];let n=null,a=s;for(let s=1;s<i&&(n=a,a=t[s],!(a[0]>e));s++);switch(e=Qw.clamp((e-n[0])/(a[0]-n[0]),0,1),this.mode){case"rgb":return this._SampleRGB(n[1],a[1],e);case"float":return this._SampleFloat(n[1],a[1],e)}}asJSON(e=!1){return"rgb"===this.mode?JSON.stringify(this.stops.map(([t,s])=>[t,e?s.slice(1):s[0]])):JSON.stringify(this.stops)}}Qw.Plugins.AdvancedRandom.Instance=class extends Qw.SDKInstanceBase{constructor(e,t){super(e),this._currentSeed="",this._octaves=1,this._lacunarity=2,this._persistence=.5,this._gradients=new Map,this._probabilityTables=new Map,this._currentGradient=null,this._currentProbabilityTable=null,this._permutation=[0];let s=t[0];this._replaceSystemPRNG=t[1],this._funcs=Qw.Plugins.AdvancedRandom.NoiseFuncs,this._CreateGradient("default","rgb"),this._AddGradientStop(0,Qw.PackRGBEx(0,0,0)),this._AddGradientStop(1,Qw.PackRGBEx(1,1,1)),this._CreateProbabilityTable("default"),""===s&&(s=this._RandomSeed(10)),this._UpdateSeed(s),this._replaceSystemPRNG&&this._runtime.SetRandomNumberGeneratorCallback(()=>this._funcs.randomXorshiro(0,1))}Release(){super.Release()}SaveToJson(){return{prng:this._funcs.saveToJson()}}LoadFromJson(e){this._funcs.loadFromJson(e.prng)}_RandomSeed(e){const t=[];for(;e--;)t.push(String.fromCharCode(Math.round(25*Math.random())+65));return t.join("")}_UpdateSeed(e){this._currentSeed=e;let t=5381;for(let s=0,i=e.length;s<i;s++)t=(t<<5)+t+e.charCodeAt(s);t>>>=0,this._funcs.seed(t)}_GetCurrentSeed(){return this._currentSeed}_SetOctaves(e){this._octaves=Qw.clamp(0|e,1,16)}_GetOctaves(){return this._octaves}_GetClassic2d(e,t){return this._funcs.classic2d(e,t,this._octaves)}_GetClassic3d(e,t,s){return this._funcs.classic3d(e,t,s,this._octaves)}_GetBillow2d(e,t){return this._funcs.billow2d(e,t,this._octaves)}_GetBillow3d(e,t,s){return this._funcs.billow3d(e,t,s,this._octaves)}_GetRidged2d(e,t){return this._funcs.ridged2d(e,t,this._octaves)}_GetRidged3d(e,t,s){return this._funcs.ridged3d(e,t,s,this._octaves)}_GetCellular2d(e,t){return this._funcs.cellular2d(e,t)}_GetCellular3d(e,t,s){return this._funcs.cellular3d(e,t,s)}_GetVoronoi2d(e,t){return this._funcs.voronoi2d(e,t)}_GetVoronoi3d(e,t,s){return this._funcs.voronoi3d(e,t,s)}_CreateGradient(e,t){const s=new Zw(t,e);this._gradients.set(e.toLowerCase(),s),this._currentGradient=s}_SetGradient(e){this._currentGradient=this._gradients.get(e.toLowerCase())||null}_AddGradientStop(e,t){const s=this._currentGradient;null!==s&&s.AddStop(e,t)}_SampleCurrentGradient(e){const t=this._currentGradient;return t?t.Sample(e):0}_SampleGradientByName(e,t){const s=this._gradients.get(e.toLowerCase());return s?s.Sample(t):0}_CreateProbabilityTable(e){const t=new Qw.ProbabilityTable(e);this._probabilityTables.set(e.toLowerCase(),t),this._currentProbabilityTable=t}_CreateProbabilityTableFromJSON(e,t){const s=Qw.ProbabilityTable.fromJSON(t,e);this._probabilityTables.set(e.toLowerCase(),s),this._currentProbabilityTable=s}_GetProbabilityTableAsJSON(){return this._currentProbabilityTable?this._currentProbabilityTable.asJSON():""}_SetProbabilityTable(e){this._currentProbabilityTable=this._probabilityTables.get(e.toLowerCase())||null}_AddProbabilityEntry(e,t){const s=this._currentProbabilityTable;s&&s.AddItem(e,t)}_RemoveProbabilityEntry(e,t){const s=this._currentProbabilityTable;s&&s.RemoveItem(e,t)}_SampleCurrentProbabilityTable(){const e=this._currentProbabilityTable;return e?e.Sample(this._funcs.randomXorshiro(0,e.GetTotalWeight())):0}_SampleProbabilityTableByName(e){const t=this._probabilityTables.get(e.toLowerCase());return t?t.Sample(this._funcs.randomXorshiro(0,t.GetTotalWeight())):0}_CreatePermutationTable(e,t){if(e<2)this._permutation=[t];else{this._permutation=[];for(let s=0;s<e;s++)this._permutation.push(s+t);Jw(this._permutation,this._funcs.randomXorshiro)}}_ShufflePermutationTable(){Jw(this._permutation,this._funcs.randomXorshiro)}_GetPermutation(e){e=Math.floor(e);const t=this._permutation,s=t.length;return(e%=s)<0&&(e+=s),t[e]}GetDebuggerProperties(){const e="plugins.advancedrandom.debugger",t=[],s=[],i=e=>e.toString().replace(/,/g,", ");for(const e of this._probabilityTables.values()){const t=e.asJSON();s.push({name:"$"+e.GetName(),value:i(t.slice(1,-1))})}for(const e of this._gradients.values()){const s=e.asJSON(!0);t.push({name:"$"+e.GetName(),value:i(s.slice(1,-1))})}return[{title:e+".title",properties:[{name:e+".seed",value:this._GetCurrentSeed(),onedit:e=>this._UpdateSeed(e)},{name:e+".replace-system",value:this._replaceSystemPRNG},{name:e+".noise-octaves",value:this._GetOctaves()},{name:e+".noise-lacunarity",value:this._lacunarity},{name:e+".noise-persistence",value:this._persistence},{name:e+".current-probability-table",value:this._currentProbabilityTable?this._currentProbabilityTable.GetName():""},{name:e+".current-gradient",value:this._currentGradient?this._currentGradient.GetName():""},{name:e+".permutation-table",value:i(this._permutation)}]},{title:e+".gradients",properties:t},{title:e+".probability-tables",properties:s}]}}}self.C3.Plugins.AdvancedRandom.Cnds={},self.C3.Plugins.AdvancedRandom.Acts={SetSeed(e){this._UpdateSeed(e)},SetOctaves(e){this._SetOctaves(e)},CreateGradient(e,t){const s=["rgb","float"][t];this._CreateGradient(e,s)},SetGradient(e){this._SetGradient(e)},AddStop(e,t){this._AddGradientStop(e,t)},CreateProbabilityTable(e){this._CreateProbabilityTable(e)},CreateProbabilityTableFromJSON(e,t){try{this._CreateProbabilityTableFromJSON(e,t)}catch(e){console.warn("Failed to create probability table from JSON String",e)}},SetProbabilityTable(e){this._SetProbabilityTable(e)},AddProbabilityEntry(e,t){this._AddProbabilityEntry(t,e)},RemoveProbabilityEntry(e,t){this._RemoveProbabilityEntry(t,e)},CreatePermutationTable(e,t){this._CreatePermutationTable(e,t)},ShufflePermutationTable(){this._ShufflePermutationTable()}},self.C3.Plugins.AdvancedRandom.Exps={Classic2d(e,t){return this._GetClassic2d(e,t)},Classic3d(e,t,s){return this._GetClassic3d(e,t,s)},Billow2d(e,t){return this._GetBillow2d(e,t)},Billow3d(e,t,s){return this._GetBillow3d(e,t,s)},Ridged2d(e,t){return this._GetRidged2d(e,t)},Ridged3d(e,t,s){return this._GetRidged3d(e,t,s)},Cellular2d(e,t){return this._GetCellular2d(e,t)},Cellular3d(e,t,s){return this._GetCellular3d(e,t,s)},Voronoi2d(e,t){return this._GetVoronoi2d(e,t)},Voronoi3d(e,t,s){return this._GetVoronoi3d(e,t,s)},Gradient(e){return this._SampleCurrentGradient(e)},GradientByName(e,t){return this._SampleGradientByName(e,t)},Weighted(){return this._SampleCurrentProbabilityTable()},WeightedByName(e){return this._SampleProbabilityTableByName(e)},RandomSeed(){return this._RandomSeed(10)},Seed(){return this._GetCurrentSeed()},Octaves(){return this._GetOctaves()},Permutation(e){return this._GetPermutation(e)},ProbabilityTableAsJSON(){return this._GetProbabilityTableAsJSON()}};{let eA=function(e,t){return bA[bA[255&e]+(255&t)]},tA=function(e,t,s){return bA[bA[bA[255&e]+(255&t)]+(255&s)]},sA=function(e,t,s){const i=GA[e];return i.x*t+i.y*s},iA=function(e,t,s,i){const r=IA[e];return r.x*t+r.y*s+r.z*i},rA=function(e){return 6*e*e*e*e*e-15*e*e*e*e+10*e*e*e},nA=function(e){return e%1},aA=function(e){return e*e},oA=function(e,t,s){const i=e[t];e[t]=e[s],e[s]=i},lA=function(e){return BigInt.asUintN(64,e)},hA=function(){mA=lA(mA+BigInt("0x9e3779b97f4a7c15"));let e=mA;return e=lA((e^e>>BigInt(30))*BigInt("0xbf58476d1ce4e5b9")),e=lA((e^e>>BigInt(27))*BigInt("0x94d049bb133111eb")),lA(e^e>>BigInt(31))},uA=function(e,t){return lA(e<<t|e>>BigInt(64)-t)},cA=function(){const e=lA(uA(lA(fA[1]*BigInt(5)),BigInt(7))*BigInt(9)),t=lA(fA[1]<<BigInt(17));return fA[2]=lA(fA[2]^fA[0]),fA[3]=lA(fA[3]^fA[1]),fA[1]=lA(fA[1]^fA[2]),fA[0]=lA(fA[0]^fA[3]),fA[2]=lA(fA[2]^t),fA[3]=uA(fA[3],BigInt(45)),e},dA=function(){return Number(cA()>>BigInt(11))/_A};pickGradient2=eA,pickGradient3=tA,dot2=sA,dot3=iA,quintic=rA,fract=nA,sq=aA,swap=oA,uint64=lA,splitmix64=hA,rotl=uA,next=cA,nextFloat=dA;const pA=self.C3,_A=9007199254740992;let mA=BigInt(0),fA=[BigInt(0),BigInt(0),BigInt(0),BigInt(0)],gA=.5,yA=2;const SA=.013,TA=256,xA=255,bA=Array.from({length:512},()=>0),GA=Array.from({length:256},()=>({x:0,y:0})),IA=Array.from({length:256},()=>({x:0,y:0,z:0}));pA.Plugins.AdvancedRandom.NoiseFuncs={setLacunarity(e){yA=e},setPersistence(e){gA=e},saveToJson:()=>({splitstate:mA.toString(),s:fA.map(e=>e.toString())}),loadFromJson(e){mA=BigInt(e.splitstate);for(let t=0,s=fA.length;t<s;++t)fA[t]=BigInt(e.s[t])},noise2d(e,t){const s=Math.floor(e),i=Math.floor(t),r=e-s,n=t-i,a=sA(eA(s,i),r,n),o=sA(eA(s+1,i),r-1,n),l=sA(eA(s,i+1),r,n-1),h=sA(eA(s+1,i+1),r-1,n-1),u=rA(r),c=rA(n);return pA.lerp(pA.lerp(a,l,c),pA.lerp(o,h,c),u)},noise3d(e,t,s){const i=Math.floor(e),r=Math.floor(t),n=Math.floor(s),a=e-i,o=t-r,l=s-n,h=iA(tA(i,r,n),a,o,l),u=iA(tA(i+1,r,n),a-1,o,l),c=iA(tA(i,r+1,n),a,o-1,l),d=iA(tA(i+1,r+1,n),a-1,o-1,l),p=iA(tA(i,r,n+1),a,o,l-1),_=iA(tA(i+1,r,n+1),a-1,o,l-1),m=iA(tA(i,r+1,n+1),a,o-1,l-1),f=iA(tA(i+1,r+1,n+1),a-1,o-1,l-1),g=rA(a),y=rA(o),S=rA(l);return pA.lerp(pA.lerp(pA.lerp(h,u,g),pA.lerp(c,d,g),y),pA.lerp(pA.lerp(p,_,g),pA.lerp(m,f,g),y),S)},randomXorshiro:(e,t)=>dA()*(t-e)+e,randomSplitMix:(e,t)=>Number(hA()>>11)/_A*(t-e)+e,seed(e){mA=BigInt(e),fA[0]=hA(),fA[1]=hA(),fA[2]=hA(),fA[3]=hA(),hA(),hA();for(let e=0;e<256;++e){const t=dA(),s=Math.acos(2*t-1),i=2*dA()*Math.PI;IA[e].x=Math.cos(i)*Math.sin(s),IA[e].y=Math.sin(i)*Math.sin(s),IA[e].z=Math.cos(s),GA[e].x=Math.cos(i),GA[e].y=Math.sin(i),bA[e]=e}for(let e=0;e<256;++e)oA(bA,e,Number(cA()&BigInt(255)));for(let e=0;e<256;++e)bA[256+e]=bA[e]},classic3d(e,t,s,i){if(1==i)return.5*(this.noise3d(.013*e,.013*t,.013*s)+1);let r,n=1,a=.013,o=0,l=0;for(let h=0;h<i;h++)r=this.noise3d(a*e,a*t,a*s),o+=n*r,l+=n,a*=yA,n*=gA;return(o/l+1)/2},billow3d(e,t,s,i){if(1==i)return Math.abs(this.noise3d(.013*e,.013*t,.013*s));let r,n=1,a=.013,o=0,l=0;for(let h=0;h<i;h++)r=this.noise3d(a*e,a*t,a*s),r=Math.abs(r),o+=n*r,l+=n,a*=yA,n*=gA;return o/l},ridged3d(e,t,s,i){if(1==i)return aA(1-Math.abs(this.noise3d(.013*e,.013*t,.013*s)));let r,n=1,a=.013,o=0,l=0;for(let h=0;h<i;h++)r=this.noise3d(a*e,a*t,a*s),r=aA(1-Math.abs(r)),o+=n*r,l+=n,a*=yA,n*=gA;return o/l},classic2d(e,t,s){if(1==s)return.5*(this.noise2d(.013*e,.013*t)+1);let i,r=1,n=.013,a=0,o=0;for(let l=0;l<s;l++)i=this.noise2d(n*e,n*t),a+=r*i,o+=r,n*=yA,r*=gA;return(a/o+1)/2},billow2d(e,t,s){if(1==s)return Math.abs(this.noise2d(.013*e,.013*t));let i,r=1,n=.013,a=0,o=0;for(let l=0;l<s;l++)i=this.noise2d(n*e,n*t),i=Math.abs(i),a+=r*i,o+=r,n*=yA,r*=gA;return a/o},ridged2d(e,t,s){if(1==s)return aA(1-Math.abs(this.noise2d(.013*e,.013*t)));let i,r=1,n=.013,a=0,o=0;for(let l=0;l<s;l++)i=this.noise2d(n*e,n*t),i=1-Math.abs(i),i*=i,a+=r*i,o+=r,n*=yA,r*=gA;return a/o},cellular2d(e,t){e*=.013,t*=.013;const s=Math.floor(e),i=Math.floor(t),r=e-s,n=t-i;let a=1e5;for(let e=-1;e<=1;e++)for(let t=-1;t<=1;t++){const o=GA[eA(s+t,i+e)],l=t+Math.abs(o.x)-r,h=e+Math.abs(o.y)-n,u=l*l+h*h;a=Math.min(u,a)}return pA.clamp(Math.sqrt(a),0,1)},cellular3d(e,t,s){e*=.013,t*=.013,s*=.013;const i=Math.floor(e),r=Math.floor(t),n=Math.floor(s),a=e-i,o=t-r,l=s-n;let h=1e5;for(let e=-1;e<=1;e++)for(let t=-1;t<=1;t++)for(let s=-1;s<=1;s++){const u=IA[tA(i+t,r+e,n+s)],c=t+Math.abs(u.x)-a,d=e+Math.abs(u.y)-o,p=s+Math.abs(u.z)-l,_=c*c+d*d+p*p;h=Math.min(_,h)}return pA.clamp(Math.sqrt(h),0,1)},voronoi2d(e,t){e*=.013,t*=.013;const s=Math.floor(e),i=Math.floor(t),r=e-s,n=t-i;let a,o=1e5;for(let e=-1;e<=1;e++)for(let t=-1;t<=1;t++){const l=s+t,h=i+e,u=GA[eA(l,h)],c=t+Math.abs(u.x)-r,d=e+Math.abs(u.y)-n,p=c*c+d*d;p<o&&(o=p,a=bA[bA[255&l]+(255&h)])}return a/255},voronoi3d(e,t,s){e*=.013,t*=.013,s*=.013;const i=Math.floor(e),r=Math.floor(t),n=Math.floor(s),a=e-i,o=t-r,l=s-n;let h,u=1e5;for(let e=-1;e<=1;e++)for(let t=-1;t<=1;t++)for(let s=-1;s<=1;s++){const c=i+t,d=r+e,p=n+s,_=IA[tA(c,d,p)],m=t+Math.abs(_.x)-a,f=e+Math.abs(_.y)-o,g=s+Math.abs(_.z)-l,y=m*m+f*f+g*g;y<u&&(u=y,h=bA[bA[bA[255&c]+(255&d)]+(255&p)])}return h/255}}}{const vA=self.C3;vA.Plugins.Mouse=class extends vA.SDKPluginBase{constructor(e){super(e)}Release(){super.Release()}}}{let CA=function(){return RA.GetSingleGlobalInstance().GetSdkInstance()};GetMouseSdkInstance=CA;const wA=self.C3,AA=self.C3X;wA.Plugins.Mouse.Type=class extends wA.SDKTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}GetScriptInterfaceClass(){return self.IMouseObjectType}};let RA=null;self.IMouseObjectType=class extends self.IObjectType{constructor(e){super(e),RA=e,e.GetRuntime()._GetCommonScriptInterfaces().mouse=this}getMouseX(e){return CA().GetMousePositionForLayer(e)[0]}getMouseY(e){return CA().GetMousePositionForLayer(e)[1]}getMousePosition(e){return CA().GetMousePositionForLayer(e)}isMouseButtonDown(e){return CA().IsMouseButtonDown(e)}setCursorStyle(e){AA.RequireString(e),CA().SetCursorStyle(e)}setCursorObjectClass(e){const t=CA(),s=t.GetRuntime()._UnwrapIObjectClass(e);t.SetCursorObjectClass(s)}}}{const PA=self.C3,MA="mouse";let EA=null;PA.Plugins.Mouse.Instance=class extends PA.SDKInstanceBase{constructor(e,t){super(e,MA),this._buttonMap=[!1,!1,!1,!1,!1],this._mouseXcanvas=0,this._mouseYcanvas=0,this._triggerButton=0,this._triggerType=0,this._triggerDir=0,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._hasPointerLock=!1,this._movementX=0,this._movementY=0,this.AddDOMMessageHandlers([["pointer-lock-change",e=>this._OnPointerLockChange(e)],["pointer-lock-error",e=>this._OnPointerLockError(e)]]);const s=this.GetRuntime().Dispatcher();this._disposables=new PA.CompositeDisposable(PA.Disposable.From(s,"pointermove",e=>this._OnPointerMove(e.data)),PA.Disposable.From(s,"pointerdown",e=>this._OnPointerDown(e.data)),PA.Disposable.From(s,"pointerup",e=>this._OnPointerUp(e.data)),PA.Disposable.From(s,"dblclick",e=>this._OnDoubleClick(e.data)),PA.Disposable.From(s,"wheel",e=>this._OnMouseWheel(e.data)),PA.Disposable.From(s,"window-blur",()=>this._OnWindowBlur()))}Release(){super.Release()}_OnPointerDown(e){"mouse"===e.pointerType&&(this._mouseXcanvas=e.pageX-this._runtime.GetCanvasClientX(),this._mouseYcanvas=e.pageY-this._runtime.GetCanvasClientY(),this._CheckButtonChanges(e.lastButtons,e.buttons))}_OnPointerMove(e){this._movementX=e.movementX,this._movementY=e.movementY,this.Trigger(PA.Plugins.Mouse.Cnds.OnMovement),this._movementX=0,this._movementY=0,"mouse"===e.pointerType&&(this._mouseXcanvas=e.pageX-this._runtime.GetCanvasClientX(),this._mouseYcanvas=e.pageY-this._runtime.GetCanvasClientY(),this._CheckButtonChanges(e.lastButtons,e.buttons))}_OnPointerUp(e){"mouse"===e.pointerType&&this._CheckButtonChanges(e.lastButtons,e.buttons)}_CheckButtonChanges(e,t){this._CheckButtonChange(e,t,1,0),this._CheckButtonChange(e,t,4,1),this._CheckButtonChange(e,t,2,2),this._CheckButtonChange(e,t,8,3),this._CheckButtonChange(e,t,16,4)}_CheckButtonChange(e,t,s,i){!(e&s)&&t&s?this._OnMouseDown(i):e&s&&!(t&s)&&this._OnMouseUp(i)}_OnMouseDown(e){this._buttonMap[e]=!0,this.Trigger(PA.Plugins.Mouse.Cnds.OnAnyClick),this._triggerButton=e,this._triggerType=0,this.Trigger(PA.Plugins.Mouse.Cnds.OnClick),this.Trigger(PA.Plugins.Mouse.Cnds.OnObjectClicked)}_OnMouseUp(e){this._buttonMap[e]&&(this._buttonMap[e]=!1,this._triggerButton=e,this.Trigger(PA.Plugins.Mouse.Cnds.OnRelease))}_OnDoubleClick(e){this._triggerButton=e.button,this._triggerType=1,this.Trigger(PA.Plugins.Mouse.Cnds.OnClick),this.Trigger(PA.Plugins.Mouse.Cnds.OnObjectClicked)}_OnMouseWheel(e){this._triggerDir=e.deltaY<0?1:0,this._wheelDeltaX=e.deltaX,this._wheelDeltaY=e.deltaY,this._wheelDeltaZ=e.deltaZ,this.Trigger(PA.Plugins.Mouse.Cnds.OnWheel)}_OnWindowBlur(){for(let e=0,t=this._buttonMap.length;e<t;++e){if(!this._buttonMap[e])return;this._buttonMap[e]=!1,this._triggerButton=e,this.Trigger(PA.Plugins.Mouse.Cnds.OnRelease)}}GetMousePositionForLayer(e){const t=this._runtime.GetMainRunningLayout(),s=this._mouseXcanvas,i=this._mouseYcanvas;if(void 0===e)return t.GetLayerByIndex(0).CanvasCssToLayer_DefaultTransform(s,i);{const r=t.GetLayer(e);return r?r.CanvasCssToLayer(s,i):[0,0]}}IsMouseButtonDown(e){return e=Math.floor(e),!!this._buttonMap[e]}_IsMouseOverCanvas(){return this._mouseXcanvas>=0&&this._mouseYcanvas>=0&&this._mouseXcanvas<this._runtime.GetCanvasCssWidth()&&this._mouseYcanvas<this._runtime.GetCanvasCssHeight()}SetCursorStyle(e){EA!==e&&(EA=e,this.PostToDOM("cursor",e))}async SetCursorObjectClass(e){if(PA.Platform.IsMobile||!e)return;const t=e.GetFirstPicked();if(!t)return;const s=t.GetWorldInfo(),i=t.GetCurrentImageInfo();if(!s||!i)return;if(EA===i)return;EA=i;const r=`url(${await i.ExtractImageToBlobURL()}) ${Math.round(s.GetOriginX()*i.GetWidth())} ${Math.round(s.GetOriginY()*i.GetHeight())}, auto`;this.PostToDOM("cursor",r)}_OnPointerLockChange(e){this._UpdatePointerLockState(e["has-pointer-lock"])}_OnPointerLockError(e){this._UpdatePointerLockState(e["has-pointer-lock"]),this.Trigger(PA.Plugins.Mouse.Cnds.OnPointerLockError)}_UpdatePointerLockState(e){this._hasPointerLock!==e&&(this._hasPointerLock=e,this._hasPointerLock?this.Trigger(PA.Plugins.Mouse.Cnds.OnPointerLocked):this.Trigger(PA.Plugins.Mouse.Cnds.OnPointerUnlocked))}GetDebuggerProperties(){const e="plugins.mouse";return[{title:e+".name",properties:[{name:e+".debugger.absolute-position",value:this._mouseXcanvas+","+this._mouseYcanvas},{name:e+".debugger.left-button",value:this._buttonMap[0]},{name:e+".debugger.middle-button",value:this._buttonMap[1]},{name:e+".debugger.right-button",value:this._buttonMap[2]},{name:e+".debugger.button-4",value:this._buttonMap[3]},{name:e+".debugger.button-5",value:this._buttonMap[4]}]},{title:e+".debugger.position-on-each-layer",properties:this._runtime.GetMainRunningLayout().GetLayers().map(e=>({name:"$"+e.GetName(),value:e.CanvasCssToLayer(this._mouseXcanvas,this._mouseYcanvas).join(", ")}))}]}}}{const DA=self.C3;DA.Plugins.Mouse.Cnds={OnClick(e,t){return this._triggerButton===e&&this._triggerType===t},OnAnyClick:()=>!0,IsButtonDown(e){return this._buttonMap[e]},OnRelease(e){return this._triggerButton===e},IsOverObject(e){const t=this._runtime.GetCurrentCondition().IsInverted(),s=[];return this._IsMouseOverCanvas()&&s.push([this._mouseXcanvas,this._mouseYcanvas]),DA.xor(this._runtime.GetCollisionEngine().TestAndSelectCanvasPointOverlap(e,s,t),t)},OnObjectClicked(e,t,s){if(e!==this._triggerButton||t!==this._triggerType)return!1;if(!this._IsMouseOverCanvas())return!1;const i=this._mouseXcanvas,r=this._mouseYcanvas;return this._runtime.GetCollisionEngine().TestAndSelectCanvasPointOverlap(s,[[i,r]],!1)},OnWheel(e){return 2===e||this._triggerDir===e},OnPointerLocked:()=>!0,OnPointerUnlocked:()=>!0,OnPointerLockError:()=>!0,HasPointerLock(){return this._hasPointerLock},OnMovement:()=>!0}}{const NA=self.C3,FA=["auto","pointer","text","crosshair","move","help","wait","none"],OA=["auto","all-scroll","none","help","pointer","progress","wait","cell","crosshair","text","vertical-text","alias","copy","move","not-allowed","grab","grabbing","col-resize","row-resize","ew-resize","ns-resize","nesw-resize","nwse-resize","zoom-in","zoom-out"];NA.Plugins.Mouse.Acts={SetCursor(e){this.SetCursorStyle(FA[e])},SetCursor2(e){this.SetCursorStyle(OA[e])},SetCursorSprite(e){this.SetCursorObjectClass(e)},RequestPointerLock(e){this._PostToDOMMaybeSync("request-pointer-lock",{unadjustedMovement:e})},ReleasePointerLock(){this.PostToDOM("release-pointer-lock")}}}self.C3.Plugins.Mouse.Exps={X(e){return this.GetMousePositionForLayer(e)[0]},Y(e){return this.GetMousePositionForLayer(e)[1]},AbsoluteX(){return this._mouseXcanvas},AbsoluteY(){return this._mouseYcanvas},MovementX(){return this._movementX},MovementY(){return this._movementY},WheelDeltaX(){return this._wheelDeltaX},WheelDeltaY(){return this._wheelDeltaY},WheelDeltaZ(){return this._wheelDeltaZ}};{const BA=self.C3;BA.Plugins.Browser=class extends BA.SDKPluginBase{constructor(e){super(e)}Release(){super.Release()}}}{const LA=self.C3;LA.Plugins.Browser.Type=class extends LA.SDKTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const kA=self.C3,VA="browser";kA.Plugins.Browser.Instance=class extends kA.SDKInstanceBase{constructor(e,t){super(e,VA),this._initLocationStr="",this._isOnline=!1,this._referrer="",this._docTitle="",this._isCookieEnabled=!1,this._screenWidth=0,this._screenHeight=0,this._windowOuterWidth=0,this._windowOuterHeight=0,this._windowHasFocus=!1,this._isConstructArcade=!1,this._cssStyleMap=new Map,this._isInstallAvailable=!1,this._installResult="",this._isWarnOnCloseEnabled=!1,this.AddDOMMessageHandlers([["online-state",e=>this._OnOnlineStateChanged(e)],["backbutton",()=>this._OnBackButton()],["sw-message",e=>this._OnSWMessage(e)],["hashchange",e=>this._OnHashChange(e)],["install-available",()=>this._OnInstallAvailable()],["app-installed",e=>this._OnAppInstalled(e)]]);const s=this.GetRuntime().Dispatcher();this._disposables=new kA.CompositeDisposable(kA.Disposable.From(s,"afterfirstlayoutstart",()=>this._OnAfterFirstLayoutStart()),kA.Disposable.From(s,"window-resize",()=>this._OnWindowResize()),kA.Disposable.From(s,"window-focus",()=>this._OnWindowFocus()),kA.Disposable.From(s,"window-blur",()=>this._OnWindowBlur()),kA.Disposable.From(s,"suspend",()=>this._OnSuspend()),kA.Disposable.From(s,"resume",()=>this._OnResume())),this._runtime.AddLoadPromise(this.PostToDOMAsync("get-initial-state",{exportType:this._runtime.GetExportType()}).then(e=>{this._initLocationStr=e.location,this._isOnline=e.isOnline,this._referrer=e.referrer,this._docTitle=e.title,this._isCookieEnabled=e.isCookieEnabled,this._screenWidth=e.screenWidth,this._screenHeight=e.screenHeight,this._windowOuterWidth=e.windowOuterWidth,this._windowOuterHeight=e.windowOuterHeight,this._windowHasFocus=e.windowHasFocus,this._isConstructArcade=e.isConstructArcade}))}Release(){super.Release()}_OnAfterFirstLayoutStart(){this.PostToDOM("ready-for-sw-messages")}async _OnOnlineStateChanged(e){const t=!!e.isOnline;this._isOnline!==t&&(this._isOnline=t,this._isOnline?await this.TriggerAsync(kA.Plugins.Browser.Cnds.OnOnline):await this.TriggerAsync(kA.Plugins.Browser.Cnds.OnOffline))}async _OnWindowResize(){await this.TriggerAsync(kA.Plugins.Browser.Cnds.OnResize)}async _OnWindowFocus(){this._windowHasFocus=!0,await this.TriggerAsync(kA.Plugins.Browser.Cnds.OnWindowFocus)}async _OnWindowBlur(){this._windowHasFocus=!1,await this.TriggerAsync(kA.Plugins.Browser.Cnds.OnWindowBlur)}_OnSuspend(){this.Trigger(kA.Plugins.Browser.Cnds.OnPageHidden)}_OnResume(){this.Trigger(kA.Plugins.Browser.Cnds.OnPageVisible)}async _OnBackButton(){await this.TriggerAsync(kA.Plugins.Browser.Cnds.OnBackButton)}_OnSWMessage(e){const t=e.type;"downloading-update"===t?this.Trigger(kA.Plugins.Browser.Cnds.OnUpdateFound):"update-ready"===t||"update-pending"===t?this.Trigger(kA.Plugins.Browser.Cnds.OnUpdateReady):"offline-ready"===t&&this.Trigger(kA.Plugins.Browser.Cnds.OnOfflineReady)}_OnHashChange(e){this._initLocationStr=e.location,this.Trigger(kA.Plugins.Browser.Cnds.OnHashChange)}_OnInstallAvailable(){this._isInstallAvailable=!0,this.Trigger(kA.Plugins.Browser.Cnds.OnInstallAvailable)}_OnAppInstalled(e){this._isInstallAvailable=!1,this.Trigger(kA.Plugins.Browser.Cnds.OnAppInstalled)}_IsWarnOnCloseEnabled(){return this._isWarnOnCloseEnabled}_SetWarnOnCloseEnabled(e){e=!!e,this._isWarnOnCloseEnabled!==e&&(this._isWarnOnCloseEnabled=e,this.PostToDOM("set-warn-on-close",{enabled:e}))}GetDebuggerProperties(){const e="plugins.browser.debugger";return[{title:"plugins.browser.name",properties:[{name:e+".user-agent",value:navigator.userAgent},{name:e+".is-online",value:this._isOnline},{name:e+".is-fullscreen",value:this._runtime.GetCanvasManager().IsDocumentFullscreen()}]}]}}}{const UA=self.C3;UA.Plugins.Browser.Cnds={IsOnline(){return this._isOnline},OnOnline:()=>!0,OnOffline:()=>!0,OnResize:()=>!0,OnWindowFocus:()=>!0,OnWindowBlur:()=>!0,WindowHasFocus(){return this._windowHasFocus},CookiesEnabled(){return this._isCookieEnabled},IsFullscreen(){return this._runtime.GetCanvasManager().IsDocumentFullscreen()},OnBackButton:()=>!0,IsPortraitLandscape(e){return(this._runtime.GetCanvasManager().GetLastWidth()<=this._runtime.GetCanvasManager().GetLastHeight()?0:1)===e},OnUpdateFound:()=>!0,OnUpdateReady:()=>!0,OnOfflineReady:()=>!0,OnHashChange:()=>!0,OnInstallAvailable:()=>!0,IsInstallAvailable(){return this._isInstallAvailable},OnInstallResult(e){switch(e){case 0:return"accepted"===this._installResult;case 1:return"dismissed"===this._installResult;case 2:return"error"===this._installResult;case 3:return!0;default:return!1}},OnAppInstalled:()=>!0,CompareDisplayMode(e){const t=this._runtime.GetCanvasManager().GetCssDisplayMode();switch(e){case 0:return"browser"===t;case 1:return"minimal-ui"===t;case 2:return"standalone"===t;case 3:return"fullscreen"===t;default:return!1}},IsWarnOnCloseEnabled(){return this._IsWarnOnCloseEnabled()},PageVisible(){return!this._runtime.IsSuspended()},OnPageHidden:()=>!0,OnPageVisible:()=>!0,HasJava:()=>!1,IsDownloadingUpdate:()=>!1,OnMenuButton:()=>!1,OnSearchButton:()=>!1,IsMetered:()=>!1,IsCharging:()=>!0,SupportsFullscreen:()=>!0}}{const C3=self.C3,ORIENTATIONS=["portrait","landscape","portrait-primary","portrait-secondary","landscape-primary","landscape-secondary"];C3.Plugins.Browser.Acts={Alert(e){this.PostToDOM("alert",{message:e.toString()})},Close(){this._isConstructArcade||(this._runtime.IsDebug()?self.C3Debugger.CloseWindow():this.PostToDOM("close"))},Focus(){this.PostToDOM("set-focus",{isFocus:!0})},Blur(){this.PostToDOM("set-focus",{isFocus:!1})},GoBack(){this._isConstructArcade||this.PostToDOM("navigate",{type:"back"})},GoForward(){this._isConstructArcade||this.PostToDOM("navigate",{type:"forward"})},GoHome(){},Reload(){this._isConstructArcade||(this._runtime.IsDebug()?this._runtime.PostToDebugger({type:"reload"}):this.PostToDOM("navigate",{type:"reload"}))},GoToURL(e,t){this._PostToDOMMaybeSync("navigate",{type:"url",url:e,target:t,exportType:this._runtime.GetExportType()})},GoToURLWindow(e,t){this._PostToDOMMaybeSync("navigate",{type:"new-window",url:e,tag:t,exportType:this._runtime.GetExportType()})},RequestFullScreen(e,t){e>=2&&(e+=1),6===e&&(e=2),1===e&&(e=0);const s=C3.CanvasManager._FullscreenModeNumberToString(e);this._runtime.GetCanvasManager().SetDocumentFullscreenMode(s),this._PostToDOMMaybeSync("request-fullscreen",{navUI:t})},CancelFullScreen(){this._PostToDOMMaybeSync("exit-fullscreen")},Vibrate(e){const t=e.split(",");for(let e=0,s=t.length;e<s;++e)t[e]=parseInt(t[e],10);this._PostToDOMMaybeSync("vibrate",{pattern:t})},async InvokeDownload(e,t){if(!e||!t)return;const s=await this._runtime.GetAssetManager().GetProjectFileUrl(e);this._runtime.InvokeDownload(s,t)},InvokeDownloadString(e,t,s){if(!s)return;const i=`data:${t},${encodeURIComponent(e)}`;this._runtime.InvokeDownload(i,s)},ConsoleLog(e,t){t=t.toString(),0===e?console.log(t):1===e?console.warn(t):2===e&&console.error(t)},ConsoleGroup(e){console.group(e)},ConsoleGroupEnd(){console.groupEnd()},ExecJs(jsStr){try{eval(jsStr)}catch(e){console.error("Error executing JavaScript: ",e)}},LockOrientation(e){if((e=Math.floor(e))<0||e>=ORIENTATIONS.length)return;const t=ORIENTATIONS[e];this._PostToDOMMaybeSync("lock-orientation",{orientation:t})},UnlockOrientation(){this._PostToDOMMaybeSync("unlock-orientation")},LoadStyleSheet(e){this._runtime.GetAssetManager().LoadStyleSheet(e)},async SetDocumentCSSStyle(e,t,s,i){await this.PostToDOMAsync("set-document-css-style",{prop:C3.CSSToCamelCase(e),value:t,selector:s,"is-all":0!==i})},async GetDocumentCSSStyle(e,t,s){const i=await this.PostToDOMAsync("get-document-css-style",{prop:e,selector:t});i.isOk&&this._cssStyleMap.set(s.toLowerCase(),i.result.trim())},SetHash(e){this.PostToDOM("set-hash",{hash:e})},SetWindowSize(e,t){this.PostToDOM("set-window-size",{windowWidth:e,windowHeight:t})},SetWindowPosition(e,t){this.PostToDOM("set-window-position",{windowX:e,windowY:t})},async RequestInstall(){const e=await this.PostToDOMAsync("request-install");this._installResult=e.result,this.Trigger(C3.Plugins.Browser.Cnds.OnInstallResult)},SetWarnOnClose(e){this._SetWarnOnCloseEnabled(e)}}}{const C3=self.C3;C3.Plugins.Browser.Exps={URL(){return this._runtime.IsInWorker()?this._initLocationStr:location.toString()},Protocol(){return this._runtime.IsInWorker()?new URL(this._initLocationStr).protocol:location.protocol},Domain(){return this._runtime.IsInWorker()?new URL(this._initLocationStr).hostname:location.hostname},Port(){return this._runtime.IsInWorker()?new URL(this._initLocationStr).port:location.port},PathName(){return this._runtime.IsInWorker()?new URL(this._initLocationStr).pathname:location.pathname},Hash(){return this._runtime.IsInWorker()?new URL(this._initLocationStr).hash:location.hash},QueryString(){return this._runtime.IsInWorker()?new URL(this._initLocationStr).search:location.search},QueryParam(e){const t=this._runtime.IsInWorker()?new URL(this._initLocationStr).search:location.search,s=RegExp("[?&]"+e+"=([^&]*)").exec(t);return s?decodeURIComponent(s[1].replace(/\+/g," ")):""},Referrer(){return this._referrer},Title(){return this._docTitle},Language:()=>navigator.language,Platform:()=>navigator.platform,UserAgent:()=>navigator.userAgent,ExecJS(jsStr){let result=0;try{result=eval(jsStr)}catch(e){console.error("Error executing JavaScript: ",e)}return"number"==typeof result||"string"==typeof result?result:"boolean"==typeof result&&result?1:0},CSSStyleValue(e){return this._cssStyleMap.get(e)||""},Name:()=>navigator.appName,Version:()=>navigator.appVersion,Product:()=>navigator.product,Vendor:()=>navigator.vendor,BatteryLevel:()=>1,BatteryTimeLeft:()=>1/0,Bandwidth(){const e=navigator.connection;return e&&(e.downlink||e.downlinkMax||e.bandwidth)||1/0},ConnectionType(){const e=navigator.connection;return e&&e.type||"unknown"},DevicePixelRatio:()=>self.devicePixelRatio,ScreenWidth(){return this._screenWidth},ScreenHeight(){return this._screenHeight},WindowInnerWidth(){return this._runtime.GetCanvasManager().GetLastWidth()},WindowInnerHeight(){return this._runtime.GetCanvasManager().GetLastHeight()},WindowOuterWidth(){return this._windowOuterWidth},WindowOuterHeight(){return this._windowOuterWidth},DisplayMode(){return this._runtime.GetCanvasManager().GetCssDisplayMode()},InstallResult(){return this._installResult}}}{let WA=function(e){e&&e.close&&e.close()};MaybeCloseImageBitmap=WA;const HA=self.C3,zA="video";HA.Plugins.video=class extends HA.SDKDOMPluginBase{constructor(e){super(e,zA),this._postImageBitmaps=!1,this._supportedFormats={},this._lastStateSequenceNumber=-1,this._videoState=new Map,this._runtime.AddLoadPromise(this._runtime.PostComponentMessageToDOMAsync("video","init",{isInWorker:this._runtime.IsInWorker()}).then(e=>{this._postImageBitmaps=e.postImageBitmaps,this._supportedFormats=e.supportedFormats})),this.AddElementMessageHandler("playback-event",(e,t)=>e._OnPlaybackEvent(t)),this._runtime.AddDOMComponentMessageHandler(zA,"state",e=>this._OnUpdateState(e))}Release(){super.Release()}IsPostImageBitmapsMode(){return this._postImageBitmaps}IsFormatSupported(e){return!!this._supportedFormats[e]}_OnUpdateState(e){const t=e.sequenceNumber;if(t<=this._lastStateSequenceNumber)for(const t of Object.values(e.videoData))WA(t.imageBitmap);else{this._lastStateSequenceNumber=t;for(const e of this._videoState.values())WA(e.imageBitmap);this._videoState.clear();for(const[t,s]of Object.entries(e.videoData))this._videoState.set(parseInt(t,10),s)}}_DeleteVideoState(e){this._videoState.delete(e)}GetVideoState(e){return this._videoState.get(e)||null}}}{const jA=self.C3;jA.Plugins.video.Type=class extends jA.SDKTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const YA=self.C3,qA=YA.New(YA.Rect),XA=YA.New(YA.Quad),$A="video",KA=["webm-vp8","webm-vp9","webm-av1","mp4-h264","mp4-h265","mp4-av1"];YA.Plugins.video.Instance=class extends YA.SDKDOMInstanceBase{constructor(e,t){super(e,$A),this._primarySrc="",this._primaryFormat="mp4-h264",this._secondarySrc="",this._secondaryFormat="webm-vp9",this._autoplay=2,this._playInBackground=!1,this._videoWasPlayingOnSuspend=!1,this._webGLTexture=null,this._currentTrigger=-1,this._isSettingSource=0,this._isPlaying=!1,this._isPaused=!1,this._hasEnded=!1,this._isLooping=!1,this._isMuted=!1,this._volume=0,t&&(this._primarySrc=t[0],this._primaryFormat=KA[t[1]],this._secondarySrc=t[2],this._secondaryFormat=KA[t[3]],this._autoplay=t[4],this._playInBackground=t[5],this.GetWorldInfo().SetVisible(t[6]));const s=this._runtime.Dispatcher();this._disposables=new YA.CompositeDisposable(YA.Disposable.From(s,"renderercontextlost",()=>this._OnRendererContextLost()),YA.Disposable.From(s,"suspend",()=>this._OnSuspend()),YA.Disposable.From(s,"resume",()=>this._OnResume())),this.CreateElement({src:this.GetVideoSource(),autoplay:this._autoplay})}Release(){this.GetPlugin()._DeleteVideoState(this.GetElementId()),this._ReleaseTexture(),super.Release()}_MaybeCreateTexture(e,t,s){if(this._webGLTexture){if(this._webGLTexture.GetWidth()===t||this._webGLTexture.GetHeight()===s)return;this._ReleaseTexture()}this._webGLTexture=e.CreateDynamicTexture(t,s,{sampling:this._runtime.GetSampling(),mipMap:!1})}_ReleaseTexture(){this._webGLTexture&&(this._runtime.GetRenderer().DeleteTexture(this._webGLTexture),this._webGLTexture=null)}GetElementState(){return{}}DbToLinearNoCap(e){return Math.pow(10,e/20)}DbToLinear(e){const t=this.DbToLinearNoCap(e);return isFinite(t)?Math.max(Math.min(t,1),0):0}LinearToDbNoCap(e){return Math.log(e)/Math.log(10)*20}LinearToDb(e){return this.LinearToDbNoCap(Math.max(Math.min(e,1),0))}GetVideoSource(){let e="";const t=this.GetPlugin();return t.IsFormatSupported(this._primaryFormat)&&this._primarySrc?e=this._primarySrc:t.IsFormatSupported(this._secondaryFormat)&&this._secondarySrc&&(e=this._secondarySrc),e&&YA.IsRelativeURL(e)?this._runtime.GetAssetManager().GetMediaFileUrl(e):e}_OnRendererContextLost(){this._webGLTexture=null}async _OnPlaybackEvent(e){const t=e.type;5===t?this._SetIsPlaying(!0):2===t?(this._SetIsPlaying(!1),this._hasEnded=!0,this._isPaused=!1):6===t&&(this._SetIsPlaying(!1),this._isPaused=!0,this._hasEnded=!1),this._currentTrigger=t,await this.TriggerAsync(YA.Plugins.video.Cnds.OnPlaybackEvent)}_SetIsPlaying(e){this._isPlaying=!!e,this._isPlaying?(this._StartTicking(),this._isPaused=!1,this._hasEnded=!1):this._StopTicking()}_OnSuspend(){this._playInBackground||this._isPlaying&&(this._videoWasPlayingOnSuspend=!0,this.PostToDOMElement("pause"))}_OnResume(){this._playInBackground||this._videoWasPlayingOnSuspend&&(this.PostToDOMElement("play"),this._videoWasPlayingOnSuspend=!1)}Draw(e){const t=this.GetWorldInfo();let s=0,i=0,r=null;const n=this.GetPlugin().IsPostImageBitmapsMode();if(n){const e=this.GetMyState();if(!e)return;r=e.imageBitmap,e.imageBitmap=null,s=e.videoWidth,i=e.videoHeight}else{const e=self.C3Video_GetElement(this.GetElementId());if(!e)return;s=e.videoWidth,i=e.videoHeight,r=e}if(s<=0||i<=0)return;this._MaybeCreateTexture(e,s,i),r&&(e.UpdateTexture(r,this._webGLTexture),n&&r.close&&r.close());const a=s/i,o=t.GetWidth(),l=t.GetHeight();let h=0,u=0,c=0,d=0;o/l>a?(c=l*a,d=l,h=Math.max(Math.floor((o-c)/2),0)):(c=o,d=o/a,u=Math.max(Math.floor((l-d)/2),0)),e.SetTexture(this._webGLTexture),qA.setWH(t.GetX()+h,t.GetY()+u,c,d),XA.setFromRect(qA),e.Quad(XA)}Tick(){this._runtime.UpdateRender()}GetMyState(){return this.GetPlugin().GetVideoState(this.GetElementId())}}}self.C3.Plugins.video.Cnds={IsPlaying(){return this._isPlaying},IsPaused(){return this._isPaused},HasEnded(){return this._hasEnded},IsMuted(){return this._isMuted},OnPlaybackEvent(e){return this._currentTrigger===e}};{const JA=self.C3,QA=["webm-vp8","webm-vp9","webm-av1","mp4-h264","mp4-h265","mp4-av1"];JA.Plugins.video.Acts={SetSource(e,t){this._primarySrc=e,this._primaryFormat="webm-vp8",this._secondarySrc=t,this._secondaryFormat="mp4-h264",this.PostToDOMElement("set-source",{src:this.GetVideoSource()}),this._ReleaseTexture()},SetSource2(e,t,s,i){this._primarySrc=e,this._primaryFormat=QA[t],this._secondarySrc=s,this._secondaryFormat=QA[i],this.PostToDOMElement("set-source",{src:this.GetVideoSource()}),this._ReleaseTexture()},SetPlaybackTime(e){this.PostToDOMElement("set-playback-time",{time:e})},SetPlaybackRate(e){this.PostToDOMElement("set-playback-rate",{rate:e})},SetLooping(e){e=0!==e,this._isLooping!==e&&(this._isLooping=e,this.PostToDOMElement("set-looping",{isLooping:e}))},SetMuted(e){e=0!==e,this._isMuted!==e&&(this._isMuted=e,this.PostToDOMElement("set-muted",{isMuted:e}))},SetVolume(e){this._volume!==e&&(this._volume=e,this.PostToDOMElement("set-volume",{volume:this.DbToLinear(e)}))},Pause(){this.PostToDOMElement("pause")},Play(){this._PostToDOMElementMaybeSync("play")}}}self.C3.Plugins.video.Exps={PlaybackTime(){const e=this.GetMyState();return e?e.currentTime:0},PlaybackRate(){const e=this.GetMyState();return e?e.playbackRate:1},Duration(){const e=this.GetMyState();return e?e.duration:0},Volume(){return this._volume},VideoWidth(){const e=this.GetMyState();return e?e.videoWidth:0},VideoHeight(){const e=this.GetMyState();return e?e.videoHeight:0}};{const ZA=self.C3,eR=[];ZA.Plugins.Audio=class extends ZA.SDKPluginBase{constructor(e){super(e)}_AddActionPromise(e){eR.push(e)}static async WaitForAllActionPromises(){await Promise.all(eR),ZA.clearArray(eR)}Release(){super.Release()}}}{let tR=function(){return nR.GetSingleGlobalInstance().GetSdkInstance()},sR=function(){if(self.C3Audio_DOMInterface)return self.C3Audio_DOMInterface;throw new Error("audio scripting API cannot be used here - make sure the project is using DOM mode, not worker mode")};GetAudioSdkInstance=tR,GetAudioDOMInterface=sR;const iR=self.C3,rR=self.C3X;iR.Plugins.Audio.Type=class extends iR.SDKTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}GetScriptInterfaceClass(){return self.IAudioObjectType}};let nR=null;self.IAudioObjectType=class extends self.IObjectType{constructor(e){super(e),nR=e}get audioContext(){return sR().GetAudioContextExtern()}get destinationNode(){return sR().GetDestinationNodeExtern()}get isSilent(){return tR()._IsSilent()}set isSilent(e){tR()._SetSilent(e)}get masterVolume(){return tR()._GetMasterVolume()}set masterVolume(e){rR.RequireFiniteNumber(e),tR()._SetMasterVolume(e)}stopAll(){tR()._StopAll()}}}{const aR=self.C3,oR="audio",lR=["interactive","balanced","playback"];aR.Plugins.Audio.Instance=class extends aR.SDKInstanceBase{constructor(e,t){super(e,oR),this._nextPlayTime=0,this._nextPlayOffset=0,this._triggerTags=[],this._enableMultiTags=!0,this._timeScaleMode=0,this._saveLoadMode=0,this._playInBackground=!1,this._panningModel=1,this._distanceModel=1,this._listenerPos=[this._runtime.GetViewportWidth()/2,this._runtime.GetViewportHeight()/2,600],this._listenerForwardVec=[0,0,-1],this._listenerUpVec=[0,1,0],this._referenceDistance=600,this._maxDistance=1e4,this._rolloffFactor=1,this._listenerInst=null,this._loadListenerUid=-1,this._masterVolume=1,this._isSilent=!1,this._sampleRate=0,this._audioContextState="suspended",this._outputLatency=0,this._effectCount=new Map,this._preloadTotal=0,this._preloadCount=0,this._bufferMetadata=new Map,this._remoteUrls=new Map;let s="interactive";t&&(this._timeScaleMode=t[0],this._saveLoadMode=t[1],this._playInBackground=t[2],s=lR[t[3]],this._enableMultiTags=t[4],this._panningModel=t[5],this._distanceModel=t[6],this._listenerPos[2]=t[7],this._referenceDistance=t[8],this._maxDistance=t[9],this._rolloffFactor=t[10]),this._lastAIState=[],this._lastFxState=[],this._lastAnalysersData=[],this.AddDOMMessageHandlers([["state",e=>this._OnUpdateState(e)],["audiocontext-state",e=>this._OnAudioContextStateChanged(e)],["fxstate",e=>this._OnUpdateFxState(e)],["trigger",e=>this._OnTrigger(e)],["buffer-metadata",e=>this._OnBufferMetadata(e)]]);const i=this.GetRuntime().Dispatcher();this._disposables=new aR.CompositeDisposable(aR.Disposable.From(i,"instancedestroy",e=>this._OnInstanceDestroyed(e.instance)),aR.Disposable.From(i,"afterload",()=>this._OnAfterLoad()),aR.Disposable.From(i,"suspend",()=>this._OnSuspend()),aR.Disposable.From(i,"resume",()=>this._OnResume()));const r=this._runtime.GetExportType(),n="Safari"===aR.Platform.Browser,a=this._runtime.IsiOSWebView()||"macos-wkwebview"===r,o=this._runtime.GetAssetManager().IsFileProtocol(),l="playable-ad-single-file"===r,h="cordova"===r&&"Android"===aR.Platform.OS,u=n||a||o||l||h;this._runtime.AddLoadPromise(this.PostToDOMAsync("create-audio-context",{preloadList:this._runtime.GetAssetManager().GetAudioToPreload().map(e=>({originalUrl:e.originalUrl,url:e.url,type:e.type,fileSize:e.fileSize})),timeScaleMode:this._timeScaleMode,latencyHint:s,panningModel:this._panningModel,distanceModel:this._distanceModel,refDistance:this._referenceDistance,maxDistance:this._maxDistance,rolloffFactor:this._rolloffFactor,listenerPos:this._listenerPos,usePlayMusicAsSoundWorkaround:u}).then(e=>{this._sampleRate=e.sampleRate,this._audioContextState=e.audioContextState,this._outputLatency=e.outputLatency})),this._StartTicking()}Release(){this._listenerInst=null,super.Release()}_SplitTags(e){return this._enableMultiTags?e.split(" ").filter(e=>!!e):e?[e]:[]}_MatchTagLists(e,t){for(const s of t){let t=!1;for(const i of e)if(aR.equalsNoCase(i,s)){t=!0;break}if(!t)return!1}return!0}_MatchTagListToStr(e,t){return this._MatchTagLists(e,this._SplitTags(t))}_AddActionPromise(e){this.GetPlugin()._AddActionPromise(e)}_OnInstanceDestroyed(e){this._listenerInst===e&&(this._listenerInst=null)}DbToLinearNoCap(e){return Math.pow(10,e/20)}DbToLinear(e){const t=this.DbToLinearNoCap(e);return isFinite(t)?Math.max(Math.min(t,1),0):0}LinearToDbNoCap(e){return Math.log(e)/Math.log(10)*20}LinearToDb(e){return this.LinearToDbNoCap(Math.max(Math.min(e,1),0))}_GetScheduledPlayInfo(){let e=0;const t=!!self.C3_GetAudioContextCurrentTime;return e=t?this._nextPlayTime:this._nextPlayOffset,this._nextPlayTime=0,this._nextPlayOffset=0,{playOffset:e,isTrueClock:t}}_OnSuspend(){this._playInBackground||this.PostToDOM("set-suspended",{isSuspended:!0})}_OnResume(){this._playInBackground||this.PostToDOM("set-suspended",{isSuspended:!1})}_OnUpdateState(e){const t=e.tickCount;this._outputLatency=e.outputLatency;const s=this._lastAIState.filter(e=>e.hasOwnProperty("placeholder")&&(e.placeholder>t||-1===e.placeholder));this._lastAIState=e.audioInstances,this._lastAnalysersData=e.analysers,s.length>0&&aR.appendArray(this._lastAIState,s)}_OnBufferMetadata(e){this._bufferMetadata.set(e.originalUrl,{duration:e.duration})}_OnAudioContextStateChanged(e){this._audioContextState=e.audioContextState}GetAudioContextState(){return this._runtime.IsExportToVideo()?"running":this._audioContextState}_OnUpdateFxState(e){this._lastFxState=e.fxstate}_GetFirstAudioStateByTags(e){const t=this._SplitTags(e);for(const e of this._lastAIState)if(this._MatchTagLists(e.tags,t))return e;return null}_IsTagPlaying(e){const t=this._SplitTags(e);return this._lastAIState.some(e=>this._MatchTagLists(e.tags,t)&&e.isPlaying)}_MaybeMarkAsPlaying(e,t,s,i,r){if(this._IsTagPlaying(t))return null;const n=this._bufferMetadata.get(e),a={tags:this._SplitTags(t),duration:n?n.duration:0,volume:r,isPlaying:!0,playbackTime:0,playbackRate:1,uid:-1,bufferOriginalUrl:e,bufferUrl:"",bufferType:"",isMusic:s,isLooping:i,isMuted:!1,resumePosition:0,pan:null,placeholder:-1};return this._lastAIState.push(a),a}_MaybeMarkAsStopped(e){const t=this._SplitTags(e);for(const e of this._lastAIState)this._MatchTagLists(e.tags,t)&&(e.isPlaying=!1)}async _OnTrigger(e){const t=e.type;this._triggerTags=e.tags;const s=e.aiid;if("ended"===t){for(const e of this._lastAIState)if(e.aiid===s){e.isPlaying=!1;break}await this.TriggerAsync(aR.Plugins.Audio.Cnds.OnEnded)}else"fade-ended"===t&&await this.TriggerAsync(aR.Plugins.Audio.Cnds.OnFadeEnded)}_MatchTriggerTag(e){return this._MatchTagListToStr(this._triggerTags,e)}Tick(){const e={timeScale:this._runtime.GetTimeScale(),gameTime:this._runtime.GetGameTimeRaw(),instPans:this.GetInstancePans(),tickCount:this._runtime.GetTickCountNoSave()};if(this._listenerInst){const t=this._listenerInst.GetWorldInfo();this._listenerPos[0]=t.GetX(),this._listenerPos[1]=t.GetY(),e.listenerPos=this._listenerPos,e.listenerOrientation=[...this._listenerForwardVec,...this._listenerUpVec]}this.PostToDOM("tick",e)}rotatePtAround(e,t,s,i,r){if(0===s)return[e,t];const n=Math.sin(s),a=Math.cos(s),o=(e-=i)*n;return e=e*a-(t-=r)*n,t=t*a+o,[e+=i,t+=r]}GetInstancePans(){return this._lastAIState.filter(e=>-1!==e.uid).map(e=>this._runtime.GetInstanceByUID(e.uid)).filter(e=>e).map(e=>{const t=e.GetWorldInfo(),s=t.GetLayer().GetAngle(),[i,r]=this.rotatePtAround(t.GetX(),t.GetY(),-s,this._listenerPos[0],this._listenerPos[1]);return{uid:e.GetUID(),x:i,y:r,z:t.GetTotalZElevation(),angle:t.GetAngle()-s}})}GetAnalyserData(e,t){for(const s of this._lastAnalysersData)if(s.index===t&&aR.equalsNoCase(s.tag,e))return s;return null}_IncrementEffectCount(e){for(const t of this._SplitTags(e)){const e=t.toLowerCase();this._effectCount.set(e,(this._effectCount.get(e)||0)+1)}}_IsSilent(){return this._isSilent}_SetSilent(e){e=!!e,this._isSilent!==e&&(this._isSilent=e,this.PostToDOM("set-silent",{isSilent:e}))}_GetMasterVolume(){return this._masterVolume}_SetMasterVolume(e){this._masterVolume!==e&&(this._masterVolume=e,this.PostToDOM("set-master-volume",{vol:e}))}_StopAll(){this.PostToDOM("stop-all");for(const e of this._lastAIState)e.isPlaying=!1}_ShouldSave(e){return!(e.hasOwnProperty("placeholder")||3===this._saveLoadMode||e.isMusic&&1===this._saveLoadMode||!e.isMusic&&2===this._saveLoadMode)}SaveToJson(){return{isSilent:this._isSilent,masterVolume:this._masterVolume,listenerZ:this._listenerPos[2],listenerForwardVec:this._listenerForwardVec,listenerUpVec:this._listenerUpVec,listenerUid:this._listenerInst?this._listenerInst.GetUID():-1,remoteUrls:[...this._remoteUrls.entries()],playing:this._lastAIState.filter(e=>this._ShouldSave(e)),effects:this._lastFxState,analysers:this._lastAnalysersData}}LoadFromJson(e){if(this._isSilent=e.isSilent,this._masterVolume=e.masterVolume,this._listenerPos[2]=e.listenerZ,this._listenerInst=null,this._loadListenerUid=e.listenerUid,e.hasOwnProperty("listenerForwardVec")?this._listenerForwardVec=e.listenerForwardVec:this._listenerForwardVec=[0,0,-1],e.hasOwnProperty("listenerUpVec")?this._listenerUpVec=e.listenerUpVec:this._listenerUpVec=[0,1,0],this._remoteUrls.clear(),e.remoteUrls)for(const[t,s]of e.remoteUrls)this._remoteUrls.set(t,s);this._lastAIState=e.playing;for(const e of this._lastAIState)e.hasOwnProperty("tag")&&!e.hasOwnProperty("tags")&&(e.tags=[e.tag].filter(e=>!!e));this._lastFxState=e.effects,this._lastAnalysersData=e.analysers}_OnAfterLoad(){if(-1!==this._loadListenerUid&&(this._listenerInst=this._runtime.GetInstanceByUID(this._loadListenerUid),this._loadListenerUid=-1,this._listenerInst)){const e=this._listenerInst.GetWorldInfo();this._listenerPos[0]=e.GetX(),this._listenerPos[1]=e.GetY()}for(const e of this._lastAIState){const t=this._runtime.GetAssetManager().GetProjectAudioFileUrl(e.bufferOriginalUrl);t?(e.bufferUrl=t.url,e.bufferType=t.type):e.bufferUrl=null}for(const e of Object.values(this._lastFxState))for(const t of e)if(t.hasOwnProperty("bufferOriginalUrl")){const e=this._runtime.GetAssetManager().GetProjectAudioFileUrl(t.bufferOriginalUrl);e&&(t.bufferUrl=e.url,t.bufferType=e.type)}this.PostToDOM("load-state",{saveLoadMode:this._saveLoadMode,timeScale:this._runtime.GetTimeScale(),gameTime:this._runtime.GetGameTimeRaw(),listenerPos:this._listenerPos,listenerOrientation:[...this._listenerForwardVec,...this._listenerUpVec],isSilent:this._isSilent,masterVolume:this._masterVolume,playing:this._lastAIState.filter(e=>null!==e.bufferUrl),effects:this._lastFxState})}GetDebuggerProperties(){const e=[];for(const[t,s]of Object.entries(this._lastFxState))e.push({name:"$"+t,value:s.map(e=>e.type).join(", ")});const t="plugins.audio.debugger";return[{title:t+".tag-effects",properties:e},{title:t+".currently-playing",properties:[{name:t+".currently-playing-count",value:this._lastAIState.length},...this._lastAIState.map((e,t)=>({name:"$#"+t,value:`${e.bufferOriginalUrl} ("${e.tags}") ${Math.round(10*e.playbackTime)/10} / ${Math.round(10*e.duration)/10}`}))]}]}}}self.C3.Plugins.Audio.Cnds={OnEnded(e){return this._MatchTriggerTag(e)},OnFadeEnded(e){return this._MatchTriggerTag(e)},PreloadsComplete(){return this._preloadCount===this._preloadTotal},AdvancedAudioSupported:()=>!0,IsSilent(){return this._IsSilent()},IsAnyPlaying(){for(const e of this._lastAIState)if(e.isPlaying)return!0;return!1},IsTagPlaying(e){return this._IsTagPlaying(e)}};{const hR=self.C3,uR=["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"];hR.Plugins.Audio.Acts={Play(e,t,s,i,r){const n=hR.Plugins.Audio.Acts._DoPlay.call(this,e,t,s,i,r);return this._AddActionPromise(n),n},PlayFromTimeline(e,t,s,i){hR.Plugins.Audio.Acts._DoPlay.call(this,e,0,t,0,s,i)},async _DoPlay(e,t,s,i,r,n){if(this._isSilent)return;const a=e[1],o=this._runtime.GetAssetManager().GetProjectAudioFileUrl(e[0]);if(!o)return;const{playOffset:l,isTrueClock:h}=this._GetScheduledPlayInfo(),u=this._MaybeMarkAsPlaying(e[0],r,a,0!==t,this.DbToLinear(s));try{await this.PostToDOMAsync("play",{originalUrl:e[0],url:o.url,type:o.type,isMusic:a,tags:this._SplitTags(r),isLooping:0!==t,vol:this.DbToLinear(s),stereoPan:hR.clamp(i/100,-1,1),pos:n||0,off:l,trueClock:h})}finally{u&&(u.placeholder=this._runtime.GetTickCountNoSave())}},async PlayAtPosition(e,t,s,i,r,n,a,o,l,h,u){if(this._isSilent)return;const c=e[1],d=this._runtime.GetAssetManager().GetProjectAudioFileUrl(e[0]);if(!d)return;const{playOffset:p,isTrueClock:_}=this._GetScheduledPlayInfo(),m=this._MaybeMarkAsPlaying(e[0],u,c,0!==t,this.DbToLinear(s));try{await this.PostToDOMAsync("play",{originalUrl:e[0],url:d.url,type:d.type,isMusic:c,tags:this._SplitTags(u),isLooping:0!==t,vol:this.DbToLinear(s),pos:0,off:p,trueClock:_,panning:{x:i,y:r,z:n,angle:hR.toRadians(a),innerAngle:hR.toRadians(o),outerAngle:hR.toRadians(l),outerGain:this.DbToLinear(h)}})}finally{m&&(m.placeholder=this._runtime.GetTickCountNoSave())}},async PlayAtObject(e,t,s,i,r,n,a,o){if(this._isSilent)return;if(!i)return;const l=i.GetFirstPicked();if(!l||!l.GetWorldInfo())return;const h=l.GetWorldInfo(),u=h.GetLayer().GetAngle(),[c,d]=this.rotatePtAround(h.GetX(),h.GetY(),-u,this._listenerPos[0],this._listenerPos[1]),p=e[1],_=this._runtime.GetAssetManager().GetProjectAudioFileUrl(e[0]);if(!_)return;const{playOffset:m,isTrueClock:f}=this._GetScheduledPlayInfo(),g=this._MaybeMarkAsPlaying(e[0],o,p,0!==t,this.DbToLinear(s));try{await this.PostToDOMAsync("play",{originalUrl:e[0],url:_.url,type:_.type,isMusic:p,tags:this._SplitTags(o),isLooping:0!==t,vol:this.DbToLinear(s),pos:0,off:m,trueClock:f,panning:{x:c,y:d,z:h.GetTotalZElevation(),angle:h.GetAngle()-u,innerAngle:hR.toRadians(r),outerAngle:hR.toRadians(n),outerGain:this.DbToLinear(a),uid:l.GetUID()}})}finally{g&&(g.placeholder=this._runtime.GetTickCountNoSave())}},async PlayByName(e,t,s,i,r,n){if(this._isSilent)return;const a=1===e,o=this._runtime.GetAssetManager().GetProjectAudioFileUrl(t)||this._remoteUrls.get(t.toLowerCase());if(!o)return;const{playOffset:l,isTrueClock:h}=this._GetScheduledPlayInfo(),u=this._MaybeMarkAsPlaying(t,n,a,0!==s,this.DbToLinear(i));try{await this.PostToDOMAsync("play",{originalUrl:t,url:o.url,type:o.type,isMusic:a,tags:this._SplitTags(n),isLooping:0!==s,vol:this.DbToLinear(i),stereoPan:hR.clamp(r/100,-1,1),pos:0,off:l,trueClock:h})}finally{u&&(u.placeholder=this._runtime.GetTickCountNoSave())}},async PlayAtPositionByName(e,t,s,i,r,n,a,o,l,h,u,c){if(this._isSilent)return;const d=1===e,p=this._runtime.GetAssetManager().GetProjectAudioFileUrl(t)||this._remoteUrls.get(t.toLowerCase());if(!p)return;const{playOffset:_,isTrueClock:m}=this._GetScheduledPlayInfo(),f=this._MaybeMarkAsPlaying(t,c,d,0!==s,this.DbToLinear(i));try{await this.PostToDOMAsync("play",{originalUrl:t,url:p.url,type:p.type,isMusic:d,tags:this._SplitTags(c),isLooping:0!==s,vol:this.DbToLinear(i),pos:0,off:_,trueClock:m,panning:{x:r,y:n,z:a,angle:hR.toRadians(o),innerAngle:hR.toRadians(l),outerAngle:hR.toRadians(h),outerGain:this.DbToLinear(u)}})}finally{f&&(f.placeholder=this._runtime.GetTickCountNoSave())}},async PlayAtObjectByName(e,t,s,i,r,n,a,o,l){if(this._isSilent)return;if(this._isSilent)return;if(!r)return;const h=r.GetFirstPicked();if(!h||!h.GetWorldInfo())return;const u=h.GetWorldInfo(),c=u.GetLayer().GetAngle(),[d,p]=this.rotatePtAround(u.GetX(),u.GetY(),-c,this._listenerPos[0],this._listenerPos[1]),_=1===e,m=this._runtime.GetAssetManager().GetProjectAudioFileUrl(t)||this._remoteUrls.get(t.toLowerCase());if(!m)return;const{playOffset:f,isTrueClock:g}=this._GetScheduledPlayInfo(),y=this._MaybeMarkAsPlaying(t,l,_,0!==s,this.DbToLinear(i));try{await this.PostToDOMAsync("play",{originalUrl:t,url:m.url,type:m.type,isMusic:_,tags:this._SplitTags(l),isLooping:0!==s,vol:this.DbToLinear(i),pos:0,off:f,trueClock:g,panning:{x:d,y:p,z:u.GetTotalZElevation(),angle:u.GetAngle()-c,innerAngle:hR.toRadians(n),outerAngle:hR.toRadians(a),outerGain:this.DbToLinear(o),uid:h.GetUID()}})}finally{y&&(y.placeholder=this._runtime.GetTickCountNoSave())}},SetLooping(e,t){this.PostToDOM("set-looping",{tags:this._SplitTags(e),isLooping:0===t})},SetMuted(e,t){this.PostToDOM("set-muted",{tags:this._SplitTags(e),isMuted:0===t})},SetVolume(e,t){this.PostToDOM("set-volume",{tags:this._SplitTags(e),vol:this.DbToLinear(t)})},FadeVolume(e,t,s,i){this.PostToDOM("fade-volume",{tags:this._SplitTags(e),vol:this.DbToLinear(t),duration:s,stopOnEnd:0===i})},SetStereoPan(e,t){this.PostToDOM("set-stereo-pan",{tags:this._SplitTags(e),p:hR.clamp(t/100,-1,1)})},async Preload(e){const t=e[1],s=this._runtime.GetAssetManager().GetProjectAudioFileUrl(e[0]);s&&(this._preloadTotal++,await this.PostToDOMAsync("preload",{originalUrl:e[0],url:s.url,type:s.type,isMusic:t}),this._preloadCount++)},async PreloadByName(e,t){const s=1===e,i=this._runtime.GetAssetManager().GetProjectAudioFileUrl(t)||this._remoteUrls.get(t.toLowerCase());i&&(this._preloadTotal++,await this.PostToDOMAsync("preload",{originalUrl:t,url:i.url,type:i.type,isMusic:s}),this._preloadCount++)},SetPlaybackRate(e,t){this.PostToDOM("set-playback-rate",{tags:this._SplitTags(e),rate:Math.max(t,0)})},Stop(e){this._MaybeMarkAsStopped(e),this.PostToDOM("stop",{tags:this._SplitTags(e)})},StopAll(){this._StopAll()},SetPaused(e,t){this.PostToDOM("set-paused",{tags:this._SplitTags(e),paused:0===t})},Seek(e,t){this.PostToDOM("seek",{tags:this._SplitTags(e),pos:t})},SetSilent(e){2===e&&(e=this._IsSilent()?1:0),this._SetSilent(0===e)},SetMasterVolume(e){const t=this.DbToLinear(e);this._SetMasterVolume(t)},AddFilterEffect(e,t,s,i,r,n,a){const o=uR[t];this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"filter",tags:this._SplitTags(e),params:[o,s,i,r,n,hR.clamp(a/100,0,1)]})},AddDelayEffect(e,t,s,i){this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"delay",tags:this._SplitTags(e),params:[t,this.DbToLinear(s),hR.clamp(i/100,0,1)]})},AddFlangerEffect(e,t,s,i,r,n){this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"flanger",tags:this._SplitTags(e),params:[t/1e3,s/1e3,i,r/100,hR.clamp(n/100,0,1)]})},AddPhaserEffect(e,t,s,i,r,n,a){this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"phaser",tags:this._SplitTags(e),params:[t,s,i,r,n,hR.clamp(a/100,0,1)]})},AddConvolutionEffect(e,t,s,i){const r=this._runtime.GetAssetManager().GetProjectAudioFileUrl(t[0]);r&&(this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"convolution",tags:this._SplitTags(e),bufferOriginalUrl:t[0],bufferUrl:r.url,bufferType:r.type,params:[0===s,hR.clamp(i/100,0,1)]}))},AddGainEffect(e,t){this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"gain",tags:this._SplitTags(e),params:[this.DbToLinear(t)]})},AddStereoPanEffect(e,t){this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"stereopan",tags:this._SplitTags(e),params:[hR.clamp(t/100,-1,1)]})},AddMuteEffect(e){this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"gain",tags:this._SplitTags(e),params:[0]})},AddTremoloEffect(e,t,s){this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"tremolo",tags:this._SplitTags(e),params:[t,hR.clamp(s/100,0,1)]})},AddRingModEffect(e,t,s){this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"ringmod",tags:this._SplitTags(e),params:[t,hR.clamp(s/100,0,1)]})},AddDistortionEffect(e,t,s,i,r,n){this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"distortion",tags:this._SplitTags(e),params:[this.DbToLinearNoCap(t),this.DbToLinearNoCap(s),i,this.DbToLinearNoCap(r),hR.clamp(n/100,0,1)]})},AddCompressorEffect(e,t,s,i,r,n){this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"compressor",tags:this._SplitTags(e),params:[t,s,i,r/1e3,n/1e3]})},AddAnalyserEffect(e,t,s){this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"analyser",tags:this._SplitTags(e),params:[t,s]})},RemoveEffects(e){const t=this._SplitTags(e);for(const e of t)this._effectCount.set(e.toLowerCase(),0);this.PostToDOM("remove-effects",{tags:t}),this._lastFxState={}},SetEffectParameter(e,t,s,i,r,n){this.PostToDOM("set-effect-param",{tags:this._SplitTags(e),index:Math.floor(t),param:s,value:i,ramp:r,time:n})},SetListenerObject(e){if(!e)return;const t=e.GetFirstPicked();t&&t.GetWorldInfo()&&(this._listenerInst=t)},SetListenerZ(e){this._listenerPos[2]=e},SetListenerOrientation(e,t,s,i,r,n){this._listenerForwardVec[0]=e,this._listenerForwardVec[1]=t,this._listenerForwardVec[2]=-s,this._listenerUpVec[0]=i,this._listenerUpVec[1]=r,this._listenerUpVec[2]=-n},ScheduleNextPlay(e){this._nextPlayTime=Math.max(e,0),this._nextPlayOffset=Math.max(e-performance.now()/1e3,0)},UnloadAudio(e){const t=e[1],s=this._runtime.GetAssetManager().GetProjectAudioFileUrl(e[0]);s&&this.PostToDOM("unload",{url:s.url,type:s.type,isMusic:t})},UnloadAudioByName(e,t){const s=1===e,i=this._runtime.GetAssetManager().GetProjectAudioFileUrl(t)||this._remoteUrls.get(t.toLowerCase());i&&this.PostToDOM("unload",{url:i.url,type:i.type,isMusic:s})},UnloadAll(){this.PostToDOM("unload-all")},AddRemoteURL(e,t,s){this._remoteUrls.set(s.toLowerCase(),{url:e,type:t})}}}{const cR=self.C3;cR.Plugins.Audio.Exps={Duration(e){const t=this._GetFirstAudioStateByTags(e);return t?t.duration:0},PlaybackTime(e){const t=this._GetFirstAudioStateByTags(e);return t?t.playbackTime:0},PlaybackRate(e){const t=this._GetFirstAudioStateByTags(e);return t?t.playbackRate:0},Volume(e){const t=this._GetFirstAudioStateByTags(e);return t?this.LinearToDb(t.volume):0},MasterVolume(){return this.LinearToDb(this._GetMasterVolume())},EffectCount(e){return this._effectCount.get(e.toLowerCase())||0},AnalyserFreqBinCount(e,t){const s=this.GetAnalyserData(e,Math.floor(t));return s?s.binCount:0},AnalyserFreqBinAt(e,t,s){const i=this.GetAnalyserData(e,Math.floor(t));return i?(s=Math.floor(s))<0||s>=i.binCount?0:i.freqBins[s]:0},AnalyserPeakLevel(e,t){const s=this.GetAnalyserData(e,Math.floor(t));return s?s.peak:0},AnalyserRMSLevel(e,t){const s=this.GetAnalyserData(e,Math.floor(t));return s?s.rms:0},SampleRate(){return this._sampleRate},CurrentTime:()=>self.C3_GetAudioContextCurrentTime?self.C3_GetAudioContextCurrentTime():performance.now()/1e3,OutputLatency(){return this._outputLatency},NormalizedVolume(e,t){return 0==(e=cR.clamp(+e,0,100)/100)?-1/0:e<.1?this.LinearToDb(cR.lerp(0,this.DbToLinear(t),10*e)):cR.lerp(t,0,(e-.1)/.9)}}}{const dR=self.C3;dR.Plugins.Dictionary=class extends dR.SDKPluginBase{constructor(e){super(e)}Release(){super.Release()}}}{const pR=self.C3;pR.Plugins.Dictionary.Type=class extends pR.SDKTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const _R=self.C3,mR=(self.C3X,self.IInstance);_R.Plugins.Dictionary.Instance=class extends _R.SDKInstanceBase{constructor(e,t){super(e),this._data=new Map,this._curKey=""}Release(){this._data.clear(),super.Release()}GetAsJsonString(){return JSON.stringify({c2dictionary:!0,data:_R.MapToObject(this._data)})}GetDataMap(){return this._data}SaveToJson(){return _R.MapToObject(this._data)}LoadFromJson(e){_R.ObjectToMap(e,this._data)}GetDebuggerProperties(){const e="plugins.dictionary";return[{title:e+".name",properties:[{name:e+".debugger.key-count",value:this._data.size},...[...this._data].map(e=>({name:"$"+e[0],value:e[1],onedit:t=>this._data.set(e[0],t)}))]}]}GetScriptInterfaceClass(){return self.IDictionaryInstance}};const fR=new WeakMap;self.IDictionaryInstance=class extends mR{constructor(){super(),fR.set(this,mR._GetInitInst().GetSdkInstance())}getDataMap(){return fR.get(this).GetDataMap()}}}{const gR=self.C3;gR.Plugins.Dictionary.Cnds={CompareValue(e,t,s){const i=this._data.get(e);return void 0!==i&&gR.compare(i,t,s)},ForEachKey(){const e=this._runtime,t=e.GetEventSheetManager(),s=e.GetCurrentEvent(),i=s.GetSolModifiers(),r=e.GetEventStack(),n=r.GetCurrentStackFrame(),a=r.Push(s);e.SetDebuggingEnabled(!1);for(const e of this._data.keys())this._curKey=e,t.PushCopySol(i),this.GetObjectClass().GetCurrentSol().PickOne(this.GetInstance()),s.Retrigger(n,a),t.PopSol(i);return e.SetDebuggingEnabled(!0),this._curKey="",r.Pop(),!1},CompareCurrentValue(e,t){const s=this._data.get(this._curKey);return void 0!==s&&gR.compare(s,e,t)},HasKey(e){return this._data.has(e)},IsEmpty(){return 0===this._data.size}}}{const yR=self.C3;yR.Plugins.Dictionary.Acts={AddKey(e,t){this._data.set(e,t)},SetKey(e,t){this._data.has(e)&&this._data.set(e,t)},DeleteKey(e){this._data.delete(e)},Clear(){this._data.clear()},JSONLoad(e){let t=null;try{t=JSON.parse(e)}catch(e){return void console.error("[Construct] Error parsing JSON: ",e)}t.c2dictionary?yR.ObjectToMap(t.data,this._data):console.warn("[Dictionary] Attempted to load JSON that does not appear to be Construct dictionary data - no data loaded")},JSONDownload(e){const t=URL.createObjectURL(new Blob([this.GetAsJsonString()],{type:"application/json"}));this._runtime.InvokeDownload(t,e)}}}self.C3.Plugins.Dictionary.Exps={Get(e){const t=this._data.get(e);return void 0===t?0:t},GetDefault(e,t){const s=this._data.get(e);return void 0===s?t:s},KeyCount(){return this._data.size},CurrentKey(){return this._curKey},CurrentValue(){return this._data.get(this._curKey)??0},AsJSON(){return this.GetAsJsonString()}};{const SR=self.C3;SR.Plugins.PlatformInfo=class extends SR.SDKPluginBase{constructor(e){super(e)}Release(){super.Release()}}}{const TR=self.C3;TR.Plugins.PlatformInfo.Type=class extends TR.SDKTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const xR=self.C3,bR="platform-info";xR.Plugins.PlatformInfo.Instance=class extends xR.SDKInstanceBase{constructor(e,t){super(e,bR),this._screenWidth=0,this._screenHeight=0,this._windowOuterWidth=0,this._windowOuterHeight=0,this._safeAreaInset=[0,0,0,0],this._supportsWakeLock=!1,this._isWakeLockActive=!1,this.AddDOMMessageHandlers([["window-resize",e=>this._OnWindowResize(e)],["wake-lock-acquired",e=>this._OnWakeLockAcquired(e)],["wake-lock-error",e=>this._OnWakeLockError(e)],["wake-lock-released",e=>this._OnWakeLockReleased(e)]]),navigator.connection&&navigator.connection.addEventListener("change",()=>this._OnNetworkChange()),this._runtime.AddLoadPromise(this.PostToDOMAsync("get-initial-state").then(e=>{this._screenWidth=e.screenWidth,this._screenHeight=e.screenHeight,this._windowOuterWidth=e.windowOuterWidth,this._windowOuterHeight=e.windowOuterHeight,this._safeAreaInset=e.safeAreaInset,this._supportsWakeLock=e.supportsWakeLock}))}Release(){super.Release()}_OnWindowResize(e){this._windowOuterWidth=e.windowOuterWidth,this._windowOuterHeight=e.windowOuterHeight,this._safeAreaInset=e.safeAreaInset}async _OnNetworkChange(){await this.TriggerAsync(xR.Plugins.PlatformInfo.Cnds.OnNetworkChange)}async _OnWakeLockAcquired(){this._isWakeLockActive=!0,await this.TriggerAsync(xR.Plugins.PlatformInfo.Cnds.OnWakeLockAcquired)}async _OnWakeLockError(){this._isWakeLockActive=!1,await this.TriggerAsync(xR.Plugins.PlatformInfo.Cnds.OnWakeLockError)}async _OnWakeLockReleased(){this._isWakeLockActive=!1,await this.TriggerAsync(xR.Plugins.PlatformInfo.Cnds.OnWakeLockReleased)}}}{const GR=self.C3;GR.Plugins.PlatformInfo.Cnds={IsOnMobile:()=>GR.Platform.IsMobile,IsOnWindows:()=>"Windows"===GR.Platform.OS,IsOnMacOS:()=>"macOS"===GR.Platform.OS,IsOnLinux:()=>"Linux"===GR.Platform.OS,IsOnChromeOS:()=>"Chrome OS"===GR.Platform.OS,IsOnAndroid:()=>"Android"===GR.Platform.OS,IsOniOS:()=>"iOS"===GR.Platform.OS,IsWebExport(){const e=this._runtime.GetExportType();return"html5"===e||"scirra-arcade"===e||"preview"===e||"instant-games"===e},IsCordovaExport(){return this._runtime.IsCordova()},IsNWjsExport(){return this._runtime.IsNWjs()},IsWindowsUWPExport(){return"windows-uwp"===this._runtime.GetExportType()},IsWindowsWebView2Export(){return this._runtime.IsWindowsWebView2()},IsMacOSWKWebView2Export(){return"macos-wkwebview"===this._runtime.GetExportType()},IsLinuxCEFExport(){return"linux-cef"===this._runtime.GetExportType()},OnNetworkChange:()=>!0,OnWakeLockAcquired:()=>!0,OnWakeLockError:()=>!0,OnWakeLockReleased:()=>!0,IsWakeLockActive(){return this._isWakeLockActive},IsWakeLockSupported(){return this._supportsWakeLock}}}self.C3.Plugins.PlatformInfo.Acts={RequestWakeLock(){this._supportsWakeLock&&this._PostToDOMMaybeSync("request-wake-lock")},ReleaseWakeLock(){this._supportsWakeLock&&(this._isWakeLockActive=!1,this.PostToDOM("release-wake-lock"))}},self.C3.Plugins.PlatformInfo.Exps={Renderer(){return this._runtime.GetCanvasManager().GetRendererString()},RendererDetail(){return this._runtime.GetCanvasManager().GetRendererDetailString()},DevicePixelRatio(){return this._runtime.GetDevicePixelRatio()},ScreenWidth(){return this._screenWidth},ScreenHeight(){return this._screenHeight},WindowInnerWidth(){return this._runtime.GetCanvasManager().GetLastWidth()},WindowInnerHeight(){return this._runtime.GetCanvasManager().GetLastHeight()},WindowOuterWidth(){return this._windowOuterWidth},WindowOuterHeight(){return this._windowOuterHeight},CanvasCssWidth(){return this._runtime.GetCanvasManager().GetCssWidth()},CanvasCssHeight(){return this._runtime.GetCanvasManager().GetCssHeight()},CanvasDeviceWidth(){return this._runtime.GetCanvasManager().GetDeviceWidth()},CanvasDeviceHeight(){return this._runtime.GetCanvasManager().GetDeviceHeight()},Downlink:()=>navigator.connection&&navigator.connection.downlink||0,DownlinkMax:()=>navigator.connection&&navigator.connection.downlinkMax||0,ConnectionType:()=>navigator.connection&&navigator.connection.type||"unknown",ConnectionEffectiveType:()=>navigator.connection&&navigator.connection.effectiveType||"unknown",ConnectionRTT:()=>navigator.connection&&navigator.connection.rtt||0,HardwareConcurrency:()=>navigator.hardwareConcurrency||0,DeviceMemory:()=>navigator.deviceMemory||0,SafeAreaInsetTop(){return this._safeAreaInset[0]},SafeAreaInsetRight(){return this._safeAreaInset[1]},SafeAreaInsetBottom(){return this._safeAreaInset[2]},SafeAreaInsetLeft(){return this._safeAreaInset[3]},FramesPerSecond(){return this._runtime.GetFramesPerSecond()},TicksPerSecond(){return this._runtime.GetTicksPerSecond()}};{const IR=self.C3;IR.Plugins.Sprite=class extends IR.SDKPluginBase{constructor(e){super(e)}Release(){super.Release()}}}{const vR=self.C3,CR=self.C3X,wR=[];vR.Plugins.Sprite.Type=class extends vR.SDKTypeBase{constructor(e){super(e),this._animations=e.GetAnimations()}Release(){vR.clearArray(this._animations),super.Release()}OnCreate(){for(const e of this._animations)e.LoadAllAssets(this._runtime)}LoadTextures(e){const t={sampling:this._runtime.GetSampling()};return Promise.all(this._animations.map(s=>s.LoadAllTextures(e,t)))}ReleaseTextures(){for(const e of this._animations)e.ReleaseAllTextures()}OnDynamicTextureLoadComplete(){this._UpdateAllCurrentTexture()}_UpdateAllCurrentTexture(){for(const e of this._objectClass.instancesIncludingPendingCreate())e.GetSdkInstance()._UpdateCurrentTexture()}FinishCondition(e){vR.Plugins.Sprite.FinishCollisionCondition(this,e)}BeforeRunAction(e){wR.push({objectClass:null,createHierarchy:!1,instances:[]})}_SpawnPickInstance(e,t,s){const i=wR.at(-1);i.objectClass=e,i.createHierarchy=s,i.instances.push(t)}AfterRunAction(e){const t=wR.pop(),s=t.objectClass,i=t.createHierarchy;if(!s)return;const r=new Map;for(const e of t.instances)e.CollectInstancesToPick(r,s,i);for(const[e,t]of r)e.GetCurrentSol().SetSetPicked(t)}_AddAnimation(e){const t=this.GetObjectClass().AddAnimation(e),s=this.GetRuntime();return t.GetFrameAt(0).GetImageInfo().LoadStaticTexture(s.GetRenderer(),{sampling:s.GetSampling()}).then(()=>this._UpdateAllCurrentTexture()),t}_RemoveAnimation(e){for(const t of this._objectClass.instancesIncludingPendingCreate())t.GetSdkInstance()._OnAnimationRemoved(e);this.GetObjectClass().RemoveAnimation(e)}_AddAnimationFrame(e,t){const s=this._objectClass.GetAnimationByName(e);if(!s)throw new Error(`cannot find animation name '${e}'`);let i=s.FrameTagOrIndexToIndex(t);i<0&&(i+=s.GetFrameCount()+1);const r=vR.AnimationFrameInfo.CreateDynamic(this.GetRuntime());s.InsertFrameAt(r,i);const n=this.GetRuntime();r.GetImageInfo().LoadStaticTexture(n.GetRenderer(),{sampling:n.GetSampling()}).then(()=>this._UpdateAllCurrentTexture());for(const e of this._objectClass.instancesIncludingPendingCreate())e.GetSdkInstance()._OnAnimationFramesChanged();return r}_RemoveAnimationFrame(e,t){const s=this._objectClass.GetAnimationByName(e);if(!s)throw new Error(`cannot find animation name '${e}'`);if(1===s.GetFrameCount())throw new Error(`cannot remove last frame from animation '${e}'`);let i=s.FrameTagOrIndexToIndex(t);i<0&&(i+=s.GetFrameCount()),s.RemoveFrameAt(i);for(const e of this._objectClass.instancesIncludingPendingCreate())e.GetSdkInstance()._OnAnimationFramesChanged()}GetScriptInterfaceClass(){return self.ISpriteObjectType}};const AR=new WeakMap;self.ISpriteObjectType=class extends self.IObjectType{constructor(e){super(e),AR.set(this,e.GetSdkType())}getAnimation(e){CR.RequireString(e);const t=AR.get(this).GetObjectClass().GetAnimationByName(e);return t?t.GetIAnimation():null}getAllAnimations(){return AR.get(this).GetObjectClass().GetAllAnimations().map(e=>e.GetIAnimation())}addAnimation(e){return CR.RequireString(e),AR.get(this)._AddAnimation(e).GetIAnimation()}removeAnimation(e){CR.RequireString(e),AR.get(this)._RemoveAnimation(e)}addAnimationFrame(e,t){if(CR.RequireString(e),"number"!=typeof t&&"string"!=typeof t)throw new TypeError("invalid insert location");return AR.get(this)._AddAnimationFrame(e,t).GetIAnimationFrame()}removeAnimationFrame(e,t){if(CR.RequireString(e),"number"!=typeof t&&"string"!=typeof t)throw new TypeError("invalid insert location");AR.get(this)._RemoveAnimationFrame(e,t)}}}{const RR=self.C3,PR=self.C3X,MR=0,ER=1,DR=2,NR=3,FR=RR.New(RR.Rect),OR=RR.New(RR.Quad),BR=RR.New(RR.Vector2),LR=1,kR=2,VR=4;RR.Plugins.Sprite.Instance=class extends RR.SDKWorldInstanceBase{constructor(e,t){super(e);let s=!0,i="",r=0,n=!0;t&&(s=!!t[MR],i=t[ER],r=t[DR],n=t[NR]),this._currentAnimation=this._objectClass.GetAnimationByName(i)||this._objectClass.GetAnimations()[0],this._currentFrameIndex=RR.clamp(r,0,this._currentAnimation.GetFrameCount()-1),this._currentAnimationFrame=this._currentAnimation.GetFrameAt(this._currentFrameIndex);const a=this._currentAnimationFrame.GetImageInfo();this._currentTexture=a.GetTexture(),this._currentRcTex=a.GetTexRect(),this._currentQuadTex=a.GetTexQuad(),this.HandleRendererContextLoss(),e.SetFlag(kR,!0),e.SetFlag(LR,this._currentAnimation.GetSpeed()>=0),this._currentAnimationSpeed=Math.abs(this._currentAnimation.GetSpeed()),this._currentAnimationRepeatTo=this._currentAnimation.GetRepeatTo(),this._animationTimer=RR.New(RR.KahanSum),this._frameStartTime=0,this._animationRepeats=0,this._animTriggerName="",this._changeAnimFrameIndex=-1,this._changeAnimationName="",this._changeAnimationFrom=0;const o=this.GetWorldInfo();this._bquadRef=o.GetBoundingQuad(),o.SetVisible(s),o.SetCollisionEnabled(n),o.SetOriginX(this._currentAnimationFrame.GetOriginX()),o.SetOriginY(this._currentAnimationFrame.GetOriginY()),o.SetSourceCollisionPoly(this._currentAnimationFrame.GetCollisionPoly()),o.SetBboxChanged(),1===this._objectClass.GetAnimationCount()&&1===this._objectClass.GetAnimations()[0].GetFrameCount()||0===this._currentAnimationSpeed||this._StartTicking()}Release(){this._currentAnimation=null,this._currentAnimationFrame=null,this._currentTexture=null,this._animationTimer=null,super.Release()}GetCurrentImageInfo(){return this._currentAnimationFrame.GetImageInfo()}IsOriginalSizeKnown(){return!0}OnRendererContextLost(){this._currentTexture=null}OnRendererContextRestored(){this._UpdateCurrentTexture()}Draw(e){const t=this._currentTexture;if(null===t)return;e.SetTexture(t);const s=this.GetWorldInfo();s.HasMesh()?this._DrawMesh(s,e):this._DrawStandard(s,e)}_DrawStandard(e,t){let s=this._bquadRef;this._runtime.IsPixelRoundingEnabled()&&(s=e.PixelRoundQuad(s)),t.Quad4(s,this._currentQuadTex)}_DrawMesh(e,t){const s=e.GetTransformedMesh();if(e.IsMeshChanged()){e.CalculateBbox(FR,OR,!1);let t=OR;this._runtime.IsPixelRoundingEnabled()&&(t=e.PixelRoundQuad(t)),s.CalculateTransformedMesh(e.GetSourceMesh(),t,this._currentQuadTex),e.SetMeshChanged(!1)}s.Draw(t,e.GetTotalZElevation())}GetAnimationTime(){return this._animationTimer.Get()}IsAnimationPlaying(){return this._inst.GetFlag(kR)}SetAnimationPlaying(e){this._inst.SetFlag(kR,e)}IsPlayingForwards(){return this._inst.GetFlag(LR)}SetPlayingForwards(e){this._inst.SetFlag(LR,e)}IsInAnimationTrigger(){return this._inst.GetFlag(VR)}SetInAnimationTrigger(e){this._inst.SetFlag(VR,e)}Tick(){this._changeAnimationName&&this._DoChangeAnimation(),this._changeAnimFrameIndex>=0&&this._DoChangeAnimFrame();const e=this._currentAnimationSpeed;if(!this.IsAnimationPlaying()||0===e)return void this._StopTicking();const t=this._runtime.GetDt(this._inst);this._animationTimer.Add(t);const s=this.GetAnimationTime(),i=this._currentAnimationFrame,r=i.GetDuration()/e;if(s<this._frameStartTime+r)return;const n=this._currentAnimation,a=this._currentAnimationRepeatTo,o=n.GetFrameCount(),l=n.GetRepeatCount(),h=n.IsLooping(),u=n.IsPingPong();this.IsPlayingForwards()?this._currentFrameIndex++:this._currentFrameIndex--,this._frameStartTime+=r,this._currentFrameIndex>=o&&(u?(this.SetPlayingForwards(!1),this._currentFrameIndex=o-2):h?this._currentFrameIndex=a:(this._animationRepeats++,this._animationRepeats>=l?this._FinishAnimation(!1):this._currentFrameIndex=a)),this._currentFrameIndex<0&&(u?(this._currentFrameIndex=1,this.SetPlayingForwards(!0),h||(this._animationRepeats++,this._animationRepeats>=l&&this._FinishAnimation(!0))):h?this._currentFrameIndex=a:(this._animationRepeats++,this._animationRepeats>=l?this._FinishAnimation(!0):this._currentFrameIndex=a)),this._currentFrameIndex=RR.clamp(this._currentFrameIndex,0,o-1);const c=n.GetFrameAt(this._currentFrameIndex);s>this._frameStartTime+c.GetDuration()/e&&(this._frameStartTime=s),this._OnFrameChanged(i,c)}_FinishAnimation(e){this._currentFrameIndex=e?0:this._currentAnimation.GetFrameCount()-1,this.SetAnimationPlaying(!1),this._animTriggerName=this._currentAnimation.GetName(),this.SetInAnimationTrigger(!0),this.DispatchScriptEvent("animationend",!1,{animationName:this._animTriggerName}),this.Trigger(RR.Plugins.Sprite.Cnds.OnAnyAnimFinished),this.Trigger(RR.Plugins.Sprite.Cnds.OnAnimFinished),this.SetInAnimationTrigger(!1),this._animationRepeats=0}_OnFrameChanged(e,t,s){if(e===t)return;const i=this.GetWorldInfo(),r=e.GetImageInfo(),n=t.GetImageInfo(),a=r.GetWidth(),o=r.GetHeight(),l=n.GetWidth(),h=n.GetHeight();s&&s.onFrameChange?s.onFrameChange(i,a,o,l,h):(a!==l&&i.SetWidth(i.GetWidth()*(l/a)),o!==h&&i.SetHeight(i.GetHeight()*(h/o))),i.SetOriginX(t.GetOriginX()),i.SetOriginY(t.GetOriginY()),i.SetSourceCollisionPoly(t.GetCollisionPoly()),i.SetBboxChanged(),this._currentAnimationFrame=t,this._currentTexture=n.GetTexture(),this._currentRcTex=n.GetTexRect(),this._currentQuadTex=n.GetTexQuad();const u=this.GetInstance().GetBehaviorInstances();for(let s=0,i=u.length;s<i;++s)u[s].OnSpriteFrameChanged(e,t);this.DispatchScriptEvent("framechange",!1,{animationName:this._currentAnimation.GetName(),animationFrame:this._currentFrameIndex}),this.Trigger(RR.Plugins.Sprite.Cnds.OnFrameChanged),this._runtime.UpdateRender()}_StartAnim(e){this.SetAnimationPlaying(!0),this._frameStartTime=this.GetAnimationTime(),1===e&&0!==this._currentFrameIndex&&(this._changeAnimFrameIndex=0,this.IsInAnimationTrigger()||this._DoChangeAnimFrame()),this._StartTicking()}_SetAnim(e,t,s){this._changeAnimationName=e,this._changeAnimationFrom=t,this._StartTicking(),!s&&this.IsInAnimationTrigger()||this._DoChangeAnimation()}_GetCurrentAnimation(){return this._currentAnimation}_GetCurrentAnimationName(){return this._changeAnimationName?this._changeAnimationName:this._currentAnimation.GetName()}_OnAnimationRemoved(e){RR.equalsNoCase(e,this._GetCurrentAnimationName())&&this._SetAnim(this._objectClass.GetFirstAnimation().GetName(),1,!0)}_SetAnimFrame(e){if("string"==typeof e)if(String(Number(e))===e)e=Number(e);else{const t=this._objectClass.GetAnimationByName(this._GetCurrentAnimationName());if(!t)return;if(-1===(e=t.GetFrameIndexByTag(e)))return}isFinite(e)&&(this._changeAnimFrameIndex=e,this.IsInAnimationTrigger()||this._DoChangeAnimFrame())}_OnAnimationFramesChanged(){if(this._changeAnimationName||-1!==this._changeAnimFrameIndex)return;const e=this._currentAnimationFrame,t=this._currentAnimation.GetFrameAt(RR.clamp(this._currentFrameIndex,0,this._currentAnimation.GetFrameCount()-1));e!==t&&this._OnFrameChanged(e,t),this._currentAnimation.GetFrameCount()>1&&this._currentAnimationSpeed>0&&this._StartTicking()}_GetAnimFrame(){return this._currentFrameIndex}_GetAnimFrameTag(){return this._currentAnimationFrame.GetTag()}_SetAnimSpeed(e){this._currentAnimationSpeed=Math.abs(e),this.SetPlayingForwards(e>=0),this._currentAnimationSpeed>0&&this._StartTicking()}_GetAnimSpeed(){return this.IsPlayingForwards()?this._currentAnimationSpeed:-this._currentAnimationSpeed}_SetAnimRepeatToFrame(e){"string"==typeof e&&-1===(e=this._currentAnimation.GetFrameIndexByTag(e))||(e=RR.clamp(Math.floor(e),0,this._currentAnimation.GetFrameCount()-1),this._currentAnimationRepeatTo=e)}_GetAnimRepeatToFrame(){return this._currentAnimationRepeatTo}_DoChangeAnimation(e){const t=this._currentAnimationFrame,s=this._objectClass.GetAnimationByName(this._changeAnimationName);if(this._changeAnimationName="",!s)return;if(s===this._currentAnimation&&this.IsAnimationPlaying())return;this._currentAnimation=s,this.SetPlayingForwards(s.GetSpeed()>=0),this._currentAnimationSpeed=Math.abs(s.GetSpeed()),this._currentAnimationRepeatTo=s.GetRepeatTo(),this._currentFrameIndex=RR.clamp(this._currentFrameIndex,0,this._currentAnimation.GetFrameCount()-1),1===this._changeAnimationFrom&&(this._currentFrameIndex=0),this.SetAnimationPlaying(!0),this._frameStartTime=this.GetAnimationTime();const i=this._currentAnimation.GetFrameAt(this._currentFrameIndex);this._OnFrameChanged(t,i,e)}_DoChangeAnimFrame(e){const t=this._currentAnimationFrame,s=this._currentFrameIndex;if(this._currentFrameIndex=RR.clamp(Math.floor(this._changeAnimFrameIndex),0,this._currentAnimation.GetFrameCount()-1),this._changeAnimFrameIndex=-1,!e&&s===this._currentFrameIndex)return;const i=this._currentAnimation.GetFrameAt(this._currentFrameIndex);this._OnFrameChanged(t,i),this._frameStartTime=this.GetAnimationTime()}_UpdateCurrentTexture(){const e=this._currentAnimationFrame.GetImageInfo();this._currentTexture=e.GetTexture(),this._currentRcTex=e.GetTexRect(),this._currentQuadTex=e.GetTexQuad(),this.GetWorldInfo().SetMeshChanged(!0)}GetTexture(){return this._currentTexture}GetTexRect(){return this._currentRcTex}GetTexQuad(){return this._currentQuadTex}GetImagePointCount(){return this._currentAnimationFrame.GetImagePointCount()}GetImagePoint(e){const t=this._currentAnimationFrame,s=this.GetWorldInfo();let i=null;if("string"==typeof e)i=t.GetImagePointByName(e);else{if("number"!=typeof e)throw new TypeError("expected string or number");i=t.GetImagePointByIndex(e-1)}let r=s.GetTotalZElevation();if(!i)return[s.GetX(),s.GetY(),r];if(BR.copy(i.GetVec2()),s.HasMesh()){const[e,t,i]=s.GetSourceMesh().TransformPoint(BR.getX(),BR.getY());BR.set(e,t),r+=i}return BR.offset(-t.GetOriginX(),-t.GetOriginY()),BR.scale(s.GetWidth(),s.GetHeight()),BR.rotate(s.GetAngle()),BR.offset(s.GetX(),s.GetY()),[BR.getX(),BR.getY(),r]}GetCollisionPolyPointCount(){return this.GetWorldInfo().GetTransformedCollisionPoly().pointCount()}GetCollisionPolyPoint(e){e=Math.floor(e);const t=this.GetWorldInfo(),s=t.GetTransformedCollisionPoly(),i=s.pointCount();if(e===i&&(e=0),e<0||e>=i)return[0,0];const r=s.pointsArr();return[r[2*e+0]+t.GetX(),r[2*e+1]+t.GetY()]}GetDebuggerProperties(){const e=RR.Plugins.Sprite.Acts,t="plugins.sprite.debugger.animation-properties";return[{title:t+".title",properties:[{name:t+".current-animation",value:this._currentAnimation.GetName(),onedit:t=>this.CallAction(e.SetAnim,t,0)},{name:t+".current-frame",value:this._currentFrameIndex,onedit:t=>this.CallAction(e.SetAnimFrame,t)},{name:t+".is-playing",value:this.IsAnimationPlaying(),onedit:t=>t?this.CallAction(e.StartAnim,0):this.CallAction(e.StopAnim)},{name:t+".speed",value:this._currentAnimationSpeed,onedit:t=>this.CallAction(e.SetAnimSpeed,t)},{name:t+".repeats",value:this._animationRepeats,onedit:e=>this._animationRepeats=e}]}]}SaveToJson(){const e={a:this._currentAnimation.GetSID()};0!==this._frameStartTime&&(e.fs=this._frameStartTime);const t=this.GetAnimationTime();0!==t&&(e.at=t),0!==this._currentFrameIndex&&(e.f=this._currentFrameIndex),0!==this._currentAnimationSpeed&&(e.cas=this._currentAnimationSpeed),1!==this._animationRepeats&&(e.ar=this._animationRepeats),0!==this._currentAnimationRepeatTo&&(e.rt=this._currentAnimationRepeatTo),this.IsAnimationPlaying()||(e.ap=this.IsAnimationPlaying()),this.IsPlayingForwards()||(e.af=this.IsPlayingForwards());const s=this.GetWorldInfo();return s.IsCollisionEnabled()&&(e.ce=s.IsCollisionEnabled()),e}LoadFromJson(e){const t=this.GetObjectClass().GetAnimationBySID(e.a);t&&(this._currentAnimation=t),this._frameStartTime=e.hasOwnProperty("fs")?e.fs:0,this._animationTimer.Set(e.hasOwnProperty("at")?e.at:0);const s=e.hasOwnProperty("f")?e.f:0;this._currentFrameIndex=RR.clamp(s,0,this._currentAnimation.GetFrameCount()-1),this._currentAnimationSpeed=e.hasOwnProperty("cas")?e.cas:0,this._animationRepeats=e.hasOwnProperty("ar")?e.ar:1;const i=e.hasOwnProperty("rt")?e.rt:0;this._currentAnimationRepeatTo=RR.clamp(i,0,this._currentAnimation.GetFrameCount()-1),this.SetAnimationPlaying(!e.hasOwnProperty("ap")||!!e.ap),this.SetPlayingForwards(!e.hasOwnProperty("af")||!!e.af);const r=this._currentAnimation.GetFrameAt(this._currentFrameIndex);this._currentAnimationFrame=r,this._UpdateCurrentTexture();const n=this.GetWorldInfo();n.SetOriginX(r.GetOriginX()),n.SetOriginY(r.GetOriginY()),n.SetSourceCollisionPoly(r.GetCollisionPoly()),n.SetCollisionEnabled(!!e.ce),this.IsAnimationPlaying()&&this._StartTicking()}GetPropertyValueByIndex(e){const t=this.GetWorldInfo();switch(e){case NR:return t.IsCollisionEnabled();case DR:return RR.clamp(this._currentFrameIndex,0,this._currentAnimation.GetFrameCount()-1);case ER:return this._currentAnimation.GetName()}}SetPropertyValueByIndex(e,t,s){const i=this.GetWorldInfo();switch(e){case NR:i.SetCollisionEnabled(!!t);break;case DR:{this.SetAnimationPlaying(!1);const e=this._currentAnimation.GetFrameCount()-1,i=t=RR.clamp(t,0,e),r=this._currentAnimation.GetFrameAt(this._currentFrameIndex),n=this._currentAnimation.GetFrameAt(i);this._OnFrameChanged(r,n,s),this._currentFrameIndex=RR.clamp(i,0,e);break}case ER:this._changeAnimationName=t,this._DoChangeAnimation(s),this._currentAnimation.GetFrameCount()>1&&this._currentAnimation.GetSpeed()>0?this._StartTicking():this._StopTicking()}}GetScriptInterfaceClass(){return self.ISpriteInstance}};const UR=new WeakMap,WR=new Map([["current-frame",0],["beginning",1]]);self.ISpriteInstance=class extends self.IWorldInstance{constructor(){super(),UR.set(this,self.IInstance._GetInitInst().GetSdkInstance())}getImagePointCount(){return UR.get(this).GetImagePointCount()}getImagePointX(e){return this.getImagePoint(e)[0]}getImagePointY(e){return this.getImagePoint(e)[1]}getImagePointZ(e){return this.getImagePoint(e)[2]}getImagePoint(e){if("string"!=typeof e&&"number"!=typeof e)throw new TypeError("expected string or number");return UR.get(this).GetImagePoint(e)}getPolyPointCount(){return UR.get(this).GetCollisionPolyPointCount()}getPolyPointX(e){return PR.RequireFiniteNumber(e),UR.get(this).GetCollisionPolyPoint(e)[0]}getPolyPointY(e){return PR.RequireFiniteNumber(e),UR.get(this).GetCollisionPolyPoint(e)[1]}getPolyPoint(e){return PR.RequireFiniteNumber(e),UR.get(this).GetCollisionPolyPoint(e)}stopAnimation(){UR.get(this).SetAnimationPlaying(!1)}startAnimation(e="current-frame"){PR.RequireString(e);const t=WR.get(e);if(void 0===t)throw new Error("invalid mode");UR.get(this)._StartAnim(t)}setAnimation(e,t="beginning"){PR.RequireString(e),PR.RequireString(t);const s=WR.get(t);if(void 0===s)throw new Error("invalid mode");const i=UR.get(this);if(!i.GetObjectClass().GetAnimationByName(e))throw new Error(`animation name "${e}" does not exist`);i._SetAnim(e,s)}getAnimation(e){PR.RequireString(e);const t=UR.get(this).GetObjectClass().GetAnimationByName(e);return t?t.GetIAnimation():null}get animation(){return UR.get(this)._GetCurrentAnimation().GetIAnimation()}get animationName(){return UR.get(this)._GetCurrentAnimationName()}set animationFrame(e){PR.RequireFiniteNumber(e),UR.get(this)._SetAnimFrame(e)}get animationFrame(){return UR.get(this)._GetAnimFrame()}set animationFrameTag(e){PR.RequireString(e),UR.get(this)._SetAnimFrame(e)}get animationFrameTag(){return UR.get(this)._GetAnimFrameTag()}set animationSpeed(e){PR.RequireFiniteNumber(e),UR.get(this)._SetAnimSpeed(e)}get animationSpeed(){return UR.get(this)._GetAnimSpeed()}set animationRepeatToFrame(e){PR.RequireFiniteNumber(e),UR.get(this)._SetAnimRepeatToFrame(e)}get animationRepeatToFrame(){return UR.get(this)._GetAnimRepeatToFrame()}get imageWidth(){return UR.get(this).GetCurrentImageInfo().GetWidth()}get imageHeight(){return UR.get(this).GetCurrentImageInfo().GetHeight()}getImageSize(){const e=UR.get(this).GetCurrentImageInfo();return[e.GetWidth(),e.GetHeight()]}async replaceCurrentAnimationFrame(e){PR.RequireInstanceOf(e,Blob);const t=UR.get(this),s=t.GetRuntime(),i=t.GetCurrentImageInfo(),r=RR.New(RR.ImageInfo);if(r.LoadDynamicBlobAsset(s,e),await r.LoadStaticTexture(s.GetRenderer(),{sampling:s.GetSampling()}),t.WasReleased())return void r.Release();i.ReplaceWith(r);const n=t.GetSdkType();n._UpdateAllCurrentTexture(),n.GetObjectClass().Dispatcher().dispatchEvent(new RR.Event("animationframeimagechange")),s.UpdateRender()}setSolidCollisionFilter(e,t){PR.RequireString(t),UR.get(this).GetWorldInfo().SetSolidCollisionFilter(!!e,t)}}}{const HR=self.C3;HR.Plugins.Sprite.Cnds={IsAnimPlaying(e){return HR.equalsNoCase(this._GetCurrentAnimationName(),e)},CompareFrame(e,t){return HR.compare(this._currentFrameIndex,e,t)},CompareFrameTag(e,t){if("string"!=typeof t)return!1;const s=this._currentAnimationFrame.GetTag();return HR.compare(s.toLowerCase(),e,t.toLowerCase())},CompareAnimSpeed(e,t){return HR.compare(this._GetAnimSpeed(),e,t)},OnAnimFinished(e){return HR.equalsNoCase(this._animTriggerName,e)},OnAnyAnimFinished:()=>!0,OnFrameChanged:()=>!0,IsMirrored(){return this.GetWorldInfo().GetWidth()<0},IsFlipped(){return this.GetWorldInfo().GetHeight()<0},OnURLLoaded:()=>!0,OnURLFailed:()=>!0,IsCollisionEnabled(){return this.GetWorldInfo().IsCollisionEnabled()}}}{const zR=self.C3;zR.Plugins.Sprite.Acts={Spawn(e,t,s,i,r){if(!e||!t)return;const[n,a]=this.GetImagePoint(s),o=this._runtime.CreateInstance(e,t,n,a,i,r);if(!o)return;if(i&&t.SortAndAddInstancesByZIndex(o),e.GetPlugin().IsRotatable()){const e=o.GetWorldInfo();e.SetAngle(this.GetWorldInfo().GetAngle()),e.SetBboxChanged()}const l=this._runtime.GetEventSheetManager();l.BlockFlushingInstances(!0),o._TriggerOnCreatedOnSelfAndRelated(),l.BlockFlushingInstances(!1),e!==this._runtime.GetCurrentAction().GetObjectClass()&&this._sdkType._SpawnPickInstance(e,o,i)},StopAnim(){this.SetAnimationPlaying(!1)},StartAnim(e){this._StartAnim(e)},SetAnim(e,t){this._SetAnim(e,t)},SetAnimFrame(e){this._SetAnimFrame(e)},SetAnimSpeed(e){this._SetAnimSpeed(e)},SetAnimRepeatToFrame(e){this._SetAnimRepeatToFrame(e)},AddRemoveAnimation(e,t){try{0===e?this.GetSdkType()._AddAnimation(t):this.GetSdkType()._RemoveAnimation(t)}catch(t){console.error(`[Construct] Error ${0===e?"adding":"removing"} animation: `,t)}},AddRemoveAnimationFrame(e,t,s){try{0===e?this.GetSdkType()._AddAnimationFrame(t,s):this.GetSdkType()._RemoveAnimationFrame(t,s)}catch(t){console.error(`[Construct] Error ${0===e?"adding":"removing"} animation frame: `,t)}},SetMirrored(e){const t=this.GetWorldInfo(),s=t.GetWidth(),i=Math.abs(s)*(0===e?-1:1);s!==i&&(t.SetWidth(i),t.SetBboxChanged())},SetFlipped(e){const t=this.GetWorldInfo(),s=t.GetHeight(),i=Math.abs(s)*(0===e?-1:1);s!==i&&(t.SetHeight(i),t.SetBboxChanged())},SetScale(e){const t=this._currentAnimationFrame.GetImageInfo(),s=this.GetWorldInfo(),i=s.GetWidth()<0?-1:1,r=s.GetHeight()<0?-1:1,n=t.GetWidth()*e*i,a=t.GetHeight()*e*r;s.GetWidth()===n&&s.GetHeight()===a||(s.SetSize(n,a),s.SetBboxChanged())},async LoadURL(e,t,s){const i=this._currentAnimationFrame.GetImageInfo(),r=this.GetWorldInfo(),n=this._runtime,a=this._sdkType;if(i.GetURL()===e)return 0===t&&(r.SetSize(i.GetWidth(),i.GetHeight()),r.SetBboxChanged()),void this.Trigger(zR.Plugins.Sprite.Cnds.OnURLLoaded);const o=zR.New(zR.ImageInfo);try{if(await o.LoadDynamicAsset(n,e),!o.IsLoaded())throw new Error("image failed to load");if(this.WasReleased())return void o.Release();await o.LoadStaticTexture(n.GetRenderer(),{sampling:n.GetSampling()})}catch(e){return console.error("Load image from URL failed: ",e),void(this.WasReleased()||this.Trigger(zR.Plugins.Sprite.Cnds.OnURLFailed))}this.WasReleased()?o.Release():(i.ReplaceWith(o),a._UpdateAllCurrentTexture(),a.GetObjectClass().Dispatcher().dispatchEvent(new zR.Event("animationframeimagechange")),n.UpdateRender(),0===t&&(r.SetSize(i.GetWidth(),i.GetHeight()),r.SetBboxChanged()),await this.TriggerAsync(zR.Plugins.Sprite.Cnds.OnURLLoaded))},SetCollisions(e){this.GetWorldInfo().SetCollisionEnabled(e)},SetSolidCollisionFilter(e,t){this.GetWorldInfo().SetSolidCollisionFilter(0===e,t)},SetEffect(e){this.GetWorldInfo().SetBlendMode(e),this._runtime.UpdateRender()}}}self.C3.Plugins.Sprite.Exps={AnimationFrame(){return this._GetAnimFrame()},AnimationFrameTag(){return this._GetAnimFrameTag()},AnimationFrameCount(){return this._currentAnimation.GetFrameCount()},AnimationName(){return this._currentAnimation.GetName()},AnimationSpeed(){return this._GetAnimSpeed()},OriginalAnimationSpeed(){return this._currentAnimation.GetSpeed()},ImagePointX(e){return this.GetImagePoint(e)[0]},ImagePointY(e){return this.GetImagePoint(e)[1]},ImagePointZ(e){return this.GetImagePoint(e)[2]},ImagePointCount(){return this.GetImagePointCount()},ImageWidth(){return this.GetCurrentImageInfo().GetWidth()},ImageHeight(){return this.GetCurrentImageInfo().GetHeight()},PolyPointXAt(e){return this.GetCollisionPolyPoint(e)[0]},PolyPointYAt(e){return this.GetCollisionPolyPoint(e)[1]},PolyPointCount(){return this.GetCollisionPolyPointCount()}};{const jR=self.C3;jR.Plugins.TiledBg=class extends jR.SDKPluginBase{constructor(e){super(e)}Release(){super.Release()}}}{let YR=function(e){switch(e){case 0:return"clamp-to-edge";case 1:return"repeat";case 2:return"mirror-repeat"}return"repeat"};WrapModeToStr=YR;const qR=self.C3;qR.Plugins.TiledBg.Type=class extends qR.SDKTypeBase{constructor(e,t){super(e),this._wrapX="repeat",this._wrapY="repeat",t&&(this._wrapX=YR(t[0]),this._wrapY=YR(t[1]))}Release(){super.Release()}OnCreate(){this.GetImageInfo().LoadAsset(this._runtime)}LoadTextures(e){return this.GetImageInfo().LoadStaticTexture(e,{sampling:this._runtime.GetSampling(),wrapX:this._wrapX,wrapY:this._wrapY})}ReleaseTextures(){this.GetImageInfo().ReleaseTexture()}GetWrapModeX(){return this._wrapX}GetWrapModeY(){return this._wrapY}}}{const XR=self.C3,$R=self.C3X,KR=0,JR=4,QR=5,ZR=6,eP=7,tP=8,sP=9,iP=10,rP=11,nP=12,aP=13,oP=14,lP=XR.New(XR.Rect),hP=XR.New(XR.Quad),uP=XR.New(XR.Rect),cP=XR.New(XR.Quad);XR.Plugins.TiledBg.Instance=class extends XR.SDKWorldInstanceBase{constructor(e,t){super(e),this._imageOffsetX=0,this._imageOffsetY=0,this._imageScaleX=1,this._imageScaleY=1,this._imageAngle=0,this._enableTileRandomization=!1,this._tileXRandom=0,this._tileYRandom=0,this._tileAngleRandom=0,this._tileBlendMarginX=0,this._tileBlendMarginY=0,this._ownImageInfo=null,t&&(this.GetWorldInfo().SetVisible(!!t[KR]),this._imageOffsetX=t[JR],this._imageOffsetY=t[QR],this._imageScaleX=t[ZR],this._imageScaleY=t[eP],this._imageAngle=XR.toRadians(t[tP]),this._enableTileRandomization=!!t[sP],this._tileXRandom=t[iP],this._tileYRandom=t[rP],this._tileAngleRandom=t[nP],this._tileBlendMarginX=t[aP],this._tileBlendMarginY=t[oP])}Release(){this._ReleaseOwnImage(),super.Release()}_ReleaseOwnImage(){this._ownImageInfo&&(this._ownImageInfo.Release(),this._ownImageInfo=null)}CalculateTextureCoordsFor3DFace(e,t,s){const i=this.GetCurrentImageInfo(),r=i.GetWidth(),n=i.GetHeight(),a=this._imageOffsetX/r,o=this._imageOffsetY/n,l=this._imageAngle;uP.set(0,0,e/(r*this._imageScaleX),t/(n*this._imageScaleY)),uP.offset(-a,-o),0===l?s.setFromRect(uP):s.setFromRotatedRect(uP,-l)}SetTilingShaderProgram(e,t=!0){if(this._enableTileRandomization){const t=this.GetCurrentImageInfo();e.SetTileRandomizationMode(),e.SetTileRandomizationInfo(t.GetWidth()*this._imageScaleX,t.GetHeight()*this._imageScaleY,this._tileXRandom,this._tileYRandom,this._tileAngleRandom,this._tileBlendMarginX,this._tileBlendMarginY)}else t&&e.SetTextureFillMode()}Draw(e){const t=this.GetCurrentImageInfo(),s=t.GetTexture();if(null===s)return;this.SetTilingShaderProgram(e),e.SetTexture(s);const i=t.GetWidth(),r=t.GetHeight();let n=this._imageOffsetX/i,a=this._imageOffsetY/r;0!==this._imageAngle||this._enableTileRandomization||("repeat"===this.GetSdkType().GetWrapModeX()&&(n%=1),"repeat"===this.GetSdkType().GetWrapModeY()&&(a%=1));const o=this.GetWorldInfo();uP.set(0,0,o.GetWidth()/(i*this._imageScaleX),o.GetHeight()/(r*this._imageScaleY)),uP.offset(-n,-a),o.HasMesh()?this._DrawMesh(o,e):this._DrawStandard(o,e)}_DrawStandard(e,t){let s=e.GetBoundingQuad();this._runtime.IsPixelRoundingEnabled()&&(s=e.PixelRoundQuad(s)),0===this._imageAngle?t.Quad3(s,uP):(cP.setFromRotatedRect(uP,-this._imageAngle),t.Quad4(s,cP))}_DrawMesh(e,t){const s=e.GetTransformedMesh();if(e.IsMeshChanged()){e.CalculateBbox(lP,hP,!1);let t=hP;this._runtime.IsPixelRoundingEnabled()&&(t=e.PixelRoundQuad(t));let i=uP;0!==this._imageAngle&&(cP.setFromRotatedRect(uP,-this._imageAngle),i=cP),s.CalculateTransformedMesh(e.GetSourceMesh(),t,i),e.SetMeshChanged(!1)}s.Draw(t,e.GetTotalZElevation())}GetCurrentImageInfo(){return this._ownImageInfo||this._objectClass.GetImageInfo()}IsOriginalSizeKnown(){return!0}GetTexture(){return this.GetCurrentImageInfo().GetTexture()}_SetMeshChanged(){this.GetWorldInfo().SetMeshChanged(!0)}_SetImageOffsetX(e){this._imageOffsetX!==e&&(this._imageOffsetX=e,this._runtime.UpdateRender(),this._SetMeshChanged())}_GetImageOffsetX(){return this._imageOffsetX}_SetImageOffsetY(e){this._imageOffsetY!==e&&(this._imageOffsetY=e,this._runtime.UpdateRender(),this._SetMeshChanged())}_GetImageOffsetY(){return this._imageOffsetY}_SetImageScaleX(e){this._imageScaleX!==e&&(this._imageScaleX=e,this._runtime.UpdateRender(),this._SetMeshChanged())}_GetImageScaleX(){return this._imageScaleX}_SetImageScaleY(e){this._imageScaleY!==e&&(this._imageScaleY=e,this._runtime.UpdateRender(),this._SetMeshChanged())}_GetImageScaleY(){return this._imageScaleY}_SetImageAngle(e){this._imageAngle!==e&&(this._imageAngle=e,this._runtime.UpdateRender(),this._SetMeshChanged())}_GetImageAngle(){return this._imageAngle}_SetTileRandomizationEnabled(e){e=!!e,this._enableTileRandomization!==e&&(this._enableTileRandomization=e,this._runtime.UpdateRender())}_IsTileRandomizationEnabled(){return this._enableTileRandomization}_SetTileXRandom(e){this._tileXRandom!==e&&(this._tileXRandom=e,this._IsTileRandomizationEnabled()&&this._runtime.UpdateRender())}_GetTileXRandom(){return this._tileXRandom}_SetTileYRandom(e){this._tileYRandom!==e&&(this._tileYRandom=e,this._IsTileRandomizationEnabled()&&this._runtime.UpdateRender())}_GetTileYRandom(){return this._tileYRandom}_SetTileAngleRandom(e){this._tileAngleRandom!==e&&(this._tileAngleRandom=e,this._IsTileRandomizationEnabled()&&this._runtime.UpdateRender())}_GetTileAngleRandom(){return this._tileAngleRandom}_SetTileBlendMarginX(e){this._tileBlendMarginX!==e&&(this._tileBlendMarginX=e,this._IsTileRandomizationEnabled()&&this._runtime.UpdateRender())}_GetTileBlendMarginX(){return this._tileBlendMarginX}_SetTileBlendMarginY(e){this._tileBlendMarginY!==e&&(this._tileBlendMarginY=e,this._IsTileRandomizationEnabled()&&this._runtime.UpdateRender())}_GetTileBlendMarginY(){return this._tileBlendMarginY}SaveToJson(){const e={};return 0!==this._imageOffsetX&&(e.iox=this._imageOffsetX),0!==this._imageOffsetY&&(e.ioy=this._imageOffsetY),1!==this._imageScaleX&&(e.isx=this._imageScaleX),1!==this._imageScaleY&&(e.isy=this._imageScaleY),0!==this._imageAngle&&(e.ia=this._imageAngle),this._enableTileRandomization&&(e.tr=!0),1!==this._tileXRandom&&(e.trx=this._tileXRandom),1!==this._tileYRandom&&(e.try=this._tileYRandom),1!==this._tileAngleRandom&&(e.tra=this._tileAngleRandom),.1!==this._tileBlendMarginX&&(e.trbmx=this._tileBlendMarginX),.1!==this._tileBlendMarginY&&(e.trbmy=this._tileBlendMarginY),e}LoadFromJson(e){this._imageOffsetX=e.iox||0,this._imageOffsetY=e.ioy||0,this._imageScaleX=e.hasOwnProperty("isx")?e.isx:1,this._imageScaleY=e.hasOwnProperty("isy")?e.isy:1,this._imageAngle=e.ia||0,this._enableTileRandomization=!!e.tr,this._tileXRandom=e.hasOwnProperty("trx")?e.trx:1,this._tileYRandom=e.hasOwnProperty("try")?e.try:1,this._tileAngleRandom=e.hasOwnProperty("tra")?e.tra:1,this._tileBlendMarginX=e.hasOwnProperty("trbmx")?e.trbmx:.1,this._tileBlendMarginY=e.hasOwnProperty("trbmy")?e.trbmy:.1}GetDebuggerProperties(){const e="plugins.tiledbg.properties";return[{title:e+".image-transform.name",properties:[{name:e+".image-offset-x.name",value:this._GetImageOffsetX(),onedit:e=>this._SetImageOffsetX(e)},{name:e+".image-offset-y.name",value:this._GetImageOffsetY(),onedit:e=>this._SetImageOffsetY(e)},{name:e+".image-scale-x.name",value:100*this._GetImageScaleX(),onedit:e=>this._SetImageScaleX(e/100)},{name:e+".image-scale-y.name",value:100*this._GetImageScaleY(),onedit:e=>this._SetImageScaleY(e/100)},{name:e+".image-angle.name",value:XR.toDegrees(this._GetImageAngle()),onedit:e=>this._SetImageAngle(XR.toRadians(e))}]},{title:e+".tile-randomization.name",properties:[{name:e+".enable-tile-randomization.name",value:this._IsTileRandomizationEnabled(),onedit:e=>this._SetTileRandomizationEnabled(e)},{name:e+".x-random.name",value:100*this._GetTileXRandom(),onedit:e=>this._SetTileXRandom(e/100)},{name:e+".y-random.name",value:100*this._GetTileYRandom(),onedit:e=>this._SetTileYRandom(e/100)},{name:e+".angle-random.name",value:100*this._GetTileAngleRandom(),onedit:e=>this._SetTileAngleRandom(e/100)},{name:e+".blend-margin-x.name",value:100*this._GetTileBlendMarginX(),onedit:e=>this._SetTileBlendMarginX(e/100)},{name:e+".blend-margin-y.name",value:100*this._GetTileBlendMarginY(),onedit:e=>this._SetTileBlendMarginY(e/100)}]}]}GetPropertyValueByIndex(e){switch(e){case JR:return this._GetImageOffsetX();case QR:return this._GetImageOffsetY();case ZR:return this._GetImageScaleX();case eP:return this._GetImageScaleY();case tP:return this._GetImageAngle();case sP:return this._IsTileRandomizationEnabled();case iP:return this._GetTileXRandom();case rP:return this._GetTileYRandom();case nP:return this._GetTileAngleRandom();case aP:return this._GetTileBlendMarginX();case oP:return this._GetTileBlendMarginY()}}SetPropertyValueByIndex(e,t){switch(e){case JR:this._SetImageOffsetX(t);break;case QR:this._SetImageOffsetY(t);break;case ZR:this._SetImageScaleX(t);break;case eP:this._SetImageScaleY(t);break;case tP:this._SetImageAngle(t);break;case sP:this._SetTileRandomizationEnabled(!!t);break;case iP:this._SetTileXRandom(t);break;case rP:this._SetTileYRandom(t);break;case nP:this._SetTileAngleRandom(t);break;case aP:this._SetTileBlendMarginX(t);break;case oP:this._SetTileBlendMarginY(t)}}GetScriptInterfaceClass(){return self.ITiledBackgroundInstance}};const dP=new WeakMap;self.ITiledBackgroundInstance=class extends self.IWorldInstance{constructor(){super(),dP.set(this,self.IInstance._GetInitInst().GetSdkInstance())}set imageOffsetX(e){$R.RequireFiniteNumber(e),dP.get(this)._SetImageOffsetX(e)}get imageOffsetX(){return dP.get(this)._GetImageOffsetX()}set imageOffsetY(e){$R.RequireFiniteNumber(e),dP.get(this)._SetImageOffsetY(e)}get imageOffsetY(){return dP.get(this)._GetImageOffsetY()}setImageOffset(e,t){$R.RequireFiniteNumber(e),$R.RequireFiniteNumber(t);const s=dP.get(this);s._SetImageOffsetX(e),s._SetImageOffsetY(t)}getImageOffset(){const e=dP.get(this);return[e._GetImageOffsetX(),e._GetImageOffsetY()]}set imageScaleX(e){$R.RequireFiniteNumber(e),dP.get(this)._SetImageScaleX(e)}get imageScaleX(){return dP.get(this)._GetImageScaleX()}set imageScaleY(e){$R.RequireFiniteNumber(e),dP.get(this)._SetImageScaleY(e)}get imageScaleY(){return dP.get(this)._GetImageScaleY()}setImageScale(e,t){$R.RequireFiniteNumber(e),$R.RequireFiniteNumber(t);const s=dP.get(this);s._SetImageScaleX(e),s._SetImageScaleY(t)}getImageScale(){const e=dP.get(this);return[e._GetImageScaleX(),e._GetImageScaleY()]}set imageAngle(e){$R.RequireFiniteNumber(e),dP.get(this)._SetImageAngle(e)}get imageAngle(){return dP.get(this)._GetImageAngle()}set imageAngleDegrees(e){$R.RequireFiniteNumber(e),dP.get(this)._SetImageAngle(XR.toRadians(e))}get imageAngleDegrees(){return XR.toDegrees(dP.get(this)._GetImageAngle())}get imageWidth(){return dP.get(this).GetCurrentImageInfo().GetWidth()}get imageHeight(){return dP.get(this).GetCurrentImageInfo().GetHeight()}getImageSize(){const e=dP.get(this).GetCurrentImageInfo();return[e.GetWidth(),e.GetHeight()]}set enableTileRandomization(e){dP.get(this)._SetTileRandomizationEnabled(!!e)}get enableTileRandomization(){return dP.get(this)._IsTileRandomizationEnabled()}set tileXRandom(e){$R.RequireFiniteNumber(e),dP.get(this)._SetTileXRandom(e)}get tileXRandom(){return dP.get(this)._GetTileXRandom()}set tileYRandom(e){$R.RequireFiniteNumber(e),dP.get(this)._SetTileYRandom(e)}get tileYRandom(){return dP.get(this)._GetTileYRandom()}setTileRandom(e,t){$R.RequireFiniteNumber(e),$R.RequireFiniteNumber(t);const s=dP.get(this);s._SetTileXRandom(e),s._SetTileYRandom(t)}getTileRandom(){const e=dP.get(this);return[e._GetTileXRandom(),e._GetTileYRandom()]}set tileAngleRandom(e){$R.RequireFiniteNumber(e),dP.get(this)._SetTileAngleRandom(e)}get tileAngleRandom(){return dP.get(this)._GetTileAngleRandom()}set tileBlendMarginX(e){$R.RequireFiniteNumber(e),dP.get(this)._SetTileBlendMarginX(e)}get tileBlendMarginX(){return dP.get(this)._GetTileBlendMarginX()}set tileBlendMarginY(e){$R.RequireFiniteNumber(e),dP.get(this)._SetTileBlendMarginY(e)}get tileBlendMarginY(){return dP.get(this)._GetTileBlendMarginY()}setTileBlendMargin(e,t){$R.RequireFiniteNumber(e),$R.RequireFiniteNumber(t);const s=dP.get(this);s._SetTileBlendMarginX(e),s._SetTileBlendMarginY(t)}getTileBlendMargin(){const e=dP.get(this);return[e._GetTileBlendMarginX(),e._GetTileBlendMarginY()]}async replaceImage(e){$R.RequireInstanceOf(e,Blob);const t=dP.get(this),s=t.GetRuntime(),i=XR.New(XR.ImageInfo);i.LoadDynamicBlobAsset(s,e),await i.LoadStaticTexture(s.GetRenderer(),{sampling:s.GetSampling(),wrapX:t.GetSdkType().GetWrapModeX(),wrapY:t.GetSdkType().GetWrapModeY()}),t.WasReleased()?i.Release():(t._ReleaseOwnImage(),t._ownImageInfo=i,s.UpdateRender())}}}self.C3.Plugins.TiledBg.Cnds={OnURLLoaded:()=>!0,OnURLFailed:()=>!0,IsTileRandomizationEnabled(){return this._IsTileRandomizationEnabled()}};{const pP=self.C3;pP.Plugins.TiledBg.Acts={SetImageOffsetX(e){this._SetImageOffsetX(e)},SetImageOffsetY(e){this._SetImageOffsetY(e)},SetImageScaleX(e){this._SetImageScaleX(e/100)},SetImageScaleY(e){this._SetImageScaleY(e/100)},SetImageAngle(e){this._SetImageAngle(pP.toRadians(e))},SetTileRandomizationEnabled(e){this._SetTileRandomizationEnabled(e)},SetTilePosRandom(e,t){this._SetTileXRandom(e/100),this._SetTileYRandom(t/100)},SetTileAngleRandom(e){this._SetTileAngleRandom(e/100)},SetTileBlendMargin(e,t){this._SetTileBlendMarginX(e/100),this._SetTileBlendMarginY(t/100)},SetEffect(e){this.GetWorldInfo().SetBlendMode(e),this._runtime.UpdateRender()},async LoadURL(e,t){if(this._ownImageInfo&&this._ownImageInfo.GetURL()===e)return;const s=this._runtime,i=pP.New(pP.ImageInfo);try{if(await i.LoadDynamicAsset(s,e,!0),!i.IsLoaded())throw new Error("image failed to load");if(this.WasReleased())return i.Release(),null;if(!await i.LoadStaticTexture(s.GetRenderer(),{sampling:s.GetSampling(),wrapX:this.GetSdkType().GetWrapModeX(),wrapY:this.GetSdkType().GetWrapModeY()}))return}catch(e){return console.error("Load image from URL failed: ",e),void(this.WasReleased()||this.Trigger(pP.Plugins.TiledBg.Cnds.OnURLFailed))}this.WasReleased()?i.Release():(this._ReleaseOwnImage(),this._ownImageInfo=i,s.UpdateRender(),await this.TriggerAsync(pP.Plugins.TiledBg.Cnds.OnURLLoaded))}}}{const _P=self.C3;_P.Plugins.TiledBg.Exps={ImageWidth(){return this.GetCurrentImageInfo().GetWidth()},ImageHeight(){return this.GetCurrentImageInfo().GetHeight()},ImageOffsetX(){return this._imageOffsetX},ImageOffsetY(){return this._imageOffsetY},ImageScaleX(){return 100*this._imageScaleX},ImageScaleY(){return 100*this._imageScaleY},ImageAngle(){return _P.toDegrees(this._imageAngle)},TileXRandom(){return 100*this._GetTileXRandom()},TileYRandom(){return 100*this._GetTileYRandom()},TileAngleRandom(){return 100*this._GetTileAngleRandom()},TileBlendMarginX(){return 100*this._GetTileBlendMarginX()},TileBlendMarginY(){return 100*this._GetTileBlendMarginY()}}}{const mP=self.C3;mP.Plugins.Text=class extends mP.SDKPluginBase{constructor(e){super(e)}Release(){super.Release()}}}{const fP=self.C3;fP.Plugins.Text.Type=class extends fP.SDKTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}LoadTextures(e){}ReleaseTextures(){}}}{const gP=self.C3,yP=self.C3X,SP=[0,0,0],TP=0,xP=1,bP=2,GP=3,IP=4,vP=5,CP=6,wP=7,AP=8,RP=9,PP=10,MP=11,EP=12,DP=13,NP=15,FP=["left","center","right"],OP=["top","center","bottom"],BP=["ltr","rtl"],LP=["word","cjk","character"],kP=new gP.Rect,VP=new gP.Quad,UP=new gP.Color,WP=gP.New(gP.Vector2),HP=new Map([["b","strong"],["i","em"],["s","s"],["u","u"],["iconoffsety",null]]);gP.Plugins.Text.Instance=class extends gP.SDKWorldInstanceBase{constructor(e,t){if(super(e),this._text="",this._enableBBcode=!0,this._faceName="Arial",this._ptSize=12,this._lineHeightOffset=0,this._isBold=!1,this._isItalic=!1,this._color=gP.New(gP.Color),this._horizontalAlign=0,this._verticalAlign=0,this._wrapMode="word",this._textDirection=0,this._resolutionMode="auto",this._fixedScaleFactor=1,this._iconObjectClass=null,this._htmlString="",this._isHtmlStringUpToDate=!1,this._readAloud=!1,this._screenReaderText=null,this._typewriterStartTime=-1,this._typewriterEndTime=-1,this._typewriterLength=0,this._rendererText=gP.New(gP.Gfx.RendererText,this._runtime.GetRenderer(),{timeout:5}),this._rendererText.ontextureupdate=()=>this._runtime.UpdateRender(),this._animationframeimagechange_handler=()=>this._OnIconObjectClassImageChanged(),this._pendingUpdateIconSet=!1,t){this._text=t[TP],this._enableBBcode=!!t[xP],this._faceName=t[bP],this._ptSize=t[GP],this._lineHeightOffset=t[IP],this._isBold=!!t[vP],this._isItalic=!!t[CP],this._horizontalAlign=t[AP],this._verticalAlign=t[RP],this._wrapMode=LP[t[PP]],this._textDirection=t[MP],this._SetIconObjectClass(this._runtime.GetObjectClassBySID(t[EP]));const e=t[wP];this._color.setRgb(e[0],e[1],e[2]),this.GetWorldInfo().SetVisible(t[DP]),this._readAloud=!!t[NP]}this._UpdateTextSettings(),this._UpdateScreenReaderText()}Release(){this._SetIconObjectClass(null),this._CancelTypewriter(),this._screenReaderText&&(this._screenReaderText.Release(),this._screenReaderText=null),this._rendererText.Release(),this._rendererText=null,super.Release()}_UpdateTextSettings(){const e=this._rendererText;e.SetText(this._text),e.SetBBCodeEnabled(this._enableBBcode),this._rendererText.IsBBCodeEnabled()&&this._iconObjectClass?this._rendererText.SetIconSet(this.GetRuntime().GetTextIconSet(this._iconObjectClass)):this._rendererText.SetIconSet(null),e.SetIconSmoothing("nearest"!==this._runtime.GetSampling()),e.SetFontName(this._faceName),e.SetLineHeight(this._lineHeightOffset),e.SetBold(this._isBold),e.SetItalic(this._isItalic),e.SetColor(this._color),e.SetHorizontalAlignment(FP[this._horizontalAlign]),e.SetVerticalAlignment(OP[this._verticalAlign]),e.SetWordWrapMode(this._wrapMode),e.SetTextDirection(BP[this._textDirection])}_UpdateTextSize(){const e=this.GetWorldInfo();this._rendererText.SetFontSize(this._ptSize),this._rendererText.SetFontSizeScale(e.GetSceneGraphScale());const t=e.GetLayer();let s;"auto"===this._resolutionMode?s=t.GetResolutionScaleFactorToZ(e.GetTotalZElevation()):"fixed"===this._resolutionMode&&(s=this._fixedScaleFactor),e.HasMesh()&&s!==this._rendererText.GetZoom()&&e.SetMeshChanged(!0),this._rendererText.SetSize(e.GetWidth(),e.GetHeight(),s)}_SetIconObjectClass(e){e&&(e.IsFamily()||e.GetPlugin().constructor!==gP.Plugins.Sprite)||e!==this._iconObjectClass&&(this._iconObjectClass&&this._iconObjectClass.Dispatcher().removeEventListener("animationframeimagechange",this._animationframeimagechange_handler),this._iconObjectClass=e,this._iconObjectClass&&this._iconObjectClass.Dispatcher().addEventListener("animationframeimagechange",this._animationframeimagechange_handler),this._UpdateTextSettings(),this._isHtmlStringUpToDate=!1,this._runtime.UpdateRender())}_OnIconObjectClassImageChanged(){this._runtime.DeleteTextIconSet(this._iconObjectClass),this._runtime.UpdateRender(),this._pendingUpdateIconSet=!0}_UpdateScreenReaderText(){if(this._readAloud){let e=this._text;this._enableBBcode&&(e=gP.BBString.StripAnyTags(e)),this._screenReaderText?this._screenReaderText.SetText(e):this._screenReaderText=gP.New(gP.ScreenReaderText,this._runtime,e)}else this._screenReaderText&&(this._screenReaderText.Release(),this._screenReaderText=null)}Draw(e){const t=this.GetWorldInfo();this._UpdateTextSize(),this._pendingUpdateIconSet&&(this._pendingUpdateIconSet=!1,this._rendererText.IsBBCodeEnabled()&&this._iconObjectClass&&this._rendererText.SetIconSet(this.GetRuntime().GetTextIconSet(this._iconObjectClass)));const s=this._rendererText.GetTexture();if(!s)return;const i=t.GetLayer();if(0===t.GetAngle()&&0===i.GetAngle()&&0===t.GetTotalZElevation()&&!t.HasMesh()&&i.RendersIn2DMode()){const r=t.GetBoundingQuad(),[n,a]=i.LayerToDrawSurface(r.getTlx(),r.getTly()),[o,l]=i.LayerToDrawSurface(r.getBrx(),r.getBry()),h=n-Math.round(n),u=a-Math.round(a);kP.set(n,a,o,l),kP.offset(-h,-u),VP.setFromRect(kP);const[c,d]=e.GetRenderTargetSize(e.GetRenderTarget());e.IsWebGL()?this._runtime.GetCanvasManager().SetDeviceTransform(e,c,d):(e.SetNormalizedCoordsProgramVariant(!0),VP.divide(c,d)),e.SetTexture(s),e.Quad3(VP,this._rendererText.GetTexRect()),e.IsWebGL()?i._SetTransform(e):e.SetNormalizedCoordsProgramVariant(!1)}else e.SetTexture(s),t.HasMesh()?this._DrawMesh(t,e):this._DrawStandard(t,e)}_DrawStandard(e,t){let s=e.GetBoundingQuad();this._runtime.IsPixelRoundingEnabled()&&(s=this._PixelRoundQuad(s)),t.Quad3(s,this._rendererText.GetTexRect())}_DrawMesh(e,t){const s=e.GetTransformedMesh();if(e.IsMeshChanged()){e.CalculateBbox(kP,VP,!1);let t=VP;this._runtime.IsPixelRoundingEnabled()&&(t=this._PixelRoundQuad(t)),s.CalculateTransformedMesh(e.GetSourceMesh(),t,this._rendererText.GetTexRect()),e.SetMeshChanged(!1)}s.Draw(t,e.GetTotalZElevation())}_PixelRoundQuad(e){const t=e.getTlx()-Math.round(e.getTlx()),s=e.getTly()-Math.round(e.getTly());return 0===t&&0===s?e:(VP.copy(e),VP.offset(-t,-s),VP)}GetCurrentSurfaceSize(){const e=this._rendererText.GetTexture();return e?[e.GetWidth(),e.GetHeight()]:[100,100]}GetCurrentTexRect(){return this._rendererText.GetTexRect()}IsCurrentTexRotated(){return!1}SaveToJson(){const e={t:this._text,c:this._color.toJSON(),fn:this._faceName,ps:this._ptSize};return this._enableBBcode&&(e.bbc=this._enableBBcode),0!==this._horizontalAlign&&(e.ha=this._horizontalAlign),0!==this._verticalAlign&&(e.va=this._verticalAlign),"word"!==this._wrapMode&&(e.wr=this._wrapMode),0!==this._lineHeightOffset&&(e.lho=this._lineHeightOffset),this._isBold&&(e.b=this._isBold),this._isItalic&&(e.i=this._isItalic),-1!==this._typewriterEndTime&&(e.tw={st:this._typewriterStartTime,en:this._typewriterEndTime,l:this._typewriterLength}),this._iconObjectClass&&(e.ioc=this._iconObjectClass.GetSID()),"fixed"===this._resolutionMode&&(e.fs=this._fixedScaleFactor),e}LoadFromJson(e){if(this._CancelTypewriter(),this._text=e.t,this._color.setFromJSON(e.c),this._faceName=e.fn,this._ptSize=e.ps,this._enableBBcode=!!e.hasOwnProperty("bbc")&&e.bbc,this._horizontalAlign=e.hasOwnProperty("ha")?e.ha:0,this._verticalAlign=e.hasOwnProperty("va")?e.va:0,e.hasOwnProperty("wr")){const t=e.wr;this._wrapMode="boolean"==typeof t?t?"word":"character":t}else this._wrapMode="word";if(this._lineHeightOffset=e.hasOwnProperty("lho")?e.lho:0,this._isBold=!!e.hasOwnProperty("b")&&e.b,this._isItalic=!!e.hasOwnProperty("i")&&e.i,e.hasOwnProperty("tw")){const t=e.tw;this._typewriterStartTime=t.st,this._typewriterEndTime=t.en,this._typewriterLength=t.l}if(e.hasOwnProperty("ioc")){const t=this.GetRuntime().GetObjectClassBySID(e.ioc);t&&this._SetIconObjectClass(t)}else this._SetIconObjectClass(null);e.hasOwnProperty("fs")?(this._resolutionMode="fixed",this._fixedScaleFactor=e.fs):this._resolutionMode="auto",this._UpdateTextSettings(),this._UpdateScreenReaderText(),this._isHtmlStringUpToDate=!1,-1!==this._typewriterEndTime&&this._StartTicking()}GetPropertyValueByIndex(e){switch(e){case TP:return this.GetText();case xP:return this._enableBBcode;case bP:return this._GetFontFace();case GP:return this._GetFontSize();case IP:return this._GetLineHeight();case vP:return this._IsBold();case CP:return this._IsItalic();case wP:return SP[0]=this._color.getR(),SP[1]=this._color.getG(),SP[2]=this._color.getB(),SP;case AP:return this._GetHAlign();case RP:return this._GetVAlign();case PP:return this._GetWrapMode();case NP:return this._IsReadAloud()}}SetPropertyValueByIndex(e,t){switch(e){case TP:this._SetText(t);break;case xP:if(this._enableBBcode===!!t)return;this._enableBBcode=!!t,this._UpdateTextSettings();break;case bP:this._SetFontFace(t);break;case GP:this._SetFontSize(t);break;case IP:this._SetLineHeight(t);break;case vP:this._SetBold(t);break;case CP:this._SetItalic(t);break;case wP:const e=this._color,s=t;if(e.getR()===s[0]&&e.getG()===s[1]&&e.getB()===s[2])return;this._color.setRgb(s[0],s[1],s[2]),this._UpdateTextSettings();break;case AP:this._SetHAlign(t);break;case RP:this._SetVAlign(t);break;case PP:this._SetWrapMode(t)}}SetPropertyColorOffsetValueByIndex(e,t,s,i){0===t&&0===s&&0===i||e!==wP||(this._color.addRgb(t,s,i),this._UpdateTextSettings())}_SetText(e){this._text!==e&&(this._text=e,this._rendererText.SetText(e),this._UpdateScreenReaderText(),this._isHtmlStringUpToDate=!1,this._runtime.UpdateRender())}GetText(){return this._text}_StartTypewriter(e,t){this._UpdateTextSize(),this._SetText(e),this._typewriterStartTime=this._runtime.GetWallTime(),this._typewriterEndTime=this._typewriterStartTime+t/this.GetInstance().GetActiveTimeScale(),this._typewriterLength=this._rendererText.GetLengthInGraphemes(),this._rendererText.SetDrawMaxCharacterCount(0),this._StartTicking()}_CancelTypewriter(){this._typewriterStartTime=-1,this._typewriterEndTime=-1,this._typewriterLength=0,this._rendererText.SetDrawMaxCharacterCount(-1),this._StopTicking()}_FinishTypewriter(){-1!==this._typewriterEndTime&&(this._CancelTypewriter(),this.Trigger(gP.Plugins.Text.Cnds.OnTypewriterTextFinished),this._runtime.UpdateRender())}_SetFontFace(e){this._faceName!==e&&(this._faceName=e,this._rendererText.SetFontName(e),this._runtime.UpdateRender())}_GetFontFace(){return this._faceName}_SetBold(e){e=!!e,this._isBold!==e&&(this._isBold=e,this._rendererText.SetBold(e),this._runtime.UpdateRender())}_IsBold(){return this._isBold}_SetItalic(e){e=!!e,this._isItalic!==e&&(this._isItalic=e,this._rendererText.SetItalic(e),this._runtime.UpdateRender())}_IsItalic(){return this._isItalic}_SetFontSize(e){this._ptSize!==e&&(this._ptSize=e,this._runtime.UpdateRender())}_GetFontSize(){return this._ptSize}_SetFontColor(e){this._color.equalsIgnoringAlpha(e)||(this._color.copyRgb(e),this._rendererText.SetColor(this._color),this._runtime.UpdateRender())}_GetFontColor(){return this._color}_SetLineHeight(e){this._lineHeightOffset!==e&&(this._lineHeightOffset=e,this._UpdateTextSettings(),this._runtime.UpdateRender())}_GetLineHeight(){return this._lineHeightOffset}_SetHAlign(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this._UpdateTextSettings(),this._runtime.UpdateRender())}_GetHAlign(){return this._horizontalAlign}_SetVAlign(e){this._verticalAlign!==e&&(this._verticalAlign=e,this._UpdateTextSettings(),this._runtime.UpdateRender())}_GetVAlign(){return this._verticalAlign}_SetWrapModeByIndex(e){this._SetWrapMode(LP[e])}_SetWrapMode(e){this._wrapMode!==e&&(this._wrapMode=e,this._UpdateTextSettings(),this._runtime.UpdateRender())}_GetWrapMode(){return this._wrapMode}_SetTextDirection(e){this._textDirection!==e&&(this._textDirection=e,this._UpdateTextSettings(),this._runtime.UpdateRender())}_GetTextDirection(){return this._textDirection}_SetReadAloud(e){this._readAloud=!!e,this._UpdateScreenReaderText()}_IsReadAloud(){return this._readAloud}_SetResolutionMode(e){this._resolutionMode!==e&&(this._resolutionMode=e,this._runtime.UpdateRender())}_GetResolutionMode(){return this._resolutionMode}_SetFixedScaleFactor(e){this._fixedScaleFactor!==e&&(this._fixedScaleFactor=e,"fixed"===this._resolutionMode&&this._runtime.UpdateRender())}_GetFixedScaleFactor(){return this._fixedScaleFactor}_GetTextWidth(){return this._UpdateTextSize(),this._rendererText.GetTextWidth()}_GetTextHeight(){return this._UpdateTextSize(),this._rendererText.GetTextHeight()}_GetTagAtPosition(e,t){this._UpdateTextSize();const s=this.GetWorldInfo();WP.set(e-s.GetX(),t-s.GetY()),WP.rotate(-s.GetAngle()),WP.offset(s.GetWidth()*s.GetOriginX(),s.GetHeight()*s.GetOriginY()),WP.divide(s.GetWidth(),s.GetHeight()),WP.scale(this._rendererText.GetWidth(),this._rendererText.GetHeight());const i=this._rendererText.HitTestFragment(WP.getX(),WP.getY());if(i){const e=i.GetStyleTag("tag");if(e)return e.param}return""}_HasTagAtPosition(e,t,s){const i=this._GetTagAtPosition(t,s);return i&&gP.equalsNoCase(e,i)}_GetTagPosition(e,t){this._UpdateTextSize(),t=Math.floor(t);const s=this._rendererText.FindFragmentWithTag(e,t);if(!s)return null;const i=this.GetWorldInfo(),r=this._rendererText.GetDrawScale(),n=s.GetPosX(),a=s.GetPosY()-(s.GetHeight()-s.GetFontBoundingBoxDescent())*r,o=s.GetWidth()*r/this._rendererText.GetWidth()*i.GetWidth(),l=s.GetHeight()*r/this._rendererText.GetHeight()*i.GetHeight();return WP.set(n,a),WP.divide(this._rendererText.GetWidth(),this._rendererText.GetHeight()),WP.scale(i.GetWidth(),i.GetHeight()),WP.offset(-i.GetWidth()*i.GetOriginX(),-i.GetHeight()*i.GetOriginY()),WP.rotate(i.GetAngle()),WP.offset(i.GetX(),i.GetY()),{x:WP.getX(),y:WP.getY(),width:o,height:l}}_GetTagCount(e){return this._UpdateTextSize(),this._rendererText.CountFragmentsWithTag(e)}_GetHTMLCloseTag(e){let t=HP.get(e);return null===t?"":(t||(t="span"),`</${t||"span"}>`)}_GetHTMLOpenTag(e,t){let s=HP.get(e);if(null===s)return"";switch(s||(s="span"),e){case"color":return`<${s} style="color: ${t}">`;case"font":return`<${s} style="font-family: '${t}'">`;case"opacity":return`<${s} style="opacity: ${t}%">`;case"size":return`<${s} style="font-size: ${t}pt">`;case"background":return`<${s} style="background-color: ${t}">`;case"hide":return`<${s} style="visibility: hidden">`;case"class":return`<${s} class="${t}">`;case"tag":return`<${s} data-tag="${t}">`;default:return`<${s}>`}}async _UpdateHTMLString(){if(this._isHtmlStringUpToDate)return this._htmlString;const e=new gP.BBString(this._text,{noEscape:!0}).toFragmentList(),t=new Map;let s='<span class="c3-text"';const i=[];i.push(`font-family: '${this._GetFontFace()}';`),this._IsBold()&&i.push("font-weight: bold;"),this._IsItalic()&&i.push("font-style: italic;"),"character"===this._GetWrapMode()&&i.push("word-break: break-all;"),s+=` style="${i.join(" ")}">`;const r=this._iconObjectClass?this.GetRuntime().GetTextIconSet(this._iconObjectClass):null;if(this._iconObjectClass){const s=gP.New(gP.PromiseThrottle),i=[],n=new Map;for(const t of e)if(t.IsIcon()){const e=t.GetTextIcon(r);if(e){const t=e.GetSource().GetImageInfo().GetImageAsset();if(n.has(t))continue;n.set(t,null),i.push(s.Add(async()=>{const e=await t.LoadToDrawable();n.set(t,e)}))}}await Promise.all(i);const a=[];for(const i of e)if(i.IsIcon()){const e=i.GetTextIcon(r);if(e){const i=e.GetSource(),r=i.GetImageInfo().GetImageAsset();a.push(s.Add(async()=>{const s=await i.GetImageInfo().ExtractImageToBlobURL(n.get(r));t.set(e,s)}))}}await Promise.all(a);for(const e of n.values())e instanceof ImageBitmap&&e.close&&e.close()}const n=new Map;for(const i of e){const e=i.GetStyleMap();let a=[...n.keys()];a.reverse();for(const t of a)e.has(t)&&e.get(t)===n.get(t)||(n.delete(t),s+=this._GetHTMLCloseTag(t));for(const[t,i]of e)n.has(t)||(n.set(t,i),s+=this._GetHTMLOpenTag(t,i));if(i.IsText()&&(s+=gP.ReplaceAll(gP.EscapeHTML(i.GetCharacterArray().join("")),"\n","<br>")),i.IsIcon()&&r){const n=i.GetTextIcon(r);if(n){const r=t.get(n);if(r){const t=[];let a="0.2em";const o=e.get("iconoffsety");if(o){let e=o.trim();a=e.endsWith("%")?parseFloat(e)/100+"em":e+"px"}t.push(`top: ${a}`),"nearest"===this._runtime.GetSampling()&&t.push("image-rendering: pixelated"),s+=`<img class="c3-text-icon" data-icon="${i.GetIconParameter()}" width="${n.GetWidth()}" height="${n.GetHeight()}" style="${t.join(";")}" src="${r}">`}}}}const a=[...n.keys()];a.reverse();for(const e of a)s+=this._GetHTMLCloseTag(e);return s+="</span>",this._htmlString=s,this._isHtmlStringUpToDate=!0,this._htmlString}Tick(){const e=this._runtime.GetWallTime();if(e>=this._typewriterEndTime)this._CancelTypewriter(),this.Trigger(gP.Plugins.Text.Cnds.OnTypewriterTextFinished),this._runtime.UpdateRender();else{let t=gP.relerp(this._typewriterStartTime,this._typewriterEndTime,e,0,this._typewriterLength);t=Math.floor(t),t!==this._rendererText.GetDrawMaxCharacterCount()&&(this._rendererText.SetDrawMaxCharacterCount(t),this._runtime.UpdateRender())}}GetDebuggerProperties(){const e="plugins.text";return[{title:e+".name",properties:[{name:e+".properties.text.name",value:this.GetText(),onedit:e=>this._SetText(e)},{name:e+".properties.font.name",value:this._GetFontFace(),onedit:e=>this._SetFontFace(e)},{name:e+".properties.size.name",value:this._GetFontSize(),onedit:e=>this._SetFontSize(e)},{name:e+".properties.line-height.name",value:this._GetLineHeight(),onedit:e=>this._SetLineHeight(e)},{name:e+".properties.bold.name",value:this._IsBold(),onedit:e=>this._SetBold(e)},{name:e+".properties.italic.name",value:this._IsItalic(),onedit:e=>this._SetItalic(e)},{name:e+".debugger.text-width",value:this._GetTextWidth()},{name:e+".debugger.text-height",value:this._GetTextHeight()}]}]}GetScriptInterfaceClass(){return self.ITextInstance}};const zP=new WeakMap,jP=new Map([["left",0],["center",1],["right",2]]),YP=new Map([["top",0],["center",1],["bottom",2]]),qP=["ltr","rtl"];self.ITextInstance=class extends self.IWorldInstance{constructor(){super(),zP.set(this,self.IInstance._GetInitInst().GetSdkInstance())}get text(){return zP.get(this).GetText()}set text(e){yP.RequireString(e);const t=zP.get(this);t._CancelTypewriter(),t._SetText(e)}typewriterText(e,t){yP.RequireString(e),yP.RequireFiniteNumber(t);const s=zP.get(this);s._CancelTypewriter(),s._StartTypewriter(e,t)}typewriterFinish(){zP.get(this)._FinishTypewriter()}set fontFace(e){yP.RequireString(e),zP.get(this)._SetFontFace(e)}get fontFace(){return zP.get(this)._GetFontFace()}set isBold(e){zP.get(this)._SetBold(e)}get isBold(){return zP.get(this)._IsBold()}set isItalic(e){zP.get(this)._SetItalic(e)}get isItalic(){return zP.get(this)._IsItalic()}set sizePt(e){yP.RequireFiniteNumber(e),zP.get(this)._SetFontSize(e)}get sizePt(){return zP.get(this)._GetFontSize()}set fontColor(e){if(yP.RequireArray(e),e.length<3)throw new Error("expected 3 elements");UP.setRgb(e[0],e[1],e[2]),zP.get(this)._SetFontColor(UP)}get fontColor(){const e=zP.get(this)._GetFontColor();return[e.getR(),e.getG(),e.getB()]}set lineHeight(e){yP.RequireFiniteNumber(e),zP.get(this)._SetLineHeight(e)}get lineHeight(){return zP.get(this)._GetLineHeight()}set horizontalAlign(e){yP.RequireString(e);const t=jP.get(e);if(void 0===t)throw new Error("invalid mode");zP.get(this)._SetHAlign(t)}get horizontalAlign(){return FP[zP.get(this)._GetHAlign()]}set verticalAlign(e){yP.RequireString(e);const t=YP.get(e);if(void 0===t)throw new Error("invalid mode");zP.get(this)._SetVAlign(t)}get verticalAlign(){return OP[zP.get(this)._GetVAlign()]}set wordWrapMode(e){if(!LP.includes(e))throw new Error("invalid mode");zP.get(this)._SetWrapMode(e)}get wordWrapMode(){return zP.get(this)._GetWrapMode()}set textDirection(e){yP.RequireString(e);const t=qP.indexOf(e);if(-1===t)throw new Error("invalid text direction");zP.get(this)._SetTextDirection(t)}get textDirection(){return qP[zP.get(this)._GetTextDirection()]}set readAloud(e){zP.get(this)._SetReadAloud(!!e)}get readAloud(){return zP.get(this)._IsReadAloud()}setFixedResolutionMode(e){yP.RequireFiniteNumber(e);const t=zP.get(this);t._SetResolutionMode("fixed"),t._SetFixedScaleFactor(e)}setAutoResolutionMode(){zP.get(this)._SetResolutionMode("auto")}get textWidth(){return zP.get(this)._GetTextWidth()}get textHeight(){return zP.get(this)._GetTextHeight()}getTextSize(){const e=zP.get(this);return[e._GetTextWidth(),e._GetTextHeight()]}hasTagAtPosition(e,t,s){return yP.RequireString(e),yP.RequireFiniteNumber(t),yP.RequireFiniteNumber(s),zP.get(this)._HasTagAtPosition(e,t,s)}getTagAtPosition(e,t){return yP.RequireFiniteNumber(e),yP.RequireFiniteNumber(t),zP.get(this)._GetTagAtPosition(e,t)}getTagPositionAndSize(e,t=0){return yP.RequireString(e),yP.RequireFiniteNumber(t),zP.get(this)._GetTagPosition(e,t)}getTagCount(e){return yP.RequireString(e),zP.get(this)._GetTagCount(e)}changeIconSet(e){const t=zP.get(this),s=t.GetRuntime()._UnwrapIObjectClass(e);t._SetIconObjectClass(s)}getAsHtmlString(){return zP.get(this)._UpdateHTMLString()}}}{const XP=self.C3;XP.Plugins.Text.Cnds={CompareText(e,t){return t?this._text===e:XP.equalsNoCase(this._text,e)},IsRunningTypewriterText(){return-1!==this._typewriterEndTime},OnTypewriterTextFinished:()=>!0,HasTagAtPosition(e,t,s){return this._HasTagAtPosition(e,t,s)}}}{const $P=self.C3,KP=$P.New($P.Color);$P.Plugins.Text.Acts={SetText(e){this._CancelTypewriter(),"number"==typeof e&&e<1e9&&(e=Math.round(1e10*e)/1e10),this._SetText(e.toString())},AppendText(e){this._CancelTypewriter(),"number"==typeof e&&e<1e9&&(e=Math.round(1e10*e)/1e10),(e=e.toString())&&this._SetText(this._text+e)},TypewriterText(e,t){this._CancelTypewriter(),"number"==typeof e&&e<1e9&&(e=Math.round(1e10*e)/1e10),this._StartTypewriter(e.toString(),t)},SetFontFace(e,t){let s=!1,i=!1;switch(t){case 1:s=!0;break;case 2:i=!0;break;case 3:s=!0,i=!0}e===this._faceName&&s===this._isBold&&i===this._isItalic||(this._SetFontFace(e),this._SetBold(s),this._SetItalic(i))},SetFontSize(e){this._SetFontSize(e)},SetFontColor(e){KP.setFromRgbValue(e),KP.clamp(),this._SetFontColor(KP)},SetWebFont(e,t){console.warn("[Text] 'Set web font' action is deprecated and no longer has any effect")},SetEffect(e){this.GetWorldInfo().SetBlendMode(e),this._runtime.UpdateRender()},TypewriterFinish(){this._FinishTypewriter()},SetLineHeight(e){this._SetLineHeight(e)},SetHAlign(e){this._SetHAlign(e)},SetVAlign(e){this._SetVAlign(e)},SetWrapping(e){this._SetWrapModeByIndex(e)},SetTextDirection(e){this._SetTextDirection(e)},ChangeIconSet(e){this._SetIconObjectClass(e)},UpdateHTML(){return this._UpdateHTMLString()},SetReadAloud(e){this._SetReadAloud(e)},SetResolutionMode(e,t){this._SetResolutionMode(["auto","fixed"][e]),this._SetFixedScaleFactor(t)}}}{const JP=self.C3;JP.Plugins.Text.Exps={Text(){return this._text},PlainText(){return this._enableBBcode?JP.BBString.StripAnyTags(this._text):this._text},FaceName(){return this._faceName},FaceSize(){return this._ptSize},TextWidth(){return this._GetTextWidth()},TextHeight(){return this._GetTextHeight()},LineHeight(){return this._lineHeightOffset},TagAtPosition(e,t){return this._GetTagAtPosition(e,t)},TagCount(e){return this._GetTagCount(e)},TagX(e,t){const s=this._GetTagPosition(e,t);return s?s.x:0},TagY(e,t){const s=this._GetTagPosition(e,t);return s?s.y:0},TagWidth(e,t){const s=this._GetTagPosition(e,t);return s?s.width:0},TagHeight(e,t){const s=this._GetTagPosition(e,t);return s?s.height:0},AsHTML(){return this._htmlString}}}{const QP=self.C3;QP.Plugins.NinePatch=class extends QP.SDKPluginBase{constructor(e){super(e)}Release(){super.Release()}}}{const ZP=self.C3;ZP.Plugins.NinePatch.Type=class extends ZP.SDKTypeBase{constructor(e){super(e),this._textureSet=null,this._drawable=null}Release(){this.ReleaseTextures(),super.Release()}OnCreate(){this.GetImageInfo().LoadAsset(this._runtime)}async LoadTextures(e){const t=this.GetImageInfo();this._drawable=await t.ExtractImageToCanvas()}CreatePatch(e,t,s,i){!this._textureSet&&this._drawable&&(this._textureSet=new self.NinePatchTextureSet(this),this._textureSet.CreateTextures(this._drawable,e,t,s,i))}ReleaseTextures(){this._textureSet&&(this._textureSet.Release(),this._textureSet=null)}GetTextureSet(){return this._textureSet}}}{const eM=self.C3,tM=0,sM=1,iM=2,rM=3,nM=4,aM=5,oM=6,lM=8,hM=eM.New(eM.Rect),uM=eM.New(eM.Rect),cM=eM.New(eM.Quad);eM.Plugins.NinePatch.Instance=class extends eM.SDKWorldInstanceBase{constructor(e,t){super(e),this._leftMargin=16,this._rightMargin=16,this._topMargin=16,this._bottomMargin=16,this._edges=1,this._fill=1,this._isSeamless=!0,this._callback3d=null,t&&(this._leftMargin=t[tM],this._rightMargin=t[sM],this._topMargin=t[iM],this._bottomMargin=t[rM],this._edges=t[nM],this._fill=t[aM],this._isSeamless=!!t[lM],this.GetWorldInfo().SetVisible(!!t[oM])),this._sdkType.CreatePatch(this._leftMargin,this._rightMargin,this._topMargin,this._bottomMargin)}Release(){super.Release()}_Set3DCallback(e){this._callback3d=e}Draw(e){const t=this.GetWorldInfo(),s=t.GetBoundingQuad();this._Draw(e,s.getTlx(),s.getTly(),t.GetWidth(),t.GetHeight())}_Draw(e,t,s,i,r){let n=this._sdkType.GetTextureSet();if(!n&&(this._sdkType.CreatePatch(this._leftMargin,this._rightMargin,this._topMargin,this._bottomMargin),n=this._sdkType.GetTextureSet(),!n))return;const a=n.GetImageWidth(),o=n.GetImageHeight(),l=Math.min(this._leftMargin,a),h=Math.min(this._rightMargin,a),u=Math.min(this._topMargin,o),c=Math.min(this._bottomMargin,o),d=a-h,p=o-c,_=this._isSeamless?1:0,m=this._edges,f=this._fill;if(l>0&&u>0&&this._DrawPatch(e,n.GetTexture(),0,0,l+_,u+_,t,s,l+_,u+_),h>0&&u>0&&this._DrawPatch(e,n.GetTexture(),d-_,0,h+_,u+_,t+i-h-_,s,h+_,u+_),h>0&&c>0&&this._DrawPatch(e,n.GetTexture(),d-_,p-_,h+_,c+_,t+i-h-_,s+r-c-_,h+_,c+_),l>0&&c>0&&this._DrawPatch(e,n.GetTexture(),0,p-_,l+_,c+_,t,s+r-c-_,l+_,c+_),0===m){const a=2===f?0:_;l>0&&p>u&&this._TilePatch(e,n.GetLeftTexture(),t,s+u,l+a,r-u-c,0,0),h>0&&p>u&&this._TilePatch(e,n.GetRightTexture(),t+i-h-a,s+u,h+a,r-u-c,a,0),u>0&&d>l&&this._TilePatch(e,n.GetTopTexture(),t+l,s,i-l-h,u+a,0,0),c>0&&d>l&&this._TilePatch(e,n.GetBottomTexture(),t+l,s+r-c-a,i-l-h,c+a,0,a)}else 1===m&&(l>0&&p>u&&this._DrawPatch(e,n.GetTexture(),0,u,l,p-u,t,s+u,l,r-u-c),h>0&&p>u&&this._DrawPatch(e,n.GetTexture(),d,u,h,p-u,t+i-h,s+u,h,r-u-c),u>0&&d>l&&this._DrawPatch(e,n.GetTexture(),l,0,d-l,u,t+l,s,i-l-h,u),c>0&&d>l&&this._DrawPatch(e,n.GetTexture(),l,p,d-l,c,t+l,s+r-c,i-l-h,c));p>u&&d>l&&(0===f?this._TilePatch(e,n.GetFillTexture(),t+l,s+u,i-l-h,r-u-c,0,0):1===f&&this._DrawPatch(e,n.GetTexture(),l,u,d-l,p-u,t+l,s+u,i-l-h,r-u-c))}_DrawPatch(e,t,s,i,r,n,a,o,l,h){const u=t.GetWidth(),c=t.GetHeight();if(e.SetTexture(t),hM.set(a,o,a+l,o+h),uM.set(s/u,i/c,(s+r)/u,(i+n)/c),null===this._callback3d){const t=this.GetWorldInfo(),s=t.GetBoundingQuad(),i=s.getTlx(),r=s.getTly();hM.offset(-i,-r),cM.setFromRotatedRect(hM,t.GetAngle()),cM.offset(i,r),e.Quad3(cM,uM)}else this._callback3d(hM,uM)}_TilePatch(e,t,s,i,r,n,a,o){const l=t.GetWidth(),h=t.GetHeight();if(e.SetTexture(t),hM.set(s,i,s+r,i+n),uM.set(-a/l,-o/h,(r-a)/l,(n-o)/h),null===this._callback3d){const t=this.GetWorldInfo(),s=t.GetBoundingQuad(),i=s.getTlx(),r=s.getTly();hM.offset(-i,-r),cM.setFromRotatedRect(hM,t.GetAngle()),cM.offset(i,r),e.Quad3(cM,uM)}else this._callback3d(hM,uM)}GetCurrentImageInfo(){this._objectClass.GetImageInfo()}GetPropertyValueByIndex(e){}SetPropertyValueByIndex(e,t){}}}self.C3.Plugins.NinePatch.Cnds={},self.C3.Plugins.NinePatch.Acts={SetEffect(e){this.GetWorldInfo().SetBlendMode(e),this._runtime.UpdateRender()}},self.C3.Plugins.NinePatch.Exps={};{let dM=function(e){const t=pM.CreateCanvas(e.width,e.height);return t.getContext("2d").drawImage(e,0,0),t};CloneDrawable=dM;const pM=self.C3;self.NinePatchTextureSet=class{constructor(e){this._sdkType=e,this._runtime=this._sdkType.GetRuntime(),this._texture=null,this._fillTexture=null,this._leftTexture=null,this._rightTexture=null,this._topTexture=null,this._bottomTexture=null,this._imageWidth=0,this._imageHeight=0,this._renderer=this._runtime.GetRenderer(),this._isLoading=!1,this._wasReleased=!1}Release(){this._renderer.IsContextLost()||(this._renderer.DeleteTexture(this._texture),this._renderer.DeleteTexture(this._fillTexture),this._renderer.DeleteTexture(this._leftTexture),this._renderer.DeleteTexture(this._rightTexture),this._renderer.DeleteTexture(this._topTexture),this._renderer.DeleteTexture(this._bottomTexture)),this._texture=null,this._fillTexture=null,this._leftTexture=null,this._rightTexture=null,this._topTexture=null,this._bottomTexture=null,this._sdkType=null,this._renderer=null,this._wasReleased=!0}WasReleased(){return this._wasReleased}CreateTextures(e,t,s,i,r){this._SliceImage(e,t,s,i,r)}HasCreatedTextures(){return!!this._texture}_SliceImage(e,t,s,i,r){if(this._wasReleased)return;const n=e.width,a=e.height;this._imageWidth=n,this._imageHeight=a,t=Math.min(Math.floor(t),n),s=Math.min(Math.floor(s),n),i=Math.min(Math.floor(i),a);const o=n-s,l=a-(r=Math.min(Math.floor(r),a)),h=this._runtime.GetSampling(),u=this._runtime.GetCanvasManager().GetTextureAnisotropy();this._texture=this._renderer.CreateStaticTexture(dM(e),{sampling:h,anisotropy:u}),o>t&&l>i&&(this._fillTexture=this._renderer.CreateStaticTexture(this._SliceSubImage(dM(e),t,i,o,l),{wrapX:"repeat",wrapY:"repeat",sampling:h,anisotropy:u})),t>0&&l>i&&(this._leftTexture=this._renderer.CreateStaticTexture(this._SliceSubImage(dM(e),0,i,t,l),{wrapY:"repeat",sampling:h,anisotropy:u})),s>0&&l>i&&(this._rightTexture=this._renderer.CreateStaticTexture(this._SliceSubImage(dM(e),o,i,n,l),{wrapY:"repeat",sampling:h,anisotropy:u})),i>0&&o>t&&(this._topTexture=this._renderer.CreateStaticTexture(this._SliceSubImage(dM(e),t,0,o,i),{wrapX:"repeat",sampling:h,anisotropy:u})),r>0&&o>t&&(this._bottomTexture=this._renderer.CreateStaticTexture(this._SliceSubImage(dM(e),t,l,o,a),{wrapX:"repeat",sampling:h,anisotropy:u}))}_SliceSubImage(e,t,s,i,r){const n=i-t,a=r-s,o=pM.CreateCanvas(n,a);return o.getContext("2d").drawImage(e,t,s,n,a,0,0,n,a),o}GetImageWidth(){return this._imageWidth}GetImageHeight(){return this._imageHeight}GetTexture(){return this._texture}GetFillTexture(){return this._fillTexture}GetLeftTexture(){return this._leftTexture}GetRightTexture(){return this._rightTexture}GetTopTexture(){return this._topTexture}GetBottomTexture(){return this._bottomTexture}}}{const _M=self.C3,mM="text-input";_M.Plugins.TextBox=class extends _M.SDKDOMPluginBase{constructor(e){super(e,mM),this.AddElementMessageHandler("click",(e,t)=>e._OnClick(t)),this.AddElementMessageHandler("dblclick",(e,t)=>e._OnDoubleClick(t)),this.AddElementMessageHandler("change",(e,t)=>e._OnChange(t))}Release(){super.Release()}}}{const fM=self.C3;fM.Plugins.TextBox.Type=class extends fM.SDKTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const gM=self.C3,yM=self.C3X,SM=0,TM=1,xM=2,bM=3,GM=4,IM=5,vM=6,CM=7,wM=8,AM=9,RM=10,PM="text-input",MM=["text","password","email","number","tel","url","textarea","search"];gM.Plugins.TextBox.Instance=class extends gM.SDKDOMInstanceBase{constructor(e,t){super(e,PM),this._text="",this._placeholder="",this._title="",this._isEnabled=!0,this._isReadOnly=!1,this._spellCheck=!1,this._type="text",this._autoFontSize=!0,this._maxLength=-1,this._id="",this._className="",t&&(this._text=t[SM],this._placeholder=t[TM],this._title=t[xM],this.GetWorldInfo().SetVisible(t[bM]),this._isEnabled=t[GM],this._isReadOnly=t[IM],this._spellCheck=t[vM],this._type=MM[t[CM]],this._autoFontSize=t[wM],this._id=t[AM],this._className=t[RM]),this.CreateElement({type:this._type,id:this._id,className:this._className})}Release(){super.Release()}GetElementState(){return{text:this._text,placeholder:this._placeholder,title:this._title,isEnabled:this._isEnabled,isReadOnly:this._isReadOnly,spellCheck:this._spellCheck,maxLength:this._maxLength}}async _OnClick(e){this.DispatchScriptEvent("click",!0),await this.TriggerAsync(gM.Plugins.TextBox.Cnds.OnClicked)}async _OnDoubleClick(e){this.DispatchScriptEvent("dblclick",!0),await this.TriggerAsync(gM.Plugins.TextBox.Cnds.OnDoubleClicked)}async _OnChange(e){this._text=e.text,this.DispatchScriptEvent("change",!0),await this.TriggerAsync(gM.Plugins.TextBox.Cnds.OnTextChanged)}_SetText(e){this._text!==e&&(this._text=e,this.UpdateElementState())}_GetText(){return this._text}_SetPlaceholder(e){this._placeholder!==e&&(this._placeholder=e,this.UpdateElementState())}_GetPlaceholder(){return this._placeholder}_SetTooltip(e){this._title!==e&&(this._title=e,this.UpdateElementState())}_GetTooltip(){return this._title}_SetEnabled(e){e=!!e,this._isEnabled!==e&&(this._isEnabled=e,this.UpdateElementState())}_IsEnabled(){return this._isEnabled}_SetReadOnly(e){e=!!e,this._isReadOnly!==e&&(this._isReadOnly=e,this.UpdateElementState())}_IsReadOnly(){return this._isReadOnly}_SetMaxLength(e){e=Math.max(+e,-1),this._maxLength!==e&&(this._maxLength=e,this.UpdateElementState())}_GetMaxLength(){return this._maxLength}_ScrollToBottom(){Promise.resolve().then(()=>this.PostToDOMElement("scroll-to-bottom"))}Draw(e){}SaveToJson(){return{t:this._text,p:this._placeholder,ti:this._title,e:this._isEnabled,r:this._isReadOnly,sp:this._spellCheck,ml:this._maxLength,type:this._type,id:this._id}}LoadFromJson(e){this._text=e.t,this._placeholder=e.p,this._title=e.ti,this._isEnabled=e.e,this._isReadOnly=e.r,this._spellCheck=e.sp,this._maxLength=e.hasOwnProperty("ml")?e.ml:-1,this._type=e.type,this._id=e.id,this.UpdateElementState()}GetPropertyValueByIndex(e){switch(e){case SM:return this._text;case TM:return this._placeholder;case xM:return this._title;case GM:return this._isEnabled;case IM:return this._isReadOnly;case vM:return this._spellCheck;case wM:return this._autoFontSize}}SetPropertyValueByIndex(e,t){switch(e){case SM:if(this._text===t)return;this._text=t,this.UpdateElementState();break;case TM:if(this._placeholder===t)return;this._placeholder=t,this.UpdateElementState();break;case xM:if(this._title===t)return;this._title=t,this.UpdateElementState();break;case GM:if(this._isEnabled===!!t)return;this._isEnabled=!!t,this.UpdateElementState();break;case IM:if(this._isReadOnly===!!t)return;this._isReadOnly=!!t,this.UpdateElementState();break;case vM:if(this._spellCheck===!!t)return;this._spellCheck=!!t,this.UpdateElementState();break;case wM:this._autoFontSize=!!t}}GetDebuggerProperties(){const e=gM.Plugins.TextBox.Acts,t="plugins.textbox";return[{title:t+".name",properties:[{name:t+".properties.text.name",value:this._text,onedit:t=>this.CallAction(e.SetText,t)},{name:t+".properties.enabled.name",value:this._isEnabled,onedit:t=>this.CallAction(e.SetEnabled,t)},{name:t+".properties.read-only.name",value:this._isReadOnly,onedit:t=>this.CallAction(e.SetReadOnly,t)}]}]}GetScriptInterfaceClass(){return self.ITextInputInstance}};const EM=new WeakMap;self.ITextInputInstance=class extends self.IDOMInstance{constructor(){super(),EM.set(this,self.IInstance._GetInitInst().GetSdkInstance())}set text(e){yM.RequireString(e),EM.get(this)._SetText(e)}get text(){return EM.get(this)._GetText()}set placeholder(e){yM.RequireString(e),EM.get(this)._SetPlaceholder(e)}get placeholder(){return EM.get(this)._GetPlaceholder()}set tooltip(e){yM.RequireString(e),EM.get(this)._SetTooltip(e)}get tooltip(){return EM.get(this)._GetTooltip()}set isEnabled(e){EM.get(this)._SetEnabled(e)}get isEnabled(){return EM.get(this)._IsEnabled()}set isReadOnly(e){EM.get(this)._SetReadOnly(e)}get isReadOnly(){return EM.get(this)._IsReadOnly()}set maxLength(e){yM.RequireFiniteNumber(e),EM.get(this)._SetMaxLength(e)}get maxLength(){return EM.get(this)._GetMaxLength()}scrollToBottom(){EM.get(this)._ScrollToBottom()}}}{const DM=self.C3;DM.Plugins.TextBox.Cnds={CompareText(e,t){return 0===t?DM.equalsNoCase(this._text,e):this._text===e},OnTextChanged:()=>!0,OnClicked:()=>!0,OnDoubleClicked:()=>!0}}self.C3.Plugins.TextBox.Acts={SetText(e){this._SetText(e.toString())},AppendText(e){""!==e&&this._SetText(this._GetText()+e)},SetPlaceholder(e){this._SetPlaceholder(e)},SetTooltip(e){this._SetTooltip(e)},SetReadOnly(e){this._SetReadOnly(0===e)},ScrollToBottom(){this._ScrollToBottom()},SetMaxLength(e){this._SetMaxLength(e)}},self.C3.Plugins.TextBox.Exps={Text(){return this._GetText()},MaxLength(){return this._GetMaxLength()}};{const NM=self.C3;NM.Behaviors.Tween=class extends NM.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const FM=self.C3;FM.Behaviors.Tween.Type=class extends FM.SDKBehaviorTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const OM=self.C3,BM=OM.Behaviors.Tween,LM=0;BM.Instance=class extends OM.SDKBehaviorInstanceBase{constructor(e,t){super(e),this._allowMultiple=!1,this._enabled=!0,t&&(this._allowMultiple=!1,this._enabled=!!t[LM]),this._activeTweens=new Map,this._disabledTweens=[],this._waitingForReleaseTweens=new Map,this._finishingTween=null,this._activeTweensJson=null,this._disabledTweensJson=null,this._waitingForReleaseTweensJson=null,this._finishingTweenName="",this._triggerTweens=[],this._afterLoad=e=>this._OnAfterLoad(),this.GetRuntime().Dispatcher().addEventListener("afterload",this._afterLoad)}Release(){this.GetRuntime().Dispatcher().removeEventListener("afterload",this._afterLoad),this._afterLoad=null,this._finishingTween&&(this.ReleaseAndCompleteTween(this._finishingTween),this._finishingTween=null),this.ReleaseAndCompleteTweens(),this._tweens=null,this.ClearDisabledList(),this._disabledTweens=null,this._ReleaseWaitingTweens(),this._waitingForReleaseTweens=null,this._triggerTweens=null,super.Release()}PushTriggerTween(e){this._triggerTweens.push(e)}PopTriggerTween(){this._triggerTweens.pop()}GetTriggerTween(){return this._triggerTweens[this._triggerTweens.length-1]}SetEnabled(e){this._enabled=!!e,e?this._waitingForReleaseTweens&&this._waitingForReleaseTweens.size&&this._StartTicking2():this._StopTicking2();for(const t of this.AllTweens())e?this.IsInDisabledList(t)&&t.Resume():((t.IsPlaying()||t.IsScheduled())&&this.AddToDisabledList(t),t.Stop());e&&this.ClearDisabledList()}IsEnabled(){return this._enabled}AddToDisabledList(e){this._disabledTweens.push(e)}IsInDisabledList(e){return this._disabledTweens.includes(e)}ClearDisabledList(){OM.clearArray(this._disabledTweens)}GetFinishingTween(){return this._finishingTween}IsInstanceValid(){const e=this.GetObjectInstance();return!!e&&!e.IsDestroyed()}GetTween(e,t,s=!1){const i=t?this.PropertyTweens(t,s):this.AllTweens(s);if(i&&i.length)for(const t of i)if(t.HasTags(e))return t}CheckTweensWithTags(e,t){for(const s of this._activeTweens.values())for(const i of s)if(!i.IsReleased()&&i.HasTags(e)&&t(i))return!0;for(const s of this._waitingForReleaseTweens.values())for(const i of s)if(!i.IsReleased()&&i.HasTags(e)&&t(i))return!0;return!1}CheckTweens(e){for(const t of this._activeTweens.values())for(const s of t)if(!s.IsReleased()&&e(s))return!0;for(const t of this._waitingForReleaseTweens.values())for(const s of t)if(!s.IsReleased()&&e(s))return!0;return!1}GetTweenIncludingWaitingForRelease(e,t){return this.GetTween(e,t,!0)}*GetTweens(e,t,s=!1){const i=t?this.PropertyTweens(t,s):this.AllTweens(s);if(i&&i.length)for(const t of i)t.HasTags(e)&&(yield t)}*GetTweensIncludingWaitingForRelease(e,t){yield*this.GetTweens(e,t,!0)}PropertyTweens(e,t){if(t){let t=this._activeTweens.get(e),s=this._waitingForReleaseTweens.get(e);return t||(t=[]),s||(s=[]),t.concat(s).filter(e=>e).filter(e=>!e.IsReleased())}{let t=this._activeTweens.get(e);return t||(t=[]),t.filter(e=>e).filter(e=>!e.IsReleased())}}AllTweens(e){if(e){const e=[...this._activeTweens.values()].flat(),t=[...this._waitingForReleaseTweens.values()].flat();return e.concat(t).filter(e=>e).filter(e=>!e.IsReleased())}return[...this._activeTweens.values()].flat().filter(e=>e).filter(e=>!e.IsReleased())}AllTweensIncludingWaitingForRelease(){return this.AllTweens(!0)}SaveToJson(e="full"){return{s:!1,e:!!this._enabled,at:this._SaveActiveTweensToJson(),dt:this._SaveDisabledTweensToJson(),wt:this._SaveWaitingForReleaseTweensToJson(),ft:this._SaveFinishingTweenToJson()}}LoadFromJson(e,t="full"){e&&(this._activeTweensJson=e.at,this._disabledTweensJson=e.dt,this._waitingForReleaseTweensJson=e.wt,this._finishingTweenName=e.ft,this._allowMultiple=!1,this._enabled=!!e.e,"state"===t&&this._OnAfterLoad())}_OnAfterLoad(){const e=this.GetRuntime().GetTimelineManager();if(this._PopulateTweenMap(this._activeTweensJson,this._activeTweens,e),this._disabledTweensJson){OM.clearArray(this._disabledTweens);for(const t of this._disabledTweensJson)this._PopulateTweenArray(this._disabledTweens,t,e)}this._PopulateTweenMap(this._waitingForReleaseTweensJson,this._waitingForReleaseTweens,e),this._finishingTween=this._GetTween(this._finishingTweenName,e),this._enabled?this._waitingForReleaseTweens&&this._waitingForReleaseTweens.size&&this._StartTicking2():this._StopTicking2()}_PopulateTweenMap(e,t,s){if(e)for(const i in e){let r=t.get(i);r?OM.clearArray(r):r=[];const n=e[i];for(const e of n)if(this._PopulateTweenArray(r,e.name,s))this._LoadTweenFromJson(e.name,e,s);else{const t=OM.TweenState.Build({runtime:this.GetRuntime(),json:e});OM.TweenState.SetInstanceUID(t,this.GetObjectInstance().GetUID()),t.AddCompletedCallback(e=>this._FinishTriggers(e)),t.SetBehaviorInstance(this),s.AddScheduledTimeline(t),this._PopulateTweenArray(r,t,s)}t.set(i,r)}}_GetTween(e,t){return t.GetScheduledOrPlayingTimelineByName(e)}_PopulateTweenArray(e,t,s){if("string"!=typeof t)return!!e.push(t);{const i=this._GetTween(t,s);if(i)return!!e.push(i)}return!1}_LoadTweenFromJson(e,t,s){if("string"==typeof e){const i=this._GetTween(e,s);i&&(i._LoadFromJson(t),OM.TweenState.SetInstanceUID(i,this.GetObjectInstance().GetUID()),OM.TweenState.SetBehaviorInstance(i,this))}else e._LoadFromJson(t),OM.TweenState.SetInstanceUID(e,this.GetObjectInstance().GetUID()),OM.TweenState.SetBehaviorInstance(e,this)}_SaveActiveTweensToJson(){const e={};for(const[t,s]of this._activeTweens)e[t]=s.filter(e=>!e.IsReleased()).map(e=>e._SaveToJson());return e}_SaveDisabledTweensToJson(){return this._disabledTweens.filter(e=>!e.IsReleased()).map(e=>e.GetName())}_SaveWaitingForReleaseTweensToJson(){const e={};for(const[t,s]of this._waitingForReleaseTweens)e[t]=s.map(e=>e._SaveToJson());return e}_SaveFinishingTweenToJson(){return this._finishingTween?this._finishingTween.GetName():""}Tick2(){this._ReleaseWaitingTweens()}CreateTween(e){const t=BM.Config.GetPropertyTracksConfig(e.property,e.startValue,e.endValue,e.ease,e.resultMode,this.GetObjectInstance()),s=BM.Maps.GetPropertyFromIndex(e.property);BM.Maps.IsValueId(s)||this.ReleaseTweens(e.property);const i=OM.TweenState.Build({runtime:this.GetRuntime(),id:s,tags:e.tags,time:e.time,instance:this.GetObjectInstance(),releaseOnComplete:!!e.releaseOnComplete,loop:!!e.loop,pingPong:!!e.pingPong,repeatCount:e.repeatCount,initialValueMode:e.initialValueMode,propertyTracksConfig:t});return i.AddCompletedCallback(e=>this._FinishTriggers(e)),i.SetBehaviorInstance(this),this._AddTween(i,e.property),i}_MaybeRemoveFromActiveTweenMap(e){const t=e.GetId();if(this._activeTweens.has(t)){const s=this._activeTweens.get(t);if(s){const t=s.indexOf(e);-1!==t&&s.splice(t,1)}}}ReleaseTween(e,t=!1){this._MaybeRemoveFromActiveTweenMap(e),e.IsReleased()||this._IsInWaitingList(e)||(e.Stop(t),this._AddToWaitingList(e))}ReleaseTweens(e,t=!1){if(OM.IsFiniteNumber(e)){const s=BM.Maps.GetPropertyFromIndex(e);if(!this._activeTweens.has(s))return;const i=this._activeTweens.get(s),r=this.GetFinishingTween();for(const e of i)e!==r&&(e.IsReleased()||this._IsInWaitingList(e)||(e.Stop(t),e.Release()));OM.clearArray(i)}else{const e=this.GetFinishingTween();for(const s of this.AllTweens())s!==e&&(s.IsReleased()||this._IsInWaitingList(s)||(s.Stop(t),s.Release()));for(const e of this._activeTweens.keys())OM.clearArray(this._activeTweens.get(e)),this._activeTweens.delete(e);this._activeTweens.clear()}}ReleaseAndCompleteTween(e){this.ReleaseTween(e,!0)}ReleaseAndCompleteTweens(){this.ReleaseTweens(NaN,!0)}GetPropertyValueByIndex(e){if(e===LM)return this._enabled}SetPropertyValueByIndex(e,t){e===LM&&(this._enabled=!!t)}_GetBehaviorType(e){const t=e.GetInstance().GetBehaviorInstances();for(const e of t){const t=e.GetBehaviorType();if(t.GetInstanceSdkCtor()===this.constructor)return t}}Trigger(e,t,s,i){return this._runtime?super.Trigger(e):t.Trigger(e,s,i)}_FinishTriggers(e){let t,s;if(this._finishingTween=e,BM.Cnds.SetFinishingTween(e),this.GetRuntime())t=this._inst,s=this._runtime,this.Trigger(BM.Cnds.OnTweensFinished),this.Trigger(BM.Cnds.OnAnyTweensFinished),this.ReleaseTween(e);else{if(t=e.GetInstance(),!t)return;if(t&&t.IsDestroyed())return;s=t.GetRuntime();const i=this._GetBehaviorType(e);this.Trigger(BM.Cnds.OnTweensFinished,s,t,i),this.Trigger(BM.Cnds.OnAnyTweensFinished,s,t,i),e.Stop()}this._finishingTween=null,BM.Cnds.SetFinishingTween(null),e.GetDestroyInstanceOnComplete()&&s.DestroyInstance(t)}_AddTween(e,t){const s=BM.Maps.GetPropertyFromIndex(t);this._activeTweens.has(s)||this._activeTweens.set(s,[]),this._activeTweens.get(s).push(e)}_AddToWaitingList(e){const t=e.GetId();this._waitingForReleaseTweens.has(t)||this._waitingForReleaseTweens.set(t,[]),this._waitingForReleaseTweens.get(t).push(e),this.IsTicking2()||this._StartTicking2()}_IsInWaitingList(e){const t=e.GetId();return!!this._waitingForReleaseTweens.has(t)&&this._waitingForReleaseTweens.get(t).includes(e)}_ReleaseWaitingTweens(){if(this._waitingForReleaseTweens.size){for(const e of this._waitingForReleaseTweens.values()){for(const t of e)t.IsReleased()||t.Release();OM.clearArray(e)}this._waitingForReleaseTweens.clear(),this.IsTicking2()&&this._StopTicking2()}}GetDebuggerProperties(){return[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:"behaviors.tween.properties.enabled.name",value:this.IsEnabled(),onedit:e=>this.SetEnabled(e)}]}]}GetScriptInterfaceClass(){return self.ITweenBehaviorInstance}}}{const kM=self.C3;let VM=null;kM.Behaviors.Tween.Cnds={OnAnyTweenLoop:()=>!0,OnTweensLoop(e){const t=this.GetTriggerTween();return!!t&&t.HasTags(e)},OnAnyTweenPingPong(e){const t=this.GetTriggerTween();return!!t&&(t.GetPingPongState()===e||2===e)},OnTweensPingPong(e,t){const s=this.GetTriggerTween();return!!s&&(s.GetPingPongState()===t||2===t)&&s.HasTags(e)},SetFinishingTween(e){VM=e},OnTweensFinished:e=>VM.HasTags(e),OnAnyTweensFinished:()=>!0,IsPlaying(e){return this.CheckTweensWithTags(e,kM.TweenState.IsPlaying)},IsAnyPlaying(){return this.CheckTweens(kM.TweenState.IsPlaying)},IsPaused(e){return this.CheckTweensWithTags(e,kM.TweenState.IsPaused)},IsAnyPaused(){return this.CheckTweens(kM.TweenState.IsPaused)},IsPingPong(e,t){return 0===t?this.CheckTweensWithTags(e,kM.TweenState.IsPing):1===t&&this.CheckTweensWithTags(e,kM.TweenState.IsPong)},IsAnyPingPong(e){return 0===e?this.CheckTweens(kM.TweenState.IsPing):1===e&&this.CheckTweens(kM.TweenState.IsPong)}}}{const UM=self.C3,WM=self.Ease,HM=UM.Behaviors.Tween;HM.Acts={SetEnabled(e){this.SetEnabled(!!e)},async TweenOneProperty(...e){if(!this.IsEnabled()||!this.IsInstanceValid())return;const t=this.CreateTween(HM.TweenArguments.OneProperty(this,...e));t.Play()&&await t.GetPlayPromise()},async TweenTwoProperties(...e){if(!this.IsEnabled()||!this.IsInstanceValid())return;const t=this.CreateTween(HM.TweenArguments.TwoProperties(this,...e));t.Play()&&await t.GetPlayPromise()},async TweenValue(...e){if(!this.IsEnabled()||!this.IsInstanceValid())return;const t=this.CreateTween(HM.TweenArguments.ValueProperty(this,...e));t.Play()&&await t.GetPlayPromise()},PauseTweens(e){if(this.IsEnabled()&&this.IsInstanceValid())for(const t of this.GetTweens(e))t.Stop()},PauseAllTweens(){if(this.IsEnabled()&&this.IsInstanceValid())for(const e of this.AllTweens())e.Stop()},ResumeTweens(e){if(this.IsEnabled()&&this.IsInstanceValid())for(const t of this.GetTweens(e))t.Resume()},ResumeAllTweens(){if(this.IsEnabled()&&this.IsInstanceValid())for(const e of this.AllTweens())e.Resume()},StopTweens(e){if(this.IsEnabled()&&this.IsInstanceValid())for(const t of this.GetTweens(e))this.ReleaseTween(t)},StopAllTweens(){if(this.IsEnabled()&&this.IsInstanceValid())for(const e of this.AllTweens())this.ReleaseTween(e)},SetOnePropertyTweensEndValue(e,t,s){if(!this.IsEnabled()||!this.IsInstanceValid())return;const i=UM.Behaviors.Tween.Maps.GetSinglePropertyFromIndex(t);for(const t of this.GetTweens(e))t.BeforeSetEndValues([i]),t.SetEndValue(s,i)},SetTwoPropertiesTweensEndValue(e,t,s,i){if(!this.IsEnabled()||!this.IsInstanceValid())return;const r=UM.Behaviors.Tween.Maps.GetRealProperties(t);for(const t of this.GetTweens(e))t.BeforeSetEndValues(r),t.SetEndValue(s,r[0]),t.SetEndValue(i,r[1])},SetValuePropertyTweensStartValue(e,t){if(this.IsEnabled()&&this.IsInstanceValid())for(const s of this.GetTweens(e,"value"))s.SetStartValue(t,"value")},SetValuePropertyTweensEndValue(e,t){if(this.IsEnabled()&&this.IsInstanceValid())for(const s of this.GetTweens(e,"value"))s.BeforeSetEndValues(["value"]),s.SetEndValue(t,"value")},SetTweensEase(e,t){if(!this.IsEnabled()||!this.IsInstanceValid())return;const s=WM.GetEaseFromIndex(t);for(const t of this.GetTweens(e))t.SetEase(s)},SetAllTweensEase(e){if(!this.IsEnabled()||!this.IsInstanceValid())return;const t=WM.GetEaseFromIndex(e);for(const e of this.AllTweens())e.SetEase(t)},SetTweensTime(e,t){if(this.IsEnabled()&&this.IsInstanceValid())for(const s of this.GetTweens(e))s.SetTime(t)},SetAllTweensTime(e){if(this.IsEnabled()&&this.IsInstanceValid())for(const t of this.AllTweens())t.SetTime(e)},SetTweensPlaybackRate(e,t){if(this.IsEnabled()&&this.IsInstanceValid())for(const s of this.GetTweens(e))s.SetPlaybackRate(t)},SetAllTweensPlaybackRate(e){if(this.IsEnabled()&&this.IsInstanceValid())for(const t of this.AllTweens())t.SetPlaybackRate(e)},SetTweensDestroyOnComplete(e,t){if(this.IsEnabled()&&this.IsInstanceValid())for(const s of this.GetTweens(e))s.SetDestroyInstanceOnComplete(!!t)},SetAllTweensDestroyOnComplete(e){if(this.IsEnabled()&&this.IsInstanceValid())for(const t of this.AllTweens())t.SetDestroyInstanceOnComplete(!!e)}}}self.C3.Behaviors.Tween.Exps={Time(e){const t=this.GetTweenIncludingWaitingForRelease(e);return t?t.GetTime():0},Progress(e){const t=this.GetTweenIncludingWaitingForRelease(e);return t?t.GetTime()/t.GetTotalTime():0},PlaybackRate(e){const t=this.GetTweenIncludingWaitingForRelease(e);return t?t.GetPlaybackRate():0},Value(e){const t=this.GetTweenIncludingWaitingForRelease(e,"value");return t?t.GetPropertyTrack("value").GetSourceAdapterValue():0},Tags(){let e=this.GetFinishingTween();return e?e.GetStringTags():(e=this.GetTriggerTween(),e?e.GetStringTags():"")}};{const zM=self.C3,jM=self.Ease,YM=["position","size","scale"],qM=["offsetX","offsetY","offsetWidth","offsetHeight","offsetAngle","offsetOpacity","offsetColor","offsetZElevation","offsetScaleX","offsetScaleY"],XM=["value"],$M=[].concat(YM).concat(qM).concat(XM),KM={position:["offsetX","offsetY"],size:["offsetWidth","offsetHeight"],scale:["offsetScaleX","offsetScaleY"]},JM=Object.assign({},$M.reduce((e,t)=>Object.assign({},e,{[t]:[t]}),{}),KM);zM.Behaviors.Tween.Maps=class{constructor(){}static GetEases(){return[...jM.GetRuntimeEaseNames()]}static GetEaseFromIndex(e){return[...jM.GetRuntimeEaseNames()][e]}static GetPropertyFromIndex(e){return $M[e]}static GetPropertyIndexFromName(e){return $M.indexOf(e)}static GetPairPropertyFromIndex(e){return YM[e]}static GetSinglePropertyFromIndex(e){return qM[e]}static GetValuePropertyFromIndex(e){return XM[e]}static GetPairProperties(e){return KM[e]}static GetRealProperties(e){return zM.IsString(e)?JM[e]:JM[$M[e]]}static IsPairId(e){return!!KM[e]}static IsColorId(e){return"offsetColor"===e}static IsAngleId(e){return"offsetAngle"===e}static IsOpacityId(e){return"offsetOpacity"===e}static IsValueId(e){return"value"===e}}}{const QM=self.C3,ZM=QM.Behaviors.Tween,eE=new Map;ZM.Config=class{constructor(){}static GetPropertyTracksConfig(e,t,s,i,r,n){0===eE.size&&this._CreateConfigObjects();const a=ZM.PropertyTypes.Pick(e);let o=eE.get(a);return QM.IsFiniteNumber(e)&&(e=ZM.Maps.GetPropertyFromIndex(e)),this._GetConfig(o,e,t,s,i,r,n)}static TransformValue(e,t){return QM.Behaviors.Tween.GetPropertyTracksConfig(e).valueGetter(t)}static _CreateConfigObjects(){const e=ZM.PropertyTypes,t=ZM.ValueGetters;this._AddConfigObject(e.PAIR,this._GetPairConfig,t._GetPropertyValue),this._AddConfigObject(e.COLOR,this._GetColorConfig,t._GetColorPropertyValue),this._AddConfigObject(e.ANGLE,this._GetAngleConfig,t._GetPropertyAngleValue),this._AddConfigObject(e.VALUE,this._GetValueConfig,t._GetPropertyValue),this._AddConfigObject(e.OTHER,this._GetCommonConfig,t._GetPropertyValue)}static _AddConfigObject(e,t,s){eE.set(e,this._CreateConfigObject(e,t,s))}static _CreateConfigObject(e,t,s){return{name:e,configFunc:t,valueGetter:s}}static _GetConfig(e,t,s,i,r,n,a){return e.configFunc(t,e.valueGetter(s),e.valueGetter(i),r,n,a)}static _GetPairConfig(e,t,s,i,r,n){return ZM.Maps.GetPairProperties(e).map((e,n)=>({sourceId:"world-instance",property:e,type:"float",valueType:"numeric",startValue:t[n],endValue:s[n],ease:ZM.Maps.GetEaseFromIndex(i),resultMode:r}))}static _GetColorConfig(e,t,s,i,r,n){return QM.Plugins.Text&&n.GetPlugin()instanceof QM.Plugins.Text?{sourceId:"plugin",sourceArgs:[7],property:"color",type:"color",valueType:"color",startValue:t,endValue:s,ease:ZM.Maps.GetEaseFromIndex(i),resultMode:r}:{sourceId:"world-instance",property:e,type:"color",valueType:"color",startValue:t,endValue:s,ease:ZM.Maps.GetEaseFromIndex(i),resultMode:r}}static _GetAngleConfig(e,t,s,i,r,n){return{sourceId:"world-instance",property:e,type:"angle",valueType:"angle",startValue:t,endValue:s,ease:ZM.Maps.GetEaseFromIndex(i),resultMode:r}}static _GetCommonConfig(e,t,s,i,r,n){return{sourceId:"world-instance",property:e,type:"float",valueType:"numeric",startValue:t,endValue:s,ease:ZM.Maps.GetEaseFromIndex(i),resultMode:r}}static _GetValueConfig(e,t,s,i,r,n){return{sourceId:"value",property:e,type:"float",valueType:"numeric",startValue:t,endValue:s,ease:ZM.Maps.GetEaseFromIndex(i),resultMode:r}}}}{const tE=self.C3,sE=tE.Behaviors.Tween,iE={resultMode:"absolute"},rE=Object.assign({},iE,{tags:"",property:"",time:0,ease:0,releaseOnComplete:0,loop:!1,pingPong:!1,repeatCount:1}),nE=Object.assign({},rE,{initialValueMode:"current-state",startValue:0,endValue:0}),aE=Object.assign({},rE,{initialValueMode:"current-state",startValue:[0,0],endValue:[0,0]}),oE=Object.assign({},rE,{initialValueMode:"current-state",startValue:[0,0,0],endValue:[0,0,0]}),lE=Object.assign({},nE,{initialValueMode:"start-value"}),hE=0,uE=1,cE=0,dE=1,pE=2;sE.TweenArguments=class{constructor(){}static _SetCommonProperties(e,t,s,i,r,n,a,o){e.tags=t,e.time=s,e.ease=i,e.releaseOnComplete=r,e.loop=n,e.pingPong=a,e.repeatCount=o}static OneProperty(e,t,s,i,r,n,a,o,l,h){const u="string"==typeof s?s:sE.Maps.GetSinglePropertyFromIndex(s),c=sE.Maps.IsColorId(u)?oE:nE;return this._SetCommonProperties(c,t,r,n,a,o,l,h),sE.Maps.IsColorId(u)?(oE.endValue[0]=tE.GetRValue(i),oE.endValue[1]=tE.GetGValue(i),oE.endValue[2]=tE.GetBValue(i),oE.property=sE.Maps.GetPropertyIndexFromName(u)):sE.Maps.IsOpacityId(u)?nE.endValue=i/100:nE.endValue=i,c.property=sE.Maps.GetPropertyIndexFromName(u),c}static TwoProperties(e,t,s,i,r,n,a,o,l,h,u){this._SetCommonProperties(aE,t,n,a,o,l,h,u);const c="string"==typeof s?s:sE.Maps.GetPairPropertyFromIndex(s);return aE.endValue[0]=i,aE.endValue[1]=r,aE.property=sE.Maps.GetPropertyIndexFromName(c),aE}static ValueProperty(e,t,s,i,r,n,a,o,l,h){return this._SetCommonProperties(lE,t,r,n,a,o,l,h),lE.startValue=s,lE.endValue=i,lE.property=sE.Maps.GetPropertyIndexFromName("value"),lE}}}{const _E=self.C3,mE=_E.Behaviors.Tween,fE=[];mE.PropertyTypes=class{constructor(){}static Pick(e){if(0===fE.length){const e=fE;e.push({checkFunc:mE.Maps.IsPairId,result:this.PAIR}),e.push({checkFunc:mE.Maps.IsColorId,result:this.COLOR}),e.push({checkFunc:mE.Maps.IsAngleId,result:this.ANGLE}),e.push({checkFunc:mE.Maps.IsValueId,result:this.VALUE}),e.push({checkFunc:()=>!0,result:this.OTHER})}_E.IsFiniteNumber(e)&&(e=_E.Behaviors.Tween.Maps.GetPropertyFromIndex(e));for(const t of fE)if(t.checkFunc(e))return t.result}static get PAIR(){return"pair"}static get COLOR(){return"color"}static get ANGLE(){return"angle"}static get VALUE(){return"value"}static get OTHER(){return"other"}}}{const gE=self.C3,yE=gE.Behaviors.Tween;yE.ValueGetters=class{constructor(){}static _GetPropertyAngleValue(e){const t=gE.toRadians(parseFloat(e));return gE.clampAngle(t)}static _GetColorPropertyValue(e){return e.slice(0)}static _GetPropertyValue(e){return e}}}{let SE=function(e){bE.RequireString(e);const t=IE.ToInternal(e);let s;if(s=t?IE.GetIndexForEase(t,null):IE.GetIndexForEase(e,null),-1===s)throw new Error(`invalid ease name '${e}'`);return s},TE=function(e,t=!1){if(!(t&&null==e||"string"==typeof e||Array.isArray(e)))throw new Error("invalid tags")};getIndexForEase=SE,ValidateTags=TE;const xE=self.C3,bE=self.C3X,GE=self.IBehaviorInstance,IE=self.Ease,vE=xE.Behaviors.Tween,CE=new WeakMap,wE=new Map([["x",{name:"offsetX",type:"one"}],["y",{name:"offsetY",type:"one"}],["width",{name:"offsetWidth",type:"one"}],["height",{name:"offsetHeight",type:"one"}],["angle",{name:"offsetAngle",type:"one"}],["opacity",{name:"offsetOpacity",type:"one"}],["color",{name:"offsetColor",type:"color"}],["z-elevation",{name:"offsetZElevation",type:"one"}],["x-scale",{name:"offsetScaleX",type:"one"}],["y-scale",{name:"offsetScaleY",type:"one"}],["position",{name:"position",type:"two"}],["size",{name:"size",type:"two"}],["scale",{name:"scale",type:"two"}],["value",{name:"value",type:"value"}]]),AE={tags:"",destroyOnComplete:!1,loop:!1,pingPong:!1,repeatCount:1,startValue:0},RE={easeToIndexFunc:SE};self.ITweenBehaviorInstance=class extends GE{constructor(){super(),CE.set(this,GE._GetInitInst().GetSdkInstance())}startTween(e,t,s,i,r){const n=CE.get(this);if(!n.IsEnabled()||!n.IsInstanceValid())return null;const a=wE.get(e);if(!a)throw new Error("invalid tween property");"one"===a.type||"value"===a.type?bE.RequireNumber(t):(bE.RequireArray(t),"two"===a.type?(bE.RequireNumber(t[0]),bE.RequireNumber(t[1])):"color"===a.type&&(bE.RequireNumber(t[0]),bE.RequireNumber(t[1]),bE.RequireNumber(t[2]))),"angle"===e?t=xE.toDegrees(t):"opacity"===e?t*=100:"color"===e&&(t=xE.PackRGBEx(t[0],t[1],t[2]));const o=SE(i);let l;if(bE.RequireFiniteNumber(s),r=Object.assign({},AE,r),"value"===a.type&&bE.RequireNumber(r.startValue),TE(r.tags,!0),"one"===a.type||"color"===a.type?l=n.CreateTween(vE.TweenArguments.OneProperty(n,r.tags,a.name,t,s,o,!!r.destroyOnComplete,!!r.loop,!!r.pingPong,r.repeatCount)):"two"===a.type?l=n.CreateTween(vE.TweenArguments.TwoProperties(n,r.tags,a.name,t[0],t[1],s,o,!!r.destroyOnComplete,!!r.loop,!!r.pingPong,r.repeatCount)):"value"===a.type&&(l=n.CreateTween(vE.TweenArguments.ValueProperty(n,r.tags,r.startValue,t,s,o,!!r.destroyOnComplete,!!r.loop,!!r.pingPong,r.repeatCount))),l.SetBehaviorInstance(n.GetBehaviorInstance().GetSdkInstance()),!l.Play())throw new Error("failed to start tween");return l.GetITweenState(n,RE)}*allTweens(){const e=CE.get(this);for(const t of e.AllTweens())yield t.GetITweenState(e,RE)}*tweensByTags(e){TE(e);const t=CE.get(this);for(const s of t.GetTweens(e))yield s.GetITweenState(t,RE)}get isEnabled(){return CE.get(this).IsEnabled()}set isEnabled(e){CE.get(this).SetEnabled(e)}}}{const PE=self.C3;PE.Behaviors.Anchor=class extends PE.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const ME=self.C3;ME.Behaviors.Anchor.Type=class extends ME.SDKBehaviorTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const EE=self.C3,DE=(self.C3X,self.IBehaviorInstance),NE=0,FE=1,OE=2,BE=3,LE=4;EE.Behaviors.Anchor.Instance=class extends EE.SDKBehaviorInstanceBase{constructor(e,t){super(e),this._anchorLeft=2,this._anchorTop=2,this._anchorRight=0,this._anchorBottom=0,this._isEnabled=!0;const s=this._inst.GetWorldInfo().GetBoundingBox();this._xLeft=s.getLeft(),this._yTop=s.getTop(),this._xRight=this._runtime.GetOriginalViewportWidth()-s.getLeft(),this._yBottom=this._runtime.GetOriginalViewportHeight()-s.getTop(),this._rDiff=this._runtime.GetOriginalViewportWidth()-s.getRight(),this._bDiff=this._runtime.GetOriginalViewportHeight()-s.getBottom(),t&&(this._anchorLeft=t[NE],this._anchorTop=t[FE],this._anchorRight=t[OE],this._anchorBottom=t[BE],this._isEnabled=!!t[LE]);const i=this._runtime.Dispatcher();this._disposables=new EE.CompositeDisposable(EE.Disposable.From(i,"layoutchange",()=>this._OnLayoutChange())),this._isEnabled&&this._StartTicking()}Release(){super.Release()}SaveToJson(){return{xl:this._xLeft,yt:this._yTop,xr:this._xRight,yb:this._yBottom,rd:this._rDiff,bd:this._bDiff,al:this._anchorLeft,at:this._anchorTop,ar:this._anchorRight,ab:this._anchorBottom,e:this._isEnabled}}LoadFromJson(e){this._xLeft=e.xl,this._yTop=e.yt,this._xRight=e.xr,this._yBottom=e.yb,this._rDiff=e.rd,this._bDiff=e.bd,this._anchorLeft=e.al,this._anchorTop=e.at,this._anchorRight=e.ar,this._anchorBottom=e.ab,this._isEnabled=e.e,this._isEnabled?this._StartTicking():this._StopTicking()}_SetEnabled(e){if(this._isEnabled&&!e)this._isEnabled=!1,this._StopTicking();else if(!this._isEnabled&&e){const e=this._inst.GetWorldInfo().GetBoundingBox();this._xLeft=e.getLeft(),this._yTop=e.getTop(),this._xRight=this._runtime.GetOriginalViewportWidth()-e.getLeft(),this._yBottom=this._runtime.GetOriginalViewportHeight()-e.getTop(),this._rDiff=this._runtime.GetOriginalViewportWidth()-e.getRight(),this._bDiff=this._runtime.GetOriginalViewportHeight()-e.getBottom(),this._isEnabled=!0,this._StartTicking()}}_IsEnabled(){return this._isEnabled}_UpdatePosition(){if(!this._isEnabled)return;const e=this._inst.GetWorldInfo(),t=e.GetLayer().GetViewport();if(0===this._anchorLeft){const s=t.getLeft()+this._xLeft-e.GetBoundingBox().getLeft();0!==s&&(e.OffsetX(s),e.SetBboxChanged())}else if(1===this._anchorLeft){const s=t.getRight()-this._xRight-e.GetBoundingBox().getLeft();0!==s&&(e.OffsetX(s),e.SetBboxChanged())}if(0===this._anchorTop){const s=t.getTop()+this._yTop-e.GetBoundingBox().getTop();0!==s&&(e.OffsetY(s),e.SetBboxChanged())}else if(1===this._anchorTop){const s=t.getBottom()-this._yBottom-e.GetBoundingBox().getTop();0!==s&&(e.OffsetY(s),e.SetBboxChanged())}if(1===this._anchorRight){const s=t.getRight()-this._rDiff-e.GetBoundingBox().getRight();0!==s&&(e.OffsetX(e.GetOriginX()*s),e.SetWidth(Math.max(e.GetWidth()+s),0),e.SetBboxChanged(),this._rDiff=t.getRight()-e.GetBoundingBox().getRight())}if(1===this._anchorBottom){const s=t.getBottom()-this._bDiff-e.GetBoundingBox().getBottom();0!==s&&(e.OffsetY(e.GetOriginY()*s),e.SetHeight(Math.max(e.GetHeight()+s,0)),e.SetBboxChanged(),this._bDiff=t.getBottom()-e.GetBoundingBox().getBottom())}}Tick(){this._UpdatePosition()}_OnLayoutChange(){this._UpdatePosition()}GetPropertyValueByIndex(e){switch(e){case NE:return this._anchorLeft;case FE:return this._anchorTop;case OE:return this._anchorRight;case BE:return this._anchorBottom;case LE:return this._isEnabled}}SetPropertyValueByIndex(e,t){switch(e){case NE:this._anchorLeft=t;break;case FE:this._anchorTop=t;break;case OE:this._anchorRight=t;break;case BE:this._anchorBottom=t;break;case LE:this._isEnabled=!!t,this._isEnabled?this._StartTicking():this._StopTicking()}}GetDebuggerProperties(){return[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:"behaviors.anchor.properties.enabled.name",value:this._IsEnabled(),onedit:e=>this._SetEnabled(e)}]}]}GetScriptInterfaceClass(){return self.IAnchorBehaviorInstance}};const kE=new WeakMap;self.IAnchorBehaviorInstance=class extends DE{constructor(){super(),kE.set(this,DE._GetInitInst().GetSdkInstance())}get isEnabled(){return kE.get(this)._IsEnabled()}set isEnabled(e){kE.get(this)._SetEnabled(e)}}}self.C3.Behaviors.Anchor.Cnds={IsEnabled(){return this._IsEnabled()}},self.C3.Behaviors.Anchor.Acts={SetEnabled(e){this._SetEnabled(0!==e)}},self.C3.Behaviors.Anchor.Exps={};{const VE=self.C3;VE.Behaviors.MoveTo=class extends VE.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const UE=self.C3;UE.Behaviors.MoveTo.Type=class extends UE.SDKBehaviorTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const WE=self.C3,HE=self.C3X,zE=self.IBehaviorInstance,jE=0,YE=1,qE=2,XE=3,$E=4,KE=5,JE=6;WE.Behaviors.MoveTo.Instance=class extends WE.SDKBehaviorInstanceBase{constructor(e,t){super(e),this._maxSpeed=200,this._acc=600,this._dec=600,this._rotateSpeed=0,this._setAngle=!0,this._stopOnSolids=!1,this._isEnabled=!0,this._speed=0,this._movingAngle=this.GetWorldInfo().GetAngle(),this._waypoints=[],t&&(this._maxSpeed=t[jE],this._acc=t[YE],this._dec=t[qE],this._rotateSpeed=WE.toRadians(t[XE]),this._setAngle=t[$E],this._stopOnSolids=t[KE],this._isEnabled=t[JE]),this._timelineInfo=null,this._lastTargetX=NaN,this._lastTargetY=NaN,this._lastTargetAngle=NaN,this._tRange=[0,0],this._timelineInfoProjectionRange={tRange:this._tRange}}Release(){this._timelineInfo&&(this._timelineInfo.Release(),this._timelineInfo=null),this._lastTargetX=NaN,this._lastTargetY=NaN,this._lastTargetAngle=NaN,this._tRange=null,this._timelineInfoProjectionRange=null,super.Release()}SaveToJson(){return{ms:this._maxSpeed,acc:this._acc,dec:this._dec,rs:this._rotateSpeed,sa:this._setAngle,sos:this._stopOnSolids,s:this._speed,ma:this._movingAngle,wp:this._waypoints.map(e=>({x:e.x,y:e.y})),e:this._isEnabled}}LoadFromJson(e){this._maxSpeed=e.ms,this._acc=e.acc,this._dec=e.dec,this._rotateSpeed=e.rs,this._setAngle=e.sa,this._stopOnSolids=e.sos,this._speed=e.s,this._movingAngle=e.ma,this._waypoints=e.wp.map(e=>({x:e.x,y:e.y})),this._SetEnabled(e.e),this._isEnabled&&this._waypoints.length>0&&this._StartTicking()}_AddWaypoint(e,t,s,i){s&&WE.clearArray(this._waypoints),this._waypoints.push({x:e,y:t,opts:i}),this._isEnabled&&this._StartTicking()}_GetWaypointCount(){return this._waypoints.length}_GetWaypointXAt(e){return(e=Math.floor(e))<0||e>=this._waypoints.length?0:this._waypoints[e].x}_GetWaypointYAt(e){return(e=Math.floor(e))<0||e>=this._waypoints.length?0:this._waypoints[e].y}_IsMoving(){return this._waypoints.length>0}_Stop(){WE.clearArray(this._waypoints),this._speed=0,this._StopTicking()}_GetTargetX(){return this._waypoints.length>0?this._waypoints[0].x:0}_GetTargetY(){return this._waypoints.length>0?this._waypoints[0].y:0}_GetTargetIsBezier(){if(this._waypoints.length>0){const e=this._waypoints[0];if(e.opts)return e.opts.isBezier}return!1}_GetTargetIsBezierFirst(){if(this._waypoints.length>0){const e=this._waypoints[0];if(e.opts)return e.opts.isBezier&&e.opts.isFirst}return!1}_GetTargetBezierAngle(){if(this._waypoints.length>0){const e=this._waypoints[0];if(e.opts)return e.opts.bezierAngle}return NaN}_SetSpeed(e){this._IsMoving()&&(this._speed=Math.min(e,this._maxSpeed))}_GetSpeed(){return this._speed}_SetMaxSpeed(e){this._maxSpeed=Math.max(e,0),this._SetSpeed(this._speed)}_GetMaxSpeed(){return this._maxSpeed}_IsRotationEnabled(){return 0!==this._rotateSpeed}Tick(){if(!this._isEnabled||!this._IsMoving())return;const e=this._runtime.GetDt(this._inst),t=this._inst.GetWorldInfo(),s=t.GetX(),i=t.GetY(),r=t.GetAngle();let n=this._speed,a=this._maxSpeed;const o=this._acc,l=this._dec,h=this._GetTargetX(),u=this._GetTargetY(),c=WE.angleTo(s,i,h,u);let d=!1;if(l>0&&1===this._waypoints.length){const e=.5*n*n/l*1.0001;if(d=WE.distanceSquared(s,i,h,u)<=e*e,d){const e=WE.distanceTo(s,i,h,u);n=Math.sqrt(2*l*e),a=n,this._speed=n}}if(this._IsRotationEnabled()){const e=WE.angleDiff(this._movingAngle,c);if(e>Number.EPSILON){const s=e/this._rotateSpeed,i=WE.distanceTo(t.GetX(),t.GetY(),h,u)/(2*Math.sin(e))*e;a=Math.min(a,WE.clamp(i/s,0,this._maxSpeed))}}let p=d?-l:o;const _=Math.min(n*e+.5*p*e*e,a*e);if(d){if(l>0&&(this._speed=Math.max(this._speed-l*e,0),0===this._speed))return void this._OnArrived(t,h,u)}else this._speed=0===o?a:Math.min(this._speed+o*e,a);if(WE.distanceSquared(t.GetX(),t.GetY(),h,u)<=_*_)this._OnArrived(t,h,u);else{if(this._IsRotationEnabled()?this._movingAngle=WE.angleRotate(this._movingAngle,c,this._rotateSpeed*e):this._movingAngle=c,t.OffsetXY(Math.cos(this._movingAngle)*_,Math.sin(this._movingAngle)*_),this._setAngle){const e=this._GetTargetIsBezier(),s=this._GetTargetIsBezierFirst();if(e&&!s){const e=WE.distanceTo(this._lastTargetX,this._lastTargetY,t.GetX(),t.GetY())/WE.distanceTo(this._lastTargetX,this._lastTargetY,h,u);t.SetAngle(WE.angleLerp(this._lastTargetAngle,this._GetTargetBezierAngle(),e))}else t.SetAngle(this._movingAngle),this._lastTargetX=NaN,this._lastTargetY=NaN,this._lastTargetAngle=NaN}t.SetBboxChanged(),this._CheckSolidCollision(s,i,r)}}_OnArrived(e,t,s){e.SetXY(t,s);const i=this._waypoints[0];i.opts&&i.opts.isBezier?(this._lastTargetX=i.x,this._lastTargetY=i.y,this._lastTargetAngle=i.opts.bezierAngle,this._setAngle&&e.SetAngle(this._lastTargetAngle)):(this._lastTargetX=NaN,this._lastTargetY=NaN,this._lastTargetAngle=NaN),e.SetBboxChanged(),this._waypoints.shift(),0===this._waypoints.length&&(this._timelineInfo&&(this._timelineInfo.Release(),this._timelineInfo=null,this._lastTargetX=NaN,this._lastTargetY=NaN,this._lastTargetAngle=NaN),this._speed=0,this._StopTicking()),this.DispatchScriptEvent("arrived"),this.Trigger(WE.Behaviors.MoveTo.Cnds.OnArrived)}_CheckSolidCollision(e,t,s){const i=this._runtime.GetCollisionEngine();if(this._stopOnSolids&&i.TestOverlapSolid(this._inst)){this._Stop();const r=this._inst.GetWorldInfo(),n=r.GetX(),a=r.GetY(),o=WE.angleTo(n,a,e,t),l=WE.distanceTo(n,a,e,t);i.PushOutSolid(this._inst,Math.cos(o),Math.sin(o),Math.max(l,1))||(r.SetXY(e,t),r.SetAngle(s),r.SetBboxChanged()),this.DispatchScriptEvent("hitsolid"),this.Trigger(WE.Behaviors.MoveTo.Cnds.OnHitSolid)}}_IsSetAngle(){return this._setAngle}_SetSetAngle(e){this._setAngle=!!e}_SetAngleOfMotion(e){if(this._movingAngle=e,this._isEnabled&&this._setAngle&&!this._IsMoving()){const e=this.GetWorldInfo();e.SetAngle(this._movingAngle),e.SetBboxChanged()}}_GetAngleOfMotion(){return this._movingAngle}_SetAcceleration(e){this._acc=Math.max(e,0)}_GetAcceleration(){return this._acc}_SetDeceleration(e){this._dec=Math.max(e,0)}_GetDeceleration(){return this._dec}_SetRotateSpeed(e){this._rotateSpeed=Math.max(e,0)}_GetRotateSpeed(){return this._rotateSpeed}_SetStopOnSolids(e){this._stopOnSolids=!!e}_IsStopOnSolids(){return this._stopOnSolids}_SetEnabled(e){e=!!e,this._isEnabled!==e&&(this._isEnabled=e,this._isEnabled&&this._IsMoving()?this._StartTicking():this._StopTicking())}_IsEnabled(){return this._isEnabled}GetPropertyValueByIndex(e){switch(e){case jE:return this._GetMaxSpeed();case YE:return this._GetAcceleration();case qE:return this._GetDeceleration();case XE:return WE.toDegrees(this._GetRotateSpeed());case $E:return this._IsSetAngle();case KE:return this._IsStopOnSolids();case JE:return this._IsEnabled()}}SetPropertyValueByIndex(e,t){switch(e){case jE:this._SetMaxSpeed(t);break;case YE:this._SetAcceleration(t);break;case qE:this._SetDeceleration(t);break;case XE:this._SetRotateSpeed(WE.toRadians(t));break;case $E:this._SetSetAngle(t);break;case KE:this._SetStopOnSolids(t);break;case JE:this._SetEnabled(t)}}GetDebuggerProperties(){const e="behaviors.moveto";return[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:e+".debugger.speed",value:this._GetSpeed(),onedit:e=>this._SetSpeed(e)},{name:e+".debugger.angle-of-motion",value:WE.toDegrees(this._GetAngleOfMotion()),onedit:e=>this._movingAngle=WE.toRadians(e)},{name:e+".debugger.target-x",value:this._GetTargetX()},{name:e+".debugger.target-y",value:this._GetTargetY()},{name:e+".debugger.waypoint-count",value:this._GetWaypointCount()},{name:e+".properties.max-speed.name",value:this._GetMaxSpeed(),onedit:e=>this._SetMaxSpeed(e)},{name:e+".properties.acceleration.name",value:this._GetAcceleration(),onedit:e=>this._SetAcceleration(e)},{name:e+".properties.deceleration.name",value:this._GetDeceleration(),onedit:e=>this._SetDeceleration(e)},{name:e+".properties.rotate-speed.name",value:WE.toDegrees(this._GetRotateSpeed()),onedit:e=>this._SetRotateSpeed(WE.toRadians(e))},{name:e+".properties.enabled.name",value:this._IsEnabled(),onedit:e=>this._SetEnabled(e)}]}]}GetScriptInterfaceClass(){return self.IMoveToBehaviorInstance}};const QE=new WeakMap;self.IMoveToBehaviorInstance=class extends zE{constructor(){super(),QE.set(this,zE._GetInitInst().GetSdkInstance())}moveToPosition(e,t,s=!0){HE.RequireFiniteNumber(e),HE.RequireFiniteNumber(t),QE.get(this)._AddWaypoint(e,t,!!s)}getTargetX(){return QE.get(this)._GetTargetX()}getTargetY(){return QE.get(this)._GetTargetY()}getTargetPosition(){const e=QE.get(this);return[e._GetTargetX(),e._GetTargetY()]}getWaypointCount(){return QE.get(this)._GetWaypointCount()}getWaypointX(e){return HE.RequireFiniteNumber(e),QE.get(this)._GetWaypointXAt(e)}getWaypointY(e){return HE.RequireFiniteNumber(e),QE.get(this)._GetWaypointYAt(e)}getWaypoint(e){HE.RequireFiniteNumber(e);const t=QE.get(this);return[t._GetWaypointXAt(e),t._GetWaypointYAt(e)]}stop(){QE.get(this)._Stop()}get isMoving(){return QE.get(this)._IsMoving()}get speed(){return QE.get(this)._GetSpeed()}set speed(e){HE.RequireFiniteNumber(e),QE.get(this)._SetSpeed(e)}get maxSpeed(){return QE.get(this)._GetMaxSpeed()}set maxSpeed(e){HE.RequireFiniteNumber(e),QE.get(this)._SetMaxSpeed(e)}get acceleration(){return QE.get(this)._GetAcceleration()}set acceleration(e){HE.RequireFiniteNumber(e),QE.get(this)._SetAcceleration(e)}get deceleration(){return QE.get(this)._GetDeceleration()}set deceleration(e){HE.RequireFiniteNumber(e),QE.get(this)._SetDeceleration(e)}get angleOfMotion(){return QE.get(this)._GetAngleOfMotion()}set angleOfMotion(e){HE.RequireFiniteNumber(e),QE.get(this)._SetAngleOfMotion(e)}get rotateSpeed(){return QE.get(this)._GetRotateSpeed()}set rotateSpeed(e){HE.RequireFiniteNumber(e),QE.get(this)._SetRotateSpeed(e)}get isStopOnSolids(){return QE.get(this)._IsStopOnSolids()}set isStopOnSolids(e){QE.get(this)._SetStopOnSolids(e)}get isEnabled(){return QE.get(this)._IsEnabled()}set isEnabled(e){QE.get(this)._SetEnabled(e)}}}{const ZE=self.C3;ZE.Behaviors.MoveTo.Cnds={IsMoving(){return this._IsMoving()},CompareSpeed(e,t){return ZE.compare(this._GetSpeed(),e,t)},IsEnabled(){return this._IsEnabled()},OnArrived:()=>!0,OnHitSolid:()=>!0}}{const eD=self.C3,tD=25;eD.Behaviors.MoveTo.Acts={MoveToPosition(e,t,s){this._AddWaypoint(e,t,0===s)},MoveToObject(e,t,s){if(!e)return;const i=e.GetPairedInstance(this._inst);if(!i||!i.GetWorldInfo())return;const[r,n]=i.GetImagePoint(t);this._AddWaypoint(r,n,0===s)},MoveAlongPathfindingPath(e){const t=this._inst.GetBehaviorSdkInstanceFromCtor(eD.Behaviors.Pathfinding);if(!t)return;const s=t._GetPath();if(0!==s.length)for(let t=0,i=s.length;t<i;++t){const i=s[t];this._AddWaypoint(i.x,i.y,0===t&&0===e)}},MoveAlongTimeline(e,t,s){const i=eD.New(eD.TimelineInfo,e,t);if(!i.WasInitialized())return void i.Release();i.SetOrigin(this._inst.GetWorldInfo());let r=!0;for(const e of i.segments())switch(e.GetType()){case"line":{const t=e.GetX(),i=e.GetY();this._AddWaypoint(t,i,r&&0===s),r=!1;break}case"cubic-bezier":for(let t=0;t<=e.GetStepCount();t++){const i=t*e.GetStepIncrement(),n=e.Map(i),a=n[0],o=n[1],l=this._GetWaypointXAt(this._GetWaypointCount()-1),h=this._GetWaypointYAt(this._GetWaypointCount()-1);!r&&eD.IsFiniteNumber(l)&&eD.IsFiniteNumber(h)&&eD.distanceSquared(l,h,a,o)<tD||(this._AddWaypoint(a,o,r&&0===s,{isBezier:!0,isFirst:r,bezierAngle:Math.atan2(o-h,a-l)}),r=!1)}}this._timelineInfo=i},MoveAlongTimelineByName(e,t,s){const i=this._runtime.GetTimelineManager().GetTimelineByName(e);i&&eD.Behaviors.MoveTo.Acts.MoveAlongTimeline.call(this,i,t,s)},Stop(){this._Stop()},SetMovingAngle(e){this._SetAngleOfMotion(eD.toRadians(e))},SetSpeed(e){this._SetSpeed(e)},SetMaxSpeed(e){this._SetMaxSpeed(e)},SetAcceleration(e){this._SetAcceleration(e)},SetDeceleration(e){this._SetDeceleration(e)},SetRotateSpeed(e){this._SetRotateSpeed(eD.toRadians(e))},SetStopOnSolids(e){this._SetStopOnSolids(e)},SetEnabled(e){this._SetEnabled(e)}}}{const sD=self.C3;sD.Behaviors.MoveTo.Exps={Speed(){return this._GetSpeed()},MaxSpeed(){return this._GetMaxSpeed()},Acceleration(){return this._GetAcceleration()},Deceleration(){return this._GetDeceleration()},MovingAngle(){return sD.toDegrees(this._GetAngleOfMotion())},RotateSpeed(){return sD.toDegrees(this._GetRotateSpeed())},TargetX(){return this._GetTargetX()},TargetY(){return this._GetTargetY()},WaypointCount(){return this._GetWaypointCount()},WaypointXAt(e){return this._GetWaypointXAt(e)},WaypointYAt(e){return this._GetWaypointYAt(e)}}}{const iD=self.C3;iD.Behaviors.solid=class extends iD.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const rD=self.C3;rD.Behaviors.solid.Type=class extends rD.SDKBehaviorTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const nD=self.C3,aD=self.C3X,oD=self.IBehaviorInstance,lD=0,hD=1,uD=new Set;nD.Behaviors.solid.Instance=class extends nD.SDKBehaviorInstanceBase{constructor(e,t){super(e),this.SetEnabled(!0),t&&(this.SetEnabled(t[lD]),this.SetTags(t[hD]))}Release(){super.Release()}SetEnabled(e){this._inst._SetSolidEnabled(!!e)}IsEnabled(){return this._inst._IsSolidEnabled()}SetTags(e){const t=this._inst.GetSavedDataMap();if(!e.trim())return void t.delete("solidTags");let s=t.get("solidTags");s||(s=new Set,t.set("solidTags",s)),s.clear();for(const t of e.split(" "))t&&s.add(t.toLowerCase())}GetTags(){return this._inst.GetSavedDataMap().get("solidTags")||uD}_GetTagsString(){return[...this.GetTags()].join(" ")}SaveToJson(){return{e:this.IsEnabled()}}LoadFromJson(e){this.SetEnabled(e.e)}GetPropertyValueByIndex(e){if(e===lD)return this.IsEnabled()}SetPropertyValueByIndex(e,t){e===lD&&this.SetEnabled(t)}GetDebuggerProperties(){return[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:"behaviors.solid.properties.enabled.name",value:this.IsEnabled(),onedit:e=>this.SetEnabled(e)},{name:"behaviors.solid.properties.tags.name",value:this._GetTagsString(),onedit:e=>this.SetTags(e)}]}]}GetScriptInterfaceClass(){return self.ISolidBehaviorInstance}};const cD=new WeakMap;self.ISolidBehaviorInstance=class extends oD{constructor(){super(),cD.set(this,oD._GetInitInst().GetSdkInstance())}set isEnabled(e){cD.get(this).SetEnabled(!!e)}get isEnabled(){return cD.get(this).IsEnabled()}set tags(e){aD.RequireString(e),cD.get(this).SetTags(e)}get tags(){return cD.get(this)._GetTagsString()}}}self.C3.Behaviors.solid.Cnds={IsEnabled(){return this.IsEnabled()}},self.C3.Behaviors.solid.Acts={SetEnabled(e){this.SetEnabled(e)},SetTags(e){this.SetTags(e)}},self.C3.Behaviors.solid.Exps={};{const dD=self.C3;dD.Behaviors.LOS=class extends dD.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const pD=self.C3;pD.Behaviors.LOS.Type=class extends pD.SDKBehaviorTypeBase{constructor(e){super(e),this._obstacleTypes=[]}Release(){pD.clearArray(this._obstacleTypes),super.Release()}OnCreate(){}AddObstacle(e){if(!this._obstacleTypes.includes(e)){for(const t of this._obstacleTypes)if(t.IsFamily()&&t.FamilyHasMember(e))return;this._obstacleTypes.push(e)}}ClearObstacles(){pD.clearArray(this._obstacleTypes)}GetObstacleTypes(){return this._obstacleTypes}FindLOSBehavior(e){const t=this.GetBehaviorType();for(const s of e.GetBehaviorInstances())if(s.GetBehaviorType()===t)return s.GetSdkInstance();return null}}}{const _D=self.C3,mD=self.C3X,fD=self.IBehaviorInstance,gD=0,yD=1,SD=2,TD=3,xD=0,bD=[];_D.Behaviors.LOS.Instance=class extends _D.SDKBehaviorInstanceBase{constructor(e,t){super(e),this._obstacleMode=0,this._range=1e4,this._cone=_D.toRadians(360),this._useCollisionCells=!0,this._ray=new _D.Ray,t&&(this._obstacleMode=t[gD],this._range=t[yD],this._cone=_D.toRadians(t[SD]),this._useCollisionCells=t[TD])}Release(){super.Release()}SaveToJson(){return{r:this._range,c:this._cone,om:this._obstacleMode,ucc:this._useCollisionCells,t:this.GetSdkType().GetObstacleTypes().map(e=>e.GetSID())}}LoadFromJson(e){this._range=e.r,this._cone=e.c,this._obstacleMode=e.om||0,this._useCollisionCells=!!e.ucc;const t=this.GetSdkType().GetObstacleTypes();_D.clearArray(t);for(const s of e.t){const e=this._runtime.GetObjectClassBySID(s);e&&t.push(e)}}HasLOSToInstance(e,t){const s=e.GetUID(),[i,r]=e.GetImagePoint(t);return this.HasLOSTo(i,r)||this._ray.DidCollide()&&this._ray.hitUid===s}HasLOSTo(e,t){const s=this.GetWorldInfo();let i=s.GetAngle();return s.GetWidth()<0&&(i+=Math.PI),this.HasLOSBetweenPositions(s.GetX(),s.GetY(),i,e,t)}HasLOSBetweenPositions(e,t,s,i,r){this._ray.Reset();const n=this._range;if(_D.distanceSquared(e,t,i,r)>n*n)return!1;const a=_D.angleTo(e,t,i,r);return!(_D.angleDiff(s,a)>this._cone/2)&&!this.CastRay(e,t,i,r,this._useCollisionCells).DidCollide()}_GetCollisionCandidates(e,t){if(t){const t=this.GetWorldInfo().GetLayer(),s=this._runtime.GetCollisionEngine();return this._obstacleMode===xD?s.GetSolidCollisionCandidates(t,e.rect,bD):s.GetObjectClassesCollisionCandidates(t,this._GetObstacleTypes(),e.rect,bD),bD}if(this._obstacleMode===xD){const e=this._runtime.GetSolidBehavior();return e?e.GetInstances():bD}for(const e of this._GetObstacleTypes())_D.appendArray(bD,e.GetInstances());return bD}_GetObstacleTypes(){return this.GetSdkType().GetObstacleTypes()}CastRay(e,t,s,i,r){const n=this._ray.Set(e,t,s,i),a=this._GetCollisionCandidates(n,r),o=this._runtime.GetCollisionEngine(),l=this._obstacleMode===xD,h=this._inst;for(let e=0,t=a.length;e<t;++e){const t=a[e];t!==h&&(l&&!o.IsSolidCollisionAllowed(t,h)||o.TestRayIntersectsInstance(t,n))}return n.Complete(),_D.clearArray(bD),n}_GetRay(){return this._ray}_GetRayHitX(){const e=this._ray;return e.DidCollide()?e.hitX:0}_GetRayHitY(){const e=this._ray;return e.DidCollide()?e.hitY:0}_GetRayHitDistance(){const e=this._ray;return e.DidCollide()?e.distance:0}_GetRayHitUID(){const e=this._ray;return e.DidCollide()?e.hitUid:-1}_GetRayNormalX(e){const t=this._ray;return t.DidCollide()?t.hitX+e*t.normalX:0}_GetRayNormalY(e){const t=this._ray;return t.DidCollide()?t.hitY+e*t.normalY:0}_GetRayNormalAngle(){const e=this._ray;return e.DidCollide()?e.hitNormal:0}_GetRayReflectionX(e){const t=this._ray;return t.DidCollide()?t.hitX+e*t.reflectionX:0}_GetRayReflectionY(e){const t=this._ray;return t.DidCollide()?t.hitY+e*t.reflectionY:0}_GetRayReflectionAngle(){const e=this._ray;return e.DidCollide()?Math.atan2(e.reflectionY,e.reflectionX):0}_SetRange(e){this._range=e}_GetRange(){return this._range}_SetConeOfView(e){this._cone=e}_GetConeOfView(){return this._cone}GetPropertyValueByIndex(e){switch(e){case gD:return this._obstacleMode;case yD:return this._range;case SD:return _D.toDegrees(this._cone);case TD:return this._useCollisionCells}}SetPropertyValueByIndex(e,t){switch(e){case gD:this._obstacleMode=t;break;case yD:this._range=t;break;case SD:this._cone=_D.toRadians(t);break;case TD:this._useCollisionCells=!!t}}GetDebuggerProperties(){const e="behaviors.los.properties";return[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:e+".range.name",value:this._GetRange(),onedit:e=>this._SetRange(e)},{name:e+".cone-of-view.name",value:_D.toDegrees(this._GetConeOfView()),onedit:e=>this._SetConeOfView(_D.toRadians(e))}]}]}GetScriptInterfaceClass(){return self.ILOSBehaviorInstance}};const GD=new WeakMap;self.ILOSBehaviorInstance=class extends fD{constructor(){super();const e=fD._GetInitInst().GetSdkInstance();GD.set(this,e),this.ray=new self.ILOSBehaviorRay(e)}set range(e){mD.RequireFiniteNumber(e),GD.get(this)._SetRange(e)}get range(){return GD.get(this)._GetRange()}set coneOfView(e){mD.RequireFiniteNumber(e),GD.get(this)._SetConeOfView(e)}get coneOfView(){return GD.get(this)._GetConeOfView()}hasLOStoPosition(e,t){return mD.RequireNumber(e),mD.RequireNumber(t),GD.get(this).HasLOSTo(e,t)}hasLOSBetweenPositions(e,t,s,i,r){return mD.RequireNumber(e),mD.RequireNumber(t),mD.RequireNumber(s),mD.RequireNumber(i),mD.RequireNumber(r),GD.get(this).HasLOSBetweenPositions(e,t,s,i,r)}castRay(e,t,s,i,r=!0){return mD.RequireNumber(e),mD.RequireNumber(t),mD.RequireNumber(s),mD.RequireNumber(i),GD.get(this).CastRay(e,t,s,i,r),this.ray}addObstacle(e){const t=GD.get(this),s=t.GetRuntime()._UnwrapIObjectClass(e);t.GetSdkType().AddObstacle(s)}clearObstacles(){GD.get(this).GetSdkType().ClearObstacles()}},self.ILOSBehaviorRay=class{constructor(e){GD.set(this,e)}get didCollide(){return GD.get(this)._GetRay().DidCollide()}get hitX(){return GD.get(this)._GetRayHitX()}get hitY(){return GD.get(this)._GetRayHitY()}getHitPosition(){const e=GD.get(this);return[e._GetRayHitX(),e._GetRayHitY()]}get hitDistance(){return GD.get(this)._GetRayHitDistance()}get hitUid(){return GD.get(this)._GetRayHitUID()}getNormalX(e){return mD.RequireFiniteNumber(e),GD.get(this)._GetRayNormalX(e)}getNormalY(e){return mD.RequireFiniteNumber(e),GD.get(this)._GetRayNormalY(e)}getNormal(e){mD.RequireFiniteNumber(e);const t=GD.get(this);return[t._GetRayNormalX(e),t._GetRayNormalY(e)]}get normalAngle(){return GD.get(this)._GetRayNormalAngle()}getReflectionX(e){return mD.RequireFiniteNumber(e),GD.get(this)._GetRayReflectionX(e)}getReflectionY(e){return mD.RequireFiniteNumber(e),GD.get(this)._GetRayReflectionY(e)}getReflection(e){mD.RequireFiniteNumber(e);const t=GD.get(this);return[t._GetRayReflectionX(e),t._GetRayReflectionY(e)]}get reflectionAngle(){return GD.get(this)._GetRayReflectionAngle()}}}{const ID=self.C3,vD=new Set,CD=new Set;ID.Behaviors.LOS.Cnds={HasLOSToPosition(e,t){return this.HasLOSTo(e,t)},RayIntersected(){return this._ray.DidCollide()},HasLOSBetweenPositions(e,t,s,i,r){return this.HasLOSBetweenPositions(e,t,ID.toRadians(s),i,r)},HasLOSToObject(e,t){if(!e)return!1;const s=this._runtime.GetCurrentCondition(),i=s.GetEventBlock().IsOrBlock(),r=s.GetRuntime(),n=s.GetObjectClass().GetCurrentSol(),a=e.GetCurrentSol();let o=n.GetInstances(),l=a.GetInstances();n.IsSelectAll()?ID.clearArray(n._GetOwnElseInstances()):i&&(o=r.IsCurrentConditionFirst()&&!n._GetOwnElseInstances().length&&n._GetOwnInstances().length?n._GetOwnInstances():n._GetOwnElseInstances()),a.IsSelectAll()?ID.clearArray(a._GetOwnElseInstances()):i&&(l=r.IsCurrentConditionFirst()&&!a._GetOwnElseInstances().length&&a._GetOwnInstances().length?a._GetOwnInstances():a._GetOwnElseInstances());const h=s.IsInverted(),u=this.GetSdkType();for(const e of o){let s=!1;const i=u.FindLOSBehavior(e);if(0===l.length)h&&(s=!0);else for(const r of l)e!==r&&ID.xor(i.HasLOSToInstance(r,t),h)&&(s=!0,CD.add(r));s&&vD.add(e)}return i?(o===n._GetOwnElseInstances()?n.TransferElseInstancesToOwn(vD):(n.AddElseInstances(vD,o),n.SetSetPicked(vD)),l===a._GetOwnElseInstances()?a.TransferElseInstancesToOwn(CD):(a.AddElseInstances(CD,l),a.SetSetPicked(CD))):(n.SetSetPicked(vD),a.SetSetPicked(CD)),vD.clear(),CD.clear(),n.HasAnyInstances()}}}{const wD=self.C3;wD.Behaviors.LOS.Acts={SetRange(e){this._SetRange(e)},SetCone(e){this._SetConeOfView(wD.toRadians(e))},CastRay(e,t,s,i,r){this.CastRay(e,t,s,i,r)},AddObstacle(e){this.GetSdkType().AddObstacle(e)},ClearObstacles(){this.GetSdkType().ClearObstacles()}}}{const AD=self.C3;AD.Behaviors.LOS.Exps={Range(){return this._GetRange()},ConeOfView(){return AD.toDegrees(this._GetConeOfView())},HitX(){return this._GetRayHitX()},HitY(){return this._GetRayHitY()},HitDistance(){return this._GetRayHitDistance()},HitUID(){return this._GetRayHitUID()},NormalX(e){return this._GetRayNormalX(e)},NormalY(e){return this._GetRayNormalY(e)},NormalAngle(){return AD.toDegrees(this._GetRayNormalAngle())},ReflectionX(e){return this._GetRayReflectionX(e)},ReflectionY(e){return this._GetRayReflectionY(e)},ReflectionAngle(){return AD.toDegrees(this._GetRayReflectionAngle())}}}{const RD=self.C3;RD.Behaviors.Persist=class extends RD.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const PD=self.C3;PD.Behaviors.Persist.Type=class extends PD.SDKBehaviorTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const MD=self.C3;MD.Behaviors.Persist.Instance=class extends MD.SDKBehaviorInstanceBase{constructor(e,t){super(e)}Release(){super.Release()}}}self.C3.Behaviors.Persist.Cnds={},self.C3.Behaviors.Persist.Acts={},self.C3.Behaviors.Persist.Exps={};{const ED=self.C3;ED.Behaviors.bound=class extends ED.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const DD=self.C3;DD.Behaviors.bound.Type=class extends DD.SDKBehaviorTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const ND=self.C3,FD=0;ND.Behaviors.bound.Instance=class extends ND.SDKBehaviorInstanceBase{constructor(e,t){super(e),this._mode=0,t&&(this._mode=t[FD]),this._StartTicking2()}Release(){super.Release()}SaveToJson(){return{m:this._mode}}LoadFromJson(e){this._mode=e.m}Tick2(){const e=this._inst.GetWorldInfo(),t=e.GetBoundingBox(),s=e.GetLayout();let i=!1;0===this._mode?(e.GetX()<0&&(e.SetX(0),i=!0),e.GetY()<0&&(e.SetY(0),i=!0),e.GetX()>s.GetWidth()&&(e.SetX(s.GetWidth()),i=!0),e.GetY()>s.GetHeight()&&(e.SetY(s.GetHeight()),i=!0)):(t.getLeft()<0&&(e.OffsetX(-t.getLeft()),i=!0),t.getTop()<0&&(e.OffsetY(-t.getTop()),i=!0),t.getRight()>s.GetWidth()&&(e.OffsetX(-(t.getRight()-s.GetWidth())),i=!0),t.getBottom()>s.GetHeight()&&(e.OffsetY(-(t.getBottom()-s.GetHeight())),i=!0)),i&&e.SetBboxChanged()}GetPropertyValueByIndex(e){if(e===FD)return this._mode}SetPropertyValueByIndex(e,t){e===FD&&(this._mode=t)}}}self.C3.Behaviors.bound.Cnds={},self.C3.Behaviors.bound.Acts={},self.C3.Behaviors.bound.Exps={};{const OD=self.C3;OD.Behaviors.scrollto=class extends OD.SDKBehaviorBase{constructor(e){super(e),this._shakeMag=0,this._shakeStart=0,this._shakeEnd=0,this._shakeMode=0}Release(){super.Release()}SetShakeMagnitude(e){this._shakeMag=e}GetShakeMagnitude(){return this._shakeMag}SetShakeStart(e){this._shakeStart=e}GetShakeStart(){return this._shakeStart}SetShakeEnd(e){this._shakeEnd=e}GetShakeEnd(){return this._shakeEnd}SetShakeMode(e){this._shakeMode=e}GetShakeMode(){return this._shakeMode}}}{const BD=self.C3;BD.Behaviors.scrollto.Type=class extends BD.SDKBehaviorTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const LD=self.C3,kD=0;LD.Behaviors.scrollto.Instance=class extends LD.SDKBehaviorInstanceBase{constructor(e,t){super(e),this._isEnabled=!0,t&&(this._isEnabled=t[kD]),this._isEnabled&&this._StartTicking2()}Release(){super.Release()}SaveToJson(){const e=this.GetBehavior();return{e:this._isEnabled,smg:e.GetShakeMagnitude(),ss:e.GetShakeStart(),se:e.GetShakeEnd(),smd:e.GetShakeMode()}}LoadFromJson(e){const t=this.GetBehavior();t.SetShakeMagnitude(e.smg),t.SetShakeStart(e.ss),t.SetShakeEnd(e.se),t.SetShakeMode(e.smd),this._isEnabled=e.e,this._isEnabled?this._StartTicking2():this._StopTicking2()}_SetEnabled(e){this._isEnabled=!!e,this._isEnabled?this._StartTicking2():this._StopTicking2()}IsEnabled(){return this._isEnabled}Tick2(){if(!this.IsEnabled())return;this._runtime.GetDt(this._inst);const e=this.GetBehavior(),t=e.GetInstances();let s=0,i=0,r=0;for(const e of t){const t=e.GetBehaviorInstanceFromCtor(LD.Behaviors.scrollto);if(!t||!t.GetSdkInstance().IsEnabled())continue;const n=e.GetWorldInfo();s+=n.GetX(),i+=n.GetY(),++r}const n=this._inst.GetWorldInfo().GetLayout(),a=this._runtime.GetGameTime();let o=0,l=0;if(a>=e.GetShakeStart()&&a<e.GetShakeEnd()){let t=e.GetShakeMagnitude()*Math.min(this._runtime.GetTimeScale(),1);0===e.GetShakeMode()&&(t*=1-(a-e.GetShakeStart())/(e.GetShakeEnd()-e.GetShakeStart()));const s=this._runtime.Random()*Math.PI*2,i=this._runtime.Random()*t;o=Math.cos(s)*i,l=Math.sin(s)*i}n.SetScrollX(s/r+o),n.SetScrollY(i/r+l)}GetPropertyValueByIndex(e){if(e===kD)return this._isEnabled}SetPropertyValueByIndex(e,t){e===kD&&(this._isEnabled=!!t,this._isEnabled?this._StartTicking2():this._StopTicking2())}GetDebuggerProperties(){return[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:"behaviors.scrollto.properties.enabled.name",value:this.IsEnabled(),onedit:e=>this._SetEnabled(e)}]}]}}}self.C3.Behaviors.scrollto.Cnds={IsEnabled(){return this.IsEnabled()}},self.C3.Behaviors.scrollto.Acts={Shake(e,t,s){const i=this.GetBehavior();i.SetShakeMagnitude(e),i.SetShakeStart(this._runtime.GetGameTime()),i.SetShakeEnd(this._runtime.GetGameTime()+t),i.SetShakeMode(s)},SetEnabled(e){this._SetEnabled(0!==e)}},self.C3.Behaviors.scrollto.Exps={};{const VD=self.C3;VD.Behaviors.custom=class extends VD.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const UD=self.C3;UD.Behaviors.custom.Type=class extends UD.SDKBehaviorTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const WD=self.C3,HD=0,zD=1,jD=2;WD.Behaviors.custom.Instance=class extends WD.SDKBehaviorInstanceBase{constructor(e,t){super(e),this._dx=0,this._dy=0,this._cancelStep=0,this._stepMode=0,this._pxPerStep=5,this._isEnabled=!0,t&&(this._stepMode=t[HD],this._pxPerStep=t[zD],this._isEnabled=t[jD]),this._isEnabled&&this._StartTicking()}Release(){super.Release()}SaveToJson(){return{dx:this._dx,dy:this._dy,cs:this._cancelStep,sm:this._stepMode,px:this._pxPerStep,e:this._isEnabled}}LoadFromJson(e){this._dx=e.dx,this._dy=e.dy,this._cancelStep=e.cs,this._stepMode=e.sm,this._pxPerStep=e.px,this._SetEnabled(e.e)}GetSpeed(){return Math.hypot(this._dx,this._dy)}GetAngle(){return Math.atan2(this._dy,this._dx)}_Step(e,t,s){if(0===e&&0===t)return;const i=this.GetWorldInfo(),r=i.GetX(),n=i.GetY();let a=Math.round(WD.hypot2DFast(e,t)/this._pxPerStep);0===a&&(a=1);for(let o=1;o<=a;++o){let l=o/a;if(i.SetXY(r+e*l,n+t*l),i.SetBboxChanged(),this.Trigger(s),1===this._cancelStep)return o--,l=o/a,i.SetXY(r+e*l,n+t*l),void i.SetBboxChanged();if(2===this._cancelStep)return}}Tick(){if(!this._isEnabled||0===this._dx&&0===this._dy)return;const e=this._inst.GetWorldInfo(),t=this._runtime.GetDt(this._inst),s=this._dx*t,i=this._dy*t;this._cancelStep=0,0===this._stepMode?(e.OffsetXY(s,i),e.SetBboxChanged()):1===this._stepMode?this._Step(s,i,WD.Behaviors.custom.Cnds.OnCMStep):2===this._stepMode?(this._Step(s,0,WD.Behaviors.custom.Cnds.OnCMHorizStep),this._cancelStep=0,this._Step(0,i,WD.Behaviors.custom.Cnds.OnCMVertStep)):3===this._stepMode&&(this._Step(0,i,WD.Behaviors.custom.Cnds.OnCMVertStep),this._cancelStep=0,this._Step(s,0,WD.Behaviors.custom.Cnds.OnCMHorizStep))}GetPropertyValueByIndex(e){switch(e){case HD:return this._stepMode;case zD:return this._pxPerStep;case jD:return this._isEnabled}}SetPropertyValueByIndex(e,t){switch(e){case HD:this._stepMode=t;break;case zD:this._pxPerStep=t;break;case jD:this._SetEnabled(t)}}_SetEnabled(e){this._isEnabled=!!e,this._isEnabled?this._StartTicking():this._StopTicking()}GetDebuggerProperties(){const e="behaviors.custom";return[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:e+".debugger.vector-x",value:this._dx,onedit:e=>this._dx=e},{name:e+".debugger.vector-y",value:this._dy,onedit:e=>this._dy=e},{name:e+".properties.pixels-per-step.name",value:this._pxPerStep,onedit:e=>this._pxPerStep=e},{name:e+".properties.enabled.name",value:this._isEnabled,onedit:e=>this._SetEnabled(e)}]}]}}}{const YD=self.C3;YD.Behaviors.custom.Cnds={IsMoving(){return 0!==this._dx||0!==this._dy},CompareSpeed(e,t,s){let i=0;switch(e){case 0:i=this.GetSpeed();break;case 1:i=this._dx;break;case 2:i=this._dy}return YD.compare(i,t,s)},OnCMStep:()=>!0,OnCMHorizStep:()=>!0,OnCMVertStep:()=>!0,IsEnabled(){return this._isEnabled}}}{const qD=self.C3;qD.Behaviors.custom.Acts={Stop(){this._dx=0,this._dy=0},Reverse(e){switch(e){case 0:this._dx*=-1,this._dy*=-1;break;case 1:this._dx*=-1;break;case 2:this._dy*=-1}},SetSpeed(e,t){let s=0;switch(e){case 0:s=this.GetAngle(),this._dx=Math.cos(s)*t,this._dy=Math.sin(s)*t;break;case 1:this._dx=t;break;case 2:this._dy=t}},Accelerate(e,t){const s=t*this._runtime.GetDt(this._inst);let i;switch(e){case 0:i=this.GetAngle(),this._dx+=Math.cos(i)*s,this._dy+=Math.sin(i)*s;break;case 1:this._dx+=s;break;case 2:this._dy+=s}},AccelerateAngle(e,t){t=qD.toRadians(t);const s=e*this._runtime.GetDt(this._inst);this._dx+=Math.cos(t)*s,this._dy+=Math.sin(t)*s},AcceleratePos(e,t,s){const i=this.GetWorldInfo(),r=e*this._runtime.GetDt(this._inst),n=Math.atan2(s-i.GetY(),t-i.GetX());this._dx+=Math.cos(n)*r,this._dy+=Math.sin(n)*r},SetAngleOfMotion(e){e=qD.toRadians(e);const t=this.GetSpeed();this._dx=Math.cos(e)*t,this._dy=Math.sin(e)*t},RotateAngleOfMotionClockwise(e){e=this.GetAngle()+qD.toRadians(e);const t=this.GetSpeed();this._dx=Math.cos(e)*t,this._dy=Math.sin(e)*t},RotateAngleOfMotionCounterClockwise(e){e=this.GetAngle()-qD.toRadians(e);const t=this.GetSpeed();this._dx=Math.cos(e)*t,this._dy=Math.sin(e)*t},StopStepping(e){this._cancelStep=e+1},PushOutSolid(e){let t,s,i;const r=this._inst,n=this.GetRuntime().GetCollisionEngine();switch(e){case 0:t=this.GetAngle(),s=Math.cos(t),i=Math.sin(t),n.PushOutSolid(r,-s,-i,Math.max(3*this.GetSpeed(),100));break;case 1:n.PushOutSolidNearest(r);break;case 2:n.PushOutSolid(r,0,-1,Math.max(3*Math.abs(this._dy),100));break;case 3:n.PushOutSolid(r,0,1,Math.max(3*Math.abs(this._dy),100));break;case 4:n.PushOutSolid(r,-1,0,Math.max(3*Math.abs(this._dx),100));break;case 5:n.PushOutSolid(r,1,0,Math.max(3*Math.abs(this._dx),100))}},PushOutSolidAngle(e){e=qD.toRadians(e);const t=Math.cos(e),s=Math.sin(e);this.GetRuntime().GetCollisionEngine().PushOutSolid(this._inst,t,s,Math.max(3*this.GetSpeed(),100))},SetEnabled(e){this._SetEnabled(e)}}}{const XD=self.C3;XD.Behaviors.custom.Exps={Speed(){return this.GetSpeed()},MovingAngle(){return XD.toDegrees(this.GetAngle())},dx(){return this._dx},dy(){return this._dy}}}{const $D=self.C3;$D.Behaviors.Bullet=class extends $D.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const KD=self.C3;KD.Behaviors.Bullet.Type=class extends KD.SDKBehaviorTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const JD=self.C3,QD=self.C3X,ZD=self.IBehaviorInstance,eN=0,tN=1,sN=2,iN=3,rN=4,nN=5,aN=6;JD.Behaviors.Bullet.Instance=class extends JD.SDKBehaviorInstanceBase{constructor(e,t){super(e);const s=this.GetWorldInfo();this._speed=0,this._acc=0,this._g=0,this._bounceOffSolid=!1,this._setAngle=!1,this._isStepping=!1,this._isEnabled=!0,this._dx=0,this._dy=0,this._lastX=s.GetX(),this._lastY=s.GetY(),this._lastKnownAngle=s.GetAngle(),this._travelled=0,this._stepSize=Math.min(Math.abs(s.GetWidth()),Math.abs(s.GetHeight())/2),this._stopStepping=!1,t&&(this._speed=t[eN],this._acc=t[tN],this._g=t[sN],this._bounceOffSolid=!!t[iN],this._setAngle=!!t[rN],this._isStepping=!!t[nN],this._isEnabled=!!t[aN]);const i=s.GetAngle();this._dx=Math.cos(i)*this._speed,this._dy=Math.sin(i)*this._speed,this._isEnabled&&(this._StartTicking(),this._bounceOffSolid&&this._StartPostTicking())}Release(){super.Release()}SaveToJson(){const e={dx:this._dx,dy:this._dy,lx:this._lastX,ly:this._lastY,lka:this._lastKnownAngle,t:this._travelled};return 0!==this._acc&&(e.acc=this._acc),0!==this._g&&(e.g=this._g),this._isStepping&&(e.st=this._isStepping),this._isEnabled||(e.e=this._isEnabled),this._bounceOffSolid&&(e.bos=this._bounceOffSolid),this._setAngle&&(e.sa=this._setAngle),e}LoadFromJson(e){this._dx=e.dx,this._dy=e.dy,this._lastX=e.lx,this._lastY=e.ly,this._lastKnownAngle=e.lka,this._travelled=e.t,this._acc=e.hasOwnProperty("acc")?e.acc:0,this._g=e.hasOwnProperty("g")?e.g:0,this._isStepping=!!e.hasOwnProperty("st")&&e.st,this._bounceOffSolid=!!e.hasOwnProperty("bos")&&e.bos,this._setAngle=!!e.hasOwnProperty("sa")&&e.sa,this._SetEnabled(!e.hasOwnProperty("e")||e.e)}Tick(){if(!this._isEnabled)return;const e=this._runtime.GetDt(this._inst),t=this._inst.GetWorldInfo();if(t.GetAngle()!==this._lastKnownAngle){const e=t.GetAngle();if(this._setAngle){const t=JD.distanceTo(0,0,this._dx,this._dy);this._dx=Math.cos(e)*t,this._dy=Math.sin(e)*t}this._lastKnownAngle=e}let s=0,i=0;if(0!==this._acc){let r=JD.distanceTo(0,0,this._dx,this._dy),n=0;n=0===this._dx&&0===this._dy?t.GetAngle():JD.angleTo(0,0,this._dx,this._dy),r+=this._acc*e,s=Math.cos(n)*this._acc,i=Math.sin(n)*this._acc,r<0&&(r=0,s=0,i=0),this._dx=Math.cos(n)*r,this._dy=Math.sin(n)*r}if(0!==this._g&&(this._dy+=this._g*e,i+=this._g),this._lastX=t.GetX(),this._lastY=t.GetY(),0!==this._dx||0!==this._dy){const r=this._dx*e+.5*s*e*e,n=this._dy*e+.5*i*e*e,a=JD.distanceTo(0,0,r,n);if(this._MoveBy(r,n,a),this._travelled+=a,this._setAngle&&(0!==r||0!==n)){const e=JD.angleTo(0,0,r,n);t.SetAngle(e),this._lastKnownAngle=t.GetAngle()}t.SetBboxChanged()}}_MoveBy(e,t,s){const i=this.GetWorldInfo();if(!this._isStepping||s<=this._stepSize)return i.OffsetXY(e,t),i.SetBboxChanged(),void(this._isStepping&&this.Trigger(JD.Behaviors.Bullet.Cnds.OnStep));this._stopStepping=!1;const r=i.GetX(),n=i.GetY(),a=r+e,o=n+t,l=JD.angleTo(0,0,e,t),h=Math.cos(l)*this._stepSize,u=Math.sin(l)*this._stepSize,c=Math.floor(s/this._stepSize);for(let e=1;e<=c;++e)if(i.SetXY(r+h*e,n+u*e),i.SetBboxChanged(),this.Trigger(JD.Behaviors.Bullet.Cnds.OnStep),this._inst.IsDestroyed()||this._stopStepping)return;i.SetXY(a,o),i.SetBboxChanged(),this.Trigger(JD.Behaviors.Bullet.Cnds.OnStep)}PostTick(){if(!this._isEnabled||!this._bounceOffSolid||0===this._dx&&0===this._dy)return;const e=this._runtime.GetDt(this._inst),t=this._inst.GetWorldInfo(),s=this._runtime.GetCollisionEngine(),i=s.TestOverlapSolid(this._inst);if(i){s.RegisterCollision(this._inst,i);const r=JD.distanceTo(0,0,this._dx,this._dy),n=s.CalculateBounceAngle(this._inst,this._lastX,this._lastY);this._dx=Math.cos(n)*r,this._dy=Math.sin(n)*r,t.OffsetXY(this._dx*e,this._dy*e),t.SetBboxChanged(),this._setAngle&&(t.SetAngle(n),this._lastKnownAngle=t.GetAngle(),t.SetBboxChanged()),s.PushOutSolid(this._inst,this._dx/r,this._dy/r,Math.max(2.5*r*e,30))||s.PushOutSolidNearest(this._inst,100)}}GetPropertyValueByIndex(e){switch(e){case eN:return this._GetSpeed();case tN:return this._GetAcceleration();case sN:return this._GetGravity();case rN:return this._setAngle;case nN:return this._isStepping;case aN:return this._IsEnabled()}}SetPropertyValueByIndex(e,t){switch(e){case eN:this._SetSpeed(t);break;case tN:this._acc=t;break;case sN:this._g=t;break;case rN:this._setAngle=!!t;break;case nN:this._isStepping=!!t;break;case aN:this._SetEnabled(!!t)}}_SetSpeed(e){const t=JD.angleTo(0,0,this._dx,this._dy);this._dx=Math.cos(t)*e,this._dy=Math.sin(t)*e}_GetSpeed(){return JD.roundToDp(JD.distanceTo(0,0,this._dx,this._dy),6)}_SetAcceleration(e){this._acc=e}_GetAcceleration(){return this._acc}_SetGravity(e){this._g=e}_GetGravity(){return this._g}_SetAngleOfMotion(e){const t=JD.distanceTo(0,0,this._dx,this._dy);this._dx=Math.cos(e)*t,this._dy=Math.sin(e)*t}_GetAngleOfMotion(){return JD.angleTo(0,0,this._dx,this._dy)}_SetBounceOffSolids(e){e=!!e,this._bounceOffSolid!==e&&(this._bounceOffSolid=e,this._isEnabled&&(this._bounceOffSolid?this._StartPostTicking():this._StopPostTicking()))}_IsBounceOffSolids(){return this._bounceOffSolid}_SetDistanceTravelled(e){this._travelled=e}_GetDistanceTravelled(){return this._travelled}_SetEnabled(e){this._isEnabled=!!e,this._isEnabled?(this._StartTicking(),this._bounceOffSolid&&this._StartPostTicking()):(this._StopTicking(),this._StopPostTicking())}_IsEnabled(){return this._isEnabled}GetDebuggerProperties(){const e="behaviors.bullet";return[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:e+".debugger.vector-x",value:this._dx,onedit:e=>this._dx=e},{name:e+".debugger.vector-y",value:this._dy,onedit:e=>this._dy=e},{name:e+".properties.speed.name",value:this._GetSpeed(),onedit:e=>this._SetSpeed(e)},{name:e+".debugger.angle-of-motion",value:JD.toDegrees(this._GetAngleOfMotion())},{name:e+".properties.gravity.name",value:this._GetGravity(),onedit:e=>this._SetGravity(e)},{name:e+".properties.acceleration.name",value:this._GetAcceleration(),onedit:e=>this._SetAcceleration(e)},{name:e+".debugger.distance-travelled",value:this._GetDistanceTravelled()},{name:e+".properties.enabled.name",value:this._IsEnabled(),onedit:e=>this._SetEnabled(e)}]}]}GetScriptInterfaceClass(){return self.IBulletBehaviorInstance}};const oN=new WeakMap;self.IBulletBehaviorInstance=class extends ZD{constructor(){super(),oN.set(this,ZD._GetInitInst().GetSdkInstance())}get speed(){return oN.get(this)._GetSpeed()}set speed(e){QD.RequireFiniteNumber(e),oN.get(this)._SetSpeed(e)}get acceleration(){return oN.get(this)._GetAcceleration()}set acceleration(e){QD.RequireFiniteNumber(e),oN.get(this)._SetAcceleration(e)}get gravity(){return oN.get(this)._GetGravity()}set gravity(e){QD.RequireFiniteNumber(e),oN.get(this)._SetGravity(e)}get angleOfMotion(){return oN.get(this)._GetAngleOfMotion()}set angleOfMotion(e){QD.RequireFiniteNumber(e),oN.get(this)._SetAngleOfMotion(e)}get bounceOffSolids(){return oN.get(this)._IsBounceOffSolids()}set bounceOffSolids(e){oN.get(this)._SetBounceOffSolids(!!e)}get distanceTravelled(){return oN.get(this)._GetDistanceTravelled()}set distanceTravelled(e){QD.RequireFiniteNumber(e),oN.get(this)._SetDistanceTravelled(e)}get isEnabled(){return oN.get(this)._IsEnabled()}set isEnabled(e){oN.get(this)._SetEnabled(e)}}}{const lN=self.C3;lN.Behaviors.Bullet.Cnds={CompareSpeed(e,t){const s=Math.hypot(this._dx,this._dy);return lN.compare(s,e,t)},CompareTravelled(e,t){return lN.compare(this._GetDistanceTravelled(),e,t)},OnStep:()=>!0,IsEnabled(){return this._IsEnabled()}}}{const hN=self.C3;hN.Behaviors.Bullet.Acts={SetSpeed(e){this._SetSpeed(e)},SetAcceleration(e){this._SetAcceleration(e)},SetGravity(e){this._SetGravity(e)},SetAngleOfMotion(e){this._SetAngleOfMotion(hN.toRadians(e))},Bounce(e){if(!e)return;const t=e.GetFirstPicked(this._inst);if(!t)return;const s=this._inst.GetWorldInfo(),i=this._runtime.GetCollisionEngine(),r=this._runtime.GetDt(this._inst),n=hN.distanceTo(0,0,this._dx,this._dy),a=i.CalculateBounceAngle(this._inst,this._lastX,this._lastY,t);this._dx=Math.cos(a)*n,this._dy=Math.sin(a)*n,s.OffsetXY(this._dx*r,this._dy*r),s.SetBboxChanged(),this._setAngle&&(s.SetAngle(a),this._lastKnownAngle=s.GetAngle(),s.SetBboxChanged()),0!==n&&(this._bounceOffSolid?i.PushOutSolid(this._inst,this._dx/n,this._dy/n,Math.max(2.5*n*r,30))||i.PushOutSolidNearest(this._inst,100):i.PushOut(this._inst,this._dx/n,this._dy/n,Math.max(2.5*n*r,30),t))},SetBounceOffSolids(e){this._SetBounceOffSolids(e)},SetDistanceTravelled(e){this._SetDistanceTravelled(e)},SetEnabled(e){this._SetEnabled(e)},StopStepping(){this._stopStepping=!0}}}{const uN=self.C3;uN.Behaviors.Bullet.Exps={Speed(){return this._GetSpeed()},Acceleration(){return this._GetAcceleration()},AngleOfMotion(){return uN.toDegrees(this._GetAngleOfMotion())},DistanceTravelled(){return this._GetDistanceTravelled()},Gravity(){return this._GetGravity()}}}{const cN=self.C3;cN.Behaviors.DragnDrop=class extends cN.SDKBehaviorBase{constructor(e){super(e);const t=this._runtime.Dispatcher();this._disposables=new cN.CompositeDisposable(cN.Disposable.From(t,"pointerdown",e=>this._OnPointerDown(e.data)),cN.Disposable.From(t,"pointermove",e=>this._OnPointerMove(e.data)),cN.Disposable.From(t,"pointerup",e=>this._OnPointerUp(e.data,!1)),cN.Disposable.From(t,"pointercancel",e=>this._OnPointerUp(e.data,!0)))}Release(){this._disposables.Release(),this._disposables=null,super.Release()}_OnPointerDown(e){"mouse"===e.pointerType&&0!==e.button||this._OnInputDown(e.pointerId.toString(),e.pageX-this._runtime.GetCanvasClientX(),e.pageY-this._runtime.GetCanvasClientY())}_OnPointerMove(e){1&e.lastButtons&&!(1&e.buttons)?this._OnInputUp(e.pointerId.toString()):this._OnInputMove(e.pointerId.toString(),e.pageX-this._runtime.GetCanvasClientX(),e.pageY-this._runtime.GetCanvasClientY())}_OnPointerUp(e,t){"mouse"===e.pointerType&&0!==e.button||this._OnInputUp(e.pointerId.toString())}async _OnInputDown(e,t,s){const i=this.GetInstances();let r=null,n=null,a=0,o=0;for(const e of i){const i=e.GetBehaviorSdkInstanceFromCtor(cN.Behaviors.DragnDrop);if(!i.IsEnabled()||i.IsDragging()||e.IsDestroyed())continue;const l=e.GetWorldInfo(),h=l.GetLayer(),[u,c]=h.CanvasCssToLayer(t,s,l.GetTotalZElevation());if(!h.IsSelfAndParentsInteractive()||!l.ContainsPoint(u,c))continue;if(!r){r=e,n=i,a=u,o=c;continue}const d=r.GetWorldInfo();(h.GetIndex()>d.GetLayer().GetIndex()||h.GetIndex()===d.GetLayer().GetIndex()&&l.GetZIndex()>d.GetZIndex())&&(r=e,n=i,a=u,o=c)}r&&await n._OnDown(e,a,o)}_OnInputMove(e,t,s){const i=this.GetInstances();for(const r of i){const i=r.GetBehaviorSdkInstanceFromCtor(cN.Behaviors.DragnDrop);if(!i.IsEnabled()||!i.IsDragging()||i.IsDragging()&&i.GetDragSource()!==e)continue;const n=r.GetWorldInfo(),a=n.GetLayer(),[o,l]=a.CanvasCssToLayer(t,s,n.GetTotalZElevation());i._OnMove(o,l)}}async _OnInputUp(e){const t=this.GetInstances();for(const s of t){const t=s.GetBehaviorSdkInstanceFromCtor(cN.Behaviors.DragnDrop);t.IsDragging()&&t.GetDragSource()===e&&await t._OnUp()}}}}{const dN=self.C3;dN.Behaviors.DragnDrop.Type=class extends dN.SDKBehaviorTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const pN=self.C3,_N=(self.C3X,self.IBehaviorInstance),mN=0,fN=1;pN.Behaviors.DragnDrop.Instance=class extends pN.SDKBehaviorInstanceBase{constructor(e,t){super(e),this._isDragging=!1,this._dx=0,this._dy=0,this._dragSource="<none>",this._axes=0,this._isEnabled=!0,t&&(this._axes=t[mN],this._isEnabled=t[fN])}Release(){super.Release()}SaveToJson(){return{a:this._axes,e:this._isEnabled}}LoadFromJson(e){this._axes=e.a,this._isEnabled=e.e,this._isDragging=!1}_SetEnabled(e){this._isEnabled=!!e,this._isEnabled||(this._isDragging=!1)}IsEnabled(){return this._isEnabled}_SetAxes(e){this._axes=e}_GetAxes(){return this._axes}_Drop(){this._isDragging&&this._OnUp()}IsDragging(){return this._isDragging}GetDragSource(){return this._dragSource}async _OnDown(e,t,s){const i=this.GetWorldInfo();this._dx=t-i.GetX(),this._dy=s-i.GetY(),this._isDragging=!0,this._dragSource=e,this.DispatchScriptEvent("dragstart"),await this.TriggerAsync(pN.Behaviors.DragnDrop.Cnds.OnDragStart)}_OnMove(e,t){const s=this.GetWorldInfo(),i=e-this._dx,r=t-this._dy;0===this._axes?s.GetX()===i&&s.GetY()===r||(s.SetXY(i,r),s.SetBboxChanged()):1===this._axes?s.GetX()!==i&&(s.SetX(i),s.SetBboxChanged()):2===this._axes&&s.GetY()!==r&&(s.SetY(r),s.SetBboxChanged())}async _OnUp(){this._isDragging=!1,this.DispatchScriptEvent("drop"),await this.TriggerAsync(pN.Behaviors.DragnDrop.Cnds.OnDrop)}GetPropertyValueByIndex(e){switch(e){case mN:return this._GetAxes();case fN:return this.IsEnabled()}}SetPropertyValueByIndex(e,t){switch(e){case mN:this._SetAxes(t);break;case fN:this._SetEnabled(!!t)}}GetDebuggerProperties(){const e="behaviors.dragndrop",t=e+".properties.axes";let s="";return 0===this._axes?s=t+".items.both":1===this._axes?s=t+".items.horizontal-only":2===this._axes&&(s=t+".items.vertical-only"),[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:e+".debugger.is-dragging",value:this.IsDragging()},{name:t+".name",value:[s]},{name:e+".properties.enabled.name",value:this.IsEnabled(),onedit:e=>this._SetEnabled(e)}]}]}GetScriptInterfaceClass(){return self.IDragDropBehaviorInstance}};const gN=new WeakMap,yN=["both","horizontal","vertical"];self.IDragDropBehaviorInstance=class extends _N{constructor(){super(),gN.set(this,_N._GetInitInst().GetSdkInstance())}set axes(e){const t=yN.indexOf(e);if(-1===t)throw new Error("invalid axes");gN.get(this)._SetAxes(t)}get axes(){return yN[gN.get(this)._GetAxes()]}drop(){gN.get(this)._Drop()}get isDragging(){return gN.get(this).IsDragging()}get isEnabled(){return gN.get(this).IsEnabled()}set isEnabled(e){gN.get(this)._SetEnabled(e)}}}self.C3.Behaviors.DragnDrop.Cnds={IsDragging(){return this.IsDragging()},OnDragStart:()=>!0,OnDrop:()=>!0,IsEnabled(){return this.IsEnabled()}},self.C3.Behaviors.DragnDrop.Acts={SetEnabled(e){this._SetEnabled(!!e)},SetAxes(e){this._SetAxes(e)},Drop(){this._Drop()}},self.C3.Behaviors.DragnDrop.Exps={};{let SN=function(e){return"number"==typeof e?-e:e},TN=function(e,t){return"number"==typeof e&&"number"==typeof t},xN=function(e,t){return TN(e,t)?e+t:e},bN=function(e,t){return TN(e,t)?e-t:e},GN=function(e,t){return TN(e,t)?e*t:e},IN=function(e,t){return TN(e,t)?e/t:e},vN=function(e,t){return TN(e,t)?e%t:e},CN=function(e,t){return TN(e,t)?Math.pow(e,t):e},wN=function(e,t){if("string"==typeof e||"string"==typeof t){let s,i;return s="number"==typeof e?(Math.round(1e10*e)/1e10).toString():e,i="number"==typeof t?(Math.round(1e10*t)/1e10).toString():t,s+i}return e&&t?1:0},AN=function(e,t){return TN(e,t)?e||t?1:0:e};unaryminus=SN,bothNumbers=TN,add=xN,subtract=bN,multiply=GN,divide=IN,mod=vN,pow=CN,and=wN,or=AN;const RN=self.C3;self.C3_ExpressionFuncs=[()=>"windmillLevel1",()=>1,e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t("windmillFan")},e=>{const t=e._GetNode(0).GetVar();return()=>t.GetValue()},()=>0,()=>"windmillFan",e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(s.ExpObject())},()=>360,e=>{const t=e._GetNode(0);return()=>t.ExpObject()},()=>"npc",()=>5,e=>{const t=e._GetNode(0);return()=>t.ExpInstVar()},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2),r=e._GetNode(3);return()=>t(s.ExpInstVar(),i.ExpObject(),r.ExpObject())},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2),r=e._GetNode(3);return()=>t(s.ExpObject(),wN(i.ExpInstVar(),r.ExpInstVar()),"message")},e=>{const t=e._GetNode(0),s=e._GetNode(1),i=e._GetNode(2);return()=>wN(t.ExpObject()+"/"+s.ExpInstVar(),i.ExpInstVar())},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2),r=e._GetNode(3),n=e._GetNode(4);return()=>t(RN.toDegrees(RN.angleTo(s.ExpObject(),i.ExpObject(),r.ExpObject(),n.ExpObject())))},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(s.ExpInstVar())},e=>{const t=e._GetNode(0);return()=>wN("idle_",t.ExpInstVar())},e=>{const t=e._GetNode(0);return()=>t.ExpInstVar()+"_portrait"},()=>1280,e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(s.ExpObject())+5},()=>"",()=>-100,()=>.2,()=>"none",()=>"equipment",()=>"loot",()=>"GlowHorizontal",()=>"GlowVertical",e=>{const t=e._GetNode(0);return()=>t.ExpObject()-1},()=>"checked",e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2);return()=>t(s.ExpInstVar_Family(),i.ExpInstVar_Family())},e=>{const t=e._GetNode(0);return()=>t.ExpInstVar_Family()},e=>{const t=e._GetNode(0);return()=>t.ExpInstVar_Family()+"_item"},e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t("obtainedItem")},()=>"ascension",()=>.25,()=>"foreground",()=>100,e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(s.ExpInstVar_Family())},e=>{const t=e._GetNode(0);return()=>t.ExpObject()+5},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetBoundMethod();return()=>wN(wN(t(s()),"_"),"loot")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2).GetBoundMethod(),r=e._GetNode(3);return()=>t(s.ExpObject(),i(r.ExpObject(),"simpleName"),"_")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2);return()=>t(s.ExpObject(),i.ExpInstVar_Family(),"fullName")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2);return()=>t(s.ExpObject(),i.ExpInstVar_Family(),"type")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2);return()=>t(s.ExpObject(),i.ExpInstVar_Family(),"lore")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2);return()=>t(s.ExpObject(),i.ExpInstVar_Family(),"level")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2);return()=>t(s.ExpObject(),i.ExpInstVar_Family(),"value")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2);return()=>t(s.ExpObject(),i.ExpInstVar_Family(),"classRestrictions")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2);return()=>t(s.ExpObject(),i.ExpInstVar_Family(),"sound")},e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t(-180,180)},e=>{const t=e._GetNode(0).GetVar(),s=e._GetNode(1).GetVar();return()=>t.GetValue()+100*Math.cos(RN.toRadians(s.GetValue()))},e=>{const t=e._GetNode(0).GetVar(),s=e._GetNode(1).GetVar();return()=>t.GetValue()+50*Math.sin(RN.toRadians(s.GetValue()))},()=>.5,e=>{const t=e._GetNode(0),s=e._GetNode(1).GetBoundMethod(),i=e._GetNode(2).GetVar();return()=>t.ExpInstVar_Family()-s(100,i.GetValue())},e=>{const t=e._GetNode(0).GetBoundMethod();return()=>wN("static_",22.5*Math.floor(t(1,17))-180)},()=>"items",()=>"overlay",()=>70,e=>{const t=e._GetNode(0),s=e._GetNode(1),i=e._GetNode(2).GetBoundMethod(),r=e._GetNode(3),n=e._GetNode(4);return()=>wN(t.ExpInstVar()===s.ExpInstVar_Family()?1:0,i(r.ExpInstVar_Family(),n.ExpInstVar_Family()))},e=>{const t=e._GetNode(0),s=e._GetNode(1),i=e._GetNode(2);return()=>AN(t.ExpInstVar()===s.ExpInstVar_Family()?1:0,"none"===i.ExpInstVar()?1:0)},e=>{const t=e._GetNode(0);return()=>t.ExpInstVar_Family()+"_loot"},e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t()},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetBoundMethod();return()=>wN(wN(t(s()),"_"),"item")},()=>"gear",e=>{const t=e._GetNode(0),s=e._GetNode(1);return()=>t.ExpObject()+"_"+s.ExpInstVar_Family()+"_gear"},e=>{const t=e._GetNode(0);return()=>t.ExpInstVar_Family()+"Equip"},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(s.ExpInstVar_Family()+"Equip")},e=>{const t=e._GetNode(0),s=e._GetNode(1);return()=>wN("chest"===t.ExpInstVar()?1:0,s.ExpInstVar())},()=>"legs",()=>"head",e=>{const t=e._GetNode(0),s=e._GetNode(1);return()=>t.ExpObject()+"_"+s.ExpInstVar()+"Default_gear"},()=>"unequip",e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t("unequip")},()=>"isometry",e=>{const t=e._GetNode(0).GetVar(),s=e._GetNode(1).GetVar();return()=>t.GetValue()*RN.lerp(.5,1,Math.abs(Math.abs(s.GetValue())-90)/90)},()=>-90,()=>90,()=>"player",()=>"levels",e=>{const t=e._GetNode(0);return()=>100*t.ExpInstVar()},e=>{const t=e._GetNode(0),s=e._GetNode(1).GetBoundMethod(),i=e._GetNode(2),r=e._GetNode(3);return()=>t.ExpObject(s(i.ExpObject(),"simpleName"),r.ExpInstVar()-1)},()=>"facings",e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(s.ExpBehavior())},()=>-1,e=>{const t=e._GetNode(0),s=e._GetNode(1),i=e._GetNode(2).GetVar(),r=e._GetNode(3).GetVar();return()=>RN.toDegrees(RN.angleTo(t.ExpObject(),s.ExpObject(),i.GetValue(),r.GetValue()))},()=>"health and mana",e=>{const t=e._GetNode(0),s=e._GetNode(1),i=e._GetNode(2),r=e._GetNode(3);return()=>RN.clamp(t.ExpInstVar()/s.ExpInstVar()*i.ExpObject(),0,r.ExpObject())},e=>{const t=e._GetNode(0),s=e._GetNode(1);return()=>RN.clamp(t.ExpInstVar(),0,s.ExpInstVar())},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(s.ExpObject()+"_die")},()=>"die",e=>{const t=e._GetNode(0);return()=>t.ExpInstVar()>0?1:0},()=>"movement and interaction",e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2);return()=>t(s.ExpInstVar(),i.ExpBehavior())},()=>"stopMoving",()=>.3,e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t("walk")},()=>10,e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(s.ExpObject()+"Footstep")},()=>25,e=>{const t=e._GetNode(0);return()=>t.ExpObject(1)},()=>"mainHand",e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2),r=e._GetNode(3),n=e._GetNode(4);return()=>t(s.ExpInstVar()+i.ExpInstVar_Family(),r.ExpObject(),n.ExpObject())},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2).GetBoundMethod(),r=e._GetNode(3),n=e._GetNode(4),a=e._GetNode(5),o=e._GetNode(6);return()=>t(s.ExpInstVar()+i(r.ExpObject(),n.ExpObject()),a.ExpObject(1),o.ExpObject(1))},()=>"control",()=>"abilities",()=>"man",()=>"downwardSlash",e=>{const t=e._GetNode(0);return()=>9/t.ExpObject()},e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t("swingWeapon")},()=>150,()=>99,e=>{const t=e._GetNode(0);return()=>t.ExpObject()/3},e=>{const t=e._GetNode(0);return()=>t.ExpBehavior()},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(650,s.ExpBehavior())},e=>{const t=e._GetNode(0),s=e._GetNode(1),i=e._GetNode(2).GetVar();return()=>t.ExpObject()/s.ExpObject()-i.GetValue()},()=>"heroicStrike",()=>"upwardSlash",e=>{const t=e._GetNode(0);return()=>4/t.ExpObject()},e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t("heroicStrike")},e=>{const t=e._GetNode(0);return()=>1.1*t.ExpInstVar()},()=>126,e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(700,s.ExpBehavior())},()=>"kick",()=>15,e=>{const t=e._GetNode(0);return()=>11/t.ExpObject()},()=>140,e=>{const t=e._GetNode(0);return()=>.5*t.ExpInstVar()},()=>500,()=>81,e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(750,s.ExpBehavior())},()=>"animations",e=>{const t=e._GetNode(0),s=e._GetNode(1),i=e._GetNode(2),r=e._GetNode(3);return()=>AN(t.ExpObject()!==s.ExpInstVar()?1:0,i.ExpObject()!==r.ExpInstVar()?1:0)},()=>"walk",e=>{const t=e._GetNode(0),s=e._GetNode(1),i=e._GetNode(2);return()=>t.ExpObject()*(s.ExpInstVar()/i.ExpInstVar())},e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t("idle")},e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t("die")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2).GetVar();return()=>t(s.ExpObject()+"_"+i.GetValue())},()=>"idle",e=>{const t=e._GetNode(0).GetVar(),s=e._GetNode(1);return()=>wN(t.GetValue()+"_",s.ExpInstVar())},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2).GetVar();return()=>t(s.ExpObject(),i.GetValue())},e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t("block")},e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t("hit")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetVar();return()=>t(s.GetValue())},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetVar(),i=e._GetNode(2),r=e._GetNode(3).GetBoundMethod(),n=e._GetNode(4).GetVar();return()=>AN(t(s.GetValue(),i.ExpObject()),r(n.GetValue(),"All Classes"))},()=>"pillar of fate",()=>"highlight",()=>"normal",()=>"ability bar",e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2);return()=>t(s.ExpObject(),i.ExpObject(),"category")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(s.ExpObject(),"category")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(s.ExpObject(),"level")},e=>{const t=e._GetNode(0),s=e._GetNode(1).GetBoundMethod(),i=e._GetNode(2),r=e._GetNode(3).GetBoundMethod();return()=>t.ExpObject(s(i.ExpObject(),"simpleName"),r())},()=>"Grayscale",()=>"Brightness",()=>"menus",e=>{const t=e._GetNode(0);return()=>t.ExpInstVar().toString()},e=>{const t=e._GetNode(0);return()=>wN(t.ExpInstVar(),"/second")},()=>"display",()=>"canvas[data-engine]",()=>"menuOpen",()=>"menuClose",e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t("menuClose")},e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t("menuOpen")},()=>"passives",e=>{const t=e._GetNode(0),s=e._GetNode(1).GetVar(),i=e._GetNode(2).GetVar(),r=e._GetNode(3).GetVar();return()=>t.ExpObject(s.GetValue(),i.GetValue(),r.GetValue())},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetVar();return()=>t(s.GetValue(),0,":")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetVar();return()=>t(s.GetValue(),1,":")},e=>{const t=e._GetNode(0);return()=>wN(t.ExpInstVar()," point available")},e=>{const t=e._GetNode(0);return()=>wN(t.ExpInstVar()," points available")},e=>{const t=e._GetNode(0);return()=>wN(t.ExpInstVar()," point allocated")},e=>{const t=e._GetNode(0);return()=>wN(t.ExpInstVar()," points allocated")},()=>"tooltip",e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2);return()=>t(s.ExpObject(),i.ExpObject(),"fullName")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2);return()=>t(s.ExpObject(),i.ExpObject(),"class")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2);return()=>t(s.ExpObject(),i.ExpObject(),"level")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetBoundMethod(),i=e._GetNode(2),r=e._GetNode(3);return()=>t(s(i.ExpObject(),r.ExpObject(),"description"))},e=>{const t=e._GetNode(0).GetVar();return()=>wN(t.GetValue()," ")+"Coins"},e=>{const t=e._GetNode(0).GetVar();return()=>wN("Level ",t.GetValue())},()=>10805227,()=>20,e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetVar();return()=>t(s.GetValue(),";")-2},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetBoundMethod(),i=e._GetNode(2).GetBoundMethod(),r=e._GetNode(3).GetVar(),n=e._GetNode(4).GetBoundMethod();return()=>t(s(i(r.GetValue(),n(),";"),1,":"),"\\{|}","g","")+"\n"},()=>65280,()=>255,e=>{const t=e._GetNode(0),s=e._GetNode(1);return()=>t.ExpObject()-s.ExpObject()-15},e=>{const t=e._GetNode(0),s=e._GetNode(1);return()=>t.ExpObject()-s.ExpObject()+20},e=>{const t=e._GetNode(0);return()=>t.ExpObject()+50},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetVar();return()=>t(s.GetValue(),"newline","\n")},()=>"enemy info",e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetVar();return()=>t(s.GetValue(),",")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetVar(),i=e._GetNode(2).GetBoundMethod();return()=>t(s.GetValue(),i(),",")+"\n"},e=>{const t=e._GetNode(0),s=e._GetNode(1);return()=>t.ExpInstVar()/s.ExpInstVar()*100},()=>"settings",()=>"unchecked",e=>{const t=e._GetNode(0);return()=>wN("unchecked",t.ExpObject())},e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t("unchecked")},e=>{const t=e._GetNode(0);return()=>wN("checked",t.ExpObject())},e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t("checked")},()=>"...",e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetBoundMethod(),i=e._GetNode(2).GetBoundMethod();return()=>t(s(i()," ","spacebar"))},e=>{const t=e._GetNode(0);return()=>"[outline=black]"+t.ExpObject()},()=>"musicVolume",()=>"soundEffectsVolume",()=>"dialogVolume",e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetVar();return()=>Math.round(t(s.GetValue(),-50))},()=>65,()=>75,e=>{const t=e._GetNode(0),s=e._GetNode(1),i=e._GetNode(2).GetBoundMethod(),r=e._GetNode(3);return()=>Math.round(RN.lerp(0,100,RN.unlerp(t.ExpObject(),s.ExpObject(),i(r.ExpObject()))))},()=>"statues",()=>50,()=>"enemies",()=>"behaviors",e=>{const t=e._GetNode(0),s=e._GetNode(1).GetVar();return()=>t.ExpBehavior()-s.GetValue()},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetVar(),i=e._GetNode(2).GetVar();return()=>t(s.GetValue(),i.GetValue())},e=>{const t=e._GetNode(0),s=e._GetNode(1).GetVar(),i=e._GetNode(2).GetVar();return()=>t.ExpObject()+Math.cos(RN.toRadians(s.GetValue()))*i.GetValue()},e=>{const t=e._GetNode(0),s=e._GetNode(1).GetVar(),i=e._GetNode(2).GetVar();return()=>t.ExpObject()+Math.sin(RN.toRadians(s.GetValue()))*i.GetValue()},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(s.ExpObject(),"walk")},()=>13,()=>33,()=>"goingBackward",()=>"goingLeft",()=>"no",()=>"goingRight",()=>"goingBackwardAgain",()=>180,e=>{const t=e._GetNode(0);return()=>2*t.ExpObject()},e=>{const t=e._GetNode(0);return()=>wN("walk_",t.ExpInstVar())},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(s.ExpObject(),"die")},e=>{const t=e._GetNode(0);return()=>wN("die_",t.ExpInstVar())},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(s.ExpInstVar()+"_die")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(s.ExpObject(),"attack")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(s.ExpObject(),"hit")},()=>"enemy abilities",()=>"goblinWarlock",e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(100,s.ExpInstVar())/600},e=>{const t=e._GetNode(0),s=e._GetNode(1),i=e._GetNode(2),r=e._GetNode(3);return()=>RN.toDegrees(RN.angleTo(t.ExpObject(),s.ExpObject(),i.ExpObject(),r.ExpObject()))},e=>{const t=e._GetNode(0);return()=>wN("attack_",t.ExpInstVar())},e=>{const t=e._GetNode(0),s=e._GetNode(1).GetVar();return()=>5/t.ExpObject()-s.GetValue()},()=>30,e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(600,s.ExpBehavior())},e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t("lightningOrb")},e=>{const t=e._GetNode(0);return()=>t.ExpObject().toString()},()=>"goblinUnderling",e=>{const t=e._GetNode(0);return()=>19/t.ExpObject()},()=>120,()=>"goblinArcher",e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(80,s.ExpInstVar())/600},e=>{const t=e._GetNode(0),s=e._GetNode(1).GetVar();return()=>48/t.ExpObject()-s.GetValue()},e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t("arrowShot")},()=>"shadows",e=>{const t=e._GetNode(0);return()=>t.ExpObject()+"_shadow"},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2).GetBoundMethod();return()=>t(s.ExpObject(),i(),"shadowOpacity")},()=>"BlurHorizontal",()=>"BlurVertical",()=>"projectiles",e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2);return()=>t(s.ExpInstVar(),i.ExpInstVar())},e=>{const t=e._GetNode(0),s=e._GetNode(1).GetBoundMethod(),i=e._GetNode(2),r=e._GetNode(3),n=e._GetNode(4);return()=>t.ExpObject()+s(i.ExpInstVar(),r.ExpBehavior())*Math.cos(RN.toRadians(n.ExpBehavior()))},e=>{const t=e._GetNode(0),s=e._GetNode(1).GetBoundMethod(),i=e._GetNode(2),r=e._GetNode(3),n=e._GetNode(4);return()=>t.ExpObject()+s(i.ExpInstVar(),r.ExpBehavior())*Math.sin(RN.toRadians(n.ExpBehavior()))},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(s.ExpInstVar(),"Unflinching")},e=>{const t=e._GetNode(0);return()=>wN("hit_",t.ExpInstVar())},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(s.ExpInstVar()+"_hit")},()=>"block",e=>{const t=e._GetNode(0).GetVar(),s=e._GetNode(1),i=e._GetNode(2);return()=>t.GetValue()-s.ExpInstVar()/i.ExpInstVar()},()=>"hit",()=>"data management",e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetVar(),i=e._GetNode(2),r=e._GetNode(3),n=e._GetNode(4).GetVar(),a=e._GetNode(5).GetVar(),o=e._GetNode(6),l=e._GetNode(7),h=e._GetNode(8).GetVar(),u=e._GetNode(9).GetVar();return()=>t(s.GetValue(),RN.toDegrees(RN.angleTo(i.ExpObject(),r.ExpObject(),n.GetValue(),a.GetValue())))>=RN.distanceTo(o.ExpObject(),l.ExpObject(),h.GetValue(),u.GetValue())?1:0},e=>{const t=e._GetNode(0),s=e._GetNode(1).GetBoundMethod();return()=>t.ExpObject(0,s())},e=>{const t=e._GetNode(0),s=e._GetNode(1).GetVar(),i=e._GetNode(2).GetBoundMethod();return()=>t.ExpObject(s.GetValue(),i())},e=>{const t=e._GetNode(0).GetVar();return()=>22.5*Math.round(t.GetValue()/22.5)},()=>-180,e=>{const t=e._GetNode(0).GetVar(),s=e._GetNode(1).GetVar();return()=>t.GetValue()/(100+s.GetValue())},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetVar(),i=e._GetNode(2).GetBoundMethod();return()=>t(s.GetValue())>i(1)?1:0},e=>{const t=e._GetNode(0).GetVar(),s=e._GetNode(1).GetBoundMethod(),i=e._GetNode(2).GetVar();return()=>Math.round(1*t.GetValue()-s(i.GetValue()))},()=>"mods",e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetVar(),i=e._GetNode(2).GetBoundMethod();return()=>t(s.GetValue(),i(),";")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetVar();return()=>t(s.GetValue(),0)},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetBoundMethod(),i=e._GetNode(2).GetVar(),r=e._GetNode(3).GetVar();return()=>t(s(i.GetValue(),"\\{.*?\\}","g",r.GetValue()),"\\{|}","g","")},e=>{const t=e._GetNode(0).GetBoundMethod();return()=>Math.floor(t(1,5))},e=>{const t=e._GetNode(0).GetVar(),s=e._GetNode(1),i=e._GetNode(2).GetVar();return()=>wN(t.GetValue()+":",s.ExpObject(i.GetValue()))+";"},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetVar();return()=>t(s.GetValue(),"\\[.*?\\]","g")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetBoundMethod(),i=e._GetNode(2).GetVar();return()=>t(s(i.GetValue(),"\\[.*?\\]","",0),"\\[|]","g","")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetVar();return()=>t(s.GetValue(),"-")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetBoundMethod(),i=e._GetNode(2).GetVar();return()=>t(s(i.GetValue(),0,"-"))},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetBoundMethod(),i=e._GetNode(2).GetVar();return()=>t(s(i.GetValue(),1,"-"))},()=>"modValues",e=>{const t=e._GetNode(0).GetVar(),s=e._GetNode(1).GetBoundMethod();return()=>t.GetValue()-s()+1},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetVar(),i=e._GetNode(2).GetBoundMethod(),r=e._GetNode(3).GetVar();return()=>t(s.GetValue(),"\\[.*?\\]","",wN("{",xN(i(),r.GetValue()))+"}")},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetVar(),i=e._GetNode(2).GetBoundMethod(),r=e._GetNode(3).GetVar(),n=e._GetNode(4).GetBoundMethod(),a=e._GetNode(5).GetBoundMethod(),o=e._GetNode(6).GetVar();return()=>t(s.GetValue(),"\\[.*?\\]","","{"+i(r.GetValue(),Math.floor(n(a(o.GetValue(),"$"))),"$")+"}")},()=>"mod functions",e=>{const t=e._GetNode(0),s=e._GetNode(1).GetVar(),i=e._GetNode(2);return()=>RN.clamp(t.ExpInstVar()-s.GetValue(),1,i.ExpInstVar())},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetVar();return()=>t(s.GetValue(),1)},()=>"Slash",()=>"Smash",()=>"Stab",()=>"audio",()=>"cantCarry",e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(s.ExpObject()+"_cantCarry")},()=>"cantPurchase",e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(s.ExpInstVar()+"_cantPurchase")},()=>"notEnoughCoins",e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(s.ExpObject()+"_notEnoughCoins")},e=>{const t=e._GetNode(0).GetVar(),s=e._GetNode(1).GetBoundMethod(),i=e._GetNode(2),r=e._GetNode(3).GetVar();return()=>wN(t.GetValue(),Math.floor(s(i.ExpObject(r.GetValue()))))},e=>{const t=e._GetNode(0);return()=>t.ExpInstVar_Family()+"Drop"},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(s.ExpInstVar_Family()+"Drop")},()=>"environment",e=>{const t=e._GetNode(0),s=e._GetNode(1);return()=>wN(t.ExpObject(),s.ExpObject())},e=>{const t=e._GetNode(0);return()=>-t.ExpObject()},()=>"debugging",()=>"main menu",()=>"log in",()=>"Authentication successful. Entering the world of Ashladon...",()=>"farm",()=>"The account has been successfully created. Please check your email with a link to verify your account.",()=>"An email with a link to reset the password has been sent.",()=>"manPickup",()=>"Account functionality has not yet been implemented. Continuing without an account...",()=>"loading screen",e=>{const t=e._GetNode(0),s=e._GetNode(1).GetBoundMethod(),i=e._GetNode(2);return()=>wN("[outline=black]",t.ExpObject(0,Math.floor(s(i.ExpObject()))))},e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t()+1},e=>{const t=e._GetNode(0).GetVar(),s=e._GetNode(1).GetBoundMethod();return()=>t.GetValue()-s()},()=>"splash screen",e=>{const t=e._GetNode(0).GetBoundMethod();return()=>100*t()},()=>"[outline=black]Update available. Downloading",()=>"mainMenu",e=>{const t=e._GetNode(0).GetBoundMethod();return()=>"Current URL is "+t()},()=>"flatHealth",()=>"flatSlash",()=>"flatStab",()=>"flatSmash",()=>"flatArmor",()=>"flatManaRegen",()=>"flatSlashAndStab",()=>"flatPhysical",e=>{const t=e._GetNode(0),s=e._GetNode(1).GetBoundMethod(),i=e._GetNode(2),r=e._GetNode(3).GetBoundMethod();return()=>t.ExpObject(s(i.ExpObject(),"dropTable"),r())},e=>{const t=e._GetNode(0),s=e._GetNode(1).GetBoundMethod(),i=e._GetNode(2),r=e._GetNode(3).GetBoundMethod();return()=>t.ExpObject(s(i.ExpObject(),"mods"),r())},e=>{const t=e._GetNode(0);return()=>t.ExpObject()+1},()=>"characterCreator",()=>"text buttons",()=>"mouseOn",()=>"mouseOff",e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t("mouseOff")},e=>{const t=e._GetNode(0);return()=>.9*t.ExpObject()},e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t("mouseOn")},()=>"womanPickup"]}}}),import_c3runtime=__toESM(require_c3runtime()),C32=self.C3;self.C3_GetObjectRefTable=function(){return[C32.Plugins.AJAX,C32.Plugins.Arr,C32.Plugins.Keyboard,C32.Plugins.AdvancedRandom,C32.Plugins.Mouse,C32.Plugins.Browser,C32.Plugins.video,C32.Plugins.Audio,C32.Plugins.Dictionary,C32.Plugins.PlatformInfo,C32.Plugins.Sprite,C32.Plugins.TiledBg,C32.Plugins.Text,C32.Plugins.NinePatch,C32.Behaviors.Tween,C32.Behaviors.Anchor,C32.Behaviors.MoveTo,C32.Behaviors.solid,C32.Behaviors.LOS,C32.Behaviors.Persist,C32.Behaviors.bound,C32.Behaviors.scrollto,C32.Behaviors.custom,C32.Behaviors.Bullet,C32.Plugins.TextBox,C32.Behaviors.DragnDrop,C32.Plugins.System.Cnds.IsGroupActive,C32.Plugins.System.Cnds.Every,C32.Plugins.Audio.Acts.PlayByName,C32.Plugins.Sprite.Cnds.IsOnScreen,C32.Plugins.Sprite.Cnds.CompareFrame,C32.Plugins.System.Cnds.TriggerOnce,C32.Plugins.Audio.Acts.PlayAtObjectByName,C32.Plugins.Sprite.Exps.ObjectTypeName,C32.Plugins.System.Cnds.OnLayoutStart,C32.Plugins.System.Cnds.IsPreview,C32.JavaScriptInEvents.Farm_Event2_Act1,C32.Plugins.System.Cnds.OnLayoutEnd,C32.Plugins.Sprite.Cnds.IsOnLayer,C32.Plugins.Sprite.Exps.LayerName,C32.Plugins.Sprite.Cnds.PickParent,C32.Plugins.Sprite.Acts.Destroy,C32.Plugins.NinePatch.Acts.SetInstanceVar,C32.Plugins.Sprite.Cnds.IsBoolInstanceVarSet,C32.Plugins.System.Cnds.Repeat,C32.Plugins.NinePatch.Cnds.IsOnLayer,C32.Plugins.NinePatch.Cnds.CompareInstanceVar,C32.Plugins.System.Cnds.PickNth,C32.Plugins.System.Cnds.PickByComparison,C32.Plugins.System.Cnds.EvaluateExpression,C32.Plugins.Sprite.Exps.X,C32.Plugins.Sprite.Exps.Y,C32.Plugins.System.Cnds.LayerVisible,C32.Plugins.Mouse.Cnds.OnObjectClicked,C32.Plugins.Sprite.Cnds.PickChildren,C32.Plugins.Sprite.Cnds.CompareInstanceVar,C32.Plugins.Audio.Acts.Stop,C32.Plugins.Sprite.Acts.AddInstanceVar,C32.Plugins.Text.Acts.SetText,C32.Plugins.Arr.Exps.ObjectTypeName,C32.Plugins.System.Cnds.Else,C32.Plugins.Sprite.Exps.UID,C32.Behaviors.MoveTo.Acts.Stop,C32.Plugins.System.Acts.ResetEventVar,C32.Plugins.Sprite.Acts.SetInstanceVar,C32.Plugins.System.Exps.lowercase,C32.Plugins.Sprite.Acts.SetAnim,C32.Plugins.System.Acts.LoadObjectTexturesByName,C32.Plugins.System.Acts.WaitForPreviousActions,C32.Plugins.System.Acts.CreateObjectByName,C32.Plugins.System.Exps.viewportbottom,C32.Plugins.System.Cnds.PickLastCreated,C32.Plugins.Sprite.Acts.AddChild,C32.Plugins.Audio.Acts.FadeVolume,C32.Plugins.System.Acts.Wait,C32.Plugins.System.Acts.UnloadObjectTextures,C32.Plugins.Mouse.Cnds.IsOverObject,C32.Plugins.Sprite.Acts.SetEffectEnabled,C32.Plugins.Sprite.Cnds.IsOverlapping,C32.Behaviors.custom.Acts.PushOutSolid,C32.Plugins.System.Cnds.PickByHighestLowestValue,C32.Plugins.Sprite.Acts.SetY,C32.Plugins.System.Acts.SetBoolVar,C32.Plugins.Sprite.Cnds.IsAnimPlaying,C32.Plugins.NinePatch.Exps.X,C32.Plugins.NinePatch.Exps.Y,C32.Plugins.NinePatch.Cnds.PickChildren,C32.Plugins.Sprite.Acts.SetVisible,C32.Behaviors.Tween.Cnds.OnTweensFinished,C32.Behaviors.Tween.Acts.TweenOneProperty,C32.Plugins.Sprite.Cnds.OnCreated,C32.Plugins.System.Acts.AddVar,C32.Plugins.Sprite.Acts.Spawn,C32.Plugins.Sprite.Acts.SetEffectParam,C32.Plugins.Sprite.Acts.SetSize,C32.Plugins.Text.Exps.TextWidth,C32.Plugins.Text.Exps.TextHeight,C32.Plugins.AdvancedRandom.Exps.WeightedByName,C32.Plugins.System.Exps.layoutname,C32.Plugins.TiledBg.Exps.LayerName,C32.Plugins.System.Exps.tokenat,C32.Plugins.System.Acts.SetVar,C32.Plugins.System.Exps.random,C32.Plugins.Sprite.Acts.SetScale,C32.Behaviors.Tween.Acts.TweenTwoProperties,C32.Behaviors.DragnDrop.Cnds.IsDragging,C32.Plugins.System.Cnds.LayerInteractive,C32.Plugins.System.Cnds.PickAll,C32.Plugins.NinePatch.Exps.UID,C32.Plugins.NinePatch.Cnds.PickByUID,C32.Plugins.Sprite.Acts.RemoveFromParent,C32.Plugins.Sprite.Acts.SubInstanceVar,C32.Behaviors.DragnDrop.Cnds.OnDragStart,C32.Plugins.Sprite.Acts.MoveToLayer,C32.Behaviors.DragnDrop.Cnds.OnDrop,C32.Plugins.Sprite.Cnds.PickByUID,C32.Plugins.System.Cnds.Compare,C32.Plugins.Mouse.Exps.X,C32.Plugins.Mouse.Exps.Y,C32.Plugins.Sprite.Acts.SetPosToObject,C32.Plugins.NinePatch.Exps.LayerName,C32.Plugins.NinePatch.Acts.AddChild,C32.Plugins.Arr.Acts.Push,C32.Plugins.System.Cnds.CompareBoolVar,C32.Plugins.Arr.Exps.Back,C32.Plugins.Arr.Acts.Pop,C32.Plugins.Audio.Cnds.IsTagPlaying,C32.Plugins.System.Acts.SetFunctionReturnValue,C32.Plugins.System.Acts.SortZOrderByInstVar,C32.Plugins.Sprite.Acts.ZMoveToObject,C32.Plugins.Arr.Exps.At,C32.Behaviors.MoveTo.Exps.MovingAngle,C32.Plugins.System.Exps.timescale,C32.Plugins.System.Cnds.CompareVar,C32.Behaviors.MoveTo.Acts.SetMovingAngle,C32.Plugins.System.Cnds.EveryTick,C32.Plugins.TiledBg.Acts.SetHeight,C32.Plugins.TiledBg.Exps.ImageHeight,C32.Plugins.Sprite.Exps.OriginalAnimationSpeed,C32.Behaviors.MoveTo.Acts.SetMaxSpeed,C32.Plugins.Text.Cnds.CompareInstanceVar,C32.Plugins.Keyboard.Cnds.IsKeyCodeDown,C32.Plugins.Mouse.Cnds.OnClick,C32.Plugins.TiledBg.Exps.ObjectTypeName,C32.Plugins.Sprite.Cnds.PickTopBottom,C32.Plugins.Sprite.Exps.ImagePointX,C32.Plugins.Sprite.Exps.ImagePointY,C32.Plugins.Mouse.Cnds.IsButtonDown,C32.Plugins.System.Exps.max,C32.Plugins.Sprite.Exps.Width,C32.Plugins.Sprite.Exps.Height,C32.Plugins.Sprite.Acts.StartAnim,C32.Behaviors.MoveTo.Cnds.IsMoving,C32.Behaviors.MoveTo.Acts.MoveToPosition,C32.Behaviors.MoveTo.Acts.SetEnabled,C32.Plugins.System.Acts.SetGroupActive,C32.Plugins.System.Cnds.ForEach,C32.Plugins.Sprite.Acts.InstanceSignal,C32.Plugins.Sprite.Exps.AnimationName,C32.Plugins.Sprite.Acts.SetBoolInstanceVar,C32.Plugins.Sprite.Exps.AnimationSpeed,C32.Plugins.System.Acts.CreateObject,C32.Plugins.Sprite.Acts.SetWidth,C32.Plugins.Sprite.Acts.SetHeight,C32.Behaviors.Bullet.Acts.SetAngleOfMotion,C32.Behaviors.Bullet.Acts.SetSpeed,C32.Behaviors.Bullet.Exps.AngleOfMotion,C32.Plugins.Sprite.Exps.AnimationFrameCount,C32.Plugins.Sprite.Cnds.OnInstanceSignal,C32.Plugins.Sprite.Acts.SetAnimFrame,C32.Plugins.Sprite.Exps.AnimationFrame,C32.Plugins.Sprite.Cnds.OnAnyAnimFinished,C32.Plugins.Browser.Acts.Reload,C32.Plugins.Sprite.Acts.SetAnimSpeed,C32.Plugins.Mouse.Cnds.OnRelease,C32.Plugins.System.Cnds.For,C32.Plugins.Arr.Exps.Height,C32.Plugins.Arr.Cnds.CompareXY,C32.Plugins.System.Exps.loopindex,C32.Plugins.Arr.Cnds.IsEmpty,C32.Plugins.NinePatch.Acts.SetEffectEnabled,C32.Plugins.Text.Cnds.CompareText,C32.Plugins.Keyboard.Cnds.OnAnyKey,C32.Behaviors.Tween.Cnds.IsAnyPlaying,C32.Plugins.Sprite.Exps.PickedCount,C32.Plugins.Sprite.Exps.Count,C32.Plugins.Keyboard.Exps.LastKeyCode,C32.Plugins.System.Acts.SetLayerVisible,C32.Plugins.System.Acts.SetLayerInteractive,C32.Plugins.Browser.Acts.SetDocumentCSSStyle,C32.Plugins.Text.Cnds.IsVisible,C32.Plugins.NinePatch.Acts.SetOpacity,C32.Plugins.Text.Acts.SetFontColor,C32.Plugins.Text.Acts.SetHeight,C32.Plugins.System.Exps.tokencount,C32.Plugins.Text.Acts.AppendText,C32.Plugins.System.Exps.regexreplace,C32.Plugins.NinePatch.Acts.SetY,C32.Plugins.Text.Acts.SetY,C32.Plugins.Text.Exps.BBoxTop,C32.Plugins.Text.Exps.BBoxBottom,C32.Plugins.NinePatch.Acts.SetHeight,C32.Plugins.NinePatch.Acts.SetWidth,C32.Plugins.NinePatch.Exps.BBoxTop,C32.Plugins.System.Exps.replace,C32.Plugins.TiledBg.Exps.ImageScaleX,C32.Plugins.TiledBg.Acts.SetImageScaleX,C32.Plugins.System.Acts.SetTimescale,C32.Plugins.Text.Acts.SetInstanceVar,C32.Plugins.System.Exps.uppercase,C32.Plugins.Keyboard.Exps.TypedKey,C32.Plugins.Text.Exps.PlainText,C32.Plugins.TiledBg.Cnds.CompareInstanceVar,C32.Plugins.Audio.Acts.SetVolume,C32.Plugins.Audio.Exps.NormalizedVolume,C32.Plugins.TiledBg.Cnds.OnCreated,C32.Plugins.TiledBg.Exps.BBoxLeft,C32.Plugins.TiledBg.Exps.BBoxRight,C32.Plugins.System.Acts.SetObjectTimescale,C32.Behaviors.Anchor.Acts.SetEnabled,C32.Plugins.Sprite.Acts.SetPos,C32.Behaviors.MoveTo.Cnds.OnArrived,C32.Behaviors.MoveTo.Cnds.OnHitSolid,C32.Plugins.System.Cnds.PickByEvaluate,C32.Behaviors.LOS.Cnds.HasLOSToObject,C32.Behaviors.MoveTo.Acts.MoveToObject,C32.Plugins.Sprite.Acts.SetOpacity,C32.Plugins.Sprite.Cnds.OnDestroyed,C32.Plugins.Sprite.Cnds.OnCollision,C32.Behaviors.Bullet.Cnds.CompareTravelled,C32.Plugins.Arr.Cnds.ArrForEach,C32.Plugins.Arr.Cnds.CompareCurrent,C32.Plugins.Arr.Exps.CurX,C32.Plugins.System.Exps.find,C32.Plugins.System.Acts.CallMappedFunction,C32.Plugins.System.Exps.regexmatchat,C32.Plugins.Dictionary.Exps.Get,C32.Plugins.System.Exps.regexmatchcount,C32.Plugins.System.Exps.int,C32.Plugins.AdvancedRandom.Acts.SetProbabilityTable,C32.Plugins.AdvancedRandom.Acts.AddProbabilityEntry,C32.Plugins.AdvancedRandom.Exps.Weighted,C32.Plugins.AdvancedRandom.Acts.RemoveProbabilityEntry,C32.Plugins.Audio.Acts.SetListenerObject,C32.Plugins.Sprite.Acts.StopAnim,C32.Plugins.Sprite.Exps.BBoxBottom,C32.Plugins.Sprite.Exps.BBoxRight,C32.Plugins.Sprite.Exps.BBoxLeft,C32.Plugins.Sprite.Exps.BBoxTop,C32.Plugins.Keyboard.Cnds.OnKey,C32.Plugins.video.Acts.SetLooping,C32.Plugins.System.Exps.projectversion,C32.Plugins.Text.Exps.LayerName,C32.Plugins.Text.Acts.Destroy,C32.Plugins.TextBox.Acts.SetText,C32.Plugins.TextBox.Cnds.IsOnLayer,C32.Plugins.TextBox.Exps.Y,C32.Plugins.TextBox.Acts.SetFocus,C32.Plugins.Browser.Acts.Alert,C32.Plugins.System.Acts.GoToLayoutByName,C32.Plugins.System.Acts.GoToLayout,C32.Plugins.Audio.Acts.StopAll,C32.Plugins.System.Exps.wallclocktime,C32.Plugins.System.Acts.LoadLayoutTexturesByName,C32.Plugins.System.Exps.loadingprogress,C32.Plugins.Text.Acts.SetVisible,C32.Plugins.NinePatch.Acts.SetVisible,C32.Plugins.Browser.Cnds.OnUpdateFound,C32.Plugins.Browser.Cnds.OnUpdateReady,C32.Plugins.Mouse.Cnds.OnAnyClick,C32.Plugins.Browser.Cnds.IsFullscreen,C32.Plugins.Browser.Acts.RequestFullScreen,C32.Plugins.Browser.Acts.ConsoleLog,C32.Plugins.Browser.Exps.URL,C32.Plugins.AJAX.Acts.RequestFile,C32.Plugins.Arr.Acts.JSONLoad,C32.Plugins.AJAX.Exps.LastData,C32.Plugins.Dictionary.Acts.JSONLoad,C32.Plugins.AdvancedRandom.Acts.CreateProbabilityTable,C32.Plugins.System.Acts.MapFunction,C32.Plugins.AdvancedRandom.Acts.CreateProbabilityTableFromJSON,C32.Plugins.Mouse.Acts.SetCursorSprite,C32.Plugins.Text.Exps.IID,C32.Plugins.Text.Acts.SetFontSize,C32.Plugins.Text.Cnds.IsEffectEnabled,C32.Plugins.Text.Acts.SetEffectEnabled,C32.Plugins.Text.Cnds.OnCreated,C32.Plugins.Text.Exps.FaceSize]},self.C3_JsPropNameTable=[{ajax:0},{equipmentArray:0},{keyboard:0},{advancedRandom:0},{mouse:0},{browser:0},{abilitiesArray:0},{video:0},{abilityOptionsArray:0},{npcDialogArray:0},{audio:0},{gearQueueArray:0},{soundEffectVariants:0},{layoutProperties:0},{mods:0},{PlatformInfo:0},{tips:0},{nodeModsArray:0},{nodeTextArray:0},{healthCover:0},{manaOrb:0},{healthOrb:0},{originalX:0},{originalY:0},{healthStatue:0},{manaStatue:0},{manaCover:0},{orbCoverFront:0},{orbCoverBack:0},{tooltipName:0},{tooltipClass:0},{tooltipDescription:0},{tooltipLevel:0},{tooltipLore:0},{Tween:0},{tooltip:0},{tooltipValue:0},{logo:0},{Anchor:0},{versionText:0},{loadingText:0},{loadingScreen:0},{VineyardTechnologiesLogo:0},{tip:0},{chestPlaceholder:0},{feetPlaceholder:0},{handsPlaceholder:0},{headPlaceholder:0},{legsPlaceholder:0},{mainHandPlaceholder:0},{neckPlaceholder:0},{offHandPlaceholder:0},{ringPlaceholder:0},{equippedMenuStatue:0},{inventoryMenuStatue:0},{abilityBarStatue:0},{abilitySelectorStatue:0},{characterMenuStatue:0},{settingsMenuStatue:0},{merchantStore:0},{merchantMenuStatue:0},{dialogStatue:0},{settingsText:0},{tutorialText:0},{autoEquip:0},{keycode:0},{abilityNumber:0},{target:0},{keybinder:0},{settingsMenu:0},{identifier:0},{type:0},{slot:0},{tutorial:0},{originalFaceSize:0},{login:0},{signup:0},{play:0},{back:0},{resetPassword:0},{create:0},{send:0},{createNewCharacter:0},{man_ability:0},{unlockLevel:0},{abilitySlot:0},{abilityKey:0},{comparisonTooltip:0},{comparisonTooltipClass:0},{comparisonTooltipDescription:0},{comparisonTooltipLevel:0},{comparisonTooltipLore:0},{comparisonTooltipName:0},{currentlyEquipped:0},{comparisonTooltipValue:0},{enemyAttributes:0},{enemyHealthBar:0},{enemyHealthFrame:0},{enemyName:0},{dialog:0},{dialogNpcName:0},{dialogText:0},{characterName:0},{class:0},{characterMenuText:0},{maxHealth:0},{healthRegen:0},{actionSpeed:0},{attackRange:0},{pickupRange:0},{movementSpeed:0},{flinchResistance:0},{armor:0},{maxMana:0},{manaRegen:0},{physicalResistance:0},{coldResistance:0},{fireResistance:0},{lightningResistance:0},{corruptResistance:0},{arcaneResistance:0},{slashDamage:0},{smashDamage:0},{stabDamage:0},{coldDamage:0},{fireDamage:0},{lightningDamage:0},{arcaneDamage:0},{holyDamage:0},{characterMenu:0},{launcherMessage:0},{loadingBarFrame:0},{loadingBar:0},{loadingBarText:0},{splashScreen:0},{copyright:0},{coinsIcon:0},{coinsTotal:0},{passives:0},{passivesText:0},{nodeTooltipTitle:0},{nodeTooltipText:0},{pointsAvailableText:0},{pointsAllocatedText:0},{pillarOfFateMenu:0},{fader:0},{decorative:0},{yValue:0},{doNotCreateShadow:0},{man:0},{goblinArcher:0},{goblinUnderling:0},{goblinWarlock:0},{guide:0},{merchant:0},{woman:0},{man_legsDefault_gear:0},{man_headDefault_gear:0},{man_maraudersBracers_gear:0},{man_maraudersStraps_gear:0},{man_simpleGloves_gear:0},{man_leggings_gear:0},{man_simpleShirt_gear:0},{man_simpleShield_gear:0},{man_simpleSword_gear:0},{man_crudeHelmet_gear:0},{man_ornateShield_gear:0},{man_simpleHelmet_gear:0},{man_simpleMace_gear:0},{man_simplePants_gear:0},{man_strappedBoots_gear:0},{man_leatherJacket_gear:0},{pickupRangeBonus:0},{destinationX:0},{destinationY:0},{level:0},{value:0},{simpleName:0},{fullName:0},{lore:0},{classRestrictions:0},{sound:0},{maraudersBracers_loot:0},{crudeHelmet_loot:0},{ornateShield_loot:0},{simpleHelmet_loot:0},{simpleMace_loot:0},{simplePants_loot:0},{strappedBoots_loot:0},{maraudersStraps_loot:0},{simpleGloves_loot:0},{leggings_loot:0},{simpleShirt_loot:0},{simpleShield_loot:0},{simpleSword_loot:0},{leatherJacket_loot:0},{maraudersBracers_item:0},{crudeHelmet_item:0},{simpleHelmet_item:0},{simpleMace_item:0},{simplePants_item:0},{simpleShield_item:0},{strappedBoots_item:0},{maraudersStraps_item:0},{simpleGloves_item:0},{leggings_item:0},{simpleShirt_item:0},{ornateShield_item:0},{simpleSword_item:0},{leatherJacket_item:0},{boundary:0},{dirt:0},{grass:0},{degrees:0},{attributes:0},{experience:0},{currentHealth:0},{attackSpeed:0},{corruptDamage:0},{holyResistance:0},{attacking:0},{hit:0},{rerouting:0},{STRIDE_COEFFICIENT:0},{MoveTo:0},{Solid:0},{knockback:0},{LineOfSight:0},{Persist:0},{enemy:0},{coins:0},{currentMana:0},{lastX:0},{lastY:0},{relocateToX:0},{relocateToY:0},{busyCastingAbility:0},{talkingToNpc:0},{isFemale:0},{unspentPassivePoints:0},{allocatedPassivePoints:0},{BoundToLayout:0},{ScrollTo:0},{Custom:0},{player:0},{range:0},{knockbackDistance:0},{knockbackSpeed:0},{piercing:0},{enabled:0},{isMelee:0},{Bullet:0},{projectile:0},{interactRange:0},{dialogCounter:0},{totalNumberOfDialogs:0},{isMerchant:0},{storeRange:0},{npc:0},{man_shadow:0},{goblinArcher_shadow:0},{goblinUnderling_shadow:0},{goblinWarlock_shadow:0},{man_crudeHelmet_gear_shadow:0},{man_headDefault_gear_shadow:0},{man_leggings_gear_shadow:0},{man_maraudersBracers_gear_shadow:0},{man_maraudersStraps_gear_shadow:0},{man_ornateShield_gear_shadow:0},{man_simpleGloves_gear_shadow:0},{man_simpleHelmet_gear_shadow:0},{man_simpleMace_gear_shadow:0},{man_simpleShield_gear_shadow:0},{man_simpleShirt_gear_shadow:0},{man_simpleSword_gear_shadow:0},{man_strappedBoots_gear_shadow:0},{guide_shadow:0},{farmhouse_shadow:0},{farmhouseTree_shadow:0},{fenceHorizontal_shadow:0},{fencePatchedHorizontal_shadow:0},{fenceVertical_shadow:0},{cottageExterior_shadow:0},{windmillExterior_shadow:0},{windmillFan_shadow:0},{cart_shadow:0},{fenceRight_shadow:0},{fencePatchedLeft_shadow:0},{fenceLeft_shadow:0},{fencePatchedRight_shadow:0},{man_legsDefault_gear_shadow:0},{man_simplePants_gear_shadow:0},{arrow_shadow:0},{lightningOrb_shadow:0},{longhouse_shadow:0},{table_shadow:0},{woodenChest_shadow:0},{merchant_shadow:0},{man_leatherJacket_gear_shadow:0},{woman_shadow:0},{guide_portrait:0},{merchant_portrait:0},{fenceHorizontal:0},{fencePatchedHorizontal:0},{farmhouse:0},{farmhouseTree:0},{fenceVertical:0},{layout:0},{leftbbox:0},{rightbbox:0},{topbbox:0},{bottombbox:0},{cottageDoor:0},{cottageExterior:0},{cottageInterior:0},{cottageProps:0},{windmillDoor:0},{windmillExterior:0},{windmillFan:0},{windmillFloorLevel:0},{windmillInterior:0},{windmillLowerStairs:0},{windmillUpperStairs:0},{cart:0},{fencePatchedLeft:0},{fenceRight:0},{fenceLeft:0},{fencePatchedRight:0},{longhouse:0},{table:0},{woodenChest:0},{cursor:0},{lightningOrb:0},{arrow:0},{lootName:0},{lootNameBackground:0},{property:0},{volumeSlider:0},{input:0},{displayText:0},{message:0},{pillarOfFate:0},{pillarOfFate_shadow:0},{pillarOfFateStatue:0},{pillarOfFateClose:0},{selectMan:0},{selectWoman:0},{gear:0},{mainHand:0},{offHand:0},{loot:0},{chest:0},{DragDrop:0},{item:0},{invalidLocation:0},{legs:0},{head:0},{hands:0},{enemyBody:0},{body:0},{feet:0},{sortable:0},{prop:0},{background:0},{placeholder:0},{queriedArray:0},{shadow:0},{hasShadow:0},{npcBody:0},{portrait:0},{statue:0},{tooltipText:0},{orb:0},{ability:0},{"9PatchInvalidLocations":0},{textButtons:0},{comparisonTooltipText:0},{door:0},{anchorTiledBackground:0},{checkbox:0},{lootChest:0},{WINDMILL_FAN_ROTATION_SPEED:0},{WINDMILL_FAN_NAME:0},{ALL_PARAMETERS:0},{ARC:0},{AUDIO_FADE_TIME:0},{CAMERA_ANGLE:0},{DEFAULT_STEREO_PAN:0},{DOUBLE_OFFSET:0},{EMPTY:0},{END_OF_TICK:0},{FALSE:0},{FIRST_FRAME:0},{FIRST_INSTANCE:0},{HALF_CIRCLE:0},{IDENTIFIER_INCREMENTER:0},{INFINITE_REPEAT_COUNT:0},{INTENSITY_PARAMETER_INDEX:0},{INTERACT_COOLDOWN:0},{ISOMETRIC_DIVIDER:0},{LAYOUT_FADE_TIME:0},{LOOP_OFFSET:0},{LOOP_DEFAULT:0},{MENU_FADE_TIME:0},{NEGATIVE_HALF_CRICLE:0},{NON_DEFAULT_IMAGE_POINT:0},{NON_DIRECTIONAL_INNER_ANGLE:0},{NON_DIRECTIONAL_OUTER_ANGLE:0},{NON_DIRECTIONAL_OUTER_GAIN:0},{OBJECT_ORIGIN:0},{ORIGINAL_SCALE:0},{PAUSED:0},{PERCENTAGE_DIVIDER:0},{QUARTER_CIRCLE:0},{SILENT:0},{SOLID_OPACITY:0},{THRESHOLD:0},{TRANSPARENT_OPACITY:0},{TRUE:0},{TWEEN_REPEAT_COUNT:0},{TWEEN_TEXT_OPACITY:0},{TWEEN_TEXT_SPEED:0},{UNPAUSED_TIME_SCALE:0},{USE_ORIGINAL_SPEED:0},{ATTACK_KEYWORD:0},{BLACK_OUTLINE_BBCODE:0},{BLANK:0},{BLOCK_KEYWORD:0},{BRIGHTNESS_EFFECT_NAME:0},{CHECKED_KEYWORD:0},{DESCRIPTION_KEYWORD:0},{DIE_KEYWORD:0},{EITHER_CURLY_BRACKET_REGEX:0},{ELLIPSIS:0},{MODS_KEYWORD:0},{FOLDER_SEPARATOR:0},{FOOTSTEP_KEYWORD:0},{FULL_NAME_KEYWORD:0},{GLOBAL_FLAG:0},{GLOWHORIZONTAL_EFFECT_NAME:0},{GLOWVERTICAL_EFFECT_NAME:0},{HIT_KEYWORD:0},{IDLE_KEYWORD:0},{ITEM_KEYWORD:0},{LEVEL_KEYWORD:0},{LOOT_KEYWORD:0},{MAIN_HAND_KEYWORD:0},{MENU_CLOSE_KEYWORD:0},{MENU_OPEN_KEYWORD:0},{MOD_NAME_SEPARATOR:0},{MOD_SEPARATOR:0},{MOD_VALUES_PROBABILITY_TABLE:0},{NONE_KEYWORD:0},{NOT_USED:0},{OPACITY_FADE_OUT_KEYWORD:0},{UNCHECKED_KEYWORD:0},{SEPARATOR:0},{SIMPLE_NAME_KEYWORD:0},{SPACE:0},{SWING_WEAPON_SOUND_EFFECT_NAME:0},{WALK_KEYWORD:0},{dialogVolume:0},{soundEffectsVolume:0},{musicVolume:0},{nextAvailableIdentifier:0},{uidOfClicked:0},{isOnInteractCooldown:0},{PORTRAIT_KEYWORD:0},{MESSAGE_COLUMN_HEADER:0},{PORTRAIT_POSITION:0},{NUMBER_OF_ITEMS:0},{DIALOG_COUNTER_INCREMENTER:0},{VIEWPORT_OFFSET:0},{INITIAL_DIALOG_COUNTER_VALUE:0},{allowEquipmentInteraction:0},{swapIdentifier:0},{swapSlotUid:0},{draggedOriginSlotUid:0},{draggedItemUid:0},{droppedOnSlotUid:0},{SOUND_KEYWORD:0},{CLASS_RESTRICTIONS_KEYWORD:0},{VALUE_KEYWORD:0},{LORE_KEYWORD:0},{TYPE_KEYWORD:0},{PUSHOUT_DISTANCE:0},{OBTAINED_ITEM_KEYWORD:0},{TRAVEL_TIME:0},{ASCENSION_TWEEN_TAG:0},{TRAVEL_TIME_DIVIDER:0},{LOOTNAME_LAYER:0},{GLOW_INTENSITY:0},{LOOTNAME_PADDING:0},{theAngle:0},{LOOT_ALTITUDE:0},{LOOT_DISTANCE:0},{INITIAL_SCALE:0},{x:0},{y:0},{STATIC_KEYWORD:0},{FIRST_ANIMATION_INDEX:0},{LAST_ANIMATION_INDEX:0},{OVERLAY_LAYER_NAME:0},{ITEM_OPACITY:0},{active:0},{allowGearManagement:0},{GEAR_KEYWORD:0},{EQUIP_KEYWORD:0},{CHEST_KEYWORD:0},{LEGS_KEYWORD:0},{HEAD_KEYWORD:0},{DEFAULT_KEYWORD:0},{UNEQUIP_KEYWORD:0},{MAX_ANGLE:0},{EXPERIENCE_THRESHOLD_MULTIPLIER:0},{LEVEL_INCREMENTER:0},{PASSIVE_SKILL_POINT_AMOUNT:0},{OFFSET:0},{REGEN_SPEED:0},{STOP_MOVING_KEYWORD:0},{LEFT_FOOTSTEP_FRAME:0},{RIGHT_FOOTSTEP_FRAME:0},{uid:0},{locationX:0},{locationY:0},{UID_OF_CLICKED_RESET_TIMER:0},{MOVEMENT_AND_INTERACTION_GROUP_NAME:0},{ABILITIES_GROUP_NAME:0},{FACINGS_GROUP_NAME:0},{DOWNWARD_SLASH_ANIMATION_NAME:0},{UPWARD_SLASH_ANIMATION_NAME:0},{KICK_ANIMATION_NAME:0},{PROJECTILE_SPEED:0},{MANIFESTATION_FRAME:0},{SIZE:0},{RANGE:0},{waitPeriod:0},{targetX:0},{targetY:0},{MANA_COST:0},{SOUND_EFFECT:0},{DAMAGE_MULTIPLIER:0},{KNOCKBACK_SPEED:0},{KNOCKBACK_DISTANCE:0},{animationName:0},{animationSpeed:0},{playFromBeginning:0},{ALL_CLASSES_KEYWORD:0},{abilityUID:0},{currentAbility:0},{selectedAbility:0},{currentCategory:0},{CATEGORY_KEYWORD:0},{GRAYSCALE_EFFECT_NAME:0},{on:0},{PER_SECOND_TEXT:0},{menuName:0},{text:0},{row:0},{column:0},{depth:0},{CLASS_KEYWORD:0},{typeForComparison:0},{TOOLTIP_VERTICAL_PADDING:0},{TOOLTIP_HORIZONTAL_PADDING:0},{TOOLTIP_VERTICAL_TEXT_PADDING:0},{COINS_TEXT:0},{GREEN:0},{RED:0},{LEVEL_TEXT:0},{MOD_NAME_INDEX:0},{DEFAULT_FONT_COLOR:0},{HIDDEN_HEIGHT:0},{TOOLTIP_VALUE_HEIGHT:0},{TOOLTIP_LORE_HEIGHT:0},{isAbility:0},{name:0},{NEWLINE_SEQUENCE:0},{ATTRIBUTE_SEPARATOR:0},{healthBarScale:0},{NO_KEYCODE:0},{SPACEBAR:0},{SLIDER_MIN:0},{SLIDER_MAX:0},{VOLUME_BASE:0},{actualMusicVolume:0},{imageScaleX:0},{MUSIC_INITIAL_VOLUME:0},{SOUND_EFFECTS_INITIAL_VOLUME:0},{DIALOG_VOLUME_INITIAL_VOLUME:0},{STATUE_DRAG_OPACITY:0},{GOING_BACKWARD_AGAIN:0},{GOING_BACKWARD:0},{GOING_LEFT:0},{GOING_RIGHT:0},{NOT_REROUTING:0},{theDistance:0},{DISTANCE_MULTIPLIER:0},{ENEMY_DEATH_FADE_OUT_TIME:0},{MANIFESTATION_POINT:0},{projectileManifestationTime:0},{SHADOW_KEYWORD:0},{SHADOW_OFFSET:0},{SHADOW_OPACITY_COLUMN_NAME:0},{BLURHORIZONTAL_EFFECT_NAME:0},{BLURVERTICAL_EFFECT_NAME:0},{INTENSITY_VALUE:0},{UNFLINCHING_ATTRIBUTE:0},{playerHealthBeforeImpact:0},{SIMPLE_NAME_COLUMN_NUMBER:0},{targetColumnNumber:0},{array:0},{targetColumn:0},{columnName:0},{NOT_FOUND:0},{findText:0},{result:0},{DIMINISHER_STRENGTH:0},{points:0},{BASE_PROBABILITY:0},{INVERTER:0},{incomingDamage:0},{resistancePoints:0},{mod:0},{DESCRIPTION_INDEX:0},{NAME_INDEX:0},{modDescription:0},{ModName:0},{INDEX:0},{CURLY_BRACKET_REGEX:0},{index:0},{rolledMods:0},{MIN_MODS:0},{MAX_MODS:0},{chosenMod:0},{SQUARE_BRACKET_REGEX:0},{modValue:0},{EITHER_SQUARE_BRACKET_REGEX:0},{FIRST_BRACKETS_INDEX:0},{LEFT_MOD_BRACKET:0},{MOD_VALUE_SEPARATOR:0},{RIGHT_MOD_BRACKET:0},{upperLimit:0},{lowerLimit:0},{LOWER_LIMIT_INDEX:0},{UPPER_LIMIT_INDEX:0},{TEXT_VALUE_PARSER:0},{RARITY_DIMINISHER:0},{ANY_WEIGHT:0},{MINIMUM_HEALTH:0},{SLASH_INDEX:0},{STAB_INDEX:0},{slashValue:0},{stabValue:0},{damageType:0},{amount:0},{SLASH_KEYWORD:0},{STAB_KEYWORD:0},{SMASH_KEYWORD:0},{AMOUNT_INDEX:0},{DAMAGE_TYPE_INDEX:0},{CANT_CARRY_KEYWORD:0},{CANT_PURCHASE_KEYWORD:0},{DONT_MEET_REQUIREMENTS_KEYWORD:0},{NOT_ENOUGH_COINS_KEYWORD:0},{soundEffectName:0},{DROP_KEYWORD:0},{INITIAL_VALUE:0},{FIRST_LAYOUT:0},{layerToTurnOff:0},{layerToTurnOn:0},{targetLayout:0},{skipLoadingScreen:0},{MINIMUM_LOADING_SCREEN_TIME:0},{minimumLoadingScreenExpiryTime:0},{FINISHED_LOADING_PROGRESS_VALUE:0},{LAYOUT_AFTER_SPLASH_SCREEN:0},{UPDATE_AVAILABLE_TEXT:0},{dataInitialized:0},{updateAvailable:0},{DAGGERQUEST_WEBSITE_URL:0},{DROP_TABLE_COLUMN_NAME:0},{selectedCharacterSlot:0},{MOUSE_ON_KEYWORD:0},{MOUSE_OFF_KEYWORD:0},{SIZE_REDUCTION_MULTIPLIER:0}],self.InstanceType={ajax:class extends self.IInstance{},equipmentArray:class extends self.IArrayInstance{},keyboard:class extends self.IInstance{},advancedRandom:class extends self.IInstance{},mouse:class extends self.IInstance{},browser:class extends self.IInstance{},abilitiesArray:class extends self.IArrayInstance{},video:class extends self.IWorldInstance{},abilityOptionsArray:class extends self.IArrayInstance{},npcDialogArray:class extends self.IArrayInstance{},audio:class extends self.IInstance{},gearQueueArray:class extends self.IArrayInstance{},soundEffectVariants:class extends self.IDictionaryInstance{},layoutProperties:class extends self.IArrayInstance{},mods:class extends self.IDictionaryInstance{},PlatformInfo:class extends self.IInstance{},tips:class extends self.IArrayInstance{},nodeModsArray:class extends self.IArrayInstance{},nodeTextArray:class extends self.IArrayInstance{},healthCover:class extends self.ISpriteInstance{},manaOrb:class extends self.ITiledBackgroundInstance{},healthOrb:class extends self.ITiledBackgroundInstance{},healthStatue:class extends self.ISpriteInstance{},manaStatue:class extends self.ISpriteInstance{},manaCover:class extends self.ISpriteInstance{},orbCoverFront:class extends self.ISpriteInstance{},orbCoverBack:class extends self.ISpriteInstance{},tooltipName:class extends self.ITextInstance{},tooltipClass:class extends self.ITextInstance{},tooltipDescription:class extends self.ITextInstance{},tooltipLevel:class extends self.ITextInstance{},tooltipLore:class extends self.ITextInstance{},tooltip:class extends self.IWorldInstance{},tooltipValue:class extends self.ITextInstance{},logo:class extends self.ITiledBackgroundInstance{},versionText:class extends self.ITextInstance{},loadingText:class extends self.ITextInstance{},loadingScreen:class extends self.ITiledBackgroundInstance{},VineyardTechnologiesLogo:class extends self.ISpriteInstance{},tip:class extends self.ITextInstance{},chestPlaceholder:class extends self.ISpriteInstance{},feetPlaceholder:class extends self.ISpriteInstance{},handsPlaceholder:class extends self.ISpriteInstance{},headPlaceholder:class extends self.ISpriteInstance{},legsPlaceholder:class extends self.ISpriteInstance{},mainHandPlaceholder:class extends self.ISpriteInstance{},neckPlaceholder:class extends self.ISpriteInstance{},offHandPlaceholder:class extends self.ISpriteInstance{},ringPlaceholder:class extends self.ISpriteInstance{},equippedMenuStatue:class extends self.ISpriteInstance{},inventoryMenuStatue:class extends self.ISpriteInstance{},abilityBarStatue:class extends self.ISpriteInstance{},abilitySelectorStatue:class extends self.ISpriteInstance{},characterMenuStatue:class extends self.ISpriteInstance{},settingsMenuStatue:class extends self.ISpriteInstance{},merchantMenuStatue:class extends self.ISpriteInstance{},dialogStatue:class extends self.ISpriteInstance{},settingsText:class extends self.ITextInstance{},tutorialText:class extends self.ITextInstance{},autoEquip:class extends self.ISpriteInstance{},keybinder:class extends self.ITextInstance{},settingsMenu:class extends self.IWorldInstance{},slot:class extends self.IWorldInstance{},tutorial:class extends self.IWorldInstance{},login:class extends self.ITextInstance{},signup:class extends self.ITextInstance{},play:class extends self.ITextInstance{},back:class extends self.ITextInstance{},resetPassword:class extends self.ITextInstance{},create:class extends self.ITextInstance{},send:class extends self.ITextInstance{},createNewCharacter:class extends self.ITextInstance{},man_ability:class extends self.ISpriteInstance{},abilitySlot:class extends self.IWorldInstance{},abilityKey:class extends self.ITextInstance{},comparisonTooltip:class extends self.IWorldInstance{},comparisonTooltipClass:class extends self.ITextInstance{},comparisonTooltipDescription:class extends self.ITextInstance{},comparisonTooltipLevel:class extends self.ITextInstance{},comparisonTooltipLore:class extends self.ITextInstance{},comparisonTooltipName:class extends self.ITextInstance{},currentlyEquipped:class extends self.ITextInstance{},comparisonTooltipValue:class extends self.ITextInstance{},enemyAttributes:class extends self.ITextInstance{},enemyHealthBar:class extends self.ITiledBackgroundInstance{},enemyHealthFrame:class extends self.IWorldInstance{},enemyName:class extends self.ITextInstance{},dialog:class extends self.IWorldInstance{},dialogNpcName:class extends self.ITextInstance{},dialogText:class extends self.ITextInstance{},characterName:class extends self.ITextInstance{},class:class extends self.ITextInstance{},characterMenuText:class extends self.ITextInstance{},maxHealth:class extends self.ITextInstance{},healthRegen:class extends self.ITextInstance{},actionSpeed:class extends self.ITextInstance{},attackRange:class extends self.ITextInstance{},pickupRange:class extends self.ITextInstance{},movementSpeed:class extends self.ITextInstance{},flinchResistance:class extends self.ITextInstance{},armor:class extends self.ITextInstance{},maxMana:class extends self.ITextInstance{},manaRegen:class extends self.ITextInstance{},physicalResistance:class extends self.ITextInstance{},coldResistance:class extends self.ITextInstance{},fireResistance:class extends self.ITextInstance{},lightningResistance:class extends self.ITextInstance{},corruptResistance:class extends self.ITextInstance{},arcaneResistance:class extends self.ITextInstance{},slashDamage:class extends self.ITextInstance{},smashDamage:class extends self.ITextInstance{},stabDamage:class extends self.ITextInstance{},coldDamage:class extends self.ITextInstance{},fireDamage:class extends self.ITextInstance{},lightningDamage:class extends self.ITextInstance{},arcaneDamage:class extends self.ITextInstance{},holyDamage:class extends self.ITextInstance{},characterMenu:class extends self.IWorldInstance{},launcherMessage:class extends self.ITextInstance{},loadingBarFrame:class extends self.IWorldInstance{},loadingBar:class extends self.ITiledBackgroundInstance{},loadingBarText:class extends self.ITextInstance{},splashScreen:class extends self.ITiledBackgroundInstance{},copyright:class extends self.ITextInstance{},coinsIcon:class extends self.ISpriteInstance{},coinsTotal:class extends self.ITextInstance{},passives:class extends self.IWorldInstance{},passivesText:class extends self.ITextInstance{},nodeTooltipTitle:class extends self.ITextInstance{},nodeTooltipText:class extends self.ITextInstance{},pointsAvailableText:class extends self.ITextInstance{},pointsAllocatedText:class extends self.ITextInstance{},pillarOfFateMenu:class extends self.IWorldInstance{},fader:class extends self.ITiledBackgroundInstance{},decorative:class extends self.IWorldInstance{},man:class extends self.ISpriteInstance{},goblinArcher:class extends self.ISpriteInstance{},goblinUnderling:class extends self.ISpriteInstance{},goblinWarlock:class extends self.ISpriteInstance{},guide:class extends self.ISpriteInstance{},merchant:class extends self.ISpriteInstance{},woman:class extends self.ISpriteInstance{},man_legsDefault_gear:class extends self.ISpriteInstance{},man_headDefault_gear:class extends self.ISpriteInstance{},man_maraudersBracers_gear:class extends self.ISpriteInstance{},man_maraudersStraps_gear:class extends self.ISpriteInstance{},man_simpleGloves_gear:class extends self.ISpriteInstance{},man_leggings_gear:class extends self.ISpriteInstance{},man_simpleShirt_gear:class extends self.ISpriteInstance{},man_simpleShield_gear:class extends self.ISpriteInstance{},man_simpleSword_gear:class extends self.ISpriteInstance{},man_crudeHelmet_gear:class extends self.ISpriteInstance{},man_ornateShield_gear:class extends self.ISpriteInstance{},man_simpleHelmet_gear:class extends self.ISpriteInstance{},man_simpleMace_gear:class extends self.ISpriteInstance{},man_simplePants_gear:class extends self.ISpriteInstance{},man_strappedBoots_gear:class extends self.ISpriteInstance{},man_leatherJacket_gear:class extends self.ISpriteInstance{},maraudersBracers_loot:class extends self.ISpriteInstance{},crudeHelmet_loot:class extends self.ISpriteInstance{},ornateShield_loot:class extends self.ISpriteInstance{},simpleHelmet_loot:class extends self.ISpriteInstance{},simpleMace_loot:class extends self.ISpriteInstance{},simplePants_loot:class extends self.ISpriteInstance{},strappedBoots_loot:class extends self.ISpriteInstance{},maraudersStraps_loot:class extends self.ISpriteInstance{},simpleGloves_loot:class extends self.ISpriteInstance{},leggings_loot:class extends self.ISpriteInstance{},simpleShirt_loot:class extends self.ISpriteInstance{},simpleShield_loot:class extends self.ISpriteInstance{},simpleSword_loot:class extends self.ISpriteInstance{},leatherJacket_loot:class extends self.ISpriteInstance{},maraudersBracers_item:class extends self.ISpriteInstance{},crudeHelmet_item:class extends self.ISpriteInstance{},simpleHelmet_item:class extends self.ISpriteInstance{},simpleMace_item:class extends self.ISpriteInstance{},simplePants_item:class extends self.ISpriteInstance{},simpleShield_item:class extends self.ISpriteInstance{},strappedBoots_item:class extends self.ISpriteInstance{},maraudersStraps_item:class extends self.ISpriteInstance{},simpleGloves_item:class extends self.ISpriteInstance{},leggings_item:class extends self.ISpriteInstance{},simpleShirt_item:class extends self.ISpriteInstance{},ornateShield_item:class extends self.ISpriteInstance{},simpleSword_item:class extends self.ISpriteInstance{},leatherJacket_item:class extends self.ISpriteInstance{},boundary:class extends self.ISpriteInstance{},dirt:class extends self.ITiledBackgroundInstance{},grass:class extends self.ITiledBackgroundInstance{},enemy:class extends self.ISpriteInstance{},player:class extends self.ISpriteInstance{},projectile:class extends self.ISpriteInstance{},npc:class extends self.ISpriteInstance{},man_shadow:class extends self.ISpriteInstance{},goblinArcher_shadow:class extends self.ISpriteInstance{},goblinUnderling_shadow:class extends self.ISpriteInstance{},goblinWarlock_shadow:class extends self.ISpriteInstance{},man_crudeHelmet_gear_shadow:class extends self.ISpriteInstance{},man_headDefault_gear_shadow:class extends self.ISpriteInstance{},man_leggings_gear_shadow:class extends self.ISpriteInstance{},man_maraudersBracers_gear_shadow:class extends self.ISpriteInstance{},man_maraudersStraps_gear_shadow:class extends self.ISpriteInstance{},man_ornateShield_gear_shadow:class extends self.ISpriteInstance{},man_simpleGloves_gear_shadow:class extends self.ISpriteInstance{},man_simpleHelmet_gear_shadow:class extends self.ISpriteInstance{},man_simpleMace_gear_shadow:class extends self.ISpriteInstance{},man_simpleShield_gear_shadow:class extends self.ISpriteInstance{},man_simpleShirt_gear_shadow:class extends self.ISpriteInstance{},man_simpleSword_gear_shadow:class extends self.ISpriteInstance{},man_strappedBoots_gear_shadow:class extends self.ISpriteInstance{},guide_shadow:class extends self.ISpriteInstance{},farmhouse_shadow:class extends self.ISpriteInstance{},farmhouseTree_shadow:class extends self.ISpriteInstance{},fenceHorizontal_shadow:class extends self.ISpriteInstance{},fencePatchedHorizontal_shadow:class extends self.ISpriteInstance{},fenceVertical_shadow:class extends self.ISpriteInstance{},cottageExterior_shadow:class extends self.ISpriteInstance{},windmillExterior_shadow:class extends self.ISpriteInstance{},windmillFan_shadow:class extends self.ISpriteInstance{},cart_shadow:class extends self.ISpriteInstance{},fenceRight_shadow:class extends self.ISpriteInstance{},fencePatchedLeft_shadow:class extends self.ISpriteInstance{},fenceLeft_shadow:class extends self.ISpriteInstance{},fencePatchedRight_shadow:class extends self.ISpriteInstance{},man_legsDefault_gear_shadow:class extends self.ISpriteInstance{},man_simplePants_gear_shadow:class extends self.ISpriteInstance{},arrow_shadow:class extends self.ISpriteInstance{},lightningOrb_shadow:class extends self.ISpriteInstance{},longhouse_shadow:class extends self.ISpriteInstance{},table_shadow:class extends self.ISpriteInstance{},woodenChest_shadow:class extends self.ISpriteInstance{},merchant_shadow:class extends self.ISpriteInstance{},man_leatherJacket_gear_shadow:class extends self.ISpriteInstance{},woman_shadow:class extends self.ISpriteInstance{},guide_portrait:class extends self.ISpriteInstance{},merchant_portrait:class extends self.ISpriteInstance{},fenceHorizontal:class extends self.ISpriteInstance{},fencePatchedHorizontal:class extends self.ISpriteInstance{},farmhouse:class extends self.ISpriteInstance{},farmhouseTree:class extends self.ISpriteInstance{},fenceVertical:class extends self.ISpriteInstance{},cottageDoor:class extends self.ISpriteInstance{},cottageExterior:class extends self.ISpriteInstance{},cottageInterior:class extends self.ISpriteInstance{},cottageProps:class extends self.ISpriteInstance{},windmillDoor:class extends self.ISpriteInstance{},windmillExterior:class extends self.ISpriteInstance{},windmillFan:class extends self.ISpriteInstance{},windmillFloorLevel:class extends self.ISpriteInstance{},windmillInterior:class extends self.ISpriteInstance{},windmillLowerStairs:class extends self.ISpriteInstance{},windmillUpperStairs:class extends self.ISpriteInstance{},cart:class extends self.ISpriteInstance{},fencePatchedLeft:class extends self.ISpriteInstance{},fenceRight:class extends self.ISpriteInstance{},fenceLeft:class extends self.ISpriteInstance{},fencePatchedRight:class extends self.ISpriteInstance{},longhouse:class extends self.ISpriteInstance{},table:class extends self.ISpriteInstance{},woodenChest:class extends self.ISpriteInstance{},cursor:class extends self.ISpriteInstance{},lightningOrb:class extends self.ISpriteInstance{},arrow:class extends self.ISpriteInstance{},lootName:class extends self.ITextInstance{},lootNameBackground:class extends self.ISpriteInstance{},volumeSlider:class extends self.ITiledBackgroundInstance{},input:class extends self.ITextInputInstance{},displayText:class extends self.ITextInstance{},message:class extends self.ITextInstance{},pillarOfFate:class extends self.ISpriteInstance{},pillarOfFate_shadow:class extends self.ISpriteInstance{},pillarOfFateStatue:class extends self.ISpriteInstance{},pillarOfFateClose:class extends self.ISpriteInstance{},selectMan:class extends self.ISpriteInstance{},selectWoman:class extends self.ISpriteInstance{},gear:class extends self.ISpriteInstance{},mainHand:class extends self.ISpriteInstance{},offHand:class extends self.ISpriteInstance{},loot:class extends self.ISpriteInstance{},chest:class extends self.ISpriteInstance{},item:class extends self.ISpriteInstance{},invalidLocation:class extends self.ISpriteInstance{},legs:class extends self.ISpriteInstance{},head:class extends self.ISpriteInstance{},hands:class extends self.ISpriteInstance{},enemyBody:class extends self.ISpriteInstance{},body:class extends self.ISpriteInstance{},feet:class extends self.ISpriteInstance{},sortable:class extends self.ISpriteInstance{},prop:class extends self.ISpriteInstance{},background:class extends self.ITiledBackgroundInstance{},placeholder:class extends self.ISpriteInstance{},queriedArray:class extends self.IArrayInstance{},shadow:class extends self.ISpriteInstance{},hasShadow:class extends self.ISpriteInstance{},npcBody:class extends self.ISpriteInstance{},portrait:class extends self.ISpriteInstance{},statue:class extends self.ISpriteInstance{},tooltipText:class extends self.ITextInstance{},orb:class extends self.ITiledBackgroundInstance{},ability:class extends self.ISpriteInstance{},_9PatchInvalidLocations:class extends self.IWorldInstance{},textButtons:class extends self.ITextInstance{},comparisonTooltipText:class extends self.ITextInstance{},door:class extends self.ISpriteInstance{},anchorTiledBackground:class extends self.ITiledBackgroundInstance{},checkbox:class extends self.ISpriteInstance{},lootChest:class extends self.ISpriteInstance{}};var t="179",e={LEFT:0,MIDDLE:1,RIGHT:2,ROTATE:0,DOLLY:1,PAN:2},s2=0,r2=1,n=2,o2=0,h=1,c2=3,u=0,d2=1,p=2,m=0,y=1,g=2,f2=3,x=4,b=5,v=100,w=101,M=102,S=103,_=104,A=200,T=201,z=202,C=203,I=204,B=205,k=206,E=207,R=208,P=209,O=210,j=0,W=1,D=2,U=3,H=4,q=5,J=6,X=7,Y=0,Z=1,G=2,$=0,Q=1,K=2,tt=3,et=4,st=6,rt=7,nt="attached",at="detached",ot=300,ht=301,lt=302,ct=303,ut=304,dt=306,pt=1e3,mt=1001,yt=1002,gt=1003,ft=1004,bt=1005,wt=1006,Mt=1007,_t=1008,At=1008,Tt=1009,zt=1010,Ct=1011,It=1012,Bt=1013,kt=1014,Et=1015,Rt=1016,Pt=1017,Ot=1018,Nt=1020,Vt=35902,Ft=1021,Lt=1022,jt=1023,Wt=1026,Dt=1027,Ut=1028,Ht=1029,qt=1030,Jt=1031,Xt=1032,Yt=1033,Zt=33776,Gt=33777,$t=33778,Qt=33779,Kt=35840,te=35841,ee=35842,ie=35843,se=36196,re=37492,ne=37496,ae=37808,oe=37809,he=37810,le=37811,ce=37812,ue=37813,de=37814,pe=37815,me=37816,ye=37817,ge=37818,fe=37819,xe=37820,be=37821,ve=36492,Se=36283,_e=36284,Ae=36285,Te=36286,Be=2300,ke=2301,Ee=2302,Re=2400,Pe=2401,Oe=2402,Fe=0,Le=1,je=2,qe=0,Je=1,Xe="",Ye="srgb",Ze="srgb-linear",Ge="linear",$e="srgb",Qe=0,Ke=7680,ti=7681,ei=7682,ii=7683,si=34055,ri=34056,ni=5386,ai=512,oi=513,hi=514,li=515,ci=516,ui=517,di=518,pi=519,mi=512,yi=513,gi=514,fi=515,xi=516,bi=517,vi=518,wi=519,Mi=35044,Si=35048,Ri=2e3,Pi=2001,Fi=class{addEventListener(e,t){void 0===this._listeners&&(this._listeners={});const s=this._listeners;void 0===s[e]&&(s[e]=[]),-1===s[e].indexOf(t)&&s[e].push(t)}hasEventListener(e,t){const s=this._listeners;return void 0!==s&&void 0!==s[e]&&-1!==s[e].indexOf(t)}removeEventListener(e,t){const s=this._listeners;if(void 0===s)return;const i=s[e];if(void 0!==i){const e=i.indexOf(t);-1!==e&&i.splice(e,1)}}dispatchEvent(e){const t=this._listeners;if(void 0===t)return;const s=t[e.type];if(void 0!==s){e.target=this;const t=s.slice(0);for(let s=0,i=t.length;s<i;s++)t[s].call(this,e);e.target=null}}},Li=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"],ji=1234567,Wi=Math.PI/180,Di=180/Math.PI;function Ui(){const e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,s=4294967295*Math.random()|0,i=4294967295*Math.random()|0;return(Li[255&e]+Li[e>>8&255]+Li[e>>16&255]+Li[e>>24&255]+"-"+Li[255&t]+Li[t>>8&255]+"-"+Li[t>>16&15|64]+Li[t>>24&255]+"-"+Li[63&s|128]+Li[s>>8&255]+"-"+Li[s>>16&255]+Li[s>>24&255]+Li[255&i]+Li[i>>8&255]+Li[i>>16&255]+Li[i>>24&255]).toLowerCase()}function Hi(e,t,s){return Math.max(t,Math.min(s,e))}function qi(e,t){return(e%t+t)%t}function Ji(e,t,s){return(1-s)*e+s*t}function Xi(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return e/4294967295;case Uint16Array:return e/65535;case Uint8Array:return e/255;case Int32Array:return Math.max(e/2147483647,-1);case Int16Array:return Math.max(e/32767,-1);case Int8Array:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}function Yi(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return Math.round(4294967295*e);case Uint16Array:return Math.round(65535*e);case Uint8Array:return Math.round(255*e);case Int32Array:return Math.round(2147483647*e);case Int16Array:return Math.round(32767*e);case Int8Array:return Math.round(127*e);default:throw new Error("Invalid component type.")}}var Zi={DEG2RAD:Wi,RAD2DEG:Di,generateUUID:Ui,clamp:Hi,euclideanModulo:qi,mapLinear:function(e,t,s,i,r){return i+(e-t)*(r-i)/(s-t)},inverseLerp:function(e,t,s){return e!==t?(s-e)/(t-e):0},lerp:Ji,damp:function(e,t,s,i){return Ji(e,t,1-Math.exp(-s*i))},pingpong:function(e,t=1){return t-Math.abs(qi(e,2*t)-t)},smoothstep:function(e,t,s){return e<=t?0:e>=s?1:(e=(e-t)/(s-t))*e*(3-2*e)},smootherstep:function(e,t,s){return e<=t?0:e>=s?1:(e=(e-t)/(s-t))*e*e*(e*(6*e-15)+10)},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},seededRandom:function(e){void 0!==e&&(ji=e);let t=ji+=1831565813;return t=Math.imul(t^t>>>15,1|t),t^=t+Math.imul(t^t>>>7,61|t),((t^t>>>14)>>>0)/4294967296},degToRad:function(e){return e*Wi},radToDeg:function(e){return e*Di},isPowerOfTwo:function(e){return!(e&e-1)&&0!==e},ceilPowerOfTwo:function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))},floorPowerOfTwo:function(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))},setQuaternionFromProperEuler:function(e,t,s,i,r){const n=Math.cos,a=Math.sin,o=n(s/2),l=a(s/2),h=n((t+i)/2),u=a((t+i)/2),c=n((t-i)/2),d=a((t-i)/2),p=n((i-t)/2),_=a((i-t)/2);switch(r){case"XYX":e.set(o*u,l*c,l*d,o*h);break;case"YZY":e.set(l*d,o*u,l*c,o*h);break;case"ZXZ":e.set(l*c,l*d,o*u,o*h);break;case"XZX":e.set(o*u,l*_,l*p,o*h);break;case"YXY":e.set(l*p,o*u,l*_,o*h);break;case"ZYZ":e.set(l*_,l*p,o*u,o*h);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+r)}},normalize:Yi,denormalize:Xi},Gi=class e{constructor(t=0,s=0){e.prototype.isVector2=!0,this.x=t,this.y=s}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const t=this.x,s=this.y,i=e.elements;return this.x=i[0]*t+i[3]*s+i[6],this.y=i[1]*t+i[4]*s+i[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=Hi(this.x,e.x,t.x),this.y=Hi(this.y,e.y,t.y),this}clampScalar(e,t){return this.x=Hi(this.x,e,t),this.y=Hi(this.y,e,t),this}clampLength(e,t){const s=this.length();return this.divideScalar(s||1).multiplyScalar(Hi(s,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const s=this.dot(e)/t;return Math.acos(Hi(s,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,s=this.y-e.y;return t*t+s*s}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,s){return this.x=e.x+(t.x-e.x)*s,this.y=e.y+(t.y-e.y)*s,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this}rotateAround(e,t){const s=Math.cos(t),i=Math.sin(t),r=this.x-e.x,n=this.y-e.y;return this.x=r*s-n*i+e.x,this.y=r*i+n*s+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}},$i=class{constructor(e=0,t=0,s=0,i=1){this.isQuaternion=!0,this._x=e,this._y=t,this._z=s,this._w=i}static slerpFlat(e,t,s,i,r,n,a){let o=s[i+0],l=s[i+1],h=s[i+2],u=s[i+3];const c=r[n+0],d=r[n+1],p=r[n+2],_=r[n+3];if(0===a)return e[t+0]=o,e[t+1]=l,e[t+2]=h,void(e[t+3]=u);if(1===a)return e[t+0]=c,e[t+1]=d,e[t+2]=p,void(e[t+3]=_);if(u!==_||o!==c||l!==d||h!==p){let e=1-a;const t=o*c+l*d+h*p+u*_,s=t>=0?1:-1,i=1-t*t;if(i>Number.EPSILON){const r=Math.sqrt(i),n=Math.atan2(r,t*s);e=Math.sin(e*n)/r,a=Math.sin(a*n)/r}const r=a*s;if(o=o*e+c*r,l=l*e+d*r,h=h*e+p*r,u=u*e+_*r,e===1-a){const e=1/Math.sqrt(o*o+l*l+h*h+u*u);o*=e,l*=e,h*=e,u*=e}}e[t]=o,e[t+1]=l,e[t+2]=h,e[t+3]=u}static multiplyQuaternionsFlat(e,t,s,i,r,n){const a=s[i],o=s[i+1],l=s[i+2],h=s[i+3],u=r[n],c=r[n+1],d=r[n+2],p=r[n+3];return e[t]=a*p+h*u+o*d-l*c,e[t+1]=o*p+h*c+l*u-a*d,e[t+2]=l*p+h*d+a*c-o*u,e[t+3]=h*p-a*u-o*c-l*d,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,s,i){return this._x=e,this._y=t,this._z=s,this._w=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t=!0){const s=e._x,i=e._y,r=e._z,n=e._order,a=Math.cos,o=Math.sin,l=a(s/2),h=a(i/2),u=a(r/2),c=o(s/2),d=o(i/2),p=o(r/2);switch(n){case"XYZ":this._x=c*h*u+l*d*p,this._y=l*d*u-c*h*p,this._z=l*h*p+c*d*u,this._w=l*h*u-c*d*p;break;case"YXZ":this._x=c*h*u+l*d*p,this._y=l*d*u-c*h*p,this._z=l*h*p-c*d*u,this._w=l*h*u+c*d*p;break;case"ZXY":this._x=c*h*u-l*d*p,this._y=l*d*u+c*h*p,this._z=l*h*p+c*d*u,this._w=l*h*u-c*d*p;break;case"ZYX":this._x=c*h*u-l*d*p,this._y=l*d*u+c*h*p,this._z=l*h*p-c*d*u,this._w=l*h*u+c*d*p;break;case"YZX":this._x=c*h*u+l*d*p,this._y=l*d*u+c*h*p,this._z=l*h*p-c*d*u,this._w=l*h*u-c*d*p;break;case"XZY":this._x=c*h*u-l*d*p,this._y=l*d*u-c*h*p,this._z=l*h*p+c*d*u,this._w=l*h*u+c*d*p;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+n)}return!0===t&&this._onChangeCallback(),this}setFromAxisAngle(e,t){const s=t/2,i=Math.sin(s);return this._x=e.x*i,this._y=e.y*i,this._z=e.z*i,this._w=Math.cos(s),this._onChangeCallback(),this}setFromRotationMatrix(e){const t=e.elements,s=t[0],i=t[4],r=t[8],n=t[1],a=t[5],o=t[9],l=t[2],h=t[6],u=t[10],c=s+a+u;if(c>0){const e=.5/Math.sqrt(c+1);this._w=.25/e,this._x=(h-o)*e,this._y=(r-l)*e,this._z=(n-i)*e}else if(s>a&&s>u){const e=2*Math.sqrt(1+s-a-u);this._w=(h-o)/e,this._x=.25*e,this._y=(i+n)/e,this._z=(r+l)/e}else if(a>u){const e=2*Math.sqrt(1+a-s-u);this._w=(r-l)/e,this._x=(i+n)/e,this._y=.25*e,this._z=(o+h)/e}else{const e=2*Math.sqrt(1+u-s-a);this._w=(n-i)/e,this._x=(r+l)/e,this._y=(o+h)/e,this._z=.25*e}return this._onChangeCallback(),this}setFromUnitVectors(e,t){let s=e.dot(t)+1;return s<1e-8?(s=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=s):(this._x=0,this._y=-e.z,this._z=e.y,this._w=s)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=s),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(Hi(this.dot(e),-1,1)))}rotateTowards(e,t){const s=this.angleTo(e);if(0===s)return this;const i=Math.min(1,t/s);return this.slerp(e,i),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){const s=e._x,i=e._y,r=e._z,n=e._w,a=t._x,o=t._y,l=t._z,h=t._w;return this._x=s*h+n*a+i*l-r*o,this._y=i*h+n*o+r*a-s*l,this._z=r*h+n*l+s*o-i*a,this._w=n*h-s*a-i*o-r*l,this._onChangeCallback(),this}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);const s=this._x,i=this._y,r=this._z,n=this._w;let a=n*e._w+s*e._x+i*e._y+r*e._z;if(a<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,a=-a):this.copy(e),a>=1)return this._w=n,this._x=s,this._y=i,this._z=r,this;const o=1-a*a;if(o<=Number.EPSILON){const e=1-t;return this._w=e*n+t*this._w,this._x=e*s+t*this._x,this._y=e*i+t*this._y,this._z=e*r+t*this._z,this.normalize(),this}const l=Math.sqrt(o),h=Math.atan2(l,a),u=Math.sin((1-t)*h)/l,c=Math.sin(t*h)/l;return this._w=n*u+this._w*c,this._x=s*u+this._x*c,this._y=i*u+this._y*c,this._z=r*u+this._z*c,this._onChangeCallback(),this}slerpQuaternions(e,t,s){return this.copy(e).slerp(t,s)}random(){const e=2*Math.PI*Math.random(),t=2*Math.PI*Math.random(),s=Math.random(),i=Math.sqrt(1-s),r=Math.sqrt(s);return this.set(i*Math.sin(e),i*Math.cos(e),r*Math.sin(t),r*Math.cos(t))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}},Qi=class e{constructor(t=0,s=0,i=0){e.prototype.isVector3=!0,this.x=t,this.y=s,this.z=i}set(e,t,s){return void 0===s&&(s=this.z),this.x=e,this.y=t,this.z=s,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return this.applyQuaternion(ts.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(ts.setFromAxisAngle(e,t))}applyMatrix3(e){const t=this.x,s=this.y,i=this.z,r=e.elements;return this.x=r[0]*t+r[3]*s+r[6]*i,this.y=r[1]*t+r[4]*s+r[7]*i,this.z=r[2]*t+r[5]*s+r[8]*i,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const t=this.x,s=this.y,i=this.z,r=e.elements,n=1/(r[3]*t+r[7]*s+r[11]*i+r[15]);return this.x=(r[0]*t+r[4]*s+r[8]*i+r[12])*n,this.y=(r[1]*t+r[5]*s+r[9]*i+r[13])*n,this.z=(r[2]*t+r[6]*s+r[10]*i+r[14])*n,this}applyQuaternion(e){const t=this.x,s=this.y,i=this.z,r=e.x,n=e.y,a=e.z,o=e.w,l=2*(n*i-a*s),h=2*(a*t-r*i),u=2*(r*s-n*t);return this.x=t+o*l+n*u-a*h,this.y=s+o*h+a*l-r*u,this.z=i+o*u+r*h-n*l,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){const t=this.x,s=this.y,i=this.z,r=e.elements;return this.x=r[0]*t+r[4]*s+r[8]*i,this.y=r[1]*t+r[5]*s+r[9]*i,this.z=r[2]*t+r[6]*s+r[10]*i,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=Hi(this.x,e.x,t.x),this.y=Hi(this.y,e.y,t.y),this.z=Hi(this.z,e.z,t.z),this}clampScalar(e,t){return this.x=Hi(this.x,e,t),this.y=Hi(this.y,e,t),this.z=Hi(this.z,e,t),this}clampLength(e,t){const s=this.length();return this.divideScalar(s||1).multiplyScalar(Hi(s,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,s){return this.x=e.x+(t.x-e.x)*s,this.y=e.y+(t.y-e.y)*s,this.z=e.z+(t.z-e.z)*s,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,t){const s=e.x,i=e.y,r=e.z,n=t.x,a=t.y,o=t.z;return this.x=i*o-r*a,this.y=r*n-s*o,this.z=s*a-i*n,this}projectOnVector(e){const t=e.lengthSq();if(0===t)return this.set(0,0,0);const s=e.dot(this)/t;return this.copy(e).multiplyScalar(s)}projectOnPlane(e){return Ki.copy(this).projectOnVector(e),this.sub(Ki)}reflect(e){return this.sub(Ki.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const s=this.dot(e)/t;return Math.acos(Hi(s,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,s=this.y-e.y,i=this.z-e.z;return t*t+s*s+i*i}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,s){const i=Math.sin(t)*e;return this.x=i*Math.sin(s),this.y=Math.cos(t)*e,this.z=i*Math.cos(s),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,s){return this.x=e*Math.sin(t),this.y=s,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){const t=this.setFromMatrixColumn(e,0).length(),s=this.setFromMatrixColumn(e,1).length(),i=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=s,this.z=i,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}setFromEuler(e){return this.x=e._x,this.y=e._y,this.z=e._z,this}setFromColor(e){return this.x=e.r,this.y=e.g,this.z=e.b,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const e=Math.random()*Math.PI*2,t=2*Math.random()-1,s=Math.sqrt(1-t*t);return this.x=s*Math.cos(e),this.y=t,this.z=s*Math.sin(e),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}},Ki=new Qi,ts=new $i,es=class e{constructor(t,s,i,r,n,a,o,l,h){e.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==t&&this.set(t,s,i,r,n,a,o,l,h)}set(e,t,s,i,r,n,a,o,l){const h=this.elements;return h[0]=e,h[1]=i,h[2]=a,h[3]=t,h[4]=r,h[5]=o,h[6]=s,h[7]=n,h[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const t=this.elements,s=e.elements;return t[0]=s[0],t[1]=s[1],t[2]=s[2],t[3]=s[3],t[4]=s[4],t[5]=s[5],t[6]=s[6],t[7]=s[7],t[8]=s[8],this}extractBasis(e,t,s){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),s.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const s=e.elements,i=t.elements,r=this.elements,n=s[0],a=s[3],o=s[6],l=s[1],h=s[4],u=s[7],c=s[2],d=s[5],p=s[8],_=i[0],m=i[3],f=i[6],g=i[1],y=i[4],S=i[7],T=i[2],x=i[5],b=i[8];return r[0]=n*_+a*g+o*T,r[3]=n*m+a*y+o*x,r[6]=n*f+a*S+o*b,r[1]=l*_+h*g+u*T,r[4]=l*m+h*y+u*x,r[7]=l*f+h*S+u*b,r[2]=c*_+d*g+p*T,r[5]=c*m+d*y+p*x,r[8]=c*f+d*S+p*b,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){const e=this.elements,t=e[0],s=e[1],i=e[2],r=e[3],n=e[4],a=e[5],o=e[6],l=e[7],h=e[8];return t*n*h-t*a*l-s*r*h+s*a*o+i*r*l-i*n*o}invert(){const e=this.elements,t=e[0],s=e[1],i=e[2],r=e[3],n=e[4],a=e[5],o=e[6],l=e[7],h=e[8],u=h*n-a*l,c=a*o-h*r,d=l*r-n*o,p=t*u+s*c+i*d;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);const _=1/p;return e[0]=u*_,e[1]=(i*l-h*s)*_,e[2]=(a*s-i*n)*_,e[3]=c*_,e[4]=(h*t-i*o)*_,e[5]=(i*r-a*t)*_,e[6]=d*_,e[7]=(s*o-l*t)*_,e[8]=(n*t-s*r)*_,this}transpose(){let e;const t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,s,i,r,n,a){const o=Math.cos(r),l=Math.sin(r);return this.set(s*o,s*l,-s*(o*n+l*a)+n+e,-i*l,i*o,-i*(-l*n+o*a)+a+t,0,0,1),this}scale(e,t){return this.premultiply(is.makeScale(e,t)),this}rotate(e){return this.premultiply(is.makeRotation(-e)),this}translate(e,t){return this.premultiply(is.makeTranslation(e,t)),this}makeTranslation(e,t){return e.isVector2?this.set(1,0,e.x,0,1,e.y,0,0,1):this.set(1,0,e,0,1,t,0,0,1),this}makeRotation(e){const t=Math.cos(e),s=Math.sin(e);return this.set(t,-s,0,s,t,0,0,0,1),this}makeScale(e,t){return this.set(e,0,0,0,t,0,0,0,1),this}equals(e){const t=this.elements,s=e.elements;for(let e=0;e<9;e++)if(t[e]!==s[e])return!1;return!0}fromArray(e,t=0){for(let s=0;s<9;s++)this.elements[s]=e[s+t];return this}toArray(e=[],t=0){const s=this.elements;return e[t]=s[0],e[t+1]=s[1],e[t+2]=s[2],e[t+3]=s[3],e[t+4]=s[4],e[t+5]=s[5],e[t+6]=s[6],e[t+7]=s[7],e[t+8]=s[8],e}clone(){return(new this.constructor).fromArray(this.elements)}},is=new es;function ss(e){for(let t=e.length-1;t>=0;--t)if(e[t]>=65535)return!0;return!1}function as(e){return document.createElementNS("http://www.w3.org/1999/xhtml",e)}function os(){const e=as("canvas");return e.style.display="block",e}var hs={};function ls(e){e in hs||(hs[e]=!0,console.warn(e))}var us=(new es).set(.4123908,.3575843,.1804808,.212639,.7151687,.0721923,.0193308,.1191948,.9505322),ds=(new es).set(3.2409699,-1.5373832,-.4986108,-.9692436,1.8759675,.0415551,.0556301,-.203977,1.0569715);function ps(){const e={enabled:!0,workingColorSpace:Ze,spaces:{},convert:function(e,t,s){return!1!==this.enabled&&t!==s&&t&&s?(this.spaces[t].transfer===$e&&(e.r=ys(e.r),e.g=ys(e.g),e.b=ys(e.b)),this.spaces[t].primaries!==this.spaces[s].primaries&&(e.applyMatrix3(this.spaces[t].toXYZ),e.applyMatrix3(this.spaces[s].fromXYZ)),this.spaces[s].transfer===$e&&(e.r=gs(e.r),e.g=gs(e.g),e.b=gs(e.b)),e):e},workingToColorSpace:function(e,t){return this.convert(e,this.workingColorSpace,t)},colorSpaceToWorking:function(e,t){return this.convert(e,t,this.workingColorSpace)},getPrimaries:function(e){return this.spaces[e].primaries},getTransfer:function(e){return""===e?Ge:this.spaces[e].transfer},getLuminanceCoefficients:function(e,t=this.workingColorSpace){return e.fromArray(this.spaces[t].luminanceCoefficients)},define:function(e){Object.assign(this.spaces,e)},_getMatrix:function(e,t,s){return e.copy(this.spaces[t].toXYZ).multiply(this.spaces[s].fromXYZ)},_getDrawingBufferColorSpace:function(e){return this.spaces[e].outputColorSpaceConfig.drawingBufferColorSpace},_getUnpackColorSpace:function(e=this.workingColorSpace){return this.spaces[e].workingColorSpaceConfig.unpackColorSpace},fromWorkingColorSpace:function(t,s){return ls("THREE.ColorManagement: .fromWorkingColorSpace() has been renamed to .workingToColorSpace()."),e.workingToColorSpace(t,s)},toWorkingColorSpace:function(t,s){return ls("THREE.ColorManagement: .toWorkingColorSpace() has been renamed to .colorSpaceToWorking()."),e.colorSpaceToWorking(t,s)}},t=[.64,.33,.3,.6,.15,.06],s=[.2126,.7152,.0722],i=[.3127,.329];return e.define({[Ze]:{primaries:t,whitePoint:i,transfer:Ge,toXYZ:us,fromXYZ:ds,luminanceCoefficients:s,workingColorSpaceConfig:{unpackColorSpace:Ye},outputColorSpaceConfig:{drawingBufferColorSpace:Ye}},[Ye]:{primaries:t,whitePoint:i,transfer:$e,toXYZ:us,fromXYZ:ds,luminanceCoefficients:s,outputColorSpaceConfig:{drawingBufferColorSpace:Ye}}}),e}var ms=ps(),fs;function ys(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function gs(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}var xs=class{static getDataURL(e,t="image/png"){if(/^data:/i.test(e.src))return e.src;if("undefined"==typeof HTMLCanvasElement)return e.src;let s;if(e instanceof HTMLCanvasElement)s=e;else{void 0===fs&&(fs=as("canvas")),fs.width=e.width,fs.height=e.height;const t=fs.getContext("2d");e instanceof ImageData?t.putImageData(e,0,0):t.drawImage(e,0,0,e.width,e.height),s=fs}return s.toDataURL(t)}static sRGBToLinear(e){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap){const t=as("canvas");t.width=e.width,t.height=e.height;const s=t.getContext("2d");s.drawImage(e,0,0,e.width,e.height);const i=s.getImageData(0,0,e.width,e.height),r=i.data;for(let e=0;e<r.length;e++)r[e]=255*ys(r[e]/255);return s.putImageData(i,0,0),t}if(e.data){const t=e.data.slice(0);for(let e=0;e<t.length;e++)t instanceof Uint8Array||t instanceof Uint8ClampedArray?t[e]=Math.floor(255*ys(t[e]/255)):t[e]=ys(t[e]);return{data:t,width:e.width,height:e.height}}return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),e}},bs=0,vs=class{constructor(e=null){this.isSource=!0,Object.defineProperty(this,"id",{value:bs++}),this.uuid=Ui(),this.data=e,this.dataReady=!0,this.version=0}getSize(e){const t=this.data;return t instanceof HTMLVideoElement?e.set(t.videoWidth,t.videoHeight,0):t instanceof VideoFrame?e.set(t.displayHeight,t.displayWidth,0):null!==t?e.set(t.width,t.height,t.depth||0):e.set(0,0,0),e}set needsUpdate(e){!0===e&&this.version++}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.images[this.uuid])return e.images[this.uuid];const s={uuid:this.uuid,url:""},i=this.data;if(null!==i){let e;if(Array.isArray(i)){e=[];for(let t=0,s=i.length;t<s;t++)i[t].isDataTexture?e.push(ws(i[t].image)):e.push(ws(i[t]))}else e=ws(i);s.url=e}return t||(e.images[this.uuid]=s),s}};function ws(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?xs.getDataURL(e):e.data?{data:Array.from(e.data),width:e.width,height:e.height,type:e.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}var Ms=0,Ss=new Qi,_s=class e extends Fi{constructor(t=e.DEFAULT_IMAGE,s=e.DEFAULT_MAPPING,i=1001,r=1001,n=1006,a=1008,o=1023,l=1009,h=e.DEFAULT_ANISOTROPY,u=""){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:Ms++}),this.uuid=Ui(),this.name="",this.source=new vs(t),this.mipmaps=[],this.mapping=s,this.channel=0,this.wrapS=i,this.wrapT=r,this.magFilter=n,this.minFilter=a,this.anisotropy=h,this.format=o,this.internalFormat=null,this.type=l,this.offset=new Gi(0,0),this.repeat=new Gi(1,1),this.center=new Gi(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new es,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=u,this.userData={},this.updateRanges=[],this.version=0,this.onUpdate=null,this.renderTarget=null,this.isRenderTargetTexture=!1,this.isArrayTexture=!!(t&&t.depth&&t.depth>1),this.pmremVersion=0}get width(){return this.source.getSize(Ss).x}get height(){return this.source.getSize(Ss).y}get depth(){return this.source.getSize(Ss).z}get image(){return this.source.data}set image(e=null){this.source.data=e}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}clone(){return(new this.constructor).copy(this)}copy(e){return this.name=e.name,this.source=e.source,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.channel=e.channel,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.colorSpace=e.colorSpace,this.renderTarget=e.renderTarget,this.isRenderTargetTexture=e.isRenderTargetTexture,this.isArrayTexture=e.isArrayTexture,this.userData=JSON.parse(JSON.stringify(e.userData)),this.needsUpdate=!0,this}setValues(e){for(const t in e){const s=e[t];if(void 0===s){console.warn(`THREE.Texture.setValues(): parameter '${t}' has value of undefined.`);continue}const i=this[t];void 0!==i?i&&s&&i.isVector2&&s.isVector2||i&&s&&i.isVector3&&s.isVector3||i&&s&&i.isMatrix3&&s.isMatrix3?i.copy(s):this[t]=s:console.warn(`THREE.Texture.setValues(): property '${t}' does not exist.`)}}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.textures[this.uuid])return e.textures[this.uuid];const s={metadata:{version:4.7,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(e).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(s.userData=this.userData),t||(e.textures[this.uuid]=s),s}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(this.mapping!==ot)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case pt:e.x=e.x-Math.floor(e.x);break;case mt:e.x=e.x<0?0:1;break;case yt:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case pt:e.y=e.y-Math.floor(e.y);break;case mt:e.y=e.y<0?0:1;break;case yt:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){!0===e&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(e){!0===e&&this.pmremVersion++}};_s.DEFAULT_IMAGE=null,_s.DEFAULT_MAPPING=ot,_s.DEFAULT_ANISOTROPY=1;var As=class e{constructor(t=0,s=0,i=0,r=1){e.prototype.isVector4=!0,this.x=t,this.y=s,this.z=i,this.w=r}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,s,i){return this.x=e,this.y=t,this.z=s,this.w=i,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,s=this.y,i=this.z,r=this.w,n=e.elements;return this.x=n[0]*t+n[4]*s+n[8]*i+n[12]*r,this.y=n[1]*t+n[5]*s+n[9]*i+n[13]*r,this.z=n[2]*t+n[6]*s+n[10]*i+n[14]*r,this.w=n[3]*t+n[7]*s+n[11]*i+n[15]*r,this}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(e){let t,s,i,r;const n=.01,a=.1,o=e.elements,l=o[0],h=o[4],u=o[8],c=o[1],d=o[5],p=o[9],_=o[2],m=o[6],f=o[10];if(Math.abs(h-c)<n&&Math.abs(u-_)<n&&Math.abs(p-m)<n){if(Math.abs(h+c)<a&&Math.abs(u+_)<a&&Math.abs(p+m)<a&&Math.abs(l+d+f-3)<a)return this.set(1,0,0,0),this;t=Math.PI;const e=(l+1)/2,o=(d+1)/2,g=(f+1)/2,y=(h+c)/4,S=(u+_)/4,T=(p+m)/4;return e>o&&e>g?e<n?(s=0,i=.707106781,r=.707106781):(s=Math.sqrt(e),i=y/s,r=S/s):o>g?o<n?(s=.707106781,i=0,r=.707106781):(i=Math.sqrt(o),s=y/i,r=T/i):g<n?(s=.707106781,i=.707106781,r=0):(r=Math.sqrt(g),s=S/r,i=T/r),this.set(s,i,r,t),this}let g=Math.sqrt((m-p)*(m-p)+(u-_)*(u-_)+(c-h)*(c-h));return Math.abs(g)<.001&&(g=1),this.x=(m-p)/g,this.y=(u-_)/g,this.z=(c-h)/g,this.w=Math.acos((l+d+f-1)/2),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this.w=t[15],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=Hi(this.x,e.x,t.x),this.y=Hi(this.y,e.y,t.y),this.z=Hi(this.z,e.z,t.z),this.w=Hi(this.w,e.w,t.w),this}clampScalar(e,t){return this.x=Hi(this.x,e,t),this.y=Hi(this.y,e,t),this.z=Hi(this.z,e,t),this.w=Hi(this.w,e,t),this}clampLength(e,t){const s=this.length();return this.divideScalar(s||1).multiplyScalar(Hi(s,e,t))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,s){return this.x=e.x+(t.x-e.x)*s,this.y=e.y+(t.y-e.y)*s,this.z=e.z+(t.z-e.z)*s,this.w=e.w+(t.w-e.w)*s,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}},Ts=class extends Fi{constructor(e=1,t=1,s={}){super(),s=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:wt,depthBuffer:!0,stencilBuffer:!1,resolveDepthBuffer:!0,resolveStencilBuffer:!0,depthTexture:null,samples:0,count:1,depth:1,multiview:!1},s),this.isRenderTarget=!0,this.width=e,this.height=t,this.depth=s.depth,this.scissor=new As(0,0,e,t),this.scissorTest=!1,this.viewport=new As(0,0,e,t);const i={width:e,height:t,depth:s.depth},r=new _s(i);this.textures=[];const n=s.count;for(let e=0;e<n;e++)this.textures[e]=r.clone(),this.textures[e].isRenderTargetTexture=!0,this.textures[e].renderTarget=this;this._setTextureOptions(s),this.depthBuffer=s.depthBuffer,this.stencilBuffer=s.stencilBuffer,this.resolveDepthBuffer=s.resolveDepthBuffer,this.resolveStencilBuffer=s.resolveStencilBuffer,this._depthTexture=null,this.depthTexture=s.depthTexture,this.samples=s.samples,this.multiview=s.multiview}_setTextureOptions(e={}){const t={minFilter:wt,generateMipmaps:!1,flipY:!1,internalFormat:null};void 0!==e.mapping&&(t.mapping=e.mapping),void 0!==e.wrapS&&(t.wrapS=e.wrapS),void 0!==e.wrapT&&(t.wrapT=e.wrapT),void 0!==e.wrapR&&(t.wrapR=e.wrapR),void 0!==e.magFilter&&(t.magFilter=e.magFilter),void 0!==e.minFilter&&(t.minFilter=e.minFilter),void 0!==e.format&&(t.format=e.format),void 0!==e.type&&(t.type=e.type),void 0!==e.anisotropy&&(t.anisotropy=e.anisotropy),void 0!==e.colorSpace&&(t.colorSpace=e.colorSpace),void 0!==e.flipY&&(t.flipY=e.flipY),void 0!==e.generateMipmaps&&(t.generateMipmaps=e.generateMipmaps),void 0!==e.internalFormat&&(t.internalFormat=e.internalFormat);for(let e=0;e<this.textures.length;e++)this.textures[e].setValues(t)}get texture(){return this.textures[0]}set texture(e){this.textures[0]=e}set depthTexture(e){null!==this._depthTexture&&(this._depthTexture.renderTarget=null),null!==e&&(e.renderTarget=this),this._depthTexture=e}get depthTexture(){return this._depthTexture}setSize(e,t,s=1){if(this.width!==e||this.height!==t||this.depth!==s){this.width=e,this.height=t,this.depth=s;for(let i=0,r=this.textures.length;i<r;i++)this.textures[i].image.width=e,this.textures[i].image.height=t,this.textures[i].image.depth=s,this.textures[i].isArrayTexture=this.textures[i].image.depth>1;this.dispose()}this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)}clone(){return(new this.constructor).copy(this)}copy(e){this.width=e.width,this.height=e.height,this.depth=e.depth,this.scissor.copy(e.scissor),this.scissorTest=e.scissorTest,this.viewport.copy(e.viewport),this.textures.length=0;for(let t=0,s=e.textures.length;t<s;t++){this.textures[t]=e.textures[t].clone(),this.textures[t].isRenderTargetTexture=!0,this.textures[t].renderTarget=this;const s=Object.assign({},e.textures[t].image);this.textures[t].source=new vs(s)}return this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.resolveDepthBuffer=e.resolveDepthBuffer,this.resolveStencilBuffer=e.resolveStencilBuffer,null!==e.depthTexture&&(this.depthTexture=e.depthTexture.clone()),this.samples=e.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}},zs=class extends Ts{constructor(e=1,t=1,s={}){super(e,t,s),this.isWebGLRenderTarget=!0}},Cs=class extends _s{constructor(e=null,t=1,s=1,i=1){super(null),this.isDataArrayTexture=!0,this.image={data:e,width:t,height:s,depth:i},this.magFilter=gt,this.minFilter=gt,this.wrapR=mt,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.layerUpdates=new Set}addLayerUpdate(e){this.layerUpdates.add(e)}clearLayerUpdates(){this.layerUpdates.clear()}},Es=class{constructor(e=new Qi(1/0,1/0,1/0),t=new Qi(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){this.makeEmpty();for(let t=0,s=e.length;t<s;t+=3)this.expandByPoint(Ps.fromArray(e,t));return this}setFromBufferAttribute(e){this.makeEmpty();for(let t=0,s=e.count;t<s;t++)this.expandByPoint(Ps.fromBufferAttribute(e,t));return this}setFromPoints(e){this.makeEmpty();for(let t=0,s=e.length;t<s;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const s=Ps.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(s),this.max.copy(e).add(s),this}setFromObject(e,t=!1){return this.makeEmpty(),this.expandByObject(e,t)}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e,t=!1){e.updateWorldMatrix(!1,!1);const s=e.geometry;if(void 0!==s){const i=s.getAttribute("position");if(!0===t&&void 0!==i&&!0!==e.isInstancedMesh)for(let t=0,s=i.count;t<s;t++)!0===e.isMesh?e.getVertexPosition(t,Ps):Ps.fromBufferAttribute(i,t),Ps.applyMatrix4(e.matrixWorld),this.expandByPoint(Ps);else void 0!==e.boundingBox?(null===e.boundingBox&&e.computeBoundingBox(),Os.copy(e.boundingBox)):(null===s.boundingBox&&s.computeBoundingBox(),Os.copy(s.boundingBox)),Os.applyMatrix4(e.matrixWorld),this.union(Os)}const i=e.children;for(let e=0,s=i.length;e<s;e++)this.expandByObject(i[e],t);return this}containsPoint(e){return e.x>=this.min.x&&e.x<=this.max.x&&e.y>=this.min.y&&e.y<=this.max.y&&e.z>=this.min.z&&e.z<=this.max.z}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return e.max.x>=this.min.x&&e.min.x<=this.max.x&&e.max.y>=this.min.y&&e.min.y<=this.max.y&&e.max.z>=this.min.z&&e.min.z<=this.max.z}intersectsSphere(e){return this.clampPoint(e.center,Ps),Ps.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,s;return e.normal.x>0?(t=e.normal.x*this.min.x,s=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,s=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,s+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,s+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,s+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,s+=e.normal.z*this.min.z),t<=-e.constant&&s>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(Ds),Us.subVectors(this.max,Ds),Ns.subVectors(e.a,Ds),Vs.subVectors(e.b,Ds),Fs.subVectors(e.c,Ds),Ls.subVectors(Vs,Ns),js.subVectors(Fs,Vs),Ws.subVectors(Ns,Fs);let t=[0,-Ls.z,Ls.y,0,-js.z,js.y,0,-Ws.z,Ws.y,Ls.z,0,-Ls.x,js.z,0,-js.x,Ws.z,0,-Ws.x,-Ls.y,Ls.x,0,-js.y,js.x,0,-Ws.y,Ws.x,0];return!!Js(t,Ns,Vs,Fs,Us)&&(t=[1,0,0,0,1,0,0,0,1],!!Js(t,Ns,Vs,Fs,Us)&&(Hs.crossVectors(Ls,js),t=[Hs.x,Hs.y,Hs.z],Js(t,Ns,Vs,Fs,Us)))}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,Ps).distanceTo(e)}getBoundingSphere(e){return this.isEmpty()?e.makeEmpty():(this.getCenter(e.center),e.radius=.5*this.getSize(Ps).length()),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()||(Rs[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),Rs[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),Rs[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),Rs[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),Rs[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),Rs[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),Rs[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),Rs[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(Rs)),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}toJSON(){return{min:this.min.toArray(),max:this.max.toArray()}}fromJSON(e){return this.min.fromArray(e.min),this.max.fromArray(e.max),this}},Rs=[new Qi,new Qi,new Qi,new Qi,new Qi,new Qi,new Qi,new Qi],Ps=new Qi,Os=new Es,Ns=new Qi,Vs=new Qi,Fs=new Qi,Ls=new Qi,js=new Qi,Ws=new Qi,Ds=new Qi,Us=new Qi,Hs=new Qi,qs=new Qi;function Js(e,t,s,i,r){for(let n=0,a=e.length-3;n<=a;n+=3){qs.fromArray(e,n);const a=r.x*Math.abs(qs.x)+r.y*Math.abs(qs.y)+r.z*Math.abs(qs.z),o=t.dot(qs),l=s.dot(qs),h=i.dot(qs);if(Math.max(-Math.max(o,l,h),Math.min(o,l,h))>a)return!1}return!0}var Xs=new Es,Ys=new Qi,Zs=new Qi,Gs=class{constructor(e=new Qi,t=-1){this.isSphere=!0,this.center=e,this.radius=t}set(e,t){return this.center.copy(e),this.radius=t,this}setFromPoints(e,t){const s=this.center;void 0!==t?s.copy(t):Xs.setFromPoints(e).getCenter(s);let i=0;for(let t=0,r=e.length;t<r;t++)i=Math.max(i,s.distanceToSquared(e[t]));return this.radius=Math.sqrt(i),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,t){const s=this.center.distanceToSquared(e);return t.copy(e),s>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t}getBoundingBox(e){return this.isEmpty()?(e.makeEmpty(),e):(e.set(this.center,this.center),e.expandByScalar(this.radius),e)}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){if(this.isEmpty())return this.center.copy(e),this.radius=0,this;Ys.subVectors(e,this.center);const t=Ys.lengthSq();if(t>this.radius*this.radius){const e=Math.sqrt(t),s=.5*(e-this.radius);this.center.addScaledVector(Ys,s/e),this.radius+=s}return this}union(e){return e.isEmpty()?this:this.isEmpty()?(this.copy(e),this):(!0===this.center.equals(e.center)?this.radius=Math.max(this.radius,e.radius):(Zs.subVectors(e.center,this.center).setLength(e.radius),this.expandByPoint(Ys.copy(e.center).add(Zs)),this.expandByPoint(Ys.copy(e.center).sub(Zs))),this)}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return(new this.constructor).copy(this)}toJSON(){return{radius:this.radius,center:this.center.toArray()}}fromJSON(e){return this.radius=e.radius,this.center.fromArray(e.center),this}},$s=new Qi,Qs=new Qi,Ks=new Qi,tr=new Qi,er=new Qi,ir=new Qi,sr=new Qi,rr=class{constructor(e=new Qi,t=new Qi(0,0,-1)){this.origin=e,this.direction=t}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,t){return t.copy(this.origin).addScaledVector(this.direction,e)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,$s)),this}closestPointToPoint(e,t){t.subVectors(e,this.origin);const s=t.dot(this.direction);return s<0?t.copy(this.origin):t.copy(this.origin).addScaledVector(this.direction,s)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){const t=$s.subVectors(e,this.origin).dot(this.direction);return t<0?this.origin.distanceToSquared(e):($s.copy(this.origin).addScaledVector(this.direction,t),$s.distanceToSquared(e))}distanceSqToSegment(e,t,s,i){Qs.copy(e).add(t).multiplyScalar(.5),Ks.copy(t).sub(e).normalize(),tr.copy(this.origin).sub(Qs);const r=.5*e.distanceTo(t),n=-this.direction.dot(Ks),a=tr.dot(this.direction),o=-tr.dot(Ks),l=tr.lengthSq(),h=Math.abs(1-n*n);let u,c,d,p;if(h>0)if(u=n*o-a,c=n*a-o,p=r*h,u>=0)if(c>=-p)if(c<=p){const e=1/h;u*=e,c*=e,d=u*(u+n*c+2*a)+c*(n*u+c+2*o)+l}else c=r,u=Math.max(0,-(n*c+a)),d=-u*u+c*(c+2*o)+l;else c=-r,u=Math.max(0,-(n*c+a)),d=-u*u+c*(c+2*o)+l;else c<=-p?(u=Math.max(0,-(-n*r+a)),c=u>0?-r:Math.min(Math.max(-r,-o),r),d=-u*u+c*(c+2*o)+l):c<=p?(u=0,c=Math.min(Math.max(-r,-o),r),d=c*(c+2*o)+l):(u=Math.max(0,-(n*r+a)),c=u>0?r:Math.min(Math.max(-r,-o),r),d=-u*u+c*(c+2*o)+l);else c=n>0?-r:r,u=Math.max(0,-(n*c+a)),d=-u*u+c*(c+2*o)+l;return s&&s.copy(this.origin).addScaledVector(this.direction,u),i&&i.copy(Qs).addScaledVector(Ks,c),d}intersectSphere(e,t){$s.subVectors(e.center,this.origin);const s=$s.dot(this.direction),i=$s.dot($s)-s*s,r=e.radius*e.radius;if(i>r)return null;const n=Math.sqrt(r-i),a=s-n,o=s+n;return o<0?null:a<0?this.at(o,t):this.at(a,t)}intersectsSphere(e){return!(e.radius<0)&&this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){const t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;const s=-(this.origin.dot(e.normal)+e.constant)/t;return s>=0?s:null}intersectPlane(e,t){const s=this.distanceToPlane(e);return null===s?null:this.at(s,t)}intersectsPlane(e){const t=e.distanceToPoint(this.origin);return 0===t||e.normal.dot(this.direction)*t<0}intersectBox(e,t){let s,i,r,n,a,o;const l=1/this.direction.x,h=1/this.direction.y,u=1/this.direction.z,c=this.origin;return l>=0?(s=(e.min.x-c.x)*l,i=(e.max.x-c.x)*l):(s=(e.max.x-c.x)*l,i=(e.min.x-c.x)*l),h>=0?(r=(e.min.y-c.y)*h,n=(e.max.y-c.y)*h):(r=(e.max.y-c.y)*h,n=(e.min.y-c.y)*h),s>n||r>i?null:((r>s||isNaN(s))&&(s=r),(n<i||isNaN(i))&&(i=n),u>=0?(a=(e.min.z-c.z)*u,o=(e.max.z-c.z)*u):(a=(e.max.z-c.z)*u,o=(e.min.z-c.z)*u),s>o||a>i?null:((a>s||s!=s)&&(s=a),(o<i||i!=i)&&(i=o),i<0?null:this.at(s>=0?s:i,t)))}intersectsBox(e){return null!==this.intersectBox(e,$s)}intersectTriangle(e,t,s,i,r){er.subVectors(t,e),ir.subVectors(s,e),sr.crossVectors(er,ir);let n,a=this.direction.dot(sr);if(a>0){if(i)return null;n=1}else{if(!(a<0))return null;n=-1,a=-a}tr.subVectors(this.origin,e);const o=n*this.direction.dot(ir.crossVectors(tr,ir));if(o<0)return null;const l=n*this.direction.dot(er.cross(tr));if(l<0)return null;if(o+l>a)return null;const h=-n*tr.dot(sr);return h<0?null:this.at(h/a,r)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}},nr=class e{constructor(t,s,i,r,n,a,o,l,h,u,c,d,p,_,m,f){e.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==t&&this.set(t,s,i,r,n,a,o,l,h,u,c,d,p,_,m,f)}set(e,t,s,i,r,n,a,o,l,h,u,c,d,p,_,m){const f=this.elements;return f[0]=e,f[4]=t,f[8]=s,f[12]=i,f[1]=r,f[5]=n,f[9]=a,f[13]=o,f[2]=l,f[6]=h,f[10]=u,f[14]=c,f[3]=d,f[7]=p,f[11]=_,f[15]=m,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new e).fromArray(this.elements)}copy(e){const t=this.elements,s=e.elements;return t[0]=s[0],t[1]=s[1],t[2]=s[2],t[3]=s[3],t[4]=s[4],t[5]=s[5],t[6]=s[6],t[7]=s[7],t[8]=s[8],t[9]=s[9],t[10]=s[10],t[11]=s[11],t[12]=s[12],t[13]=s[13],t[14]=s[14],t[15]=s[15],this}copyPosition(e){const t=this.elements,s=e.elements;return t[12]=s[12],t[13]=s[13],t[14]=s[14],this}setFromMatrix3(e){const t=e.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(e,t,s){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),s.setFromMatrixColumn(this,2),this}makeBasis(e,t,s){return this.set(e.x,t.x,s.x,0,e.y,t.y,s.y,0,e.z,t.z,s.z,0,0,0,0,1),this}extractRotation(e){const t=this.elements,s=e.elements,i=1/ar.setFromMatrixColumn(e,0).length(),r=1/ar.setFromMatrixColumn(e,1).length(),n=1/ar.setFromMatrixColumn(e,2).length();return t[0]=s[0]*i,t[1]=s[1]*i,t[2]=s[2]*i,t[3]=0,t[4]=s[4]*r,t[5]=s[5]*r,t[6]=s[6]*r,t[7]=0,t[8]=s[8]*n,t[9]=s[9]*n,t[10]=s[10]*n,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){const t=this.elements,s=e.x,i=e.y,r=e.z,n=Math.cos(s),a=Math.sin(s),o=Math.cos(i),l=Math.sin(i),h=Math.cos(r),u=Math.sin(r);if("XYZ"===e.order){const e=n*h,s=n*u,i=a*h,r=a*u;t[0]=o*h,t[4]=-o*u,t[8]=l,t[1]=s+i*l,t[5]=e-r*l,t[9]=-a*o,t[2]=r-e*l,t[6]=i+s*l,t[10]=n*o}else if("YXZ"===e.order){const e=o*h,s=o*u,i=l*h,r=l*u;t[0]=e+r*a,t[4]=i*a-s,t[8]=n*l,t[1]=n*u,t[5]=n*h,t[9]=-a,t[2]=s*a-i,t[6]=r+e*a,t[10]=n*o}else if("ZXY"===e.order){const e=o*h,s=o*u,i=l*h,r=l*u;t[0]=e-r*a,t[4]=-n*u,t[8]=i+s*a,t[1]=s+i*a,t[5]=n*h,t[9]=r-e*a,t[2]=-n*l,t[6]=a,t[10]=n*o}else if("ZYX"===e.order){const e=n*h,s=n*u,i=a*h,r=a*u;t[0]=o*h,t[4]=i*l-s,t[8]=e*l+r,t[1]=o*u,t[5]=r*l+e,t[9]=s*l-i,t[2]=-l,t[6]=a*o,t[10]=n*o}else if("YZX"===e.order){const e=n*o,s=n*l,i=a*o,r=a*l;t[0]=o*h,t[4]=r-e*u,t[8]=i*u+s,t[1]=u,t[5]=n*h,t[9]=-a*h,t[2]=-l*h,t[6]=s*u+i,t[10]=e-r*u}else if("XZY"===e.order){const e=n*o,s=n*l,i=a*o,r=a*l;t[0]=o*h,t[4]=-u,t[8]=l*h,t[1]=e*u+r,t[5]=n*h,t[9]=s*u-i,t[2]=i*u-s,t[6]=a*h,t[10]=r*u+e}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(hr,e,lr)}lookAt(e,t,s){const i=this.elements;return dr.subVectors(e,t),0===dr.lengthSq()&&(dr.z=1),dr.normalize(),cr.crossVectors(s,dr),0===cr.lengthSq()&&(1===Math.abs(s.z)?dr.x+=1e-4:dr.z+=1e-4,dr.normalize(),cr.crossVectors(s,dr)),cr.normalize(),ur.crossVectors(dr,cr),i[0]=cr.x,i[4]=ur.x,i[8]=dr.x,i[1]=cr.y,i[5]=ur.y,i[9]=dr.y,i[2]=cr.z,i[6]=ur.z,i[10]=dr.z,this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const s=e.elements,i=t.elements,r=this.elements,n=s[0],a=s[4],o=s[8],l=s[12],h=s[1],u=s[5],c=s[9],d=s[13],p=s[2],_=s[6],m=s[10],f=s[14],g=s[3],y=s[7],S=s[11],T=s[15],x=i[0],b=i[4],G=i[8],I=i[12],v=i[1],C=i[5],w=i[9],A=i[13],R=i[2],P=i[6],M=i[10],E=i[14],D=i[3],N=i[7],F=i[11],O=i[15];return r[0]=n*x+a*v+o*R+l*D,r[4]=n*b+a*C+o*P+l*N,r[8]=n*G+a*w+o*M+l*F,r[12]=n*I+a*A+o*E+l*O,r[1]=h*x+u*v+c*R+d*D,r[5]=h*b+u*C+c*P+d*N,r[9]=h*G+u*w+c*M+d*F,r[13]=h*I+u*A+c*E+d*O,r[2]=p*x+_*v+m*R+f*D,r[6]=p*b+_*C+m*P+f*N,r[10]=p*G+_*w+m*M+f*F,r[14]=p*I+_*A+m*E+f*O,r[3]=g*x+y*v+S*R+T*D,r[7]=g*b+y*C+S*P+T*N,r[11]=g*G+y*w+S*M+T*F,r[15]=g*I+y*A+S*E+T*O,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){const e=this.elements,t=e[0],s=e[4],i=e[8],r=e[12],n=e[1],a=e[5],o=e[9],l=e[13],h=e[2],u=e[6],c=e[10],d=e[14];return e[3]*(+r*o*u-i*l*u-r*a*c+s*l*c+i*a*d-s*o*d)+e[7]*(+t*o*d-t*l*c+r*n*c-i*n*d+i*l*h-r*o*h)+e[11]*(+t*l*u-t*a*d-r*n*u+s*n*d+r*a*h-s*l*h)+e[15]*(-i*a*h-t*o*u+t*a*c+i*n*u-s*n*c+s*o*h)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e,t,s){const i=this.elements;return e.isVector3?(i[12]=e.x,i[13]=e.y,i[14]=e.z):(i[12]=e,i[13]=t,i[14]=s),this}invert(){const e=this.elements,t=e[0],s=e[1],i=e[2],r=e[3],n=e[4],a=e[5],o=e[6],l=e[7],h=e[8],u=e[9],c=e[10],d=e[11],p=e[12],_=e[13],m=e[14],f=e[15],g=u*m*l-_*c*l+_*o*d-a*m*d-u*o*f+a*c*f,y=p*c*l-h*m*l-p*o*d+n*m*d+h*o*f-n*c*f,S=h*_*l-p*u*l+p*a*d-n*_*d-h*a*f+n*u*f,T=p*u*o-h*_*o-p*a*c+n*_*c+h*a*m-n*u*m,x=t*g+s*y+i*S+r*T;if(0===x)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const b=1/x;return e[0]=g*b,e[1]=(_*c*r-u*m*r-_*i*d+s*m*d+u*i*f-s*c*f)*b,e[2]=(a*m*r-_*o*r+_*i*l-s*m*l-a*i*f+s*o*f)*b,e[3]=(u*o*r-a*c*r-u*i*l+s*c*l+a*i*d-s*o*d)*b,e[4]=y*b,e[5]=(h*m*r-p*c*r+p*i*d-t*m*d-h*i*f+t*c*f)*b,e[6]=(p*o*r-n*m*r-p*i*l+t*m*l+n*i*f-t*o*f)*b,e[7]=(n*c*r-h*o*r+h*i*l-t*c*l-n*i*d+t*o*d)*b,e[8]=S*b,e[9]=(p*u*r-h*_*r-p*s*d+t*_*d+h*s*f-t*u*f)*b,e[10]=(n*_*r-p*a*r+p*s*l-t*_*l-n*s*f+t*a*f)*b,e[11]=(h*a*r-n*u*r-h*s*l+t*u*l+n*s*d-t*a*d)*b,e[12]=T*b,e[13]=(h*_*i-p*u*i+p*s*c-t*_*c-h*s*m+t*u*m)*b,e[14]=(p*a*i-n*_*i-p*s*o+t*_*o+n*s*m-t*a*m)*b,e[15]=(n*u*i-h*a*i+h*s*o-t*u*o-n*s*c+t*a*c)*b,this}scale(e){const t=this.elements,s=e.x,i=e.y,r=e.z;return t[0]*=s,t[4]*=i,t[8]*=r,t[1]*=s,t[5]*=i,t[9]*=r,t[2]*=s,t[6]*=i,t[10]*=r,t[3]*=s,t[7]*=i,t[11]*=r,this}getMaxScaleOnAxis(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],s=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],i=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,s,i))}makeTranslation(e,t,s){return e.isVector3?this.set(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1):this.set(1,0,0,e,0,1,0,t,0,0,1,s,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),s=Math.sin(e);return this.set(1,0,0,0,0,t,-s,0,0,s,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),s=Math.sin(e);return this.set(t,0,s,0,0,1,0,0,-s,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),s=Math.sin(e);return this.set(t,-s,0,0,s,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const s=Math.cos(t),i=Math.sin(t),r=1-s,n=e.x,a=e.y,o=e.z,l=r*n,h=r*a;return this.set(l*n+s,l*a-i*o,l*o+i*a,0,l*a+i*o,h*a+s,h*o-i*n,0,l*o-i*a,h*o+i*n,r*o*o+s,0,0,0,0,1),this}makeScale(e,t,s){return this.set(e,0,0,0,0,t,0,0,0,0,s,0,0,0,0,1),this}makeShear(e,t,s,i,r,n){return this.set(1,s,r,0,e,1,n,0,t,i,1,0,0,0,0,1),this}compose(e,t,s){const i=this.elements,r=t._x,n=t._y,a=t._z,o=t._w,l=r+r,h=n+n,u=a+a,c=r*l,d=r*h,p=r*u,_=n*h,m=n*u,f=a*u,g=o*l,y=o*h,S=o*u,T=s.x,x=s.y,b=s.z;return i[0]=(1-(_+f))*T,i[1]=(d+S)*T,i[2]=(p-y)*T,i[3]=0,i[4]=(d-S)*x,i[5]=(1-(c+f))*x,i[6]=(m+g)*x,i[7]=0,i[8]=(p+y)*b,i[9]=(m-g)*b,i[10]=(1-(c+_))*b,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1,this}decompose(e,t,s){const i=this.elements;let r=ar.set(i[0],i[1],i[2]).length();const n=ar.set(i[4],i[5],i[6]).length(),a=ar.set(i[8],i[9],i[10]).length();this.determinant()<0&&(r=-r),e.x=i[12],e.y=i[13],e.z=i[14],or2.copy(this);const o=1/r,l=1/n,h=1/a;return or2.elements[0]*=o,or2.elements[1]*=o,or2.elements[2]*=o,or2.elements[4]*=l,or2.elements[5]*=l,or2.elements[6]*=l,or2.elements[8]*=h,or2.elements[9]*=h,or2.elements[10]*=h,t.setFromRotationMatrix(or2),s.x=r,s.y=n,s.z=a,this}makePerspective(e,t,s,i,r,n,a=2e3,o=!1){const l=this.elements,h=2*r/(t-e),u=2*r/(s-i),c=(t+e)/(t-e),d=(s+i)/(s-i);let p,_;if(o)p=r/(n-r),_=n*r/(n-r);else if(a===Ri)p=-(n+r)/(n-r),_=-2*n*r/(n-r);else{if(a!==Pi)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+a);p=-n/(n-r),_=-n*r/(n-r)}return l[0]=h,l[4]=0,l[8]=c,l[12]=0,l[1]=0,l[5]=u,l[9]=d,l[13]=0,l[2]=0,l[6]=0,l[10]=p,l[14]=_,l[3]=0,l[7]=0,l[11]=-1,l[15]=0,this}makeOrthographic(e,t,s,i,r,n,a=2e3,o=!1){const l=this.elements,h=2/(t-e),u=2/(s-i),c=-(t+e)/(t-e),d=-(s+i)/(s-i);let p,_;if(o)p=1/(n-r),_=n/(n-r);else if(a===Ri)p=-2/(n-r),_=-(n+r)/(n-r);else{if(a!==Pi)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+a);p=-1/(n-r),_=-r/(n-r)}return l[0]=h,l[4]=0,l[8]=0,l[12]=c,l[1]=0,l[5]=u,l[9]=0,l[13]=d,l[2]=0,l[6]=0,l[10]=p,l[14]=_,l[3]=0,l[7]=0,l[11]=0,l[15]=1,this}equals(e){const t=this.elements,s=e.elements;for(let e=0;e<16;e++)if(t[e]!==s[e])return!1;return!0}fromArray(e,t=0){for(let s=0;s<16;s++)this.elements[s]=e[s+t];return this}toArray(e=[],t=0){const s=this.elements;return e[t]=s[0],e[t+1]=s[1],e[t+2]=s[2],e[t+3]=s[3],e[t+4]=s[4],e[t+5]=s[5],e[t+6]=s[6],e[t+7]=s[7],e[t+8]=s[8],e[t+9]=s[9],e[t+10]=s[10],e[t+11]=s[11],e[t+12]=s[12],e[t+13]=s[13],e[t+14]=s[14],e[t+15]=s[15],e}},ar=new Qi,or2=new nr,hr=new Qi(0,0,0),lr=new Qi(1,1,1),cr=new Qi,ur=new Qi,dr=new Qi,pr=new nr,mr=new $i,yr=class e{constructor(t=0,s=0,i=0,r=e.DEFAULT_ORDER){this.isEuler=!0,this._x=t,this._y=s,this._z=i,this._order=r}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,t,s,i=this._order){return this._x=e,this._y=t,this._z=s,this._order=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,t=this._order,s=!0){const i=e.elements,r=i[0],n=i[4],a=i[8],o=i[1],l=i[5],h=i[9],u=i[2],c=i[6],d=i[10];switch(t){case"XYZ":this._y=Math.asin(Hi(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-h,d),this._z=Math.atan2(-n,r)):(this._x=Math.atan2(c,l),this._z=0);break;case"YXZ":this._x=Math.asin(-Hi(h,-1,1)),Math.abs(h)<.9999999?(this._y=Math.atan2(a,d),this._z=Math.atan2(o,l)):(this._y=Math.atan2(-u,r),this._z=0);break;case"ZXY":this._x=Math.asin(Hi(c,-1,1)),Math.abs(c)<.9999999?(this._y=Math.atan2(-u,d),this._z=Math.atan2(-n,l)):(this._y=0,this._z=Math.atan2(o,r));break;case"ZYX":this._y=Math.asin(-Hi(u,-1,1)),Math.abs(u)<.9999999?(this._x=Math.atan2(c,d),this._z=Math.atan2(o,r)):(this._x=0,this._z=Math.atan2(-n,l));break;case"YZX":this._z=Math.asin(Hi(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-h,l),this._y=Math.atan2(-u,r)):(this._x=0,this._y=Math.atan2(a,d));break;case"XZY":this._z=Math.asin(-Hi(n,-1,1)),Math.abs(n)<.9999999?(this._x=Math.atan2(c,l),this._y=Math.atan2(a,r)):(this._x=Math.atan2(-h,d),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+t)}return this._order=t,!0===s&&this._onChangeCallback(),this}setFromQuaternion(e,t,s){return pr.makeRotationFromQuaternion(e),this.setFromRotationMatrix(pr,t,s)}setFromVector3(e,t=this._order){return this.set(e.x,e.y,e.z,t)}reorder(e){return mr.setFromEuler(this),this.setFromQuaternion(mr,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}};yr.DEFAULT_ORDER="XYZ";var gr=class{constructor(){this.mask=1}set(e){this.mask=1<<e>>>0}enable(e){this.mask|=1<<e}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e}disable(e){this.mask&=~(1<<e)}disableAll(){this.mask=0}test(e){return 0!==(this.mask&e.mask)}isEnabled(e){return!!(this.mask&1<<e)}},fr=0,xr=new Qi,br=new $i,vr=new nr,wr=new Qi,Mr=new Qi,Sr=new Qi,_r=new $i,Ar=new Qi(1,0,0),Tr=new Qi(0,1,0),zr=new Qi(0,0,1),Cr={type:"added"},Ir={type:"removed"},Br={type:"childadded",child:null},kr={type:"childremoved",child:null},Er=class e extends Fi{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:fr++}),this.uuid=Ui(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=e.DEFAULT_UP.clone();const t=new Qi,s=new yr,i=new $i,r=new Qi(1,1,1);s._onChange(function(){i.setFromEuler(s,!1)}),i._onChange(function(){s.setFromQuaternion(i,void 0,!1)}),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:s},quaternion:{configurable:!0,enumerable:!0,value:i},scale:{configurable:!0,enumerable:!0,value:r},modelViewMatrix:{value:new nr},normalMatrix:{value:new es}}),this.matrix=new nr,this.matrixWorld=new nr,this.matrixAutoUpdate=e.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=e.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new gr,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.customDepthMaterial=void 0,this.customDistanceMaterial=void 0,this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return br.setFromAxisAngle(e,t),this.quaternion.multiply(br),this}rotateOnWorldAxis(e,t){return br.setFromAxisAngle(e,t),this.quaternion.premultiply(br),this}rotateX(e){return this.rotateOnAxis(Ar,e)}rotateY(e){return this.rotateOnAxis(Tr,e)}rotateZ(e){return this.rotateOnAxis(zr,e)}translateOnAxis(e,t){return xr.copy(e).applyQuaternion(this.quaternion),this.position.add(xr.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(Ar,e)}translateY(e){return this.translateOnAxis(Tr,e)}translateZ(e){return this.translateOnAxis(zr,e)}localToWorld(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(vr.copy(this.matrixWorld).invert())}lookAt(e,t,s){e.isVector3?wr.copy(e):wr.set(e,t,s);const i=this.parent;this.updateWorldMatrix(!0,!1),Mr.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?vr.lookAt(Mr,wr,this.up):vr.lookAt(wr,Mr,this.up),this.quaternion.setFromRotationMatrix(vr),i&&(vr.extractRotation(i.matrixWorld),br.setFromRotationMatrix(vr),this.quaternion.premultiply(br.invert()))}add(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(e.removeFromParent(),e.parent=this,this.children.push(e),e.dispatchEvent(Cr),Br.child=e,this.dispatchEvent(Br),Br.child=null):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)}remove(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}const t=this.children.indexOf(e);return-1!==t&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(Ir),kr.child=e,this.dispatchEvent(kr),kr.child=null),this}removeFromParent(){const e=this.parent;return null!==e&&e.remove(this),this}clear(){return this.remove(...this.children)}attach(e){return this.updateWorldMatrix(!0,!1),vr.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),vr.multiply(e.parent.matrixWorld)),e.applyMatrix4(vr),e.removeFromParent(),e.parent=this,this.children.push(e),e.updateWorldMatrix(!1,!0),e.dispatchEvent(Cr),Br.child=e,this.dispatchEvent(Br),Br.child=null,this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,t){if(this[e]===t)return this;for(let s=0,i=this.children.length;s<i;s++){const i=this.children[s].getObjectByProperty(e,t);if(void 0!==i)return i}}getObjectsByProperty(e,t,s=[]){this[e]===t&&s.push(this);const i=this.children;for(let r=0,n=i.length;r<n;r++)i[r].getObjectsByProperty(e,t,s);return s}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Mr,e,Sr),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Mr,_r,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}raycast(){}traverse(e){e(this);const t=this.children;for(let s=0,i=t.length;s<i;s++)t[s].traverse(e)}traverseVisible(e){if(!1===this.visible)return;e(this);const t=this.children;for(let s=0,i=t.length;s<i;s++)t[s].traverseVisible(e)}traverseAncestors(e){const t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;for(let s=0,i=t.length;s<i;s++)t[s].updateMatrixWorld(e)}updateWorldMatrix(e,t){const s=this.parent;if(!0===e&&null!==s&&s.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),!0===t){const e=this.children;for(let t=0,s=e.length;t<s;t++)e[t].updateWorldMatrix(!1,!0)}}toJSON(e){const t=void 0===e||"string"==typeof e,s={};t&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},s.metadata={version:4.7,type:"Object",generator:"Object3D.toJSON"});const i={};function r(t,s){return void 0===t[s.uuid]&&(t[s.uuid]=s.toJSON(e)),s.uuid}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),!0===this.castShadow&&(i.castShadow=!0),!0===this.receiveShadow&&(i.receiveShadow=!0),!1===this.visible&&(i.visible=!1),!1===this.frustumCulled&&(i.frustumCulled=!1),0!==this.renderOrder&&(i.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(i.userData=this.userData),i.layers=this.layers.mask,i.matrix=this.matrix.toArray(),i.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(i.matrixAutoUpdate=!1),this.isInstancedMesh&&(i.type="InstancedMesh",i.count=this.count,i.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(i.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(i.type="BatchedMesh",i.perObjectFrustumCulled=this.perObjectFrustumCulled,i.sortObjects=this.sortObjects,i.drawRanges=this._drawRanges,i.reservedRanges=this._reservedRanges,i.geometryInfo=this._geometryInfo.map(e=>({...e,boundingBox:e.boundingBox?e.boundingBox.toJSON():void 0,boundingSphere:e.boundingSphere?e.boundingSphere.toJSON():void 0})),i.instanceInfo=this._instanceInfo.map(e=>({...e})),i.availableInstanceIds=this._availableInstanceIds.slice(),i.availableGeometryIds=this._availableGeometryIds.slice(),i.nextIndexStart=this._nextIndexStart,i.nextVertexStart=this._nextVertexStart,i.geometryCount=this._geometryCount,i.maxInstanceCount=this._maxInstanceCount,i.maxVertexCount=this._maxVertexCount,i.maxIndexCount=this._maxIndexCount,i.geometryInitialized=this._geometryInitialized,i.matricesTexture=this._matricesTexture.toJSON(e),i.indirectTexture=this._indirectTexture.toJSON(e),null!==this._colorsTexture&&(i.colorsTexture=this._colorsTexture.toJSON(e)),null!==this.boundingSphere&&(i.boundingSphere=this.boundingSphere.toJSON()),null!==this.boundingBox&&(i.boundingBox=this.boundingBox.toJSON())),this.isScene)this.background&&(this.background.isColor?i.background=this.background.toJSON():this.background.isTexture&&(i.background=this.background.toJSON(e).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(i.environment=this.environment.toJSON(e).uuid);else if(this.isMesh||this.isLine||this.isPoints){i.geometry=r(e.geometries,this.geometry);const t=this.geometry.parameters;if(void 0!==t&&void 0!==t.shapes){const s=t.shapes;if(Array.isArray(s))for(let t=0,i=s.length;t<i;t++){const i=s[t];r(e.shapes,i)}else r(e.shapes,s)}}if(this.isSkinnedMesh&&(i.bindMode=this.bindMode,i.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(r(e.skeletons,this.skeleton),i.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const t=[];for(let s=0,i=this.material.length;s<i;s++)t.push(r(e.materials,this.material[s]));i.material=t}else i.material=r(e.materials,this.material);if(this.children.length>0){i.children=[];for(let t=0;t<this.children.length;t++)i.children.push(this.children[t].toJSON(e).object)}if(this.animations.length>0){i.animations=[];for(let t=0;t<this.animations.length;t++){const s=this.animations[t];i.animations.push(r(e.animations,s))}}if(t){const t=n(e.geometries),i=n(e.materials),r=n(e.textures),a=n(e.images),o=n(e.shapes),l=n(e.skeletons),h=n(e.animations),u=n(e.nodes);t.length>0&&(s.geometries=t),i.length>0&&(s.materials=i),r.length>0&&(s.textures=r),a.length>0&&(s.images=a),o.length>0&&(s.shapes=o),l.length>0&&(s.skeletons=l),h.length>0&&(s.animations=h),u.length>0&&(s.nodes=u)}return s.object=i,s;function n(e){const t=[];for(const s in e){const i=e[s];delete i.metadata,t.push(i)}return t}}clone(e){return(new this.constructor).copy(this,e)}copy(e,t=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldAutoUpdate=e.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.animations=e.animations.slice(),this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(let t=0;t<e.children.length;t++){const s=e.children[t];this.add(s.clone())}return this}};Er.DEFAULT_UP=new Qi(0,1,0),Er.DEFAULT_MATRIX_AUTO_UPDATE=!0,Er.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;var Rr=new Qi,Pr=new Qi,Or=new Qi,Nr=new Qi,Vr=new Qi,Fr=new Qi,Lr=new Qi,jr=new Qi,Wr=new Qi,Dr=new Qi,Ur=new As,Hr=new As,qr=new As,Jr=class e{constructor(e=new Qi,t=new Qi,s=new Qi){this.a=e,this.b=t,this.c=s}static getNormal(e,t,s,i){i.subVectors(s,t),Rr.subVectors(e,t),i.cross(Rr);const r=i.lengthSq();return r>0?i.multiplyScalar(1/Math.sqrt(r)):i.set(0,0,0)}static getBarycoord(e,t,s,i,r){Rr.subVectors(i,t),Pr.subVectors(s,t),Or.subVectors(e,t);const n=Rr.dot(Rr),a=Rr.dot(Pr),o=Rr.dot(Or),l=Pr.dot(Pr),h=Pr.dot(Or),u=n*l-a*a;if(0===u)return r.set(0,0,0),null;const c=1/u,d=(l*o-a*h)*c,p=(n*h-a*o)*c;return r.set(1-d-p,p,d)}static containsPoint(e,t,s,i){return null!==this.getBarycoord(e,t,s,i,Nr)&&Nr.x>=0&&Nr.y>=0&&Nr.x+Nr.y<=1}static getInterpolation(e,t,s,i,r,n,a,o){return null===this.getBarycoord(e,t,s,i,Nr)?(o.x=0,o.y=0,"z"in o&&(o.z=0),"w"in o&&(o.w=0),null):(o.setScalar(0),o.addScaledVector(r,Nr.x),o.addScaledVector(n,Nr.y),o.addScaledVector(a,Nr.z),o)}static getInterpolatedAttribute(e,t,s,i,r,n){return Ur.setScalar(0),Hr.setScalar(0),qr.setScalar(0),Ur.fromBufferAttribute(e,t),Hr.fromBufferAttribute(e,s),qr.fromBufferAttribute(e,i),n.setScalar(0),n.addScaledVector(Ur,r.x),n.addScaledVector(Hr,r.y),n.addScaledVector(qr,r.z),n}static isFrontFacing(e,t,s,i){return Rr.subVectors(s,t),Pr.subVectors(e,t),Rr.cross(Pr).dot(i)<0}set(e,t,s){return this.a.copy(e),this.b.copy(t),this.c.copy(s),this}setFromPointsAndIndices(e,t,s,i){return this.a.copy(e[t]),this.b.copy(e[s]),this.c.copy(e[i]),this}setFromAttributeAndIndices(e,t,s,i){return this.a.fromBufferAttribute(e,t),this.b.fromBufferAttribute(e,s),this.c.fromBufferAttribute(e,i),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return Rr.subVectors(this.c,this.b),Pr.subVectors(this.a,this.b),.5*Rr.cross(Pr).length()}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(t){return e.getNormal(this.a,this.b,this.c,t)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(t,s){return e.getBarycoord(t,this.a,this.b,this.c,s)}getInterpolation(t,s,i,r,n){return e.getInterpolation(t,this.a,this.b,this.c,s,i,r,n)}containsPoint(t){return e.containsPoint(t,this.a,this.b,this.c)}isFrontFacing(t){return e.isFrontFacing(this.a,this.b,this.c,t)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,t){const s=this.a,i=this.b,r=this.c;let n,a;Vr.subVectors(i,s),Fr.subVectors(r,s),jr.subVectors(e,s);const o=Vr.dot(jr),l=Fr.dot(jr);if(o<=0&&l<=0)return t.copy(s);Wr.subVectors(e,i);const h=Vr.dot(Wr),u=Fr.dot(Wr);if(h>=0&&u<=h)return t.copy(i);const c=o*u-h*l;if(c<=0&&o>=0&&h<=0)return n=o/(o-h),t.copy(s).addScaledVector(Vr,n);Dr.subVectors(e,r);const d=Vr.dot(Dr),p=Fr.dot(Dr);if(p>=0&&d<=p)return t.copy(r);const _=d*l-o*p;if(_<=0&&l>=0&&p<=0)return a=l/(l-p),t.copy(s).addScaledVector(Fr,a);const m=h*p-d*u;if(m<=0&&u-h>=0&&d-p>=0)return Lr.subVectors(r,i),a=(u-h)/(u-h+(d-p)),t.copy(i).addScaledVector(Lr,a);const f=1/(m+_+c);return n=_*f,a=c*f,t.copy(s).addScaledVector(Vr,n).addScaledVector(Fr,a)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}},Xr={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},Yr={h:0,s:0,l:0},Zr={h:0,s:0,l:0};function Gr(e,t,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?e+6*(t-e)*s:s<.5?t:s<2/3?e+6*(t-e)*(2/3-s):e}var $r=class{constructor(e,t,s){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(e,t,s)}set(e,t,s){if(void 0===t&&void 0===s){const t=e;t&&t.isColor?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t)}else this.setRGB(e,t,s);return this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e,t=Ye){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,ms.colorSpaceToWorking(this,t),this}setRGB(e,t,s,i=ms.workingColorSpace){return this.r=e,this.g=t,this.b=s,ms.colorSpaceToWorking(this,i),this}setHSL(e,t,s,i=ms.workingColorSpace){if(e=qi(e,1),t=Hi(t,0,1),s=Hi(s,0,1),0===t)this.r=this.g=this.b=s;else{const i=s<=.5?s*(1+t):s+t-s*t,r=2*s-i;this.r=Gr(r,i,e+1/3),this.g=Gr(r,i,e),this.b=Gr(r,i,e-1/3)}return ms.colorSpaceToWorking(this,i),this}setStyle(e,t=Ye){function s(t){void 0!==t&&parseFloat(t)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}let i;if(i=/^(\w+)\(([^\)]*)\)/.exec(e)){let r;const n=i[1],a=i[2];switch(n){case"rgb":case"rgba":if(r=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return s(r[4]),this.setRGB(Math.min(255,parseInt(r[1],10))/255,Math.min(255,parseInt(r[2],10))/255,Math.min(255,parseInt(r[3],10))/255,t);if(r=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return s(r[4]),this.setRGB(Math.min(100,parseInt(r[1],10))/100,Math.min(100,parseInt(r[2],10))/100,Math.min(100,parseInt(r[3],10))/100,t);break;case"hsl":case"hsla":if(r=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return s(r[4]),this.setHSL(parseFloat(r[1])/360,parseFloat(r[2])/100,parseFloat(r[3])/100,t);break;default:console.warn("THREE.Color: Unknown color model "+e)}}else if(i=/^\#([A-Fa-f\d]+)$/.exec(e)){const s=i[1],r=s.length;if(3===r)return this.setRGB(parseInt(s.charAt(0),16)/15,parseInt(s.charAt(1),16)/15,parseInt(s.charAt(2),16)/15,t);if(6===r)return this.setHex(parseInt(s,16),t);console.warn("THREE.Color: Invalid hex color "+e)}else if(e&&e.length>0)return this.setColorName(e,t);return this}setColorName(e,t=Ye){const s=Xr[e.toLowerCase()];return void 0!==s?this.setHex(s,t):console.warn("THREE.Color: Unknown color "+e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copySRGBToLinear(e){return this.r=ys(e.r),this.g=ys(e.g),this.b=ys(e.b),this}copyLinearToSRGB(e){return this.r=gs(e.r),this.g=gs(e.g),this.b=gs(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(e=Ye){return ms.workingToColorSpace(Qr.copy(this),e),65536*Math.round(Hi(255*Qr.r,0,255))+256*Math.round(Hi(255*Qr.g,0,255))+Math.round(Hi(255*Qr.b,0,255))}getHexString(e=Ye){return("000000"+this.getHex(e).toString(16)).slice(-6)}getHSL(e,t=ms.workingColorSpace){ms.workingToColorSpace(Qr.copy(this),t);const s=Qr.r,i=Qr.g,r=Qr.b,n=Math.max(s,i,r),a=Math.min(s,i,r);let o,l;const h=(a+n)/2;if(a===n)o=0,l=0;else{const e=n-a;switch(l=h<=.5?e/(n+a):e/(2-n-a),n){case s:o=(i-r)/e+(i<r?6:0);break;case i:o=(r-s)/e+2;break;case r:o=(s-i)/e+4}o/=6}return e.h=o,e.s=l,e.l=h,e}getRGB(e,t=ms.workingColorSpace){return ms.workingToColorSpace(Qr.copy(this),t),e.r=Qr.r,e.g=Qr.g,e.b=Qr.b,e}getStyle(e=Ye){ms.workingToColorSpace(Qr.copy(this),e);const t=Qr.r,s=Qr.g,i=Qr.b;return e!==Ye?`color(${e} ${t.toFixed(3)} ${s.toFixed(3)} ${i.toFixed(3)})`:`rgb(${Math.round(255*t)},${Math.round(255*s)},${Math.round(255*i)})`}offsetHSL(e,t,s){return this.getHSL(Yr),this.setHSL(Yr.h+e,Yr.s+t,Yr.l+s)}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}lerpColors(e,t,s){return this.r=e.r+(t.r-e.r)*s,this.g=e.g+(t.g-e.g)*s,this.b=e.b+(t.b-e.b)*s,this}lerpHSL(e,t){this.getHSL(Yr),e.getHSL(Zr);const s=Ji(Yr.h,Zr.h,t),i=Ji(Yr.s,Zr.s,t),r=Ji(Yr.l,Zr.l,t);return this.setHSL(s,i,r),this}setFromVector3(e){return this.r=e.x,this.g=e.y,this.b=e.z,this}applyMatrix3(e){const t=this.r,s=this.g,i=this.b,r=e.elements;return this.r=r[0]*t+r[3]*s+r[6]*i,this.g=r[1]*t+r[4]*s+r[7]*i,this.b=r[2]*t+r[5]*s+r[8]*i,this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this}toArray(e=[],t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}fromBufferAttribute(e,t){return this.r=e.getX(t),this.g=e.getY(t),this.b=e.getZ(t),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}},Qr=new $r;$r.NAMES=Xr;var Kr=0,tn=class extends Fi{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:Kr++}),this.uuid=Ui(),this.name="",this.type="Material",this.blending=1,this.side=0,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=204,this.blendDst=205,this.blendEquation=100,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new $r(0,0,0),this.blendAlpha=0,this.depthFunc=3,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=Ke,this.stencilZFail=Ke,this.stencilZPass=Ke,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.allowOverride=!0,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(e){this._alphaTest>0!=e>0&&this.version++,this._alphaTest=e}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(void 0!==e)for(const t in e){const s=e[t];if(void 0===s){console.warn(`THREE.Material: parameter '${t}' has value of undefined.`);continue}const i=this[t];void 0!==i?i&&i.isColor?i.set(s):i&&i.isVector3&&s&&s.isVector3?i.copy(s):this[t]=s:console.warn(`THREE.Material: '${t}' is not a property of THREE.${this.type}.`)}}toJSON(e){const t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{}});const s={metadata:{version:4.7,type:"Material",generator:"Material.toJSON"}};function i(e){const t=[];for(const s in e){const i=e[s];delete i.metadata,t.push(i)}return t}if(s.uuid=this.uuid,s.type=this.type,""!==this.name&&(s.name=this.name),this.color&&this.color.isColor&&(s.color=this.color.getHex()),void 0!==this.roughness&&(s.roughness=this.roughness),void 0!==this.metalness&&(s.metalness=this.metalness),void 0!==this.sheen&&(s.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(s.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(s.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(s.emissive=this.emissive.getHex()),void 0!==this.emissiveIntensity&&1!==this.emissiveIntensity&&(s.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(s.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(s.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(s.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(s.shininess=this.shininess),void 0!==this.clearcoat&&(s.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(s.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(s.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(s.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(s.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,s.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),void 0!==this.dispersion&&(s.dispersion=this.dispersion),void 0!==this.iridescence&&(s.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(s.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(s.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(s.iridescenceMap=this.iridescenceMap.toJSON(e).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(s.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(e).uuid),void 0!==this.anisotropy&&(s.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(s.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(s.anisotropyMap=this.anisotropyMap.toJSON(e).uuid),this.map&&this.map.isTexture&&(s.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(s.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(s.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(s.lightMap=this.lightMap.toJSON(e).uuid,s.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(s.aoMap=this.aoMap.toJSON(e).uuid,s.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(s.bumpMap=this.bumpMap.toJSON(e).uuid,s.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(s.normalMap=this.normalMap.toJSON(e).uuid,s.normalMapType=this.normalMapType,s.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(s.displacementMap=this.displacementMap.toJSON(e).uuid,s.displacementScale=this.displacementScale,s.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(s.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(s.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(s.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(s.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(s.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(s.specularColorMap=this.specularColorMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(s.envMap=this.envMap.toJSON(e).uuid,void 0!==this.combine&&(s.combine=this.combine)),void 0!==this.envMapRotation&&(s.envMapRotation=this.envMapRotation.toArray()),void 0!==this.envMapIntensity&&(s.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(s.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(s.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(s.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.transmission&&(s.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(s.transmissionMap=this.transmissionMap.toJSON(e).uuid),void 0!==this.thickness&&(s.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(s.thicknessMap=this.thicknessMap.toJSON(e).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(s.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(s.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(s.size=this.size),null!==this.shadowSide&&(s.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(s.sizeAttenuation=this.sizeAttenuation),1!==this.blending&&(s.blending=this.blending),0!==this.side&&(s.side=this.side),!0===this.vertexColors&&(s.vertexColors=!0),this.opacity<1&&(s.opacity=this.opacity),!0===this.transparent&&(s.transparent=!0),204!==this.blendSrc&&(s.blendSrc=this.blendSrc),205!==this.blendDst&&(s.blendDst=this.blendDst),100!==this.blendEquation&&(s.blendEquation=this.blendEquation),null!==this.blendSrcAlpha&&(s.blendSrcAlpha=this.blendSrcAlpha),null!==this.blendDstAlpha&&(s.blendDstAlpha=this.blendDstAlpha),null!==this.blendEquationAlpha&&(s.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(s.blendColor=this.blendColor.getHex()),0!==this.blendAlpha&&(s.blendAlpha=this.blendAlpha),3!==this.depthFunc&&(s.depthFunc=this.depthFunc),!1===this.depthTest&&(s.depthTest=this.depthTest),!1===this.depthWrite&&(s.depthWrite=this.depthWrite),!1===this.colorWrite&&(s.colorWrite=this.colorWrite),255!==this.stencilWriteMask&&(s.stencilWriteMask=this.stencilWriteMask),519!==this.stencilFunc&&(s.stencilFunc=this.stencilFunc),0!==this.stencilRef&&(s.stencilRef=this.stencilRef),255!==this.stencilFuncMask&&(s.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==Ke&&(s.stencilFail=this.stencilFail),this.stencilZFail!==Ke&&(s.stencilZFail=this.stencilZFail),this.stencilZPass!==Ke&&(s.stencilZPass=this.stencilZPass),!0===this.stencilWrite&&(s.stencilWrite=this.stencilWrite),void 0!==this.rotation&&0!==this.rotation&&(s.rotation=this.rotation),!0===this.polygonOffset&&(s.polygonOffset=!0),0!==this.polygonOffsetFactor&&(s.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(s.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(s.linewidth=this.linewidth),void 0!==this.dashSize&&(s.dashSize=this.dashSize),void 0!==this.gapSize&&(s.gapSize=this.gapSize),void 0!==this.scale&&(s.scale=this.scale),!0===this.dithering&&(s.dithering=!0),this.alphaTest>0&&(s.alphaTest=this.alphaTest),!0===this.alphaHash&&(s.alphaHash=!0),!0===this.alphaToCoverage&&(s.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(s.premultipliedAlpha=!0),!0===this.forceSinglePass&&(s.forceSinglePass=!0),!0===this.wireframe&&(s.wireframe=!0),this.wireframeLinewidth>1&&(s.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(s.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(s.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(s.flatShading=!0),!1===this.visible&&(s.visible=!1),!1===this.toneMapped&&(s.toneMapped=!1),!1===this.fog&&(s.fog=!1),Object.keys(this.userData).length>0&&(s.userData=this.userData),t){const t=i(e.textures),r=i(e.images);t.length>0&&(s.textures=t),r.length>0&&(s.images=r)}return s}clone(){return(new this.constructor).copy(this)}copy(e){this.name=e.name,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.blendColor.copy(e.blendColor),this.blendAlpha=e.blendAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;const t=e.clippingPlanes;let s=null;if(null!==t){const e=t.length;s=new Array(e);for(let i=0;i!==e;++i)s[i]=t[i].clone()}return this.clippingPlanes=s,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaHash=e.alphaHash,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.forceSinglePass=e.forceSinglePass,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){!0===e&&this.version++}},en=class extends tn{constructor(e){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new $r(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new yr,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}},sn=rn();function rn(){const e=new ArrayBuffer(4),t=new Float32Array(e),s=new Uint32Array(e),i=new Uint32Array(512),r=new Uint32Array(512);for(let e=0;e<256;++e){const t=e-127;t<-27?(i[e]=0,i[256|e]=32768,r[e]=24,r[256|e]=24):t<-14?(i[e]=1024>>-t-14,i[256|e]=1024>>-t-14|32768,r[e]=-t-1,r[256|e]=-t-1):t<=15?(i[e]=t+15<<10,i[256|e]=t+15<<10|32768,r[e]=13,r[256|e]=13):t<128?(i[e]=31744,i[256|e]=64512,r[e]=24,r[256|e]=24):(i[e]=31744,i[256|e]=64512,r[e]=13,r[256|e]=13)}const n=new Uint32Array(2048),a=new Uint32Array(64),o=new Uint32Array(64);for(let e=1;e<1024;++e){let t=e<<13,s=0;for(;!(8388608&t);)t<<=1,s-=8388608;t&=-8388609,s+=947912704,n[e]=t|s}for(let e=1024;e<2048;++e)n[e]=939524096+(e-1024<<13);for(let e=1;e<31;++e)a[e]=e<<23;a[31]=1199570944,a[32]=2147483648;for(let e=33;e<63;++e)a[e]=2147483648+(e-32<<23);a[63]=3347054592;for(let e=1;e<64;++e)32!==e&&(o[e]=1024);return{floatView:t,uint32View:s,baseTable:i,shiftTable:r,mantissaTable:n,exponentTable:a,offsetTable:o}}function nn(e){Math.abs(e)>65504&&console.warn("THREE.DataUtils.toHalfFloat(): Value out of range."),e=Hi(e,-65504,65504),sn.floatView[0]=e;const t=sn.uint32View[0],s=t>>23&511;return sn.baseTable[s]+((8388607&t)>>sn.shiftTable[s])}function an(e){const t=e>>10;return sn.uint32View[0]=sn.mantissaTable[sn.offsetTable[t]+(1023&e)]+sn.exponentTable[t],sn.floatView[0]}var hn=new Qi,ln2=new Gi,cn=0,un=class{constructor(e,t,s=!1){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,Object.defineProperty(this,"id",{value:cn++}),this.name="",this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=s,this.usage=Mi,this.updateRanges=[],this.gpuType=Et,this.version=0}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this.gpuType=e.gpuType,this}copyAt(e,t,s){e*=this.itemSize,s*=t.itemSize;for(let i=0,r=this.itemSize;i<r;i++)this.array[e+i]=t.array[s+i];return this}copyArray(e){return this.array.set(e),this}applyMatrix3(e){if(2===this.itemSize)for(let t=0,s=this.count;t<s;t++)ln2.fromBufferAttribute(this,t),ln2.applyMatrix3(e),this.setXY(t,ln2.x,ln2.y);else if(3===this.itemSize)for(let t=0,s=this.count;t<s;t++)hn.fromBufferAttribute(this,t),hn.applyMatrix3(e),this.setXYZ(t,hn.x,hn.y,hn.z);return this}applyMatrix4(e){for(let t=0,s=this.count;t<s;t++)hn.fromBufferAttribute(this,t),hn.applyMatrix4(e),this.setXYZ(t,hn.x,hn.y,hn.z);return this}applyNormalMatrix(e){for(let t=0,s=this.count;t<s;t++)hn.fromBufferAttribute(this,t),hn.applyNormalMatrix(e),this.setXYZ(t,hn.x,hn.y,hn.z);return this}transformDirection(e){for(let t=0,s=this.count;t<s;t++)hn.fromBufferAttribute(this,t),hn.transformDirection(e),this.setXYZ(t,hn.x,hn.y,hn.z);return this}set(e,t=0){return this.array.set(e,t),this}getComponent(e,t){let s=this.array[e*this.itemSize+t];return this.normalized&&(s=Xi(s,this.array)),s}setComponent(e,t,s){return this.normalized&&(s=Yi(s,this.array)),this.array[e*this.itemSize+t]=s,this}getX(e){let t=this.array[e*this.itemSize];return this.normalized&&(t=Xi(t,this.array)),t}setX(e,t){return this.normalized&&(t=Yi(t,this.array)),this.array[e*this.itemSize]=t,this}getY(e){let t=this.array[e*this.itemSize+1];return this.normalized&&(t=Xi(t,this.array)),t}setY(e,t){return this.normalized&&(t=Yi(t,this.array)),this.array[e*this.itemSize+1]=t,this}getZ(e){let t=this.array[e*this.itemSize+2];return this.normalized&&(t=Xi(t,this.array)),t}setZ(e,t){return this.normalized&&(t=Yi(t,this.array)),this.array[e*this.itemSize+2]=t,this}getW(e){let t=this.array[e*this.itemSize+3];return this.normalized&&(t=Xi(t,this.array)),t}setW(e,t){return this.normalized&&(t=Yi(t,this.array)),this.array[e*this.itemSize+3]=t,this}setXY(e,t,s){return e*=this.itemSize,this.normalized&&(t=Yi(t,this.array),s=Yi(s,this.array)),this.array[e+0]=t,this.array[e+1]=s,this}setXYZ(e,t,s,i){return e*=this.itemSize,this.normalized&&(t=Yi(t,this.array),s=Yi(s,this.array),i=Yi(i,this.array)),this.array[e+0]=t,this.array[e+1]=s,this.array[e+2]=i,this}setXYZW(e,t,s,i,r){return e*=this.itemSize,this.normalized&&(t=Yi(t,this.array),s=Yi(s,this.array),i=Yi(i,this.array),r=Yi(r,this.array)),this.array[e+0]=t,this.array[e+1]=s,this.array[e+2]=i,this.array[e+3]=r,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(e.name=this.name),this.usage!==Mi&&(e.usage=this.usage),e}},gn=class extends un{constructor(e,t,s){super(new Uint16Array(e),t,s)}},xn=class extends un{constructor(e,t,s){super(new Uint32Array(e),t,s)}},bn=class extends un{constructor(e,t,s){super(new Uint16Array(e),t,s),this.isFloat16BufferAttribute=!0}getX(e){let t=an(this.array[e*this.itemSize]);return this.normalized&&(t=Xi(t,this.array)),t}setX(e,t){return this.normalized&&(t=Yi(t,this.array)),this.array[e*this.itemSize]=nn(t),this}getY(e){let t=an(this.array[e*this.itemSize+1]);return this.normalized&&(t=Xi(t,this.array)),t}setY(e,t){return this.normalized&&(t=Yi(t,this.array)),this.array[e*this.itemSize+1]=nn(t),this}getZ(e){let t=an(this.array[e*this.itemSize+2]);return this.normalized&&(t=Xi(t,this.array)),t}setZ(e,t){return this.normalized&&(t=Yi(t,this.array)),this.array[e*this.itemSize+2]=nn(t),this}getW(e){let t=an(this.array[e*this.itemSize+3]);return this.normalized&&(t=Xi(t,this.array)),t}setW(e,t){return this.normalized&&(t=Yi(t,this.array)),this.array[e*this.itemSize+3]=nn(t),this}setXY(e,t,s){return e*=this.itemSize,this.normalized&&(t=Yi(t,this.array),s=Yi(s,this.array)),this.array[e+0]=nn(t),this.array[e+1]=nn(s),this}setXYZ(e,t,s,i){return e*=this.itemSize,this.normalized&&(t=Yi(t,this.array),s=Yi(s,this.array),i=Yi(i,this.array)),this.array[e+0]=nn(t),this.array[e+1]=nn(s),this.array[e+2]=nn(i),this}setXYZW(e,t,s,i,r){return e*=this.itemSize,this.normalized&&(t=Yi(t,this.array),s=Yi(s,this.array),i=Yi(i,this.array),r=Yi(r,this.array)),this.array[e+0]=nn(t),this.array[e+1]=nn(s),this.array[e+2]=nn(i),this.array[e+3]=nn(r),this}},vn=class extends un{constructor(e,t,s){super(new Float32Array(e),t,s)}},wn=0,Mn=new nr,Sn=new Er,_n=new Qi,An=new Es,Tn=new Es,zn=new Qi,Cn=class e extends Fi{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:wn++}),this.uuid=Ui(),this.name="",this.type="BufferGeometry",this.index=null,this.indirect=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(e){return Array.isArray(e)?this.index=new(ss(e)?xn:gn)(e,1):this.index=e,this}setIndirect(e){return this.indirect=e,this}getIndirect(){return this.indirect}getAttribute(e){return this.attributes[e]}setAttribute(e,t){return this.attributes[e]=t,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return void 0!==this.attributes[e]}addGroup(e,t,s=0){this.groups.push({start:e,count:t,materialIndex:s})}clearGroups(){this.groups=[]}setDrawRange(e,t){this.drawRange.start=e,this.drawRange.count=t}applyMatrix4(e){const t=this.attributes.position;void 0!==t&&(t.applyMatrix4(e),t.needsUpdate=!0);const s=this.attributes.normal;if(void 0!==s){const t=(new es).getNormalMatrix(e);s.applyNormalMatrix(t),s.needsUpdate=!0}const i=this.attributes.tangent;return void 0!==i&&(i.transformDirection(e),i.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(e){return Mn.makeRotationFromQuaternion(e),this.applyMatrix4(Mn),this}rotateX(e){return Mn.makeRotationX(e),this.applyMatrix4(Mn),this}rotateY(e){return Mn.makeRotationY(e),this.applyMatrix4(Mn),this}rotateZ(e){return Mn.makeRotationZ(e),this.applyMatrix4(Mn),this}translate(e,t,s){return Mn.makeTranslation(e,t,s),this.applyMatrix4(Mn),this}scale(e,t,s){return Mn.makeScale(e,t,s),this.applyMatrix4(Mn),this}lookAt(e){return Sn.lookAt(e),Sn.updateMatrix(),this.applyMatrix4(Sn.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(_n).negate(),this.translate(_n.x,_n.y,_n.z),this}setFromPoints(e){const t=this.getAttribute("position");if(void 0===t){const t=[];for(let s=0,i=e.length;s<i;s++){const i=e[s];t.push(i.x,i.y,i.z||0)}this.setAttribute("position",new vn(t,3))}else{const s=Math.min(e.length,t.count);for(let i=0;i<s;i++){const s=e[i];t.setXYZ(i,s.x,s.y,s.z||0)}e.length>t.count&&console.warn("THREE.BufferGeometry: Buffer size too small for points data. Use .dispose() and create a new geometry."),t.needsUpdate=!0}return this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new Es);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error("THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box.",this),void this.boundingBox.set(new Qi(-1/0,-1/0,-1/0),new Qi(1/0,1/0,1/0));if(void 0!==e){if(this.boundingBox.setFromBufferAttribute(e),t)for(let e=0,s=t.length;e<s;e++){const s=t[e];An.setFromBufferAttribute(s),this.morphTargetsRelative?(zn.addVectors(this.boundingBox.min,An.min),this.boundingBox.expandByPoint(zn),zn.addVectors(this.boundingBox.max,An.max),this.boundingBox.expandByPoint(zn)):(this.boundingBox.expandByPoint(An.min),this.boundingBox.expandByPoint(An.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new Gs);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error("THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere.",this),void this.boundingSphere.set(new Qi,1/0);if(e){const s=this.boundingSphere.center;if(An.setFromBufferAttribute(e),t)for(let e=0,s=t.length;e<s;e++){const s=t[e];Tn.setFromBufferAttribute(s),this.morphTargetsRelative?(zn.addVectors(An.min,Tn.min),An.expandByPoint(zn),zn.addVectors(An.max,Tn.max),An.expandByPoint(zn)):(An.expandByPoint(Tn.min),An.expandByPoint(Tn.max))}An.getCenter(s);let i=0;for(let t=0,r=e.count;t<r;t++)zn.fromBufferAttribute(e,t),i=Math.max(i,s.distanceToSquared(zn));if(t)for(let r=0,n=t.length;r<n;r++){const n=t[r],a=this.morphTargetsRelative;for(let t=0,r=n.count;t<r;t++)zn.fromBufferAttribute(n,t),a&&(_n.fromBufferAttribute(e,t),zn.add(_n)),i=Math.max(i,s.distanceToSquared(zn))}this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){const e=this.index,t=this.attributes;if(null===e||void 0===t.position||void 0===t.normal||void 0===t.uv)return void console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");const s=t.position,i=t.normal,r=t.uv;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new un(new Float32Array(4*s.count),4));const n=this.getAttribute("tangent"),a=[],o=[];for(let e=0;e<s.count;e++)a[e]=new Qi,o[e]=new Qi;const l=new Qi,h=new Qi,u=new Qi,c=new Gi,d=new Gi,p=new Gi,_=new Qi,m=new Qi;function f(e,t,i){l.fromBufferAttribute(s,e),h.fromBufferAttribute(s,t),u.fromBufferAttribute(s,i),c.fromBufferAttribute(r,e),d.fromBufferAttribute(r,t),p.fromBufferAttribute(r,i),h.sub(l),u.sub(l),d.sub(c),p.sub(c);const n=1/(d.x*p.y-p.x*d.y);isFinite(n)&&(_.copy(h).multiplyScalar(p.y).addScaledVector(u,-d.y).multiplyScalar(n),m.copy(u).multiplyScalar(d.x).addScaledVector(h,-p.x).multiplyScalar(n),a[e].add(_),a[t].add(_),a[i].add(_),o[e].add(m),o[t].add(m),o[i].add(m))}let g=this.groups;0===g.length&&(g=[{start:0,count:e.count}]);for(let t=0,s=g.length;t<s;++t){const s=g[t],i=s.start;for(let t=i,r=i+s.count;t<r;t+=3)f(e.getX(t+0),e.getX(t+1),e.getX(t+2))}const y=new Qi,S=new Qi,T=new Qi,x=new Qi;function b(e){T.fromBufferAttribute(i,e),x.copy(T);const t=a[e];y.copy(t),y.sub(T.multiplyScalar(T.dot(t))).normalize(),S.crossVectors(x,t);const s=S.dot(o[e])<0?-1:1;n.setXYZW(e,y.x,y.y,y.z,s)}for(let t=0,s=g.length;t<s;++t){const s=g[t],i=s.start;for(let t=i,r=i+s.count;t<r;t+=3)b(e.getX(t+0)),b(e.getX(t+1)),b(e.getX(t+2))}}computeVertexNormals(){const e=this.index,t=this.getAttribute("position");if(void 0!==t){let s=this.getAttribute("normal");if(void 0===s)s=new un(new Float32Array(3*t.count),3),this.setAttribute("normal",s);else for(let e=0,t=s.count;e<t;e++)s.setXYZ(e,0,0,0);const i=new Qi,r=new Qi,n=new Qi,a=new Qi,o=new Qi,l=new Qi,h=new Qi,u=new Qi;if(e)for(let c=0,d=e.count;c<d;c+=3){const d=e.getX(c+0),p=e.getX(c+1),_=e.getX(c+2);i.fromBufferAttribute(t,d),r.fromBufferAttribute(t,p),n.fromBufferAttribute(t,_),h.subVectors(n,r),u.subVectors(i,r),h.cross(u),a.fromBufferAttribute(s,d),o.fromBufferAttribute(s,p),l.fromBufferAttribute(s,_),a.add(h),o.add(h),l.add(h),s.setXYZ(d,a.x,a.y,a.z),s.setXYZ(p,o.x,o.y,o.z),s.setXYZ(_,l.x,l.y,l.z)}else for(let e=0,a=t.count;e<a;e+=3)i.fromBufferAttribute(t,e+0),r.fromBufferAttribute(t,e+1),n.fromBufferAttribute(t,e+2),h.subVectors(n,r),u.subVectors(i,r),h.cross(u),s.setXYZ(e+0,h.x,h.y,h.z),s.setXYZ(e+1,h.x,h.y,h.z),s.setXYZ(e+2,h.x,h.y,h.z);this.normalizeNormals(),s.needsUpdate=!0}}normalizeNormals(){const e=this.attributes.normal;for(let t=0,s=e.count;t<s;t++)zn.fromBufferAttribute(e,t),zn.normalize(),e.setXYZ(t,zn.x,zn.y,zn.z)}toNonIndexed(){function t(e,t){const s=e.array,i=e.itemSize,r=e.normalized,n=new s.constructor(t.length*i);let a=0,o=0;for(let r=0,l=t.length;r<l;r++){a=e.isInterleavedBufferAttribute?t[r]*e.data.stride+e.offset:t[r]*i;for(let e=0;e<i;e++)n[o++]=s[a++]}return new un(n,i,r)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const s=new e,i=this.index.array,r=this.attributes;for(const e in r){const n=t(r[e],i);s.setAttribute(e,n)}const n=this.morphAttributes;for(const e in n){const r=[],a=n[e];for(let e=0,s=a.length;e<s;e++){const s=t(a[e],i);r.push(s)}s.morphAttributes[e]=r}s.morphTargetsRelative=this.morphTargetsRelative;const a=this.groups;for(let e=0,t=a.length;e<t;e++){const t=a[e];s.addGroup(t.start,t.count,t.materialIndex)}return s}toJSON(){const e={metadata:{version:4.7,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),void 0!==this.parameters){const t=this.parameters;for(const s in t)void 0!==t[s]&&(e[s]=t[s]);return e}e.data={attributes:{}};const t=this.index;null!==t&&(e.data.index={type:t.array.constructor.name,array:Array.prototype.slice.call(t.array)});const s=this.attributes;for(const t in s){const i=s[t];e.data.attributes[t]=i.toJSON(e.data)}const i={};let r=!1;for(const t in this.morphAttributes){const s=this.morphAttributes[t],n=[];for(let t=0,i=s.length;t<i;t++){const i=s[t];n.push(i.toJSON(e.data))}n.length>0&&(i[t]=n,r=!0)}r&&(e.data.morphAttributes=i,e.data.morphTargetsRelative=this.morphTargetsRelative);const n=this.groups;n.length>0&&(e.data.groups=JSON.parse(JSON.stringify(n)));const a=this.boundingSphere;return null!==a&&(e.data.boundingSphere=a.toJSON()),e}clone(){return(new this.constructor).copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const t={};this.name=e.name;const s=e.index;null!==s&&this.setIndex(s.clone());const i=e.attributes;for(const e in i){const s=i[e];this.setAttribute(e,s.clone(t))}const r=e.morphAttributes;for(const e in r){const s=[],i=r[e];for(let e=0,r=i.length;e<r;e++)s.push(i[e].clone(t));this.morphAttributes[e]=s}this.morphTargetsRelative=e.morphTargetsRelative;const n=e.groups;for(let e=0,t=n.length;e<t;e++){const t=n[e];this.addGroup(t.start,t.count,t.materialIndex)}const a=e.boundingBox;null!==a&&(this.boundingBox=a.clone());const o=e.boundingSphere;return null!==o&&(this.boundingSphere=o.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}},In=new nr,Bn=new rr,kn=new Gs,En=new Qi,Rn=new Qi,Pn=new Qi,On=new Qi,Nn=new Qi,Vn=new Qi,Fn=new Qi,Ln=new Qi,jn=class extends Er{constructor(e=new Cn,t=new en){super(),this.isMesh=!0,this.type="Mesh",this.geometry=e,this.material=t,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.count=1,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const s=e[t[0]];if(void 0!==s){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=s.length;e<t;e++){const t=s[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}getVertexPosition(e,t){const s=this.geometry,i=s.attributes.position,r=s.morphAttributes.position,n=s.morphTargetsRelative;t.fromBufferAttribute(i,e);const a=this.morphTargetInfluences;if(r&&a){Vn.set(0,0,0);for(let s=0,i=r.length;s<i;s++){const i=a[s],o=r[s];0!==i&&(Nn.fromBufferAttribute(o,e),n?Vn.addScaledVector(Nn,i):Vn.addScaledVector(Nn.sub(t),i))}t.add(Vn)}return t}raycast(e,t){const s=this.geometry,i=this.material,r=this.matrixWorld;if(void 0!==i){if(null===s.boundingSphere&&s.computeBoundingSphere(),kn.copy(s.boundingSphere),kn.applyMatrix4(r),Bn.copy(e.ray).recast(e.near),!1===kn.containsPoint(Bn.origin)){if(null===Bn.intersectSphere(kn,En))return;if(Bn.origin.distanceToSquared(En)>(e.far-e.near)**2)return}In.copy(r).invert(),Bn.copy(e.ray).applyMatrix4(In),null!==s.boundingBox&&!1===Bn.intersectsBox(s.boundingBox)||this._computeIntersections(e,t,Bn)}}_computeIntersections(e,t,s){let i;const r=this.geometry,n=this.material,a=r.index,o=r.attributes.position,l=r.attributes.uv,h=r.attributes.uv1,u=r.attributes.normal,c=r.groups,d=r.drawRange;if(null!==a)if(Array.isArray(n))for(let r=0,o=c.length;r<o;r++){const o=c[r],p=n[o.materialIndex];for(let r=Math.max(o.start,d.start),n=Math.min(a.count,Math.min(o.start+o.count,d.start+d.count));r<n;r+=3)i=Wn(this,p,e,s,l,h,u,a.getX(r),a.getX(r+1),a.getX(r+2)),i&&(i.faceIndex=Math.floor(r/3),i.face.materialIndex=o.materialIndex,t.push(i))}else for(let r=Math.max(0,d.start),o=Math.min(a.count,d.start+d.count);r<o;r+=3)i=Wn(this,n,e,s,l,h,u,a.getX(r),a.getX(r+1),a.getX(r+2)),i&&(i.faceIndex=Math.floor(r/3),t.push(i));else if(void 0!==o)if(Array.isArray(n))for(let r=0,a=c.length;r<a;r++){const a=c[r],p=n[a.materialIndex];for(let r=Math.max(a.start,d.start),n=Math.min(o.count,Math.min(a.start+a.count,d.start+d.count));r<n;r+=3)i=Wn(this,p,e,s,l,h,u,r,r+1,r+2),i&&(i.faceIndex=Math.floor(r/3),i.face.materialIndex=a.materialIndex,t.push(i))}else for(let r=Math.max(0,d.start),a=Math.min(o.count,d.start+d.count);r<a;r+=3)i=Wn(this,n,e,s,l,h,u,r,r+1,r+2),i&&(i.faceIndex=Math.floor(r/3),t.push(i))}};function Wn(e,t,s,i,r,n,a,o,l,h){e.getVertexPosition(o,Rn),e.getVertexPosition(l,Pn),e.getVertexPosition(h,On);const u=function(e,t,s,i,r,n,a,o){let l;if(l=1===t.side?i.intersectTriangle(a,n,r,!0,o):i.intersectTriangle(r,n,a,0===t.side,o),null===l)return null;Ln.copy(o),Ln.applyMatrix4(e.matrixWorld);const h=s.ray.origin.distanceTo(Ln);return h<s.near||h>s.far?null:{distance:h,point:Ln.clone(),object:e}}(e,t,s,i,Rn,Pn,On,Fn);if(u){const e=new Qi;Jr.getBarycoord(Fn,Rn,Pn,On,e),r&&(u.uv=Jr.getInterpolatedAttribute(r,o,l,h,e,new Gi)),n&&(u.uv1=Jr.getInterpolatedAttribute(n,o,l,h,e,new Gi)),a&&(u.normal=Jr.getInterpolatedAttribute(a,o,l,h,e,new Qi),u.normal.dot(i.direction)>0&&u.normal.multiplyScalar(-1));const t={a:o,b:l,c:h,normal:new Qi,materialIndex:0};Jr.getNormal(Rn,Pn,On,t.normal),u.face=t,u.barycoord=e}return u}var Dn=class e extends Cn{constructor(e=1,t=1,s=1,i=1,r=1,n=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:s,widthSegments:i,heightSegments:r,depthSegments:n};const a=this;i=Math.floor(i),r=Math.floor(r),n=Math.floor(n);const o=[],l=[],h=[],u=[];let c=0,d=0;function p(e,t,s,i,r,n,p,_,m,f,g){const y=n/m,S=p/f,T=n/2,x=p/2,b=_/2,G=m+1,I=f+1;let v=0,C=0;const w=new Qi;for(let n=0;n<I;n++){const a=n*S-x;for(let o=0;o<G;o++){const c=o*y-T;w[e]=c*i,w[t]=a*r,w[s]=b,l.push(w.x,w.y,w.z),w[e]=0,w[t]=0,w[s]=_>0?1:-1,h.push(w.x,w.y,w.z),u.push(o/m),u.push(1-n/f),v+=1}}for(let e=0;e<f;e++)for(let t=0;t<m;t++){const s=c+t+G*e,i=c+t+G*(e+1),r=c+(t+1)+G*(e+1),n=c+(t+1)+G*e;o.push(s,i,n),o.push(i,r,n),C+=6}a.addGroup(d,C,g),d+=C,c+=v}p("z","y","x",-1,-1,s,t,e,n,r,0),p("z","y","x",1,-1,s,t,-e,n,r,1),p("x","z","y",1,1,e,s,t,i,n,2),p("x","z","y",1,-1,e,s,-t,i,n,3),p("x","y","z",1,-1,e,t,s,i,r,4),p("x","y","z",-1,-1,e,t,-s,i,r,5),this.setIndex(o),this.setAttribute("position",new vn(l,3)),this.setAttribute("normal",new vn(h,3)),this.setAttribute("uv",new vn(u,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(t){return new e(t.width,t.height,t.depth,t.widthSegments,t.heightSegments,t.depthSegments)}};function Un(e){const t={};for(const s in e){t[s]={};for(const i in e[s]){const r=e[s][i];r&&(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector2||r.isVector3||r.isVector4||r.isTexture||r.isQuaternion)?r.isRenderTargetTexture?(console.warn("UniformsUtils: Textures of render targets cannot be cloned via cloneUniforms() or mergeUniforms()."),t[s][i]=null):t[s][i]=r.clone():Array.isArray(r)?t[s][i]=r.slice():t[s][i]=r}}return t}var Xn=class extends tn{constructor(e){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={clipCullDistance:!1,multiDraw:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==e&&this.setValues(e)}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=Un(e.uniforms),this.uniformsGroups=function(e){const t=[];for(let s=0;s<e.length;s++)t.push(e[s].clone());return t}(e.uniformsGroups),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.fog=e.fog,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this}toJSON(e){const t=super.toJSON(e);t.glslVersion=this.glslVersion,t.uniforms={};for(const s in this.uniforms){const i=this.uniforms[s].value;i&&i.isTexture?t.uniforms[s]={type:"t",value:i.toJSON(e).uuid}:i&&i.isColor?t.uniforms[s]={type:"c",value:i.getHex()}:i&&i.isVector2?t.uniforms[s]={type:"v2",value:i.toArray()}:i&&i.isVector3?t.uniforms[s]={type:"v3",value:i.toArray()}:i&&i.isVector4?t.uniforms[s]={type:"v4",value:i.toArray()}:i&&i.isMatrix3?t.uniforms[s]={type:"m3",value:i.toArray()}:i&&i.isMatrix4?t.uniforms[s]={type:"m4",value:i.toArray()}:t.uniforms[s]={value:i}}Object.keys(this.defines).length>0&&(t.defines=this.defines),t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t.lights=this.lights,t.clipping=this.clipping;const s={};for(const e in this.extensions)!0===this.extensions[e]&&(s[e]=!0);return Object.keys(s).length>0&&(t.extensions=s),t}},Yn=class extends Er{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new nr,this.projectionMatrix=new nr,this.projectionMatrixInverse=new nr,this.coordinateSystem=Ri,this._reversedDepth=!1}get reversedDepth(){return this._reversedDepth}copy(e,t){return super.copy(e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this.coordinateSystem=e.coordinateSystem,this}getWorldDirection(e){return super.getWorldDirection(e).negate()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,t){super.updateWorldMatrix(e,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}},Zn=new Qi,Gn=new Gi,$n=new Gi,Qn=class extends Yn{constructor(e=50,t=1,s=.1,i=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=s,this.far=i,this.focus=10,this.aspect=t,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){const t=.5*this.getFilmHeight()/e;this.fov=2*Di*Math.atan(t),this.updateProjectionMatrix()}getFocalLength(){const e=Math.tan(.5*Wi*this.fov);return.5*this.getFilmHeight()/e}getEffectiveFOV(){return 2*Di*Math.atan(Math.tan(.5*Wi*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(e,t,s){Zn.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),t.set(Zn.x,Zn.y).multiplyScalar(-e/Zn.z),Zn.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),s.set(Zn.x,Zn.y).multiplyScalar(-e/Zn.z)}getViewSize(e,t){return this.getViewBounds(e,Gn,$n),t.subVectors($n,Gn)}setViewOffset(e,t,s,i,r,n){this.aspect=e/t,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=s,this.view.offsetY=i,this.view.width=r,this.view.height=n,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=this.near;let t=e*Math.tan(.5*Wi*this.fov)/this.zoom,s=2*t,i=this.aspect*s,r=-.5*i;const n=this.view;if(null!==this.view&&this.view.enabled){const e=n.fullWidth,a=n.fullHeight;r+=n.offsetX*i/e,t-=n.offsetY*s/a,i*=n.width/e,s*=n.height/a}const a=this.filmOffset;0!==a&&(r+=e*a/this.getFilmWidth()),this.projectionMatrix.makePerspective(r,r+i,t,t-s,e,this.far,this.coordinateSystem,this.reversedDepth),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}},Kn=-90,ta=class extends Er{constructor(e,t,s){super(),this.type="CubeCamera",this.renderTarget=s,this.coordinateSystem=null,this.activeMipmapLevel=0;const i=new Qn(Kn,1,e,t);i.layers=this.layers,this.add(i);const r=new Qn(Kn,1,e,t);r.layers=this.layers,this.add(r);const n=new Qn(Kn,1,e,t);n.layers=this.layers,this.add(n);const a=new Qn(Kn,1,e,t);a.layers=this.layers,this.add(a);const o=new Qn(Kn,1,e,t);o.layers=this.layers,this.add(o);const l=new Qn(Kn,1,e,t);l.layers=this.layers,this.add(l)}updateCoordinateSystem(){const e=this.coordinateSystem,t=this.children.concat(),[s,i,r,n,a,o]=t;for(const e of t)this.remove(e);if(e===Ri)s.up.set(0,1,0),s.lookAt(1,0,0),i.up.set(0,1,0),i.lookAt(-1,0,0),r.up.set(0,0,-1),r.lookAt(0,1,0),n.up.set(0,0,1),n.lookAt(0,-1,0),a.up.set(0,1,0),a.lookAt(0,0,1),o.up.set(0,1,0),o.lookAt(0,0,-1);else{if(e!==Pi)throw new Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+e);s.up.set(0,-1,0),s.lookAt(-1,0,0),i.up.set(0,-1,0),i.lookAt(1,0,0),r.up.set(0,0,1),r.lookAt(0,1,0),n.up.set(0,0,-1),n.lookAt(0,-1,0),a.up.set(0,-1,0),a.lookAt(0,0,1),o.up.set(0,-1,0),o.lookAt(0,0,-1)}for(const e of t)this.add(e),e.updateMatrixWorld()}update(e,t){null===this.parent&&this.updateMatrixWorld();const{renderTarget:s,activeMipmapLevel:i}=this;this.coordinateSystem!==e.coordinateSystem&&(this.coordinateSystem=e.coordinateSystem,this.updateCoordinateSystem());const[r,n,a,o,l,h]=this.children,u=e.getRenderTarget(),c=e.getActiveCubeFace(),d=e.getActiveMipmapLevel(),p=e.xr.enabled;e.xr.enabled=!1;const _=s.texture.generateMipmaps;s.texture.generateMipmaps=!1,e.setRenderTarget(s,0,i),e.render(t,r),e.setRenderTarget(s,1,i),e.render(t,n),e.setRenderTarget(s,2,i),e.render(t,a),e.setRenderTarget(s,3,i),e.render(t,o),e.setRenderTarget(s,4,i),e.render(t,l),s.texture.generateMipmaps=_,e.setRenderTarget(s,5,i),e.render(t,h),e.setRenderTarget(u,c,d),e.xr.enabled=p,s.texture.needsPMREMUpdate=!0}},ea=class extends _s{constructor(e=[],t=301,s,i,r,n,a,o,l,h){super(e,t,s,i,r,n,a,o,l,h),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(e){this.image=e}},ia=class extends zs{constructor(e=1,t={}){super(e,e,t),this.isWebGLCubeRenderTarget=!0;const s={width:e,height:e,depth:1},i=[s,s,s,s,s,s];this.texture=new ea(i),this._setTextureOptions(t),this.texture.isRenderTargetTexture=!0}fromEquirectangularTexture(e,t){this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const s={tEquirect:{value:null}},i="\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t\t#include <project_vertex>\n\n\t\t\t\t}\n\t\t\t",r="\n\n\t\t\t\tuniform sampler2D tEquirect;\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\t#include <common>\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\n\t\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\n\t\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t\t\t\t}\n\t\t\t",n=new Dn(5,5,5),a=new Xn({name:"CubemapFromEquirect",uniforms:Un(s),vertexShader:i,fragmentShader:r,side:1,blending:0});a.uniforms.tEquirect.value=t;const o=new jn(n,a),l=t.minFilter;return t.minFilter===_t&&(t.minFilter=wt),new ta(1,10,this).update(e,o),t.minFilter=l,o.geometry.dispose(),o.material.dispose(),this}clear(e,t=!0,s=!0,i=!0){const r=e.getRenderTarget();for(let r=0;r<6;r++)e.setRenderTarget(this,r),e.clear(t,s,i);e.setRenderTarget(r)}},sa=class extends Er{constructor(){super(),this.isGroup=!0,this.type="Group"}},ra={type:"move"},na=class{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return null===this._hand&&(this._hand=new sa,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return null===this._targetRay&&(this._targetRay=new sa,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new Qi,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new Qi),this._targetRay}getGripSpace(){return null===this._grip&&(this._grip=new sa,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new Qi,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new Qi),this._grip}dispatchEvent(e){return null!==this._targetRay&&this._targetRay.dispatchEvent(e),null!==this._grip&&this._grip.dispatchEvent(e),null!==this._hand&&this._hand.dispatchEvent(e),this}connect(e){if(e&&e.hand){const t=this._hand;if(t)for(const s of e.hand.values())this._getHandJoint(t,s)}return this.dispatchEvent({type:"connected",data:e}),this}disconnect(e){return this.dispatchEvent({type:"disconnected",data:e}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this}update(e,t,s){let i=null,r=null,n=null;const a=this._targetRay,o=this._grip,l=this._hand;if(e&&"visible-blurred"!==t.session.visibilityState){if(l&&e.hand){n=!0;for(const i of e.hand.values()){const e=t.getJointPose(i,s),r=this._getHandJoint(l,i);null!==e&&(r.matrix.fromArray(e.transform.matrix),r.matrix.decompose(r.position,r.rotation,r.scale),r.matrixWorldNeedsUpdate=!0,r.jointRadius=e.radius),r.visible=null!==e}const i=l.joints["index-finger-tip"],r=l.joints["thumb-tip"],a=i.position.distanceTo(r.position),o=.02,h=.005;l.inputState.pinching&&a>o+h?(l.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!l.inputState.pinching&&a<=o-h&&(l.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else null!==o&&e.gripSpace&&(r=t.getPose(e.gripSpace,s),null!==r&&(o.matrix.fromArray(r.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),o.matrixWorldNeedsUpdate=!0,r.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(r.linearVelocity)):o.hasLinearVelocity=!1,r.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(r.angularVelocity)):o.hasAngularVelocity=!1));null!==a&&(i=t.getPose(e.targetRaySpace,s),null===i&&null!==r&&(i=r),null!==i&&(a.matrix.fromArray(i.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale),a.matrixWorldNeedsUpdate=!0,i.linearVelocity?(a.hasLinearVelocity=!0,a.linearVelocity.copy(i.linearVelocity)):a.hasLinearVelocity=!1,i.angularVelocity?(a.hasAngularVelocity=!0,a.angularVelocity.copy(i.angularVelocity)):a.hasAngularVelocity=!1,this.dispatchEvent(ra)))}return null!==a&&(a.visible=null!==i),null!==o&&(o.visible=null!==r),null!==l&&(l.visible=null!==n),this}_getHandJoint(e,t){if(void 0===e.joints[t.jointName]){const s=new sa;s.matrixAutoUpdate=!1,s.visible=!1,e.joints[t.jointName]=s,e.add(s)}return e.joints[t.jointName]}},ha=class extends Er{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.backgroundRotation=new yr,this.environmentIntensity=1,this.environmentRotation=new yr,this.overrideMaterial=null,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,t){return super.copy(e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.environment&&(this.environment=e.environment.clone()),null!==e.fog&&(this.fog=e.fog.clone()),this.backgroundBlurriness=e.backgroundBlurriness,this.backgroundIntensity=e.backgroundIntensity,this.backgroundRotation.copy(e.backgroundRotation),this.environmentIntensity=e.environmentIntensity,this.environmentRotation.copy(e.environmentRotation),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){const t=super.toJSON(e);return null!==this.fog&&(t.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(t.object.backgroundBlurriness=this.backgroundBlurriness),1!==this.backgroundIntensity&&(t.object.backgroundIntensity=this.backgroundIntensity),t.object.backgroundRotation=this.backgroundRotation.toArray(),1!==this.environmentIntensity&&(t.object.environmentIntensity=this.environmentIntensity),t.object.environmentRotation=this.environmentRotation.toArray(),t}},la=class{constructor(e,t){this.isInterleavedBuffer=!0,this.array=e,this.stride=t,this.count=void 0!==e?e.length/t:0,this.usage=Mi,this.updateRanges=[],this.version=0,this.uuid=Ui()}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.usage=e.usage,this}copyAt(e,t,s){e*=this.stride,s*=t.stride;for(let i=0,r=this.stride;i<r;i++)this.array[e+i]=t.array[s+i];return this}set(e,t=0){return this.array.set(e,t),this}clone(e){void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=Ui()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const t=new this.array.constructor(e.arrayBuffers[this.array.buffer._uuid]),s=new this.constructor(t,this.stride);return s.setUsage(this.usage),s}onUpload(e){return this.onUploadCallback=e,this}toJSON(e){return void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=Ui()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=Array.from(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}},ca=new Qi,ua=class e{constructor(e,t,s,i=!1){this.isInterleavedBufferAttribute=!0,this.name="",this.data=e,this.itemSize=t,this.offset=s,this.normalized=i}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(e){this.data.needsUpdate=e}applyMatrix4(e){for(let t=0,s=this.data.count;t<s;t++)ca.fromBufferAttribute(this,t),ca.applyMatrix4(e),this.setXYZ(t,ca.x,ca.y,ca.z);return this}applyNormalMatrix(e){for(let t=0,s=this.count;t<s;t++)ca.fromBufferAttribute(this,t),ca.applyNormalMatrix(e),this.setXYZ(t,ca.x,ca.y,ca.z);return this}transformDirection(e){for(let t=0,s=this.count;t<s;t++)ca.fromBufferAttribute(this,t),ca.transformDirection(e),this.setXYZ(t,ca.x,ca.y,ca.z);return this}getComponent(e,t){let s=this.array[e*this.data.stride+this.offset+t];return this.normalized&&(s=Xi(s,this.array)),s}setComponent(e,t,s){return this.normalized&&(s=Yi(s,this.array)),this.data.array[e*this.data.stride+this.offset+t]=s,this}setX(e,t){return this.normalized&&(t=Yi(t,this.array)),this.data.array[e*this.data.stride+this.offset]=t,this}setY(e,t){return this.normalized&&(t=Yi(t,this.array)),this.data.array[e*this.data.stride+this.offset+1]=t,this}setZ(e,t){return this.normalized&&(t=Yi(t,this.array)),this.data.array[e*this.data.stride+this.offset+2]=t,this}setW(e,t){return this.normalized&&(t=Yi(t,this.array)),this.data.array[e*this.data.stride+this.offset+3]=t,this}getX(e){let t=this.data.array[e*this.data.stride+this.offset];return this.normalized&&(t=Xi(t,this.array)),t}getY(e){let t=this.data.array[e*this.data.stride+this.offset+1];return this.normalized&&(t=Xi(t,this.array)),t}getZ(e){let t=this.data.array[e*this.data.stride+this.offset+2];return this.normalized&&(t=Xi(t,this.array)),t}getW(e){let t=this.data.array[e*this.data.stride+this.offset+3];return this.normalized&&(t=Xi(t,this.array)),t}setXY(e,t,s){return e=e*this.data.stride+this.offset,this.normalized&&(t=Yi(t,this.array),s=Yi(s,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=s,this}setXYZ(e,t,s,i){return e=e*this.data.stride+this.offset,this.normalized&&(t=Yi(t,this.array),s=Yi(s,this.array),i=Yi(i,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=s,this.data.array[e+2]=i,this}setXYZW(e,t,s,i,r){return e=e*this.data.stride+this.offset,this.normalized&&(t=Yi(t,this.array),s=Yi(s,this.array),i=Yi(i,this.array),r=Yi(r,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=s,this.data.array[e+2]=i,this.data.array[e+3]=r,this}clone(t){if(void 0===t){console.log("THREE.InterleavedBufferAttribute.clone(): Cloning an interleaved buffer attribute will de-interleave buffer data.");const e=[];for(let t=0;t<this.count;t++){const s=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[s+t])}return new un(new this.array.constructor(e),this.itemSize,this.normalized)}return void 0===t.interleavedBuffers&&(t.interleavedBuffers={}),void 0===t.interleavedBuffers[this.data.uuid]&&(t.interleavedBuffers[this.data.uuid]=this.data.clone(t)),new e(t.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)}toJSON(e){if(void 0===e){console.log("THREE.InterleavedBufferAttribute.toJSON(): Serializing an interleaved buffer attribute will de-interleave buffer data.");const e=[];for(let t=0;t<this.count;t++){const s=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[s+t])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:e,normalized:this.normalized}}return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.toJSON(e)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}},da=class extends tn{constructor(e){super(),this.isSpriteMaterial=!0,this.type="SpriteMaterial",this.color=new $r(16777215),this.map=null,this.alphaMap=null,this.rotation=0,this.sizeAttenuation=!0,this.transparent=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.rotation=e.rotation,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}},ma=new Qi,ya=new Qi,ga=new Qi,fa=new Gi,xa=new Gi,ba=new nr,va=new Qi,wa=new Qi,Ma=new Qi,Sa=new Gi,_a=new Gi,Aa=new Gi,Ca=new Qi,Ia=new Qi,ka=new Qi,Ea=new As,Ra=new As,Pa=new Qi,Oa=new nr,Na=new Qi,Va=new Gs,Fa=new nr,La=new rr,ja=class extends jn{constructor(e,t){super(e,t),this.isSkinnedMesh=!0,this.type="SkinnedMesh",this.bindMode=nt,this.bindMatrix=new nr,this.bindMatrixInverse=new nr,this.boundingBox=null,this.boundingSphere=null}computeBoundingBox(){const e=this.geometry;null===this.boundingBox&&(this.boundingBox=new Es),this.boundingBox.makeEmpty();const t=e.getAttribute("position");for(let e=0;e<t.count;e++)this.getVertexPosition(e,Na),this.boundingBox.expandByPoint(Na)}computeBoundingSphere(){const e=this.geometry;null===this.boundingSphere&&(this.boundingSphere=new Gs),this.boundingSphere.makeEmpty();const t=e.getAttribute("position");for(let e=0;e<t.count;e++)this.getVertexPosition(e,Na),this.boundingSphere.expandByPoint(Na)}copy(e,t){return super.copy(e,t),this.bindMode=e.bindMode,this.bindMatrix.copy(e.bindMatrix),this.bindMatrixInverse.copy(e.bindMatrixInverse),this.skeleton=e.skeleton,null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this}raycast(e,t){const s=this.material,i=this.matrixWorld;void 0!==s&&(null===this.boundingSphere&&this.computeBoundingSphere(),Va.copy(this.boundingSphere),Va.applyMatrix4(i),!1!==e.ray.intersectsSphere(Va)&&(Fa.copy(i).invert(),La.copy(e.ray).applyMatrix4(Fa),null!==this.boundingBox&&!1===La.intersectsBox(this.boundingBox)||this._computeIntersections(e,t,La)))}getVertexPosition(e,t){return super.getVertexPosition(e,t),this.applyBoneTransform(e,t),t}bind(e,t){this.skeleton=e,void 0===t&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.copy(t).invert()}pose(){this.skeleton.pose()}normalizeSkinWeights(){const e=new As,t=this.geometry.attributes.skinWeight;for(let s=0,i=t.count;s<i;s++){e.fromBufferAttribute(t,s);const i=1/e.manhattanLength();i!==1/0?e.multiplyScalar(i):e.set(1,0,0,0),t.setXYZW(s,e.x,e.y,e.z,e.w)}}updateMatrixWorld(e){super.updateMatrixWorld(e),this.bindMode===nt?this.bindMatrixInverse.copy(this.matrixWorld).invert():this.bindMode===at?this.bindMatrixInverse.copy(this.bindMatrix).invert():console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)}applyBoneTransform(e,t){const s=this.skeleton,i=this.geometry;Ea.fromBufferAttribute(i.attributes.skinIndex,e),Ra.fromBufferAttribute(i.attributes.skinWeight,e),ka.copy(t).applyMatrix4(this.bindMatrix),t.set(0,0,0);for(let e=0;e<4;e++){const i=Ra.getComponent(e);if(0!==i){const r=Ea.getComponent(e);Oa.multiplyMatrices(s.bones[r].matrixWorld,s.boneInverses[r]),t.addScaledVector(Pa.copy(ka).applyMatrix4(Oa),i)}}return t.applyMatrix4(this.bindMatrixInverse)}},Wa=class extends Er{constructor(){super(),this.isBone=!0,this.type="Bone"}},Da=class extends _s{constructor(e=null,t=1,s=1,i,r,n,a,o,l=1003,h=1003,u,c){super(null,n,a,o,l,h,i,r,u,c),this.isDataTexture=!0,this.image={data:e,width:t,height:s},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}},Ua=new nr,Ha=new nr,qa=class e{constructor(e=[],t=[]){this.uuid=Ui(),this.bones=e.slice(0),this.boneInverses=t,this.boneMatrices=null,this.boneTexture=null,this.init()}init(){const e=this.bones,t=this.boneInverses;if(this.boneMatrices=new Float32Array(16*e.length),0===t.length)this.calculateInverses();else if(e.length!==t.length){console.warn("THREE.Skeleton: Number of inverse bone matrices does not match amount of bones."),this.boneInverses=[];for(let e=0,t=this.bones.length;e<t;e++)this.boneInverses.push(new nr)}}calculateInverses(){this.boneInverses.length=0;for(let e=0,t=this.bones.length;e<t;e++){const t=new nr;this.bones[e]&&t.copy(this.bones[e].matrixWorld).invert(),this.boneInverses.push(t)}}pose(){for(let e=0,t=this.bones.length;e<t;e++){const t=this.bones[e];t&&t.matrixWorld.copy(this.boneInverses[e]).invert()}for(let e=0,t=this.bones.length;e<t;e++){const t=this.bones[e];t&&(t.parent&&t.parent.isBone?(t.matrix.copy(t.parent.matrixWorld).invert(),t.matrix.multiply(t.matrixWorld)):t.matrix.copy(t.matrixWorld),t.matrix.decompose(t.position,t.quaternion,t.scale))}}update(){const e=this.bones,t=this.boneInverses,s=this.boneMatrices,i=this.boneTexture;for(let i=0,r=e.length;i<r;i++){const r=e[i]?e[i].matrixWorld:Ha;Ua.multiplyMatrices(r,t[i]),Ua.toArray(s,16*i)}null!==i&&(i.needsUpdate=!0)}clone(){return new e(this.bones,this.boneInverses)}computeBoneTexture(){let e=Math.sqrt(4*this.bones.length);e=4*Math.ceil(e/4),e=Math.max(e,4);const t=new Float32Array(e*e*4);t.set(this.boneMatrices);const s=new Da(t,e,e,jt,Et);return s.needsUpdate=!0,this.boneMatrices=t,this.boneTexture=s,this}getBoneByName(e){for(let t=0,s=this.bones.length;t<s;t++){const s=this.bones[t];if(s.name===e)return s}}dispose(){null!==this.boneTexture&&(this.boneTexture.dispose(),this.boneTexture=null)}fromJSON(e,t){this.uuid=e.uuid;for(let s=0,i=e.bones.length;s<i;s++){const i=e.bones[s];let r=t[i];void 0===r&&(console.warn("THREE.Skeleton: No bone found with UUID:",i),r=new Wa),this.bones.push(r),this.boneInverses.push((new nr).fromArray(e.boneInverses[s]))}return this.init(),this}toJSON(){const e={metadata:{version:4.7,type:"Skeleton",generator:"Skeleton.toJSON"},bones:[],boneInverses:[]};e.uuid=this.uuid;const t=this.bones,s=this.boneInverses;for(let i=0,r=t.length;i<r;i++){const r=t[i];e.bones.push(r.uuid);const n=s[i];e.boneInverses.push(n.toArray())}return e}},Ja=class extends un{constructor(e,t,s,i=1){super(e,t,s),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=i}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}toJSON(){const e=super.toJSON();return e.meshPerAttribute=this.meshPerAttribute,e.isInstancedBufferAttribute=!0,e}},Xa=new nr,Ya=new nr,Za=[],Ga=new Es,$a=new nr,Qa=new jn,Ka=new Gs,to=class extends jn{constructor(e,t,s){super(e,t),this.isInstancedMesh=!0,this.instanceMatrix=new Ja(new Float32Array(16*s),16),this.instanceColor=null,this.morphTexture=null,this.count=s,this.boundingBox=null,this.boundingSphere=null;for(let e=0;e<s;e++)this.setMatrixAt(e,$a)}computeBoundingBox(){const e=this.geometry,t=this.count;null===this.boundingBox&&(this.boundingBox=new Es),null===e.boundingBox&&e.computeBoundingBox(),this.boundingBox.makeEmpty();for(let s=0;s<t;s++)this.getMatrixAt(s,Xa),Ga.copy(e.boundingBox).applyMatrix4(Xa),this.boundingBox.union(Ga)}computeBoundingSphere(){const e=this.geometry,t=this.count;null===this.boundingSphere&&(this.boundingSphere=new Gs),null===e.boundingSphere&&e.computeBoundingSphere(),this.boundingSphere.makeEmpty();for(let s=0;s<t;s++)this.getMatrixAt(s,Xa),Ka.copy(e.boundingSphere).applyMatrix4(Xa),this.boundingSphere.union(Ka)}copy(e,t){return super.copy(e,t),this.instanceMatrix.copy(e.instanceMatrix),null!==e.morphTexture&&(this.morphTexture=e.morphTexture.clone()),null!==e.instanceColor&&(this.instanceColor=e.instanceColor.clone()),this.count=e.count,null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this}getColorAt(e,t){t.fromArray(this.instanceColor.array,3*e)}getMatrixAt(e,t){t.fromArray(this.instanceMatrix.array,16*e)}getMorphAt(e,t){const s=t.morphTargetInfluences,i=this.morphTexture.source.data.data,r=e*(s.length+1)+1;for(let e=0;e<s.length;e++)s[e]=i[r+e]}raycast(e,t){const s=this.matrixWorld,i=this.count;if(Qa.geometry=this.geometry,Qa.material=this.material,void 0!==Qa.material&&(null===this.boundingSphere&&this.computeBoundingSphere(),Ka.copy(this.boundingSphere),Ka.applyMatrix4(s),!1!==e.ray.intersectsSphere(Ka)))for(let r=0;r<i;r++){this.getMatrixAt(r,Xa),Ya.multiplyMatrices(s,Xa),Qa.matrixWorld=Ya,Qa.raycast(e,Za);for(let e=0,s=Za.length;e<s;e++){const s=Za[e];s.instanceId=r,s.object=this,t.push(s)}Za.length=0}}setColorAt(e,t){null===this.instanceColor&&(this.instanceColor=new Ja(new Float32Array(3*this.instanceMatrix.count).fill(1),3)),t.toArray(this.instanceColor.array,3*e)}setMatrixAt(e,t){t.toArray(this.instanceMatrix.array,16*e)}setMorphAt(e,t){const s=t.morphTargetInfluences,i=s.length+1;null===this.morphTexture&&(this.morphTexture=new Da(new Float32Array(i*this.count),i,this.count,Ut,Et));const r=this.morphTexture.source.data.data;let n=0;for(let e=0;e<s.length;e++)n+=s[e];const a=this.geometry.morphTargetsRelative?1:1-n,o=i*e;r[o]=a,r.set(s,o+1)}updateMorphTargets(){}dispose(){this.dispatchEvent({type:"dispose"}),null!==this.morphTexture&&(this.morphTexture.dispose(),this.morphTexture=null)}},eo=new Qi,io=new Qi,so=new es,ro=class{constructor(e=new Qi(1,0,0),t=0){this.isPlane=!0,this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,s,i){return this.normal.set(e,t,s),this.constant=i,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,s){const i=eo.subVectors(s,t).cross(io.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(i,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t){return t.copy(e).addScaledVector(this.normal,-this.distanceToPoint(e))}intersectLine(e,t){const s=e.delta(eo),i=this.normal.dot(s);if(0===i)return 0===this.distanceToPoint(e.start)?t.copy(e.start):null;const r=-(e.start.dot(this.normal)+this.constant)/i;return r<0||r>1?null:t.copy(e.start).addScaledVector(s,r)}intersectsLine(e){const t=this.distanceToPoint(e.start),s=this.distanceToPoint(e.end);return t<0&&s>0||s<0&&t>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const s=t||so.getNormalMatrix(e),i=this.coplanarPoint(eo).applyMatrix4(e),r=this.normal.applyMatrix3(s).normalize();return this.constant=-i.dot(r),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return(new this.constructor).copy(this)}},no=new Gs,ao=new Gi(.5,.5),oo=new Qi,ho=class{constructor(e=new ro,t=new ro,s=new ro,i=new ro,r=new ro,n=new ro){this.planes=[e,t,s,i,r,n]}set(e,t,s,i,r,n){const a=this.planes;return a[0].copy(e),a[1].copy(t),a[2].copy(s),a[3].copy(i),a[4].copy(r),a[5].copy(n),this}copy(e){const t=this.planes;for(let s=0;s<6;s++)t[s].copy(e.planes[s]);return this}setFromProjectionMatrix(e,t=2e3,s=!1){const i=this.planes,r=e.elements,n=r[0],a=r[1],o=r[2],l=r[3],h=r[4],u=r[5],c=r[6],d=r[7],p=r[8],_=r[9],m=r[10],f=r[11],g=r[12],y=r[13],S=r[14],T=r[15];if(i[0].setComponents(l-n,d-h,f-p,T-g).normalize(),i[1].setComponents(l+n,d+h,f+p,T+g).normalize(),i[2].setComponents(l+a,d+u,f+_,T+y).normalize(),i[3].setComponents(l-a,d-u,f-_,T-y).normalize(),s)i[4].setComponents(o,c,m,S).normalize(),i[5].setComponents(l-o,d-c,f-m,T-S).normalize();else if(i[4].setComponents(l-o,d-c,f-m,T-S).normalize(),t===Ri)i[5].setComponents(l+o,d+c,f+m,T+S).normalize();else{if(t!==Pi)throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+t);i[5].setComponents(o,c,m,S).normalize()}return this}intersectsObject(e){if(void 0!==e.boundingSphere)null===e.boundingSphere&&e.computeBoundingSphere(),no.copy(e.boundingSphere).applyMatrix4(e.matrixWorld);else{const t=e.geometry;null===t.boundingSphere&&t.computeBoundingSphere(),no.copy(t.boundingSphere).applyMatrix4(e.matrixWorld)}return this.intersectsSphere(no)}intersectsSprite(e){no.center.set(0,0,0);const t=ao.distanceTo(e.center);return no.radius=.7071067811865476+t,no.applyMatrix4(e.matrixWorld),this.intersectsSphere(no)}intersectsSphere(e){const t=this.planes,s=e.center,i=-e.radius;for(let e=0;e<6;e++)if(t[e].distanceToPoint(s)<i)return!1;return!0}intersectsBox(e){const t=this.planes;for(let s=0;s<6;s++){const i=t[s];if(oo.x=i.normal.x>0?e.max.x:e.min.x,oo.y=i.normal.y>0?e.max.y:e.min.y,oo.z=i.normal.z>0?e.max.z:e.min.z,i.distanceToPoint(oo)<0)return!1}return!0}containsPoint(e){const t=this.planes;for(let s=0;s<6;s++)if(t[s].distanceToPoint(e)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}},lo=new nr,co=new ho,uo=class e{constructor(){this.coordinateSystem=Ri}intersectsObject(e,t){if(!t.isArrayCamera||0===t.cameras.length)return!1;for(let s=0;s<t.cameras.length;s++){const i=t.cameras[s];if(lo.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),co.setFromProjectionMatrix(lo,i.coordinateSystem,i.reversedDepth),co.intersectsObject(e))return!0}return!1}intersectsSprite(e,t){if(!t||!t.cameras||0===t.cameras.length)return!1;for(let s=0;s<t.cameras.length;s++){const i=t.cameras[s];if(lo.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),co.setFromProjectionMatrix(lo,i.coordinateSystem,i.reversedDepth),co.intersectsSprite(e))return!0}return!1}intersectsSphere(e,t){if(!t||!t.cameras||0===t.cameras.length)return!1;for(let s=0;s<t.cameras.length;s++){const i=t.cameras[s];if(lo.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),co.setFromProjectionMatrix(lo,i.coordinateSystem,i.reversedDepth),co.intersectsSphere(e))return!0}return!1}intersectsBox(e,t){if(!t||!t.cameras||0===t.cameras.length)return!1;for(let s=0;s<t.cameras.length;s++){const i=t.cameras[s];if(lo.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),co.setFromProjectionMatrix(lo,i.coordinateSystem,i.reversedDepth),co.intersectsBox(e))return!0}return!1}containsPoint(e,t){if(!t||!t.cameras||0===t.cameras.length)return!1;for(let s=0;s<t.cameras.length;s++){const i=t.cameras[s];if(lo.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),co.setFromProjectionMatrix(lo,i.coordinateSystem,i.reversedDepth),co.containsPoint(e))return!0}return!1}clone(){return new e}},go=class{constructor(){this.index=0,this.pool=[],this.list=[]}push(e,t,s,i){const r=this.pool,n=this.list;this.index>=r.length&&r.push({start:-1,count:-1,z:-1,index:-1});const a=r[this.index];n.push(a),this.index++,a.start=e,a.count=t,a.z=s,a.index=i}reset(){this.list.length=0,this.index=0}},fo=new nr,xo=new $r(1,1,1),bo=new ho,vo=new uo,wo=new Es,Mo=new Gs,So=new Qi,_o=new Qi,Ao=new Qi,To=new go,zo=new jn,Eo=class extends tn{constructor(e){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new $r(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this.fog=e.fog,this}},Ro=new Qi,Po=new Qi,Oo=new nr,No=new rr,Vo=new Gs,Fo=new Qi,Lo=new Qi,jo=class extends Er{constructor(e=new Cn,t=new Eo){super(),this.isLine=!0,this.type="Line",this.geometry=e,this.material=t,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}computeLineDistances(){const e=this.geometry;if(null===e.index){const t=e.attributes.position,s=[0];for(let e=1,i=t.count;e<i;e++)Ro.fromBufferAttribute(t,e-1),Po.fromBufferAttribute(t,e),s[e]=s[e-1],s[e]+=Ro.distanceTo(Po);e.setAttribute("lineDistance",new vn(s,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}raycast(e,t){const s=this.geometry,i=this.matrixWorld,r=e.params.Line.threshold,n=s.drawRange;if(null===s.boundingSphere&&s.computeBoundingSphere(),Vo.copy(s.boundingSphere),Vo.applyMatrix4(i),Vo.radius+=r,!1===e.ray.intersectsSphere(Vo))return;Oo.copy(i).invert(),No.copy(e.ray).applyMatrix4(Oo);const a=r/((this.scale.x+this.scale.y+this.scale.z)/3),o=a*a,l=this.isLineSegments?2:1,h=s.index,u=s.attributes.position;if(null!==h){const s=Math.max(0,n.start),i=Math.min(h.count,n.start+n.count);for(let r=s,n=i-1;r<n;r+=l){const s=h.getX(r),i=h.getX(r+1),n=Wo(this,e,No,o,s,i,r);n&&t.push(n)}if(this.isLineLoop){const r=h.getX(i-1),n=h.getX(s),a=Wo(this,e,No,o,r,n,i-1);a&&t.push(a)}}else{const s=Math.max(0,n.start),i=Math.min(u.count,n.start+n.count);for(let r=s,n=i-1;r<n;r+=l){const s=Wo(this,e,No,o,r,r+1,r);s&&t.push(s)}if(this.isLineLoop){const r=Wo(this,e,No,o,i-1,s,i-1);r&&t.push(r)}}}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const s=e[t[0]];if(void 0!==s){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=s.length;e<t;e++){const t=s[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}};function Wo(e,t,s,i,r,n,a){const o=e.geometry.attributes.position;if(Ro.fromBufferAttribute(o,r),Po.fromBufferAttribute(o,n),s.distanceSqToSegment(Ro,Po,Fo,Lo)>i)return;Fo.applyMatrix4(e.matrixWorld);const l=t.ray.origin.distanceTo(Fo);return l<t.near||l>t.far?void 0:{distance:l,point:Lo.clone().applyMatrix4(e.matrixWorld),index:a,face:null,faceIndex:null,barycoord:null,object:e}}var Do=new Qi,Uo=new Qi,Ho=class extends jo{constructor(e,t){super(e,t),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){const e=this.geometry;if(null===e.index){const t=e.attributes.position,s=[];for(let e=0,i=t.count;e<i;e+=2)Do.fromBufferAttribute(t,e),Uo.fromBufferAttribute(t,e+1),s[e]=0===e?0:s[e-1],s[e+1]=s[e]+Do.distanceTo(Uo);e.setAttribute("lineDistance",new vn(s,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}},qo=class extends jo{constructor(e,t){super(e,t),this.isLineLoop=!0,this.type="LineLoop"}},Jo=class extends tn{constructor(e){super(),this.isPointsMaterial=!0,this.type="PointsMaterial",this.color=new $r(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}},Xo=new nr,Yo=new rr,Zo=new Gs,Go=new Qi,$o=class extends Er{constructor(e=new Cn,t=new Jo){super(),this.isPoints=!0,this.type="Points",this.geometry=e,this.material=t,this.morphTargetDictionary=void 0,this.morphTargetInfluences=void 0,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}raycast(e,t){const s=this.geometry,i=this.matrixWorld,r=e.params.Points.threshold,n=s.drawRange;if(null===s.boundingSphere&&s.computeBoundingSphere(),Zo.copy(s.boundingSphere),Zo.applyMatrix4(i),Zo.radius+=r,!1===e.ray.intersectsSphere(Zo))return;Xo.copy(i).invert(),Yo.copy(e.ray).applyMatrix4(Xo);const a=r/((this.scale.x+this.scale.y+this.scale.z)/3),o=a*a,l=s.index,h=s.attributes.position;if(null!==l)for(let s=Math.max(0,n.start),r=Math.min(l.count,n.start+n.count);s<r;s++){const r=l.getX(s);Go.fromBufferAttribute(h,r),Qo(Go,r,o,i,e,t,this)}else for(let s=Math.max(0,n.start),r=Math.min(h.count,n.start+n.count);s<r;s++)Go.fromBufferAttribute(h,s),Qo(Go,s,o,i,e,t,this)}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const s=e[t[0]];if(void 0!==s){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=s.length;e<t;e++){const t=s[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}};function Qo(e,t,s,i,r,n,a){const o=Yo.distanceSqToPoint(e);if(o<s){const s=new Qi;Yo.closestPointToPoint(e,s),s.applyMatrix4(i);const l=r.ray.origin.distanceTo(s);if(l<r.near||l>r.far)return;n.push({distance:l,distanceToRay:Math.sqrt(o),point:s,index:t,face:null,faceIndex:null,barycoord:null,object:a})}}var eh=class extends _s{constructor(e,t){super({width:e,height:t}),this.isFramebufferTexture=!0,this.magFilter=gt,this.minFilter=gt,this.generateMipmaps=!1,this.needsUpdate=!0}},ah=class extends _s{constructor(e,t,s=1014,i,r,n,a=1003,o=1003,l,h=1026,u=1){if(h!==Wt&&1027!==h)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");super({width:e,height:t,depth:u},i,r,n,a,o,h,s,l),this.isDepthTexture=!0,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(e){return super.copy(e),this.source=new vs(Object.assign({},e.image)),this.compareFunction=e.compareFunction,this}toJSON(e){const t=super.toJSON(e);return null!==this.compareFunction&&(t.compareFunction=this.compareFunction),t}},oh=class e extends Cn{constructor(e=1,t=1,s=4,i=8,r=1){super(),this.type="CapsuleGeometry",this.parameters={radius:e,height:t,capSegments:s,radialSegments:i,heightSegments:r},t=Math.max(0,t),s=Math.max(1,Math.floor(s)),i=Math.max(3,Math.floor(i)),r=Math.max(1,Math.floor(r));const n=[],a=[],o=[],l=[],h=t/2,u=Math.PI/2*e,c=t,d=2*u+c,p=2*s+r,_=i+1,m=new Qi,f=new Qi;for(let g=0;g<=p;g++){let y=0,S=0,T=0,x=0;if(g<=s){const t=g/s,i=t*Math.PI/2;S=-h-e*Math.cos(i),T=e*Math.sin(i),x=-e*Math.cos(i),y=t*u}else if(g<=s+r){const i=(g-s)/r;S=i*t-h,T=e,x=0,y=u+i*c}else{const t=(g-s-r)/s,i=t*Math.PI/2;S=h+e*Math.sin(i),T=e*Math.cos(i),x=e*Math.sin(i),y=u+c+t*u}const b=Math.max(0,Math.min(1,y/d));let G=0;0===g?G=.5/i:g===p&&(G=-.5/i);for(let e=0;e<=i;e++){const t=e/i,s=t*Math.PI*2,r=Math.sin(s),n=Math.cos(s);f.x=-T*n,f.y=S,f.z=T*r,a.push(f.x,f.y,f.z),m.set(-T*n,x,T*r),m.normalize(),o.push(m.x,m.y,m.z),l.push(t+G,b)}if(g>0){const e=(g-1)*_;for(let t=0;t<i;t++){const s=e+t,i=e+t+1,r=g*_+t,a=g*_+t+1;n.push(s,i,r),n.push(i,a,r)}}}this.setIndex(n),this.setAttribute("position",new vn(a,3)),this.setAttribute("normal",new vn(o,3)),this.setAttribute("uv",new vn(l,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(t){return new e(t.radius,t.height,t.capSegments,t.radialSegments,t.heightSegments)}},hh=class e extends Cn{constructor(e=1,t=32,s=0,i=2*Math.PI){super(),this.type="CircleGeometry",this.parameters={radius:e,segments:t,thetaStart:s,thetaLength:i},t=Math.max(3,t);const r=[],n=[],a=[],o=[],l=new Qi,h=new Gi;n.push(0,0,0),a.push(0,0,1),o.push(.5,.5);for(let r=0,u=3;r<=t;r++,u+=3){const c=s+r/t*i;l.x=e*Math.cos(c),l.y=e*Math.sin(c),n.push(l.x,l.y,l.z),a.push(0,0,1),h.x=(n[u]/e+1)/2,h.y=(n[u+1]/e+1)/2,o.push(h.x,h.y)}for(let e=1;e<=t;e++)r.push(e,e+1,0);this.setIndex(r),this.setAttribute("position",new vn(n,3)),this.setAttribute("normal",new vn(a,3)),this.setAttribute("uv",new vn(o,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(t){return new e(t.radius,t.segments,t.thetaStart,t.thetaLength)}},lh=class e extends Cn{constructor(e=1,t=1,s=1,i=32,r=1,n=!1,a=0,o=2*Math.PI){super(),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:s,radialSegments:i,heightSegments:r,openEnded:n,thetaStart:a,thetaLength:o};const l=this;i=Math.floor(i),r=Math.floor(r);const h=[],u=[],c=[],d=[];let p=0;const _=[],m=s/2;let f=0;function g(s){const r=p,n=new Gi,_=new Qi;let g=0;const y=!0===s?e:t,S=!0===s?1:-1;for(let e=1;e<=i;e++)u.push(0,m*S,0),c.push(0,S,0),d.push(.5,.5),p++;const T=p;for(let e=0;e<=i;e++){const t=e/i*o+a,s=Math.cos(t),r=Math.sin(t);_.x=y*r,_.y=m*S,_.z=y*s,u.push(_.x,_.y,_.z),c.push(0,S,0),n.x=.5*s+.5,n.y=.5*r*S+.5,d.push(n.x,n.y),p++}for(let e=0;e<i;e++){const t=r+e,i=T+e;!0===s?h.push(i,i+1,t):h.push(i+1,i,t),g+=3}l.addGroup(f,g,!0===s?1:2),f+=g}!function(){const n=new Qi,g=new Qi;let y=0;const S=(t-e)/s;for(let l=0;l<=r;l++){const h=[],f=l/r,y=f*(t-e)+e;for(let e=0;e<=i;e++){const t=e/i,r=t*o+a,l=Math.sin(r),_=Math.cos(r);g.x=y*l,g.y=-f*s+m,g.z=y*_,u.push(g.x,g.y,g.z),n.set(l,S,_).normalize(),c.push(n.x,n.y,n.z),d.push(t,1-f),h.push(p++)}_.push(h)}for(let s=0;s<i;s++)for(let i=0;i<r;i++){const n=_[i][s],a=_[i+1][s],o=_[i+1][s+1],l=_[i][s+1];(e>0||0!==i)&&(h.push(n,a,l),y+=3),(t>0||i!==r-1)&&(h.push(a,o,l),y+=3)}l.addGroup(f,y,0),f+=y}(),!1===n&&(e>0&&g(!0),t>0&&g(!1)),this.setIndex(h),this.setAttribute("position",new vn(u,3)),this.setAttribute("normal",new vn(c,3)),this.setAttribute("uv",new vn(d,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(t){return new e(t.radiusTop,t.radiusBottom,t.height,t.radialSegments,t.heightSegments,t.openEnded,t.thetaStart,t.thetaLength)}},ch=class e extends lh{constructor(e=1,t=1,s=32,i=1,r=!1,n=0,a=2*Math.PI){super(0,e,t,s,i,r,n,a),this.type="ConeGeometry",this.parameters={radius:e,height:t,radialSegments:s,heightSegments:i,openEnded:r,thetaStart:n,thetaLength:a}}static fromJSON(t){return new e(t.radius,t.height,t.radialSegments,t.heightSegments,t.openEnded,t.thetaStart,t.thetaLength)}},uh=class e extends Cn{constructor(e=[],t=[],s=1,i=0){super(),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:t,radius:s,detail:i};const r=[],n=[];function a(e,t,s,i){const r=i+1,n=[];for(let i=0;i<=r;i++){n[i]=[];const a=e.clone().lerp(s,i/r),o=t.clone().lerp(s,i/r),l=r-i;for(let e=0;e<=l;e++)n[i][e]=0===e&&i===r?a:a.clone().lerp(o,e/l)}for(let e=0;e<r;e++)for(let t=0;t<2*(r-e)-1;t++){const s=Math.floor(t/2);t%2==0?(o(n[e][s+1]),o(n[e+1][s]),o(n[e][s])):(o(n[e][s+1]),o(n[e+1][s+1]),o(n[e+1][s]))}}function o(e){r.push(e.x,e.y,e.z)}function l(t,s){const i=3*t;s.x=e[i+0],s.y=e[i+1],s.z=e[i+2]}function h(e,t,s,i){i<0&&1===e.x&&(n[t]=e.x-1),0===s.x&&0===s.z&&(n[t]=i/2/Math.PI+.5)}function u(e){return Math.atan2(e.z,-e.x)}function c(e){return Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z))}!function(e){const s=new Qi,i=new Qi,r=new Qi;for(let n=0;n<t.length;n+=3)l(t[n+0],s),l(t[n+1],i),l(t[n+2],r),a(s,i,r,e)}(i),function(e){const t=new Qi;for(let s=0;s<r.length;s+=3)t.x=r[s+0],t.y=r[s+1],t.z=r[s+2],t.normalize().multiplyScalar(e),r[s+0]=t.x,r[s+1]=t.y,r[s+2]=t.z}(s),function(){const e=new Qi;for(let t=0;t<r.length;t+=3){e.x=r[t+0],e.y=r[t+1],e.z=r[t+2];const s=u(e)/2/Math.PI+.5,i=c(e)/Math.PI+.5;n.push(s,1-i)}(function(){const e=new Qi,t=new Qi,s=new Qi,i=new Qi,a=new Gi,o=new Gi,l=new Gi;for(let c=0,d=0;c<r.length;c+=9,d+=6){e.set(r[c+0],r[c+1],r[c+2]),t.set(r[c+3],r[c+4],r[c+5]),s.set(r[c+6],r[c+7],r[c+8]),a.set(n[d+0],n[d+1]),o.set(n[d+2],n[d+3]),l.set(n[d+4],n[d+5]),i.copy(e).add(t).add(s).divideScalar(3);const p=u(i);h(a,d+0,e,p),h(o,d+2,t,p),h(l,d+4,s,p)}})(),function(){for(let e=0;e<n.length;e+=6){const t=n[e+0],s=n[e+2],i=n[e+4],r=Math.max(t,s,i),a=Math.min(t,s,i);r>.9&&a<.1&&(t<.2&&(n[e+0]+=1),s<.2&&(n[e+2]+=1),i<.2&&(n[e+4]+=1))}}()}(),this.setAttribute("position",new vn(r,3)),this.setAttribute("normal",new vn(r.slice(),3)),this.setAttribute("uv",new vn(n,2)),0===i?this.computeVertexNormals():this.normalizeNormals()}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(t){return new e(t.vertices,t.indices,t.radius,t.details)}},dh=class e extends uh{constructor(e=1,t=0){const s=(1+Math.sqrt(5))/2,i=1/s;super([-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-i,-s,0,-i,s,0,i,-s,0,i,s,-i,-s,0,-i,s,0,i,-s,0,i,s,0,-s,0,-i,s,0,-i,-s,0,i,s,0,i],[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9],e,t),this.type="DodecahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(t){return new e(t.radius,t.detail)}},ph=new Qi,mh=new Qi,yh=new Qi,gh=new Jr,fh=class extends Cn{constructor(e=null,t=1){if(super(),this.type="EdgesGeometry",this.parameters={geometry:e,thresholdAngle:t},null!==e){const s=4,i=Math.pow(10,s),r=Math.cos(Wi*t),n=e.getIndex(),a=e.getAttribute("position"),o=n?n.count:a.count,l=[0,0,0],h=["a","b","c"],u=new Array(3),c={},d=[];for(let e=0;e<o;e+=3){n?(l[0]=n.getX(e),l[1]=n.getX(e+1),l[2]=n.getX(e+2)):(l[0]=e,l[1]=e+1,l[2]=e+2);const{a:t,b:s,c:o}=gh;if(t.fromBufferAttribute(a,l[0]),s.fromBufferAttribute(a,l[1]),o.fromBufferAttribute(a,l[2]),gh.getNormal(yh),u[0]=`${Math.round(t.x*i)},${Math.round(t.y*i)},${Math.round(t.z*i)}`,u[1]=`${Math.round(s.x*i)},${Math.round(s.y*i)},${Math.round(s.z*i)}`,u[2]=`${Math.round(o.x*i)},${Math.round(o.y*i)},${Math.round(o.z*i)}`,u[0]!==u[1]&&u[1]!==u[2]&&u[2]!==u[0])for(let e=0;e<3;e++){const t=(e+1)%3,s=u[e],i=u[t],n=gh[h[e]],a=gh[h[t]],o=`${s}_${i}`,p=`${i}_${s}`;p in c&&c[p]?(yh.dot(c[p].normal)<=r&&(d.push(n.x,n.y,n.z),d.push(a.x,a.y,a.z)),c[p]=null):o in c||(c[o]={index0:l[e],index1:l[t],normal:yh.clone()})}}for(const e in c)if(c[e]){const{index0:t,index1:s}=c[e];ph.fromBufferAttribute(a,t),mh.fromBufferAttribute(a,s),d.push(ph.x,ph.y,ph.z),d.push(mh.x,mh.y,mh.z)}this.setAttribute("position",new vn(d,3))}}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}},xh=class{constructor(){this.type="Curve",this.arcLengthDivisions=200,this.needsUpdate=!1,this.cacheArcLengths=null}getPoint(){console.warn("THREE.Curve: .getPoint() not implemented.")}getPointAt(e,t){const s=this.getUtoTmapping(e);return this.getPoint(s,t)}getPoints(e=5){const t=[];for(let s=0;s<=e;s++)t.push(this.getPoint(s/e));return t}getSpacedPoints(e=5){const t=[];for(let s=0;s<=e;s++)t.push(this.getPointAt(s/e));return t}getLength(){const e=this.getLengths();return e[e.length-1]}getLengths(e=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;const t=[];let s,i=this.getPoint(0),r=0;t.push(0);for(let n=1;n<=e;n++)s=this.getPoint(n/e),r+=s.distanceTo(i),t.push(r),i=s;return this.cacheArcLengths=t,t}updateArcLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(e,t=null){const s=this.getLengths();let i=0;const r=s.length;let n;n=t||e*s[r-1];let a,o=0,l=r-1;for(;o<=l;)if(i=Math.floor(o+(l-o)/2),a=s[i]-n,a<0)o=i+1;else{if(!(a>0)){l=i;break}l=i-1}if(i=l,s[i]===n)return i/(r-1);const h=s[i];return(i+(n-h)/(s[i+1]-h))/(r-1)}getTangent(e,t){const s=1e-4;let i=e-s,r=e+s;i<0&&(i=0),r>1&&(r=1);const n=this.getPoint(i),a=this.getPoint(r),o=t||(n.isVector2?new Gi:new Qi);return o.copy(a).sub(n).normalize(),o}getTangentAt(e,t){const s=this.getUtoTmapping(e);return this.getTangent(s,t)}computeFrenetFrames(e,t=!1){const s=new Qi,i=[],r=[],n=[],a=new Qi,o=new nr;for(let t=0;t<=e;t++){const s=t/e;i[t]=this.getTangentAt(s,new Qi)}r[0]=new Qi,n[0]=new Qi;let l=Number.MAX_VALUE;const h=Math.abs(i[0].x),u=Math.abs(i[0].y),c=Math.abs(i[0].z);h<=l&&(l=h,s.set(1,0,0)),u<=l&&(l=u,s.set(0,1,0)),c<=l&&s.set(0,0,1),a.crossVectors(i[0],s).normalize(),r[0].crossVectors(i[0],a),n[0].crossVectors(i[0],r[0]);for(let t=1;t<=e;t++){if(r[t]=r[t-1].clone(),n[t]=n[t-1].clone(),a.crossVectors(i[t-1],i[t]),a.length()>Number.EPSILON){a.normalize();const e=Math.acos(Hi(i[t-1].dot(i[t]),-1,1));r[t].applyMatrix4(o.makeRotationAxis(a,e))}n[t].crossVectors(i[t],r[t])}if(!0===t){let t=Math.acos(Hi(r[0].dot(r[e]),-1,1));t/=e,i[0].dot(a.crossVectors(r[0],r[e]))>0&&(t=-t);for(let s=1;s<=e;s++)r[s].applyMatrix4(o.makeRotationAxis(i[s],t*s)),n[s].crossVectors(i[s],r[s])}return{tangents:i,normals:r,binormals:n}}clone(){return(new this.constructor).copy(this)}copy(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}toJSON(){const e={metadata:{version:4.7,type:"Curve",generator:"Curve.toJSON"}};return e.arcLengthDivisions=this.arcLengthDivisions,e.type=this.type,e}fromJSON(e){return this.arcLengthDivisions=e.arcLengthDivisions,this}},bh=class extends xh{constructor(e=0,t=0,s=1,i=1,r=0,n=2*Math.PI,a=!1,o=0){super(),this.isEllipseCurve=!0,this.type="EllipseCurve",this.aX=e,this.aY=t,this.xRadius=s,this.yRadius=i,this.aStartAngle=r,this.aEndAngle=n,this.aClockwise=a,this.aRotation=o}getPoint(e,t=new Gi){const s=t,i=2*Math.PI;let r=this.aEndAngle-this.aStartAngle;const n=Math.abs(r)<Number.EPSILON;for(;r<0;)r+=i;for(;r>i;)r-=i;r<Number.EPSILON&&(r=n?0:i),!0!==this.aClockwise||n||(r===i?r=-i:r-=i);const a=this.aStartAngle+e*r;let o=this.aX+this.xRadius*Math.cos(a),l=this.aY+this.yRadius*Math.sin(a);if(0!==this.aRotation){const e=Math.cos(this.aRotation),t=Math.sin(this.aRotation),s=o-this.aX,i=l-this.aY;o=s*e-i*t+this.aX,l=s*t+i*e+this.aY}return s.set(o,l)}copy(e){return super.copy(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}toJSON(){const e=super.toJSON();return e.aX=this.aX,e.aY=this.aY,e.xRadius=this.xRadius,e.yRadius=this.yRadius,e.aStartAngle=this.aStartAngle,e.aEndAngle=this.aEndAngle,e.aClockwise=this.aClockwise,e.aRotation=this.aRotation,e}fromJSON(e){return super.fromJSON(e),this.aX=e.aX,this.aY=e.aY,this.xRadius=e.xRadius,this.yRadius=e.yRadius,this.aStartAngle=e.aStartAngle,this.aEndAngle=e.aEndAngle,this.aClockwise=e.aClockwise,this.aRotation=e.aRotation,this}},vh=class extends bh{constructor(e,t,s,i,r,n){super(e,t,s,s,i,r,n),this.isArcCurve=!0,this.type="ArcCurve"}};function wh(){let e=0,t=0,s=0,i=0;function r(r,n,a,o){e=r,t=a,s=-3*r+3*n-2*a-o,i=2*r-2*n+a+o}return{initCatmullRom:function(e,t,s,i,n){r(t,s,n*(s-e),n*(i-t))},initNonuniformCatmullRom:function(e,t,s,i,n,a,o){let l=(t-e)/n-(s-e)/(n+a)+(s-t)/a,h=(s-t)/a-(i-t)/(a+o)+(i-s)/o;l*=a,h*=a,r(t,s,l,h)},calc:function(r){const n=r*r;return e+t*r+s*n+i*(n*r)}}}var Mh=new Qi,Sh=new wh,_h=new wh,Ah=new wh,Th=class extends xh{constructor(e=[],t=!1,s="centripetal",i=.5){super(),this.isCatmullRomCurve3=!0,this.type="CatmullRomCurve3",this.points=e,this.closed=t,this.curveType=s,this.tension=i}getPoint(e,t=new Qi){const s=t,i=this.points,r=i.length,n=(r-(this.closed?0:1))*e;let a,o,l=Math.floor(n),h=n-l;this.closed?l+=l>0?0:(Math.floor(Math.abs(l)/r)+1)*r:0===h&&l===r-1&&(l=r-2,h=1),this.closed||l>0?a=i[(l-1)%r]:(Mh.subVectors(i[0],i[1]).add(i[0]),a=Mh);const u=i[l%r],c=i[(l+1)%r];if(this.closed||l+2<r?o=i[(l+2)%r]:(Mh.subVectors(i[r-1],i[r-2]).add(i[r-1]),o=Mh),"centripetal"===this.curveType||"chordal"===this.curveType){const e="chordal"===this.curveType?.5:.25;let t=Math.pow(a.distanceToSquared(u),e),s=Math.pow(u.distanceToSquared(c),e),i=Math.pow(c.distanceToSquared(o),e);s<1e-4&&(s=1),t<1e-4&&(t=s),i<1e-4&&(i=s),Sh.initNonuniformCatmullRom(a.x,u.x,c.x,o.x,t,s,i),_h.initNonuniformCatmullRom(a.y,u.y,c.y,o.y,t,s,i),Ah.initNonuniformCatmullRom(a.z,u.z,c.z,o.z,t,s,i)}else"catmullrom"===this.curveType&&(Sh.initCatmullRom(a.x,u.x,c.x,o.x,this.tension),_h.initCatmullRom(a.y,u.y,c.y,o.y,this.tension),Ah.initCatmullRom(a.z,u.z,c.z,o.z,this.tension));return s.set(Sh.calc(h),_h.calc(h),Ah.calc(h)),s}copy(e){super.copy(e),this.points=[];for(let t=0,s=e.points.length;t<s;t++){const s=e.points[t];this.points.push(s.clone())}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,s=this.points.length;t<s;t++){const s=this.points[t];e.points.push(s.toArray())}return e.closed=this.closed,e.curveType=this.curveType,e.tension=this.tension,e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,s=e.points.length;t<s;t++){const s=e.points[t];this.points.push((new Qi).fromArray(s))}return this.closed=e.closed,this.curveType=e.curveType,this.tension=e.tension,this}};function zh(e,t,s,i,r){const n=.5*(i-t),a=.5*(r-s),o=e*e;return(2*s-2*i+n+a)*(e*o)+(-3*s+3*i-2*n-a)*o+n*e+s}function Ch(e,t,s,i){return function(e,t){const s=1-e;return s*s*t}(e,t)+2*(1-(r=e))*r*s+function(e,t){return e*e*t}(e,i);var r}function Ih(e,t,s,i,r){return function(e,t){const s=1-e;return s*s*s*t}(e,t)+function(e,t){const s=1-e;return 3*s*s*e*t}(e,s)+3*(1-(n=e))*n*n*i+function(e,t){return e*e*e*t}(e,r);var n}var Bh=class extends xh{constructor(e=new Gi,t=new Gi,s=new Gi,i=new Gi){super(),this.isCubicBezierCurve=!0,this.type="CubicBezierCurve",this.v0=e,this.v1=t,this.v2=s,this.v3=i}getPoint(e,t=new Gi){const s=t,i=this.v0,r=this.v1,n=this.v2,a=this.v3;return s.set(Ih(e,i.x,r.x,n.x,a.x),Ih(e,i.y,r.y,n.y,a.y)),s}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}},kh=class extends xh{constructor(e=new Qi,t=new Qi,s=new Qi,i=new Qi){super(),this.isCubicBezierCurve3=!0,this.type="CubicBezierCurve3",this.v0=e,this.v1=t,this.v2=s,this.v3=i}getPoint(e,t=new Qi){const s=t,i=this.v0,r=this.v1,n=this.v2,a=this.v3;return s.set(Ih(e,i.x,r.x,n.x,a.x),Ih(e,i.y,r.y,n.y,a.y),Ih(e,i.z,r.z,n.z,a.z)),s}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this.v3.copy(e.v3),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e.v3=this.v3.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this.v3.fromArray(e.v3),this}},Eh=class extends xh{constructor(e=new Gi,t=new Gi){super(),this.isLineCurve=!0,this.type="LineCurve",this.v1=e,this.v2=t}getPoint(e,t=new Gi){const s=t;return 1===e?s.copy(this.v2):(s.copy(this.v2).sub(this.v1),s.multiplyScalar(e).add(this.v1)),s}getPointAt(e,t){return this.getPoint(e,t)}getTangent(e,t=new Gi){return t.subVectors(this.v2,this.v1).normalize()}getTangentAt(e,t){return this.getTangent(e,t)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}},Rh=class extends xh{constructor(e=new Qi,t=new Qi){super(),this.isLineCurve3=!0,this.type="LineCurve3",this.v1=e,this.v2=t}getPoint(e,t=new Qi){const s=t;return 1===e?s.copy(this.v2):(s.copy(this.v2).sub(this.v1),s.multiplyScalar(e).add(this.v1)),s}getPointAt(e,t){return this.getPoint(e,t)}getTangent(e,t=new Qi){return t.subVectors(this.v2,this.v1).normalize()}getTangentAt(e,t){return this.getTangent(e,t)}copy(e){return super.copy(e),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}},Ph=class extends xh{constructor(e=new Gi,t=new Gi,s=new Gi){super(),this.isQuadraticBezierCurve=!0,this.type="QuadraticBezierCurve",this.v0=e,this.v1=t,this.v2=s}getPoint(e,t=new Gi){const s=t,i=this.v0,r=this.v1,n=this.v2;return s.set(Ch(e,i.x,r.x,n.x),Ch(e,i.y,r.y,n.y)),s}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}},Oh=class extends xh{constructor(e=new Qi,t=new Qi,s=new Qi){super(),this.isQuadraticBezierCurve3=!0,this.type="QuadraticBezierCurve3",this.v0=e,this.v1=t,this.v2=s}getPoint(e,t=new Qi){const s=t,i=this.v0,r=this.v1,n=this.v2;return s.set(Ch(e,i.x,r.x,n.x),Ch(e,i.y,r.y,n.y),Ch(e,i.z,r.z,n.z)),s}copy(e){return super.copy(e),this.v0.copy(e.v0),this.v1.copy(e.v1),this.v2.copy(e.v2),this}toJSON(){const e=super.toJSON();return e.v0=this.v0.toArray(),e.v1=this.v1.toArray(),e.v2=this.v2.toArray(),e}fromJSON(e){return super.fromJSON(e),this.v0.fromArray(e.v0),this.v1.fromArray(e.v1),this.v2.fromArray(e.v2),this}},Nh=class extends xh{constructor(e=[]){super(),this.isSplineCurve=!0,this.type="SplineCurve",this.points=e}getPoint(e,t=new Gi){const s=t,i=this.points,r=(i.length-1)*e,n=Math.floor(r),a=r-n,o=i[0===n?n:n-1],l=i[n],h=i[n>i.length-2?i.length-1:n+1],u=i[n>i.length-3?i.length-1:n+2];return s.set(zh(a,o.x,l.x,h.x,u.x),zh(a,o.y,l.y,h.y,u.y)),s}copy(e){super.copy(e),this.points=[];for(let t=0,s=e.points.length;t<s;t++){const s=e.points[t];this.points.push(s.clone())}return this}toJSON(){const e=super.toJSON();e.points=[];for(let t=0,s=this.points.length;t<s;t++){const s=this.points[t];e.points.push(s.toArray())}return e}fromJSON(e){super.fromJSON(e),this.points=[];for(let t=0,s=e.points.length;t<s;t++){const s=e.points[t];this.points.push((new Gi).fromArray(s))}return this}},Vh=Object.freeze({__proto__:null,ArcCurve:vh,CatmullRomCurve3:Th,CubicBezierCurve:Bh,CubicBezierCurve3:kh,EllipseCurve:bh,LineCurve:Eh,LineCurve3:Rh,QuadraticBezierCurve:Ph,QuadraticBezierCurve3:Oh,SplineCurve:Nh}),Fh=class extends xh{constructor(){super(),this.type="CurvePath",this.curves=[],this.autoClose=!1}add(e){this.curves.push(e)}closePath(){const e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);if(!e.equals(t)){const s=!0===e.isVector2?"LineCurve":"LineCurve3";this.curves.push(new Vh[s](t,e))}return this}getPoint(e,t){const s=e*this.getLength(),i=this.getCurveLengths();let r=0;for(;r<i.length;){if(i[r]>=s){const e=i[r]-s,n=this.curves[r],a=n.getLength(),o=0===a?0:1-e/a;return n.getPointAt(o,t)}r++}return null}getLength(){const e=this.getCurveLengths();return e[e.length-1]}updateArcLengths(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()}getCurveLengths(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;const e=[];let t=0;for(let s=0,i=this.curves.length;s<i;s++)t+=this.curves[s].getLength(),e.push(t);return this.cacheLengths=e,e}getSpacedPoints(e=40){const t=[];for(let s=0;s<=e;s++)t.push(this.getPoint(s/e));return this.autoClose&&t.push(t[0]),t}getPoints(e=12){const t=[];let s;for(let i=0,r=this.curves;i<r.length;i++){const n=r[i],a=n.isEllipseCurve?2*e:n.isLineCurve||n.isLineCurve3?1:n.isSplineCurve?e*n.points.length:e,o=n.getPoints(a);for(let e=0;e<o.length;e++){const i=o[e];s&&s.equals(i)||(t.push(i),s=i)}}return this.autoClose&&t.length>1&&!t[t.length-1].equals(t[0])&&t.push(t[0]),t}copy(e){super.copy(e),this.curves=[];for(let t=0,s=e.curves.length;t<s;t++){const s=e.curves[t];this.curves.push(s.clone())}return this.autoClose=e.autoClose,this}toJSON(){const e=super.toJSON();e.autoClose=this.autoClose,e.curves=[];for(let t=0,s=this.curves.length;t<s;t++){const s=this.curves[t];e.curves.push(s.toJSON())}return e}fromJSON(e){super.fromJSON(e),this.autoClose=e.autoClose,this.curves=[];for(let t=0,s=e.curves.length;t<s;t++){const s=e.curves[t];this.curves.push((new Vh[s.type]).fromJSON(s))}return this}},Lh=class extends Fh{constructor(e){super(),this.type="Path",this.currentPoint=new Gi,e&&this.setFromPoints(e)}setFromPoints(e){this.moveTo(e[0].x,e[0].y);for(let t=1,s=e.length;t<s;t++)this.lineTo(e[t].x,e[t].y);return this}moveTo(e,t){return this.currentPoint.set(e,t),this}lineTo(e,t){const s=new Eh(this.currentPoint.clone(),new Gi(e,t));return this.curves.push(s),this.currentPoint.set(e,t),this}quadraticCurveTo(e,t,s,i){const r=new Ph(this.currentPoint.clone(),new Gi(e,t),new Gi(s,i));return this.curves.push(r),this.currentPoint.set(s,i),this}bezierCurveTo(e,t,s,i,r,n){const a=new Bh(this.currentPoint.clone(),new Gi(e,t),new Gi(s,i),new Gi(r,n));return this.curves.push(a),this.currentPoint.set(r,n),this}splineThru(e){const t=[this.currentPoint.clone()].concat(e),s=new Nh(t);return this.curves.push(s),this.currentPoint.copy(e[e.length-1]),this}arc(e,t,s,i,r,n){const a=this.currentPoint.x,o=this.currentPoint.y;return this.absarc(e+a,t+o,s,i,r,n),this}absarc(e,t,s,i,r,n){return this.absellipse(e,t,s,s,i,r,n),this}ellipse(e,t,s,i,r,n,a,o){const l=this.currentPoint.x,h=this.currentPoint.y;return this.absellipse(e+l,t+h,s,i,r,n,a,o),this}absellipse(e,t,s,i,r,n,a,o){const l=new bh(e,t,s,i,r,n,a,o);if(this.curves.length>0){const e=l.getPoint(0);e.equals(this.currentPoint)||this.lineTo(e.x,e.y)}this.curves.push(l);const h=l.getPoint(1);return this.currentPoint.copy(h),this}copy(e){return super.copy(e),this.currentPoint.copy(e.currentPoint),this}toJSON(){const e=super.toJSON();return e.currentPoint=this.currentPoint.toArray(),e}fromJSON(e){return super.fromJSON(e),this.currentPoint.fromArray(e.currentPoint),this}},jh=class extends Lh{constructor(e){super(e),this.uuid=Ui(),this.type="Shape",this.holes=[]}getPointsHoles(e){const t=[];for(let s=0,i=this.holes.length;s<i;s++)t[s]=this.holes[s].getPoints(e);return t}extractPoints(e){return{shape:this.getPoints(e),holes:this.getPointsHoles(e)}}copy(e){super.copy(e),this.holes=[];for(let t=0,s=e.holes.length;t<s;t++){const s=e.holes[t];this.holes.push(s.clone())}return this}toJSON(){const e=super.toJSON();e.uuid=this.uuid,e.holes=[];for(let t=0,s=this.holes.length;t<s;t++){const s=this.holes[t];e.holes.push(s.toJSON())}return e}fromJSON(e){super.fromJSON(e),this.uuid=e.uuid,this.holes=[];for(let t=0,s=e.holes.length;t<s;t++){const s=e.holes[t];this.holes.push((new Lh).fromJSON(s))}return this}};function Wh(e,t,s=2){const i=t&&t.length,r=i?t[0]*s:e.length;let n=Dh(e,0,r,s,!0);const a=[];if(!n||n.next===n.prev)return a;let o,l,h;if(i&&(n=function(e,t,s,i){const r=[];for(let s=0,n=t.length;s<n;s++){const a=Dh(e,t[s]*i,s<n-1?t[s+1]*i:e.length,i,!1);a===a.next&&(a.steiner=!0),r.push(Kh(a))}r.sort(Zh);for(let e=0;e<r.length;e++)s=Gh(r[e],s);return s}(e,t,n,s)),e.length>80*s){o=1/0,l=1/0;let t=-1/0,i=-1/0;for(let n=s;n<r;n+=s){const s=e[n],r=e[n+1];s<o&&(o=s),r<l&&(l=r),s>t&&(t=s),r>i&&(i=r)}h=Math.max(t-o,i-l),h=0!==h?32767/h:0}return Hh(n,a,s,o,l,h,0),a}function Dh(e,t,s,i,r){let n;if(r===function(e,t,s,i){let r=0;for(let n=t,a=s-i;n<s;n+=i)r+=(e[a]-e[n])*(e[n+1]+e[a+1]),a=n;return r}(e,t,s,i)>0)for(let r=t;r<s;r+=i)n=cl(r/i|0,e[r],e[r+1],n);else for(let r=s-i;r>=t;r-=i)n=cl(r/i|0,e[r],e[r+1],n);return n&&rl(n,n.next)&&(ul(n),n=n.next),n}function Uh(e,t){if(!e)return e;t||(t=e);let s,i=e;do{if(s=!1,i.steiner||!rl(i,i.next)&&0!==sl(i.prev,i,i.next))i=i.next;else{if(ul(i),i=t=i.prev,i===i.next)break;s=!0}}while(s||i!==t);return t}function Hh(e,t,s,i,r,n,a){if(!e)return;!a&&n&&function(e,t,s,i){let r=e;do{0===r.z&&(r.z=Qh(r.x,r.y,t,s,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){let t,s=1;do{let i,r=e;e=null;let n=null;for(t=0;r;){t++;let a=r,o=0;for(let e=0;e<s&&(o++,a=a.nextZ,a);e++);let l=s;for(;o>0||l>0&&a;)0!==o&&(0===l||!a||r.z<=a.z)?(i=r,r=r.nextZ,o--):(i=a,a=a.nextZ,l--),n?n.nextZ=i:e=i,i.prevZ=n,n=i;r=a}n.nextZ=null,s*=2}while(t>1)}(r)}(e,i,r,n);let o=e;for(;e.prev!==e.next;){const l=e.prev,h=e.next;if(n?Jh(e,i,r,n):qh(e))t.push(l.i,e.i,h.i),ul(e),e=h.next,o=h.next;else if((e=h)===o){a?1===a?Hh(e=Xh(Uh(e),t),t,s,i,r,n,2):2===a&&Yh(e,t,s,i,r,n):Hh(Uh(e),t,s,i,r,n,1);break}}}function qh(e){const t=e.prev,s=e,i=e.next;if(sl(t,s,i)>=0)return!1;const r=t.x,n=s.x,a=i.x,o=t.y,l=s.y,h=i.y,u=Math.min(r,n,a),c=Math.min(o,l,h),d=Math.max(r,n,a),p=Math.max(o,l,h);let _=i.next;for(;_!==t;){if(_.x>=u&&_.x<=d&&_.y>=c&&_.y<=p&&el(r,o,n,l,a,h,_.x,_.y)&&sl(_.prev,_,_.next)>=0)return!1;_=_.next}return!0}function Jh(e,t,s,i){const r=e.prev,n=e,a=e.next;if(sl(r,n,a)>=0)return!1;const o=r.x,l=n.x,h=a.x,u=r.y,c=n.y,d=a.y,p=Math.min(o,l,h),_=Math.min(u,c,d),m=Math.max(o,l,h),f=Math.max(u,c,d),g=Qh(p,_,t,s,i),y=Qh(m,f,t,s,i);let S=e.prevZ,T=e.nextZ;for(;S&&S.z>=g&&T&&T.z<=y;){if(S.x>=p&&S.x<=m&&S.y>=_&&S.y<=f&&S!==r&&S!==a&&el(o,u,l,c,h,d,S.x,S.y)&&sl(S.prev,S,S.next)>=0)return!1;if(S=S.prevZ,T.x>=p&&T.x<=m&&T.y>=_&&T.y<=f&&T!==r&&T!==a&&el(o,u,l,c,h,d,T.x,T.y)&&sl(T.prev,T,T.next)>=0)return!1;T=T.nextZ}for(;S&&S.z>=g;){if(S.x>=p&&S.x<=m&&S.y>=_&&S.y<=f&&S!==r&&S!==a&&el(o,u,l,c,h,d,S.x,S.y)&&sl(S.prev,S,S.next)>=0)return!1;S=S.prevZ}for(;T&&T.z<=y;){if(T.x>=p&&T.x<=m&&T.y>=_&&T.y<=f&&T!==r&&T!==a&&el(o,u,l,c,h,d,T.x,T.y)&&sl(T.prev,T,T.next)>=0)return!1;T=T.nextZ}return!0}function Xh(e,t){let s=e;do{const i=s.prev,r=s.next.next;!rl(i,r)&&nl(i,s,s.next,r)&&hl(i,r)&&hl(r,i)&&(t.push(i.i,s.i,r.i),ul(s),ul(s.next),s=e=r),s=s.next}while(s!==e);return Uh(s)}function Yh(e,t,s,i,r,n){let a=e;do{let e=a.next.next;for(;e!==a.prev;){if(a.i!==e.i&&il(a,e)){let o=ll(a,e);return a=Uh(a,a.next),o=Uh(o,o.next),Hh(a,t,s,i,r,n,0),void Hh(o,t,s,i,r,n,0)}e=e.next}a=a.next}while(a!==e)}function Zh(e,t){let s=e.x-t.x;return 0===s&&(s=e.y-t.y,0===s)&&(s=(e.next.y-e.y)/(e.next.x-e.x)-(t.next.y-t.y)/(t.next.x-t.x)),s}function Gh(e,t){const s=function(e,t){let s=t;const i=e.x,r=e.y;let n,a=-1/0;if(rl(e,s))return s;do{if(rl(e,s.next))return s.next;if(r<=s.y&&r>=s.next.y&&s.next.y!==s.y){const e=s.x+(r-s.y)*(s.next.x-s.x)/(s.next.y-s.y);if(e<=i&&e>a&&(a=e,n=s.x<s.next.x?s:s.next,e===i))return n}s=s.next}while(s!==t);if(!n)return null;const o=n,l=n.x,h=n.y;let u=1/0;s=n;do{if(i>=s.x&&s.x>=l&&i!==s.x&&tl(r<h?i:a,r,l,h,r<h?a:i,r,s.x,s.y)){const t=Math.abs(r-s.y)/(i-s.x);hl(s,e)&&(t<u||t===u&&(s.x>n.x||s.x===n.x&&$h(n,s)))&&(n=s,u=t)}s=s.next}while(s!==o);return n}(e,t);if(!s)return t;const i=ll(s,e);return Uh(i,i.next),Uh(s,s.next)}function $h(e,t){return sl(e.prev,e,t.prev)<0&&sl(t.next,e,e.next)<0}function Qh(e,t,s,i,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-s)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-i)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function Kh(e){let t=e,s=e;do{(t.x<s.x||t.x===s.x&&t.y<s.y)&&(s=t),t=t.next}while(t!==e);return s}function tl(e,t,s,i,r,n,a,o){return(r-a)*(t-o)>=(e-a)*(n-o)&&(e-a)*(i-o)>=(s-a)*(t-o)&&(s-a)*(n-o)>=(r-a)*(i-o)}function el(e,t,s,i,r,n,a,o){return!(e===a&&t===o)&&tl(e,t,s,i,r,n,a,o)}function il(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){let s=e;do{if(s.i!==e.i&&s.next.i!==e.i&&s.i!==t.i&&s.next.i!==t.i&&nl(s,s.next,e,t))return!0;s=s.next}while(s!==e);return!1}(e,t)&&(hl(e,t)&&hl(t,e)&&function(e,t){let s=e,i=!1;const r=(e.x+t.x)/2,n=(e.y+t.y)/2;do{s.y>n!=s.next.y>n&&s.next.y!==s.y&&r<(s.next.x-s.x)*(n-s.y)/(s.next.y-s.y)+s.x&&(i=!i),s=s.next}while(s!==e);return i}(e,t)&&(sl(e.prev,e,t.prev)||sl(e,t.prev,t))||rl(e,t)&&sl(e.prev,e,e.next)>0&&sl(t.prev,t,t.next)>0)}function sl(e,t,s){return(t.y-e.y)*(s.x-t.x)-(t.x-e.x)*(s.y-t.y)}function rl(e,t){return e.x===t.x&&e.y===t.y}function nl(e,t,s,i){const r=ol(sl(e,t,s)),n=ol(sl(e,t,i)),a=ol(sl(s,i,e)),o=ol(sl(s,i,t));return r!==n&&a!==o||!(0!==r||!al(e,s,t))||!(0!==n||!al(e,i,t))||!(0!==a||!al(s,e,i))||!(0!==o||!al(s,t,i))}function al(e,t,s){return t.x<=Math.max(e.x,s.x)&&t.x>=Math.min(e.x,s.x)&&t.y<=Math.max(e.y,s.y)&&t.y>=Math.min(e.y,s.y)}function ol(e){return e>0?1:e<0?-1:0}function hl(e,t){return sl(e.prev,e,e.next)<0?sl(e,t,e.next)>=0&&sl(e,e.prev,t)>=0:sl(e,t,e.prev)<0||sl(e,e.next,t)<0}function ll(e,t){const s=dl(e.i,e.x,e.y),i=dl(t.i,t.x,t.y),r=e.next,n=t.prev;return e.next=t,t.prev=e,s.next=r,r.prev=s,i.next=s,s.prev=i,n.next=i,i.prev=n,i}function cl(e,t,s,i){const r=dl(e,t,s);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function ul(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function dl(e,t,s){return{i:e,x:t,y:s,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}var pl=class{static triangulate(e,t,s=2){return Wh(e,t,s)}},ml=class e{static area(e){const t=e.length;let s=0;for(let i=t-1,r=0;r<t;i=r++)s+=e[i].x*e[r].y-e[r].x*e[i].y;return.5*s}static isClockWise(t){return e.area(t)<0}static triangulateShape(e,t){const s=[],i=[],r=[];yl(e),gl(s,e);let n=e.length;t.forEach(yl);for(let e=0;e<t.length;e++)i.push(n),n+=t[e].length,gl(s,t[e]);const a=pl.triangulate(s,i);for(let e=0;e<a.length;e+=3)r.push(a.slice(e,e+3));return r}};function yl(e){const t=e.length;t>2&&e[t-1].equals(e[0])&&e.pop()}function gl(e,t){for(let s=0;s<t.length;s++)e.push(t[s].x),e.push(t[s].y)}var fl=class e extends Cn{constructor(e=new jh([new Gi(.5,.5),new Gi(-.5,.5),new Gi(-.5,-.5),new Gi(.5,-.5)]),t={}){super(),this.type="ExtrudeGeometry",this.parameters={shapes:e,options:t},e=Array.isArray(e)?e:[e];const s=this,i=[],r=[];for(let t=0,s=e.length;t<s;t++)n(e[t]);function n(e){const n=[],a=void 0!==t.curveSegments?t.curveSegments:12,o=void 0!==t.steps?t.steps:1,l=void 0!==t.depth?t.depth:1;let h=void 0===t.bevelEnabled||t.bevelEnabled,u=void 0!==t.bevelThickness?t.bevelThickness:.2,c=void 0!==t.bevelSize?t.bevelSize:u-.1,d=void 0!==t.bevelOffset?t.bevelOffset:0,p=void 0!==t.bevelSegments?t.bevelSegments:3;const _=t.extrudePath,m=void 0!==t.UVGenerator?t.UVGenerator:xl;let f,g,y,S,T,x=!1;_&&(f=_.getSpacedPoints(o),x=!0,h=!1,g=_.computeFrenetFrames(o,!1),y=new Qi,S=new Qi,T=new Qi),h||(p=0,u=0,c=0,d=0);const b=e.extractPoints(a);let G=b.shape;const I=b.holes;if(!ml.isClockWise(G)){G=G.reverse();for(let e=0,t=I.length;e<t;e++){const t=I[e];ml.isClockWise(t)&&(I[e]=t.reverse())}}function v(e){const t=1e-10*1e-10;let s=e[0];for(let i=1;i<=e.length;i++){const r=i%e.length,n=e[r],a=n.x-s.x,o=n.y-s.y,l=a*a+o*o,h=Math.max(Math.abs(n.x),Math.abs(n.y),Math.abs(s.x),Math.abs(s.y));l<=t*h*h?(e.splice(r,1),i--):s=n}}v(G),I.forEach(v);const C=I.length,w=G;for(let e=0;e<C;e++){const t=I[e];G=G.concat(t)}function A(e,t,s){return t||console.error("THREE.ExtrudeGeometry: vec does not exist"),e.clone().addScaledVector(t,s)}const R=G.length;function P(e,t,s){let i,r,n;const a=e.x-t.x,o=e.y-t.y,l=s.x-e.x,h=s.y-e.y,u=a*a+o*o,c=a*h-o*l;if(Math.abs(c)>Number.EPSILON){const c=Math.sqrt(u),d=Math.sqrt(l*l+h*h),p=t.x-o/c,_=t.y+a/c,m=((s.x-h/d-p)*h-(s.y+l/d-_)*l)/(a*h-o*l);i=p+a*m-e.x,r=_+o*m-e.y;const f=i*i+r*r;if(f<=2)return new Gi(i,r);n=Math.sqrt(f/2)}else{let e=!1;a>Number.EPSILON?l>Number.EPSILON&&(e=!0):a<-Number.EPSILON?l<-Number.EPSILON&&(e=!0):Math.sign(o)===Math.sign(h)&&(e=!0),e?(i=-o,r=a,n=Math.sqrt(u)):(i=a,r=o,n=Math.sqrt(u/2))}return new Gi(i/n,r/n)}const M=[];for(let e=0,t=w.length,s=t-1,i=e+1;e<t;e++,s++,i++)s===t&&(s=0),i===t&&(i=0),M[e]=P(w[e],w[s],w[i]);const E=[];let D,N,F=M.concat();for(let e=0,t=C;e<t;e++){const t=I[e];D=[];for(let e=0,s=t.length,i=s-1,r=e+1;e<s;e++,i++,r++)i===s&&(i=0),r===s&&(r=0),D[e]=P(t[e],t[i],t[r]);E.push(D),F=F.concat(D)}if(0===p)N=ml.triangulateShape(w,I);else{const e=[],t=[];for(let s=0;s<p;s++){const i=s/p,r=u*Math.cos(i*Math.PI/2),n=c*Math.sin(i*Math.PI/2)+d;for(let t=0,s=w.length;t<s;t++){const s=A(w[t],M[t],n);k(s.x,s.y,-r),0===i&&e.push(s)}for(let e=0,s=C;e<s;e++){const s=I[e];D=E[e];const a=[];for(let e=0,t=s.length;e<t;e++){const t=A(s[e],D[e],n);k(t.x,t.y,-r),0===i&&a.push(t)}0===i&&t.push(a)}}N=ml.triangulateShape(e,t)}const O=N.length,B=c+d;for(let e=0;e<R;e++){const t=h?A(G[e],F[e],B):G[e];x?(S.copy(g.normals[0]).multiplyScalar(t.x),y.copy(g.binormals[0]).multiplyScalar(t.y),T.copy(f[0]).add(S).add(y),k(T.x,T.y,T.z)):k(t.x,t.y,0)}for(let e=1;e<=o;e++)for(let t=0;t<R;t++){const s=h?A(G[t],F[t],B):G[t];x?(S.copy(g.normals[e]).multiplyScalar(s.x),y.copy(g.binormals[e]).multiplyScalar(s.y),T.copy(f[e]).add(S).add(y),k(T.x,T.y,T.z)):k(s.x,s.y,l/o*e)}for(let e=p-1;e>=0;e--){const t=e/p,s=u*Math.cos(t*Math.PI/2),i=c*Math.sin(t*Math.PI/2)+d;for(let e=0,t=w.length;e<t;e++){const t=A(w[e],M[e],i);k(t.x,t.y,l+s)}for(let e=0,t=I.length;e<t;e++){const t=I[e];D=E[e];for(let e=0,r=t.length;e<r;e++){const r=A(t[e],D[e],i);x?k(r.x,r.y+f[o-1].y,f[o-1].x+s):k(r.x,r.y,l+s)}}}function L(e,t){let s=e.length;for(;--s>=0;){const i=s;let r=s-1;r<0&&(r=e.length-1);for(let e=0,s=o+2*p;e<s;e++){const s=R*e,n=R*(e+1);U(t+i+s,t+r+s,t+r+n,t+i+n)}}}function k(e,t,s){n.push(e),n.push(t),n.push(s)}function V(e,t,r){W(e),W(t),W(r);const n=i.length/3,a=m.generateTopUV(s,i,n-3,n-2,n-1);H(a[0]),H(a[1]),H(a[2])}function U(e,t,r,n){W(e),W(t),W(n),W(t),W(r),W(n);const a=i.length/3,o=m.generateSideWallUV(s,i,a-6,a-3,a-2,a-1);H(o[0]),H(o[1]),H(o[3]),H(o[1]),H(o[2]),H(o[3])}function W(e){i.push(n[3*e+0]),i.push(n[3*e+1]),i.push(n[3*e+2])}function H(e){r.push(e.x),r.push(e.y)}!function(){const e=i.length/3;if(h){let e=0,t=R*e;for(let e=0;e<O;e++){const s=N[e];V(s[2]+t,s[1]+t,s[0]+t)}e=o+2*p,t=R*e;for(let e=0;e<O;e++){const s=N[e];V(s[0]+t,s[1]+t,s[2]+t)}}else{for(let e=0;e<O;e++){const t=N[e];V(t[2],t[1],t[0])}for(let e=0;e<O;e++){const t=N[e];V(t[0]+R*o,t[1]+R*o,t[2]+R*o)}}s.addGroup(e,i.length/3-e,0)}(),function(){const e=i.length/3;let t=0;L(w,t),t+=w.length;for(let e=0,s=I.length;e<s;e++){const s=I[e];L(s,t),t+=s.length}s.addGroup(e,i.length/3-e,1)}()}this.setAttribute("position",new vn(i,3)),this.setAttribute("uv",new vn(r,2)),this.computeVertexNormals()}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}toJSON(){const e=super.toJSON();return function(e,t,s){if(s.shapes=[],Array.isArray(e))for(let t=0,i=e.length;t<i;t++){const i=e[t];s.shapes.push(i.uuid)}else s.shapes.push(e.uuid);return s.options=Object.assign({},t),void 0!==t.extrudePath&&(s.options.extrudePath=t.extrudePath.toJSON()),s}(this.parameters.shapes,this.parameters.options,e)}static fromJSON(t,s){const i=[];for(let e=0,r=t.shapes.length;e<r;e++){const r=s[t.shapes[e]];i.push(r)}const r=t.options.extrudePath;return void 0!==r&&(t.options.extrudePath=(new Vh[r.type]).fromJSON(r)),new e(i,t.options)}},xl={generateTopUV:function(e,t,s,i,r){const n=t[3*s],a=t[3*s+1],o=t[3*i],l=t[3*i+1],h=t[3*r],u=t[3*r+1];return[new Gi(n,a),new Gi(o,l),new Gi(h,u)]},generateSideWallUV:function(e,t,s,i,r,n){const a=t[3*s],o=t[3*s+1],l=t[3*s+2],h=t[3*i],u=t[3*i+1],c=t[3*i+2],d=t[3*r],p=t[3*r+1],_=t[3*r+2],m=t[3*n],f=t[3*n+1],g=t[3*n+2];return Math.abs(o-u)<Math.abs(a-h)?[new Gi(a,1-l),new Gi(h,1-c),new Gi(d,1-_),new Gi(m,1-g)]:[new Gi(o,1-l),new Gi(u,1-c),new Gi(p,1-_),new Gi(f,1-g)]}},bl=class e extends uh{constructor(e=1,t=0){const s=(1+Math.sqrt(5))/2;super([-1,s,0,1,s,0,-1,-s,0,1,-s,0,0,-1,s,0,1,s,0,-1,-s,0,1,-s,s,0,-1,s,0,1,-s,0,-1,-s,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],e,t),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(t){return new e(t.radius,t.detail)}},vl=class e extends Cn{constructor(e=[new Gi(0,-.5),new Gi(.5,0),new Gi(0,.5)],t=12,s=0,i=2*Math.PI){super(),this.type="LatheGeometry",this.parameters={points:e,segments:t,phiStart:s,phiLength:i},t=Math.floor(t),i=Hi(i,0,2*Math.PI);const r=[],n=[],a=[],o=[],l=[],h=1/t,u=new Qi,c=new Gi,d=new Qi,p=new Qi,_=new Qi;let m=0,f=0;for(let t=0;t<=e.length-1;t++)switch(t){case 0:m=e[t+1].x-e[t].x,f=e[t+1].y-e[t].y,d.x=1*f,d.y=-m,d.z=0*f,_.copy(d),d.normalize(),o.push(d.x,d.y,d.z);break;case e.length-1:o.push(_.x,_.y,_.z);break;default:m=e[t+1].x-e[t].x,f=e[t+1].y-e[t].y,d.x=1*f,d.y=-m,d.z=0*f,p.copy(d),d.x+=_.x,d.y+=_.y,d.z+=_.z,d.normalize(),o.push(d.x,d.y,d.z),_.copy(p)}for(let r=0;r<=t;r++){const d=s+r*h*i,p=Math.sin(d),_=Math.cos(d);for(let s=0;s<=e.length-1;s++){u.x=e[s].x*p,u.y=e[s].y,u.z=e[s].x*_,n.push(u.x,u.y,u.z),c.x=r/t,c.y=s/(e.length-1),a.push(c.x,c.y);const i=o[3*s+0]*p,h=o[3*s+1],d=o[3*s+0]*_;l.push(i,h,d)}}for(let s=0;s<t;s++)for(let t=0;t<e.length-1;t++){const i=t+s*e.length,n=i,a=i+e.length,o=i+e.length+1,l=i+1;r.push(n,a,l),r.push(o,l,a)}this.setIndex(r),this.setAttribute("position",new vn(n,3)),this.setAttribute("uv",new vn(a,2)),this.setAttribute("normal",new vn(l,3))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(t){return new e(t.points,t.segments,t.phiStart,t.phiLength)}},wl=class e extends uh{constructor(e=1,t=0){super([1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],e,t),this.type="OctahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(t){return new e(t.radius,t.detail)}},Ml=class e extends Cn{constructor(e=1,t=1,s=1,i=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:s,heightSegments:i};const r=e/2,n=t/2,a=Math.floor(s),o=Math.floor(i),l=a+1,h=o+1,u=e/a,c=t/o,d=[],p=[],_=[],m=[];for(let e=0;e<h;e++){const t=e*c-n;for(let s=0;s<l;s++){const i=s*u-r;p.push(i,-t,0),_.push(0,0,1),m.push(s/a),m.push(1-e/o)}}for(let e=0;e<o;e++)for(let t=0;t<a;t++){const s=t+l*e,i=t+l*(e+1),r=t+1+l*(e+1),n=t+1+l*e;d.push(s,i,n),d.push(i,r,n)}this.setIndex(d),this.setAttribute("position",new vn(p,3)),this.setAttribute("normal",new vn(_,3)),this.setAttribute("uv",new vn(m,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(t){return new e(t.width,t.height,t.widthSegments,t.heightSegments)}},Sl=class e extends Cn{constructor(e=.5,t=1,s=32,i=1,r=0,n=2*Math.PI){super(),this.type="RingGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:s,phiSegments:i,thetaStart:r,thetaLength:n},s=Math.max(3,s);const a=[],o=[],l=[],h=[];let u=e;const c=(t-e)/(i=Math.max(1,i)),d=new Qi,p=new Gi;for(let e=0;e<=i;e++){for(let e=0;e<=s;e++){const i=r+e/s*n;d.x=u*Math.cos(i),d.y=u*Math.sin(i),o.push(d.x,d.y,d.z),l.push(0,0,1),p.x=(d.x/t+1)/2,p.y=(d.y/t+1)/2,h.push(p.x,p.y)}u+=c}for(let e=0;e<i;e++){const t=e*(s+1);for(let e=0;e<s;e++){const i=e+t,r=i,n=i+s+1,o=i+s+2,l=i+1;a.push(r,n,l),a.push(n,o,l)}}this.setIndex(a),this.setAttribute("position",new vn(o,3)),this.setAttribute("normal",new vn(l,3)),this.setAttribute("uv",new vn(h,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(t){return new e(t.innerRadius,t.outerRadius,t.thetaSegments,t.phiSegments,t.thetaStart,t.thetaLength)}},_l=class e extends Cn{constructor(e=new jh([new Gi(0,.5),new Gi(-.5,-.5),new Gi(.5,-.5)]),t=12){super(),this.type="ShapeGeometry",this.parameters={shapes:e,curveSegments:t};const s=[],i=[],r=[],n=[];let a=0,o=0;if(!1===Array.isArray(e))l(e);else for(let t=0;t<e.length;t++)l(e[t]),this.addGroup(a,o,t),a+=o,o=0;function l(e){const a=i.length/3,l=e.extractPoints(t);let h=l.shape;const u=l.holes;!1===ml.isClockWise(h)&&(h=h.reverse());for(let e=0,t=u.length;e<t;e++){const t=u[e];!0===ml.isClockWise(t)&&(u[e]=t.reverse())}const c=ml.triangulateShape(h,u);for(let e=0,t=u.length;e<t;e++){const t=u[e];h=h.concat(t)}for(let e=0,t=h.length;e<t;e++){const t=h[e];i.push(t.x,t.y,0),r.push(0,0,1),n.push(t.x,t.y)}for(let e=0,t=c.length;e<t;e++){const t=c[e],i=t[0]+a,r=t[1]+a,n=t[2]+a;s.push(i,r,n),o+=3}}this.setIndex(s),this.setAttribute("position",new vn(i,3)),this.setAttribute("normal",new vn(r,3)),this.setAttribute("uv",new vn(n,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}toJSON(){const e=super.toJSON();return function(e,t){if(t.shapes=[],Array.isArray(e))for(let s=0,i=e.length;s<i;s++){const i=e[s];t.shapes.push(i.uuid)}else t.shapes.push(e.uuid);return t}(this.parameters.shapes,e)}static fromJSON(t,s){const i=[];for(let e=0,r=t.shapes.length;e<r;e++){const r=s[t.shapes[e]];i.push(r)}return new e(i,t.curveSegments)}},Al=class e extends Cn{constructor(e=1,t=32,s=16,i=0,r=2*Math.PI,n=0,a=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:s,phiStart:i,phiLength:r,thetaStart:n,thetaLength:a},t=Math.max(3,Math.floor(t)),s=Math.max(2,Math.floor(s));const o=Math.min(n+a,Math.PI);let l=0;const h=[],u=new Qi,c=new Qi,d=[],p=[],_=[],m=[];for(let d=0;d<=s;d++){const f=[],g=d/s;let y=0;0===d&&0===n?y=.5/t:d===s&&o===Math.PI&&(y=-.5/t);for(let s=0;s<=t;s++){const o=s/t;u.x=-e*Math.cos(i+o*r)*Math.sin(n+g*a),u.y=e*Math.cos(n+g*a),u.z=e*Math.sin(i+o*r)*Math.sin(n+g*a),p.push(u.x,u.y,u.z),c.copy(u).normalize(),_.push(c.x,c.y,c.z),m.push(o+y,1-g),f.push(l++)}h.push(f)}for(let e=0;e<s;e++)for(let i=0;i<t;i++){const t=h[e][i+1],r=h[e][i],a=h[e+1][i],l=h[e+1][i+1];(0!==e||n>0)&&d.push(t,r,l),(e!==s-1||o<Math.PI)&&d.push(r,a,l)}this.setIndex(d),this.setAttribute("position",new vn(p,3)),this.setAttribute("normal",new vn(_,3)),this.setAttribute("uv",new vn(m,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(t){return new e(t.radius,t.widthSegments,t.heightSegments,t.phiStart,t.phiLength,t.thetaStart,t.thetaLength)}},Tl=class e extends uh{constructor(e=1,t=0){super([1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],[2,1,0,0,3,2,1,3,0,2,3,1],e,t),this.type="TetrahedronGeometry",this.parameters={radius:e,detail:t}}static fromJSON(t){return new e(t.radius,t.detail)}},zl=class e extends Cn{constructor(e=1,t=.4,s=12,i=48,r=2*Math.PI){super(),this.type="TorusGeometry",this.parameters={radius:e,tube:t,radialSegments:s,tubularSegments:i,arc:r},s=Math.floor(s),i=Math.floor(i);const n=[],a=[],o=[],l=[],h=new Qi,u=new Qi,c=new Qi;for(let n=0;n<=s;n++)for(let d=0;d<=i;d++){const p=d/i*r,_=n/s*Math.PI*2;u.x=(e+t*Math.cos(_))*Math.cos(p),u.y=(e+t*Math.cos(_))*Math.sin(p),u.z=t*Math.sin(_),a.push(u.x,u.y,u.z),h.x=e*Math.cos(p),h.y=e*Math.sin(p),c.subVectors(u,h).normalize(),o.push(c.x,c.y,c.z),l.push(d/i),l.push(n/s)}for(let e=1;e<=s;e++)for(let t=1;t<=i;t++){const s=(i+1)*e+t-1,r=(i+1)*(e-1)+t-1,a=(i+1)*(e-1)+t,o=(i+1)*e+t;n.push(s,r,o),n.push(r,a,o)}this.setIndex(n),this.setAttribute("position",new vn(a,3)),this.setAttribute("normal",new vn(o,3)),this.setAttribute("uv",new vn(l,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(t){return new e(t.radius,t.tube,t.radialSegments,t.tubularSegments,t.arc)}},Cl=class e extends Cn{constructor(e=1,t=.4,s=64,i=8,r=2,n=3){super(),this.type="TorusKnotGeometry",this.parameters={radius:e,tube:t,tubularSegments:s,radialSegments:i,p:r,q:n},s=Math.floor(s),i=Math.floor(i);const a=[],o=[],l=[],h=[],u=new Qi,c=new Qi,d=new Qi,p=new Qi,_=new Qi,m=new Qi,f=new Qi;for(let a=0;a<=s;++a){const y=a/s*r*Math.PI*2;g(y,r,n,e,d),g(y+.01,r,n,e,p),m.subVectors(p,d),f.addVectors(p,d),_.crossVectors(m,f),f.crossVectors(_,m),_.normalize(),f.normalize();for(let e=0;e<=i;++e){const r=e/i*Math.PI*2,n=-t*Math.cos(r),p=t*Math.sin(r);u.x=d.x+(n*f.x+p*_.x),u.y=d.y+(n*f.y+p*_.y),u.z=d.z+(n*f.z+p*_.z),o.push(u.x,u.y,u.z),c.subVectors(u,d).normalize(),l.push(c.x,c.y,c.z),h.push(a/s),h.push(e/i)}}for(let e=1;e<=s;e++)for(let t=1;t<=i;t++){const s=(i+1)*(e-1)+(t-1),r=(i+1)*e+(t-1),n=(i+1)*e+t,o=(i+1)*(e-1)+t;a.push(s,r,o),a.push(r,n,o)}function g(e,t,s,i,r){const n=Math.cos(e),a=Math.sin(e),o=s/t*e,l=Math.cos(o);r.x=i*(2+l)*.5*n,r.y=i*(2+l)*a*.5,r.z=i*Math.sin(o)*.5}this.setIndex(a),this.setAttribute("position",new vn(o,3)),this.setAttribute("normal",new vn(l,3)),this.setAttribute("uv",new vn(h,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(t){return new e(t.radius,t.tube,t.tubularSegments,t.radialSegments,t.p,t.q)}},Il=class e extends Cn{constructor(e=new Oh(new Qi(-1,-1,0),new Qi(-1,1,0),new Qi(1,1,0)),t=64,s=1,i=8,r=!1){super(),this.type="TubeGeometry",this.parameters={path:e,tubularSegments:t,radius:s,radialSegments:i,closed:r};const n=e.computeFrenetFrames(t,r);this.tangents=n.tangents,this.normals=n.normals,this.binormals=n.binormals;const a=new Qi,o=new Qi,l=new Gi;let h=new Qi;const u=[],c=[],d=[],p=[];function _(r){h=e.getPointAt(r/t,h);const l=n.normals[r],d=n.binormals[r];for(let e=0;e<=i;e++){const t=e/i*Math.PI*2,r=Math.sin(t),n=-Math.cos(t);o.x=n*l.x+r*d.x,o.y=n*l.y+r*d.y,o.z=n*l.z+r*d.z,o.normalize(),c.push(o.x,o.y,o.z),a.x=h.x+s*o.x,a.y=h.y+s*o.y,a.z=h.z+s*o.z,u.push(a.x,a.y,a.z)}}!function(){for(let e=0;e<t;e++)_(e);_(!1===r?t:0),function(){for(let e=0;e<=t;e++)for(let s=0;s<=i;s++)l.x=e/t,l.y=s/i,d.push(l.x,l.y)}(),function(){for(let e=1;e<=t;e++)for(let t=1;t<=i;t++){const s=(i+1)*(e-1)+(t-1),r=(i+1)*e+(t-1),n=(i+1)*e+t,a=(i+1)*(e-1)+t;p.push(s,r,a),p.push(r,n,a)}}()}(),this.setIndex(p),this.setAttribute("position",new vn(u,3)),this.setAttribute("normal",new vn(c,3)),this.setAttribute("uv",new vn(d,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}toJSON(){const e=super.toJSON();return e.path=this.parameters.path.toJSON(),e}static fromJSON(t){return new e((new Vh[t.path.type]).fromJSON(t.path),t.tubularSegments,t.radius,t.radialSegments,t.closed)}},Bl=class extends Cn{constructor(e=null){if(super(),this.type="WireframeGeometry",this.parameters={geometry:e},null!==e){const t=[],s=new Set,i=new Qi,r=new Qi;if(null!==e.index){const n=e.attributes.position,a=e.index;let o=e.groups;0===o.length&&(o=[{start:0,count:a.count,materialIndex:0}]);for(let e=0,l=o.length;e<l;++e){const l=o[e],h=l.start;for(let e=h,o=h+l.count;e<o;e+=3)for(let o=0;o<3;o++){const l=a.getX(e+o),h=a.getX(e+(o+1)%3);i.fromBufferAttribute(n,l),r.fromBufferAttribute(n,h),!0===kl(i,r,s)&&(t.push(i.x,i.y,i.z),t.push(r.x,r.y,r.z))}}}else{const n=e.attributes.position;for(let e=0,a=n.count/3;e<a;e++)for(let a=0;a<3;a++){const o=3*e+a,l=3*e+(a+1)%3;i.fromBufferAttribute(n,o),r.fromBufferAttribute(n,l),!0===kl(i,r,s)&&(t.push(i.x,i.y,i.z),t.push(r.x,r.y,r.z))}}this.setAttribute("position",new vn(t,3))}}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}};function kl(e,t,s){const i=`${e.x},${e.y},${e.z}-${t.x},${t.y},${t.z}`,r=`${t.x},${t.y},${t.z}-${e.x},${e.y},${e.z}`;return!0!==s.has(i)&&!0!==s.has(r)&&(s.add(i),s.add(r),!0)}var El=Object.freeze({__proto__:null,BoxGeometry:Dn,CapsuleGeometry:oh,CircleGeometry:hh,ConeGeometry:ch,CylinderGeometry:lh,DodecahedronGeometry:dh,EdgesGeometry:fh,ExtrudeGeometry:fl,IcosahedronGeometry:bl,LatheGeometry:vl,OctahedronGeometry:wl,PlaneGeometry:Ml,PolyhedronGeometry:uh,RingGeometry:Sl,ShapeGeometry:_l,SphereGeometry:Al,TetrahedronGeometry:Tl,TorusGeometry:zl,TorusKnotGeometry:Cl,TubeGeometry:Il,WireframeGeometry:Bl}),Rl=class extends tn{constructor(e){super(),this.isShadowMaterial=!0,this.type="ShadowMaterial",this.color=new $r(0),this.transparent=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.fog=e.fog,this}},Ol=class extends tn{constructor(e){super(),this.isMeshStandardMaterial=!0,this.type="MeshStandardMaterial",this.defines={STANDARD:""},this.color=new $r(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new $r(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Gi(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new yr,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.envMapIntensity=e.envMapIntensity,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}},Nl=class extends Ol{constructor(e){super(),this.isMeshPhysicalMaterial=!0,this.defines={STANDARD:"",PHYSICAL:""},this.type="MeshPhysicalMaterial",this.anisotropyRotation=0,this.anisotropyMap=null,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new Gi(1,1),this.clearcoatNormalMap=null,this.ior=1.5,Object.defineProperty(this,"reflectivity",{get:function(){return Hi(2.5*(this.ior-1)/(this.ior+1),0,1)},set:function(e){this.ior=(1+.4*e)/(1-.4*e)}}),this.iridescenceMap=null,this.iridescenceIOR=1.3,this.iridescenceThicknessRange=[100,400],this.iridescenceThicknessMap=null,this.sheenColor=new $r(0),this.sheenColorMap=null,this.sheenRoughness=1,this.sheenRoughnessMap=null,this.transmissionMap=null,this.thickness=0,this.thicknessMap=null,this.attenuationDistance=1/0,this.attenuationColor=new $r(1,1,1),this.specularIntensity=1,this.specularIntensityMap=null,this.specularColor=new $r(1,1,1),this.specularColorMap=null,this._anisotropy=0,this._clearcoat=0,this._dispersion=0,this._iridescence=0,this._sheen=0,this._transmission=0,this.setValues(e)}get anisotropy(){return this._anisotropy}set anisotropy(e){this._anisotropy>0!=e>0&&this.version++,this._anisotropy=e}get clearcoat(){return this._clearcoat}set clearcoat(e){this._clearcoat>0!=e>0&&this.version++,this._clearcoat=e}get iridescence(){return this._iridescence}set iridescence(e){this._iridescence>0!=e>0&&this.version++,this._iridescence=e}get dispersion(){return this._dispersion}set dispersion(e){this._dispersion>0!=e>0&&this.version++,this._dispersion=e}get sheen(){return this._sheen}set sheen(e){this._sheen>0!=e>0&&this.version++,this._sheen=e}get transmission(){return this._transmission}set transmission(e){this._transmission>0!=e>0&&this.version++,this._transmission=e}copy(e){return super.copy(e),this.defines={STANDARD:"",PHYSICAL:""},this.anisotropy=e.anisotropy,this.anisotropyRotation=e.anisotropyRotation,this.anisotropyMap=e.anisotropyMap,this.clearcoat=e.clearcoat,this.clearcoatMap=e.clearcoatMap,this.clearcoatRoughness=e.clearcoatRoughness,this.clearcoatRoughnessMap=e.clearcoatRoughnessMap,this.clearcoatNormalMap=e.clearcoatNormalMap,this.clearcoatNormalScale.copy(e.clearcoatNormalScale),this.dispersion=e.dispersion,this.ior=e.ior,this.iridescence=e.iridescence,this.iridescenceMap=e.iridescenceMap,this.iridescenceIOR=e.iridescenceIOR,this.iridescenceThicknessRange=[...e.iridescenceThicknessRange],this.iridescenceThicknessMap=e.iridescenceThicknessMap,this.sheen=e.sheen,this.sheenColor.copy(e.sheenColor),this.sheenColorMap=e.sheenColorMap,this.sheenRoughness=e.sheenRoughness,this.sheenRoughnessMap=e.sheenRoughnessMap,this.transmission=e.transmission,this.transmissionMap=e.transmissionMap,this.thickness=e.thickness,this.thicknessMap=e.thicknessMap,this.attenuationDistance=e.attenuationDistance,this.attenuationColor.copy(e.attenuationColor),this.specularIntensity=e.specularIntensity,this.specularIntensityMap=e.specularIntensityMap,this.specularColor.copy(e.specularColor),this.specularColorMap=e.specularColorMap,this}},Vl=class extends tn{constructor(e){super(),this.isMeshPhongMaterial=!0,this.type="MeshPhongMaterial",this.color=new $r(16777215),this.specular=new $r(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new $r(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Gi(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new yr,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}},Fl=class extends tn{constructor(e){super(),this.isMeshToonMaterial=!0,this.defines={TOON:""},this.type="MeshToonMaterial",this.color=new $r(16777215),this.map=null,this.gradientMap=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new $r(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Gi(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.gradientMap=e.gradientMap,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}},Ll=class extends tn{constructor(e){super(),this.isMeshNormalMaterial=!0,this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Gi(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.flatShading=!1,this.setValues(e)}copy(e){return super.copy(e),this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.flatShading=e.flatShading,this}},jl=class extends tn{constructor(e){super(),this.isMeshLambertMaterial=!0,this.type="MeshLambertMaterial",this.color=new $r(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new $r(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Gi(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new yr,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}},Ul=class extends tn{constructor(e){super(),this.isMeshMatcapMaterial=!0,this.defines={MATCAP:""},this.type="MeshMatcapMaterial",this.color=new $r(16777215),this.matcap=null,this.map=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new Gi(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.alphaMap=null,this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={MATCAP:""},this.color.copy(e.color),this.matcap=e.matcap,this.map=e.map,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.alphaMap=e.alphaMap,this.flatShading=e.flatShading,this.fog=e.fog,this}},Hl=class extends Eo{constructor(e){super(),this.isLineDashedMaterial=!0,this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(e)}copy(e){return super.copy(e),this.scale=e.scale,this.dashSize=e.dashSize,this.gapSize=e.gapSize,this}};function ql(e,t){return e&&e.constructor!==t?"number"==typeof t.BYTES_PER_ELEMENT?new t(e):Array.prototype.slice.call(e):e}function Jl(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)}function Xl(e){const t=e.length,s=new Array(t);for(let e=0;e!==t;++e)s[e]=e;return s.sort(function(t,s){return e[t]-e[s]}),s}function Yl(e,t,s){const i=e.length,r=new e.constructor(i);for(let n=0,a=0;a!==i;++n){const i=s[n]*t;for(let s=0;s!==t;++s)r[a++]=e[i+s]}return r}function Zl(e,t,s,i){let r=1,n=e[0];for(;void 0!==n&&void 0===n[i];)n=e[r++];if(void 0===n)return;let a=n[i];if(void 0!==a)if(Array.isArray(a))do{a=n[i],void 0!==a&&(t.push(n.time),s.push(...a)),n=e[r++]}while(void 0!==n);else if(void 0!==a.toArray)do{a=n[i],void 0!==a&&(t.push(n.time),a.toArray(s,s.length)),n=e[r++]}while(void 0!==n);else do{a=n[i],void 0!==a&&(t.push(n.time),s.push(a)),n=e[r++]}while(void 0!==n)}var $l=class{constructor(e,t,s,i){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==i?i:new t.constructor(s),this.sampleValues=t,this.valueSize=s,this.settings=null,this.DefaultSettings_={}}evaluate(e){const t=this.parameterPositions;let s=this._cachedIndex,i=t[s],r=t[s-1];e:{t:{let n;s:{i:if(!(e<i)){for(let n=s+2;;){if(void 0===i){if(e<r)break i;return s=t.length,this._cachedIndex=s,this.copySampleValue_(s-1)}if(s===n)break;if(r=i,i=t[++s],e<i)break t}n=t.length;break s}if(!(e>=r)){const a=t[1];e<a&&(s=2,r=a);for(let n=s-2;;){if(void 0===r)return this._cachedIndex=0,this.copySampleValue_(0);if(s===n)break;if(i=r,r=t[--s-1],e>=r)break t}n=s,s=0;break s}break e}for(;s<n;){const i=s+n>>>1;e<t[i]?n=i:s=i+1}if(i=t[s],r=t[s-1],void 0===r)return this._cachedIndex=0,this.copySampleValue_(0);if(void 0===i)return s=t.length,this._cachedIndex=s,this.copySampleValue_(s-1)}this._cachedIndex=s,this.intervalChanged_(s,r,i)}return this.interpolate_(s,r,e,i)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,i=this.valueSize,r=e*i;for(let e=0;e!==i;++e)t[e]=s[r+e];return t}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}},Ql=class extends $l{constructor(e,t,s,i){super(e,t,s,i),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:Re,endingEnd:Re}}intervalChanged_(e,t,s){const i=this.parameterPositions;let r=e-2,n=e+1,a=i[r],o=i[n];if(void 0===a)switch(this.getSettings_().endingStart){case Pe:r=e,a=2*t-s;break;case Oe:r=i.length-2,a=t+i[r]-i[r+1];break;default:r=e,a=s}if(void 0===o)switch(this.getSettings_().endingEnd){case Pe:n=e,o=2*s-t;break;case Oe:n=1,o=s+i[1]-i[0];break;default:n=e-1,o=t}const l=.5*(s-t),h=this.valueSize;this._weightPrev=l/(t-a),this._weightNext=l/(o-s),this._offsetPrev=r*h,this._offsetNext=n*h}interpolate_(e,t,s,i){const r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=e*a,l=o-a,h=this._offsetPrev,u=this._offsetNext,c=this._weightPrev,d=this._weightNext,p=(s-t)/(i-t),_=p*p,m=_*p,f=-c*m+2*c*_-c*p,g=(1+c)*m+(-1.5-2*c)*_+(-.5+c)*p+1,y=(-1-d)*m+(1.5+d)*_+.5*p,S=d*m-d*_;for(let e=0;e!==a;++e)r[e]=f*n[h+e]+g*n[l+e]+y*n[o+e]+S*n[u+e];return r}},Kl=class extends $l{constructor(e,t,s,i){super(e,t,s,i)}interpolate_(e,t,s,i){const r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=e*a,l=o-a,h=(s-t)/(i-t),u=1-h;for(let e=0;e!==a;++e)r[e]=n[l+e]*u+n[o+e]*h;return r}},tc=class extends $l{constructor(e,t,s,i){super(e,t,s,i)}interpolate_(e){return this.copySampleValue_(e-1)}},ec=class{constructor(e,t,s,i){if(void 0===e)throw new Error("THREE.KeyframeTrack: track name is undefined");if(void 0===t||0===t.length)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+e);this.name=e,this.times=ql(t,this.TimeBufferType),this.values=ql(s,this.ValueBufferType),this.setInterpolation(i||this.DefaultInterpolation)}static toJSON(e){const t=e.constructor;let s;if(t.toJSON!==this.toJSON)s=t.toJSON(e);else{s={name:e.name,times:ql(e.times,Array),values:ql(e.values,Array)};const t=e.getInterpolation();t!==e.DefaultInterpolation&&(s.interpolation=t)}return s.type=e.ValueTypeName,s}InterpolantFactoryMethodDiscrete(e){return new tc(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodLinear(e){return new Kl(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodSmooth(e){return new Ql(this.times,this.values,this.getValueSize(),e)}setInterpolation(e){let t;switch(e){case Be:t=this.InterpolantFactoryMethodDiscrete;break;case ke:t=this.InterpolantFactoryMethodLinear;break;case Ee:t=this.InterpolantFactoryMethodSmooth}if(void 0===t){const t="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(e===this.DefaultInterpolation)throw new Error(t);this.setInterpolation(this.DefaultInterpolation)}return console.warn("THREE.KeyframeTrack:",t),this}return this.createInterpolant=t,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return Be;case this.InterpolantFactoryMethodLinear:return ke;case this.InterpolantFactoryMethodSmooth:return Ee}}getValueSize(){return this.values.length/this.times.length}shift(e){if(0!==e){const t=this.times;for(let s=0,i=t.length;s!==i;++s)t[s]+=e}return this}scale(e){if(1!==e){const t=this.times;for(let s=0,i=t.length;s!==i;++s)t[s]*=e}return this}trim(e,t){const s=this.times,i=s.length;let r=0,n=i-1;for(;r!==i&&s[r]<e;)++r;for(;-1!==n&&s[n]>t;)--n;if(++n,0!==r||n!==i){r>=n&&(n=Math.max(n,1),r=n-1);const e=this.getValueSize();this.times=s.slice(r,n),this.values=this.values.slice(r*e,n*e)}return this}validate(){let e=!0;const t=this.getValueSize();t-Math.floor(t)!==0&&(console.error("THREE.KeyframeTrack: Invalid value size in track.",this),e=!1);const s=this.times,i=this.values,r=s.length;0===r&&(console.error("THREE.KeyframeTrack: Track is empty.",this),e=!1);let n=null;for(let t=0;t!==r;t++){const i=s[t];if("number"==typeof i&&isNaN(i)){console.error("THREE.KeyframeTrack: Time is not a valid number.",this,t,i),e=!1;break}if(null!==n&&n>i){console.error("THREE.KeyframeTrack: Out of order keys.",this,t,i,n),e=!1;break}n=i}if(void 0!==i&&Jl(i))for(let t=0,s=i.length;t!==s;++t){const s=i[t];if(isNaN(s)){console.error("THREE.KeyframeTrack: Value is not a valid number.",this,t,s),e=!1;break}}return e}optimize(){const e=this.times.slice(),t=this.values.slice(),s=this.getValueSize(),i=this.getInterpolation()===Ee,r=e.length-1;let n=1;for(let a=1;a<r;++a){let r=!1;const o=e[a];if(o!==e[a+1]&&(1!==a||o!==e[0]))if(i)r=!0;else{const e=a*s,i=e-s,n=e+s;for(let a=0;a!==s;++a){const s=t[e+a];if(s!==t[i+a]||s!==t[n+a]){r=!0;break}}}if(r){if(a!==n){e[n]=e[a];const i=a*s,r=n*s;for(let e=0;e!==s;++e)t[r+e]=t[i+e]}++n}}if(r>0){e[n]=e[r];for(let e=r*s,i=n*s,a=0;a!==s;++a)t[i+a]=t[e+a];++n}return n!==e.length?(this.times=e.slice(0,n),this.values=t.slice(0,n*s)):(this.times=e,this.values=t),this}clone(){const e=this.times.slice(),t=this.values.slice(),s=new(0,this.constructor)(this.name,e,t);return s.createInterpolant=this.createInterpolant,s}};ec.prototype.ValueTypeName="",ec.prototype.TimeBufferType=Float32Array,ec.prototype.ValueBufferType=Float32Array,ec.prototype.DefaultInterpolation=ke;var ic=class extends ec{constructor(e,t,s){super(e,t,s)}};ic.prototype.ValueTypeName="bool",ic.prototype.ValueBufferType=Array,ic.prototype.DefaultInterpolation=Be,ic.prototype.InterpolantFactoryMethodLinear=void 0,ic.prototype.InterpolantFactoryMethodSmooth=void 0;var sc=class extends ec{constructor(e,t,s,i){super(e,t,s,i)}};sc.prototype.ValueTypeName="color";var rc=class extends ec{constructor(e,t,s,i){super(e,t,s,i)}};rc.prototype.ValueTypeName="number";var nc=class extends $l{constructor(e,t,s,i){super(e,t,s,i)}interpolate_(e,t,s,i){const r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=(s-t)/(i-t);let l=e*a;for(let e=l+a;l!==e;l+=4)$i.slerpFlat(r,0,n,l-a,n,l,o);return r}},ac=class extends ec{constructor(e,t,s,i){super(e,t,s,i)}InterpolantFactoryMethodLinear(e){return new nc(this.times,this.values,this.getValueSize(),e)}};ac.prototype.ValueTypeName="quaternion",ac.prototype.InterpolantFactoryMethodSmooth=void 0;var oc=class extends ec{constructor(e,t,s){super(e,t,s)}};oc.prototype.ValueTypeName="string",oc.prototype.ValueBufferType=Array,oc.prototype.DefaultInterpolation=Be,oc.prototype.InterpolantFactoryMethodLinear=void 0,oc.prototype.InterpolantFactoryMethodSmooth=void 0;var hc=class extends ec{constructor(e,t,s,i){super(e,t,s,i)}};hc.prototype.ValueTypeName="vector";var lc=class{constructor(e="",t=-1,s=[],i=2500){this.name=e,this.tracks=s,this.duration=t,this.blendMode=i,this.uuid=Ui(),this.duration<0&&this.resetDuration()}static parse(e){const t=[],s=e.tracks,i=1/(e.fps||1);for(let e=0,r=s.length;e!==r;++e)t.push(cc(s[e]).scale(i));const r=new this(e.name,e.duration,t,e.blendMode);return r.uuid=e.uuid,r}static toJSON(e){const t=[],s=e.tracks,i={name:e.name,duration:e.duration,tracks:t,uuid:e.uuid,blendMode:e.blendMode};for(let e=0,i=s.length;e!==i;++e)t.push(ec.toJSON(s[e]));return i}static CreateFromMorphTargetSequence(e,t,s,i){const r=t.length,n=[];for(let e=0;e<r;e++){let a=[],o=[];a.push((e+r-1)%r,e,(e+1)%r),o.push(0,1,0);const l=Xl(a);a=Yl(a,1,l),o=Yl(o,1,l),i||0!==a[0]||(a.push(r),o.push(o[0])),n.push(new rc(".morphTargetInfluences["+t[e].name+"]",a,o).scale(1/s))}return new this(e,-1,n)}static findByName(e,t){let s=e;if(!Array.isArray(e)){const t=e;s=t.geometry&&t.geometry.animations||t.animations}for(let e=0;e<s.length;e++)if(s[e].name===t)return s[e];return null}static CreateClipsFromMorphTargetSequences(e,t,s){const i={},r=/^([\w-]*?)([\d]+)$/;for(let t=0,s=e.length;t<s;t++){const s=e[t],n=s.name.match(r);if(n&&n.length>1){const e=n[1];let t=i[e];t||(i[e]=t=[]),t.push(s)}}const n=[];for(const e in i)n.push(this.CreateFromMorphTargetSequence(e,i[e],t,s));return n}static parseAnimation(e,t){if(console.warn("THREE.AnimationClip: parseAnimation() is deprecated and will be removed with r185"),!e)return console.error("THREE.AnimationClip: No animation in JSONLoader data."),null;const s=function(e,t,s,i,r){if(0!==s.length){const n=[],a=[];Zl(s,n,a,i),0!==n.length&&r.push(new e(t,n,a))}},i=[],r=e.name||"default",n=e.fps||30,a=e.blendMode;let o=e.length||-1;const l=e.hierarchy||[];for(let e=0;e<l.length;e++){const r=l[e].keys;if(r&&0!==r.length)if(r[0].morphTargets){const e={};let t;for(t=0;t<r.length;t++)if(r[t].morphTargets)for(let s=0;s<r[t].morphTargets.length;s++)e[r[t].morphTargets[s]]=-1;for(const s in e){const e=[],n=[];for(let i=0;i!==r[t].morphTargets.length;++i){const i=r[t];e.push(i.time),n.push(i.morphTarget===s?1:0)}i.push(new rc(".morphTargetInfluence["+s+"]",e,n))}o=e.length*n}else{const n=".bones["+t[e].name+"]";s(hc,n+".position",r,"pos",i),s(ac,n+".quaternion",r,"rot",i),s(hc,n+".scale",r,"scl",i)}}return 0===i.length?null:new this(r,o,i,a)}resetDuration(){let e=0;for(let t=0,s=this.tracks.length;t!==s;++t){const s=this.tracks[t];e=Math.max(e,s.times[s.times.length-1])}return this.duration=e,this}trim(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this}validate(){let e=!0;for(let t=0;t<this.tracks.length;t++)e=e&&this.tracks[t].validate();return e}optimize(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}clone(){const e=[];for(let t=0;t<this.tracks.length;t++)e.push(this.tracks[t].clone());return new this.constructor(this.name,this.duration,e,this.blendMode)}toJSON(){return this.constructor.toJSON(this)}};function cc(e){if(void 0===e.type)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");const t=function(e){switch(e.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return rc;case"vector":case"vector2":case"vector3":case"vector4":return hc;case"color":return sc;case"quaternion":return ac;case"bool":case"boolean":return ic;case"string":return oc}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+e)}(e.type);if(void 0===e.times){const t=[],s=[];Zl(e.keys,t,s,"value"),e.times=t,e.values=s}return void 0!==t.parse?t.parse(e):new t(e.name,e.times,e.values,e.interpolation)}var uc={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}},dc=class{constructor(e,t,s){const i=this;let r,n=!1,a=0,o=0;const l=[];this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=s,this.abortController=new AbortController,this.itemStart=function(e){o++,!1===n&&void 0!==i.onStart&&i.onStart(e,a,o),n=!0},this.itemEnd=function(e){a++,void 0!==i.onProgress&&i.onProgress(e,a,o),a===o&&(n=!1,void 0!==i.onLoad&&i.onLoad())},this.itemError=function(e){void 0!==i.onError&&i.onError(e)},this.resolveURL=function(e){return r?r(e):e},this.setURLModifier=function(e){return r=e,this},this.addHandler=function(e,t){return l.push(e,t),this},this.removeHandler=function(e){const t=l.indexOf(e);return-1!==t&&l.splice(t,2),this},this.getHandler=function(e){for(let t=0,s=l.length;t<s;t+=2){const s=l[t],i=l[t+1];if(s.global&&(s.lastIndex=0),s.test(e))return i}return null},this.abort=function(){return this.abortController.abort(),this.abortController=new AbortController,this}}},pc=new dc,mc=class{constructor(e){this.manager=void 0!==e?e:pc,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,t){const s=this;return new Promise(function(i,r){s.load(e,i,t,r)})}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}abort(){return this}};mc.DEFAULT_MATERIAL_NAME="__DEFAULT";var yc={},gc=class extends Error{constructor(e,t){super(e),this.response=t}},fc=class extends mc{constructor(e){super(e),this.mimeType="",this.responseType="",this._abortController=new AbortController}load(e,t,s,i){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const r=uc.get(`file:${e}`);if(void 0!==r)return this.manager.itemStart(e),setTimeout(()=>{t&&t(r),this.manager.itemEnd(e)},0),r;if(void 0!==yc[e])return void yc[e].push({onLoad:t,onProgress:s,onError:i});yc[e]=[],yc[e].push({onLoad:t,onProgress:s,onError:i});const n=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin",signal:"function"==typeof AbortSignal.any?AbortSignal.any([this._abortController.signal,this.manager.abortController.signal]):this._abortController.signal}),a=this.mimeType,o=this.responseType;fetch(n).then(t=>{if(200===t.status||0===t.status){if(0===t.status&&console.warn("THREE.FileLoader: HTTP Status 0 received."),"undefined"==typeof ReadableStream||void 0===t.body||void 0===t.body.getReader)return t;const s=yc[e],i=t.body.getReader(),r=t.headers.get("X-File-Size")||t.headers.get("Content-Length"),n=r?parseInt(r):0,a=0!==n;let o=0;const l=new ReadableStream({start(e){!function t(){i.read().then(({done:i,value:r})=>{if(i)e.close();else{o+=r.byteLength;const i=new ProgressEvent("progress",{lengthComputable:a,loaded:o,total:n});for(let e=0,t=s.length;e<t;e++){const t=s[e];t.onProgress&&t.onProgress(i)}e.enqueue(r),t()}},t=>{e.error(t)})}()}});return new Response(l)}throw new gc(`fetch for "${t.url}" responded with ${t.status}: ${t.statusText}`,t)}).then(e=>{switch(o){case"arraybuffer":return e.arrayBuffer();case"blob":return e.blob();case"document":return e.text().then(e=>(new DOMParser).parseFromString(e,a));case"json":return e.json();default:if(""===a)return e.text();{const t=/charset="?([^;"\s]*)"?/i.exec(a),s=t&&t[1]?t[1].toLowerCase():void 0,i=new TextDecoder(s);return e.arrayBuffer().then(e=>i.decode(e))}}}).then(t=>{uc.add(`file:${e}`,t);const s=yc[e];delete yc[e];for(let e=0,i=s.length;e<i;e++){const i=s[e];i.onLoad&&i.onLoad(t)}}).catch(t=>{const s=yc[e];if(void 0===s)throw this.manager.itemError(e),t;delete yc[e];for(let e=0,i=s.length;e<i;e++){const i=s[e];i.onError&&i.onError(t)}this.manager.itemError(e)}).finally(()=>{this.manager.itemEnd(e)}),this.manager.itemStart(e)}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}abort(){return this._abortController.abort(),this._abortController=new AbortController,this}},vc=new WeakMap,wc=class extends mc{constructor(e){super(e)}load(e,t,s,i){void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const r=this,n=uc.get(`image:${e}`);if(void 0!==n){if(!0===n.complete)r.manager.itemStart(e),setTimeout(function(){t&&t(n),r.manager.itemEnd(e)},0);else{let e=vc.get(n);void 0===e&&(e=[],vc.set(n,e)),e.push({onLoad:t,onError:i})}return n}const a=as("img");function o(){h(),t&&t(this);const s=vc.get(this)||[];for(let e=0;e<s.length;e++){const t=s[e];t.onLoad&&t.onLoad(this)}vc.delete(this),r.manager.itemEnd(e)}function l(t){h(),i&&i(t),uc.remove(`image:${e}`);const s=vc.get(this)||[];for(let e=0;e<s.length;e++){const i=s[e];i.onError&&i.onError(t)}vc.delete(this),r.manager.itemError(e),r.manager.itemEnd(e)}function h(){a.removeEventListener("load",o,!1),a.removeEventListener("error",l,!1)}return a.addEventListener("load",o,!1),a.addEventListener("error",l,!1),"data:"!==e.slice(0,5)&&void 0!==this.crossOrigin&&(a.crossOrigin=this.crossOrigin),uc.add(`image:${e}`,a),r.manager.itemStart(e),a.src=e,a}},_c=class extends mc{constructor(e){super(e)}load(e,t,s,i){const r=new _s,n=new wc(this.manager);return n.setCrossOrigin(this.crossOrigin),n.setPath(this.path),n.load(e,function(e){r.image=e,r.needsUpdate=!0,void 0!==t&&t(r)},s,i),r}},Ac=class extends Er{constructor(e,t=1){super(),this.isLight=!0,this.type="Light",this.color=new $r(e),this.intensity=t}dispose(){}copy(e,t){return super.copy(e,t),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){const t=super.toJSON(e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),void 0!==this.target&&(t.object.target=this.target.uuid),t}},Tc=class extends Ac{constructor(e,t,s){super(e,s),this.isHemisphereLight=!0,this.type="HemisphereLight",this.position.copy(Er.DEFAULT_UP),this.updateMatrix(),this.groundColor=new $r(t)}copy(e,t){return super.copy(e,t),this.groundColor.copy(e.groundColor),this}},zc=new nr,Cc=new Qi,Ic=new Qi,Bc=class{constructor(e){this.camera=e,this.intensity=1,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new Gi(512,512),this.mapType=Tt,this.map=null,this.mapPass=null,this.matrix=new nr,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new ho,this._frameExtents=new Gi(1,1),this._viewportCount=1,this._viewports=[new As(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){const t=this.camera,s=this.matrix;Cc.setFromMatrixPosition(e.matrixWorld),t.position.copy(Cc),Ic.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(Ic),t.updateMatrixWorld(),zc.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix(zc,t.coordinateSystem,t.reversedDepth),t.reversedDepth?s.set(.5,0,0,.5,0,.5,0,.5,0,0,1,0,0,0,0,1):s.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),s.multiply(zc)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(e){return this.camera=e.camera.clone(),this.intensity=e.intensity,this.bias=e.bias,this.radius=e.radius,this.autoUpdate=e.autoUpdate,this.needsUpdate=e.needsUpdate,this.normalBias=e.normalBias,this.blurSamples=e.blurSamples,this.mapSize.copy(e.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){const e={};return 1!==this.intensity&&(e.intensity=this.intensity),0!==this.bias&&(e.bias=this.bias),0!==this.normalBias&&(e.normalBias=this.normalBias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}},kc=class extends Bc{constructor(){super(new Qn(50,1,.5,500)),this.isSpotLightShadow=!0,this.focus=1,this.aspect=1}updateMatrices(e){const t=this.camera,s=2*Di*e.angle*this.focus,i=this.mapSize.width/this.mapSize.height*this.aspect,r=e.distance||t.far;s===t.fov&&i===t.aspect&&r===t.far||(t.fov=s,t.aspect=i,t.far=r,t.updateProjectionMatrix()),super.updateMatrices(e)}copy(e){return super.copy(e),this.focus=e.focus,this}},Ec=class extends Ac{constructor(e,t,s=0,i=Math.PI/3,r=0,n=2){super(e,t),this.isSpotLight=!0,this.type="SpotLight",this.position.copy(Er.DEFAULT_UP),this.updateMatrix(),this.target=new Er,this.distance=s,this.angle=i,this.penumbra=r,this.decay=n,this.map=null,this.shadow=new kc}get power(){return this.intensity*Math.PI}set power(e){this.intensity=e/Math.PI}dispose(){this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}},Rc=new nr,Pc=new Qi,Oc=new Qi,Nc=class extends Bc{constructor(){super(new Qn(90,1,.5,500)),this.isPointLightShadow=!0,this._frameExtents=new Gi(4,2),this._viewportCount=6,this._viewports=[new As(2,1,1,1),new As(0,1,1,1),new As(3,1,1,1),new As(1,1,1,1),new As(3,0,1,1),new As(1,0,1,1)],this._cubeDirections=[new Qi(1,0,0),new Qi(-1,0,0),new Qi(0,0,1),new Qi(0,0,-1),new Qi(0,1,0),new Qi(0,-1,0)],this._cubeUps=[new Qi(0,1,0),new Qi(0,1,0),new Qi(0,1,0),new Qi(0,1,0),new Qi(0,0,1),new Qi(0,0,-1)]}updateMatrices(e,t=0){const s=this.camera,i=this.matrix,r=e.distance||s.far;r!==s.far&&(s.far=r,s.updateProjectionMatrix()),Pc.setFromMatrixPosition(e.matrixWorld),s.position.copy(Pc),Oc.copy(s.position),Oc.add(this._cubeDirections[t]),s.up.copy(this._cubeUps[t]),s.lookAt(Oc),s.updateMatrixWorld(),i.makeTranslation(-Pc.x,-Pc.y,-Pc.z),Rc.multiplyMatrices(s.projectionMatrix,s.matrixWorldInverse),this._frustum.setFromProjectionMatrix(Rc,s.coordinateSystem,s.reversedDepth)}},Vc=class extends Ac{constructor(e,t,s=0,i=2){super(e,t),this.isPointLight=!0,this.type="PointLight",this.distance=s,this.decay=i,this.shadow=new Nc}get power(){return 4*this.intensity*Math.PI}set power(e){this.intensity=e/(4*Math.PI)}dispose(){this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}},Fc=class extends Yn{constructor(e=-1,t=1,s=1,i=-1,r=.1,n=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=s,this.bottom=i,this.near=r,this.far=n,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this}setViewOffset(e,t,s,i,r,n){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=s,this.view.offsetY=i,this.view.width=r,this.view.height=n,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),s=(this.right+this.left)/2,i=(this.top+this.bottom)/2;let r=s-e,n=s+e,a=i+t,o=i-t;if(null!==this.view&&this.view.enabled){const e=(this.right-this.left)/this.view.fullWidth/this.zoom,t=(this.top-this.bottom)/this.view.fullHeight/this.zoom;r+=e*this.view.offsetX,n=r+e*this.view.width,a-=t*this.view.offsetY,o=a-t*this.view.height}this.projectionMatrix.makeOrthographic(r,n,a,o,this.near,this.far,this.coordinateSystem,this.reversedDepth),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}},Lc=class extends Bc{constructor(){super(new Fc(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}},jc=class extends Ac{constructor(e,t){super(e,t),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(Er.DEFAULT_UP),this.updateMatrix(),this.target=new Er,this.shadow=new Lc}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}},Wc=class extends Ac{constructor(e,t){super(e,t),this.isAmbientLight=!0,this.type="AmbientLight"}},Dc=class extends Ac{constructor(e,t,s=10,i=10){super(e,t),this.isRectAreaLight=!0,this.type="RectAreaLight",this.width=s,this.height=i}get power(){return this.intensity*this.width*this.height*Math.PI}set power(e){this.intensity=e/(this.width*this.height*Math.PI)}copy(e){return super.copy(e),this.width=e.width,this.height=e.height,this}toJSON(e){const t=super.toJSON(e);return t.object.width=this.width,t.object.height=this.height,t}},Uc=class{constructor(){this.isSphericalHarmonics3=!0,this.coefficients=[];for(let e=0;e<9;e++)this.coefficients.push(new Qi)}set(e){for(let t=0;t<9;t++)this.coefficients[t].copy(e[t]);return this}zero(){for(let e=0;e<9;e++)this.coefficients[e].set(0,0,0);return this}getAt(e,t){const s=e.x,i=e.y,r=e.z,n=this.coefficients;return t.copy(n[0]).multiplyScalar(.282095),t.addScaledVector(n[1],.488603*i),t.addScaledVector(n[2],.488603*r),t.addScaledVector(n[3],.488603*s),t.addScaledVector(n[4],s*i*1.092548),t.addScaledVector(n[5],i*r*1.092548),t.addScaledVector(n[6],.315392*(3*r*r-1)),t.addScaledVector(n[7],s*r*1.092548),t.addScaledVector(n[8],.546274*(s*s-i*i)),t}getIrradianceAt(e,t){const s=e.x,i=e.y,r=e.z,n=this.coefficients;return t.copy(n[0]).multiplyScalar(.886227),t.addScaledVector(n[1],1.023328*i),t.addScaledVector(n[2],1.023328*r),t.addScaledVector(n[3],1.023328*s),t.addScaledVector(n[4],.858086*s*i),t.addScaledVector(n[5],.858086*i*r),t.addScaledVector(n[6],.743125*r*r-.247708),t.addScaledVector(n[7],.858086*s*r),t.addScaledVector(n[8],.429043*(s*s-i*i)),t}add(e){for(let t=0;t<9;t++)this.coefficients[t].add(e.coefficients[t]);return this}addScaledSH(e,t){for(let s=0;s<9;s++)this.coefficients[s].addScaledVector(e.coefficients[s],t);return this}scale(e){for(let t=0;t<9;t++)this.coefficients[t].multiplyScalar(e);return this}lerp(e,t){for(let s=0;s<9;s++)this.coefficients[s].lerp(e.coefficients[s],t);return this}equals(e){for(let t=0;t<9;t++)if(!this.coefficients[t].equals(e.coefficients[t]))return!1;return!0}copy(e){return this.set(e.coefficients)}clone(){return(new this.constructor).copy(this)}fromArray(e,t=0){const s=this.coefficients;for(let i=0;i<9;i++)s[i].fromArray(e,t+3*i);return this}toArray(e=[],t=0){const s=this.coefficients;for(let i=0;i<9;i++)s[i].toArray(e,t+3*i);return e}static getBasisAt(e,t){const s=e.x,i=e.y,r=e.z;t[0]=.282095,t[1]=.488603*i,t[2]=.488603*r,t[3]=.488603*s,t[4]=1.092548*s*i,t[5]=1.092548*i*r,t[6]=.315392*(3*r*r-1),t[7]=1.092548*s*r,t[8]=.546274*(s*s-i*i)}},Hc=class extends Ac{constructor(e=new Uc,t=1){super(void 0,t),this.isLightProbe=!0,this.sh=e}copy(e){return super.copy(e),this.sh.copy(e.sh),this}fromJSON(e){return this.intensity=e.intensity,this.sh.fromArray(e.sh),this}toJSON(e){const t=super.toJSON(e);return t.object.sh=this.sh.toArray(),t}},Jc=class{static extractUrlBase(e){const t=e.lastIndexOf("/");return-1===t?"./":e.slice(0,t+1)}static resolveURL(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}},Kc=new WeakMap,tu=class extends mc{constructor(e){super(e),this.isImageBitmapLoader=!0,"undefined"==typeof createImageBitmap&&console.warn("THREE.ImageBitmapLoader: createImageBitmap() not supported."),"undefined"==typeof fetch&&console.warn("THREE.ImageBitmapLoader: fetch() not supported."),this.options={premultiplyAlpha:"none"},this._abortController=new AbortController}setOptions(e){return this.options=e,this}load(e,t,s,i){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const r=this,n=uc.get(`image-bitmap:${e}`);if(void 0!==n)return r.manager.itemStart(e),n.then?void n.then(s=>{if(!0!==Kc.has(n))return t&&t(s),r.manager.itemEnd(e),s;i&&i(Kc.get(n)),r.manager.itemError(e),r.manager.itemEnd(e)}):(setTimeout(function(){t&&t(n),r.manager.itemEnd(e)},0),n);const a={};a.credentials="anonymous"===this.crossOrigin?"same-origin":"include",a.headers=this.requestHeader,a.signal="function"==typeof AbortSignal.any?AbortSignal.any([this._abortController.signal,this.manager.abortController.signal]):this._abortController.signal;const o=fetch(e,a).then(function(e){return e.blob()}).then(function(e){return createImageBitmap(e,Object.assign(r.options,{colorSpaceConversion:"none"}))}).then(function(s){return uc.add(`image-bitmap:${e}`,s),t&&t(s),r.manager.itemEnd(e),s}).catch(function(t){i&&i(t),Kc.set(o,t),uc.remove(`image-bitmap:${e}`),r.manager.itemError(e),r.manager.itemEnd(e)});uc.add(`image-bitmap:${e}`,o),r.manager.itemStart(e)}abort(){return this._abortController.abort(),this._abortController=new AbortController,this}},ru=new nr,nu=new nr,au=new nr,hu=class extends Qn{constructor(e=[]){super(),this.isArrayCamera=!0,this.isMultiViewCamera=!1,this.cameras=e}},lu=class{constructor(e=!0){this.autoStart=e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=performance.now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const t=performance.now();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return e}},cu=new Qi,uu=new $i,du=new Qi,pu=new Qi,mu=new Qi,fu=new Qi,xu=new $i,bu=new Qi,vu=new Qi,_u="\\[\\]\\.:\\/",Au=new RegExp("["+_u+"]","g"),Tu="[^"+_u+"]",zu="[^"+_u.replace("\\.","")+"]",Cu=new RegExp("^"+/((?:WC+[\/:])*)/.source.replace("WC",Tu)+/(WCOD+)?/.source.replace("WCOD",zu)+/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",Tu)+/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",Tu)+"$"),Iu=["material","materials","bones","map"],Bu=class e{constructor(t,s,i){this.path=s,this.parsedPath=i||e.parseTrackName(s),this.node=e.findNode(t,this.parsedPath.nodeName),this.rootNode=t,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}static create(t,s,i){return t&&t.isAnimationObjectGroup?new e.Composite(t,s,i):new e(t,s,i)}static sanitizeNodeName(e){return e.replace(/\s/g,"_").replace(Au,"")}static parseTrackName(e){const t=Cu.exec(e);if(null===t)throw new Error("PropertyBinding: Cannot parse trackName: "+e);const s={nodeName:t[2],objectName:t[3],objectIndex:t[4],propertyName:t[5],propertyIndex:t[6]},i=s.nodeName&&s.nodeName.lastIndexOf(".");if(void 0!==i&&-1!==i){const e=s.nodeName.substring(i+1);-1!==Iu.indexOf(e)&&(s.nodeName=s.nodeName.substring(0,i),s.objectName=e)}if(null===s.propertyName||0===s.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+e);return s}static findNode(e,t){if(void 0===t||""===t||"."===t||-1===t||t===e.name||t===e.uuid)return e;if(e.skeleton){const s=e.skeleton.getBoneByName(t);if(void 0!==s)return s}if(e.children){const s=function(e){for(let i=0;i<e.length;i++){const r=e[i];if(r.name===t||r.uuid===t)return r;const n=s(r.children);if(n)return n}return null},i=s(e.children);if(i)return i}return null}_getValue_unavailable(){}_setValue_unavailable(){}_getValue_direct(e,t){e[t]=this.targetObject[this.propertyName]}_getValue_array(e,t){const s=this.resolvedProperty;for(let i=0,r=s.length;i!==r;++i)e[t++]=s[i]}_getValue_arrayElement(e,t){e[t]=this.resolvedProperty[this.propertyIndex]}_getValue_toArray(e,t){this.resolvedProperty.toArray(e,t)}_setValue_direct(e,t){this.targetObject[this.propertyName]=e[t]}_setValue_direct_setNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.needsUpdate=!0}_setValue_direct_setMatrixWorldNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_array(e,t){const s=this.resolvedProperty;for(let i=0,r=s.length;i!==r;++i)s[i]=e[t++]}_setValue_array_setNeedsUpdate(e,t){const s=this.resolvedProperty;for(let i=0,r=s.length;i!==r;++i)s[i]=e[t++];this.targetObject.needsUpdate=!0}_setValue_array_setMatrixWorldNeedsUpdate(e,t){const s=this.resolvedProperty;for(let i=0,r=s.length;i!==r;++i)s[i]=e[t++];this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_arrayElement(e,t){this.resolvedProperty[this.propertyIndex]=e[t]}_setValue_arrayElement_setNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.needsUpdate=!0}_setValue_arrayElement_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_fromArray(e,t){this.resolvedProperty.fromArray(e,t)}_setValue_fromArray_setNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.needsUpdate=!0}_setValue_fromArray_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.matrixWorldNeedsUpdate=!0}_getValue_unbound(e,t){this.bind(),this.getValue(e,t)}_setValue_unbound(e,t){this.bind(),this.setValue(e,t)}bind(){let t=this.node;const s=this.parsedPath,i=s.objectName,r=s.propertyName;let n=s.propertyIndex;if(t||(t=e.findNode(this.rootNode,s.nodeName),this.node=t),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!t)return void console.warn("THREE.PropertyBinding: No target node found for track: "+this.path+".");if(i){let e=s.objectIndex;switch(i){case"materials":if(!t.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!t.material.materials)return void console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);t=t.material.materials;break;case"bones":if(!t.skeleton)return void console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);t=t.skeleton.bones;for(let s=0;s<t.length;s++)if(t[s].name===e){e=s;break}break;case"map":if("map"in t){t=t.map;break}if(!t.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!t.material.map)return void console.error("THREE.PropertyBinding: Can not bind to material.map as node.material does not have a map.",this);t=t.material.map;break;default:if(void 0===t[i])return void console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);t=t[i]}if(void 0!==e){if(void 0===t[e])return void console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,t);t=t[e]}}const a=t[r];if(void 0===a){const e=s.nodeName;return void console.error("THREE.PropertyBinding: Trying to update property for track: "+e+"."+r+" but it wasn't found.",t)}let o=this.Versioning.None;this.targetObject=t,!0===t.isMaterial?o=this.Versioning.NeedsUpdate:!0===t.isObject3D&&(o=this.Versioning.MatrixWorldNeedsUpdate);let l=this.BindingType.Direct;if(void 0!==n){if("morphTargetInfluences"===r){if(!t.geometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(!t.geometry.morphAttributes)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);void 0!==t.morphTargetDictionary[n]&&(n=t.morphTargetDictionary[n])}l=this.BindingType.ArrayElement,this.resolvedProperty=a,this.propertyIndex=n}else void 0!==a.fromArray&&void 0!==a.toArray?(l=this.BindingType.HasFromToArray,this.resolvedProperty=a):Array.isArray(a)?(l=this.BindingType.EntireArray,this.resolvedProperty=a):this.propertyName=r;this.getValue=this.GetterByBindingType[l],this.setValue=this.SetterByBindingTypeAndVersioning[l][o]}unbind(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}};Bu.Composite=class{constructor(e,t,s){const i=s||Bu.parseTrackName(t);this._targetGroup=e,this._bindings=e.subscribe_(t,i)}getValue(e,t){this.bind();const s=this._targetGroup.nCachedObjects_,i=this._bindings[s];void 0!==i&&i.getValue(e,t)}setValue(e,t){const s=this._bindings;for(let i=this._targetGroup.nCachedObjects_,r=s.length;i!==r;++i)s[i].setValue(e,t)}bind(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,s=e.length;t!==s;++t)e[t].bind()}unbind(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,s=e.length;t!==s;++t)e[t].unbind()}},Bu.prototype.BindingType={Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},Bu.prototype.Versioning={None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},Bu.prototype.GetterByBindingType=[Bu.prototype._getValue_direct,Bu.prototype._getValue_array,Bu.prototype._getValue_arrayElement,Bu.prototype._getValue_toArray],Bu.prototype.SetterByBindingTypeAndVersioning=[[Bu.prototype._setValue_direct,Bu.prototype._setValue_direct_setNeedsUpdate,Bu.prototype._setValue_direct_setMatrixWorldNeedsUpdate],[Bu.prototype._setValue_array,Bu.prototype._setValue_array_setNeedsUpdate,Bu.prototype._setValue_array_setMatrixWorldNeedsUpdate],[Bu.prototype._setValue_arrayElement,Bu.prototype._setValue_arrayElement_setNeedsUpdate,Bu.prototype._setValue_arrayElement_setMatrixWorldNeedsUpdate],[Bu.prototype._setValue_fromArray,Bu.prototype._setValue_fromArray_setNeedsUpdate,Bu.prototype._setValue_fromArray_setMatrixWorldNeedsUpdate]];var Ru=new Float32Array(1),Lu=class extends la{constructor(e,t,s=1){super(e,t),this.isInstancedInterleavedBuffer=!0,this.meshPerAttribute=s}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}clone(e){const t=super.clone(e);return t.meshPerAttribute=this.meshPerAttribute,t}toJSON(e){const t=super.toJSON(e);return t.isInstancedInterleavedBuffer=!0,t.meshPerAttribute=this.meshPerAttribute,t}},Wu=new nr,Du=class{constructor(e,t,s=0,i=1/0){this.ray=new rr(e,t),this.near=s,this.far=i,this.camera=null,this.layers=new gr,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(e,t){this.ray.set(e,t)}setFromCamera(e,t){t.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize(),this.camera=t):t.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld),this.camera=t):console.error("THREE.Raycaster: Unsupported camera type: "+t.type)}setFromXRController(e){return Wu.identity().extractRotation(e.matrixWorld),this.ray.origin.setFromMatrixPosition(e.matrixWorld),this.ray.direction.set(0,0,-1).applyMatrix4(Wu),this}intersectObject(e,t=!0,s=[]){return Hu(e,this,s,t),s.sort(Uu),s}intersectObjects(e,t=!0,s=[]){for(let i=0,r=e.length;i<r;i++)Hu(e[i],this,s,t);return s.sort(Uu),s}};function Uu(e,t){return e.distance-t.distance}function Hu(e,t,s,i){let r=!0;if(e.layers.test(t.layers)&&!1===e.raycast(t,s)&&(r=!1),!0===r&&!0===i){const i=e.children;for(let e=0,r=i.length;e<r;e++)Hu(i[e],t,s,!0)}}var Zu=class e{constructor(t,s,i,r){e.prototype.isMatrix2=!0,this.elements=[1,0,0,1],void 0!==t&&this.set(t,s,i,r)}identity(){return this.set(1,0,0,1),this}fromArray(e,t=0){for(let s=0;s<4;s++)this.elements[s]=e[s+t];return this}set(e,t,s,i){const r=this.elements;return r[0]=e,r[2]=t,r[1]=s,r[3]=i,this}},Gu=new Gi,Qu=new Qi,Ku=new Qi,td=new Qi,ed=new Qi,id=new Qi,sd=new Qi,rd=new Qi,ad=new Qi,hd=new Qi,ld=new nr,cd=new nr,md=new Qi,yd=new $r,gd=new $r,vd=new Qi,wd=new Qi,Md=new Qi,_d=new Qi,Ad=new Yn,Cd=new Es,Ed=new Qi,Fd=class extends Fi{constructor(e,t=null){super(),this.object=e,this.domElement=t,this.enabled=!0,this.state=-1,this.keys={},this.mouseButtons={LEFT:null,MIDDLE:null,RIGHT:null},this.touches={ONE:null,TWO:null}}connect(e){void 0!==e?(null!==this.domElement&&this.disconnect(),this.domElement=e):console.warn("THREE.Controls: connect() now requires an element.")}disconnect(){}dispose(){}update(){}};"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:t}})),"undefined"!=typeof window&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=t);var ms2=["alphaMap","alphaTest","anisotropy","anisotropyMap","anisotropyRotation","aoMap","aoMapIntensity","attenuationColor","attenuationDistance","bumpMap","clearcoat","clearcoatMap","clearcoatNormalMap","clearcoatNormalScale","clearcoatRoughness","color","dispersion","displacementMap","emissive","emissiveIntensity","emissiveMap","envMap","envMapIntensity","gradientMap","ior","iridescence","iridescenceIOR","iridescenceMap","iridescenceThicknessMap","lightMap","lightMapIntensity","map","matcap","metalness","metalnessMap","normalMap","normalScale","opacity","roughness","roughnessMap","sheen","sheenColor","sheenColorMap","sheenRoughnessMap","shininess","specular","specularColor","specularColorMap","specularIntensity","specularIntensityMap","specularMap","thickness","transmission","transmissionMap"],fs2=new WeakMap,ys2=class{constructor(e){this.renderObjects=new WeakMap,this.hasNode=this.containsNode(e),this.hasAnimation=!0===e.object.isSkinnedMesh,this.refreshUniforms=ms2,this.renderId=0}firstInitialization(e){return!1===this.renderObjects.has(e)&&(this.getRenderObjectData(e),!0)}needsVelocity(e){const t=e.getMRT();return null!==t&&t.has("velocity")}getRenderObjectData(e){let t=this.renderObjects.get(e);if(void 0===t){const{geometry:s,material:i,object:r}=e;if(t={material:this.getMaterialData(i),geometry:{id:s.id,attributes:this.getAttributesData(s.attributes),indexVersion:s.index?s.index.version:null,drawRange:{start:s.drawRange.start,count:s.drawRange.count}},worldMatrix:r.matrixWorld.clone()},r.center&&(t.center=r.center.clone()),r.morphTargetInfluences&&(t.morphTargetInfluences=r.morphTargetInfluences.slice()),null!==e.bundle&&(t.version=e.bundle.version),t.material.transmission>0){const{width:s,height:i}=e.context;t.bufferWidth=s,t.bufferHeight=i}t.lights=this.getLightsData(e.lightsNode.getLights()),this.renderObjects.set(e,t)}return t}getAttributesData(e){const t={};for(const s in e){const i=e[s];t[s]={version:i.version}}return t}containsNode(e){const t=e.material;for(const e in t)if(t[e]&&t[e].isNode)return!0;return null!==e.renderer.overrideNodes.modelViewMatrix||null!==e.renderer.overrideNodes.modelNormalViewMatrix}getMaterialData(e){const t={};for(const s of this.refreshUniforms){const i=e[s];null!=i&&("object"==typeof i&&void 0!==i.clone?!0===i.isTexture?t[s]={id:i.id,version:i.version}:t[s]=i.clone():t[s]=i)}return t}equals(e,t){const{object:s,material:i,geometry:r}=e,n=this.getRenderObjectData(e);if(!0!==n.worldMatrix.equals(s.matrixWorld))return n.worldMatrix.copy(s.matrixWorld),!1;const a=n.material;for(const e in a){const t=a[e],s=i[e];if(void 0!==t.equals){if(!1===t.equals(s))return t.copy(s),!1}else if(!0===s.isTexture){if(t.id!==s.id||t.version!==s.version)return t.id=s.id,t.version=s.version,!1}else if(t!==s)return a[e]=s,!1}if(a.transmission>0){const{width:t,height:s}=e.context;if(n.bufferWidth!==t||n.bufferHeight!==s)return n.bufferWidth=t,n.bufferHeight=s,!1}const o=n.geometry,l=r.attributes,h=o.attributes,u=Object.keys(h),c=Object.keys(l);if(o.id!==r.id)return o.id=r.id,!1;if(u.length!==c.length)return n.geometry.attributes=this.getAttributesData(l),!1;for(const e of u){const t=h[e],s=l[e];if(void 0===s)return delete h[e],!1;if(t.version!==s.version)return t.version=s.version,!1}const d=r.index,p=o.indexVersion,_=d?d.version:null;if(p!==_)return o.indexVersion=_,!1;if(o.drawRange.start!==r.drawRange.start||o.drawRange.count!==r.drawRange.count)return o.drawRange.start=r.drawRange.start,o.drawRange.count=r.drawRange.count,!1;if(n.morphTargetInfluences){let e=!1;for(let t=0;t<n.morphTargetInfluences.length;t++)n.morphTargetInfluences[t]!==s.morphTargetInfluences[t]&&(e=!0);if(e)return!0}if(n.lights)for(let e=0;e<t.length;e++)if(n.lights[e].map!==t[e].map)return!1;return n.center&&!1===n.center.equals(s.center)?(n.center.copy(s.center),!0):(null!==e.bundle&&(n.version=e.bundle.version),!0)}getLightsData(e){const t=[];for(const s of e)!0===s.isSpotLight&&null!==s.map&&t.push({map:s.map.version});return t}getLights(e,t){if(fs2.has(e)){const s=fs2.get(e);if(s.renderId===t)return s.lightsData}const s=this.getLightsData(e.getLights());return fs2.set(e,{renderId:t,lightsData:s}),s}needsRefresh(e,t){if(this.hasNode||this.hasAnimation||this.firstInitialization(e)||this.needsVelocity(t.renderer))return!0;const{renderId:s}=t;if(this.renderId!==s)return this.renderId=s,!0;const i=!0===e.object.static,r=null!==e.bundle&&!0===e.bundle.static&&this.getRenderObjectData(e).version===e.bundle.version;if(i||r)return!1;const n=this.getLights(e.lightsNode,s);return!0!==this.equals(e,n)}};function bs2(e,t=0){let s=3735928559^t,i=1103547991^t;if(e instanceof Array)for(let t,r=0;r<e.length;r++)t=e[r],s=Math.imul(s^t,2654435761),i=Math.imul(i^t,1597334677);else for(let t,r=0;r<e.length;r++)t=e.charCodeAt(r),s=Math.imul(s^t,2654435761),i=Math.imul(i^t,1597334677);return s=Math.imul(s^s>>>16,2246822507),s^=Math.imul(i^i>>>13,3266489909),i=Math.imul(i^i>>>16,2246822507),i^=Math.imul(s^s>>>13,3266489909),4294967296*(2097151&i)+(s>>>0)}var xs2=e=>bs2(e),Ts2=e=>bs2(e),_s2=(...e)=>bs2(e);function vs2(e,t=!1){const s=[];!0===e.isNode&&(s.push(e.id),e=e.getSelf());for(const{property:i,childNode:r}of Ns2(e))s.push(bs2(i.slice(0,-4)),r.getCacheKey(t));return bs2(s)}function*Ns2(e,t=!1){for(const s in e){if(!0===s.startsWith("_"))continue;const i=e[s];if(!0===Array.isArray(i))for(let e=0;e<i.length;e++){const r=i[e];r&&(!0===r.isNode||t&&"function"==typeof r.toJSON)&&(yield{property:s,index:e,childNode:r})}else if(i&&!0===i.isNode)yield{property:s,childNode:i};else if(i&&Object.getPrototypeOf(i)===Object.prototype)for(const e in i){if(!0===e.startsWith("_"))continue;const r=i[e];r&&(!0===r.isNode||t&&"function"==typeof r.toJSON)&&(yield{property:s,index:e,childNode:r})}}}var Ss2=new Map([[1,"float"],[2,"vec2"],[3,"vec3"],[4,"vec4"],[9,"mat3"],[16,"mat4"]]),Es2=new WeakMap;function ws2(e){return Ss2.get(e)}function As2(e){if(/[iu]?vec\d/.test(e))return e.startsWith("ivec")?Int32Array:e.startsWith("uvec")?Uint32Array:Float32Array;if(/mat\d/.test(e))return Float32Array;if(/float/.test(e))return Float32Array;if(/uint/.test(e))return Uint32Array;if(/int/.test(e))return Int32Array;throw new Error(`THREE.NodeUtils: Unsupported type: ${e}`)}function Rs2(e){return/float|int|uint/.test(e)?1:/vec2/.test(e)?2:/vec3/.test(e)?3:/vec4/.test(e)||/mat2/.test(e)?4:/mat3/.test(e)?9:/mat4/.test(e)?16:void console.error("THREE.TSL: Unsupported type:",e)}function Cs2(e){return/float|int|uint/.test(e)?1:/vec2/.test(e)?2:/vec3/.test(e)?3:/vec4/.test(e)||/mat2/.test(e)?4:/mat3/.test(e)?12:/mat4/.test(e)?16:void console.error("THREE.TSL: Unsupported type:",e)}function Ms2(e){return/float|int|uint/.test(e)?4:/vec2/.test(e)?8:/vec3/.test(e)||/vec4/.test(e)?16:/mat2/.test(e)?8:/mat3/.test(e)?48:/mat4/.test(e)?64:void console.error("THREE.TSL: Unsupported type:",e)}function Ps2(e){if(null==e)return null;const t=typeof e;return!0===e.isNode?"node":"number"===t?"float":"boolean"===t?"bool":"string"===t?"string":"function"===t?"shader":!0===e.isVector2?"vec2":!0===e.isVector3?"vec3":!0===e.isVector4?"vec4":!0===e.isMatrix2?"mat2":!0===e.isMatrix3?"mat3":!0===e.isMatrix4?"mat4":!0===e.isColor?"color":e instanceof ArrayBuffer?"ArrayBuffer":null}function Bs2(e,...t){const s=e?e.slice(-4):void 0;return 1===t.length&&("vec2"===s?t=[t[0],t[0]]:"vec3"===s?t=[t[0],t[0],t[0]]:"vec4"===s&&(t=[t[0],t[0],t[0],t[0]])),"color"===e?new $r(...t):"vec2"===s?new Gi(...t):"vec3"===s?new Qi(...t):"vec4"===s?new As(...t):"mat2"===s?new Zu(...t):"mat3"===s?new es(...t):"mat4"===s?new nr(...t):"bool"===e?t[0]||!1:"float"===e||"int"===e||"uint"===e?t[0]||0:"string"===e?t[0]||"":"ArrayBuffer"===e?Is2(t[0]):null}function Ls2(e){let t=Es2.get(e);return void 0===t&&(t={},Es2.set(e,t)),t}function Fs2(e){let t="";const s=new Uint8Array(e);for(let e=0;e<s.length;e++)t+=String.fromCharCode(s[e]);return btoa(t)}function Is2(e){return Uint8Array.from(atob(e),e=>e.charCodeAt(0)).buffer}var Ds2=Object.freeze({__proto__:null,arrayBufferToBase64:Fs2,base64ToArrayBuffer:Is2,getByteBoundaryFromType:Ms2,getCacheKey:vs2,getDataFromObject:Ls2,getLengthFromType:Rs2,getMemoryLengthFromType:Cs2,getNodeChildren:Ns2,getTypeFromLength:ws2,getTypedArrayFromType:As2,getValueFromType:Bs2,getValueType:Ps2,hash:_s2,hashArray:Ts2,hashString:xs2}),Vs2={VERTEX:"vertex",FRAGMENT:"fragment"},Us2={NONE:"none",FRAME:"frame",RENDER:"render",OBJECT:"object"},Os2={BOOLEAN:"bool",INTEGER:"int",FLOAT:"float",VECTOR2:"vec2",VECTOR3:"vec3",VECTOR4:"vec4",MATRIX2:"mat2",MATRIX3:"mat3",MATRIX4:"mat4"},ks2={READ_ONLY:"readOnly",WRITE_ONLY:"writeOnly",READ_WRITE:"readWrite"},Gs2=["fragment","vertex"],zs2=["setup","analyze","generate"],Hs2=[...Gs2,"compute"],$s2=["x","y","z","w"],Ws2={analyze:"setup",generate:"analyze"},qs2=0,js2=class extends Fi{static get type(){return"Node"}constructor(e=null){super(),this.nodeType=e,this.updateType=Us2.NONE,this.updateBeforeType=Us2.NONE,this.updateAfterType=Us2.NONE,this.uuid=Zi.generateUUID(),this.version=0,this.global=!1,this.parents=!1,this.isNode=!0,this._cacheKey=null,this._cacheKeyVersion=0,Object.defineProperty(this,"id",{value:qs2++})}set needsUpdate(e){!0===e&&this.version++}get type(){return this.constructor.type}onUpdate(e,t){return this.updateType=t,this.update=e.bind(this.getSelf()),this}onFrameUpdate(e){return this.onUpdate(e,Us2.FRAME)}onRenderUpdate(e){return this.onUpdate(e,Us2.RENDER)}onObjectUpdate(e){return this.onUpdate(e,Us2.OBJECT)}onReference(e){return this.updateReference=e.bind(this.getSelf()),this}getSelf(){return this.self||this}updateReference(){return this}isGlobal(){return this.global}*getChildren(){for(const{childNode:e}of Ns2(this))yield e}dispose(){this.dispatchEvent({type:"dispose"})}traverse(e){e(this);for(const t of this.getChildren())t.traverse(e)}getCacheKey(e=!1){return!0!==(e=e||this.version!==this._cacheKeyVersion)&&null!==this._cacheKey||(this._cacheKey=_s2(vs2(this,e),this.customCacheKey()),this._cacheKeyVersion=this.version),this._cacheKey}customCacheKey(){return 0}getScope(){return this}getHash(){return this.uuid}getUpdateType(){return this.updateType}getUpdateBeforeType(){return this.updateBeforeType}getUpdateAfterType(){return this.updateAfterType}getElementType(e){const t=this.getNodeType(e);return e.getElementType(t)}getMemberType(){return"void"}getNodeType(e){const t=e.getNodeProperties(this);return t.outputNode?t.outputNode.getNodeType(e):this.nodeType}getShared(e){const t=this.getHash(e);return e.getNodeFromHash(t)||this}getArrayCount(){return null}setup(e){const t=e.getNodeProperties(this);let s=0;for(const e of this.getChildren())t["node"+s++]=e;return t.outputNode||null}analyze(e,t=null){const s=e.increaseUsage(this);if(!0===this.parents){const s=e.getDataFromNode(this,"any");s.stages=s.stages||{},s.stages[e.shaderStage]=s.stages[e.shaderStage]||[],s.stages[e.shaderStage].push(t)}if(1===s){const t=e.getNodeProperties(this);for(const s of Object.values(t))s&&!0===s.isNode&&s.build(e,this)}}generate(e,t){const{outputNode:s}=e.getNodeProperties(this);if(s&&!0===s.isNode)return s.build(e,t)}updateBefore(){console.warn("Abstract function.")}updateAfter(){console.warn("Abstract function.")}update(){console.warn("Abstract function.")}build(e,t=null){const s=this.getShared(e);if(this!==s)return s.build(e,t);const i=e.getDataFromNode(this);i.buildStages=i.buildStages||{},i.buildStages[e.buildStage]=!0;const r=Ws2[e.buildStage];if(r&&!0!==i.buildStages[r]){const t=e.getBuildStage();e.setBuildStage(r),this.build(e),e.setBuildStage(t)}e.addNode(this),e.addChain(this);let n=null;const a=e.getBuildStage();if("setup"===a){this.updateReference(e);const t=e.getNodeProperties(this);if(!0!==t.initialized){t.initialized=!0,t.outputNode=this.setup(e)||t.outputNode||null;for(const s of Object.values(t))if(s&&!0===s.isNode){if(!0===s.parents){const t=e.getNodeProperties(s);t.parents=t.parents||[],t.parents.push(this)}s.build(e)}}n=t.outputNode}else if("analyze"===a)this.analyze(e,t);else if("generate"===a)if(1===this.generate.length){const s=this.getNodeType(e),i=e.getDataFromNode(this);n=i.snippet,void 0===n?void 0===i.generated?(i.generated=!0,n=this.generate(e)||"",i.snippet=n):(console.warn("THREE.Node: Recursion detected.",this),n="/* Recursion detected. */"):void 0!==i.flowCodes&&void 0!==e.context.nodeBlock&&e.addFlowCodeHierarchy(this,e.context.nodeBlock),n=e.format(n,s,t)}else n=this.generate(e,t)||"";return e.removeChain(this),e.addSequentialNode(this),n}getSerializeChildren(){return Ns2(this)}serialize(e){const t=this.getSerializeChildren(),s={};for(const{property:i,index:r,childNode:n}of t)void 0!==r?(void 0===s[i]&&(s[i]=Number.isInteger(r)?[]:{}),s[i][r]=n.toJSON(e.meta).uuid):s[i]=n.toJSON(e.meta).uuid;Object.keys(s).length>0&&(e.inputNodes=s)}deserialize(e){if(void 0!==e.inputNodes){const t=e.meta.nodes;for(const s in e.inputNodes)if(Array.isArray(e.inputNodes[s])){const i=[];for(const r of e.inputNodes[s])i.push(t[r]);this[s]=i}else if("object"==typeof e.inputNodes[s]){const i={};for(const r in e.inputNodes[s]){const n=e.inputNodes[s][r];i[r]=t[n]}this[s]=i}else{const i=e.inputNodes[s];this[s]=t[i]}}}toJSON(e){const{uuid:t,type:s}=this,i=void 0===e||"string"==typeof e;i&&(e={textures:{},images:{},nodes:{}});let r=e.nodes[t];function n(e){const t=[];for(const s in e){const i=e[s];delete i.metadata,t.push(i)}return t}if(void 0===r&&(r={uuid:t,type:s,meta:e,metadata:{version:4.7,type:"Node",generator:"Node.toJSON"}},!0!==i&&(e.nodes[r.uuid]=r),this.serialize(r),delete r.meta),i){const t=n(e.textures),s=n(e.images),i=n(e.nodes);t.length>0&&(r.textures=t),s.length>0&&(r.images=s),i.length>0&&(r.nodes=i)}return r}},Xs2=class extends js2{static get type(){return"ArrayElementNode"}constructor(e,t){super(),this.node=e,this.indexNode=t,this.isArrayElementNode=!0}getNodeType(e){return this.node.getElementType(e)}generate(e){const t=this.indexNode.getNodeType(e);return`${this.node.build(e)}[ ${this.indexNode.build(e,!e.isVector(t)&&e.isInteger(t)?t:"uint")} ]`}},Ks2=class extends js2{static get type(){return"ConvertNode"}constructor(e,t){super(),this.node=e,this.convertTo=t}getNodeType(e){const t=this.node.getNodeType(e);let s=null;for(const i of this.convertTo.split("|"))null!==s&&e.getTypeLength(t)!==e.getTypeLength(i)||(s=i);return s}serialize(e){super.serialize(e),e.convertTo=this.convertTo}deserialize(e){super.deserialize(e),this.convertTo=e.convertTo}generate(e,t){const s=this.node,i=this.getNodeType(e),r=s.build(e,i);return e.format(r,i,t)}},Ys2=class extends js2{static get type(){return"TempNode"}constructor(e=null){super(e),this.isTempNode=!0}hasDependencies(e){return e.getDataFromNode(this).usageCount>1}build(e,t){if("generate"===e.getBuildStage()){const s=e.getVectorType(this.getNodeType(e,t)),i=e.getDataFromNode(this);if(void 0!==i.propertyName)return e.format(i.propertyName,s,t);if("void"!==s&&"void"!==t&&this.hasDependencies(e)){const r=super.build(e,s),n=e.getVarFromNode(this,null,s),a=e.getPropertyName(n);return e.addLineFlowCode(`${a} = ${r}`,this),i.snippet=r,i.propertyName=a,e.format(i.propertyName,s,t)}}return super.build(e,t)}},Qs2=class extends Ys2{static get type(){return"JoinNode"}constructor(e=[],t=null){super(t),this.nodes=e}getNodeType(e){return null!==this.nodeType?e.getVectorType(this.nodeType):e.getTypeFromLength(this.nodes.reduce((t,s)=>t+e.getTypeLength(s.getNodeType(e)),0))}generate(e,t){const s=this.getNodeType(e),i=e.getTypeLength(s),r=this.nodes,n=e.getComponentType(s),a=[];let o=0;for(const t of r){if(o>=i){console.error(`THREE.TSL: Length of parameters exceeds maximum length of function '${s}()' type.`);break}let r,l=t.getNodeType(e),h=e.getTypeLength(l);o+h>i&&(console.error(`THREE.TSL: Length of '${s}()' data exceeds maximum length of output type.`),h=i-o,l=e.getTypeFromLength(h)),o+=h,r=t.build(e,l);const u=e.getComponentType(l);u!==n&&(r=e.format(r,u,n)),a.push(r)}const l=`${e.getType(s)}( ${a.join(", ")} )`;return e.format(l,s,t)}},Zs2=$s2.join(""),Js2=class extends js2{static get type(){return"SplitNode"}constructor(e,t="x"){super(),this.node=e,this.components=t,this.isSplitNode=!0}getVectorLength(){let e=this.components.length;for(const t of this.components)e=Math.max($s2.indexOf(t)+1,e);return e}getComponentType(e){return e.getComponentType(this.node.getNodeType(e))}getNodeType(e){return e.getTypeFromLength(this.components.length,this.getComponentType(e))}generate(e,t){const s=this.node,i=e.getTypeLength(s.getNodeType(e));let r=null;if(i>1){let n=null;this.getVectorLength()>=i&&(n=e.getTypeFromLength(this.getVectorLength(),this.getComponentType(e)));const a=s.build(e,n);r=this.components.length===i&&this.components===Zs2.slice(0,this.components.length)?e.format(a,n,t):e.format(`${a}.${this.components}`,this.getNodeType(e),t)}else r=s.build(e,t);return r}serialize(e){super.serialize(e),e.components=this.components}deserialize(e){super.deserialize(e),this.components=e.components}},ei2=class extends Ys2{static get type(){return"SetNode"}constructor(e,t,s){super(),this.sourceNode=e,this.components=t,this.targetNode=s}getNodeType(e){return this.sourceNode.getNodeType(e)}generate(e){const{sourceNode:t,components:s,targetNode:i}=this,r=this.getNodeType(e),n=e.getComponentType(i.getNodeType(e)),a=e.getTypeFromLength(s.length,n),o=i.build(e,a),l=t.build(e,r),h=e.getTypeLength(r),u=[];for(let e=0;e<h;e++){const t=$s2[e];t===s[0]?(u.push(o),e+=s.length-1):u.push(l+"."+t)}return`${e.getType(r)}( ${u.join(", ")} )`}},ti2=class extends Ys2{static get type(){return"FlipNode"}constructor(e,t){super(),this.sourceNode=e,this.components=t}getNodeType(e){return this.sourceNode.getNodeType(e)}generate(e){const{components:t,sourceNode:s}=this,i=this.getNodeType(e),r=s.build(e),n=e.getVarFromNode(this),a=e.getPropertyName(n);e.addLineFlowCode(a+" = "+r,this);const o=e.getTypeLength(i),l=[];let h=0;for(let e=0;e<o;e++){const s=$s2[e];s===t[h]?(l.push("1.0 - "+a+"."+s),h++):l.push(a+"."+s)}return`${e.getType(i)}( ${l.join(", ")} )`}},ri2=class extends js2{static get type(){return"InputNode"}constructor(e,t=null){super(t),this.isInputNode=!0,this.value=e,this.precision=null}getNodeType(){return null===this.nodeType?Ps2(this.value):this.nodeType}getInputType(e){return this.getNodeType(e)}setPrecision(e){return this.precision=e,this}serialize(e){super.serialize(e),e.value=this.value,this.value&&this.value.toArray&&(e.value=this.value.toArray()),e.valueType=Ps2(this.value),e.nodeType=this.nodeType,"ArrayBuffer"===e.valueType&&(e.value=Fs2(e.value)),e.precision=this.precision}deserialize(e){super.deserialize(e),this.nodeType=e.nodeType,this.value=Array.isArray(e.value)?Bs2(e.valueType,...e.value):e.value,this.precision=e.precision||null,this.value&&this.value.fromArray&&(this.value=this.value.fromArray(e.value))}generate(){console.warn("Abstract function.")}},si2=/float|u?int/,ii2=class extends ri2{static get type(){return"ConstNode"}constructor(e,t=null){super(e,t),this.isConstNode=!0}generateConst(e){return e.generateConst(this.getNodeType(e),this.value)}generate(e,t){const s=this.getNodeType(e);return si2.test(s)&&si2.test(t)?e.generateConst(t,this.value):e.format(this.generateConst(e),s,t)}},ni2=class extends js2{static get type(){return"MemberNode"}constructor(e,t){super(),this.node=e,this.property=t,this.isMemberNode=!0}getNodeType(e){return this.node.getMemberType(e,this.property)}generate(e){return this.node.build(e)+"."+this.property}},ai2=null,oi2=new Map;function ui2(e,t){if(oi2.has(e))console.warn(`THREE.TSL: Redefinition of method chaining '${e}'.`);else{if("function"!=typeof t)throw new Error(`THREE.TSL: Node element ${e} is not a function`);oi2.set(e,t)}}var li2=e=>e.replace(/r|s/g,"x").replace(/g|t/g,"y").replace(/b|p/g,"z").replace(/a|q/g,"w"),di2=e=>li2(e).split("").sort().join(""),ci2={setup(e,t){const s=t.shift();return e(Vi2(s),...t)},get(e,t,s){if("string"==typeof t&&void 0===e[t]){if(!0!==e.isStackNode&&"assign"===t)return(...e)=>(ai2.assign(s,...e),s);if(oi2.has(t)){const i=oi2.get(t);return e.isStackNode?(...e)=>s.add(i(...e)):(...e)=>i(s,...e)}if("toVarIntent"===t)return()=>s;if("self"===t)return e;if(t.endsWith("Assign")&&oi2.has(t.slice(0,t.length-6))){const i=oi2.get(t.slice(0,t.length-6));return e.isStackNode?(...e)=>s.assign(e[0],i(...e)):(...e)=>s.assign(i(s,...e))}if(!0===/^[xyzwrgbastpq]{1,4}$/.test(t))return t=li2(t),Ii2(new Js2(s,t));if(!0===/^set[XYZWRGBASTPQ]{1,4}$/.test(t))return t=di2(t.slice(3).toLowerCase()),s=>Ii2(new ei2(e,t,Ii2(s)));if(!0===/^flip[XYZWRGBASTPQ]{1,4}$/.test(t))return t=di2(t.slice(4).toLowerCase()),()=>Ii2(new ti2(Ii2(e),t));if("width"===t||"height"===t||"depth"===t)return"width"===t?t="x":"height"===t?t="y":"depth"===t&&(t="z"),Ii2(new Js2(e,t));if(!0===/^\d+$/.test(t))return Ii2(new Xs2(s,new ii2(Number(t),"uint")));if(!0===/^get$/.test(t))return e=>Ii2(new ni2(s,e))}return Reflect.get(e,t,s)},set:(e,t,s,i)=>"string"!=typeof t||void 0!==e[t]||!0!==/^[xyzwrgbastpq]{1,4}$/.test(t)&&"width"!==t&&"height"!==t&&"depth"!==t&&!0!==/^\d+$/.test(t)?Reflect.set(e,t,s,i):(i[t].assign(s),!0)},hi2=new WeakMap,pi2=new WeakMap,gi2=function(e,t=null){for(const s in e)e[s]=Ii2(e[s],t);return e},mi2=function(e,t=null){const s=e.length;for(let i=0;i<s;i++)e[i]=Ii2(e[i],t);return e},fi2=function(e,t=null,s=null,i=null){function r(e){return null!==i?(e=Ii2(Object.assign(e,i)),!0===i.intent&&(e=e.toVarIntent())):e=Ii2(e),e}let n,a,o,l=t;function h(t){let s;return s=l?/[a-z]/i.test(l)?l+"()":l:e.type,void 0!==a&&t.length<a?(console.error(`THREE.TSL: "${s}" parameter length is less than minimum required.`),t.concat(new Array(a-t.length).fill(0))):void 0!==o&&t.length>o?(console.error(`THREE.TSL: "${s}" parameter length exceeds limit.`),t.slice(0,o)):t}return null===t?n=(...t)=>r(new e(...Ui2(h(t)))):null!==s?(s=Ii2(s),n=(...i)=>r(new e(t,...Ui2(h(i)),s))):n=(...s)=>r(new e(t,...Ui2(h(s)))),n.setParameterLength=(...e)=>(1===e.length?a=o=e[0]:2===e.length&&([a,o]=e),n),n.setName=e=>(l=e,n),n},yi2=function(e,...t){return Ii2(new e(...Ui2(t)))},bi2=class extends js2{constructor(e,t){super(),this.shaderNode=e,this.inputNodes=t,this.isShaderCallNodeInternal=!0}getNodeType(e){return this.shaderNode.nodeType||this.getOutputNode(e).getNodeType(e)}getMemberType(e,t){return this.getOutputNode(e).getMemberType(e,t)}call(e){const{shaderNode:t,inputNodes:s}=this,i=e.getNodeProperties(t),r=e.getClosestSubBuild(t.subBuilds)||"",n=r||"default";if(i[n])return i[n];const a=e.subBuildFn;e.subBuildFn=r;let o=null;if(t.layout){let i=pi2.get(e.constructor);void 0===i&&(i=new WeakMap,pi2.set(e.constructor,i));let r=i.get(t);void 0===r&&(r=Ii2(e.buildFunctionNode(t)),i.set(t,r)),e.addInclude(r),o=Ii2(r.call(s))}else{let i=s;if(Array.isArray(i)){let e=0;i=new Proxy(i,{get:(t,s,i)=>void 0===t[s]?t[e++]:Reflect.get(t,s,i)})}const r=t.jsFunc,n=null!==i||r.length>1?r(i||[],e):r(e);o=Ii2(n)}return e.subBuildFn=a,t.once&&(i[n]=o),o}setupOutput(e){return e.addStack(),e.stack.outputNode=this.call(e),e.removeStack()}getOutputNode(e){const t=e.getNodeProperties(this),s=e.getSubBuildOutput(this);return t[s]=t[s]||this.setupOutput(e),t[s].subBuild=e.getClosestSubBuild(this),t[s]}build(e,t=null){let s=null;const i=e.getBuildStage(),r=e.getNodeProperties(this),n=e.getSubBuildOutput(this),a=this.getOutputNode(e);if("setup"===i){const t=e.getSubBuildProperty("initialized",this);if(!0!==r[t]&&(r[t]=!0,r[n]=this.getOutputNode(e),r[n].build(e),this.shaderNode.subBuilds))for(const t of e.chaining){const s=e.getDataFromNode(t,"any");s.subBuilds=s.subBuilds||new Set;for(const e of this.shaderNode.subBuilds)s.subBuilds.add(e)}s=r[n]}else"analyze"===i?a.build(e,t):"generate"===i&&(s=a.build(e,t)||"");return s}},xi2=class extends js2{constructor(e,t){super(t),this.jsFunc=e,this.layout=null,this.global=!0,this.once=!1}setLayout(e){return this.layout=e,this}call(e=null){return Vi2(e),Ii2(new bi2(this,e))}setup(){return this.call()}},Ti2=[!1,!0],_i2=[0,1,2,3],vi2=[-1,-2],Ni2=[.5,1.5,1/3,1e-6,1e6,Math.PI,2*Math.PI,1/Math.PI,2/Math.PI,1/(2*Math.PI),Math.PI/2],Si2=new Map;for(const e of Ti2)Si2.set(e,new ii2(e));var Ei2=new Map;for(const e of _i2)Ei2.set(e,new ii2(e,"uint"));var wi2=new Map([...Ei2].map(e=>new ii2(e.value,"int")));for(const e of vi2)wi2.set(e,new ii2(e,"int"));var Ai2=new Map([...wi2].map(e=>new ii2(e.value)));for(const e of Ni2)Ai2.set(e,new ii2(e));for(const e of Ni2)Ai2.set(-e,new ii2(-e));var Ri2={bool:Si2,uint:Ei2,ints:wi2,float:Ai2},Ci2=new Map([...Si2,...Ai2]),Mi2=(e,t)=>Ci2.has(e)?Ci2.get(e):!0===e.isNode?e:new ii2(e,t),Pi2=function(e,t=null){return(...s)=>{if((0===s.length||!["bool","float","int","uint"].includes(e)&&s.every(e=>"object"!=typeof e))&&(s=[Bs2(e,...s)]),1===s.length&&null!==t&&t.has(s[0]))return Di2(t.get(s[0]));if(1===s.length){const t=Mi2(s[0],e);return t.nodeType===e?Di2(t):Di2(new Ks2(t,e))}const i=s.map(e=>Mi2(e));return Di2(new Qs2(i,e))}},Bi2=e=>"object"==typeof e&&null!==e?e.value:e,Li2=e=>null!=e?e.nodeType||e.convertTo||("string"==typeof e?e:null):null;function Fi2(e,t){return new Proxy(new xi2(e,t),ci2)}var Ii2=(e,t=null)=>function(e,t=null){const s=Ps2(e);if("node"===s){let t=hi2.get(e);return void 0===t&&(t=new Proxy(e,ci2),hi2.set(e,t),hi2.set(t,t)),t}return null===t&&("float"===s||"boolean"===s)||s&&"shader"!==s&&"string"!==s?Ii2(Mi2(e,t)):"shader"===s?e.isFn?e:Hi2(e):e}(e,t),Di2=(e,t=null)=>Ii2(e,t).toVarIntent(),Vi2=(e,t=null)=>new gi2(e,t),Ui2=(e,t=null)=>new mi2(e,t),Oi2=(e,t=null,s=null,i=null)=>new fi2(e,t,s,i),ki2=(e,...t)=>new yi2(e,...t),Gi2=(e,t=null,s=null,i={})=>new fi2(e,t,s,{intent:!0,...i}),zi2=0,Hi2=(e,t=null)=>{let s=null;null!==t&&("object"==typeof t?s=t.return:("string"==typeof t?s=t:console.error("THREE.TSL: Invalid layout type."),t=null));const i=new Fi2(e,s),r=(...e)=>{let t;Vi2(e),t=e[0]&&(e[0].isNode||Object.getPrototypeOf(e[0])!==Object.prototype)?[...e]:e[0];const r=i.call(t);return"void"===s&&r.toStack(),r.toVarIntent()};if(r.shaderNode=i,r.id=i.id,r.isFn=!0,r.getNodeType=(...e)=>i.getNodeType(...e),r.getCacheKey=(...e)=>i.getCacheKey(...e),r.setLayout=e=>(i.setLayout(e),r),r.once=(e=null)=>(i.once=!0,i.subBuilds=e,r),null!==t){if("object"!=typeof t.inputs){const e={name:"fn"+zi2++,type:s,inputs:[]};for(const s in t)"return"!==s&&e.inputs.push({name:s,type:t[s]});t=e}r.setLayout(t)}return r},$i2=e=>{ai2=e},Wi2=()=>ai2,qi2=(...e)=>ai2.If(...e);function ji2(e){return ai2&&ai2.add(e),e}ui2("toStack",ji2);var Xi2=new Pi2("color"),Ki2=new Pi2("float",Ri2.float),Yi2=new Pi2("int",Ri2.ints),Qi2=new Pi2("uint",Ri2.uint),Zi2=new Pi2("bool",Ri2.bool),Ji2=new Pi2("vec2"),en2=new Pi2("ivec2"),tn2=new Pi2("uvec2"),rn2=new Pi2("bvec2"),sn2=new Pi2("vec3"),nn2=new Pi2("ivec3"),an2=new Pi2("uvec3"),on2=new Pi2("bvec3"),un2=new Pi2("vec4"),ln3=new Pi2("ivec4"),dn2=new Pi2("uvec4"),cn2=new Pi2("bvec4"),hn2=new Pi2("mat2"),pn2=new Pi2("mat3"),gn2=new Pi2("mat4");ui2("toColor",Xi2),ui2("toFloat",Ki2),ui2("toInt",Yi2),ui2("toUint",Qi2),ui2("toBool",Zi2),ui2("toVec2",Ji2),ui2("toIVec2",en2),ui2("toUVec2",tn2),ui2("toBVec2",rn2),ui2("toVec3",sn2),ui2("toIVec3",nn2),ui2("toUVec3",an2),ui2("toBVec3",on2),ui2("toVec4",un2),ui2("toIVec4",ln3),ui2("toUVec4",dn2),ui2("toBVec4",cn2),ui2("toMat2",hn2),ui2("toMat3",pn2),ui2("toMat4",gn2);var mn2=Oi2(Xs2).setParameterLength(2),fn2=(e,t)=>Ii2(new Ks2(Ii2(e),t));ui2("element",mn2),ui2("convert",fn2),ui2("append",e=>(console.warn("THREE.TSL: .append() has been renamed to .toStack()."),ji2(e)));var yn2=class extends js2{static get type(){return"PropertyNode"}constructor(e,t=null,s=!1){super(e),this.name=t,this.varying=s,this.isPropertyNode=!0,this.global=!0}getHash(e){return this.name||super.getHash(e)}generate(e){let t;return!0===this.varying?(t=e.getVaryingFromNode(this,this.name),t.needsInterpolation=!0):t=e.getVarFromNode(this,this.name),e.getPropertyName(t)}},bn2=(e,t)=>Ii2(new yn2(e,t)),xn2=(e,t)=>Ii2(new yn2(e,t,!0)),Tn2=ki2(yn2,"vec4","DiffuseColor"),_n2=ki2(yn2,"vec3","EmissiveColor"),vn2=ki2(yn2,"float","Roughness"),Nn2=ki2(yn2,"float","Metalness"),Sn2=ki2(yn2,"float","Clearcoat"),En2=ki2(yn2,"float","ClearcoatRoughness"),wn2=ki2(yn2,"vec3","Sheen"),An2=ki2(yn2,"float","SheenRoughness"),Rn2=ki2(yn2,"float","Iridescence"),Cn2=ki2(yn2,"float","IridescenceIOR"),Mn2=ki2(yn2,"float","IridescenceThickness"),Pn2=ki2(yn2,"float","AlphaT"),Bn2=ki2(yn2,"float","Anisotropy"),Ln2=ki2(yn2,"vec3","AnisotropyT"),Fn2=ki2(yn2,"vec3","AnisotropyB"),In2=ki2(yn2,"color","SpecularColor"),Dn2=ki2(yn2,"float","SpecularF90"),Vn2=ki2(yn2,"float","Shininess"),Un2=ki2(yn2,"vec4","Output"),On2=ki2(yn2,"float","dashSize"),kn2=ki2(yn2,"float","gapSize"),Gn2=ki2(yn2,"float","pointWidth"),zn2=ki2(yn2,"float","IOR"),Hn=ki2(yn2,"float","Transmission"),$n2=ki2(yn2,"float","Thickness"),Wn2=ki2(yn2,"float","AttenuationDistance"),qn=ki2(yn2,"color","AttenuationColor"),jn2=ki2(yn2,"float","Dispersion"),Xn2=class extends js2{static get type(){return"UniformGroupNode"}constructor(e,t=!1,s=1){super("string"),this.name=e,this.shared=t,this.order=s,this.isUniformGroup=!0}serialize(e){super.serialize(e),e.name=this.name,e.version=this.version,e.shared=this.shared}deserialize(e){super.deserialize(e),this.name=e.name,this.version=e.version,this.shared=e.shared}},Kn2=e=>new Xn2(e),Yn2=(e,t=0)=>new Xn2(e,!0,t),Qn2=Yn2("frame"),Zn2=Yn2("render"),Jn=Kn2("object"),ea2=class extends ri2{static get type(){return"UniformNode"}constructor(e,t=null){super(e,t),this.isUniformNode=!0,this.name="",this.groupNode=Jn}setName(e){return this.name=e,this}label(e){return console.warn('THREE.TSL: "label()" has been deprecated. Use "setName()" instead.'),this.setName(e)}setGroup(e){return this.groupNode=e,this}getGroup(){return this.groupNode}getUniformHash(e){return this.getHash(e)}onUpdate(e,t){const s=this.getSelf();return e=e.bind(s),super.onUpdate(t=>{const i=e(t,s);void 0!==i&&(this.value=i)},t)}getInputType(e){let t=super.getInputType(e);return"bool"===t&&(t="uint"),t}generate(e,t){const s=this.getNodeType(e),i=this.getUniformHash(e);let r=e.getNodeFromHash(i);void 0===r&&(e.setHashNode(this,i),r=this);const n=r.getInputType(e),a=e.getUniformFromNode(r,n,e.shaderStage,this.name||e.context.nodeName),o=e.getPropertyName(a);void 0!==e.context.nodeName&&delete e.context.nodeName;let l=o;if("bool"===s){const t=e.getDataFromNode(this);let i=t.propertyName;if(void 0===i){const r=e.getVarFromNode(this,null,"bool");i=e.getPropertyName(r),t.propertyName=i,l=e.format(o,n,s),e.addLineFlowCode(`${i} = ${l}`,this)}l=i}return e.format(l,s,t)}},ta2=(e,t)=>{const s=Li2(t||e),i=e&&!0===e.isNode?e.node&&e.node.value||e.value:e;return Ii2(new ea2(i,s))},ra2=class extends Ys2{static get type(){return"ArrayNode"}constructor(e,t,s=null){super(e),this.count=t,this.values=s,this.isArrayNode=!0}getArrayCount(){return this.count}getNodeType(e){return null===this.nodeType&&(this.nodeType=this.values[0].getNodeType(e)),this.nodeType}getElementType(e){return this.getNodeType(e)}generate(e){const t=this.getNodeType(e);return e.generateArray(t,this.count,this.values)}},sa2=(...e)=>{let t;if(1===e.length){const s=e[0];t=new ra2(null,s.length,s)}else{const s=e[0],i=e[1];t=new ra2(s,i)}return Ii2(t)};ui2("toArray",(e,t)=>sa2(Array(t).fill(e)));var ia2=class extends Ys2{static get type(){return"AssignNode"}constructor(e,t){super(),this.targetNode=e,this.sourceNode=t,this.isAssignNode=!0}hasDependencies(){return!1}getNodeType(e,t){return"void"!==t?this.targetNode.getNodeType(e):"void"}needsSplitAssign(e){const{targetNode:t}=this;if(!1===e.isAvailable("swizzleAssign")&&t.isSplitNode&&t.components.length>1){const s=e.getTypeLength(t.node.getNodeType(e));return $s2.join("").slice(0,s)!==t.components}return!1}setup(e){const{targetNode:t,sourceNode:s}=this;e.getNodeProperties(t).assign=!0;const i=e.getNodeProperties(this);i.sourceNode=s,i.targetNode=t.context({assign:!0})}generate(e,t){const{targetNode:s,sourceNode:i}=e.getNodeProperties(this),r=this.needsSplitAssign(e),n=s.getNodeType(e),a=s.build(e),o=i.build(e,n),l=i.getNodeType(e),h=e.getDataFromNode(this);let u;if(!0===h.initialized)"void"!==t&&(u=a);else if(r){const i=e.getVarFromNode(this,null,n),r=e.getPropertyName(i);e.addLineFlowCode(`${r} = ${o}`,this);const l=s.node,h=l.node.context({assign:!0}).build(e);for(let t=0;t<l.components.length;t++){const s=l.components[t];e.addLineFlowCode(`${h}.${s} = ${r}[ ${t} ]`,this)}"void"!==t&&(u=a)}else u=`${a} = ${o}`,"void"!==t&&"void"!==l||(e.addLineFlowCode(u,this),"void"!==t&&(u=a));return h.initialized=!0,e.format(u,n,t)}},na2=Oi2(ia2).setParameterLength(2);ui2("assign",na2);var aa2=class extends Ys2{static get type(){return"FunctionCallNode"}constructor(e=null,t={}){super(),this.functionNode=e,this.parameters=t}setParameters(e){return this.parameters=e,this}getParameters(){return this.parameters}getNodeType(e){return this.functionNode.getNodeType(e)}generate(e){const t=[],s=this.functionNode,i=s.getInputs(e),r=this.parameters,n=(t,s)=>{const i=s.type;let r;return r="pointer"===i?"&"+t.build(e):t.build(e,i),r};if(Array.isArray(r)){if(r.length>i.length)console.error("THREE.TSL: The number of provided parameters exceeds the expected number of inputs in 'Fn()'."),r.length=i.length;else if(r.length<i.length)for(console.error("THREE.TSL: The number of provided parameters is less than the expected number of inputs in 'Fn()'.");r.length<i.length;)r.push(Ki2(0));for(let e=0;e<r.length;e++)t.push(n(r[e],i[e]))}else for(const e of i){const s=r[e.name];void 0!==s?t.push(n(s,e)):(console.error(`THREE.TSL: Input '${e.name}' not found in 'Fn()'.`),t.push(n(Ki2(0),e)))}return`${s.build(e,"property")}( ${t.join(", ")} )`}},oa2=(e,...t)=>(t=t.length>1||t[0]&&!0===t[0].isNode?Ui2(t):Vi2(t[0]),Ii2(new aa2(Ii2(e),t)));ui2("call",oa2);var ua2={"==":"equal","!=":"notEqual","<":"lessThan",">":"greaterThan","<=":"lessThanEqual",">=":"greaterThanEqual","%":"mod"},la2=class e extends Ys2{static get type(){return"OperatorNode"}constructor(t,s,i,...r){if(super(),r.length>0){let n=new e(t,s,i);for(let s=0;s<r.length-1;s++)n=new e(t,n,r[s]);s=n,i=r[r.length-1]}this.op=t,this.aNode=s,this.bNode=i,this.isOperatorNode=!0}getOperatorMethod(e,t){return e.getMethod(ua2[this.op],t)}getNodeType(e){const t=this.op,s=this.aNode,i=this.bNode,r=s.getNodeType(e),n=i?i.getNodeType(e):null;if("void"===r||"void"===n)return"void";if("%"===t)return r;if("~"===t||"&"===t||"|"===t||"^"===t||">>"===t||"<<"===t)return e.getIntegerType(r);if("!"===t||"&&"===t||"||"===t||"^^"===t)return"bool";if("=="===t||"!="===t||"<"===t||">"===t||"<="===t||">="===t){const t=Math.max(e.getTypeLength(r),e.getTypeLength(n));return t>1?`bvec${t}`:"bool"}if(e.isMatrix(r)){if("float"===n)return r;if(e.isVector(n))return e.getVectorFromMatrix(r);if(e.isMatrix(n))return r}else if(e.isMatrix(n)){if("float"===r)return n;if(e.isVector(r))return e.getVectorFromMatrix(n)}return e.getTypeLength(n)>e.getTypeLength(r)?n:r}generate(e,t){const s=this.op,{aNode:i,bNode:r}=this,n=this.getNodeType(e);let a=null,o=null;"void"!==n?(a=i.getNodeType(e),o=r?r.getNodeType(e):null,"<"===s||">"===s||"<="===s||">="===s||"=="===s||"!="===s?e.isVector(a)?o=a:e.isVector(o)?a=o:a!==o&&(a=o="float"):">>"===s||"<<"===s?(a=n,o=e.changeComponentType(o,"uint")):"%"===s?(a=n,o=e.isInteger(a)&&e.isInteger(o)?o:a):e.isMatrix(a)?"float"===o?o="float":e.isVector(o)?o=e.getVectorFromMatrix(a):e.isMatrix(o)||(a=o=n):a=e.isMatrix(o)?"float"===a?"float":e.isVector(a)?e.getVectorFromMatrix(o):o=n:o=n):a=o=n;const l=i.build(e,a),h=r?r.build(e,o):null,u=e.getFunctionOperator(s);if("void"!==t){const i=e.renderer.coordinateSystem===Ri;if("=="===s||"!="===s||"<"===s||">"===s||"<="===s||">="===s)return i&&e.isVector(a)?e.format(`${this.getOperatorMethod(e,t)}( ${l}, ${h} )`,n,t):e.format(`( ${l} ${s} ${h} )`,n,t);if("%"===s)return e.isInteger(o)?e.format(`( ${l} % ${h} )`,n,t):e.format(`${this.getOperatorMethod(e,n)}( ${l}, ${h} )`,n,t);if("!"===s||"~"===s)return e.format(`(${s}${l})`,a,t);if(u)return e.format(`${u}( ${l}, ${h} )`,n,t);if(e.isMatrix(a)&&"float"===o)return e.format(`( ${h} ${s} ${l} )`,n,t);if("float"===a&&e.isMatrix(o))return e.format(`${l} ${s} ${h}`,n,t);{let r=`( ${l} ${s} ${h} )`;return!i&&"bool"===n&&e.isVector(a)&&e.isVector(o)&&(r=`all${r}`),e.format(r,n,t)}}if("void"!==a)return u?e.format(`${u}( ${l}, ${h} )`,n,t):e.isMatrix(a)&&"float"===o?e.format(`${h} ${s} ${l}`,n,t):e.format(`${l} ${s} ${h}`,n,t)}serialize(e){super.serialize(e),e.op=this.op}deserialize(e){super.deserialize(e),this.op=e.op}},da2=Gi2(la2,"+").setParameterLength(2,1/0).setName("add"),ca2=Gi2(la2,"-").setParameterLength(2,1/0).setName("sub"),ha2=Gi2(la2,"*").setParameterLength(2,1/0).setName("mul"),pa=Gi2(la2,"/").setParameterLength(2,1/0).setName("div"),ga2=Gi2(la2,"%").setParameterLength(2).setName("mod"),ma2=Gi2(la2,"==").setParameterLength(2).setName("equal"),fa2=Gi2(la2,"!=").setParameterLength(2).setName("notEqual"),ya2=Gi2(la2,"<").setParameterLength(2).setName("lessThan"),ba2=Gi2(la2,">").setParameterLength(2).setName("greaterThan"),xa2=Gi2(la2,"<=").setParameterLength(2).setName("lessThanEqual"),Ta2=Gi2(la2,">=").setParameterLength(2).setName("greaterThanEqual"),_a2=Gi2(la2,"&&").setParameterLength(2,1/0).setName("and"),va2=Gi2(la2,"||").setParameterLength(2,1/0).setName("or"),Na2=Gi2(la2,"!").setParameterLength(1).setName("not"),Sa2=Gi2(la2,"^^").setParameterLength(2).setName("xor"),Ea2=Gi2(la2,"&").setParameterLength(2).setName("bitAnd"),wa2=Gi2(la2,"~").setParameterLength(2).setName("bitNot"),Aa2=Gi2(la2,"|").setParameterLength(2).setName("bitOr"),Ra2=Gi2(la2,"^").setParameterLength(2).setName("bitXor"),Ca2=Gi2(la2,"<<").setParameterLength(2).setName("shiftLeft"),Ma2=Gi2(la2,">>").setParameterLength(2).setName("shiftRight"),Pa2=Hi2(([e])=>(e.addAssign(1),e)),Ba2=Hi2(([e])=>(e.subAssign(1),e)),La2=Hi2(([e])=>{const t=Yi2(e).toConst();return e.addAssign(1),t}),Fa2=Hi2(([e])=>{const t=Yi2(e).toConst();return e.subAssign(1),t});ui2("add",da2),ui2("sub",ca2),ui2("mul",ha2),ui2("div",pa),ui2("mod",ga2),ui2("equal",ma2),ui2("notEqual",fa2),ui2("lessThan",ya2),ui2("greaterThan",ba2),ui2("lessThanEqual",xa2),ui2("greaterThanEqual",Ta2),ui2("and",_a2),ui2("or",va2),ui2("not",Na2),ui2("xor",Sa2),ui2("bitAnd",Ea2),ui2("bitNot",wa2),ui2("bitOr",Aa2),ui2("bitXor",Ra2),ui2("shiftLeft",Ca2),ui2("shiftRight",Ma2),ui2("incrementBefore",Pa2),ui2("decrementBefore",Ba2),ui2("increment",La2),ui2("decrement",Fa2);var Ia2=(e,t)=>(console.warn('THREE.TSL: "modInt()" is deprecated. Use "mod( int( ... ) )" instead.'),ga2(Yi2(e),Yi2(t)));ui2("modInt",Ia2);var Da2=class e extends Ys2{static get type(){return"MathNode"}constructor(t,s,i=null,r=null){if(super(),(t===e.MAX||t===e.MIN)&&arguments.length>3){let n=new e(t,s,i);for(let s=2;s<arguments.length-1;s++)n=new e(t,n,arguments[s]);s=n,i=arguments[arguments.length-1],r=null}this.method=t,this.aNode=s,this.bNode=i,this.cNode=r,this.isMathNode=!0}getInputType(e){const t=this.aNode.getNodeType(e),s=this.bNode?this.bNode.getNodeType(e):null,i=this.cNode?this.cNode.getNodeType(e):null,r=e.isMatrix(t)?0:e.getTypeLength(t),n=e.isMatrix(s)?0:e.getTypeLength(s),a=e.isMatrix(i)?0:e.getTypeLength(i);return r>n&&r>a?t:n>a?s:a>r?i:t}getNodeType(t){const s=this.method;return s===e.LENGTH||s===e.DISTANCE||s===e.DOT?"float":s===e.CROSS?"vec3":s===e.ALL||s===e.ANY?"bool":s===e.EQUALS?t.changeComponentType(this.aNode.getNodeType(t),"bool"):this.getInputType(t)}setup(t){const{aNode:s,bNode:i,method:r}=this;let n=null;if(r===e.ONE_MINUS)n=ca2(1,s);else if(r===e.RECIPROCAL)n=pa(1,s);else if(r===e.DIFFERENCE)n=oo2(ca2(s,i));else if(r===e.TRANSFORM_DIRECTION){let e=s,r=i;t.isMatrix(e.getNodeType(t))?r=un2(sn2(r),0):e=un2(sn2(e),0);const a=ha2(e,r).xyz;n=Ja2(a)}return null!==n?n:super.setup(t)}generate(t,s){if(t.getNodeProperties(this).outputNode)return super.generate(t,s);let i=this.method;const r=this.getNodeType(t),n=this.getInputType(t),a=this.aNode,o=this.bNode,l=this.cNode,h=t.renderer.coordinateSystem;if(i===e.NEGATE)return t.format("( - "+a.build(t,n)+" )",r,s);{const u=[];return i===e.CROSS?u.push(a.build(t,r),o.build(t,r)):h===Ri&&i===e.STEP?u.push(a.build(t,1===t.getTypeLength(a.getNodeType(t))?"float":n),o.build(t,n)):h!==Ri||i!==e.MIN&&i!==e.MAX?i===e.REFRACT?u.push(a.build(t,n),o.build(t,n),l.build(t,"float")):i===e.MIX?u.push(a.build(t,n),o.build(t,n),l.build(t,1===t.getTypeLength(l.getNodeType(t))?"float":n)):(h===Pi&&i===e.ATAN&&null!==o&&(i="atan2"),"fragment"===t.shaderStage||i!==e.DFDX&&i!==e.DFDY||(console.warn(`THREE.TSL: '${i}' is not supported in the ${t.shaderStage} stage.`),i="/*"+i+"*/"),u.push(a.build(t,n)),null!==o&&u.push(o.build(t,n)),null!==l&&u.push(l.build(t,n))):u.push(a.build(t,n),o.build(t,1===t.getTypeLength(o.getNodeType(t))?"float":n)),t.format(`${t.getMethod(i,r)}( ${u.join(", ")} )`,r,s)}}serialize(e){super.serialize(e),e.method=this.method}deserialize(e){super.deserialize(e),this.method=e.method}};Da2.ALL="all",Da2.ANY="any",Da2.RADIANS="radians",Da2.DEGREES="degrees",Da2.EXP="exp",Da2.EXP2="exp2",Da2.LOG="log",Da2.LOG2="log2",Da2.SQRT="sqrt",Da2.INVERSE_SQRT="inversesqrt",Da2.FLOOR="floor",Da2.CEIL="ceil",Da2.NORMALIZE="normalize",Da2.FRACT="fract",Da2.SIN="sin",Da2.COS="cos",Da2.TAN="tan",Da2.ASIN="asin",Da2.ACOS="acos",Da2.ATAN="atan",Da2.ABS="abs",Da2.SIGN="sign",Da2.LENGTH="length",Da2.NEGATE="negate",Da2.ONE_MINUS="oneMinus",Da2.DFDX="dFdx",Da2.DFDY="dFdy",Da2.ROUND="round",Da2.RECIPROCAL="reciprocal",Da2.TRUNC="trunc",Da2.FWIDTH="fwidth",Da2.TRANSPOSE="transpose",Da2.DETERMINANT="determinant",Da2.INVERSE="inverse",Da2.BITCAST="bitcast",Da2.EQUALS="equals",Da2.MIN="min",Da2.MAX="max",Da2.STEP="step",Da2.REFLECT="reflect",Da2.DISTANCE="distance",Da2.DIFFERENCE="difference",Da2.DOT="dot",Da2.CROSS="cross",Da2.POW="pow",Da2.TRANSFORM_DIRECTION="transformDirection",Da2.MIX="mix",Da2.CLAMP="clamp",Da2.REFRACT="refract",Da2.SMOOTHSTEP="smoothstep",Da2.FACEFORWARD="faceforward";var Va2=Ki2(1e-6),Ua2=Ki2(1e6),Oa2=Ki2(Math.PI),ka2=Ki2(2*Math.PI),Ga2=Gi2(Da2,Da2.ALL).setParameterLength(1),za=Gi2(Da2,Da2.ANY).setParameterLength(1),Ha2=Gi2(Da2,Da2.RADIANS).setParameterLength(1),$a2=Gi2(Da2,Da2.DEGREES).setParameterLength(1),Wa2=Gi2(Da2,Da2.EXP).setParameterLength(1),qa2=Gi2(Da2,Da2.EXP2).setParameterLength(1),ja2=Gi2(Da2,Da2.LOG).setParameterLength(1),Xa2=Gi2(Da2,Da2.LOG2).setParameterLength(1),Ka2=Gi2(Da2,Da2.SQRT).setParameterLength(1),Ya2=Gi2(Da2,Da2.INVERSE_SQRT).setParameterLength(1),Qa2=Gi2(Da2,Da2.FLOOR).setParameterLength(1),Za2=Gi2(Da2,Da2.CEIL).setParameterLength(1),Ja2=Gi2(Da2,Da2.NORMALIZE).setParameterLength(1),eo2=Gi2(Da2,Da2.FRACT).setParameterLength(1),to2=Gi2(Da2,Da2.SIN).setParameterLength(1),ro2=Gi2(Da2,Da2.COS).setParameterLength(1),so2=Gi2(Da2,Da2.TAN).setParameterLength(1),io2=Gi2(Da2,Da2.ASIN).setParameterLength(1),no2=Gi2(Da2,Da2.ACOS).setParameterLength(1),ao2=Gi2(Da2,Da2.ATAN).setParameterLength(1,2),oo2=Gi2(Da2,Da2.ABS).setParameterLength(1),uo2=Gi2(Da2,Da2.SIGN).setParameterLength(1),lo2=Gi2(Da2,Da2.LENGTH).setParameterLength(1),co2=Gi2(Da2,Da2.NEGATE).setParameterLength(1),ho2=Gi2(Da2,Da2.ONE_MINUS).setParameterLength(1),po=Gi2(Da2,Da2.DFDX).setParameterLength(1),go2=Gi2(Da2,Da2.DFDY).setParameterLength(1),mo=Gi2(Da2,Da2.ROUND).setParameterLength(1),fo2=Gi2(Da2,Da2.RECIPROCAL).setParameterLength(1),yo=Gi2(Da2,Da2.TRUNC).setParameterLength(1),bo2=Gi2(Da2,Da2.FWIDTH).setParameterLength(1),xo2=Gi2(Da2,Da2.TRANSPOSE).setParameterLength(1),To2=Gi2(Da2,Da2.DETERMINANT).setParameterLength(1),_o2=Gi2(Da2,Da2.INVERSE).setParameterLength(1),vo2=Gi2(Da2,Da2.BITCAST).setParameterLength(2),No2=(e,t)=>(console.warn('THREE.TSL: "equals" is deprecated. Use "equal" inside a vector instead, like: "bvec*( equal( ... ) )"'),ma2(e,t)),So2=Gi2(Da2,Da2.MIN).setParameterLength(2,1/0),Eo2=Gi2(Da2,Da2.MAX).setParameterLength(2,1/0),wo2=Gi2(Da2,Da2.STEP).setParameterLength(2),Ao2=Gi2(Da2,Da2.REFLECT).setParameterLength(2),Ro2=Gi2(Da2,Da2.DISTANCE).setParameterLength(2),Co=Gi2(Da2,Da2.DIFFERENCE).setParameterLength(2),Mo2=Gi2(Da2,Da2.DOT).setParameterLength(2),Po2=Gi2(Da2,Da2.CROSS).setParameterLength(2),Bo=Gi2(Da2,Da2.POW).setParameterLength(2),Lo2=Gi2(Da2,Da2.POW,2).setParameterLength(1),Fo2=Gi2(Da2,Da2.POW,3).setParameterLength(1),Io=Gi2(Da2,Da2.POW,4).setParameterLength(1),Do2=Gi2(Da2,Da2.TRANSFORM_DIRECTION).setParameterLength(2),Vo2=e=>ha2(uo2(e),Bo(oo2(e),1/3)),Uo2=e=>Mo2(e,e),Oo2=Gi2(Da2,Da2.MIX).setParameterLength(3),ko2=(e,t=0,s=1)=>Ii2(new Da2(Da2.CLAMP,Ii2(e),Ii2(t),Ii2(s))),Go2=e=>ko2(e),zo2=Gi2(Da2,Da2.REFRACT).setParameterLength(3),Ho2=Gi2(Da2,Da2.SMOOTHSTEP).setParameterLength(3),$o2=Gi2(Da2,Da2.FACEFORWARD).setParameterLength(3),Wo2=Hi2(([e])=>{const t=Mo2(e.xy,Ji2(12.9898,78.233)),s=ga2(t,Oa2);return eo2(to2(s).mul(43758.5453))}),qo2=(e,t,s)=>Oo2(t,s,e),jo2=(e,t,s)=>Ho2(t,s,e),Xo2=(e,t)=>wo2(t,e),Ko2=(e,t)=>(console.warn('THREE.TSL: "atan2" is overloaded. Use "atan" instead.'),ao2(e,t)),Yo2=$o2,Qo2=Ya2;ui2("all",Ga2),ui2("any",za),ui2("equals",No2),ui2("radians",Ha2),ui2("degrees",$a2),ui2("exp",Wa2),ui2("exp2",qa2),ui2("log",ja2),ui2("log2",Xa2),ui2("sqrt",Ka2),ui2("inverseSqrt",Ya2),ui2("floor",Qa2),ui2("ceil",Za2),ui2("normalize",Ja2),ui2("fract",eo2),ui2("sin",to2),ui2("cos",ro2),ui2("tan",so2),ui2("asin",io2),ui2("acos",no2),ui2("atan",ao2),ui2("abs",oo2),ui2("sign",uo2),ui2("length",lo2),ui2("lengthSq",Uo2),ui2("negate",co2),ui2("oneMinus",ho2),ui2("dFdx",po),ui2("dFdy",go2),ui2("round",mo),ui2("reciprocal",fo2),ui2("trunc",yo),ui2("fwidth",bo2),ui2("atan2",Ko2),ui2("min",So2),ui2("max",Eo2),ui2("step",Xo2),ui2("reflect",Ao2),ui2("distance",Ro2),ui2("dot",Mo2),ui2("cross",Po2),ui2("pow",Bo),ui2("pow2",Lo2),ui2("pow3",Fo2),ui2("pow4",Io),ui2("transformDirection",Do2),ui2("mix",qo2),ui2("clamp",ko2),ui2("refract",zo2),ui2("smoothstep",jo2),ui2("faceForward",$o2),ui2("difference",Co),ui2("saturate",Go2),ui2("cbrt",Vo2),ui2("transpose",xo2),ui2("determinant",To2),ui2("inverse",_o2),ui2("rand",Wo2);var Zo2=class extends js2{static get type(){return"ConditionalNode"}constructor(e,t,s=null){super(),this.condNode=e,this.ifNode=t,this.elseNode=s}getNodeType(e){const{ifNode:t,elseNode:s}=e.getNodeProperties(this);if(void 0===t)return e.flowBuildStage(this,"setup"),this.getNodeType(e);const i=t.getNodeType(e);if(null!==s){const t=s.getNodeType(e);if(e.getTypeLength(t)>e.getTypeLength(i))return t}return i}setup(e){const t=this.condNode.cache(),s=this.ifNode.cache(),i=this.elseNode?this.elseNode.cache():null,r=e.context.nodeBlock;e.getDataFromNode(s).parentNodeBlock=r,null!==i&&(e.getDataFromNode(i).parentNodeBlock=r);const n=e.getNodeProperties(this);n.condNode=t,n.ifNode=s.context({nodeBlock:s}),n.elseNode=i?i.context({nodeBlock:i}):null}generate(e,t){const s=this.getNodeType(e),i=e.getDataFromNode(this);if(void 0!==i.nodeProperty)return i.nodeProperty;const{condNode:r,ifNode:n,elseNode:a}=e.getNodeProperties(this),o=e.currentFunctionNode,l="void"!==t,h=l?bn2(s).build(e):"";i.nodeProperty=h;const u=r.build(e,"bool");e.addFlowCode(`\n${e.tab}if ( ${u} ) {\n\n`).addFlowTab();let c=n.build(e,s);if(c&&(l?c=h+" = "+c+";":(c="return "+c+";",null===o&&(console.warn("THREE.TSL: Return statement used in an inline 'Fn()'. Define a layout struct to allow return values."),c="// "+c))),e.removeFlowTab().addFlowCode(e.tab+"\t"+c+"\n\n"+e.tab+"}"),null!==a){e.addFlowCode(" else {\n\n").addFlowTab();let t=a.build(e,s);t&&(l?t=h+" = "+t+";":(t="return "+t+";",null===o&&(console.warn("THREE.TSL: Return statement used in an inline 'Fn()'. Define a layout struct to allow return values."),t="// "+t))),e.removeFlowTab().addFlowCode(e.tab+"\t"+t+"\n\n"+e.tab+"}\n\n")}else e.addFlowCode("\n\n");return e.format(h,s,t)}},Jo2=Oi2(Zo2).setParameterLength(2,3);ui2("select",Jo2);var eu=class extends js2{static get type(){return"ContextNode"}constructor(e,t={}){super(),this.isContextNode=!0,this.node=e,this.value=t}getScope(){return this.node.getScope()}getNodeType(e){return this.node.getNodeType(e)}analyze(e){const t=e.getContext();e.setContext({...e.context,...this.value}),this.node.build(e),e.setContext(t)}setup(e){const t=e.getContext();e.setContext({...e.context,...this.value}),this.node.build(e),e.setContext(t)}generate(e,t){const s=e.getContext();e.setContext({...e.context,...this.value});const i=this.node.build(e,t);return e.setContext(s),i}},tu2=Oi2(eu).setParameterLength(1,2),ru2=(e,t)=>tu2(e,{nodeName:t});function su2(e,t){return console.warn('THREE.TSL: "label()" has been deprecated. Use "setName()" instead.'),ru2(e,t)}ui2("context",tu2),ui2("label",su2),ui2("setName",ru2);var iu2=class extends js2{static get type(){return"VarNode"}constructor(e,t=null,s=!1){super(),this.node=e,this.name=t,this.global=!0,this.isVarNode=!0,this.readOnly=s,this.parents=!0,this.intent=!1}setIntent(e){return this.intent=e,this}getIntent(){return this.intent}getMemberType(e,t){return this.node.getMemberType(e,t)}getElementType(e){return this.node.getElementType(e)}getNodeType(e){return this.node.getNodeType(e)}getArrayCount(e){return this.node.getArrayCount(e)}build(...e){return!0===this.intent&&!0!==e[0].getNodeProperties(this).assign?this.node.build(...e):super.build(...e)}generate(e){const{node:t,name:s,readOnly:i}=this,{renderer:r}=e,n=!0===r.backend.isWebGPUBackend;let a=!1,o=!1;i&&(a=e.isDeterministic(t),o=n?i:a);const l=e.getVectorType(this.getNodeType(e)),h=t.build(e,l),u=e.getVarFromNode(this,s,l,void 0,o),c=e.getPropertyName(u);let d=c;if(o)if(n)d=a?`const ${c}`:`let ${c}`;else{const s=t.getArrayCount(e);d=`const ${e.getVar(u.type,c,s)}`}return e.addLineFlowCode(`${d} = ${h}`,this),c}},nu2=Oi2(iu2),au2=(e,t=null)=>nu2(e,t).toStack(),ou2=(e,t=null)=>nu2(e,t,!0).toStack(),uu2=e=>null===Wi2()?e:nu2(e).setIntent(!0).toStack();ui2("toVar",au2),ui2("toConst",ou2),ui2("toVarIntent",uu2);var lu2=e=>(console.warn('TSL: "temp( node )" is deprecated. Use "Var( node )" or "node.toVar()" instead.'),nu2(e));ui2("temp",lu2);var du2=class extends js2{static get type(){return"SubBuild"}constructor(e,t,s=null){super(s),this.node=e,this.name=t,this.isSubBuildNode=!0}getNodeType(e){if(null!==this.nodeType)return this.nodeType;e.addSubBuild(this.name);const t=this.node.getNodeType(e);return e.removeSubBuild(),t}build(e,...t){e.addSubBuild(this.name);const s=this.node.build(e,...t);return e.removeSubBuild(),s}},cu2=(e,t,s=null)=>Ii2(new du2(Ii2(e),t,s)),hu2=class extends js2{static get type(){return"VaryingNode"}constructor(e,t=null){super(),this.node=e,this.name=t,this.isVaryingNode=!0,this.interpolationType=null,this.interpolationSampling=null,this.global=!0}setInterpolation(e,t=null){return this.interpolationType=e,this.interpolationSampling=t,this}getHash(e){return this.name||super.getHash(e)}getNodeType(e){return this.node.getNodeType(e)}setupVarying(e){const t=e.getNodeProperties(this);let s=t.varying;if(void 0===s){const i=this.name,r=this.getNodeType(e),n=this.interpolationType,a=this.interpolationSampling;t.varying=s=e.getVaryingFromNode(this,i,r,n,a),t.node=cu2(this.node,"VERTEX")}return s.needsInterpolation||(s.needsInterpolation="fragment"===e.shaderStage),s}setup(e){this.setupVarying(e),e.flowNodeFromShaderStage(Vs2.VERTEX,this.node)}analyze(e){this.setupVarying(e),e.flowNodeFromShaderStage(Vs2.VERTEX,this.node)}generate(e){const t=e.getSubBuildProperty("property",e.currentStack),s=e.getNodeProperties(this),i=this.setupVarying(e);if(void 0===s[t]){const r=this.getNodeType(e),n=e.getPropertyName(i,Vs2.VERTEX);e.flowNodeFromShaderStage(Vs2.VERTEX,s.node,r,n),s[t]=n}return e.getPropertyName(i)}},pu2=Oi2(hu2).setParameterLength(1,2),gu2=e=>pu2(e);ui2("toVarying",pu2),ui2("toVertexStage",gu2),ui2("varying",(...e)=>(console.warn("THREE.TSL: .varying() has been renamed to .toVarying()."),pu2(...e))),ui2("vertexStage",(...e)=>(console.warn("THREE.TSL: .vertexStage() has been renamed to .toVertexStage()."),pu2(...e)));var mu2=Hi2(([e])=>{const t=e.mul(.9478672986).add(.0521327014).pow(2.4),s=e.mul(.0773993808),i=e.lessThanEqual(.04045);return Oo2(t,s,i)}).setLayout({name:"sRGBTransferEOTF",type:"vec3",inputs:[{name:"color",type:"vec3"}]}),fu2=Hi2(([e])=>{const t=e.pow(.41666).mul(1.055).sub(.055),s=e.mul(12.92),i=e.lessThanEqual(.0031308);return Oo2(t,s,i)}).setLayout({name:"sRGBTransferOETF",type:"vec3",inputs:[{name:"color",type:"vec3"}]}),yu2="WorkingColorSpace",bu2=class extends Ys2{static get type(){return"ColorSpaceNode"}constructor(e,t,s){super("vec4"),this.colorNode=e,this.source=t,this.target=s}resolveColorSpace(e,t){return t===yu2?ms.workingColorSpace:"OutputColorSpace"===t?e.context.outputColorSpace||e.renderer.outputColorSpace:t}setup(e){const{colorNode:t}=this,s=this.resolveColorSpace(e,this.source),i=this.resolveColorSpace(e,this.target);let r=t;return!1!==ms.enabled&&s!==i&&s&&i?(ms.getTransfer(s)===$e&&(r=un2(mu2(r.rgb),r.a)),ms.getPrimaries(s)!==ms.getPrimaries(i)&&(r=un2(pn2(ms._getMatrix(new es,s,i)).mul(r.rgb),r.a)),ms.getTransfer(i)===$e&&(r=un2(fu2(r.rgb),r.a)),r):r}},xu2=(e,t)=>Ii2(new bu2(Ii2(e),yu2,t)),Tu2=(e,t)=>Ii2(new bu2(Ii2(e),t,yu2));ui2("workingToColorSpace",xu2),ui2("colorSpaceToWorking",Tu2);var _u2=class extends Xs2{static get type(){return"ReferenceElementNode"}constructor(e,t){super(e,t),this.referenceNode=e,this.isReferenceElementNode=!0}getNodeType(){return this.referenceNode.uniformType}generate(e){const t=super.generate(e),s=this.referenceNode.getNodeType(),i=this.getNodeType();return e.format(t,s,i)}},vu2=class extends js2{static get type(){return"ReferenceBaseNode"}constructor(e,t,s=null,i=null){super(),this.property=e,this.uniformType=t,this.object=s,this.count=i,this.properties=e.split("."),this.reference=s,this.node=null,this.group=null,this.updateType=Us2.OBJECT}setGroup(e){return this.group=e,this}element(e){return Ii2(new _u2(this,Ii2(e)))}setNodeType(e){const t=ta2(null,e).getSelf();null!==this.group&&t.setGroup(this.group),this.node=t}getNodeType(e){return null===this.node&&(this.updateReference(e),this.updateValue()),this.node.getNodeType(e)}getValueFromReference(e=this.reference){const{properties:t}=this;let s=e[t[0]];for(let e=1;e<t.length;e++)s=s[t[e]];return s}updateReference(e){return this.reference=null!==this.object?this.object:e.object,this.reference}setup(){return this.updateValue(),this.node}update(){this.updateValue()}updateValue(){null===this.node&&this.setNodeType(this.uniformType);const e=this.getValueFromReference();Array.isArray(e)?this.node.array=e:this.node.value=e}},Nu2=class extends vu2{static get type(){return"RendererReferenceNode"}constructor(e,t,s=null){super(e,t,s),this.renderer=s,this.setGroup(Zn2)}updateReference(e){return this.reference=null!==this.renderer?this.renderer:e.renderer,this.reference}},Su2=(e,t,s=null)=>Ii2(new Nu2(e,t,s)),Eu2=class extends Ys2{static get type(){return"ToneMappingNode"}constructor(e,t=Au2,s=null){super("vec3"),this.toneMapping=e,this.exposureNode=t,this.colorNode=s}customCacheKey(){return _s2(this.toneMapping)}setup(e){const t=this.colorNode||e.context.color,s=this.toneMapping;if(s===$)return t;let i=null;const r=e.renderer.library.getToneMappingFunction(s);return null!==r?i=un2(r(t.rgb,this.exposureNode),t.a):(console.error("ToneMappingNode: Unsupported Tone Mapping configuration.",s),i=t),i}},wu2=(e,t,s)=>Ii2(new Eu2(e,Ii2(t),Ii2(s))),Au2=Su2("toneMappingExposure","float");ui2("toneMapping",(e,t,s)=>wu2(t,s,e));var Ru2=class extends ri2{static get type(){return"BufferAttributeNode"}constructor(e,t=null,s=0,i=0){super(e,t),this.isBufferNode=!0,this.bufferType=t,this.bufferStride=s,this.bufferOffset=i,this.usage=Mi,this.instanced=!1,this.attribute=null,this.global=!0,e&&!0===e.isBufferAttribute&&(this.attribute=e,this.usage=e.usage,this.instanced=e.isInstancedBufferAttribute)}getHash(e){if(0===this.bufferStride&&0===this.bufferOffset){let t=e.globalCache.getData(this.value);return void 0===t&&(t={node:this},e.globalCache.setData(this.value,t)),t.node.uuid}return this.uuid}getNodeType(e){return null===this.bufferType&&(this.bufferType=e.getTypeFromAttribute(this.attribute)),this.bufferType}setup(e){if(null!==this.attribute)return;const t=this.getNodeType(e),s=this.value,i=e.getTypeLength(t),r=this.bufferStride||i,n=this.bufferOffset,a=!0===s.isInterleavedBuffer?s:new la(s,r),o=new ua(a,i,n);a.setUsage(this.usage),this.attribute=o,this.attribute.isInstancedBufferAttribute=this.instanced}generate(e){const t=this.getNodeType(e),s=e.getBufferAttributeFromNode(this,t),i=e.getPropertyName(s);let r=null;return"vertex"===e.shaderStage||"compute"===e.shaderStage?(this.name=i,r=i):r=pu2(this).build(e,t),r}getInputType(){return"bufferAttribute"}setUsage(e){return this.usage=e,this.attribute&&!0===this.attribute.isBufferAttribute&&(this.attribute.usage=e),this}setInstanced(e){return this.instanced=e,this}},Cu2=(e,t=null,s=0,i=0)=>Ii2(new Ru2(e,t,s,i)),Mu2=(e,t=null,s=0,i=0)=>Cu2(e,t,s,i).setUsage(Si),Pu2=(e,t=null,s=0,i=0)=>Cu2(e,t,s,i).setInstanced(!0),Bu2=(e,t=null,s=0,i=0)=>Mu2(e,t,s,i).setInstanced(!0);ui2("toAttribute",e=>Cu2(e.value));var Lu2=class extends js2{static get type(){return"ComputeNode"}constructor(e,t){super("void"),this.isComputeNode=!0,this.computeNode=e,this.workgroupSize=t,this.count=null,this.version=1,this.name="",this.updateBeforeType=Us2.OBJECT,this.onInitFunction=null}setCount(e){return this.count=e,this}getCount(){return this.count}dispose(){this.dispatchEvent({type:"dispose"})}setName(e){return this.name=e,this}label(e){return console.warn('THREE.TSL: "label()" has been deprecated. Use "setName()" instead.'),this.setName(e)}onInit(e){return this.onInitFunction=e,this}updateBefore({renderer:e}){e.compute(this)}setup(e){const t=this.computeNode.build(e);return t&&(e.getNodeProperties(this).outputComputeNode=t.outputNode,t.outputNode=null),t}generate(e,t){const{shaderStage:s}=e;if("compute"===s){const t=this.computeNode.build(e,"void");""!==t&&e.addLineFlowCode(t,this)}else{const s=e.getNodeProperties(this).outputComputeNode;if(s)return s.build(e,t)}}},Fu2=(e,t=[64])=>{(0===t.length||t.length>3)&&console.error("THREE.TSL: compute() workgroupSize must have 1, 2, or 3 elements");for(let e=0;e<t.length;e++){const s=t[e];("number"!=typeof s||s<=0||!Number.isInteger(s))&&console.error(`THREE.TSL: compute() workgroupSize element at index [ ${e} ] must be a positive integer`)}for(;t.length<3;)t.push(1);return Ii2(new Lu2(Ii2(e),t))},Iu2=(e,t,s)=>Fu2(e,s).setCount(t);ui2("compute",Iu2),ui2("computeKernel",Fu2);var Du2=class extends js2{static get type(){return"CacheNode"}constructor(e,t=!0){super(),this.node=e,this.parent=t,this.isCacheNode=!0}getNodeType(e){const t=e.getCache(),s=e.getCacheFromNode(this,this.parent);e.setCache(s);const i=this.node.getNodeType(e);return e.setCache(t),i}build(e,...t){const s=e.getCache(),i=e.getCacheFromNode(this,this.parent);e.setCache(i);const r=this.node.build(e,...t);return e.setCache(s),r}},Vu=(e,t)=>Ii2(new Du2(Ii2(e),t));ui2("cache",Vu);var Uu2=class extends js2{static get type(){return"BypassNode"}constructor(e,t){super(),this.isBypassNode=!0,this.outputNode=e,this.callNode=t}getNodeType(e){return this.outputNode.getNodeType(e)}generate(e){const t=this.callNode.build(e,"void");return""!==t&&e.addLineFlowCode(t,this),this.outputNode.build(e)}},Ou2=Oi2(Uu2).setParameterLength(2);ui2("bypass",Ou2);var ku2=class extends js2{static get type(){return"RemapNode"}constructor(e,t,s,i=Ki2(0),r=Ki2(1)){super(),this.node=e,this.inLowNode=t,this.inHighNode=s,this.outLowNode=i,this.outHighNode=r,this.doClamp=!0}setup(){const{node:e,inLowNode:t,inHighNode:s,outLowNode:i,outHighNode:r,doClamp:n}=this;let a=e.sub(t).div(s.sub(t));return!0===n&&(a=a.clamp()),a.mul(r.sub(i)).add(i)}},Gu2=Oi2(ku2,null,null,{doClamp:!1}).setParameterLength(3,5),zu2=Oi2(ku2).setParameterLength(3,5);ui2("remap",Gu2),ui2("remapClamp",zu2);var Hu2=class extends js2{static get type(){return"ExpressionNode"}constructor(e="",t="void"){super(t),this.snippet=e}generate(e,t){const s=this.getNodeType(e),i=this.snippet;if("void"!==s)return e.format(i,s,t);e.addLineFlowCode(i,this)}},$u2=Oi2(Hu2).setParameterLength(1,2),Wu2=e=>(e?Jo2(e,$u2("discard")):$u2("discard")).toStack();ui2("discard",Wu2);var qu2=class extends Ys2{static get type(){return"RenderOutputNode"}constructor(e,t,s){super("vec4"),this.colorNode=e,this.toneMapping=t,this.outputColorSpace=s,this.isRenderOutputNode=!0}setup({context:e}){let t=this.colorNode||e.color;const s=(null!==this.toneMapping?this.toneMapping:e.toneMapping)||$,i=(null!==this.outputColorSpace?this.outputColorSpace:e.outputColorSpace)||Xe;return s!==$&&(t=t.toneMapping(s)),i!==Xe&&i!==ms.workingColorSpace&&(t=t.workingToColorSpace(i)),t}},ju2=(e,t=null,s=null)=>Ii2(new qu2(Ii2(e),t,s));ui2("renderOutput",ju2);var Xu2=class extends Ys2{static get type(){return"DebugNode"}constructor(e,t=null){super(),this.node=e,this.callback=t}getNodeType(e){return this.node.getNodeType(e)}setup(e){return this.node.build(e)}analyze(e){return this.node.build(e)}generate(e){const t=this.callback,s=this.node.build(e),i="--- TSL debug - "+e.shaderStage+" shader ---",r="-".repeat(i.length);let n="";return n+="// #"+i+"#\n",n+=e.flow.code.replace(/^\t/gm,"")+"\n",n+="/* ... */ "+s+" /* ... */\n",n+="// #"+r+"#\n",null!==t?t(e,n):console.log(n),s}},Ku2=(e,t=null)=>Ii2(new Xu2(Ii2(e),t)).toStack();ui2("debug",Ku2);var Yu2=class extends js2{static get type(){return"AttributeNode"}constructor(e,t=null){super(t),this.global=!0,this._attributeName=e}getHash(e){return this.getAttributeName(e)}getNodeType(e){let t=this.nodeType;if(null===t){const s=this.getAttributeName(e);if(e.hasGeometryAttribute(s)){const i=e.geometry.getAttribute(s);t=e.getTypeFromAttribute(i)}else t="float"}return t}setAttributeName(e){return this._attributeName=e,this}getAttributeName(){return this._attributeName}generate(e){const t=this.getAttributeName(e),s=this.getNodeType(e);if(!0===e.hasGeometryAttribute(t)){const i=e.geometry.getAttribute(t),r=e.getTypeFromAttribute(i),n=e.getAttribute(t,r);return"vertex"===e.shaderStage?e.format(n.name,r,s):pu2(this).build(e,s)}return console.warn(`AttributeNode: Vertex attribute "${t}" not found on geometry.`),e.generateConst(s)}serialize(e){super.serialize(e),e.global=this.global,e._attributeName=this._attributeName}deserialize(e){super.deserialize(e),this.global=e.global,this._attributeName=e._attributeName}},Qu2=(e,t=null)=>Ii2(new Yu2(e,t)),Zu2=(e=0)=>Qu2("uv"+(e>0?e:""),"vec2"),Ju=class extends js2{static get type(){return"TextureSizeNode"}constructor(e,t=null){super("uvec2"),this.isTextureSizeNode=!0,this.textureNode=e,this.levelNode=t}generate(e,t){const s=this.textureNode.build(e,"property"),i=null===this.levelNode?"0":this.levelNode.build(e,"int");return e.format(`${e.getMethod("textureDimensions")}( ${s}, ${i} )`,this.getNodeType(e),t)}},el2=Oi2(Ju).setParameterLength(1,2),tl2=class extends ea2{static get type(){return"MaxMipLevelNode"}constructor(e){super(0),this._textureNode=e,this.updateType=Us2.FRAME}get textureNode(){return this._textureNode}get texture(){return this._textureNode.value}update(){const e=this.texture,t=e.images,s=t&&t.length>0?t[0]&&t[0].image||t[0]:e.image;if(s&&void 0!==s.width){const{width:e,height:t}=s;this.value=Math.log2(Math.max(e,t))}}},rl2=Oi2(tl2).setParameterLength(1),sl2=new _s,il2=class extends ea2{static get type(){return"TextureNode"}constructor(e=sl2,t=null,s=null,i=null){super(e),this.isTextureNode=!0,this.uvNode=t,this.levelNode=s,this.biasNode=i,this.compareNode=null,this.depthNode=null,this.gradNode=null,this.sampler=!0,this.updateMatrix=!1,this.updateType=Us2.NONE,this.referenceNode=null,this._value=e,this._matrixUniform=null,this.setUpdateMatrix(null===t)}set value(e){this.referenceNode?this.referenceNode.value=e:this._value=e}get value(){return this.referenceNode?this.referenceNode.value:this._value}getUniformHash(){return this.value.uuid}getNodeType(){return!0===this.value.isDepthTexture?"float":this.value.type===kt?"uvec4":this.value.type===Bt?"ivec4":"vec4"}getInputType(){return"texture"}getDefaultUV(){return Zu2(this.value.channel)}updateReference(){return this.value}getTransformedUV(e){return null===this._matrixUniform&&(this._matrixUniform=ta2(this.value.matrix)),this._matrixUniform.mul(sn2(e,1)).xy}setUpdateMatrix(e){return this.updateMatrix=e,this.updateType=e?Us2.OBJECT:Us2.NONE,this}setupUV(e,t){const s=this.value;return e.isFlipY()&&(s.image instanceof ImageBitmap&&!0===s.flipY||!0===s.isRenderTargetTexture||!0===s.isFramebufferTexture||!0===s.isDepthTexture)&&(t=this.sampler?t.flipY():t.setY(Yi2(el2(this,this.levelNode).y).sub(t.y).sub(1))),t}setup(e){const t=e.getNodeProperties(this);t.referenceNode=this.referenceNode;const s=this.value;if(!s||!0!==s.isTexture)throw new Error("THREE.TSL: `texture( value )` function expects a valid instance of THREE.Texture().");let i=this.uvNode;null!==i&&!0!==e.context.forceUVContext||!e.context.getUV||(i=e.context.getUV(this,e)),i||(i=this.getDefaultUV()),!0===this.updateMatrix&&(i=this.getTransformedUV(i)),i=this.setupUV(e,i);let r=this.levelNode;null===r&&e.context.getTextureLevel&&(r=e.context.getTextureLevel(this)),t.uvNode=i,t.levelNode=r,t.biasNode=this.biasNode,t.compareNode=this.compareNode,t.gradNode=this.gradNode,t.depthNode=this.depthNode}generateUV(e,t){return t.build(e,!0===this.sampler?"vec2":"ivec2")}generateSnippet(e,t,s,i,r,n,a,o){const l=this.value;let h;return h=i?e.generateTextureLevel(l,t,s,i,n):r?e.generateTextureBias(l,t,s,r,n):o?e.generateTextureGrad(l,t,s,o,n):a?e.generateTextureCompare(l,t,s,a,n):!1===this.sampler?e.generateTextureLoad(l,t,s,n):e.generateTexture(l,t,s,n),h}generate(e,t){const s=this.value,i=e.getNodeProperties(this),r=super.generate(e,"property");if(/^sampler/.test(t))return r+"_sampler";if(e.isReference(t))return r;{const n=e.getDataFromNode(this);let a=n.propertyName;if(void 0===a){const{uvNode:t,levelNode:s,biasNode:o,compareNode:l,depthNode:h,gradNode:u}=i,c=this.generateUV(e,t),d=s?s.build(e,"float"):null,p=o?o.build(e,"float"):null,_=h?h.build(e,"int"):null,m=l?l.build(e,"float"):null,f=u?[u[0].build(e,"vec2"),u[1].build(e,"vec2")]:null,g=e.getVarFromNode(this);a=e.getPropertyName(g);const y=this.generateSnippet(e,r,c,d,p,_,m,f);e.addLineFlowCode(`${a} = ${y}`,this),n.snippet=y,n.propertyName=a}let o=a;const l=this.getNodeType(e);return e.needsToWorkingColorSpace(s)&&(o=Tu2($u2(o,l),s.colorSpace).setup(e).build(e,l)),e.format(o,l,t)}}setSampler(e){return this.sampler=e,this}getSampler(){return this.sampler}uv(e){return console.warn("THREE.TextureNode: .uv() has been renamed. Use .sample() instead."),this.sample(e)}sample(e){const t=this.clone();return t.uvNode=Ii2(e),t.referenceNode=this.getSelf(),Ii2(t)}load(e){return this.sample(e).setSampler(!1)}blur(e){const t=this.clone();t.biasNode=Ii2(e).mul(rl2(t)),t.referenceNode=this.getSelf();const s=t.value;return!1===t.generateMipmaps&&(s&&!1===s.generateMipmaps||s.minFilter===gt||s.magFilter===gt)&&(console.warn("THREE.TSL: texture().blur() requires mipmaps and sampling. Use .generateMipmaps=true and .minFilter/.magFilter=THREE.LinearFilter in the Texture."),t.biasNode=null),Ii2(t)}level(e){const t=this.clone();return t.levelNode=Ii2(e),t.referenceNode=this.getSelf(),Ii2(t)}size(e){return el2(this,e)}bias(e){const t=this.clone();return t.biasNode=Ii2(e),t.referenceNode=this.getSelf(),Ii2(t)}compare(e){const t=this.clone();return t.compareNode=Ii2(e),t.referenceNode=this.getSelf(),Ii2(t)}grad(e,t){const s=this.clone();return s.gradNode=[Ii2(e),Ii2(t)],s.referenceNode=this.getSelf(),Ii2(s)}depth(e){const t=this.clone();return t.depthNode=Ii2(e),t.referenceNode=this.getSelf(),Ii2(t)}serialize(e){super.serialize(e),e.value=this.value.toJSON(e.meta).uuid,e.sampler=this.sampler,e.updateMatrix=this.updateMatrix,e.updateType=this.updateType}deserialize(e){super.deserialize(e),this.value=e.meta.textures[e.value],this.sampler=e.sampler,this.updateMatrix=e.updateMatrix,this.updateType=e.updateType}update(){const e=this.value,t=this._matrixUniform;null!==t&&(t.value=e.matrix),!0===e.matrixAutoUpdate&&e.updateMatrix()}clone(){const e=new this.constructor(this.value,this.uvNode,this.levelNode,this.biasNode);return e.sampler=this.sampler,e.depthNode=this.depthNode,e.compareNode=this.compareNode,e.gradNode=this.gradNode,e}},nl2=Oi2(il2).setParameterLength(1,4).setName("texture"),al2=(e=sl2,t=null,s=null,i=null)=>{let r;return e&&!0===e.isTextureNode?(r=Ii2(e.clone()),r.referenceNode=e.getSelf(),null!==t&&(r.uvNode=Ii2(t)),null!==s&&(r.levelNode=Ii2(s)),null!==i&&(r.biasNode=Ii2(i))):r=nl2(e,t,s,i),r},ol2=(...e)=>al2(...e).setSampler(!1),ul2=class extends ea2{static get type(){return"BufferNode"}constructor(e,t,s=0){super(e,t),this.isBufferNode=!0,this.bufferType=t,this.bufferCount=s}getElementType(e){return this.getNodeType(e)}getInputType(){return"buffer"}},ll2=(e,t,s)=>Ii2(new ul2(e,t,s)),dl2=class extends Xs2{static get type(){return"UniformArrayElementNode"}constructor(e,t){super(e,t),this.isArrayBufferElementNode=!0}generate(e){const t=super.generate(e),s=this.getNodeType(),i=this.node.getPaddedType();return e.format(t,i,s)}},cl2=class extends ul2{static get type(){return"UniformArrayNode"}constructor(e,t=null){super(null),this.array=e,this.elementType=null===t?Ps2(e[0]):t,this.paddedType=this.getPaddedType(),this.updateType=Us2.RENDER,this.isArrayBufferNode=!0}getNodeType(){return this.paddedType}getElementType(){return this.elementType}getPaddedType(){const e=this.elementType;let t="vec4";return"mat2"===e?t="mat2":!0===/mat/.test(e)?t="mat4":"i"===e.charAt(0)?t="ivec4":"u"===e.charAt(0)&&(t="uvec4"),t}update(){const{array:e,value:t}=this,s=this.elementType;if("float"===s||"int"===s||"uint"===s)for(let s=0;s<e.length;s++)t[4*s]=e[s];else if("color"===s)for(let s=0;s<e.length;s++){const i=4*s,r=e[s];t[i]=r.r,t[i+1]=r.g,t[i+2]=r.b||0}else if("mat2"===s)for(let s=0;s<e.length;s++){const i=4*s,r=e[s];t[i]=r.elements[0],t[i+1]=r.elements[1],t[i+2]=r.elements[2],t[i+3]=r.elements[3]}else if("mat3"===s)for(let s=0;s<e.length;s++){const i=16*s,r=e[s];t[i]=r.elements[0],t[i+1]=r.elements[1],t[i+2]=r.elements[2],t[i+4]=r.elements[3],t[i+5]=r.elements[4],t[i+6]=r.elements[5],t[i+8]=r.elements[6],t[i+9]=r.elements[7],t[i+10]=r.elements[8],t[i+15]=1}else if("mat4"===s)for(let s=0;s<e.length;s++){const i=16*s,r=e[s];for(let e=0;e<r.elements.length;e++)t[i+e]=r.elements[e]}else for(let s=0;s<e.length;s++){const i=4*s,r=e[s];t[i]=r.x,t[i+1]=r.y,t[i+2]=r.z||0,t[i+3]=r.w||0}}setup(e){const t=this.array.length,s=this.elementType;let i=Float32Array;const r=this.paddedType,n=e.getTypeLength(r);return"i"===s.charAt(0)&&(i=Int32Array),"u"===s.charAt(0)&&(i=Uint32Array),this.value=new i(t*n),this.bufferCount=t,this.bufferType=r,super.setup(e)}element(e){return Ii2(new dl2(this,Ii2(e)))}},hl2=(e,t)=>Ii2(new cl2(e,t)),pl2=Oi2(class extends js2{constructor(e){super("float"),this.name=e,this.isBuiltinNode=!0}generate(){return this.name}}).setParameterLength(1),gl2=ta2(0,"uint").setName("u_cameraIndex").setGroup(Yn2("cameraIndex")).toVarying("v_cameraIndex"),ml2=ta2("float").setName("cameraNear").setGroup(Zn2).onRenderUpdate(({camera:e})=>e.near),fl2=ta2("float").setName("cameraFar").setGroup(Zn2).onRenderUpdate(({camera:e})=>e.far),yl2=Hi2(({camera:e})=>{let t;if(e.isArrayCamera&&e.cameras.length>0){const s=[];for(const t of e.cameras)s.push(t.projectionMatrix);t=hl2(s).setGroup(Zn2).setName("cameraProjectionMatrices").element(e.isMultiViewCamera?pl2("gl_ViewID_OVR"):gl2).toVar("cameraProjectionMatrix")}else t=ta2("mat4").setName("cameraProjectionMatrix").setGroup(Zn2).onRenderUpdate(({camera:e})=>e.projectionMatrix);return t}).once()(),bl2=Hi2(({camera:e})=>{let t;if(e.isArrayCamera&&e.cameras.length>0){const s=[];for(const t of e.cameras)s.push(t.projectionMatrixInverse);t=hl2(s).setGroup(Zn2).setName("cameraProjectionMatricesInverse").element(e.isMultiViewCamera?pl2("gl_ViewID_OVR"):gl2).toVar("cameraProjectionMatrixInverse")}else t=ta2("mat4").setName("cameraProjectionMatrixInverse").setGroup(Zn2).onRenderUpdate(({camera:e})=>e.projectionMatrixInverse);return t}).once()(),xl2=Hi2(({camera:e})=>{let t;if(e.isArrayCamera&&e.cameras.length>0){const s=[];for(const t of e.cameras)s.push(t.matrixWorldInverse);t=hl2(s).setGroup(Zn2).setName("cameraViewMatrices").element(e.isMultiViewCamera?pl2("gl_ViewID_OVR"):gl2).toVar("cameraViewMatrix")}else t=ta2("mat4").setName("cameraViewMatrix").setGroup(Zn2).onRenderUpdate(({camera:e})=>e.matrixWorldInverse);return t}).once()(),Tl2=ta2("mat4").setName("cameraWorldMatrix").setGroup(Zn2).onRenderUpdate(({camera:e})=>e.matrixWorld),_l2=ta2("mat3").setName("cameraNormalMatrix").setGroup(Zn2).onRenderUpdate(({camera:e})=>e.normalMatrix),vl2=ta2(new Qi).setName("cameraPosition").setGroup(Zn2).onRenderUpdate(({camera:e},t)=>t.value.setFromMatrixPosition(e.matrixWorld)),Nl2=new Gs,Sl2=class e extends js2{static get type(){return"Object3DNode"}constructor(e,t=null){super(),this.scope=e,this.object3d=t,this.updateType=Us2.OBJECT,this.uniformNode=new ea2(null)}getNodeType(){const t=this.scope;return t===e.WORLD_MATRIX?"mat4":t===e.POSITION||t===e.VIEW_POSITION||t===e.DIRECTION||t===e.SCALE?"vec3":t===e.RADIUS?"float":void 0}update(t){const s=this.object3d,i=this.uniformNode,r=this.scope;if(r===e.WORLD_MATRIX)i.value=s.matrixWorld;else if(r===e.POSITION)i.value=i.value||new Qi,i.value.setFromMatrixPosition(s.matrixWorld);else if(r===e.SCALE)i.value=i.value||new Qi,i.value.setFromMatrixScale(s.matrixWorld);else if(r===e.DIRECTION)i.value=i.value||new Qi,s.getWorldDirection(i.value);else if(r===e.VIEW_POSITION){const e=t.camera;i.value=i.value||new Qi,i.value.setFromMatrixPosition(s.matrixWorld),i.value.applyMatrix4(e.matrixWorldInverse)}else if(r===e.RADIUS){const e=t.object.geometry;null===e.boundingSphere&&e.computeBoundingSphere(),Nl2.copy(e.boundingSphere).applyMatrix4(s.matrixWorld),i.value=Nl2.radius}}generate(t){const s=this.scope;return s===e.WORLD_MATRIX?this.uniformNode.nodeType="mat4":s===e.POSITION||s===e.VIEW_POSITION||s===e.DIRECTION||s===e.SCALE?this.uniformNode.nodeType="vec3":s===e.RADIUS&&(this.uniformNode.nodeType="float"),this.uniformNode.build(t)}serialize(e){super.serialize(e),e.scope=this.scope}deserialize(e){super.deserialize(e),this.scope=e.scope}};Sl2.WORLD_MATRIX="worldMatrix",Sl2.POSITION="position",Sl2.SCALE="scale",Sl2.VIEW_POSITION="viewPosition",Sl2.DIRECTION="direction",Sl2.RADIUS="radius";var El2=Oi2(Sl2,Sl2.DIRECTION).setParameterLength(1),wl2=Oi2(Sl2,Sl2.WORLD_MATRIX).setParameterLength(1),Al2=Oi2(Sl2,Sl2.POSITION).setParameterLength(1),Rl2=Oi2(Sl2,Sl2.SCALE).setParameterLength(1),Cl2=Oi2(Sl2,Sl2.VIEW_POSITION).setParameterLength(1),Ml2=Oi2(Sl2,Sl2.RADIUS).setParameterLength(1),Pl2=class extends Sl2{static get type(){return"ModelNode"}constructor(e){super(e)}update(e){this.object3d=e.object,super.update(e)}},Bl2=ki2(Pl2,Pl2.DIRECTION),Ll2=ki2(Pl2,Pl2.WORLD_MATRIX),Fl2=ki2(Pl2,Pl2.POSITION),Il2=ki2(Pl2,Pl2.SCALE),Dl2=ki2(Pl2,Pl2.VIEW_POSITION),Vl2=ki2(Pl2,Pl2.RADIUS),Ul2=ta2(new es).onObjectUpdate(({object:e},t)=>t.value.getNormalMatrix(e.matrixWorld)),Ol2=ta2(new nr).onObjectUpdate(({object:e},t)=>t.value.copy(e.matrixWorld).invert()),kl2=Hi2(e=>e.renderer.overrideNodes.modelViewMatrix||Gl2).once()().toVar("modelViewMatrix"),Gl2=xl2.mul(Ll2),zl2=Hi2(e=>(e.context.isHighPrecisionModelViewMatrix=!0,ta2("mat4").onObjectUpdate(({object:e,camera:t})=>e.modelViewMatrix.multiplyMatrices(t.matrixWorldInverse,e.matrixWorld)))).once()().toVar("highpModelViewMatrix"),Hl2=Hi2(e=>{const t=e.context.isHighPrecisionModelViewMatrix;return ta2("mat3").onObjectUpdate(({object:e,camera:s})=>(!0!==t&&e.modelViewMatrix.multiplyMatrices(s.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix)))}).once()().toVar("highpModelNormalViewMatrix"),$l2=Qu2("position","vec3"),Wl2=$l2.toVarying("positionLocal"),ql2=$l2.toVarying("positionPrevious"),jl2=Hi2(e=>Ll2.mul(Wl2).xyz.toVarying(e.getSubBuildProperty("v_positionWorld")),"vec3").once(["POSITION"])(),Xl2=Hi2(()=>Wl2.transformDirection(Ll2).toVarying("v_positionWorldDirection").normalize().toVar("positionWorldDirection"),"vec3").once(["POSITION"])(),Kl2=Hi2(e=>e.context.setupPositionView().toVarying("v_positionView"),"vec3").once(["POSITION"])(),Yl2=Kl2.negate().toVarying("v_positionViewDirection").normalize().toVar("positionViewDirection"),Ql2=class extends js2{static get type(){return"FrontFacingNode"}constructor(){super("bool"),this.isFrontFacingNode=!0}generate(e){if("fragment"!==e.shaderStage)return"true";const{renderer:t,material:s}=e;return t.coordinateSystem===Ri&&s.side===d2?"false":e.getFrontFacing()}},Zl2=ki2(Ql2),Jl2=Ki2(Zl2).mul(2).sub(1),ed2=Hi2(([e],{material:t})=>{const s=t.side;return s===d2?e=e.mul(-1):s===p&&(e=e.mul(Jl2)),e}),td2=Qu2("normal","vec3"),rd2=Hi2(e=>!1===e.geometry.hasAttribute("normal")?(console.warn('THREE.TSL: Vertex attribute "normal" not found on geometry.'),sn2(0,1,0)):td2,"vec3").once()().toVar("normalLocal"),sd2=Kl2.dFdx().cross(Kl2.dFdy()).normalize().toVar("normalFlat"),id2=Hi2(e=>{let t;return t=!0===e.material.flatShading?sd2:dd(rd2).toVarying("v_normalViewGeometry").normalize(),t},"vec3").once()().toVar("normalViewGeometry"),nd2=Hi2(e=>{let t=id2.transformDirection(xl2);return!0!==e.material.flatShading&&(t=t.toVarying("v_normalWorldGeometry")),t.normalize().toVar("normalWorldGeometry")},"vec3").once()(),ad2=Hi2(({subBuildFn:e,material:t,context:s})=>{let i;return"NORMAL"===e||"VERTEX"===e?(i=id2,!0!==t.flatShading&&(i=ed2(i))):i=s.setupNormal().context({getUV:null}),i},"vec3").once(["NORMAL","VERTEX"])().toVar("normalView"),od2=ad2.transformDirection(xl2).toVar("normalWorld"),ud2=Hi2(({subBuildFn:e,context:t})=>{let s;return s="NORMAL"===e||"VERTEX"===e?ad2:t.setupClearcoatNormal().context({getUV:null}),s},"vec3").once(["NORMAL","VERTEX"])().toVar("clearcoatNormalView"),ld2=Hi2(([e,t=Ll2])=>{const s=pn2(t),i=e.div(sn2(s[0].dot(s[0]),s[1].dot(s[1]),s[2].dot(s[2])));return s.mul(i).xyz}),dd=Hi2(([e],t)=>{const s=t.renderer.overrideNodes.modelNormalViewMatrix;if(null!==s)return s.transformDirection(e);const i=Ul2.mul(e);return xl2.transformDirection(i)}),cd2=Hi2(()=>(console.warn('THREE.TSL: "transformedNormalView" is deprecated. Use "normalView" instead.'),ad2)).once(["NORMAL","VERTEX"])(),hd2=Hi2(()=>(console.warn('THREE.TSL: "transformedNormalWorld" is deprecated. Use "normalWorld" instead.'),od2)).once(["NORMAL","VERTEX"])(),pd2=Hi2(()=>(console.warn('THREE.TSL: "transformedClearcoatNormalView" is deprecated. Use "clearcoatNormalView" instead.'),ud2)).once(["NORMAL","VERTEX"])(),gd2=new yr,md2=new nr,fd2=ta2(0).onReference(({material:e})=>e).onObjectUpdate(({material:e})=>e.refractionRatio),yd2=ta2(1).onReference(({material:e})=>e).onObjectUpdate(function({material:e,scene:t}){return e.envMap?e.envMapIntensity:t.environmentIntensity}),bd2=ta2(new nr).onReference(function(e){return e.material}).onObjectUpdate(function({material:e,scene:t}){const s=null!==t.environment&&null===e.envMap?t.environmentRotation:e.envMapRotation;return s?(gd2.copy(s),md2.makeRotationFromEuler(gd2)):md2.identity(),md2}),xd2=Yl2.negate().reflect(ad2),Td2=Yl2.negate().refract(ad2,fd2),_d2=xd2.transformDirection(xl2).toVar("reflectVector"),vd2=Td2.transformDirection(xl2).toVar("reflectVector"),Nd2=new ea,Sd2=class extends il2{static get type(){return"CubeTextureNode"}constructor(e,t=null,s=null,i=null){super(e,t,s,i),this.isCubeTextureNode=!0}getInputType(){return"cubeTexture"}getDefaultUV(){const e=this.value;return e.mapping===ht?_d2:e.mapping===lt?vd2:(console.error('THREE.CubeTextureNode: Mapping "%s" not supported.',e.mapping),sn2(0,0,0))}setUpdateMatrix(){}setupUV(e,t){const s=this.value;return e.renderer.coordinateSystem!==Pi&&s.isRenderTargetTexture||(t=sn2(t.x.negate(),t.yz)),bd2.mul(t)}generateUV(e,t){return t.build(e,"vec3")}},Ed2=Oi2(Sd2).setParameterLength(1,4).setName("cubeTexture"),wd2=(e=Nd2,t=null,s=null,i=null)=>{let r;return e&&!0===e.isCubeTextureNode?(r=Ii2(e.clone()),r.referenceNode=e.getSelf(),null!==t&&(r.uvNode=Ii2(t)),null!==s&&(r.levelNode=Ii2(s)),null!==i&&(r.biasNode=Ii2(i))):r=Ed2(e,t,s,i),r},Ad2=class extends Xs2{static get type(){return"ReferenceElementNode"}constructor(e,t){super(e,t),this.referenceNode=e,this.isReferenceElementNode=!0}getNodeType(){return this.referenceNode.uniformType}generate(e){const t=super.generate(e),s=this.referenceNode.getNodeType(),i=this.getNodeType();return e.format(t,s,i)}},Rd=class extends js2{static get type(){return"ReferenceNode"}constructor(e,t,s=null,i=null){super(),this.property=e,this.uniformType=t,this.object=s,this.count=i,this.properties=e.split("."),this.reference=s,this.node=null,this.group=null,this.name=null,this.updateType=Us2.OBJECT}element(e){return Ii2(new Ad2(this,Ii2(e)))}setGroup(e){return this.group=e,this}setName(e){return this.name=e,this}label(e){return console.warn('THREE.TSL: "label()" has been deprecated. Use "setName()" instead.'),this.setName(e)}setNodeType(e){let t=null;t=null!==this.count?ll2(null,e,this.count):Array.isArray(this.getValueFromReference())?hl2(null,e):"texture"===e?al2(null):"cubeTexture"===e?wd2(null):ta2(null,e),null!==this.group&&t.setGroup(this.group),null!==this.name&&t.setName(this.name),this.node=t.getSelf()}getNodeType(e){return null===this.node&&(this.updateReference(e),this.updateValue()),this.node.getNodeType(e)}getValueFromReference(e=this.reference){const{properties:t}=this;let s=e[t[0]];for(let e=1;e<t.length;e++)s=s[t[e]];return s}updateReference(e){return this.reference=null!==this.object?this.object:e.object,this.reference}setup(){return this.updateValue(),this.node}update(){this.updateValue()}updateValue(){null===this.node&&this.setNodeType(this.uniformType);const e=this.getValueFromReference();Array.isArray(e)?this.node.array=e:this.node.value=e}},Cd2=(e,t,s)=>Ii2(new Rd(e,t,s)),Md2=(e,t,s,i)=>Ii2(new Rd(e,t,i,s)),Pd=class extends Rd{static get type(){return"MaterialReferenceNode"}constructor(e,t,s=null){super(e,t,s),this.material=s,this.isMaterialReferenceNode=!0}updateReference(e){return this.reference=null!==this.material?this.material:e.material,this.reference}},Bd2=(e,t,s=null)=>Ii2(new Pd(e,t,s)),Ld=Zu2(),Fd2=Kl2.dFdx(),Id2=Kl2.dFdy(),Dd=Ld.dFdx(),Vd2=Ld.dFdy(),Ud=ad2,Od2=Id2.cross(Ud),kd2=Ud.cross(Fd2),Gd=Od2.mul(Dd.x).add(kd2.mul(Vd2.x)),zd=Od2.mul(Dd.y).add(kd2.mul(Vd2.y)),Hd=Gd.dot(Gd).max(zd.dot(zd)),$d=Hd.equal(0).select(0,Hd.inverseSqrt()),Wd=Gd.mul($d).toVar("tangentViewFrame"),qd=zd.mul($d).toVar("bitangentViewFrame"),jd2=Hi2(e=>(!1===e.geometry.hasAttribute("tangent")&&e.geometry.computeTangents(),Qu2("tangent","vec4")))(),Xd=jd2.xyz.toVar("tangentLocal"),Kd=Hi2(({subBuildFn:e,geometry:t,material:s})=>{let i;return i="VERTEX"===e||t.hasAttribute("tangent")?kl2.mul(un2(Xd,0)).xyz.toVarying("v_tangentView").normalize():Wd,!0!==s.flatShading&&(i=ed2(i)),i},"vec3").once(["NORMAL","VERTEX"])().toVar("tangentView"),Yd=Kd.transformDirection(xl2).toVarying("v_tangentWorld").normalize().toVar("tangentWorld"),Qd=Hi2(([e,t],{subBuildFn:s,material:i})=>{let r=e.mul(jd2.w).xyz;return"NORMAL"===s&&!0!==i.flatShading&&(r=r.toVarying(t)),r}).once(["NORMAL"]),Zd=Qd(td2.cross(jd2),"v_bitangentGeometry").normalize().toVar("bitangentGeometry"),Jd=Qd(rd2.cross(Xd),"v_bitangentLocal").normalize().toVar("bitangentLocal"),ec2=Hi2(({subBuildFn:e,geometry:t,material:s})=>{let i;return i="VERTEX"===e||t.hasAttribute("tangent")?Qd(ad2.cross(Kd),"v_bitangentView").normalize():qd,!0!==s.flatShading&&(i=ed2(i)),i},"vec3").once(["NORMAL","VERTEX"])().toVar("bitangentView"),tc2=Qd(od2.cross(Yd),"v_bitangentWorld").normalize().toVar("bitangentWorld"),rc2=pn2(Kd,ec2,ad2).toVar("TBNViewMatrix"),sc2=Yl2.mul(rc2),ic2=Hi2(()=>{let e=Fn2.cross(Yl2);return e=e.cross(Fn2).normalize(),e=Oo2(e,ad2,Bn2.mul(vn2.oneMinus()).oneMinus().pow2().pow2()).normalize(),e}).once()(),nc2=class extends Ys2{static get type(){return"NormalMapNode"}constructor(e,t=null){super("vec3"),this.node=e,this.scaleNode=t,this.normalMapType=qe}setup({material:e}){const{normalMapType:t,scaleNode:s}=this;let i=this.node.mul(2).sub(1);if(null!==s){let t=s;!0===e.flatShading&&(t=ed2(t)),i=sn2(i.xy.mul(t),i.z)}let r=null;return t===Je?r=dd(i):t===qe?r=rc2.mul(i).normalize():(console.error(`THREE.NodeMaterial: Unsupported normal map type: ${t}`),r=ad2),r}},ac2=Oi2(nc2).setParameterLength(1,2),oc2=Hi2(({textureNode:e,bumpScale:t})=>{const s=t=>e.cache().context({getUV:e=>t(e.uvNode||Zu2()),forceUVContext:!0}),i=Ki2(s(e=>e));return Ji2(Ki2(s(e=>e.add(e.dFdx()))).sub(i),Ki2(s(e=>e.add(e.dFdy()))).sub(i)).mul(t)}),uc2=Hi2(e=>{const{surf_pos:t,surf_norm:s,dHdxy:i}=e,r=t.dFdx().normalize(),n=s,a=t.dFdy().normalize().cross(n),o=n.cross(r),l=r.dot(a).mul(Jl2),h=l.sign().mul(i.x.mul(a).add(i.y.mul(o)));return l.abs().mul(s).sub(h).normalize()}),lc2=class extends Ys2{static get type(){return"BumpMapNode"}constructor(e,t=null){super("vec3"),this.textureNode=e,this.scaleNode=t}setup(){const e=null!==this.scaleNode?this.scaleNode:1,t=oc2({textureNode:this.textureNode,bumpScale:e});return uc2({surf_pos:Kl2,surf_norm:ad2,dHdxy:t})}},dc2=Oi2(lc2).setParameterLength(1,2),cc2=new Map,hc2=class e extends js2{static get type(){return"MaterialNode"}constructor(e){super(),this.scope=e}getCache(e,t){let s=cc2.get(e);return void 0===s&&(s=Bd2(e,t),cc2.set(e,s)),s}getFloat(e){return this.getCache(e,"float")}getColor(e){return this.getCache(e,"color")}getTexture(e){return this.getCache("map"===e?"map":e+"Map","texture")}setup(t){const s=t.context.material,i=this.scope;let r=null;if(i===e.COLOR){const e=void 0!==s.color?this.getColor(i):sn2();r=s.map&&!0===s.map.isTexture?e.mul(this.getTexture("map")):e}else if(i===e.OPACITY){const e=this.getFloat(i);r=s.alphaMap&&!0===s.alphaMap.isTexture?e.mul(this.getTexture("alpha")):e}else if(i===e.SPECULAR_STRENGTH)r=s.specularMap&&!0===s.specularMap.isTexture?this.getTexture("specular").r:Ki2(1);else if(i===e.SPECULAR_INTENSITY){const e=this.getFloat(i);r=s.specularIntensityMap&&!0===s.specularIntensityMap.isTexture?e.mul(this.getTexture(i).a):e}else if(i===e.SPECULAR_COLOR){const e=this.getColor(i);r=s.specularColorMap&&!0===s.specularColorMap.isTexture?e.mul(this.getTexture(i).rgb):e}else if(i===e.ROUGHNESS){const e=this.getFloat(i);r=s.roughnessMap&&!0===s.roughnessMap.isTexture?e.mul(this.getTexture(i).g):e}else if(i===e.METALNESS){const e=this.getFloat(i);r=s.metalnessMap&&!0===s.metalnessMap.isTexture?e.mul(this.getTexture(i).b):e}else if(i===e.EMISSIVE){const e=this.getFloat("emissiveIntensity"),t=this.getColor(i).mul(e);r=s.emissiveMap&&!0===s.emissiveMap.isTexture?t.mul(this.getTexture(i)):t}else if(i===e.NORMAL)s.normalMap?(r=ac2(this.getTexture("normal"),this.getCache("normalScale","vec2")),r.normalMapType=s.normalMapType):r=s.bumpMap?dc2(this.getTexture("bump").r,this.getFloat("bumpScale")):ad2;else if(i===e.CLEARCOAT){const e=this.getFloat(i);r=s.clearcoatMap&&!0===s.clearcoatMap.isTexture?e.mul(this.getTexture(i).r):e}else if(i===e.CLEARCOAT_ROUGHNESS){const e=this.getFloat(i);r=s.clearcoatRoughnessMap&&!0===s.clearcoatRoughnessMap.isTexture?e.mul(this.getTexture(i).r):e}else if(i===e.CLEARCOAT_NORMAL)r=s.clearcoatNormalMap?ac2(this.getTexture(i),this.getCache(i+"Scale","vec2")):ad2;else if(i===e.SHEEN){const e=this.getColor("sheenColor").mul(this.getFloat("sheen"));r=s.sheenColorMap&&!0===s.sheenColorMap.isTexture?e.mul(this.getTexture("sheenColor").rgb):e}else if(i===e.SHEEN_ROUGHNESS){const e=this.getFloat(i);r=s.sheenRoughnessMap&&!0===s.sheenRoughnessMap.isTexture?e.mul(this.getTexture(i).a):e,r=r.clamp(.07,1)}else if(i===e.ANISOTROPY)if(s.anisotropyMap&&!0===s.anisotropyMap.isTexture){const e=this.getTexture(i);r=hn2(Yc2.x,Yc2.y,Yc2.y.negate(),Yc2.x).mul(e.rg.mul(2).sub(Ji2(1)).normalize().mul(e.b))}else r=Yc2;else if(i===e.IRIDESCENCE_THICKNESS){const e=Cd2("1","float",s.iridescenceThicknessRange);if(s.iridescenceThicknessMap){const t=Cd2("0","float",s.iridescenceThicknessRange);r=e.sub(t).mul(this.getTexture(i).g).add(t)}else r=e}else if(i===e.TRANSMISSION){const e=this.getFloat(i);r=s.transmissionMap?e.mul(this.getTexture(i).r):e}else if(i===e.THICKNESS){const e=this.getFloat(i);r=s.thicknessMap?e.mul(this.getTexture(i).g):e}else if(i===e.IOR)r=this.getFloat(i);else if(i===e.LIGHT_MAP)r=this.getTexture(i).rgb.mul(this.getFloat("lightMapIntensity"));else if(i===e.AO)r=this.getTexture(i).r.sub(1).mul(this.getFloat("aoMapIntensity")).add(1);else if(i===e.LINE_DASH_OFFSET)r=s.dashOffset?this.getFloat(i):Ki2(0);else{const e=this.getNodeType(t);r=this.getCache(i,e)}return r}};hc2.ALPHA_TEST="alphaTest",hc2.COLOR="color",hc2.OPACITY="opacity",hc2.SHININESS="shininess",hc2.SPECULAR="specular",hc2.SPECULAR_STRENGTH="specularStrength",hc2.SPECULAR_INTENSITY="specularIntensity",hc2.SPECULAR_COLOR="specularColor",hc2.REFLECTIVITY="reflectivity",hc2.ROUGHNESS="roughness",hc2.METALNESS="metalness",hc2.NORMAL="normal",hc2.CLEARCOAT="clearcoat",hc2.CLEARCOAT_ROUGHNESS="clearcoatRoughness",hc2.CLEARCOAT_NORMAL="clearcoatNormal",hc2.EMISSIVE="emissive",hc2.ROTATION="rotation",hc2.SHEEN="sheen",hc2.SHEEN_ROUGHNESS="sheenRoughness",hc2.ANISOTROPY="anisotropy",hc2.IRIDESCENCE="iridescence",hc2.IRIDESCENCE_IOR="iridescenceIOR",hc2.IRIDESCENCE_THICKNESS="iridescenceThickness",hc2.IOR="ior",hc2.TRANSMISSION="transmission",hc2.THICKNESS="thickness",hc2.ATTENUATION_DISTANCE="attenuationDistance",hc2.ATTENUATION_COLOR="attenuationColor",hc2.LINE_SCALE="scale",hc2.LINE_DASH_SIZE="dashSize",hc2.LINE_GAP_SIZE="gapSize",hc2.LINE_WIDTH="linewidth",hc2.LINE_DASH_OFFSET="dashOffset",hc2.POINT_SIZE="size",hc2.DISPERSION="dispersion",hc2.LIGHT_MAP="light",hc2.AO="ao";var pc2=ki2(hc2,hc2.ALPHA_TEST),gc2=ki2(hc2,hc2.COLOR),mc2=ki2(hc2,hc2.SHININESS),fc2=ki2(hc2,hc2.EMISSIVE),yc2=ki2(hc2,hc2.OPACITY),bc2=ki2(hc2,hc2.SPECULAR),xc2=ki2(hc2,hc2.SPECULAR_INTENSITY),Tc2=ki2(hc2,hc2.SPECULAR_COLOR),_c2=ki2(hc2,hc2.SPECULAR_STRENGTH),vc2=ki2(hc2,hc2.REFLECTIVITY),Nc2=ki2(hc2,hc2.ROUGHNESS),Sc2=ki2(hc2,hc2.METALNESS),Ec2=ki2(hc2,hc2.NORMAL),wc2=ki2(hc2,hc2.CLEARCOAT),Ac2=ki2(hc2,hc2.CLEARCOAT_ROUGHNESS),Rc2=ki2(hc2,hc2.CLEARCOAT_NORMAL),Cc2=ki2(hc2,hc2.ROTATION),Mc2=ki2(hc2,hc2.SHEEN),Pc2=ki2(hc2,hc2.SHEEN_ROUGHNESS),Bc2=ki2(hc2,hc2.ANISOTROPY),Lc2=ki2(hc2,hc2.IRIDESCENCE),Fc2=ki2(hc2,hc2.IRIDESCENCE_IOR),Ic2=ki2(hc2,hc2.IRIDESCENCE_THICKNESS),Dc2=ki2(hc2,hc2.TRANSMISSION),Vc2=ki2(hc2,hc2.THICKNESS),Uc2=ki2(hc2,hc2.IOR),Oc2=ki2(hc2,hc2.ATTENUATION_DISTANCE),kc2=ki2(hc2,hc2.ATTENUATION_COLOR),Gc=ki2(hc2,hc2.LINE_SCALE),zc2=ki2(hc2,hc2.LINE_DASH_SIZE),Hc2=ki2(hc2,hc2.LINE_GAP_SIZE),$c=ki2(hc2,hc2.LINE_WIDTH),Wc2=ki2(hc2,hc2.LINE_DASH_OFFSET),qc2=ki2(hc2,hc2.POINT_SIZE),jc2=ki2(hc2,hc2.DISPERSION),Xc2=ki2(hc2,hc2.LIGHT_MAP),Kc2=ki2(hc2,hc2.AO),Yc2=ta2(new Gi).onReference(function(e){return e.material}).onRenderUpdate(function({material:e}){this.value.set(e.anisotropy*Math.cos(e.anisotropyRotation),e.anisotropy*Math.sin(e.anisotropyRotation))}),Qc=Hi2(e=>e.context.setupModelViewProjection(),"vec4").once()().toVarying("v_modelViewProjection"),Zc2=class e extends js2{static get type(){return"IndexNode"}constructor(e){super("uint"),this.scope=e,this.isIndexNode=!0}generate(t){const s=this.getNodeType(t),i=this.scope;let r,n;if(i===e.VERTEX)r=t.getVertexIndex();else if(i===e.INSTANCE)r=t.getInstanceIndex();else if(i===e.DRAW)r=t.getDrawIndex();else if(i===e.INVOCATION_LOCAL)r=t.getInvocationLocalIndex();else if(i===e.INVOCATION_SUBGROUP)r=t.getInvocationSubgroupIndex();else{if(i!==e.SUBGROUP)throw new Error("THREE.IndexNode: Unknown scope: "+i);r=t.getSubgroupIndex()}return n="vertex"===t.shaderStage||"compute"===t.shaderStage?r:pu2(this).build(t,s),n}};Zc2.VERTEX="vertex",Zc2.INSTANCE="instance",Zc2.SUBGROUP="subgroup",Zc2.INVOCATION_LOCAL="invocationLocal",Zc2.INVOCATION_SUBGROUP="invocationSubgroup",Zc2.DRAW="draw";var Jc2=ki2(Zc2,Zc2.VERTEX),eh2=ki2(Zc2,Zc2.INSTANCE),th2=ki2(Zc2,Zc2.SUBGROUP),rh2=ki2(Zc2,Zc2.INVOCATION_SUBGROUP),sh2=ki2(Zc2,Zc2.INVOCATION_LOCAL),ih2=ki2(Zc2,Zc2.DRAW),nh2=class extends js2{static get type(){return"InstanceNode"}constructor(e,t,s=null){super("void"),this.count=e,this.instanceMatrix=t,this.instanceColor=s,this.instanceMatrixNode=null,this.instanceColorNode=null,this.updateType=Us2.FRAME,this.buffer=null,this.bufferColor=null}setup(e){const{count:t,instanceMatrix:s,instanceColor:i}=this;let{instanceMatrixNode:r,instanceColorNode:n}=this;if(null===r){if(t<=1e3)r=ll2(s.array,"mat4",Math.max(t,1)).element(eh2);else{const e=new Lu(s.array,16,1);this.buffer=e;const t=s.usage===Si?Bu2:Pu2,i=[t(e,"vec4",16,0),t(e,"vec4",16,4),t(e,"vec4",16,8),t(e,"vec4",16,12)];r=gn2(...i)}this.instanceMatrixNode=r}if(i&&null===n){const e=new Ja(i.array,3),t=i.usage===Si?Bu2:Pu2;this.bufferColor=e,n=sn2(t(e,"vec3",3,0)),this.instanceColorNode=n}const a=r.mul(Wl2).xyz;if(Wl2.assign(a),e.hasGeometryAttribute("normal")){const e=ld2(rd2,r);rd2.assign(e)}null!==this.instanceColorNode&&xn2("vec3","vInstanceColor").assign(this.instanceColorNode)}update(){this.instanceMatrix.usage!==Si&&null!==this.buffer&&this.instanceMatrix.version!==this.buffer.version&&(this.buffer.version=this.instanceMatrix.version),this.instanceColor&&this.instanceColor.usage!==Si&&null!==this.bufferColor&&this.instanceColor.version!==this.bufferColor.version&&(this.bufferColor.version=this.instanceColor.version)}},ah2=Oi2(nh2).setParameterLength(2,3),oh2=class extends nh2{static get type(){return"InstancedMeshNode"}constructor(e){const{count:t,instanceMatrix:s,instanceColor:i}=e;super(t,s,i),this.instancedMesh=e}},uh2=Oi2(oh2).setParameterLength(1),lh2=class extends js2{static get type(){return"BatchNode"}constructor(e){super("void"),this.batchMesh=e,this.batchingIdNode=null}setup(e){null===this.batchingIdNode&&(null===e.getDrawIndex()?this.batchingIdNode=eh2:this.batchingIdNode=ih2);const t=Hi2(([e])=>{const t=Yi2(el2(ol2(this.batchMesh._indirectTexture),0).x),s=Yi2(e).mod(t),i=Yi2(e).div(t);return ol2(this.batchMesh._indirectTexture,en2(s,i)).x}).setLayout({name:"getIndirectIndex",type:"uint",inputs:[{name:"id",type:"int"}]})(Yi2(this.batchingIdNode)),s=this.batchMesh._matricesTexture,i=Yi2(el2(ol2(s),0).x),r=Ki2(t).mul(4).toInt().toVar(),n=r.mod(i),a=r.div(i),o=gn2(ol2(s,en2(n,a)),ol2(s,en2(n.add(1),a)),ol2(s,en2(n.add(2),a)),ol2(s,en2(n.add(3),a))),l=this.batchMesh._colorsTexture;if(null!==l){const e=Hi2(([e])=>{const t=Yi2(el2(ol2(l),0).x),s=e,i=s.mod(t),r=s.div(t);return ol2(l,en2(i,r)).rgb}).setLayout({name:"getBatchingColor",type:"vec3",inputs:[{name:"id",type:"int"}]})(t);xn2("vec3","vBatchColor").assign(e)}const h=pn2(o);Wl2.assign(o.mul(Wl2));const u=rd2.div(sn2(h[0].dot(h[0]),h[1].dot(h[1]),h[2].dot(h[2]))),c=h.mul(u).xyz;rd2.assign(c),e.hasGeometryAttribute("tangent")&&Xd.mulAssign(h)}},dh2=Oi2(lh2).setParameterLength(1),ch2=class extends Xs2{static get type(){return"StorageArrayElementNode"}constructor(e,t){super(e,t),this.isStorageArrayElementNode=!0}set storageBufferNode(e){this.node=e}get storageBufferNode(){return this.node}getMemberType(e,t){const s=this.storageBufferNode.structTypeNode;return s?s.getMemberType(e,t):"void"}setup(e){return!1===e.isAvailable("storageBuffer")&&!0===this.node.isPBO&&e.setupPBO(this.node),super.setup(e)}generate(e,t){let s;const i=e.context.assign;if(s=!1===e.isAvailable("storageBuffer")?!0!==this.node.isPBO||!0===i||!this.node.value.isInstancedBufferAttribute&&"compute"===e.shaderStage?this.node.build(e):e.generatePBO(this):super.generate(e),!0!==i){const i=this.getNodeType(e);s=e.format(s,i,t)}return s}},hh2=Oi2(ch2).setParameterLength(2),ph2=class extends ul2{static get type(){return"StorageBufferNode"}constructor(e,t=null,s=0){let i,r=null;t&&t.isStruct?(i="struct",r=t.layout,(e.isStorageBufferAttribute||e.isStorageInstancedBufferAttribute)&&(s=e.count)):null===t&&(e.isStorageBufferAttribute||e.isStorageInstancedBufferAttribute)?(i=ws2(e.itemSize),s=e.count):i=t,super(e,i,s),this.isStorageBufferNode=!0,this.structTypeNode=r,this.access=ks2.READ_WRITE,this.isAtomic=!1,this.isPBO=!1,this._attribute=null,this._varying=null,this.global=!0,!0!==e.isStorageBufferAttribute&&!0!==e.isStorageInstancedBufferAttribute&&(e.isInstancedBufferAttribute?e.isStorageInstancedBufferAttribute=!0:e.isStorageBufferAttribute=!0)}getHash(e){if(0===this.bufferCount){let t=e.globalCache.getData(this.value);return void 0===t&&(t={node:this},e.globalCache.setData(this.value,t)),t.node.uuid}return this.uuid}getInputType(){return this.value.isIndirectStorageBufferAttribute?"indirectStorageBuffer":"storageBuffer"}element(e){return hh2(this,e)}setPBO(e){return this.isPBO=e,this}getPBO(){return this.isPBO}setAccess(e){return this.access=e,this}toReadOnly(){return this.setAccess(ks2.READ_ONLY)}setAtomic(e){return this.isAtomic=e,this}toAtomic(){return this.setAtomic(!0)}getAttributeData(){return null===this._attribute&&(this._attribute=Cu2(this.value),this._varying=pu2(this._attribute)),{attribute:this._attribute,varying:this._varying}}getNodeType(e){if(null!==this.structTypeNode)return this.structTypeNode.getNodeType(e);if(e.isAvailable("storageBuffer")||e.isAvailable("indirectStorageBuffer"))return super.getNodeType(e);const{attribute:t}=this.getAttributeData();return t.getNodeType(e)}getMemberType(e,t){return null!==this.structTypeNode?this.structTypeNode.getMemberType(e,t):"void"}generate(e){if(null!==this.structTypeNode&&this.structTypeNode.build(e),e.isAvailable("storageBuffer")||e.isAvailable("indirectStorageBuffer"))return super.generate(e);const{attribute:t,varying:s}=this.getAttributeData(),i=s.build(e);return e.registerTransform(i,t),i}},gh2=(e,t=null,s=0)=>Ii2(new ph2(e,t,s)),mh2=new WeakMap,fh2=class extends js2{static get type(){return"SkinningNode"}constructor(e){super("void"),this.skinnedMesh=e,this.updateType=Us2.OBJECT,this.skinIndexNode=Qu2("skinIndex","uvec4"),this.skinWeightNode=Qu2("skinWeight","vec4"),this.bindMatrixNode=Cd2("bindMatrix","mat4"),this.bindMatrixInverseNode=Cd2("bindMatrixInverse","mat4"),this.boneMatricesNode=Md2("skeleton.boneMatrices","mat4",e.skeleton.bones.length),this.positionNode=Wl2,this.toPositionNode=Wl2,this.previousBoneMatricesNode=null}getSkinnedPosition(e=this.boneMatricesNode,t=this.positionNode){const{skinIndexNode:s,skinWeightNode:i,bindMatrixNode:r,bindMatrixInverseNode:n}=this,a=e.element(s.x),o=e.element(s.y),l=e.element(s.z),h=e.element(s.w),u=r.mul(t),c=da2(a.mul(i.x).mul(u),o.mul(i.y).mul(u),l.mul(i.z).mul(u),h.mul(i.w).mul(u));return n.mul(c).xyz}getSkinnedNormal(e=this.boneMatricesNode,t=rd2){const{skinIndexNode:s,skinWeightNode:i,bindMatrixNode:r,bindMatrixInverseNode:n}=this,a=e.element(s.x),o=e.element(s.y),l=e.element(s.z),h=e.element(s.w);let u=da2(i.x.mul(a),i.y.mul(o),i.z.mul(l),i.w.mul(h));return u=n.mul(u).mul(r),u.transformDirection(t).xyz}getPreviousSkinnedPosition(e){const t=e.object;return null===this.previousBoneMatricesNode&&(t.skeleton.previousBoneMatrices=new Float32Array(t.skeleton.boneMatrices),this.previousBoneMatricesNode=Md2("skeleton.previousBoneMatrices","mat4",t.skeleton.bones.length)),this.getSkinnedPosition(this.previousBoneMatricesNode,ql2)}needsPreviousBoneMatrices(e){const t=e.renderer.getMRT();return t&&t.has("velocity")||!0===Ls2(e.object).useVelocity}setup(e){this.needsPreviousBoneMatrices(e)&&ql2.assign(this.getPreviousSkinnedPosition(e));const t=this.getSkinnedPosition();if(this.toPositionNode&&this.toPositionNode.assign(t),e.hasGeometryAttribute("normal")){const t=this.getSkinnedNormal();rd2.assign(t),e.hasGeometryAttribute("tangent")&&Xd.assign(t)}return t}generate(e,t){if("void"!==t)return super.generate(e,t)}update(e){const t=e.object&&e.object.skeleton?e.object.skeleton:this.skinnedMesh.skeleton;mh2.get(t)!==e.frameId&&(mh2.set(t,e.frameId),null!==this.previousBoneMatricesNode&&t.previousBoneMatrices.set(t.boneMatrices),t.update())}},yh2=e=>Ii2(new fh2(e)),bh2=class extends js2{static get type(){return"LoopNode"}constructor(e=[]){super(),this.params=e}getVarName(e){return String.fromCharCode("i".charCodeAt(0)+e)}getProperties(e){const t=e.getNodeProperties(this);if(void 0!==t.stackNode)return t;const s={};for(let e=0,t=this.params.length-1;e<t;e++){const t=this.params[e],i=!0!==t.isNode&&t.name||this.getVarName(e),r=!0!==t.isNode&&t.type||"int";s[i]=$u2(i,r)}const i=e.addStack();t.returnsNode=this.params[this.params.length-1](s,e),t.stackNode=i;const r=this.params[0];return!0!==r.isNode&&"function"==typeof r.update&&(t.updateNode=Hi2(this.params[0].update)(s)),e.removeStack(),t}getNodeType(e){const{returnsNode:t}=this.getProperties(e);return t?t.getNodeType(e):"void"}setup(e){this.getProperties(e)}generate(e){const t=this.getProperties(e),s=this.params,i=t.stackNode;for(let i=0,r=s.length-1;i<r;i++){const r=s[i];let n,a=!1,o=null,l=null,h=null,u=null,c=null,d=null;if(r.isNode?"bool"===r.getNodeType(e)?(a=!0,u="bool",l=r.build(e,u)):(u="int",h=this.getVarName(i),o="0",l=r.build(e,u),c="<"):(u=r.type||"int",h=r.name||this.getVarName(i),o=r.start,l=r.end,c=r.condition,d=r.update,"number"==typeof o?o=e.generateConst(u,o):o&&o.isNode&&(o=o.build(e,u)),"number"==typeof l?l=e.generateConst(u,l):l&&l.isNode&&(l=l.build(e,u)),void 0!==o&&void 0===l?(o+=" - 1",l="0",c=">="):void 0!==l&&void 0===o&&(o="0",c="<"),void 0===c&&(c=Number(o)>Number(l)?">=":"<")),a)n=`while ( ${l} )`;else{const s={start:o,end:l},i=s.start,r=s.end;let a;const p=()=>c.includes("<")?"+=":"-=";if(null!=d)switch(typeof d){case"function":a=e.flowStagesNode(t.updateNode,"void").code.replace(/\t|;/g,"");break;case"number":a=h+" "+p()+" "+e.generateConst(u,d);break;case"string":a=h+" "+d;break;default:d.isNode?a=h+" "+p()+" "+d.build(e):(console.error("THREE.TSL: 'Loop( { update: ... } )' is not a function, string or number."),a="break /* invalid update */")}else d="int"===u||"uint"===u?c.includes("<")?"++":"--":p()+" 1.",a=h+" "+d;n=`for ( ${e.getVar(u,h)+" = "+i}; ${h+" "+c+" "+r}; ${a} )`}e.addFlowCode((0===i?"\n":"")+e.tab+n+" {\n\n").addFlowTab()}const r=i.build(e,"void"),n=t.returnsNode?t.returnsNode.build(e):"";e.removeFlowTab().addFlowCode("\n"+e.tab+r);for(let t=0,s=this.params.length-1;t<s;t++)e.addFlowCode((0===t?"":e.tab)+"}\n\n").removeFlowTab();return e.addFlowTab(),n}},xh2=(...e)=>Ii2(new bh2(Ui2(e,"int"))).toStack(),Th2=()=>$u2("break").toStack(),_h2=new WeakMap,vh2=new As,Nh2=Hi2(({bufferMap:e,influence:t,stride:s,width:i,depth:r,offset:n})=>{const a=Yi2(Jc2).mul(s).add(n),o=a.div(i),l=a.sub(o.mul(i));return ol2(e,en2(l,o)).depth(r).xyz.mul(t)}),Sh2=class extends js2{static get type(){return"MorphNode"}constructor(e){super("void"),this.mesh=e,this.morphBaseInfluence=ta2(1),this.updateType=Us2.OBJECT}setup(e){const{geometry:t}=e,s=void 0!==t.morphAttributes.position,i=t.hasAttribute("normal")&&void 0!==t.morphAttributes.normal,r=t.morphAttributes.position||t.morphAttributes.normal||t.morphAttributes.color,n=void 0!==r?r.length:0,{texture:a,stride:o,size:l}=function(e){const t=void 0!==e.morphAttributes.position,s=void 0!==e.morphAttributes.normal,i=void 0!==e.morphAttributes.color,r=e.morphAttributes.position||e.morphAttributes.normal||e.morphAttributes.color,n=void 0!==r?r.length:0;let a=_h2.get(e);if(void 0===a||a.count!==n){let r=function(){m.dispose(),_h2.delete(e),e.removeEventListener("dispose",r)};void 0!==a&&a.texture.dispose();const o=e.morphAttributes.position||[],l=e.morphAttributes.normal||[],h=e.morphAttributes.color||[];let u=0;!0===t&&(u=1),!0===s&&(u=2),!0===i&&(u=3);let c=e.attributes.position.count*u,d=1;const p=4096;c>p&&(d=Math.ceil(c/p),c=p);const _=new Float32Array(c*d*4*n),m=new Cs(_,c,d,n);m.type=Et,m.needsUpdate=!0;const f=4*u;for(let e=0;e<n;e++){const r=o[e],n=l[e],a=h[e],u=c*d*4*e;for(let e=0;e<r.count;e++){const o=e*f;!0===t&&(vh2.fromBufferAttribute(r,e),_[u+o+0]=vh2.x,_[u+o+1]=vh2.y,_[u+o+2]=vh2.z,_[u+o+3]=0),!0===s&&(vh2.fromBufferAttribute(n,e),_[u+o+4]=vh2.x,_[u+o+5]=vh2.y,_[u+o+6]=vh2.z,_[u+o+7]=0),!0===i&&(vh2.fromBufferAttribute(a,e),_[u+o+8]=vh2.x,_[u+o+9]=vh2.y,_[u+o+10]=vh2.z,_[u+o+11]=4===a.itemSize?vh2.w:1)}}a={count:n,texture:m,stride:u,size:new Gi(c,d)},_h2.set(e,a),e.addEventListener("dispose",r)}return a}(t);!0===s&&Wl2.mulAssign(this.morphBaseInfluence),!0===i&&rd2.mulAssign(this.morphBaseInfluence);const h=Yi2(l.width);xh2(n,({i:e})=>{const t=Ki2(0).toVar();this.mesh.count>1&&null!==this.mesh.morphTexture&&void 0!==this.mesh.morphTexture?t.assign(ol2(this.mesh.morphTexture,en2(Yi2(e).add(1),Yi2(eh2))).r):t.assign(Cd2("morphTargetInfluences","float").element(e).toVar()),qi2(t.notEqual(0),()=>{!0===s&&Wl2.addAssign(Nh2({bufferMap:a,influence:t,stride:o,width:h,depth:e,offset:Yi2(0)})),!0===i&&rd2.addAssign(Nh2({bufferMap:a,influence:t,stride:o,width:h,depth:e,offset:Yi2(1)}))})})}update(){const e=this.morphBaseInfluence;this.mesh.geometry.morphTargetsRelative?e.value=1:e.value=1-this.mesh.morphTargetInfluences.reduce((e,t)=>e+t,0)}},Eh2=Oi2(Sh2).setParameterLength(1),wh2=class extends js2{static get type(){return"LightingNode"}constructor(){super("vec3"),this.isLightingNode=!0}},Ah2=class extends wh2{static get type(){return"AONode"}constructor(e=null){super(),this.aoNode=e}setup(e){e.context.ambientOcclusion.mulAssign(this.aoNode)}},Rh2=class extends eu{static get type(){return"LightingContextNode"}constructor(e,t=null,s=null,i=null){super(e),this.lightingModel=t,this.backdropNode=s,this.backdropAlphaNode=i,this._value=null}getContext(){const{backdropNode:e,backdropAlphaNode:t}=this,s={directDiffuse:sn2().toVar("directDiffuse"),directSpecular:sn2().toVar("directSpecular"),indirectDiffuse:sn2().toVar("indirectDiffuse"),indirectSpecular:sn2().toVar("indirectSpecular")};return{radiance:sn2().toVar("radiance"),irradiance:sn2().toVar("irradiance"),iblIrradiance:sn2().toVar("iblIrradiance"),ambientOcclusion:Ki2(1).toVar("ambientOcclusion"),reflectedLight:s,backdrop:e,backdropAlpha:t}}setup(e){return this.value=this._value||(this._value=this.getContext()),this.value.lightingModel=this.lightingModel||e.context.lightingModel,super.setup(e)}},Ch2=Oi2(Rh2),Mh2=class extends wh2{static get type(){return"IrradianceNode"}constructor(e){super(),this.node=e}setup(e){e.context.irradiance.addAssign(this.node)}},Ph2,Bh2,Lh2=class e extends js2{static get type(){return"ScreenNode"}constructor(e){super(),this.scope=e,this.isViewportNode=!0}getNodeType(){return this.scope===e.VIEWPORT?"vec4":"vec2"}getUpdateType(){let t=Us2.NONE;return this.scope!==e.SIZE&&this.scope!==e.VIEWPORT||(t=Us2.RENDER),this.updateType=t,t}update({renderer:t}){const s=t.getRenderTarget();this.scope===e.VIEWPORT?null!==s?Bh2.copy(s.viewport):(t.getViewport(Bh2),Bh2.multiplyScalar(t.getPixelRatio())):null!==s?(Ph2.width=s.width,Ph2.height=s.height):t.getDrawingBufferSize(Ph2)}setup(){const t=this.scope;let s=null;return s=t===e.SIZE?ta2(Ph2||(Ph2=new Gi)):t===e.VIEWPORT?ta2(Bh2||(Bh2=new As)):Ji2(Dh2.div(Ih2)),s}generate(t){if(this.scope===e.COORDINATE){let e=t.getFragCoord();if(t.isFlipY()){const s=t.getNodeProperties(Ih2).outputNode.build(t);e=`${t.getType("vec2")}( ${e}.x, ${s}.y - ${e}.y )`}return e}return super.generate(t)}};Lh2.COORDINATE="coordinate",Lh2.VIEWPORT="viewport",Lh2.SIZE="size",Lh2.UV="uv";var Fh2=ki2(Lh2,Lh2.UV),Ih2=ki2(Lh2,Lh2.SIZE),Dh2=ki2(Lh2,Lh2.COORDINATE),Vh2=ki2(Lh2,Lh2.VIEWPORT),Uh2=Vh2.zw,Oh2=Dh2.sub(Vh2.xy),kh2=Oh2.div(Uh2),Gh2=Hi2(()=>(console.warn('THREE.TSL: "viewportResolution" is deprecated. Use "screenSize" instead.'),Ih2),"vec2").once()(),zh2=new Gi,Hh2=class extends il2{static get type(){return"ViewportTextureNode"}constructor(e=Fh2,t=null,s=null){let i=null;null===s?(i=new eh,i.minFilter=_t,s=i):i=s,super(s,e,t),this.generateMipmaps=!1,this.defaultFramebuffer=i,this.isOutputTextureNode=!0,this.updateBeforeType=Us2.RENDER,this._textures=new WeakMap}getFrameBufferTexture(e=null){const t=this.referenceNode?this.referenceNode.defaultFramebuffer:this.defaultFramebuffer;if(null===e)return t;if(!1===this._textures.has(e)){const s=t.clone();this._textures.set(e,s)}return this._textures.get(e)}updateBefore(e){const t=e.renderer,s=t.getRenderTarget();null===s?t.getDrawingBufferSize(zh2):zh2.set(s.width,s.height);const i=this.getFrameBufferTexture(s);i.image.width===zh2.width&&i.image.height===zh2.height||(i.image.width=zh2.width,i.image.height=zh2.height,i.needsUpdate=!0);const r=i.generateMipmaps;i.generateMipmaps=this.generateMipmaps,t.copyFramebufferToTexture(i),i.generateMipmaps=r,this.value=i}clone(){const e=new this.constructor(this.uvNode,this.levelNode,this.value);return e.generateMipmaps=this.generateMipmaps,e}},$h2=Oi2(Hh2).setParameterLength(0,3),Wh2=Oi2(Hh2,null,null,{generateMipmaps:!0}).setParameterLength(0,3),qh2=null,jh2=class extends Hh2{static get type(){return"ViewportDepthTextureNode"}constructor(e=Fh2,t=null){null===qh2&&(qh2=new ah),super(e,t,qh2)}},Xh2=Oi2(jh2).setParameterLength(0,2),Kh2=class e extends js2{static get type(){return"ViewportDepthNode"}constructor(e,t=null){super("float"),this.scope=e,this.valueNode=t,this.isViewportDepthNode=!0}generate(t){const{scope:s}=this;return s===e.DEPTH_BASE?t.getFragDepth():super.generate(t)}setup({camera:t}){const{scope:s}=this,i=this.valueNode;let r=null;if(s===e.DEPTH_BASE)null!==i&&(r=ep().assign(i));else if(s===e.DEPTH)r=t.isPerspectiveCamera?Qh2(Kl2.z,ml2,fl2):Yh2(Kl2.z,ml2,fl2);else if(s===e.LINEAR_DEPTH)if(null!==i)if(t.isPerspectiveCamera){const e=Zh2(i,ml2,fl2);r=Yh2(e,ml2,fl2)}else r=i;else r=Yh2(Kl2.z,ml2,fl2);return r}};Kh2.DEPTH_BASE="depthBase",Kh2.DEPTH="depth",Kh2.LINEAR_DEPTH="linearDepth";var Yh2=(e,t,s)=>e.add(t).div(t.sub(s)),Qh2=(e,t,s)=>t.add(e).mul(s).div(s.sub(t).mul(e)),Zh2=(e,t,s)=>t.mul(s).div(s.sub(t).mul(e).sub(s)),Jh2=(e,t,s)=>{t=t.max(1e-6).toVar();const i=Xa2(e.negate().div(t)),r=Xa2(s.div(t));return i.div(r)},ep=Oi2(Kh2,Kh2.DEPTH_BASE),tp=ki2(Kh2,Kh2.DEPTH),rp=Oi2(Kh2,Kh2.LINEAR_DEPTH).setParameterLength(0,1),sp=rp(Xh2());tp.assign=e=>ep(e);var ip=class e extends js2{static get type(){return"ClippingNode"}constructor(t=e.DEFAULT){super(),this.scope=t}setup(t){super.setup(t);const s=t.clippingContext,{intersectionPlanes:i,unionPlanes:r}=s;return this.hardwareClipping=t.material.hardwareClipping,this.scope===e.ALPHA_TO_COVERAGE?this.setupAlphaToCoverage(i,r):this.scope===e.HARDWARE?this.setupHardwareClipping(r,t):this.setupDefault(i,r)}setupAlphaToCoverage(e,t){return Hi2(()=>{const s=Ki2().toVar("distanceToPlane"),i=Ki2().toVar("distanceToGradient"),r=Ki2(1).toVar("clipOpacity"),n=t.length;if(!1===this.hardwareClipping&&n>0){const e=hl2(t);xh2(n,({i:t})=>{const n=e.element(t);s.assign(Kl2.dot(n.xyz).negate().add(n.w)),i.assign(s.fwidth().div(2)),r.mulAssign(Ho2(i.negate(),i,s))})}const a=e.length;if(a>0){const t=hl2(e),n=Ki2(1).toVar("intersectionClipOpacity");xh2(a,({i:e})=>{const r=t.element(e);s.assign(Kl2.dot(r.xyz).negate().add(r.w)),i.assign(s.fwidth().div(2)),n.mulAssign(Ho2(i.negate(),i,s).oneMinus())}),r.mulAssign(n.oneMinus())}Tn2.a.mulAssign(r),Tn2.a.equal(0).discard()})()}setupDefault(e,t){return Hi2(()=>{const s=t.length;if(!1===this.hardwareClipping&&s>0){const e=hl2(t);xh2(s,({i:t})=>{const s=e.element(t);Kl2.dot(s.xyz).greaterThan(s.w).discard()})}const i=e.length;if(i>0){const t=hl2(e),s=Zi2(!0).toVar("clipped");xh2(i,({i:e})=>{const i=t.element(e);s.assign(Kl2.dot(i.xyz).greaterThan(i.w).and(s))}),s.discard()}})()}setupHardwareClipping(e,t){const s=e.length;return t.enableHardwareClipping(s),Hi2(()=>{const i=hl2(e),r=pl2(t.getClipDistance());xh2(s,({i:e})=>{const t=i.element(e),s=Kl2.dot(t.xyz).sub(t.w).negate();r.element(e).assign(s)})})()}};ip.ALPHA_TO_COVERAGE="alphaToCoverage",ip.DEFAULT="default",ip.HARDWARE="hardware";var np=Hi2(([e])=>eo2(ha2(1e4,to2(ha2(17,e.x).add(ha2(.1,e.y)))).mul(da2(.1,oo2(to2(ha2(13,e.y).add(e.x))))))),ap=Hi2(([e])=>np(Ji2(np(e.xy),e.z))),op=Hi2(([e])=>{const t=Eo2(lo2(po(e.xyz)),lo2(go2(e.xyz))),s=Ki2(1).div(Ki2(.05).mul(t)).toVar("pixScale"),i=Ji2(qa2(Qa2(Xa2(s))),qa2(Za2(Xa2(s)))),r=Ji2(ap(Qa2(i.x.mul(e.xyz))),ap(Qa2(i.y.mul(e.xyz)))),n=eo2(Xa2(s)),a=da2(ha2(n.oneMinus(),r.x),ha2(n,r.y)),o=So2(n,n.oneMinus()),l=sn2(a.mul(a).div(ha2(2,o).mul(ca2(1,o))),a.sub(ha2(.5,o)).div(ca2(1,o)),ca2(1,ca2(1,a).mul(ca2(1,a)).div(ha2(2,o).mul(ca2(1,o))))),h=a.lessThan(o.oneMinus()).select(a.lessThan(o).select(l.x,l.y),l.z);return ko2(h,1e-6,1)}).setLayout({name:"getAlphaHashThreshold",type:"float",inputs:[{name:"position",type:"vec3"}]}),up=class extends Yu2{static get type(){return"VertexColorNode"}constructor(e){super(null,"vec4"),this.isVertexColorNode=!0,this.index=e}getAttributeName(){const e=this.index;return"color"+(e>0?e:"")}generate(e){const t=this.getAttributeName(e);let s;return s=!0===e.hasGeometryAttribute(t)?super.generate(e):e.generateConst(this.nodeType,new As(1,1,1,1)),s}serialize(e){super.serialize(e),e.index=this.index}deserialize(e){super.deserialize(e),this.index=e.index}},lp=(e=0)=>Ii2(new up(e)),dp=Hi2(([e,t])=>So2(1,e.oneMinus().div(t)).oneMinus()).setLayout({name:"blendBurn",type:"vec3",inputs:[{name:"base",type:"vec3"},{name:"blend",type:"vec3"}]}),cp=Hi2(([e,t])=>So2(e.div(t.oneMinus()),1)).setLayout({name:"blendDodge",type:"vec3",inputs:[{name:"base",type:"vec3"},{name:"blend",type:"vec3"}]}),hp=Hi2(([e,t])=>e.oneMinus().mul(t.oneMinus()).oneMinus()).setLayout({name:"blendScreen",type:"vec3",inputs:[{name:"base",type:"vec3"},{name:"blend",type:"vec3"}]}),pp=Hi2(([e,t])=>Oo2(e.mul(2).mul(t),e.oneMinus().mul(2).mul(t.oneMinus()).oneMinus(),wo2(.5,e))).setLayout({name:"blendOverlay",type:"vec3",inputs:[{name:"base",type:"vec3"},{name:"blend",type:"vec3"}]}),gp=Hi2(([e,t])=>{const s=t.a.add(e.a.mul(t.a.oneMinus()));return un2(t.rgb.mul(t.a).add(e.rgb.mul(e.a).mul(t.a.oneMinus())).div(s),s)}).setLayout({name:"blendColor",type:"vec4",inputs:[{name:"base",type:"vec4"},{name:"blend",type:"vec4"}]}),mp=Hi2(([e])=>un2(e.rgb.mul(e.a),e.a),{color:"vec4",return:"vec4"}),fp=Hi2(([e])=>(qi2(e.a.equal(0),()=>un2(0)),un2(e.rgb.div(e.a),e.a)),{color:"vec4",return:"vec4"}),yp=class extends tn{static get type(){return"NodeMaterial"}get type(){return this.constructor.type}set type(e){}constructor(){super(),this.isNodeMaterial=!0,this.fog=!0,this.lights=!1,this.hardwareClipping=!1,this.lightsNode=null,this.envNode=null,this.aoNode=null,this.colorNode=null,this.normalNode=null,this.opacityNode=null,this.backdropNode=null,this.backdropAlphaNode=null,this.alphaTestNode=null,this.maskNode=null,this.positionNode=null,this.geometryNode=null,this.depthNode=null,this.receivedShadowPositionNode=null,this.castShadowPositionNode=null,this.receivedShadowNode=null,this.castShadowNode=null,this.outputNode=null,this.mrtNode=null,this.fragmentNode=null,this.vertexNode=null,Object.defineProperty(this,"shadowPositionNode",{get:()=>this.receivedShadowPositionNode,set:e=>{console.warn('THREE.NodeMaterial: ".shadowPositionNode" was renamed to ".receivedShadowPositionNode".'),this.receivedShadowPositionNode=e}})}customProgramCacheKey(){return this.type+vs2(this)}build(e){this.setup(e)}setupObserver(e){return new ys2(e)}setup(e){e.context.setupNormal=()=>cu2(this.setupNormal(e),"NORMAL","vec3"),e.context.setupPositionView=()=>this.setupPositionView(e),e.context.setupModelViewProjection=()=>this.setupModelViewProjection(e);const t=e.renderer,s=t.getRenderTarget();e.addStack();const i=cu2(this.setupVertex(e),"VERTEX"),r=this.vertexNode||i;let n;e.stack.outputNode=r,this.setupHardwareClipping(e),null!==this.geometryNode&&(e.stack.outputNode=e.stack.outputNode.bypass(this.geometryNode)),e.addFlow("vertex",e.removeStack()),e.addStack();const a=this.setupClipping(e);if(!0!==this.depthWrite&&!0!==this.depthTest||(null!==s?!0===s.depthBuffer&&this.setupDepth(e):!0===t.depth&&this.setupDepth(e)),null===this.fragmentNode){this.setupDiffuseColor(e),this.setupVariants(e);const i=this.setupLighting(e);null!==a&&e.stack.add(a);const r=un2(i,Tn2.a).max(0);n=this.setupOutput(e,r),Un2.assign(n);const o=null!==this.outputNode;if(o&&(n=this.outputNode),null!==s){const e=t.getMRT(),s=this.mrtNode;null!==e?(o&&Un2.assign(n),n=e,null!==s&&(n=e.merge(s))):null!==s&&(n=s)}}else{let t=this.fragmentNode;!0!==t.isOutputStructNode&&(t=un2(t)),n=this.setupOutput(e,t)}e.stack.outputNode=n,e.addFlow("fragment",e.removeStack()),e.observer=this.setupObserver(e)}setupClipping(e){if(null===e.clippingContext)return null;const{unionPlanes:t,intersectionPlanes:s}=e.clippingContext;let i=null;if(t.length>0||s.length>0){const t=e.renderer.samples;this.alphaToCoverage&&t>1?i=Ii2(new ip(ip.ALPHA_TO_COVERAGE)):e.stack.add(Ii2(new ip))}return i}setupHardwareClipping(e){if(this.hardwareClipping=!1,null===e.clippingContext)return;const t=e.clippingContext.unionPlanes.length;t>0&&t<=8&&e.isAvailable("clipDistance")&&(e.stack.add(Ii2(new ip(ip.HARDWARE))),this.hardwareClipping=!0)}setupDepth(e){const{renderer:t,camera:s}=e;let i=this.depthNode;if(null===i){const e=t.getMRT();e&&e.has("depth")?i=e.get("depth"):!0===t.logarithmicDepthBuffer&&(i=s.isPerspectiveCamera?Jh2(Kl2.z,ml2,fl2):Yh2(Kl2.z,ml2,fl2))}null!==i&&tp.assign(i).toStack()}setupPositionView(){return kl2.mul(Wl2).xyz}setupModelViewProjection(){return yl2.mul(Kl2)}setupVertex(e){return e.addStack(),this.setupPosition(e),e.context.vertex=e.removeStack(),Qc}setupPosition(e){const{object:t,geometry:s}=e;if((s.morphAttributes.position||s.morphAttributes.normal||s.morphAttributes.color)&&Eh2(t).toStack(),!0===t.isSkinnedMesh&&yh2(t).toStack(),this.displacementMap){const e=Bd2("displacementMap","texture"),t=Bd2("displacementScale","float"),s=Bd2("displacementBias","float");Wl2.addAssign(rd2.normalize().mul(e.x.mul(t).add(s)))}return t.isBatchedMesh&&dh2(t).toStack(),t.isInstancedMesh&&t.instanceMatrix&&!0===t.instanceMatrix.isInstancedBufferAttribute&&uh2(t).toStack(),null!==this.positionNode&&Wl2.assign(cu2(this.positionNode,"POSITION","vec3")),Wl2}setupDiffuseColor({object:e,geometry:t}){null!==this.maskNode&&Zi2(this.maskNode).not().discard();let s=this.colorNode?un2(this.colorNode):gc2;!0===this.vertexColors&&t.hasAttribute("color")&&(s=s.mul(lp())),e.instanceColor&&(s=xn2("vec3","vInstanceColor").mul(s)),e.isBatchedMesh&&e._colorsTexture&&(s=xn2("vec3","vBatchColor").mul(s)),Tn2.assign(s);const i=this.opacityNode?Ki2(this.opacityNode):yc2;Tn2.a.assign(Tn2.a.mul(i));let r=null;(null!==this.alphaTestNode||this.alphaTest>0)&&(r=null!==this.alphaTestNode?Ki2(this.alphaTestNode):pc2,Tn2.a.lessThanEqual(r).discard()),!0===this.alphaHash&&Tn2.a.lessThan(op(Wl2)).discard(),!1===this.transparent&&this.blending===y&&!1===this.alphaToCoverage?Tn2.a.assign(1):null===r&&Tn2.a.lessThanEqual(0).discard()}setupVariants(){}setupOutgoingLight(){return!0===this.lights?sn2(0):Tn2.rgb}setupNormal(){return this.normalNode?sn2(this.normalNode):Ec2}setupEnvironment(){let e=null;return this.envNode?e=this.envNode:this.envMap&&(e=this.envMap.isCubeTexture?Bd2("envMap","cubeTexture"):Bd2("envMap","texture")),e}setupLightMap(e){let t=null;return e.material.lightMap&&(t=new Mh2(Xc2)),t}setupLights(e){const t=[],s=this.setupEnvironment(e);s&&s.isLightingNode&&t.push(s);const i=this.setupLightMap(e);if(i&&i.isLightingNode&&t.push(i),null!==this.aoNode||e.material.aoMap){const e=null!==this.aoNode?this.aoNode:Kc2;t.push(new Ah2(e))}let r=this.lightsNode||e.lightsNode;return t.length>0&&(r=e.renderer.lighting.createNode([...r.getLights(),...t])),r}setupLightingModel(){}setupLighting(e){const{material:t}=e,{backdropNode:s,backdropAlphaNode:i,emissiveNode:r}=this,n=!0===this.lights||null!==this.lightsNode?this.setupLights(e):null;let a=this.setupOutgoingLight(e);if(n&&n.getScope().hasLights){const t=this.setupLightingModel(e)||null;a=Ch2(n,t,s,i)}else null!==s&&(a=sn2(null!==i?Oo2(a,s,i):s));return(r&&!0===r.isNode||t.emissive&&!0===t.emissive.isColor)&&(_n2.assign(sn2(r||fc2)),a=a.add(_n2)),a}setupFog(e,t){const s=e.fogNode;return s&&(Un2.assign(t),t=un2(s.toVar())),t}setupPremultipliedAlpha(e,t){return mp(t)}setupOutput(e,t){return!0===this.fog&&(t=this.setupFog(e,t)),!0===this.premultipliedAlpha&&(t=this.setupPremultipliedAlpha(e,t)),t}setDefaultValues(e){for(const t in e){const s=e[t];void 0===this[t]&&(this[t]=s,s&&s.clone&&(this[t]=s.clone()))}const t=Object.getOwnPropertyDescriptors(e.constructor.prototype);for(const e in t)void 0===Object.getOwnPropertyDescriptor(this.constructor.prototype,e)&&void 0!==t[e].get&&Object.defineProperty(this.constructor.prototype,e,t[e])}toJSON(e){const t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{},nodes:{}});const s=tn.prototype.toJSON.call(this,e),i=Ns2(this);s.inputNodes={};for(const{property:t,childNode:r}of i)s.inputNodes[t]=r.toJSON(e).uuid;function r(e){const t=[];for(const s in e){const i=e[s];delete i.metadata,t.push(i)}return t}if(t){const t=r(e.textures),i=r(e.images),n=r(e.nodes);t.length>0&&(s.textures=t),i.length>0&&(s.images=i),n.length>0&&(s.nodes=n)}return s}copy(e){return this.lightsNode=e.lightsNode,this.envNode=e.envNode,this.colorNode=e.colorNode,this.normalNode=e.normalNode,this.opacityNode=e.opacityNode,this.backdropNode=e.backdropNode,this.backdropAlphaNode=e.backdropAlphaNode,this.alphaTestNode=e.alphaTestNode,this.maskNode=e.maskNode,this.positionNode=e.positionNode,this.geometryNode=e.geometryNode,this.depthNode=e.depthNode,this.receivedShadowPositionNode=e.receivedShadowPositionNode,this.castShadowPositionNode=e.castShadowPositionNode,this.receivedShadowNode=e.receivedShadowNode,this.castShadowNode=e.castShadowNode,this.outputNode=e.outputNode,this.mrtNode=e.mrtNode,this.fragmentNode=e.fragmentNode,this.vertexNode=e.vertexNode,super.copy(e)}},bp=new Eo,xp=class extends yp{static get type(){return"LineBasicNodeMaterial"}constructor(e){super(),this.isLineBasicNodeMaterial=!0,this.setDefaultValues(bp),this.setValues(e)}},Tp=new Hl,_p=class extends yp{static get type(){return"LineDashedNodeMaterial"}constructor(e){super(),this.isLineDashedNodeMaterial=!0,this.setDefaultValues(Tp),this.dashOffset=0,this.offsetNode=null,this.dashScaleNode=null,this.dashSizeNode=null,this.gapSizeNode=null,this.setValues(e)}setupVariants(){const e=this.offsetNode?Ki2(this.offsetNode):Wc2,t=this.dashScaleNode?Ki2(this.dashScaleNode):Gc,s=this.dashSizeNode?Ki2(this.dashSizeNode):zc2,i=this.gapSizeNode?Ki2(this.gapSizeNode):Hc2;On2.assign(s),kn2.assign(i);const r=pu2(Qu2("lineDistance").mul(t));(e?r.add(e):r).mod(On2.add(kn2)).greaterThan(On2).discard()}},vp=null,Np=class extends Hh2{static get type(){return"ViewportSharedTextureNode"}constructor(e=Fh2,t=null){null===vp&&(vp=new eh),super(e,t,vp)}updateReference(){return this}},Sp=Oi2(Np).setParameterLength(0,2),Ep=new Hl,Ap=e=>Ii2(e).mul(.5).add(.5),Rp=new Ll,Cp=class extends yp{static get type(){return"MeshNormalNodeMaterial"}constructor(e){super(),this.isMeshNormalNodeMaterial=!0,this.setDefaultValues(Rp),this.setValues(e)}setupDiffuseColor(){const e=this.opacityNode?Ki2(this.opacityNode):yc2;Tn2.assign(Tu2(un2(Ap(ad2),e),Ye))}},Mp=Hi2(([e=Xl2])=>{const t=e.z.atan(e.x).mul(1/(2*Math.PI)).add(.5),s=e.y.clamp(-1,1).asin().mul(1/Math.PI).add(.5);return Ji2(t,s)}),Pp=class extends ia{constructor(e=1,t={}){super(e,t),this.isCubeRenderTarget=!0}fromEquirectangularTexture(e,t){const s=t.minFilter,i=t.generateMipmaps;t.generateMipmaps=!0,this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const r=new Dn(5,5,5),n=Mp(Xl2),a=new yp;a.colorNode=al2(t,n,0),a.side=d2,a.blending=m;const o=new jn(r,a),l=new ha;l.add(o),t.minFilter===_t&&(t.minFilter=wt);const h=new ta(1,10,this),u=e.getMRT();return e.setMRT(null),h.update(e,l),e.setMRT(u),t.minFilter=s,t.currentGenerateMipmaps=i,o.geometry.dispose(),o.material.dispose(),this}},Bp=new WeakMap,Lp=class extends Ys2{static get type(){return"CubeMapNode"}constructor(e){super("vec3"),this.envNode=e,this._cubeTexture=null,this._cubeTextureNode=wd2(null);const t=new ea;t.isRenderTargetTexture=!0,this._defaultTexture=t,this.updateBeforeType=Us2.RENDER}updateBefore(e){const{renderer:t,material:s}=e,i=this.envNode;if(i.isTextureNode||i.isMaterialReferenceNode){const e=i.isTextureNode?i.value:s[i.property];if(e&&e.isTexture){const s=e.mapping;if(s===ct||s===ut){if(Bp.has(e)){const t=Bp.get(e);Ip(t,e.mapping),this._cubeTexture=t}else{const s=e.image;if(null!=(r=s)&&r.height>0){const i=new Pp(s.height);i.fromEquirectangularTexture(t,e),Ip(i.texture,e.mapping),this._cubeTexture=i.texture,Bp.set(e,i.texture),e.addEventListener("dispose",Fp)}else this._cubeTexture=this._defaultTexture}this._cubeTextureNode.value=this._cubeTexture}else this._cubeTextureNode=this.envNode}}var r}setup(e){return this.updateBefore(e),this._cubeTextureNode}};function Fp(e){const t=e.target;t.removeEventListener("dispose",Fp);const s=Bp.get(t);void 0!==s&&(Bp.delete(t),s.dispose())}function Ip(e,t){t===ct?e.mapping=ht:t===ut&&(e.mapping=lt)}var Dp=Oi2(Lp).setParameterLength(1),Vp=class extends wh2{static get type(){return"BasicEnvironmentNode"}constructor(e=null){super(),this.envNode=e}setup(e){e.context.environment=Dp(this.envNode)}},Up=class extends wh2{static get type(){return"BasicLightMapNode"}constructor(e=null){super(),this.lightMapNode=e}setup(e){const t=Ki2(1/Math.PI);e.context.irradianceLightMap=this.lightMapNode.mul(t)}},Op=class{start(e){e.lightsNode.setupLights(e,e.lightsNode.getLightNodes(e)),this.indirect(e)}finish(){}direct(){}directRectArea(){}indirect(){}ambientOcclusion(){}},kp=class extends Op{constructor(){super()}indirect({context:e}){const t=e.ambientOcclusion,s=e.reflectedLight,i=e.irradianceLightMap;s.indirectDiffuse.assign(un2(0)),i?s.indirectDiffuse.addAssign(i):s.indirectDiffuse.addAssign(un2(1,1,1,0)),s.indirectDiffuse.mulAssign(t),s.indirectDiffuse.mulAssign(Tn2.rgb)}finish(e){const{material:t,context:s}=e,i=s.outgoingLight,r=e.context.environment;if(r)switch(t.combine){case Y:i.rgb.assign(Oo2(i.rgb,i.rgb.mul(r.rgb),_c2.mul(vc2)));break;case Z:i.rgb.assign(Oo2(i.rgb,r.rgb,_c2.mul(vc2)));break;case G:i.rgb.addAssign(r.rgb.mul(_c2.mul(vc2)));break;default:console.warn("THREE.BasicLightingModel: Unsupported .combine value:",t.combine)}}},Gp=new en,zp=class extends yp{static get type(){return"MeshBasicNodeMaterial"}constructor(e){super(),this.isMeshBasicNodeMaterial=!0,this.lights=!0,this.setDefaultValues(Gp),this.setValues(e)}setupNormal(){return ed2(id2)}setupEnvironment(e){const t=super.setupEnvironment(e);return t?new Vp(t):null}setupLightMap(e){let t=null;return e.material.lightMap&&(t=new Up(Xc2)),t}setupOutgoingLight(){return Tn2.rgb}setupLightingModel(){return new kp}},Hp=Hi2(({f0:e,f90:t,dotVH:s})=>{const i=s.mul(-5.55473).sub(6.98316).mul(s).exp2();return e.mul(i.oneMinus()).add(t.mul(i))}),$p=Hi2(e=>e.diffuseColor.mul(1/Math.PI)),Wp=Hi2(({dotNH:e})=>Vn2.mul(Ki2(.5)).add(1).mul(Ki2(1/Math.PI)).mul(e.pow(Vn2))),qp=Hi2(({lightDirection:e})=>{const t=e.add(Yl2).normalize(),s=ad2.dot(t).clamp(),i=Yl2.dot(t).clamp(),r=Hp({f0:In2,f90:1,dotVH:i}),n=Ki2(.25),a=Wp({dotNH:s});return r.mul(n).mul(a)}),jp=class extends kp{constructor(e=!0){super(),this.specular=e}direct({lightDirection:e,lightColor:t,reflectedLight:s}){const i=ad2.dot(e).clamp().mul(t);s.directDiffuse.addAssign(i.mul($p({diffuseColor:Tn2.rgb}))),!0===this.specular&&s.directSpecular.addAssign(i.mul(qp({lightDirection:e})).mul(_c2))}indirect(e){const{ambientOcclusion:t,irradiance:s,reflectedLight:i}=e.context;i.indirectDiffuse.addAssign(s.mul($p({diffuseColor:Tn2}))),i.indirectDiffuse.mulAssign(t)}},Xp=new jl,Kp=class extends yp{static get type(){return"MeshLambertNodeMaterial"}constructor(e){super(),this.isMeshLambertNodeMaterial=!0,this.lights=!0,this.setDefaultValues(Xp),this.setValues(e)}setupEnvironment(e){const t=super.setupEnvironment(e);return t?new Vp(t):null}setupLightingModel(){return new jp(!1)}},Yp=new Vl,Qp=class extends yp{static get type(){return"MeshPhongNodeMaterial"}constructor(e){super(),this.isMeshPhongNodeMaterial=!0,this.lights=!0,this.shininessNode=null,this.specularNode=null,this.setDefaultValues(Yp),this.setValues(e)}setupEnvironment(e){const t=super.setupEnvironment(e);return t?new Vp(t):null}setupLightingModel(){return new jp}setupVariants(){const e=(this.shininessNode?Ki2(this.shininessNode):mc2).max(1e-4);Vn2.assign(e);const t=this.specularNode||bc2;In2.assign(t)}copy(e){return this.shininessNode=e.shininessNode,this.specularNode=e.specularNode,super.copy(e)}},Zp=Hi2(e=>{if(!1===e.geometry.hasAttribute("normal"))return Ki2(0);const t=id2.dFdx().abs().max(id2.dFdy().abs());return t.x.max(t.y).max(t.z)}),Jp=Hi2(e=>{const{roughness:t}=e,s=Zp();let i=t.max(.0525);return i=i.add(s),i=i.min(1),i}),eg=Hi2(({alpha:e,dotNL:t,dotNV:s})=>{const i=e.pow2(),r=t.mul(i.add(i.oneMinus().mul(s.pow2())).sqrt()),n=s.mul(i.add(i.oneMinus().mul(t.pow2())).sqrt());return pa(.5,r.add(n).max(Va2))}).setLayout({name:"V_GGX_SmithCorrelated",type:"float",inputs:[{name:"alpha",type:"float"},{name:"dotNL",type:"float"},{name:"dotNV",type:"float"}]}),tg=Hi2(({alphaT:e,alphaB:t,dotTV:s,dotBV:i,dotTL:r,dotBL:n,dotNV:a,dotNL:o})=>{const l=o.mul(sn2(e.mul(s),t.mul(i),a).length()),h=a.mul(sn2(e.mul(r),t.mul(n),o).length());return pa(.5,l.add(h)).saturate()}).setLayout({name:"V_GGX_SmithCorrelated_Anisotropic",type:"float",inputs:[{name:"alphaT",type:"float",qualifier:"in"},{name:"alphaB",type:"float",qualifier:"in"},{name:"dotTV",type:"float",qualifier:"in"},{name:"dotBV",type:"float",qualifier:"in"},{name:"dotTL",type:"float",qualifier:"in"},{name:"dotBL",type:"float",qualifier:"in"},{name:"dotNV",type:"float",qualifier:"in"},{name:"dotNL",type:"float",qualifier:"in"}]}),rg=Hi2(({alpha:e,dotNH:t})=>{const s=e.pow2(),i=t.pow2().mul(s.oneMinus()).oneMinus();return s.div(i.pow2()).mul(1/Math.PI)}).setLayout({name:"D_GGX",type:"float",inputs:[{name:"alpha",type:"float"},{name:"dotNH",type:"float"}]}),sg=Ki2(1/Math.PI),ig=Hi2(({alphaT:e,alphaB:t,dotNH:s,dotTH:i,dotBH:r})=>{const n=e.mul(t),a=sn2(t.mul(i),e.mul(r),n.mul(s)),o=a.dot(a),l=n.div(o);return sg.mul(n.mul(l.pow2()))}).setLayout({name:"D_GGX_Anisotropic",type:"float",inputs:[{name:"alphaT",type:"float",qualifier:"in"},{name:"alphaB",type:"float",qualifier:"in"},{name:"dotNH",type:"float",qualifier:"in"},{name:"dotTH",type:"float",qualifier:"in"},{name:"dotBH",type:"float",qualifier:"in"}]}),ng=Hi2(({lightDirection:e,f0:t,f90:s,roughness:i,f:r,normalView:n=ad2,USE_IRIDESCENCE:a,USE_ANISOTROPY:o})=>{const l=i.pow2(),h=e.add(Yl2).normalize(),u=n.dot(e).clamp(),c=n.dot(Yl2).clamp(),d=n.dot(h).clamp(),p=Yl2.dot(h).clamp();let _,m,f=Hp({f0:t,f90:s,dotVH:p});if(Bi2(a)&&(f=Rn2.mix(f,r)),Bi2(o)){const t=Ln2.dot(e),s=Ln2.dot(Yl2),i=Ln2.dot(h),r=Fn2.dot(e),n=Fn2.dot(Yl2),a=Fn2.dot(h);_=tg({alphaT:Pn2,alphaB:l,dotTV:s,dotBV:n,dotTL:t,dotBL:r,dotNV:c,dotNL:u}),m=ig({alphaT:Pn2,alphaB:l,dotNH:d,dotTH:i,dotBH:a})}else _=eg({alpha:l,dotNL:u,dotNV:c}),m=rg({alpha:l,dotNH:d});return f.mul(_).mul(m)}),ag=Hi2(({roughness:e,dotNV:t})=>{const s=un2(-1,-.0275,-.572,.022),i=un2(1,.0425,1.04,-.04),r=e.mul(s).add(i),n=r.x.mul(r.x).min(t.mul(-9.28).exp2()).mul(r.x).add(r.y);return Ji2(-1.04,1.04).mul(n).add(r.zw)}).setLayout({name:"DFGApprox",type:"vec2",inputs:[{name:"roughness",type:"float"},{name:"dotNV",type:"vec3"}]}),og=Hi2(e=>{const{dotNV:t,specularColor:s,specularF90:i,roughness:r}=e,n=ag({dotNV:t,roughness:r});return s.mul(n.x).add(i.mul(n.y))}),ug=Hi2(({f:e,f90:t,dotVH:s})=>{const i=s.oneMinus().saturate(),r=i.mul(i),n=i.mul(r,r).clamp(0,.9999);return e.sub(sn2(t).mul(n)).div(n.oneMinus())}).setLayout({name:"Schlick_to_F0",type:"vec3",inputs:[{name:"f",type:"vec3"},{name:"f90",type:"float"},{name:"dotVH",type:"float"}]}),lg=Hi2(({roughness:e,dotNH:t})=>{const s=e.pow2(),i=Ki2(1).div(s),r=t.pow2().oneMinus().max(.0078125);return Ki2(2).add(i).mul(r.pow(i.mul(.5))).div(2*Math.PI)}).setLayout({name:"D_Charlie",type:"float",inputs:[{name:"roughness",type:"float"},{name:"dotNH",type:"float"}]}),dg=Hi2(({dotNV:e,dotNL:t})=>Ki2(1).div(Ki2(4).mul(t.add(e).sub(t.mul(e))))).setLayout({name:"V_Neubelt",type:"float",inputs:[{name:"dotNV",type:"float"},{name:"dotNL",type:"float"}]}),cg=Hi2(({lightDirection:e})=>{const t=e.add(Yl2).normalize(),s=ad2.dot(e).clamp(),i=ad2.dot(Yl2).clamp(),r=ad2.dot(t).clamp(),n=lg({roughness:An2,dotNH:r}),a=dg({dotNV:i,dotNL:s});return wn2.mul(n).mul(a)}),hg=Hi2(({N:e,V:t,roughness:s})=>{const i=e.dot(t).saturate(),r=Ji2(s,i.oneMinus().sqrt());return r.assign(r.mul(.984375).add(.0078125)),r}).setLayout({name:"LTC_Uv",type:"vec2",inputs:[{name:"N",type:"vec3"},{name:"V",type:"vec3"},{name:"roughness",type:"float"}]}),pg=Hi2(({f:e})=>{const t=e.length();return Eo2(t.mul(t).add(e.z).div(t.add(1)),0)}).setLayout({name:"LTC_ClippedSphereFormFactor",type:"float",inputs:[{name:"f",type:"vec3"}]}),gg=Hi2(({v1:e,v2:t})=>{const s=e.dot(t),i=s.abs().toVar(),r=i.mul(.0145206).add(.4965155).mul(i).add(.8543985).toVar(),n=i.add(4.1616724).mul(i).add(3.417594).toVar(),a=r.div(n),o=s.greaterThan(0).select(a,Eo2(s.mul(s).oneMinus(),1e-7).inverseSqrt().mul(.5).sub(a));return e.cross(t).mul(o)}).setLayout({name:"LTC_EdgeVectorFormFactor",type:"vec3",inputs:[{name:"v1",type:"vec3"},{name:"v2",type:"vec3"}]}),mg=Hi2(({N:e,V:t,P:s,mInv:i,p0:r,p1:n,p2:a,p3:o})=>{const l=n.sub(r).toVar(),h=o.sub(r).toVar(),u=l.cross(h),c=sn2().toVar();return qi2(u.dot(s.sub(r)).greaterThanEqual(0),()=>{const l=t.sub(e.mul(t.dot(e))).normalize(),h=e.cross(l).negate(),u=i.mul(pn2(l,h,e).transpose()).toVar(),d=u.mul(r.sub(s)).normalize().toVar(),p=u.mul(n.sub(s)).normalize().toVar(),_=u.mul(a.sub(s)).normalize().toVar(),m=u.mul(o.sub(s)).normalize().toVar(),f=sn2(0).toVar();f.addAssign(gg({v1:d,v2:p})),f.addAssign(gg({v1:p,v2:_})),f.addAssign(gg({v1:_,v2:m})),f.addAssign(gg({v1:m,v2:d})),c.assign(sn2(pg({f:f})))}),c}).setLayout({name:"LTC_Evaluate",type:"vec3",inputs:[{name:"N",type:"vec3"},{name:"V",type:"vec3"},{name:"P",type:"vec3"},{name:"mInv",type:"mat3"},{name:"p0",type:"vec3"},{name:"p1",type:"vec3"},{name:"p2",type:"vec3"},{name:"p3",type:"vec3"}]}),fg=Hi2(({P:e,p0:t,p1:s,p2:i,p3:r})=>{const n=s.sub(t).toVar(),a=r.sub(t).toVar(),o=n.cross(a),l=sn2().toVar();return qi2(o.dot(e.sub(t)).greaterThanEqual(0),()=>{const n=t.sub(e).normalize().toVar(),a=s.sub(e).normalize().toVar(),o=i.sub(e).normalize().toVar(),h=r.sub(e).normalize().toVar(),u=sn2(0).toVar();u.addAssign(gg({v1:n,v2:a})),u.addAssign(gg({v1:a,v2:o})),u.addAssign(gg({v1:o,v2:h})),u.addAssign(gg({v1:h,v2:n})),l.assign(sn2(pg({f:u.abs()})))}),l}).setLayout({name:"LTC_Evaluate",type:"vec3",inputs:[{name:"P",type:"vec3"},{name:"p0",type:"vec3"},{name:"p1",type:"vec3"},{name:"p2",type:"vec3"},{name:"p3",type:"vec3"}]}),yg=1/6,bg=e=>ha2(yg,ha2(e,ha2(e,e.negate().add(3)).sub(3)).add(1)),xg=e=>ha2(yg,ha2(e,ha2(e,ha2(3,e).sub(6))).add(4)),Tg=e=>ha2(yg,ha2(e,ha2(e,ha2(-3,e).add(3)).add(3)).add(1)),_g=e=>ha2(yg,Bo(e,3)),vg=e=>bg(e).add(xg(e)),Ng=e=>Tg(e).add(_g(e)),Sg=e=>da2(-1,xg(e).div(bg(e).add(xg(e)))),Eg=e=>da2(1,_g(e).div(Tg(e).add(_g(e)))),wg=(e,t,s)=>{const i=e.uvNode,r=ha2(i,t.zw).add(.5),n=Qa2(r),a=eo2(r),o=vg(a.x),l=Ng(a.x),h=Sg(a.x),u=Eg(a.x),c=Sg(a.y),d=Eg(a.y),p=Ji2(n.x.add(h),n.y.add(c)).sub(.5).mul(t.xy),_=Ji2(n.x.add(u),n.y.add(c)).sub(.5).mul(t.xy),m=Ji2(n.x.add(h),n.y.add(d)).sub(.5).mul(t.xy),f=Ji2(n.x.add(u),n.y.add(d)).sub(.5).mul(t.xy),g=vg(a.y).mul(da2(o.mul(e.sample(p).level(s)),l.mul(e.sample(_).level(s)))),y=Ng(a.y).mul(da2(o.mul(e.sample(m).level(s)),l.mul(e.sample(f).level(s))));return g.add(y)},Ag=Hi2(([e,t])=>{const s=Ji2(e.size(Yi2(t))),i=Ji2(e.size(Yi2(t.add(1)))),r=pa(1,s),n=pa(1,i),a=wg(e,un2(r,s),Qa2(t)),o=wg(e,un2(n,i),Za2(t));return eo2(t).mix(a,o)}),Rg=Hi2(([e,t])=>{const s=t.mul(rl2(e));return Ag(e,s)}),Cg=Hi2(([e,t,s,i,r])=>{const n=sn2(zo2(t.negate(),Ja2(e),pa(1,i))),a=sn2(lo2(r[0].xyz),lo2(r[1].xyz),lo2(r[2].xyz));return Ja2(n).mul(s.mul(a))}).setLayout({name:"getVolumeTransmissionRay",type:"vec3",inputs:[{name:"n",type:"vec3"},{name:"v",type:"vec3"},{name:"thickness",type:"float"},{name:"ior",type:"float"},{name:"modelMatrix",type:"mat4"}]}),Mg=Hi2(([e,t])=>e.mul(ko2(t.mul(2).sub(2),0,1))).setLayout({name:"applyIorToRoughness",type:"float",inputs:[{name:"roughness",type:"float"},{name:"ior",type:"float"}]}),Pg=Wh2(),Bg=Wh2(),Lg=Hi2(([e,t,s],{material:i})=>{const r=(i.side===d2?Pg:Bg).sample(e),n=Xa2(Ih2.x).mul(Mg(t,s));return Ag(r,n)}),Fg=Hi2(([e,t,s])=>(qi2(s.notEqual(0),()=>{const i=ja2(t).negate().div(s);return Wa2(i.negate().mul(e))}),sn2(1))).setLayout({name:"volumeAttenuation",type:"vec3",inputs:[{name:"transmissionDistance",type:"float"},{name:"attenuationColor",type:"vec3"},{name:"attenuationDistance",type:"float"}]}),Ig=Hi2(([e,t,s,i,r,n,a,o,l,h,u,c,d,p,_])=>{let m,f;if(_){m=un2().toVar(),f=sn2().toVar();const r=u.sub(1).mul(_.mul(.025)),n=sn2(u.sub(r),u,u.add(r));xh2({start:0,end:3},({i:r})=>{const u=n.element(r),_=Cg(e,t,c,u,o),g=a.add(_),y=h.mul(l.mul(un2(g,1))),S=Ji2(y.xy.div(y.w)).toVar();S.addAssign(1),S.divAssign(2),S.assign(Ji2(S.x,S.y.oneMinus()));const T=Lg(S,s,u);m.element(r).assign(T.element(r)),m.a.addAssign(T.a),f.element(r).assign(i.element(r).mul(Fg(lo2(_),d,p).element(r)))}),m.a.divAssign(3)}else{const r=Cg(e,t,c,u,o),n=a.add(r),_=h.mul(l.mul(un2(n,1))),g=Ji2(_.xy.div(_.w)).toVar();g.addAssign(1),g.divAssign(2),g.assign(Ji2(g.x,g.y.oneMinus())),m=Lg(g,s,u),f=i.mul(Fg(lo2(r),d,p))}const g=f.rgb.mul(m.rgb),y=e.dot(t).clamp(),S=sn2(og({dotNV:y,specularColor:r,specularF90:n,roughness:s})),T=f.r.add(f.g,f.b).div(3);return un2(S.oneMinus().mul(g),m.a.oneMinus().mul(T).oneMinus())}),Dg=pn2(3.2404542,-.969266,.0556434,-1.5371385,1.8760108,-.2040259,-.4985314,.041556,1.0572252),Vg=(e,t)=>e.sub(t).div(e.add(t)).pow2(),Ug=Hi2(({outsideIOR:e,eta2:t,cosTheta1:s,thinFilmThickness:i,baseF0:r})=>{const n=Oo2(e,t,Ho2(0,.03,i)),a=e.div(n).pow2().mul(s.pow2().oneMinus()).oneMinus();qi2(a.lessThan(0),()=>sn2(1));const o=a.sqrt(),l=Vg(n,e),h=Hp({f0:l,f90:1,dotVH:s}),u=h.oneMinus(),c=n.lessThan(e).select(Math.PI,0),d=Ki2(Math.PI).sub(c),p=(e=>{const t=e.sqrt();return sn2(1).add(t).div(sn2(1).sub(t))})(r.clamp(0,.9999)),_=Vg(p,n.toVec3()),m=Hp({f0:_,f90:1,dotVH:o}),f=sn2(p.x.lessThan(n).select(Math.PI,0),p.y.lessThan(n).select(Math.PI,0),p.z.lessThan(n).select(Math.PI,0)),g=n.mul(i,o,2),y=sn2(d).add(f),S=h.mul(m).clamp(1e-5,.9999),T=S.sqrt(),x=u.pow2().mul(m).div(sn2(1).sub(S)),b=h.add(x).toVar(),G=x.sub(u).toVar();return xh2({start:1,end:2,condition:"<=",name:"m"},({m:e})=>{G.mulAssign(T);const t=((e,t)=>{const s=e.mul(2*Math.PI*1e-9),i=sn2(54856e-17,44201e-17,52481e-17),r=sn2(1681e3,1795300,2208400),n=sn2(43278e5,93046e5,66121e5),a=Ki2(9747e-17*Math.sqrt(2*Math.PI*45282e5)).mul(s.mul(2239900).add(t.x).cos()).mul(s.pow2().mul(-45282e5).exp());let o=i.mul(n.mul(2*Math.PI).sqrt()).mul(r.mul(s).add(t).cos()).mul(s.pow2().negate().mul(n).exp());return o=sn2(o.x.add(a),o.y,o.z).div(1.0685e-7),Dg.mul(o)})(Ki2(e).mul(g),Ki2(e).mul(y)).mul(2);b.addAssign(G.mul(t))}),b.max(sn2(0))}).setLayout({name:"evalIridescence",type:"vec3",inputs:[{name:"outsideIOR",type:"float"},{name:"eta2",type:"float"},{name:"cosTheta1",type:"float"},{name:"thinFilmThickness",type:"float"},{name:"baseF0",type:"vec3"}]}),Og=Hi2(({normal:e,viewDir:t,roughness:s})=>{const i=e.dot(t).saturate(),r=s.pow2(),n=Jo2(s.lessThan(.25),Ki2(-339.2).mul(r).add(Ki2(161.4).mul(s)).sub(25.9),Ki2(-8.48).mul(r).add(Ki2(14.3).mul(s)).sub(9.95)),a=Jo2(s.lessThan(.25),Ki2(44).mul(r).sub(Ki2(23.7).mul(s)).add(3.26),Ki2(1.97).mul(r).sub(Ki2(3.27).mul(s)).add(.72));return Jo2(s.lessThan(.25),0,Ki2(.1).mul(s).sub(.025)).add(n.mul(i).add(a).exp()).mul(1/Math.PI).saturate()}),kg=sn2(.04),Gg=Ki2(1),zg=class extends Op{constructor(e=!1,t=!1,s=!1,i=!1,r=!1,n=!1){super(),this.clearcoat=e,this.sheen=t,this.iridescence=s,this.anisotropy=i,this.transmission=r,this.dispersion=n,this.clearcoatRadiance=null,this.clearcoatSpecularDirect=null,this.clearcoatSpecularIndirect=null,this.sheenSpecularDirect=null,this.sheenSpecularIndirect=null,this.iridescenceFresnel=null,this.iridescenceF0=null}start(e){if(!0===this.clearcoat&&(this.clearcoatRadiance=sn2().toVar("clearcoatRadiance"),this.clearcoatSpecularDirect=sn2().toVar("clearcoatSpecularDirect"),this.clearcoatSpecularIndirect=sn2().toVar("clearcoatSpecularIndirect")),!0===this.sheen&&(this.sheenSpecularDirect=sn2().toVar("sheenSpecularDirect"),this.sheenSpecularIndirect=sn2().toVar("sheenSpecularIndirect")),!0===this.iridescence){const e=ad2.dot(Yl2).clamp();this.iridescenceFresnel=Ug({outsideIOR:Ki2(1),eta2:Cn2,cosTheta1:e,thinFilmThickness:Mn2,baseF0:In2}),this.iridescenceF0=ug({f:this.iridescenceFresnel,f90:1,dotVH:e})}if(!0===this.transmission){const t=jl2,s=vl2.sub(jl2).normalize(),i=od2,r=e.context;r.backdrop=Ig(i,s,vn2,Tn2,In2,Dn2,t,Ll2,xl2,yl2,zn2,$n2,qn,Wn2,this.dispersion?jn2:null),r.backdropAlpha=Hn,Tn2.a.mulAssign(Oo2(1,r.backdrop.a,Hn))}super.start(e)}computeMultiscattering(e,t,s){const i=ad2.dot(Yl2).clamp(),r=ag({roughness:vn2,dotNV:i}),n=(this.iridescenceF0?Rn2.mix(In2,this.iridescenceF0):In2).mul(r.x).add(s.mul(r.y)),a=r.x.add(r.y).oneMinus(),o=In2.add(In2.oneMinus().mul(.047619)),l=n.mul(o).div(a.mul(o).oneMinus());e.addAssign(n),t.addAssign(l.mul(a))}direct({lightDirection:e,lightColor:t,reflectedLight:s}){const i=ad2.dot(e).clamp().mul(t);if(!0===this.sheen&&this.sheenSpecularDirect.addAssign(i.mul(cg({lightDirection:e}))),!0===this.clearcoat){const s=ud2.dot(e).clamp().mul(t);this.clearcoatSpecularDirect.addAssign(s.mul(ng({lightDirection:e,f0:kg,f90:Gg,roughness:En2,normalView:ud2})))}s.directDiffuse.addAssign(i.mul($p({diffuseColor:Tn2.rgb}))),s.directSpecular.addAssign(i.mul(ng({lightDirection:e,f0:In2,f90:1,roughness:vn2,iridescence:this.iridescence,f:this.iridescenceFresnel,USE_IRIDESCENCE:this.iridescence,USE_ANISOTROPY:this.anisotropy})))}directRectArea({lightColor:e,lightPosition:t,halfWidth:s,halfHeight:i,reflectedLight:r,ltc_1:n,ltc_2:a}){const o=t.add(s).sub(i),l=t.sub(s).sub(i),h=t.sub(s).add(i),u=t.add(s).add(i),c=ad2,d=Yl2,p=Kl2.toVar(),_=hg({N:c,V:d,roughness:vn2}),m=n.sample(_).toVar(),f=a.sample(_).toVar(),g=pn2(sn2(m.x,0,m.y),sn2(0,1,0),sn2(m.z,0,m.w)).toVar(),y=In2.mul(f.x).add(In2.oneMinus().mul(f.y)).toVar();r.directSpecular.addAssign(e.mul(y).mul(mg({N:c,V:d,P:p,mInv:g,p0:o,p1:l,p2:h,p3:u}))),r.directDiffuse.addAssign(e.mul(Tn2).mul(mg({N:c,V:d,P:p,mInv:pn2(1,0,0,0,1,0,0,0,1),p0:o,p1:l,p2:h,p3:u})))}indirect(e){this.indirectDiffuse(e),this.indirectSpecular(e),this.ambientOcclusion(e)}indirectDiffuse(e){const{irradiance:t,reflectedLight:s}=e.context;s.indirectDiffuse.addAssign(t.mul($p({diffuseColor:Tn2})))}indirectSpecular(e){const{radiance:t,iblIrradiance:s,reflectedLight:i}=e.context;if(!0===this.sheen&&this.sheenSpecularIndirect.addAssign(s.mul(wn2,Og({normal:ad2,viewDir:Yl2,roughness:An2}))),!0===this.clearcoat){const e=ud2.dot(Yl2).clamp(),t=og({dotNV:e,specularColor:kg,specularF90:Gg,roughness:En2});this.clearcoatSpecularIndirect.addAssign(this.clearcoatRadiance.mul(t))}const r=sn2().toVar("singleScattering"),n=sn2().toVar("multiScattering"),a=s.mul(1/Math.PI);this.computeMultiscattering(r,n,Dn2);const o=r.add(n),l=Tn2.mul(o.r.max(o.g).max(o.b).oneMinus());i.indirectSpecular.addAssign(t.mul(r)),i.indirectSpecular.addAssign(n.mul(a)),i.indirectDiffuse.addAssign(l.mul(a))}ambientOcclusion(e){const{ambientOcclusion:t,reflectedLight:s}=e.context,i=ad2.dot(Yl2).clamp().add(t),r=vn2.mul(-16).oneMinus().negate().exp2(),n=t.sub(i.pow(r).oneMinus()).clamp();!0===this.clearcoat&&this.clearcoatSpecularIndirect.mulAssign(t),!0===this.sheen&&this.sheenSpecularIndirect.mulAssign(t),s.indirectDiffuse.mulAssign(t),s.indirectSpecular.mulAssign(n)}finish({context:e}){const{outgoingLight:t}=e;if(!0===this.clearcoat){const e=ud2.dot(Yl2).clamp(),s=Hp({dotVH:e,f0:kg,f90:Gg}),i=t.mul(Sn2.mul(s).oneMinus()).add(this.clearcoatSpecularDirect.add(this.clearcoatSpecularIndirect).mul(Sn2));t.assign(i)}if(!0===this.sheen){const e=wn2.r.max(wn2.g).max(wn2.b).mul(.157).oneMinus(),s=t.mul(e).add(this.sheenSpecularDirect,this.sheenSpecularIndirect);t.assign(s)}}},Hg=Ki2(1),$g=Ki2(-2),Wg=Ki2(.8),qg=Ki2(-1),jg=Ki2(.4),Xg=Ki2(2),Kg=Ki2(.305),Yg=Ki2(3),Qg=Ki2(.21),Zg=Ki2(4),Jg=Ki2(4),em=Ki2(16),tm=Hi2(([e])=>{const t=sn2(oo2(e)).toVar(),s=Ki2(-1).toVar();return qi2(t.x.greaterThan(t.z),()=>{qi2(t.x.greaterThan(t.y),()=>{s.assign(Jo2(e.x.greaterThan(0),0,3))}).Else(()=>{s.assign(Jo2(e.y.greaterThan(0),1,4))})}).Else(()=>{qi2(t.z.greaterThan(t.y),()=>{s.assign(Jo2(e.z.greaterThan(0),2,5))}).Else(()=>{s.assign(Jo2(e.y.greaterThan(0),1,4))})}),s}).setLayout({name:"getFace",type:"float",inputs:[{name:"direction",type:"vec3"}]}),rm=Hi2(([e,t])=>{const s=Ji2().toVar();return qi2(t.equal(0),()=>{s.assign(Ji2(e.z,e.y).div(oo2(e.x)))}).ElseIf(t.equal(1),()=>{s.assign(Ji2(e.x.negate(),e.z.negate()).div(oo2(e.y)))}).ElseIf(t.equal(2),()=>{s.assign(Ji2(e.x.negate(),e.y).div(oo2(e.z)))}).ElseIf(t.equal(3),()=>{s.assign(Ji2(e.z.negate(),e.y).div(oo2(e.x)))}).ElseIf(t.equal(4),()=>{s.assign(Ji2(e.x.negate(),e.z).div(oo2(e.y)))}).Else(()=>{s.assign(Ji2(e.x,e.y).div(oo2(e.z)))}),ha2(.5,s.add(1))}).setLayout({name:"getUV",type:"vec2",inputs:[{name:"direction",type:"vec3"},{name:"face",type:"float"}]}),sm=Hi2(([e])=>{const t=Ki2(0).toVar();return qi2(e.greaterThanEqual(Wg),()=>{t.assign(Hg.sub(e).mul(qg.sub($g)).div(Hg.sub(Wg)).add($g))}).ElseIf(e.greaterThanEqual(jg),()=>{t.assign(Wg.sub(e).mul(Xg.sub(qg)).div(Wg.sub(jg)).add(qg))}).ElseIf(e.greaterThanEqual(Kg),()=>{t.assign(jg.sub(e).mul(Yg.sub(Xg)).div(jg.sub(Kg)).add(Xg))}).ElseIf(e.greaterThanEqual(Qg),()=>{t.assign(Kg.sub(e).mul(Zg.sub(Yg)).div(Kg.sub(Qg)).add(Yg))}).Else(()=>{t.assign(Ki2(-2).mul(Xa2(ha2(1.16,e))))}),t}).setLayout({name:"roughnessToMip",type:"float",inputs:[{name:"roughness",type:"float"}]}),im=Hi2(([e,t])=>{const s=e.toVar();s.assign(ha2(2,s).sub(1));const i=sn2(s,1).toVar();return qi2(t.equal(0),()=>{i.assign(i.zyx)}).ElseIf(t.equal(1),()=>{i.assign(i.xzy),i.xz.mulAssign(-1)}).ElseIf(t.equal(2),()=>{i.x.mulAssign(-1)}).ElseIf(t.equal(3),()=>{i.assign(i.zyx),i.xz.mulAssign(-1)}).ElseIf(t.equal(4),()=>{i.assign(i.xzy),i.xy.mulAssign(-1)}).ElseIf(t.equal(5),()=>{i.z.mulAssign(-1)}),i}).setLayout({name:"getDirection",type:"vec3",inputs:[{name:"uv",type:"vec2"},{name:"face",type:"float"}]}),nm=Hi2(([e,t,s,i,r,n])=>{const a=Ki2(s),o=sn2(t),l=ko2(sm(a),$g,n),h=eo2(l),u=Qa2(l),c=sn2(am(e,o,u,i,r,n)).toVar();return qi2(h.notEqual(0),()=>{const t=sn2(am(e,o,u.add(1),i,r,n)).toVar();c.assign(Oo2(c,t,h))}),c}),am=Hi2(([e,t,s,i,r,n])=>{const a=Ki2(s).toVar(),o=sn2(t),l=Ki2(tm(o)).toVar(),h=Ki2(Eo2(Jg.sub(a),0)).toVar();a.assign(Eo2(a,Jg));const u=Ki2(qa2(a)).toVar(),c=Ji2(rm(o,l).mul(u.sub(2)).add(1)).toVar();return qi2(l.greaterThan(2),()=>{c.y.addAssign(u),l.subAssign(3)}),c.x.addAssign(l.mul(u)),c.x.addAssign(h.mul(ha2(3,em))),c.y.addAssign(ha2(4,qa2(n).sub(u))),c.x.mulAssign(i),c.y.mulAssign(r),e.sample(c).grad(Ji2(),Ji2())}),om=Hi2(({envMap:e,mipInt:t,outputDirection:s,theta:i,axis:r,CUBEUV_TEXEL_WIDTH:n,CUBEUV_TEXEL_HEIGHT:a,CUBEUV_MAX_MIP:o})=>{const l=ro2(i),h=s.mul(l).add(r.cross(s).mul(to2(i))).add(r.mul(r.dot(s).mul(l.oneMinus())));return am(e,h,t,n,a,o)}),um=Hi2(({n:e,latitudinal:t,poleAxis:s,outputDirection:i,weights:r,samples:n,dTheta:a,mipInt:o,envMap:l,CUBEUV_TEXEL_WIDTH:h,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:c})=>{const d=sn2(Jo2(t,s,Po2(s,i))).toVar();qi2(d.equal(sn2(0)),()=>{d.assign(sn2(i.z,0,i.x.negate()))}),d.assign(Ja2(d));const p=sn2().toVar();return p.addAssign(r.element(0).mul(om({theta:0,axis:d,outputDirection:i,mipInt:o,envMap:l,CUBEUV_TEXEL_WIDTH:h,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:c}))),xh2({start:Yi2(1),end:e},({i:e})=>{qi2(e.greaterThanEqual(n),()=>{Th2()});const t=Ki2(a.mul(Ki2(e))).toVar();p.addAssign(r.element(e).mul(om({theta:t.mul(-1),axis:d,outputDirection:i,mipInt:o,envMap:l,CUBEUV_TEXEL_WIDTH:h,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:c}))),p.addAssign(r.element(e).mul(om({theta:t,axis:d,outputDirection:i,mipInt:o,envMap:l,CUBEUV_TEXEL_WIDTH:h,CUBEUV_TEXEL_HEIGHT:u,CUBEUV_MAX_MIP:c})))}),un2(p,1)}),lm=[.125,.215,.35,.446,.526,.582],dm=20,cm=new Fc(-1,1,1,-1,0,1),hm=new Qn(90,1),pm=new $r,gm=null,mm=0,fm=0,ym=(1+Math.sqrt(5))/2,bm=1/ym,xm=[new Qi(-ym,bm,0),new Qi(ym,bm,0),new Qi(-bm,0,ym),new Qi(bm,0,ym),new Qi(0,ym,-bm),new Qi(0,ym,bm),new Qi(-1,1,-1),new Qi(1,1,-1),new Qi(-1,1,1),new Qi(1,1,1)],Tm=new Qi,_m=new WeakMap,vm=[3,1,5,0,4,2],Nm=im(Zu2(),Qu2("faceIndex")).normalize(),Sm=sn2(Nm.x,Nm.y,Nm.z),Em=class{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._lodMeshes=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._backgroundBox=null}get _hasInitialized(){return this._renderer.hasInitialized()}fromScene(e,t=0,s=.1,i=100,r={}){const{size:n=256,position:a=Tm,renderTarget:o=null}=r;if(this._setSize(n),!1===this._hasInitialized){console.warn("THREE.PMREMGenerator: .fromScene() called before the backend is initialized. Try using .fromSceneAsync() instead.");const n=o||this._allocateTarget();return r.renderTarget=n,this.fromSceneAsync(e,t,s,i,r),n}gm=this._renderer.getRenderTarget(),mm=this._renderer.getActiveCubeFace(),fm=this._renderer.getActiveMipmapLevel();const l=o||this._allocateTarget();return l.depthBuffer=!0,this._init(l),this._sceneToCubeUV(e,s,i,l,a),t>0&&this._blur(l,0,0,t),this._applyPMREM(l),this._cleanup(l),l}async fromSceneAsync(e,t=0,s=.1,i=100,r={}){return!1===this._hasInitialized&&await this._renderer.init(),this.fromScene(e,t,s,i,r)}fromEquirectangular(e,t=null){if(!1===this._hasInitialized){console.warn("THREE.PMREMGenerator: .fromEquirectangular() called before the backend is initialized. Try using .fromEquirectangularAsync() instead."),this._setSizeFromTexture(e);const s=t||this._allocateTarget();return this.fromEquirectangularAsync(e,s),s}return this._fromTexture(e,t)}async fromEquirectangularAsync(e,t=null){return!1===this._hasInitialized&&await this._renderer.init(),this._fromTexture(e,t)}fromCubemap(e,t=null){if(!1===this._hasInitialized){console.warn("THREE.PMREMGenerator: .fromCubemap() called before the backend is initialized. Try using .fromCubemapAsync() instead."),this._setSizeFromTexture(e);const s=t||this._allocateTarget();return this.fromCubemapAsync(e,t),s}return this._fromTexture(e,t)}async fromCubemapAsync(e,t=null){return!1===this._hasInitialized&&await this._renderer.init(),this._fromTexture(e,t)}async compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=Cm(),await this._compileMaterial(this._cubemapMaterial))}async compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=Mm(),await this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose(),null!==this._backgroundBox&&(this._backgroundBox.geometry.dispose(),this._backgroundBox.material.dispose())}_setSizeFromTexture(e){e.mapping===ht||e.mapping===lt?this._setSize(0===e.image.length?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4)}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodPlanes.length;e++)this._lodPlanes[e].dispose()}_cleanup(e){this._renderer.setRenderTarget(gm,mm,fm),e.scissorTest=!1,Am(e,0,0,e.width,e.height)}_fromTexture(e,t){this._setSizeFromTexture(e),gm=this._renderer.getRenderTarget(),mm=this._renderer.getActiveCubeFace(),fm=this._renderer.getActiveMipmapLevel();const s=t||this._allocateTarget();return this._init(s),this._textureToCubeUV(e,s),this._applyPMREM(s),this._cleanup(s),s}_allocateTarget(){return wm(3*Math.max(this._cubeSize,112),4*this._cubeSize)}_init(e){if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==e.width||this._pingPongRenderTarget.height!==e.height){null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=wm(e.width,e.height);const{_lodMax:t}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas,lodMeshes:this._lodMeshes}=function(e){const t=[],s=[],i=[],r=[];let n=e;const a=e-4+1+lm.length;for(let o=0;o<a;o++){const a=Math.pow(2,n);s.push(a);let l=1/a;o>e-4?l=lm[o-e+4-1]:0===o&&(l=0),i.push(l);const h=1/(a-2),u=-h,c=1+h,d=[u,u,c,u,c,c,u,u,c,c,u,c],p=6,_=6,m=3,f=2,g=1,y=new Float32Array(m*_*p),S=new Float32Array(f*_*p),T=new Float32Array(g*_*p);for(let e=0;e<p;e++){const t=e%3*2/3-1,s=e>2?0:-1,i=[t,s,0,t+2/3,s,0,t+2/3,s+1,0,t,s,0,t+2/3,s+1,0,t,s+1,0],r=vm[e];y.set(i,m*_*r),S.set(d,f*_*r);const n=[r,r,r,r,r,r];T.set(n,g*_*r)}const x=new Cn;x.setAttribute("position",new un(y,m)),x.setAttribute("uv",new un(S,f)),x.setAttribute("faceIndex",new un(T,g)),t.push(x),r.push(new jn(x,null)),n>4&&n--}return{lodPlanes:t,sizeLods:s,sigmas:i,lodMeshes:r}}(t)),this._blurMaterial=function(e,t,s){const i=hl2(new Array(dm).fill(0)),r=ta2(new Qi(0,1,0)),n=ta2(0),a=Ki2(dm),o=ta2(0),l=ta2(1),h=al2(null),u=ta2(0),c=Ki2(1/t),d=Ki2(1/s),p=Ki2(e),_={n:a,latitudinal:o,weights:i,poleAxis:r,outputDirection:Sm,dTheta:n,samples:l,envMap:h,mipInt:u,CUBEUV_TEXEL_WIDTH:c,CUBEUV_TEXEL_HEIGHT:d,CUBEUV_MAX_MIP:p},m=Rm("blur");return m.fragmentNode=um({..._,latitudinal:o.equal(1)}),_m.set(m,_),m}(t,e.width,e.height)}}async _compileMaterial(e){const t=new jn(this._lodPlanes[0],e);await this._renderer.compile(t,cm)}_sceneToCubeUV(e,t,s,i,r){const n=hm;n.near=t,n.far=s;const a=[1,1,1,1,-1,1],o=[1,-1,1,-1,1,-1],l=this._renderer,h=l.autoClear;l.getClearColor(pm),l.autoClear=!1;let u=this._backgroundBox;if(null===u){const e=new en({name:"PMREM.Background",side:d2,depthWrite:!1,depthTest:!1});u=new jn(new Dn,e)}let c=!1;const d=e.background;d?d.isColor&&(u.material.color.copy(d),e.background=null,c=!0):(u.material.color.copy(pm),c=!0),l.setRenderTarget(i),l.clear(),c&&l.render(u,n);for(let t=0;t<6;t++){const s=t%3;0===s?(n.up.set(0,a[t],0),n.position.set(r.x,r.y,r.z),n.lookAt(r.x+o[t],r.y,r.z)):1===s?(n.up.set(0,0,a[t]),n.position.set(r.x,r.y,r.z),n.lookAt(r.x,r.y+o[t],r.z)):(n.up.set(0,a[t],0),n.position.set(r.x,r.y,r.z),n.lookAt(r.x,r.y,r.z+o[t]));const h=this._cubeSize;Am(i,s*h,t>2?h:0,h,h),l.render(e,n)}l.autoClear=h,e.background=d}_textureToCubeUV(e,t){const s=this._renderer,i=e.mapping===ht||e.mapping===lt;i?null===this._cubemapMaterial&&(this._cubemapMaterial=Cm(e)):null===this._equirectMaterial&&(this._equirectMaterial=Mm(e));const r=i?this._cubemapMaterial:this._equirectMaterial;r.fragmentNode.value=e;const n=this._lodMeshes[0];n.material=r;const a=this._cubeSize;Am(t,0,0,3*a,2*a),s.setRenderTarget(t),s.render(n,cm)}_applyPMREM(e){const t=this._renderer,s=t.autoClear;t.autoClear=!1;const i=this._lodPlanes.length;for(let t=1;t<i;t++){const s=Math.sqrt(this._sigmas[t]*this._sigmas[t]-this._sigmas[t-1]*this._sigmas[t-1]),r=xm[(i-t-1)%xm.length];this._blur(e,t-1,t,s,r)}t.autoClear=s}_blur(e,t,s,i,r){const n=this._pingPongRenderTarget;this._halfBlur(e,n,t,s,i,"latitudinal",r),this._halfBlur(n,e,s,s,i,"longitudinal",r)}_halfBlur(e,t,s,i,r,n,a){const o=this._renderer,l=this._blurMaterial;"latitudinal"!==n&&"longitudinal"!==n&&console.error("blur direction must be either latitudinal or longitudinal!");const h=this._lodMeshes[i];h.material=l;const u=_m.get(l),c=this._sizeLods[s]-1,d=isFinite(r)?Math.PI/(2*c):2*Math.PI/39,p=r/d,_=isFinite(r)?1+Math.floor(3*p):dm;_>dm&&console.warn(`sigmaRadians, ${r}, is too large and will clip, as it requested ${_} samples when the maximum is set to 20`);const m=[];let f=0;for(let e=0;e<dm;++e){const t=e/p,s=Math.exp(-t*t/2);m.push(s),0===e?f+=s:e<_&&(f+=2*s)}for(let e=0;e<m.length;e++)m[e]=m[e]/f;e.texture.frame=(e.texture.frame||0)+1,u.envMap.value=e.texture,u.samples.value=_,u.weights.array=m,u.latitudinal.value="latitudinal"===n?1:0,a&&(u.poleAxis.value=a);const{_lodMax:g}=this;u.dTheta.value=d,u.mipInt.value=g-s;const y=this._sizeLods[i];Am(t,3*y*(i>g-4?i-g+4:0),4*(this._cubeSize-y),3*y,2*y),o.setRenderTarget(t),o.render(h,cm)}};function wm(e,t){const s=new Ts(e,t,{magFilter:wt,minFilter:wt,generateMipmaps:!1,type:Rt,format:jt,colorSpace:Ze});return s.texture.mapping=dt,s.texture.name="PMREM.cubeUv",s.texture.isPMREMTexture=!0,s.scissorTest=!0,s}function Am(e,t,s,i,r){e.viewport.set(t,s,i,r),e.scissor.set(t,s,i,r)}function Rm(e){const t=new yp;return t.depthTest=!1,t.depthWrite=!1,t.blending=m,t.name=`PMREM_${e}`,t}function Cm(e){const t=Rm("cubemap");return t.fragmentNode=wd2(e,Sm),t}function Mm(e){const t=Rm("equirect");return t.fragmentNode=al2(e,Mp(Sm),0),t}var Pm=new WeakMap;function Bm(e,t,s){const i=function(e){let t=Pm.get(e);return void 0===t&&(t=new WeakMap,Pm.set(e,t)),t}(t);let r=i.get(e);if((void 0!==r?r.pmremVersion:-1)!==e.pmremVersion){const t=e.image;if(e.isCubeTexture){if(!function(e){if(null==e)return!1;let t=0;for(let s=0;s<6;s++)void 0!==e[s]&&t++;return 6===t}(t))return null;r=s.fromCubemap(e,r)}else{if(!(null!=(n=t)&&n.height>0))return null;r=s.fromEquirectangular(e,r)}r.pmremVersion=e.pmremVersion,i.set(e,r)}var n;return r.texture}var Lm=class extends Ys2{static get type(){return"PMREMNode"}constructor(e,t=null,s=null){super("vec3"),this._value=e,this._pmrem=null,this.uvNode=t,this.levelNode=s,this._generator=null;const i=new _s;i.isRenderTargetTexture=!0,this._texture=al2(i),this._width=ta2(0),this._height=ta2(0),this._maxMip=ta2(0),this.updateBeforeType=Us2.RENDER}set value(e){this._value=e,this._pmrem=null}get value(){return this._value}updateFromTexture(e){const t=function(e){const t=Math.log2(e)-2,s=1/e;return{texelWidth:1/(3*Math.max(Math.pow(2,t),112)),texelHeight:s,maxMip:t}}(e.image.height);this._texture.value=e,this._width.value=t.texelWidth,this._height.value=t.texelHeight,this._maxMip.value=t.maxMip}updateBefore(e){let t=this._pmrem;const s=t?t.pmremVersion:-1,i=this._value;s!==i.pmremVersion&&(t=!0===i.isPMREMTexture?i:Bm(i,e.renderer,this._generator),null!==t&&(this._pmrem=t,this.updateFromTexture(t)))}setup(e){null===this._generator&&(this._generator=new Em(e.renderer)),this.updateBefore(e);let t=this.uvNode;null===t&&e.context.getUV&&(t=e.context.getUV(this)),t=bd2.mul(sn2(t.x,t.y.negate(),t.z));let s=this.levelNode;return null===s&&e.context.getTextureLevel&&(s=e.context.getTextureLevel(this)),nm(this._texture,t,s,this._width,this._height,this._maxMip)}dispose(){super.dispose(),null!==this._generator&&this._generator.dispose()}},Fm=Oi2(Lm).setParameterLength(1,3),Im=new WeakMap,Dm=class extends wh2{static get type(){return"EnvironmentNode"}constructor(e=null){super(),this.envNode=e}setup(e){const{material:t}=e;let s=this.envNode;if(s.isTextureNode||s.isMaterialReferenceNode){const e=s.isTextureNode?s.value:t[s.property];let i=Im.get(e);void 0===i&&(i=Fm(e),Im.set(e,i)),s=i}const i=!0===t.useAnisotropy||t.anisotropy>0?ic2:ad2,r=s.context(Vm(vn2,i)).mul(yd2),n=s.context(Um(od2)).mul(Math.PI).mul(yd2),a=Vu(r),o=Vu(n);e.context.radiance.addAssign(a),e.context.iblIrradiance.addAssign(o);const l=e.context.lightingModel.clearcoatRadiance;if(l){const e=s.context(Vm(En2,ud2)).mul(yd2),t=Vu(e);l.addAssign(t)}}},Vm=(e,t)=>{let s=null;return{getUV:()=>(null===s&&(s=Yl2.negate().reflect(t),s=e.mul(e).mix(s,t).normalize(),s=s.transformDirection(xl2)),s),getTextureLevel:()=>e}},Um=e=>({getUV:()=>e,getTextureLevel:()=>Ki2(1)}),Om=new Ol,km=class extends yp{static get type(){return"MeshStandardNodeMaterial"}constructor(e){super(),this.isMeshStandardNodeMaterial=!0,this.lights=!0,this.emissiveNode=null,this.metalnessNode=null,this.roughnessNode=null,this.setDefaultValues(Om),this.setValues(e)}setupEnvironment(e){let t=super.setupEnvironment(e);return null===t&&e.environmentNode&&(t=e.environmentNode),t?new Dm(t):null}setupLightingModel(){return new zg}setupSpecular(){const e=Oo2(sn2(.04),Tn2.rgb,Nn2);In2.assign(e),Dn2.assign(1)}setupVariants(){const e=this.metalnessNode?Ki2(this.metalnessNode):Sc2;Nn2.assign(e);let t=this.roughnessNode?Ki2(this.roughnessNode):Nc2;t=Jp({roughness:t}),vn2.assign(t),this.setupSpecular(),Tn2.assign(un2(Tn2.rgb.mul(e.oneMinus()),Tn2.a))}copy(e){return this.emissiveNode=e.emissiveNode,this.metalnessNode=e.metalnessNode,this.roughnessNode=e.roughnessNode,super.copy(e)}},Gm=new Nl,zm=class extends km{static get type(){return"MeshPhysicalNodeMaterial"}constructor(e){super(),this.isMeshPhysicalNodeMaterial=!0,this.clearcoatNode=null,this.clearcoatRoughnessNode=null,this.clearcoatNormalNode=null,this.sheenNode=null,this.sheenRoughnessNode=null,this.iridescenceNode=null,this.iridescenceIORNode=null,this.iridescenceThicknessNode=null,this.specularIntensityNode=null,this.specularColorNode=null,this.iorNode=null,this.transmissionNode=null,this.thicknessNode=null,this.attenuationDistanceNode=null,this.attenuationColorNode=null,this.dispersionNode=null,this.anisotropyNode=null,this.setDefaultValues(Gm),this.setValues(e)}get useClearcoat(){return this.clearcoat>0||null!==this.clearcoatNode}get useIridescence(){return this.iridescence>0||null!==this.iridescenceNode}get useSheen(){return this.sheen>0||null!==this.sheenNode}get useAnisotropy(){return this.anisotropy>0||null!==this.anisotropyNode}get useTransmission(){return this.transmission>0||null!==this.transmissionNode}get useDispersion(){return this.dispersion>0||null!==this.dispersionNode}setupSpecular(){const e=this.iorNode?Ki2(this.iorNode):Uc2;zn2.assign(e),In2.assign(Oo2(So2(Lo2(zn2.sub(1).div(zn2.add(1))).mul(Tc2),sn2(1)).mul(xc2),Tn2.rgb,Nn2)),Dn2.assign(Oo2(xc2,1,Nn2))}setupLightingModel(){return new zg(this.useClearcoat,this.useSheen,this.useIridescence,this.useAnisotropy,this.useTransmission,this.useDispersion)}setupVariants(e){if(super.setupVariants(e),this.useClearcoat){const e=this.clearcoatNode?Ki2(this.clearcoatNode):wc2,t=this.clearcoatRoughnessNode?Ki2(this.clearcoatRoughnessNode):Ac2;Sn2.assign(e),En2.assign(Jp({roughness:t}))}if(this.useSheen){const e=this.sheenNode?sn2(this.sheenNode):Mc2,t=this.sheenRoughnessNode?Ki2(this.sheenRoughnessNode):Pc2;wn2.assign(e),An2.assign(t)}if(this.useIridescence){const e=this.iridescenceNode?Ki2(this.iridescenceNode):Lc2,t=this.iridescenceIORNode?Ki2(this.iridescenceIORNode):Fc2,s=this.iridescenceThicknessNode?Ki2(this.iridescenceThicknessNode):Ic2;Rn2.assign(e),Cn2.assign(t),Mn2.assign(s)}if(this.useAnisotropy){const e=(this.anisotropyNode?Ji2(this.anisotropyNode):Bc2).toVar();Bn2.assign(e.length()),qi2(Bn2.equal(0),()=>{e.assign(Ji2(1,0))}).Else(()=>{e.divAssign(Ji2(Bn2)),Bn2.assign(Bn2.saturate())}),Pn2.assign(Bn2.pow2().mix(vn2.pow2(),1)),Ln2.assign(rc2[0].mul(e.x).add(rc2[1].mul(e.y))),Fn2.assign(rc2[1].mul(e.x).sub(rc2[0].mul(e.y)))}if(this.useTransmission){const e=this.transmissionNode?Ki2(this.transmissionNode):Dc2,t=this.thicknessNode?Ki2(this.thicknessNode):Vc2,s=this.attenuationDistanceNode?Ki2(this.attenuationDistanceNode):Oc2,i=this.attenuationColorNode?sn2(this.attenuationColorNode):kc2;if(Hn.assign(e),$n2.assign(t),Wn2.assign(s),qn.assign(i),this.useDispersion){const e=this.dispersionNode?Ki2(this.dispersionNode):jc2;jn2.assign(e)}}}setupClearcoatNormal(){return this.clearcoatNormalNode?sn2(this.clearcoatNormalNode):Rc2}setup(e){e.context.setupClearcoatNormal=()=>cu2(this.setupClearcoatNormal(e),"NORMAL","vec3"),super.setup(e)}copy(e){return this.clearcoatNode=e.clearcoatNode,this.clearcoatRoughnessNode=e.clearcoatRoughnessNode,this.clearcoatNormalNode=e.clearcoatNormalNode,this.sheenNode=e.sheenNode,this.sheenRoughnessNode=e.sheenRoughnessNode,this.iridescenceNode=e.iridescenceNode,this.iridescenceIORNode=e.iridescenceIORNode,this.iridescenceThicknessNode=e.iridescenceThicknessNode,this.specularIntensityNode=e.specularIntensityNode,this.specularColorNode=e.specularColorNode,this.transmissionNode=e.transmissionNode,this.thicknessNode=e.thicknessNode,this.attenuationDistanceNode=e.attenuationDistanceNode,this.attenuationColorNode=e.attenuationColorNode,this.dispersionNode=e.dispersionNode,this.anisotropyNode=e.anisotropyNode,super.copy(e)}},Wm=Hi2(({normal:e,lightDirection:t,builder:s})=>{const i=e.dot(t),r=Ji2(i.mul(.5).add(.5),0);if(s.material.gradientMap){const e=Bd2("gradientMap","texture").context({getUV:()=>r});return sn2(e.r)}{const e=r.fwidth().mul(.5);return Oo2(sn2(.7),sn2(1),Ho2(Ki2(.7).sub(e.x),Ki2(.7).add(e.x),r.x))}}),qm=class extends Op{direct({lightDirection:e,lightColor:t,reflectedLight:s},i){const r=Wm({normal:td2,lightDirection:e,builder:i}).mul(t);s.directDiffuse.addAssign(r.mul($p({diffuseColor:Tn2.rgb})))}indirect(e){const{ambientOcclusion:t,irradiance:s,reflectedLight:i}=e.context;i.indirectDiffuse.addAssign(s.mul($p({diffuseColor:Tn2}))),i.indirectDiffuse.mulAssign(t)}},jm=new Fl,Xm=class extends yp{static get type(){return"MeshToonNodeMaterial"}constructor(e){super(),this.isMeshToonNodeMaterial=!0,this.lights=!0,this.setDefaultValues(jm),this.setValues(e)}setupLightingModel(){return new qm}},Km=Hi2(()=>{const e=sn2(Yl2.z,0,Yl2.x.negate()).normalize(),t=Yl2.cross(e);return Ji2(e.dot(ad2),t.dot(ad2)).mul(.495).add(.5)}).once(["NORMAL","VERTEX"])().toVar("matcapUV"),Ym=new Ul,Qm=class extends yp{static get type(){return"MeshMatcapNodeMaterial"}constructor(e){super(),this.isMeshMatcapNodeMaterial=!0,this.setDefaultValues(Ym),this.setValues(e)}setupVariants(e){const t=Km;let s;s=e.material.matcap?Bd2("matcap","texture").context({getUV:()=>t}):sn2(Oo2(.2,.8,t.y)),Tn2.rgb.mulAssign(s.rgb)}},Zm=class extends Ys2{static get type(){return"RotateNode"}constructor(e,t){super(),this.positionNode=e,this.rotationNode=t}getNodeType(e){return this.positionNode.getNodeType(e)}setup(e){const{rotationNode:t,positionNode:s}=this;if("vec2"===this.getNodeType(e)){const e=t.cos(),i=t.sin();return hn2(e,i,i.negate(),e).mul(s)}{const e=t,i=gn2(un2(1,0,0,0),un2(0,ro2(e.x),to2(e.x).negate(),0),un2(0,to2(e.x),ro2(e.x),0),un2(0,0,0,1)),r=gn2(un2(ro2(e.y),0,to2(e.y),0),un2(0,1,0,0),un2(to2(e.y).negate(),0,ro2(e.y),0),un2(0,0,0,1)),n=gn2(un2(ro2(e.z),to2(e.z).negate(),0,0),un2(to2(e.z),ro2(e.z),0,0),un2(0,0,1,0),un2(0,0,0,1));return i.mul(r).mul(n).mul(un2(s,1)).xyz}}},Jm=Oi2(Zm).setParameterLength(2),ef=new da,tf=class extends yp{static get type(){return"SpriteNodeMaterial"}constructor(e){super(),this.isSpriteNodeMaterial=!0,this._useSizeAttenuation=!0,this.positionNode=null,this.rotationNode=null,this.scaleNode=null,this.transparent=!0,this.setDefaultValues(ef),this.setValues(e)}setupPositionView(e){const{object:t,camera:s}=e,i=this.sizeAttenuation,{positionNode:r,rotationNode:n,scaleNode:a}=this,o=kl2.mul(sn2(r||0));let l=Ji2(Ll2[0].xyz.length(),Ll2[1].xyz.length());if(null!==a&&(l=l.mul(Ji2(a))),!1===i)if(s.isPerspectiveCamera)l=l.mul(o.z.negate());else{const e=Ki2(2).div(yl2.element(1).element(1));l=l.mul(e.mul(2))}let h=$l2.xy;if(t.center&&!0===t.center.isVector2){const e=Ii2(new vu2("center","vec2",t));h=h.sub(e.sub(.5))}h=h.mul(l);const u=Ki2(n||Cc2),c=Jm(h,u);return un2(o.xy.add(c),o.zw)}copy(e){return this.positionNode=e.positionNode,this.rotationNode=e.rotationNode,this.scaleNode=e.scaleNode,super.copy(e)}get sizeAttenuation(){return this._useSizeAttenuation}set sizeAttenuation(e){this._useSizeAttenuation!==e&&(this._useSizeAttenuation=e,this.needsUpdate=!0)}},rf=new Jo,sf=class extends tf{static get type(){return"PointsNodeMaterial"}constructor(e){super(),this.sizeNode=null,this.isPointsNodeMaterial=!0,this.setDefaultValues(rf),this.setValues(e)}setupPositionView(){const{positionNode:e}=this;return kl2.mul(sn2(e||Wl2)).xyz}setupVertex(e){const t=super.setupVertex(e);if(!0!==e.material.isNodeMaterial)return t;const{rotationNode:s,scaleNode:i,sizeNode:r}=this,n=$l2.xy.toVar(),a=Vh2.z.div(Vh2.w);if(s&&s.isNode){const e=Ki2(s);n.assign(Jm(n,e))}let o=null!==r?Ji2(r):qc2;return!0===this.sizeAttenuation&&(o=o.mul(o.div(Kl2.z.negate()))),i&&i.isNode&&(o=o.mul(Ji2(i))),n.mulAssign(o.mul(2)),n.assign(n.div(Vh2.z)),n.y.assign(n.y.mul(a)),n.assign(n.mul(t.w)),t.addAssign(un2(n,0,0)),t}get alphaToCoverage(){return this._useAlphaToCoverage}set alphaToCoverage(e){this._useAlphaToCoverage!==e&&(this._useAlphaToCoverage=e,this.needsUpdate=!0)}},nf=class extends Op{constructor(){super(),this.shadowNode=Ki2(1).toVar("shadowMask")}direct({lightNode:e}){null!==e.shadowNode&&this.shadowNode.mulAssign(e.shadowNode)}finish({context:e}){Tn2.a.mulAssign(this.shadowNode.oneMinus()),e.outgoingLight.rgb.assign(Tn2.rgb)}},af=new Rl,of=class extends yp{static get type(){return"ShadowNodeMaterial"}constructor(e){super(),this.isShadowNodeMaterial=!0,this.lights=!0,this.transparent=!0,this.setDefaultValues(af),this.setValues(e)}setupLightingModel(){return new nf}},uf=bn2("vec3"),lf=bn2("vec3"),df=bn2("vec3"),pf=class{constructor(e,t){this.nodes=e,this.info=t,this._context="undefined"!=typeof self?self:null,this._animationLoop=null,this._requestId=null}start(){const e=(t,s)=>{this._requestId=this._context.requestAnimationFrame(e),!0===this.info.autoReset&&this.info.reset(),this.nodes.nodeFrame.update(),this.info.frame=this.nodes.nodeFrame.frameId,null!==this._animationLoop&&this._animationLoop(t,s)};e()}stop(){this._context.cancelAnimationFrame(this._requestId),this._requestId=null}getAnimationLoop(){return this._animationLoop}setAnimationLoop(e){this._animationLoop=e}getContext(){return this._context}setContext(e){this._context=e}dispose(){this.stop()}},gf=class{constructor(){this.weakMap=new WeakMap}get(e){let t=this.weakMap;for(let s=0;s<e.length-1;s++)if(t=t.get(e[s]),void 0===t)return;return t.get(e[e.length-1])}set(e,t){let s=this.weakMap;for(let t=0;t<e.length-1;t++){const i=e[t];!1===s.has(i)&&s.set(i,new WeakMap),s=s.get(i)}return s.set(e[e.length-1],t),this}delete(e){let t=this.weakMap;for(let s=0;s<e.length-1;s++)if(t=t.get(e[s]),void 0===t)return!1;return t.delete(e[e.length-1])}},mf=0,ff=class{constructor(e,t,s,i,r,n,a,o,l,h){this.id=mf++,this._nodes=e,this._geometries=t,this.renderer=s,this.object=i,this.material=r,this.scene=n,this.camera=a,this.lightsNode=o,this.context=l,this.geometry=i.geometry,this.version=r.version,this.drawRange=null,this.attributes=null,this.attributesId=null,this.pipeline=null,this.group=null,this.vertexBuffers=null,this.drawParams=null,this.bundle=null,this.clippingContext=h,this.clippingContextCacheKey=null!==h?h.cacheKey:"",this.initialNodesCacheKey=this.getDynamicCacheKey(),this.initialCacheKey=this.getCacheKey(),this._nodeBuilderState=null,this._bindings=null,this._monitor=null,this.onDispose=null,this.isRenderObject=!0,this.onMaterialDispose=()=>{this.dispose()},this.onGeometryDispose=()=>{this.attributes=null,this.attributesId=null},this.material.addEventListener("dispose",this.onMaterialDispose),this.geometry.addEventListener("dispose",this.onGeometryDispose)}updateClipping(e){this.clippingContext=e}get clippingNeedsUpdate(){return null!==this.clippingContext&&this.clippingContext.cacheKey!==this.clippingContextCacheKey&&(this.clippingContextCacheKey=this.clippingContext.cacheKey,!0)}get hardwareClippingPlanes(){return!0===this.material.hardwareClipping?this.clippingContext.unionClippingCount:0}getNodeBuilderState(){return this._nodeBuilderState||(this._nodeBuilderState=this._nodes.getForRender(this))}getMonitor(){return this._monitor||(this._monitor=this.getNodeBuilderState().observer)}getBindings(){return this._bindings||(this._bindings=this.getNodeBuilderState().createBindings())}getBindingGroup(e){for(const t of this.getBindings())if(t.name===e)return t}getIndex(){return this._geometries.getIndex(this)}getIndirect(){return this._geometries.getIndirect(this)}getChainArray(){return[this.object,this.material,this.context,this.lightsNode]}setGeometry(e){this.geometry=e,this.attributes=null,this.attributesId=null}getAttributes(){if(null!==this.attributes)return this.attributes;const e=this.getNodeBuilderState().nodeAttributes,t=this.geometry,s=[],i=new Set,r={};for(const n of e){let e;if(n.node&&n.node.attribute?e=n.node.attribute:(e=t.getAttribute(n.name),r[n.name]=e.version),void 0===e)continue;s.push(e);const a=e.isInterleavedBufferAttribute?e.data:e;i.add(a)}return this.attributes=s,this.attributesId=r,this.vertexBuffers=Array.from(i.values()),s}getVertexBuffers(){return null===this.vertexBuffers&&this.getAttributes(),this.vertexBuffers}getDrawParameters(){const{object:e,material:t,geometry:s,group:i,drawRange:r}=this,n=this.drawParams||(this.drawParams={vertexCount:0,firstVertex:0,instanceCount:0,firstInstance:0}),a=this.getIndex(),o=null!==a;let l=1;if(!0===s.isInstancedBufferGeometry?l=s.instanceCount:void 0!==e.count&&(l=Math.max(0,e.count)),0===l)return null;if(n.instanceCount=l,!0===e.isBatchedMesh)return n;let h=1;!0!==t.wireframe||e.isPoints||e.isLineSegments||e.isLine||e.isLineLoop||(h=2);let u=r.start*h,c=(r.start+r.count)*h;null!==i&&(u=Math.max(u,i.start*h),c=Math.min(c,(i.start+i.count)*h));const d=s.attributes.position;let p=1/0;o?p=a.count:null!=d&&(p=d.count),u=Math.max(u,0),c=Math.min(c,p);const _=c-u;return _<0||_===1/0?null:(n.vertexCount=_,n.firstVertex=u,n)}getGeometryCacheKey(){const{geometry:e}=this;let t="";for(const s of Object.keys(e.attributes).sort()){const i=e.attributes[s];t+=s+",",i.data&&(t+=i.data.stride+","),i.offset&&(t+=i.offset+","),i.itemSize&&(t+=i.itemSize+","),i.normalized&&(t+="n,")}for(const s of Object.keys(e.morphAttributes).sort()){const i=e.morphAttributes[s];t+="morph-"+s+",";for(let e=0,s=i.length;e<s;e++)t+=i[e].id+","}return e.index&&(t+="index,"),t}getMaterialCacheKey(){const{object:e,material:t}=this;let s=t.customProgramCacheKey();for(const e of function(e){const t=Object.keys(e);let s=Object.getPrototypeOf(e);for(;s;){const e=Object.getOwnPropertyDescriptors(s);for(const s in e)if(void 0!==e[s]){const i=e[s];i&&"function"==typeof i.get&&t.push(s)}s=Object.getPrototypeOf(s)}return t}(t)){if(/^(is[A-Z]|_)|^(visible|version|uuid|name|opacity|userData)$/.test(e))continue;const i=t[e];let r;if(null!==i){const e=typeof i;"number"===e?r=0!==i?"1":"0":"object"===e?(r="{",i.isTexture&&(r+=i.mapping),r+="}"):r=String(i)}else r=String(i);s+=r+","}return s+=this.clippingContextCacheKey+",",e.geometry&&(s+=this.getGeometryCacheKey()),e.skeleton&&(s+=e.skeleton.bones.length+","),e.isBatchedMesh&&(s+=e._matricesTexture.uuid+",",null!==e._colorsTexture&&(s+=e._colorsTexture.uuid+",")),e.count>1&&(s+=e.uuid+","),s+=e.receiveShadow+",",xs2(s)}get needsGeometryUpdate(){if(this.geometry.id!==this.object.geometry.id)return!0;if(null!==this.attributes){const e=this.attributesId;for(const t in e){const s=this.geometry.getAttribute(t);if(void 0===s||e[t]!==s.id)return!0}}return!1}get needsUpdate(){return this.initialNodesCacheKey!==this.getDynamicCacheKey()||this.clippingNeedsUpdate}getDynamicCacheKey(){let e=0;return!0!==this.material.isShadowPassMaterial&&(e=this._nodes.getCacheKey(this.scene,this.lightsNode)),this.camera.isArrayCamera&&(e=_s2(e,this.camera.cameras.length)),this.object.receiveShadow&&(e=_s2(e,1)),e}getCacheKey(){return this.getMaterialCacheKey()+this.getDynamicCacheKey()}dispose(){this.material.removeEventListener("dispose",this.onMaterialDispose),this.geometry.removeEventListener("dispose",this.onGeometryDispose),this.onDispose()}},yf=[],bf=class{constructor(e,t,s,i,r,n){this.renderer=e,this.nodes=t,this.geometries=s,this.pipelines=i,this.bindings=r,this.info=n,this.chainMaps={}}get(e,t,s,i,r,n,a,o){const l=this.getChainMap(o);yf[0]=e,yf[1]=t,yf[2]=n,yf[3]=r;let h=l.get(yf);return void 0===h?(h=this.createRenderObject(this.nodes,this.geometries,this.renderer,e,t,s,i,r,n,a,o),l.set(yf,h)):(h.updateClipping(a),h.needsGeometryUpdate&&h.setGeometry(e.geometry),(h.version!==t.version||h.needsUpdate)&&(h.initialCacheKey!==h.getCacheKey()?(h.dispose(),h=this.get(e,t,s,i,r,n,a,o)):h.version=t.version)),yf.length=0,h}getChainMap(e="default"){return this.chainMaps[e]||(this.chainMaps[e]=new gf)}dispose(){this.chainMaps={}}createRenderObject(e,t,s,i,r,n,a,o,l,h,u){const c=this.getChainMap(u),d=new ff(e,t,s,i,r,n,a,o,l,h);return d.onDispose=()=>{this.pipelines.delete(d),this.bindings.delete(d),this.nodes.delete(d),c.delete(d.getChainArray())},d}},xf=class{constructor(){this.data=new WeakMap}get(e){let t=this.data.get(e);return void 0===t&&(t={},this.data.set(e,t)),t}delete(e){let t=null;return this.data.has(e)&&(t=this.data.get(e),this.data.delete(e)),t}has(e){return this.data.has(e)}dispose(){this.data=new WeakMap}},Tf=1,_f=2,vf=3,Nf=4,Sf=16,Ef=class extends xf{constructor(e){super(),this.backend=e}delete(e){const t=super.delete(e);return null!==t&&this.backend.destroyAttribute(e),t}update(e,t){const s=this.get(e);if(void 0===s.version)t===Tf?this.backend.createAttribute(e):t===_f?this.backend.createIndexAttribute(e):t===vf?this.backend.createStorageAttribute(e):t===Nf&&this.backend.createIndirectStorageAttribute(e),s.version=this._getBufferAttribute(e).version;else{const t=this._getBufferAttribute(e);(s.version<t.version||t.usage===Si)&&(this.backend.updateAttribute(e),s.version=t.version)}}_getBufferAttribute(e){return e.isInterleavedBufferAttribute&&(e=e.data),e}};function wf(e){return null!==e.index?e.index.version:e.attributes.position.version}function Af(e){const t=[],s=e.index,i=e.attributes.position;if(null!==s){const e=s.array;for(let s=0,i=e.length;s<i;s+=3){const i=e[s+0],r=e[s+1],n=e[s+2];t.push(i,r,r,n,n,i)}}else for(let e=0,s=i.array.length/3-1;e<s;e+=3){const s=e+0,i=e+1,r=e+2;t.push(s,i,i,r,r,s)}const r=new(ss(t)?xn:gn)(t,1);return r.version=wf(e),r}var Rf=class extends xf{constructor(e,t){super(),this.attributes=e,this.info=t,this.wireframes=new WeakMap,this.attributeCall=new WeakMap}has(e){const t=e.geometry;return super.has(t)&&!0===this.get(t).initialized}updateForRender(e){!1===this.has(e)&&this.initGeometry(e),this.updateAttributes(e)}initGeometry(e){const t=e.geometry;this.get(t).initialized=!0,this.info.memory.geometries++;const s=()=>{this.info.memory.geometries--;const i=t.index,r=e.getAttributes();null!==i&&this.attributes.delete(i);for(const e of r)this.attributes.delete(e);const n=this.wireframes.get(t);void 0!==n&&this.attributes.delete(n),t.removeEventListener("dispose",s)};t.addEventListener("dispose",s)}updateAttributes(e){const t=e.getAttributes();for(const e of t)e.isStorageBufferAttribute||e.isStorageInstancedBufferAttribute?this.updateAttribute(e,vf):this.updateAttribute(e,Tf);const s=this.getIndex(e);null!==s&&this.updateAttribute(s,_f);const i=e.geometry.indirect;null!==i&&this.updateAttribute(i,Nf)}updateAttribute(e,t){const s=this.info.render.calls;e.isInterleavedBufferAttribute?void 0===this.attributeCall.get(e)?(this.attributes.update(e,t),this.attributeCall.set(e,s)):this.attributeCall.get(e.data)!==s&&(this.attributes.update(e,t),this.attributeCall.set(e.data,s),this.attributeCall.set(e,s)):this.attributeCall.get(e)!==s&&(this.attributes.update(e,t),this.attributeCall.set(e,s))}getIndirect(e){return e.geometry.indirect}getIndex(e){const{geometry:t,material:s}=e;let i=t.index;if(!0===s.wireframe){const e=this.wireframes;let s=e.get(t);void 0===s?(s=Af(t),e.set(t,s)):s.version!==wf(t)&&(this.attributes.delete(s),s=Af(t),e.set(t,s)),i=s}return i}},Cf=class{constructor(){this.autoReset=!0,this.frame=0,this.calls=0,this.render={calls:0,frameCalls:0,drawCalls:0,triangles:0,points:0,lines:0,timestamp:0},this.compute={calls:0,frameCalls:0,timestamp:0},this.memory={geometries:0,textures:0}}update(e,t,s){this.render.drawCalls++,e.isMesh||e.isSprite?this.render.triangles+=s*(t/3):e.isPoints?this.render.points+=s*t:e.isLineSegments?this.render.lines+=s*(t/2):e.isLine?this.render.lines+=s*(t-1):console.error("THREE.WebGPUInfo: Unknown object type.")}reset(){this.render.drawCalls=0,this.render.frameCalls=0,this.compute.frameCalls=0,this.render.triangles=0,this.render.points=0,this.render.lines=0}dispose(){this.reset(),this.calls=0,this.render.calls=0,this.compute.calls=0,this.render.timestamp=0,this.compute.timestamp=0,this.memory.geometries=0,this.memory.textures=0}},Mf=class{constructor(e){this.cacheKey=e,this.usedTimes=0}},Pf=class extends Mf{constructor(e,t,s){super(e),this.vertexProgram=t,this.fragmentProgram=s}},Bf=class extends Mf{constructor(e,t){super(e),this.computeProgram=t,this.isComputePipeline=!0}},Lf=0,Ff=class{constructor(e,t,s,i=null,r=null){this.id=Lf++,this.code=e,this.stage=t,this.name=s,this.transforms=i,this.attributes=r,this.usedTimes=0}},If=class extends xf{constructor(e,t){super(),this.backend=e,this.nodes=t,this.bindings=null,this.caches=new Map,this.programs={vertex:new Map,fragment:new Map,compute:new Map}}getForCompute(e,t){const{backend:s}=this,i=this.get(e);if(this._needsComputeUpdate(e)){const r=i.pipeline;r&&(r.usedTimes--,r.computeProgram.usedTimes--);const n=this.nodes.getForCompute(e);let a=this.programs.compute.get(n.computeShader);void 0===a&&(r&&0===r.computeProgram.usedTimes&&this._releaseProgram(r.computeProgram),a=new Ff(n.computeShader,"compute",e.name,n.transforms,n.nodeAttributes),this.programs.compute.set(n.computeShader,a),s.createProgram(a));const o=this._getComputeCacheKey(e,a);let l=this.caches.get(o);void 0===l&&(r&&0===r.usedTimes&&this._releasePipeline(r),l=this._getComputePipeline(e,a,o,t)),l.usedTimes++,a.usedTimes++,i.version=e.version,i.pipeline=l}return i.pipeline}getForRender(e,t=null){const{backend:s}=this,i=this.get(e);if(this._needsRenderUpdate(e)){const r=i.pipeline;r&&(r.usedTimes--,r.vertexProgram.usedTimes--,r.fragmentProgram.usedTimes--);const n=e.getNodeBuilderState(),a=e.material?e.material.name:"";let o=this.programs.vertex.get(n.vertexShader);void 0===o&&(r&&0===r.vertexProgram.usedTimes&&this._releaseProgram(r.vertexProgram),o=new Ff(n.vertexShader,"vertex",a),this.programs.vertex.set(n.vertexShader,o),s.createProgram(o));let l=this.programs.fragment.get(n.fragmentShader);void 0===l&&(r&&0===r.fragmentProgram.usedTimes&&this._releaseProgram(r.fragmentProgram),l=new Ff(n.fragmentShader,"fragment",a),this.programs.fragment.set(n.fragmentShader,l),s.createProgram(l));const h=this._getRenderCacheKey(e,o,l);let u=this.caches.get(h);void 0===u?(r&&0===r.usedTimes&&this._releasePipeline(r),u=this._getRenderPipeline(e,o,l,h,t)):e.pipeline=u,u.usedTimes++,o.usedTimes++,l.usedTimes++,i.pipeline=u}return i.pipeline}delete(e){const t=this.get(e).pipeline;return t&&(t.usedTimes--,0===t.usedTimes&&this._releasePipeline(t),t.isComputePipeline?(t.computeProgram.usedTimes--,0===t.computeProgram.usedTimes&&this._releaseProgram(t.computeProgram)):(t.fragmentProgram.usedTimes--,t.vertexProgram.usedTimes--,0===t.vertexProgram.usedTimes&&this._releaseProgram(t.vertexProgram),0===t.fragmentProgram.usedTimes&&this._releaseProgram(t.fragmentProgram))),super.delete(e)}dispose(){super.dispose(),this.caches=new Map,this.programs={vertex:new Map,fragment:new Map,compute:new Map}}updateForRender(e){this.getForRender(e)}_getComputePipeline(e,t,s,i){s=s||this._getComputeCacheKey(e,t);let r=this.caches.get(s);return void 0===r&&(r=new Bf(s,t),this.caches.set(s,r),this.backend.createComputePipeline(r,i)),r}_getRenderPipeline(e,t,s,i,r){i=i||this._getRenderCacheKey(e,t,s);let n=this.caches.get(i);return void 0===n&&(n=new Pf(i,t,s),this.caches.set(i,n),e.pipeline=n,this.backend.createRenderPipeline(e,r)),n}_getComputeCacheKey(e,t){return e.id+","+t.id}_getRenderCacheKey(e,t,s){return t.id+","+s.id+","+this.backend.getRenderCacheKey(e)}_releasePipeline(e){this.caches.delete(e.cacheKey)}_releaseProgram(e){const t=e.code,s=e.stage;this.programs[s].delete(t)}_needsComputeUpdate(e){const t=this.get(e);return void 0===t.pipeline||t.version!==e.version}_needsRenderUpdate(e){return void 0===this.get(e).pipeline||this.backend.needsRenderUpdate(e)}},Df=class extends xf{constructor(e,t,s,i,r,n){super(),this.backend=e,this.textures=s,this.pipelines=r,this.attributes=i,this.nodes=t,this.info=n,this.pipelines.bindings=this}getForRender(e){const t=e.getBindings();for(const e of t){const s=this.get(e);void 0===s.bindGroup&&(this._init(e),this.backend.createBindings(e,t,0),s.bindGroup=e)}return t}getForCompute(e){const t=this.nodes.getForCompute(e).bindings;for(const e of t){const s=this.get(e);void 0===s.bindGroup&&(this._init(e),this.backend.createBindings(e,t,0),s.bindGroup=e)}return t}updateForCompute(e){this._updateBindings(this.getForCompute(e))}updateForRender(e){this._updateBindings(this.getForRender(e))}_updateBindings(e){for(const t of e)this._update(t,e)}_init(e){for(const t of e.bindings)if(t.isSampledTexture)this.textures.updateTexture(t.texture);else if(t.isStorageBuffer){const e=t.attribute,s=e.isIndirectStorageBufferAttribute?Nf:vf;this.attributes.update(e,s)}}_update(e,t){const{backend:s}=this;let i=!1,r=!0,n=0,a=0;for(const t of e.bindings)if(!t.isNodeUniformsGroup||!1!==this.nodes.updateGroup(t)){if(t.isStorageBuffer){const e=t.attribute,s=e.isIndirectStorageBufferAttribute?Nf:vf;this.attributes.update(e,s)}if(t.isUniformBuffer)t.update()&&s.updateBinding(t);else if(t.isSampledTexture){const e=t.update(),o=t.texture,l=this.textures.get(o);if(e&&(this.textures.updateTexture(o),t.generation!==l.generation&&(t.generation=l.generation,i=!0)),void 0!==s.get(o).externalTexture||l.isDefaultTexture?r=!1:(n=10*n+o.id,a+=o.version),!0===o.isStorageTexture){const e=this.get(o);!0===t.store?e.needsMipmap=!0:this.textures.needsMipmaps(o)&&!0===e.needsMipmap&&(this.backend.generateMipmaps(o),e.needsMipmap=!1)}}else t.isSampler&&t.update()}!0===i&&this.backend.updateBindings(e,t,r?n:0,a)}};function Vf(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?e.z-t.z:e.id-t.id}function Uf(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function Of(e){return(e.transmission>0||e.transmissionNode)&&e.side===p&&!1===e.forceSinglePass}var kf=class{constructor(e,t,s){this.renderItems=[],this.renderItemsIndex=0,this.opaque=[],this.transparentDoublePass=[],this.transparent=[],this.bundles=[],this.lightsNode=e.getNode(t,s),this.lightsArray=[],this.scene=t,this.camera=s,this.occlusionQueryCount=0}begin(){return this.renderItemsIndex=0,this.opaque.length=0,this.transparentDoublePass.length=0,this.transparent.length=0,this.bundles.length=0,this.lightsArray.length=0,this.occlusionQueryCount=0,this}getNextRenderItem(e,t,s,i,r,n,a){let o=this.renderItems[this.renderItemsIndex];return void 0===o?(o={id:e.id,object:e,geometry:t,material:s,groupOrder:i,renderOrder:e.renderOrder,z:r,group:n,clippingContext:a},this.renderItems[this.renderItemsIndex]=o):(o.id=e.id,o.object=e,o.geometry=t,o.material=s,o.groupOrder=i,o.renderOrder=e.renderOrder,o.z=r,o.group=n,o.clippingContext=a),this.renderItemsIndex++,o}push(e,t,s,i,r,n,a){const o=this.getNextRenderItem(e,t,s,i,r,n,a);!0===e.occlusionTest&&this.occlusionQueryCount++,!0===s.transparent||s.transmission>0?(Of(s)&&this.transparentDoublePass.push(o),this.transparent.push(o)):this.opaque.push(o)}unshift(e,t,s,i,r,n,a){const o=this.getNextRenderItem(e,t,s,i,r,n,a);!0===s.transparent||s.transmission>0?(Of(s)&&this.transparentDoublePass.unshift(o),this.transparent.unshift(o)):this.opaque.unshift(o)}pushBundle(e){this.bundles.push(e)}pushLight(e){this.lightsArray.push(e)}sort(e,t){this.opaque.length>1&&this.opaque.sort(e||Vf),this.transparentDoublePass.length>1&&this.transparentDoublePass.sort(t||Uf),this.transparent.length>1&&this.transparent.sort(t||Uf)}finish(){this.lightsNode.setLights(this.lightsArray);for(let e=this.renderItemsIndex,t=this.renderItems.length;e<t;e++){const t=this.renderItems[e];if(null===t.id)break;t.id=null,t.object=null,t.geometry=null,t.material=null,t.groupOrder=null,t.renderOrder=null,t.z=null,t.group=null,t.clippingContext=null}}},Gf=[],zf=class{constructor(e){this.lighting=e,this.lists=new gf}get(e,t){const s=this.lists;Gf[0]=e,Gf[1]=t;let i=s.get(Gf);return void 0===i&&(i=new kf(this.lighting,e,t),s.set(Gf,i)),Gf.length=0,i}dispose(){this.lists=new gf}},Hf=0,$f=class{constructor(){this.id=Hf++,this.color=!0,this.clearColor=!0,this.clearColorValue={r:0,g:0,b:0,a:1},this.depth=!0,this.clearDepth=!0,this.clearDepthValue=1,this.stencil=!1,this.clearStencil=!0,this.clearStencilValue=1,this.viewport=!1,this.viewportValue=new As,this.scissor=!1,this.scissorValue=new As,this.renderTarget=null,this.textures=null,this.depthTexture=null,this.activeCubeFace=0,this.activeMipmapLevel=0,this.sampleCount=1,this.width=0,this.height=0,this.occlusionQueryCount=0,this.clippingContext=null,this.isRenderContext=!0}getCacheKey(){return Wf(this)}};function Wf(e){const{textures:t,activeCubeFace:s}=e,i=[s];for(const e of t)i.push(e.id);return Ts2(i)}var qf=[],jf=new ha,Xf=new Yn,Kf=class{constructor(){this.chainMaps={}}get(e,t,s=null){let i;if(qf[0]=e,qf[1]=t,null===s)i="default";else{const e=s.texture.format;i=`${s.textures.length}:${e}:${s.samples}:${s.depthBuffer}:${s.stencilBuffer}`}const r=this._getChainMap(i);let n=r.get(qf);return void 0===n&&(n=new $f,r.set(qf,n)),qf.length=0,null!==s&&(n.sampleCount=0===s.samples?1:s.samples),n}getForClear(e=null){return this.get(jf,Xf,e)}_getChainMap(e){return this.chainMaps[e]||(this.chainMaps[e]=new gf)}dispose(){this.chainMaps={}}},Yf=new Qi,Qf=class extends xf{constructor(e,t,s){super(),this.renderer=e,this.backend=t,this.info=s}updateRenderTarget(e,t=0){const s=this.get(e),i=0===e.samples?1:e.samples,r=s.depthTextureMips||(s.depthTextureMips={}),n=e.textures,a=this.getSize(n[0]),o=a.width>>t,l=a.height>>t;let h=e.depthTexture||r[t];const u=!0===e.depthBuffer||!0===e.stencilBuffer;let c=!1;void 0===h&&u&&(h=new ah,h.format=e.stencilBuffer?Dt:Wt,h.type=e.stencilBuffer?Nt:kt,h.image.width=o,h.image.height=l,h.image.depth=a.depth,h.isArrayTexture=!0===e.multiview&&a.depth>1,r[t]=h),s.width===a.width&&a.height===s.height||(c=!0,h&&(h.needsUpdate=!0,h.image.width=o,h.image.height=l,h.image.depth=h.isArrayTexture?h.image.depth:1)),s.width=a.width,s.height=a.height,s.textures=n,s.depthTexture=h||null,s.depth=e.depthBuffer,s.stencil=e.stencilBuffer,s.renderTarget=e,s.sampleCount!==i&&(c=!0,h&&(h.needsUpdate=!0),s.sampleCount=i);const d={sampleCount:i};if(!0!==e.isXRRenderTarget){for(let e=0;e<n.length;e++){const t=n[e];c&&(t.needsUpdate=!0),this.updateTexture(t,d)}h&&this.updateTexture(h,d)}if(!0!==s.initialized){s.initialized=!0;const t=()=>{e.removeEventListener("dispose",t);for(let e=0;e<n.length;e++)this._destroyTexture(n[e]);h&&this._destroyTexture(h),this.delete(e)};e.addEventListener("dispose",t)}}updateTexture(e,t={}){const s=this.get(e);if(!0===s.initialized&&s.version===e.version)return;const i=e.isRenderTargetTexture||e.isDepthTexture||e.isFramebufferTexture,r=this.backend;if(i&&!0===s.initialized&&(r.destroySampler(e),r.destroyTexture(e)),e.isFramebufferTexture){const t=this.renderer.getRenderTarget();e.type=t?t.texture.type:Tt}const{width:n,height:a,depth:o}=this.getSize(e);if(t.width=n,t.height=a,t.depth=o,t.needsMipmaps=this.needsMipmaps(e),t.levels=t.needsMipmaps?this.getMipLevels(e,n,a):1,i||!0===e.isStorageTexture)r.createSampler(e),r.createTexture(e,t),s.generation=e.version;else if(!0!==s.initialized&&r.createSampler(e),e.version>0){const i=e.image;if(void 0===i)console.warn("THREE.Renderer: Texture marked for update but image is undefined.");else if(!1===i.complete)console.warn("THREE.Renderer: Texture marked for update but image is incomplete.");else{if(e.images){const s=[];for(const t of e.images)s.push(t);t.images=s}else t.image=i;void 0!==s.isDefaultTexture&&!0!==s.isDefaultTexture||(r.createTexture(e,t),s.isDefaultTexture=!1,s.generation=e.version),!0===e.source.dataReady&&r.updateTexture(e,t),t.needsMipmaps&&0===e.mipmaps.length&&r.generateMipmaps(e)}}else r.createDefaultTexture(e),s.isDefaultTexture=!0,s.generation=e.version;if(!0!==s.initialized){s.initialized=!0,s.generation=e.version,this.info.memory.textures++;const t=()=>{e.removeEventListener("dispose",t),this._destroyTexture(e)};e.addEventListener("dispose",t)}s.version=e.version}getSize(e,t=Yf){let s=e.images?e.images[0]:e.image;return s?(void 0!==s.image&&(s=s.image),s instanceof HTMLVideoElement?(t.width=s.videoWidth||1,t.height=s.videoHeight||1,t.depth=1):s instanceof VideoFrame?(t.width=s.displayWidth||1,t.height=s.displayHeight||1,t.depth=1):(t.width=s.width||1,t.height=s.height||1,t.depth=e.isCubeTexture?6:s.depth||1)):t.width=t.height=t.depth=1,t}getMipLevels(e,t,s){let i;return i=e.isCompressedTexture?e.mipmaps?e.mipmaps.length:1:Math.floor(Math.log2(Math.max(t,s)))+1,i}needsMipmaps(e){return!0===e.isCompressedTexture||e.generateMipmaps}_destroyTexture(e){!0===this.has(e)&&(this.backend.destroySampler(e),this.backend.destroyTexture(e),this.delete(e),this.info.memory.textures--)}},Zf=class extends $r{constructor(e,t,s,i=1){super(e,t,s),this.a=i}set(e,t,s,i=1){return this.a=i,super.set(e,t,s)}copy(e){return void 0!==e.a&&(this.a=e.a),super.copy(e)}clone(){return new this.constructor(this.r,this.g,this.b,this.a)}},Jf=class extends yn2{static get type(){return"ParameterNode"}constructor(e,t=null){super(e,t),this.isParameterNode=!0}getHash(){return this.uuid}generate(){return this.name}},ey=class extends js2{static get type(){return"StackNode"}constructor(e=null){super(),this.nodes=[],this.outputNode=null,this.parent=e,this._currentCond=null,this._expressionNode=null,this.isStackNode=!0}getNodeType(e){return this.outputNode?this.outputNode.getNodeType(e):"void"}getMemberType(e,t){return this.outputNode?this.outputNode.getMemberType(e,t):"void"}add(e){return this.nodes.push(e),this}If(e,t){const s=new Fi2(t);return this._currentCond=Jo2(e,s),this.add(this._currentCond)}ElseIf(e,t){const s=new Fi2(t),i=Jo2(e,s);return this._currentCond.elseNode=i,this._currentCond=i,this}Else(e){return this._currentCond.elseNode=new Fi2(e),this}Switch(e){return this._expressionNode=Ii2(e),this}Case(...e){const t=[];if(!(e.length>=2))throw new Error("TSL: Invalid parameter length. Case() requires at least two parameters.");for(let s=0;s<e.length-1;s++)t.push(this._expressionNode.equal(Ii2(e[s])));const s=new Fi2(e[e.length-1]);let i=t[0];for(let e=1;e<t.length;e++)i=i.or(t[e]);const r=Jo2(i,s);return null===this._currentCond?(this._currentCond=r,this.add(this._currentCond)):(this._currentCond.elseNode=r,this._currentCond=r,this)}Default(e){return this.Else(e),this}setup(e){const t=e.getNodeProperties(this);let s=0;for(const i of this.getChildren())i.isVarNode&&!0===i.intent&&!0!==e.getNodeProperties(i).assign||(t["node"+s++]=i);return t.outputNode||null}build(e,...t){const s=e.currentStack,i=Wi2();$i2(this),e.currentStack=this;const r=e.buildStage;for(const t of this.nodes)if(!t.isVarNode||!0!==t.intent||!0===e.getNodeProperties(t).assign)if("setup"===r)t.build(e);else if("analyze"===r)t.build(e,this);else if("generate"===r){const s=e.getDataFromNode(t,"any").stages,i=s&&s[e.shaderStage];if(t.isVarNode&&i&&1===i.length&&i[0]&&i[0].isStackNode)continue;t.build(e,"void")}const n=this.outputNode?this.outputNode.build(e,...t):super.build(e,...t);return $i2(i),e.currentStack=s,n}},ty=Oi2(ey).setParameterLength(0,1),ry=class extends js2{static get type(){return"StructTypeNode"}constructor(e,t=null){var s;super("struct"),this.membersLayout=(s=e,Object.entries(s).map(([e,t])=>"string"==typeof t?{name:e,type:t,atomic:!1}:{name:e,type:t.type,atomic:t.atomic||!1})),this.name=t,this.isStructLayoutNode=!0}getLength(){const e=Float32Array.BYTES_PER_ELEMENT;let t=0;for(const s of this.membersLayout){const i=s.type,r=Cs2(i)*e,n=t%8,a=n%Ms2(i),o=n+a;t+=a,0!==o&&8-o<r&&(t+=8-o),t+=r}return 8*Math.ceil(t/8)/e}getMemberType(e,t){const s=this.membersLayout.find(e=>e.name===t);return s?s.type:"void"}getNodeType(e){return e.getStructTypeFromNode(this,this.membersLayout,this.name).name}setup(e){e.addInclude(this)}generate(e){return this.getNodeType(e)}},sy=class extends js2{static get type(){return"StructNode"}constructor(e,t){super("vec3"),this.structLayoutNode=e,this.values=t,this.isStructNode=!0}getNodeType(e){return this.structLayoutNode.getNodeType(e)}getMemberType(e,t){return this.structLayoutNode.getMemberType(e,t)}generate(e){const t=e.getVarFromNode(this),s=t.type,i=e.getPropertyName(t);return e.addLineFlowCode(`${i} = ${e.generateStruct(s,this.structLayoutNode.membersLayout,this.values)}`,this),t.name}},iy=class extends js2{static get type(){return"OutputStructNode"}constructor(...e){super(),this.members=e,this.isOutputStructNode=!0}getNodeType(e){const t=e.getNodeProperties(this);if(void 0===t.membersLayout){const s=this.members,i=[];for(let t=0;t<s.length;t++){const r="m"+t,n=s[t].getNodeType(e);i.push({name:r,type:n,index:t})}t.membersLayout=i,t.structType=e.getOutputStructTypeFromNode(this,t.membersLayout)}return t.structType.name}generate(e){const t=e.getOutputStructName(),s=this.members,i=""!==t?t+".":"";for(let t=0;t<s.length;t++){const r=s[t].build(e);e.addLineFlowCode(`${i}m${t} = ${r}`,this)}return t}},ny=Oi2(iy);function ay(e,t){for(let s=0;s<e.length;s++)if(e[s].name===t)return s;return-1}var oy=class extends iy{static get type(){return"MRTNode"}constructor(e){super(),this.outputNodes=e,this.isMRTNode=!0}has(e){return void 0!==this.outputNodes[e]}get(e){return this.outputNodes[e]}merge(e){const t={...this.outputNodes,...e.outputNodes};return uy(t)}setup(e){const t=this.outputNodes,s=[],i=e.renderer.getRenderTarget().textures;for(const e in t)s[ay(i,e)]=un2(t[e]);return this.members=s,super.setup(e)}},uy=Oi2(oy),ly=Hi2(([e])=>{const t=e.toUint().mul(747796405).add(2891336453),s=t.shiftRight(t.shiftRight(28).add(4)).bitXor(t).mul(277803737);return s.shiftRight(22).bitXor(s).toFloat().mul(1/2**32)}),dy=(e,t)=>Bo(ha2(4,e.mul(ca2(1,e))),t),cy=Hi2(([e])=>e.fract().sub(.5).abs()).setLayout({name:"tri",type:"float",inputs:[{name:"x",type:"float"}]}),hy=Hi2(([e])=>sn2(cy(e.z.add(cy(e.y.mul(1)))),cy(e.z.add(cy(e.x.mul(1)))),cy(e.y.add(cy(e.x.mul(1)))))).setLayout({name:"tri3",type:"vec3",inputs:[{name:"p",type:"vec3"}]}),py=Hi2(([e,t,s])=>{const i=sn2(e).toVar(),r=Ki2(1.4).toVar(),n=Ki2(0).toVar(),a=sn2(i).toVar();return xh2({start:Ki2(0),end:Ki2(3),type:"float",condition:"<="},()=>{const e=sn2(hy(a.mul(2))).toVar();i.addAssign(e.add(s.mul(Ki2(.1).mul(t)))),a.mulAssign(1.8),r.mulAssign(1.5),i.mulAssign(1.2);const o=Ki2(cy(i.z.add(cy(i.x.add(cy(i.y)))))).toVar();n.addAssign(o.div(r)),a.addAssign(.14)}),n}).setLayout({name:"triNoise3D",type:"float",inputs:[{name:"position",type:"vec3"},{name:"speed",type:"float"},{name:"time",type:"float"}]}),gy=class extends js2{static get type(){return"FunctionOverloadingNode"}constructor(e=[],...t){super(),this.functionNodes=e,this.parametersNodes=t,this._candidateFnCall=null,this.global=!0}getNodeType(){return this.functionNodes[0].shaderNode.layout.type}setup(e){const t=this.parametersNodes;let s=this._candidateFnCall;if(null===s){let i=null,r=-1;for(const s of this.functionNodes){const n=s.shaderNode.layout;if(null===n)throw new Error("FunctionOverloadingNode: FunctionNode must be a layout.");const a=n.inputs;if(t.length===a.length){let n=0;for(let s=0;s<t.length;s++){const i=t[s],r=a[s];i.getNodeType(e)===r.type?n++:n=0}n>r&&(i=s,r=n)}}this._candidateFnCall=s=i(...t)}return s}},my=Oi2(gy),fy=e=>(...t)=>my(e,...t),yy=ta2(0).setGroup(Zn2).onRenderUpdate(e=>e.time),by=ta2(0).setGroup(Zn2).onRenderUpdate(e=>e.deltaTime),xy=ta2(0,"uint").setGroup(Zn2).onRenderUpdate(e=>e.frameId),Ty=Hi2(([e,t,s=Ji2(.5)])=>Jm(e.sub(s),t).add(s)),_y=Hi2(([e,t,s=Ji2(.5)])=>{const i=e.sub(s),r=i.dot(i),n=r.mul(r).mul(t);return e.add(i.mul(n))}),vy=Hi2(({position:e=null,horizontal:t=!0,vertical:s=!1})=>{let i;null!==e?(i=Ll2.toVar(),i[3][0]=e.x,i[3][1]=e.y,i[3][2]=e.z):i=Ll2;const r=xl2.mul(i);return Bi2(t)&&(r[0][0]=Ll2[0].length(),r[0][1]=0,r[0][2]=0),Bi2(s)&&(r[1][0]=0,r[1][1]=Ll2[1].length(),r[1][2]=0),r[2][0]=0,r[2][1]=0,r[2][2]=1,yl2.mul(r).mul(Wl2)}),Ny=Hi2(([e=null])=>{const t=rp();return rp(Xh2(e)).sub(t).lessThan(0).select(Fh2,e)}),Sy=class extends js2{static get type(){return"SpriteSheetUVNode"}constructor(e,t=Zu2(),s=Ki2(0)){super("vec2"),this.countNode=e,this.uvNode=t,this.frameNode=s}setup(){const{frameNode:e,uvNode:t,countNode:s}=this,{width:i,height:r}=s,n=e.mod(i.mul(r)).floor(),a=n.mod(i),o=r.sub(n.add(1).div(i).ceil()),l=s.reciprocal(),h=Ji2(a,o);return t.add(h).mul(l)}},Ey=Oi2(Sy).setParameterLength(3),wy=Hi2(([e,t=null,s=null,i=Ki2(1),r=Wl2,n=rd2])=>{let a=n.abs().normalize();a=a.div(a.dot(sn2(1)));const o=r.yz.mul(i),l=r.zx.mul(i),h=r.xy.mul(i),u=e.value,c=null!==t?t.value:u,d=null!==s?s.value:u,p=al2(u,o).mul(a.x),_=al2(c,l).mul(a.y),m=al2(d,h).mul(a.z);return da2(p,_,m)}),Ay=new ro,Ry=new Qi,Cy=new Qi,My=new Qi,Py=new nr,By=new Qi(0,0,-1),Ly=new As,Fy=new Qi,Iy=new Qi,Dy=new As,Vy=new Gi,Uy=new Ts,Oy=Fh2.flipX();Uy.depthTexture=new ah(1,1);var ky=!1,Gy=class e extends il2{static get type(){return"ReflectorNode"}constructor(e={}){super(e.defaultTexture||Uy.texture,Oy),this._reflectorBaseNode=e.reflector||new zy(this,e),this._depthNode=null,this.setUpdateMatrix(!1)}get reflector(){return this._reflectorBaseNode}get target(){return this._reflectorBaseNode.target}getDepthNode(){if(null===this._depthNode){if(!0!==this._reflectorBaseNode.depth)throw new Error("THREE.ReflectorNode: Depth node can only be requested when the reflector is created with { depth: true }. ");this._depthNode=Ii2(new e({defaultTexture:Uy.depthTexture,reflector:this._reflectorBaseNode}))}return this._depthNode}setup(e){return e.object.isQuadMesh||this._reflectorBaseNode.build(e),super.setup(e)}clone(){const e=new this.constructor(this.reflectorNode);return e.uvNode=this.uvNode,e.levelNode=this.levelNode,e.biasNode=this.biasNode,e.sampler=this.sampler,e.depthNode=this.depthNode,e.compareNode=this.compareNode,e.gradNode=this.gradNode,e._reflectorBaseNode=this._reflectorBaseNode,e}dispose(){super.dispose(),this._reflectorBaseNode.dispose()}},zy=class extends js2{static get type(){return"ReflectorBaseNode"}constructor(e,t={}){super();const{target:s=new Er,resolution:i=1,generateMipmaps:r=!1,bounces:n=!0,depth:a=!1}=t;this.textureNode=e,this.target=s,this.resolution=i,this.generateMipmaps=r,this.bounces=n,this.depth=a,this.updateBeforeType=n?Us2.RENDER:Us2.FRAME,this.virtualCameras=new WeakMap,this.renderTargets=new Map,this.forceUpdate=!1,this.hasOutput=!1}_updateResolution(e,t){const s=this.resolution;t.getDrawingBufferSize(Vy),e.setSize(Math.round(Vy.width*s),Math.round(Vy.height*s))}setup(e){return this._updateResolution(Uy,e.renderer),super.setup(e)}dispose(){super.dispose();for(const e of this.renderTargets.values())e.dispose()}getVirtualCamera(e){let t=this.virtualCameras.get(e);return void 0===t&&(t=e.clone(),this.virtualCameras.set(e,t)),t}getRenderTarget(e){let t=this.renderTargets.get(e);return void 0===t&&(t=new Ts(0,0,{type:Rt}),!0===this.generateMipmaps&&(t.texture.minFilter=At,t.texture.generateMipmaps=!0),!0===this.depth&&(t.depthTexture=new ah),this.renderTargets.set(e,t)),t}updateBefore(e){if(!1===this.bounces&&ky)return!1;ky=!0;const{scene:t,camera:s,renderer:i,material:r}=e,{target:n}=this,a=this.getVirtualCamera(s),o=this.getRenderTarget(a);i.getDrawingBufferSize(Vy),this._updateResolution(o,i),Cy.setFromMatrixPosition(n.matrixWorld),My.setFromMatrixPosition(s.matrixWorld),Py.extractRotation(n.matrixWorld),Ry.set(0,0,1),Ry.applyMatrix4(Py),Fy.subVectors(Cy,My);let l=!1;if(!0==Fy.dot(Ry)>0&&!1===this.forceUpdate){if(!1===this.hasOutput)return void(ky=!1);l=!0}Fy.reflect(Ry).negate(),Fy.add(Cy),Py.extractRotation(s.matrixWorld),By.set(0,0,-1),By.applyMatrix4(Py),By.add(My),Iy.subVectors(Cy,By),Iy.reflect(Ry).negate(),Iy.add(Cy),a.coordinateSystem=s.coordinateSystem,a.position.copy(Fy),a.up.set(0,1,0),a.up.applyMatrix4(Py),a.up.reflect(Ry),a.lookAt(Iy),a.near=s.near,a.far=s.far,a.updateMatrixWorld(),a.projectionMatrix.copy(s.projectionMatrix),Ay.setFromNormalAndCoplanarPoint(Ry,Cy),Ay.applyMatrix4(a.matrixWorldInverse),Ly.set(Ay.normal.x,Ay.normal.y,Ay.normal.z,Ay.constant);const h=a.projectionMatrix;Dy.x=(Math.sign(Ly.x)+h.elements[8])/h.elements[0],Dy.y=(Math.sign(Ly.y)+h.elements[9])/h.elements[5],Dy.z=-1,Dy.w=(1+h.elements[10])/h.elements[14],Ly.multiplyScalar(1/Ly.dot(Dy)),h.elements[2]=Ly.x,h.elements[6]=Ly.y,h.elements[10]=i.coordinateSystem===Pi?Ly.z-0:Ly.z+1-0,h.elements[14]=Ly.w,this.textureNode.value=o.texture,!0===this.depth&&(this.textureNode.getDepthNode().value=o.depthTexture),r.visible=!1;const u=i.getRenderTarget(),c=i.getMRT(),d=i.autoClear;i.setMRT(null),i.setRenderTarget(o),i.autoClear=!0,l?(i.clear(),this.hasOutput=!1):(i.render(t,a),this.hasOutput=!0),i.setMRT(c),i.setRenderTarget(u),i.autoClear=d,r.visible=!0,ky=!1,this.forceUpdate=!1}},Hy=new Fc(-1,1,1,-1,0,1),$y=class extends Cn{constructor(e=!1){super();const t=!1===e?[0,-1,0,1,2,1]:[0,2,0,0,2,0];this.setAttribute("position",new vn([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new vn(t,2))}},Wy=new $y,qy=class extends jn{constructor(e=null){super(Wy,e),this.camera=Hy,this.isQuadMesh=!0}async renderAsync(e){return e.renderAsync(this,Hy)}render(e){e.render(this,Hy)}},jy=new Gi,Xy=class extends il2{static get type(){return"RTTNode"}constructor(e,t=null,s=null,i={type:Rt}){const r=new Ts(t,s,i);super(r.texture,Zu2()),this.isRTTNode=!0,this.node=e,this.width=t,this.height=s,this.pixelRatio=1,this.renderTarget=r,this.textureNeedsUpdate=!0,this.autoUpdate=!0,this._rttNode=null,this._quadMesh=new qy(new yp),this.updateBeforeType=Us2.RENDER}get autoResize(){return null===this.width}setup(e){return this._rttNode=this.node.context(e.getSharedContext()),this._quadMesh.material.name="RTT",this._quadMesh.material.needsUpdate=!0,super.setup(e)}setSize(e,t){this.width=e,this.height=t;const s=e*this.pixelRatio,i=t*this.pixelRatio;this.renderTarget.setSize(s,i),this.textureNeedsUpdate=!0}setPixelRatio(e){this.pixelRatio=e,this.setSize(this.width,this.height)}updateBefore({renderer:e}){if(!1===this.textureNeedsUpdate&&!1===this.autoUpdate)return;if(this.textureNeedsUpdate=!1,!0===this.autoResize){const t=e.getPixelRatio(),s=e.getSize(jy),i=s.width*t,r=s.height*t;i===this.renderTarget.width&&r===this.renderTarget.height||(this.renderTarget.setSize(i,r),this.textureNeedsUpdate=!0)}this._quadMesh.material.fragmentNode=this._rttNode;const t=e.getRenderTarget();e.setRenderTarget(this.renderTarget),this._quadMesh.render(e),e.setRenderTarget(t)}clone(){const e=new il2(this.value,this.uvNode,this.levelNode);return e.sampler=this.sampler,e.referenceNode=this,e}},Ky=(e,...t)=>Ii2(new Xy(Ii2(e),...t)),Yy=Hi2(([e,t,s],i)=>{let r;i.renderer.coordinateSystem===Pi?(e=Ji2(e.x,e.y.oneMinus()).mul(2).sub(1),r=un2(sn2(e,t),1)):r=un2(sn2(e.x,e.y.oneMinus(),t).mul(2).sub(1),1);const n=un2(s.mul(r));return n.xyz.div(n.w)}),Qy=Hi2(([e,t])=>{const s=t.mul(un2(e,1)),i=s.xy.div(s.w).mul(.5).add(.5).toVar();return Ji2(i.x,i.y.oneMinus())}),Zy=Hi2(([e,t,s])=>{const i=el2(ol2(t)),r=en2(e.mul(i)).toVar(),n=ol2(t,r).toVar(),a=ol2(t,r.sub(en2(2,0))).toVar(),o=ol2(t,r.sub(en2(1,0))).toVar(),l=ol2(t,r.add(en2(1,0))).toVar(),h=ol2(t,r.add(en2(2,0))).toVar(),u=ol2(t,r.add(en2(0,2))).toVar(),c=ol2(t,r.add(en2(0,1))).toVar(),d=ol2(t,r.sub(en2(0,1))).toVar(),p=ol2(t,r.sub(en2(0,2))).toVar(),_=oo2(ca2(Ki2(2).mul(o).sub(a),n)).toVar(),m=oo2(ca2(Ki2(2).mul(l).sub(h),n)).toVar(),f=oo2(ca2(Ki2(2).mul(c).sub(u),n)).toVar(),g=oo2(ca2(Ki2(2).mul(d).sub(p),n)).toVar(),y=Yy(e,n,s).toVar(),S=_.lessThan(m).select(y.sub(Yy(e.sub(Ji2(Ki2(1).div(i.x),0)),o,s)),y.negate().add(Yy(e.add(Ji2(Ki2(1).div(i.x),0)),l,s))),T=f.lessThan(g).select(y.sub(Yy(e.add(Ji2(0,Ki2(1).div(i.y))),c,s)),y.negate().add(Yy(e.sub(Ji2(0,Ki2(1).div(i.y))),d,s)));return Ja2(Po2(S,T))}),Jy=class extends js2{static get type(){return"SampleNode"}constructor(e){super(),this.callback=e,this.isSampleNode=!0}setup(){return this.sample(Zu2())}sample(e){return this.callback(e)}},eb=class e extends js2{static get type(){return"EventNode"}constructor(t,s){super("void"),this.eventType=t,this.callback=s,t===e.OBJECT?this.updateType=Us2.OBJECT:t===e.MATERIAL&&(this.updateType=Us2.RENDER)}update(e){this.callback(e)}};eb.OBJECT="object",eb.MATERIAL="material";var tb=(e,t)=>Ii2(new eb(e,t)).toStack(),rb=class extends Ja{constructor(e,t,s=Float32Array){super(ArrayBuffer.isView(e)?e:new s(e*t),t),this.isStorageInstancedBufferAttribute=!0}},sb=class extends un{constructor(e,t,s=Float32Array){super(ArrayBuffer.isView(e)?e:new s(e*t),t),this.isStorageBufferAttribute=!0}},ib=class extends js2{static get type(){return"PointUVNode"}constructor(){super("vec2"),this.isPointUVNode=!0}generate(){return"vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y )"}},nb=ki2(ib),ab=new yr,ob=new nr,ub=class e extends js2{static get type(){return"SceneNode"}constructor(t=e.BACKGROUND_BLURRINESS,s=null){super(),this.scope=t,this.scene=s}setup(t){const s=this.scope,i=null!==this.scene?this.scene:t.scene;let r;return s===e.BACKGROUND_BLURRINESS?r=Cd2("backgroundBlurriness","float",i):s===e.BACKGROUND_INTENSITY?r=Cd2("backgroundIntensity","float",i):s===e.BACKGROUND_ROTATION?r=ta2("mat4").setName("backgroundRotation").setGroup(Zn2).onRenderUpdate(()=>{const e=i.background;return null!==e&&e.isTexture&&e.mapping!==ot?(ab.copy(i.backgroundRotation),ab.x*=-1,ab.y*=-1,ab.z*=-1,ob.makeRotationFromEuler(ab)):ob.identity(),ob}):console.error("THREE.SceneNode: Unknown scope:",s),r}};ub.BACKGROUND_BLURRINESS="backgroundBlurriness",ub.BACKGROUND_INTENSITY="backgroundIntensity",ub.BACKGROUND_ROTATION="backgroundRotation";var lb=ki2(ub,ub.BACKGROUND_BLURRINESS),db=ki2(ub,ub.BACKGROUND_INTENSITY),cb=ki2(ub,ub.BACKGROUND_ROTATION),hb=class extends il2{static get type(){return"StorageTextureNode"}constructor(e,t,s=null){super(e,t),this.storeNode=s,this.isStorageTextureNode=!0,this.access=ks2.WRITE_ONLY}getInputType(){return"storageTexture"}setup(e){super.setup(e);const t=e.getNodeProperties(this);return t.storeNode=this.storeNode,t}setAccess(e){return this.access=e,this}generate(e,t){let s;return s=null!==this.storeNode?this.generateStore(e):super.generate(e,t),s}toReadWrite(){return this.setAccess(ks2.READ_WRITE)}toReadOnly(){return this.setAccess(ks2.READ_ONLY)}toWriteOnly(){return this.setAccess(ks2.WRITE_ONLY)}generateStore(e){const t=e.getNodeProperties(this),{uvNode:s,storeNode:i,depthNode:r}=t,n=super.generate(e,"property"),a=s.build(e,!0===this.value.is3DTexture?"uvec3":"uvec2"),o=i.build(e,"vec4"),l=r?r.build(e,"int"):null,h=e.generateTextureStore(e,n,a,l,o);e.addLineFlowCode(h,this)}clone(){const e=super.clone();return e.storeNode=this.storeNode,e}},pb=Oi2(hb).setParameterLength(1,3),gb=Hi2(({texture:e,uv:t})=>{const s=1e-4,i=sn2().toVar();return qi2(t.x.lessThan(s),()=>{i.assign(sn2(1,0,0))}).ElseIf(t.y.lessThan(s),()=>{i.assign(sn2(0,1,0))}).ElseIf(t.z.lessThan(s),()=>{i.assign(sn2(0,0,1))}).ElseIf(t.x.greaterThan(.9999),()=>{i.assign(sn2(-1,0,0))}).ElseIf(t.y.greaterThan(.9999),()=>{i.assign(sn2(0,-1,0))}).ElseIf(t.z.greaterThan(.9999),()=>{i.assign(sn2(0,0,-1))}).Else(()=>{const s=.01,r=e.sample(t.add(sn2(-.01,0,0))).r.sub(e.sample(t.add(sn2(s,0,0))).r),n=e.sample(t.add(sn2(0,-.01,0))).r.sub(e.sample(t.add(sn2(0,s,0))).r),a=e.sample(t.add(sn2(0,0,-.01))).r.sub(e.sample(t.add(sn2(0,0,s))).r);i.assign(sn2(r,n,a))}),i.normalize()}),mb=class extends il2{static get type(){return"Texture3DNode"}constructor(e,t=null,s=null){super(e,t,s),this.isTexture3DNode=!0}getInputType(){return"texture3D"}getDefaultUV(){return sn2(.5,.5,.5)}setUpdateMatrix(){}setupUV(e,t){const s=this.value;return!e.isFlipY()||!0!==s.isRenderTargetTexture&&!0!==s.isFramebufferTexture||(t=this.sampler?t.flipY():t.setY(Yi2(el2(this,this.levelNode).y).sub(t.y).sub(1))),t}generateUV(e,t){return t.build(e,"vec3")}normal(e){return gb({texture:this,uv:e})}},fb=Oi2(mb).setParameterLength(1,3),yb=class extends Rd{static get type(){return"UserDataNode"}constructor(e,t,s=null){super(e,t,s),this.userData=s}updateReference(e){return this.reference=null!==this.userData?this.userData:e.object.userData,this.reference}},bb=new WeakMap,xb=class extends Ys2{static get type(){return"VelocityNode"}constructor(){super("vec2"),this.projectionMatrix=null,this.updateType=Us2.OBJECT,this.updateAfterType=Us2.OBJECT,this.previousModelWorldMatrix=ta2(new nr),this.previousProjectionMatrix=ta2(new nr).setGroup(Zn2),this.previousCameraViewMatrix=ta2(new nr)}setProjectionMatrix(e){this.projectionMatrix=e}update({frameId:e,camera:t,object:s}){const i=_b(s);this.previousModelWorldMatrix.value.copy(i);const r=Tb(t);r.frameId!==e&&(r.frameId=e,void 0===r.previousProjectionMatrix?(r.previousProjectionMatrix=new nr,r.previousCameraViewMatrix=new nr,r.currentProjectionMatrix=new nr,r.currentCameraViewMatrix=new nr,r.previousProjectionMatrix.copy(this.projectionMatrix||t.projectionMatrix),r.previousCameraViewMatrix.copy(t.matrixWorldInverse)):(r.previousProjectionMatrix.copy(r.currentProjectionMatrix),r.previousCameraViewMatrix.copy(r.currentCameraViewMatrix)),r.currentProjectionMatrix.copy(this.projectionMatrix||t.projectionMatrix),r.currentCameraViewMatrix.copy(t.matrixWorldInverse),this.previousProjectionMatrix.value.copy(r.previousProjectionMatrix),this.previousCameraViewMatrix.value.copy(r.previousCameraViewMatrix))}updateAfter({object:e}){_b(e).copy(e.matrixWorld)}setup(){const e=null===this.projectionMatrix?yl2:ta2(this.projectionMatrix),t=this.previousCameraViewMatrix.mul(this.previousModelWorldMatrix),s=e.mul(kl2).mul(Wl2),i=this.previousProjectionMatrix.mul(t).mul(ql2),r=s.xy.div(s.w),n=i.xy.div(i.w);return ca2(r,n)}};function Tb(e){let t=bb.get(e);return void 0===t&&(t={},bb.set(e,t)),t}function _b(e,t=0){const s=Tb(e);let i=s[t];return void 0===i&&(s[t]=i=new nr,s[t].copy(e.matrixWorld)),i}var vb=ki2(xb),Nb=Hi2(([e])=>Ab(e.rgb)),Sb=Hi2(([e,t=Ki2(1)])=>t.mix(Ab(e.rgb),e.rgb)),Eb=Hi2(([e,t=Ki2(1)])=>{const s=da2(e.r,e.g,e.b).div(3),i=e.r.max(e.g.max(e.b)),r=i.sub(s).mul(t).mul(-3);return Oo2(e.rgb,i,r)}),wb=Hi2(([e,t=Ki2(1)])=>{const s=sn2(.57735,.57735,.57735),i=t.cos();return sn2(e.rgb.mul(i).add(s.cross(e.rgb).mul(t.sin()).add(s.mul(Mo2(s,e.rgb).mul(i.oneMinus())))))}),Ab=(e,t=sn2(ms.getLuminanceCoefficients(new Qi)))=>Mo2(e,t),Rb=Hi2(([e,t=sn2(1),s=sn2(0),i=sn2(1),r=Ki2(1),n=sn2(ms.getLuminanceCoefficients(new Qi,Ze))])=>{const a=e.rgb.dot(sn2(n)),o=Eo2(e.rgb.mul(t).add(s),0).toVar(),l=o.pow(i).toVar();return qi2(o.r.greaterThan(0),()=>{o.r.assign(l.r)}),qi2(o.g.greaterThan(0),()=>{o.g.assign(l.g)}),qi2(o.b.greaterThan(0),()=>{o.b.assign(l.b)}),o.assign(a.add(o.sub(a).mul(r))),un2(o.rgb,e.a)}),Cb=class extends Ys2{static get type(){return"PosterizeNode"}constructor(e,t){super(),this.sourceNode=e,this.stepsNode=t}setup(){const{sourceNode:e,stepsNode:t}=this;return e.mul(t).floor().div(t)}},Mb=Oi2(Cb).setParameterLength(2),Pb=new Gi,Bb=class extends il2{static get type(){return"PassTextureNode"}constructor(e,t){super(t),this.passNode=e,this.setUpdateMatrix(!1)}setup(e){return this.passNode.build(e),super.setup(e)}clone(){return new this.constructor(this.passNode,this.value)}},Lb=class extends Bb{static get type(){return"PassMultipleTextureNode"}constructor(e,t,s=!1){super(e,null),this.textureName=t,this.previousTexture=s}updateTexture(){this.value=this.previousTexture?this.passNode.getPreviousTexture(this.textureName):this.passNode.getTexture(this.textureName)}setup(e){return this.updateTexture(),super.setup(e)}clone(){const e=new this.constructor(this.passNode,this.textureName,this.previousTexture);return e.uvNode=this.uvNode,e.levelNode=this.levelNode,e.biasNode=this.biasNode,e.sampler=this.sampler,e.depthNode=this.depthNode,e.compareNode=this.compareNode,e.gradNode=this.gradNode,e}},Fb=class e extends Ys2{static get type(){return"PassNode"}constructor(e,t,s,i={}){super("vec4"),this.scope=e,this.scene=t,this.camera=s,this.options=i,this._pixelRatio=1,this._width=1,this._height=1;const r=new ah;r.isRenderTargetTexture=!0,r.name="depth";const n=new Ts(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:Rt,...i});n.texture.name="output",n.depthTexture=r,this.renderTarget=n,this._textures={output:n.texture,depth:r},this._textureNodes={},this._linearDepthNodes={},this._viewZNodes={},this._previousTextures={},this._previousTextureNodes={},this._cameraNear=ta2(0),this._cameraFar=ta2(0),this._mrt=null,this._layers=null,this._resolution=1,this._viewport=null,this._scissor=null,this.isPassNode=!0,this.updateBeforeType=Us2.FRAME,this.global=!0}setResolution(e){return this._resolution=e,this}getResolution(){return this._resolution}setLayers(e){return this._layers=e,this}getLayers(){return this._layers}setMRT(e){return this._mrt=e,this}getMRT(){return this._mrt}getTexture(e){let t=this._textures[e];return void 0===t&&(t=this.renderTarget.texture.clone(),t.name=e,this._textures[e]=t,this.renderTarget.textures.push(t)),t}getPreviousTexture(e){let t=this._previousTextures[e];return void 0===t&&(t=this.getTexture(e).clone(),this._previousTextures[e]=t),t}toggleTexture(e){const t=this._previousTextures[e];if(void 0!==t){const s=this._textures[e],i=this.renderTarget.textures.indexOf(s);this.renderTarget.textures[i]=t,this._textures[e]=t,this._previousTextures[e]=s,this._textureNodes[e].updateTexture(),this._previousTextureNodes[e].updateTexture()}}getTextureNode(e="output"){let t=this._textureNodes[e];return void 0===t&&(t=Ii2(new Lb(this,e)),t.updateTexture(),this._textureNodes[e]=t),t}getPreviousTextureNode(e="output"){let t=this._previousTextureNodes[e];return void 0===t&&(void 0===this._textureNodes[e]&&this.getTextureNode(e),t=Ii2(new Lb(this,e,!0)),t.updateTexture(),this._previousTextureNodes[e]=t),t}getViewZNode(e="depth"){let t=this._viewZNodes[e];if(void 0===t){const s=this._cameraNear,i=this._cameraFar;this._viewZNodes[e]=t=Zh2(this.getTextureNode(e),s,i)}return t}getLinearDepthNode(e="depth"){let t=this._linearDepthNodes[e];if(void 0===t){const s=this._cameraNear,i=this._cameraFar,r=this.getViewZNode(e);this._linearDepthNodes[e]=t=Yh2(r,s,i)}return t}async compileAsync(e){const t=e.getRenderTarget(),s=e.getMRT();e.setRenderTarget(this.renderTarget),e.setMRT(this._mrt),await e.compileAsync(this.scene,this.camera),e.setRenderTarget(t),e.setMRT(s)}setup({renderer:t}){return this.renderTarget.samples=void 0===this.options.samples?t.samples:this.options.samples,this.renderTarget.texture.type=t.getColorBufferType(),this.scope===e.COLOR?this.getTextureNode():this.getLinearDepthNode()}updateBefore(e){const{renderer:t}=e,{scene:s}=this;let i,r;const n=t.getOutputRenderTarget();n&&!0===n.isXRRenderTarget?(r=1,i=t.xr.getCamera(),t.xr.updateCamera(i),Pb.set(n.width,n.height)):(i=this.camera,r=t.getPixelRatio(),t.getSize(Pb)),this._pixelRatio=r,this.setSize(Pb.width,Pb.height);const a=t.getRenderTarget(),o=t.getMRT(),l=i.layers.mask;this._cameraNear.value=i.near,this._cameraFar.value=i.far,null!==this._layers&&(i.layers.mask=this._layers.mask);for(const e in this._previousTextures)this.toggleTexture(e);t.setRenderTarget(this.renderTarget),t.setMRT(this._mrt),t.render(s,i),t.setRenderTarget(a),t.setMRT(o),i.layers.mask=l}setSize(e,t){this._width=e,this._height=t;const s=this._width*this._pixelRatio*this._resolution,i=this._height*this._pixelRatio*this._resolution;this.renderTarget.setSize(s,i),null!==this._scissor&&this.renderTarget.scissor.copy(this._scissor),null!==this._viewport&&this.renderTarget.viewport.copy(this._viewport)}setScissor(e,t,s,i){null===e?this._scissor=null:(null===this._scissor&&(this._scissor=new As),e.isVector4?this._scissor.copy(e):this._scissor.set(e,t,s,i),this._scissor.multiplyScalar(this._pixelRatio*this._resolution).floor())}setViewport(e,t,s,i){null===e?this._viewport=null:(null===this._viewport&&(this._viewport=new As),e.isVector4?this._viewport.copy(e):this._viewport.set(e,t,s,i),this._viewport.multiplyScalar(this._pixelRatio*this._resolution).floor())}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget.dispose()}};Fb.COLOR="color",Fb.DEPTH="depth";var Ib=class extends Fb{static get type(){return"ToonOutlinePassNode"}constructor(e,t,s,i,r){super(Fb.COLOR,e,t),this.colorNode=s,this.thicknessNode=i,this.alphaNode=r,this._materialCache=new WeakMap}updateBefore(e){const{renderer:t}=e,s=t.getRenderObjectFunction();t.setRenderObjectFunction((e,s,i,r,n,a,o,l)=>{if((n.isMeshToonMaterial||n.isMeshToonNodeMaterial)&&!1===n.wireframe){const h=this._getOutlineMaterial(n);t.renderObject(e,s,i,r,h,a,o,l)}t.renderObject(e,s,i,r,n,a,o,l)}),super.updateBefore(e),t.setRenderObjectFunction(s)}_createMaterial(){const e=new yp;e.isMeshToonOutlineMaterial=!0,e.name="Toon_Outline",e.side=d2;const t=rd2.negate(),s=yl2.mul(kl2),i=Ki2(1),r=s.mul(un2(Wl2,1)),n=s.mul(un2(Wl2.add(t),1)),a=Ja2(r.sub(n));return e.vertexNode=r.add(a.mul(this.thicknessNode).mul(r.w).mul(i)),e.colorNode=un2(this.colorNode,this.alphaNode),e}_getOutlineMaterial(e){let t=this._materialCache.get(e);return void 0===t&&(t=this._createMaterial(),this._materialCache.set(e,t)),t}},Db=Hi2(([e,t])=>e.mul(t).clamp()).setLayout({name:"linearToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),Vb=Hi2(([e,t])=>(e=e.mul(t)).div(e.add(1)).clamp()).setLayout({name:"reinhardToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),Ub=Hi2(([e,t])=>{const s=(e=(e=e.mul(t)).sub(.004).max(0)).mul(e.mul(6.2).add(.5)),i=e.mul(e.mul(6.2).add(1.7)).add(.06);return s.div(i).pow(2.2)}).setLayout({name:"cineonToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),Ob=Hi2(([e])=>{const t=e.mul(e.add(.0245786)).sub(90537e-9),s=e.mul(e.add(.432951).mul(.983729)).add(.238081);return t.div(s)}),kb=Hi2(([e,t])=>{const s=pn2(.59719,.35458,.04823,.076,.90834,.01566,.0284,.13383,.83777),i=pn2(1.60475,-.53108,-.07367,-.10208,1.10813,-.00605,-.00327,-.07276,1.07602);return e=e.mul(t).div(.6),e=s.mul(e),e=Ob(e),(e=i.mul(e)).clamp()}).setLayout({name:"acesFilmicToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),Gb=pn2(sn2(1.6605,-.1246,-.0182),sn2(-.5876,1.1329,-.1006),sn2(-.0728,-.0083,1.1187)),zb=pn2(sn2(.6274,.0691,.0164),sn2(.3293,.9195,.088),sn2(.0433,.0113,.8956)),Hb=Hi2(([e])=>{const t=sn2(e).toVar(),s=sn2(t.mul(t)).toVar(),i=sn2(s.mul(s)).toVar();return Ki2(15.5).mul(i.mul(s)).sub(ha2(40.14,i.mul(t))).add(ha2(31.96,i).sub(ha2(6.868,s.mul(t))).add(ha2(.4298,s).add(ha2(.1191,t).sub(.00232))))}),$b=Hi2(([e,t])=>{const s=sn2(e).toVar(),i=pn2(sn2(.856627153315983,.137318972929847,.11189821299995),sn2(.0951212405381588,.761241990602591,.0767994186031903),sn2(.0482516061458583,.101439036467562,.811302368396859)),r=pn2(sn2(1.1271005818144368,-.1413297634984383,-.14132976349843826),sn2(-.11060664309660323,1.157823702216272,-.11060664309660294),sn2(-.016493938717834573,-.016493938717834257,1.2519364065950405)),n=Ki2(-12.47393),a=Ki2(4.026069);return s.mulAssign(t),s.assign(zb.mul(s)),s.assign(i.mul(s)),s.assign(Eo2(s,1e-10)),s.assign(Xa2(s)),s.assign(s.sub(n).div(a.sub(n))),s.assign(ko2(s,0,1)),s.assign(Hb(s)),s.assign(r.mul(s)),s.assign(Bo(Eo2(sn2(0),s),sn2(2.2))),s.assign(Gb.mul(s)),s.assign(ko2(s,0,1)),s}).setLayout({name:"agxToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),Wb=Hi2(([e,t])=>{const s=Ki2(.76),i=Ki2(.15);e=e.mul(t);const r=So2(e.r,So2(e.g,e.b)),n=Jo2(r.lessThan(.08),r.sub(ha2(6.25,r.mul(r))),.04);e.subAssign(n);const a=Eo2(e.r,Eo2(e.g,e.b));qi2(a.lessThan(s),()=>e);const o=ca2(1,s),l=ca2(1,o.mul(o).div(a.add(o.sub(s))));e.mulAssign(l.div(a));const h=ca2(1,pa(1,i.mul(a.sub(l)).add(1)));return Oo2(e,sn2(l),h)}).setLayout({name:"neutralToneMapping",type:"vec3",inputs:[{name:"color",type:"vec3"},{name:"exposure",type:"float"}]}),qb=class extends js2{static get type(){return"CodeNode"}constructor(e="",t=[],s=""){super("code"),this.isCodeNode=!0,this.global=!0,this.code=e,this.includes=t,this.language=s}setIncludes(e){return this.includes=e,this}getIncludes(){return this.includes}generate(e){const t=this.getIncludes(e);for(const s of t)s.build(e);const s=e.getCodeFromNode(this,this.getNodeType(e));return s.code=this.code,s.code}serialize(e){super.serialize(e),e.code=this.code,e.language=this.language}deserialize(e){super.deserialize(e),this.code=e.code,this.language=e.language}},jb=Oi2(qb).setParameterLength(1,3),Xb=class extends qb{static get type(){return"FunctionNode"}constructor(e="",t=[],s=""){super(e,t,s)}getNodeType(e){return this.getNodeFunction(e).type}getInputs(e){return this.getNodeFunction(e).inputs}getNodeFunction(e){const t=e.getDataFromNode(this);let s=t.nodeFunction;return void 0===s&&(s=e.parser.parseFunction(this.code),t.nodeFunction=s),s}generate(e,t){super.generate(e);const s=this.getNodeFunction(e),i=s.name,r=s.type,n=e.getCodeFromNode(this,r);""!==i&&(n.name=i);const a=e.getPropertyName(n),o=this.getNodeFunction(e).getCode(a);return n.code=o+"\n","property"===t?a:e.format(`${a}()`,r,t)}},Kb=(e,t=[],s="")=>{for(let e=0;e<t.length;e++){const s=t[e];"function"==typeof s&&(t[e]=s.functionNode)}const i=Ii2(new Xb(e,t,s)),r=(...e)=>i.call(...e);return r.functionNode=i,r},Yb=class extends js2{static get type(){return"ScriptableValueNode"}constructor(e=null){super(),this._value=e,this._cache=null,this.inputType=null,this.outputType=null,this.events=new Fi,this.isScriptableValueNode=!0}get isScriptableOutputNode(){return null!==this.outputType}set value(e){this._value!==e&&(this._cache&&"URL"===this.inputType&&this.value.value instanceof ArrayBuffer&&(URL.revokeObjectURL(this._cache),this._cache=null),this._value=e,this.events.dispatchEvent({type:"change"}),this.refresh())}get value(){return this._value}refresh(){this.events.dispatchEvent({type:"refresh"})}getValue(){const e=this.value;if(e&&null===this._cache&&"URL"===this.inputType&&e.value instanceof ArrayBuffer)this._cache=URL.createObjectURL(new Blob([e.value]));else if(e&&null!==e.value&&void 0!==e.value&&(("URL"===this.inputType||"String"===this.inputType)&&"string"==typeof e.value||"Number"===this.inputType&&"number"==typeof e.value||"Vector2"===this.inputType&&e.value.isVector2||"Vector3"===this.inputType&&e.value.isVector3||"Vector4"===this.inputType&&e.value.isVector4||"Color"===this.inputType&&e.value.isColor||"Matrix3"===this.inputType&&e.value.isMatrix3||"Matrix4"===this.inputType&&e.value.isMatrix4))return e.value;return this._cache||e}getNodeType(e){return this.value&&this.value.isNode?this.value.getNodeType(e):"float"}setup(){return this.value&&this.value.isNode?this.value:Ki2()}serialize(e){super.serialize(e),null!==this.value?"ArrayBuffer"===this.inputType?e.value=Fs2(this.value):e.value=this.value?this.value.toJSON(e.meta).uuid:null:e.value=null,e.inputType=this.inputType,e.outputType=this.outputType}deserialize(e){super.deserialize(e);let t=null;null!==e.value&&(t="ArrayBuffer"===e.inputType?Is2(e.value):"Texture"===e.inputType?e.meta.textures[e.value]:e.meta.nodes[e.value]||null),this.value=t,this.inputType=e.inputType,this.outputType=e.outputType}},Qb=Oi2(Yb).setParameterLength(1),Zb=class extends Map{get(e,t=null,...s){if(this.has(e))return super.get(e);if(null!==t){const i=t(...s);return this.set(e,i),i}}},Jb=class{constructor(e){this.scriptableNode=e}get parameters(){return this.scriptableNode.parameters}get layout(){return this.scriptableNode.getLayout()}getInputLayout(e){return this.scriptableNode.getInputLayout(e)}get(e){const t=this.parameters[e];return t?t.getValue():null}},ex=new Zb,tx=class extends js2{static get type(){return"ScriptableNode"}constructor(e=null,t={}){super(),this.codeNode=e,this.parameters=t,this._local=new Zb,this._output=Qb(null),this._outputs={},this._source=this.source,this._method=null,this._object=null,this._value=null,this._needsOutputUpdate=!0,this.onRefresh=this.onRefresh.bind(this),this.isScriptableNode=!0}get source(){return this.codeNode?this.codeNode.code:""}setLocal(e,t){return this._local.set(e,t)}getLocal(e){return this._local.get(e)}onRefresh(){this._refresh()}getInputLayout(e){for(const t of this.getLayout())if(t.inputType&&(t.id===e||t.name===e))return t}getOutputLayout(e){for(const t of this.getLayout())if(t.outputType&&(t.id===e||t.name===e))return t}setOutput(e,t){const s=this._outputs;return void 0===s[e]?s[e]=Qb(t):s[e].value=t,this}getOutput(e){return this._outputs[e]}getParameter(e){return this.parameters[e]}setParameter(e,t){const s=this.parameters;return t&&t.isScriptableNode?(this.deleteParameter(e),s[e]=t,s[e].getDefaultOutput().events.addEventListener("refresh",this.onRefresh)):t&&t.isScriptableValueNode?(this.deleteParameter(e),s[e]=t,s[e].events.addEventListener("refresh",this.onRefresh)):void 0===s[e]?(s[e]=Qb(t),s[e].events.addEventListener("refresh",this.onRefresh)):s[e].value=t,this}getValue(){return this.getDefaultOutput().getValue()}deleteParameter(e){let t=this.parameters[e];return t&&(t.isScriptableNode&&(t=t.getDefaultOutput()),t.events.removeEventListener("refresh",this.onRefresh)),this}clearParameters(){for(const e of Object.keys(this.parameters))this.deleteParameter(e);return this.needsUpdate=!0,this}call(e,...t){const s=this.getObject()[e];if("function"==typeof s)return s(...t)}async callAsync(e,...t){const s=this.getObject()[e];if("function"==typeof s)return"AsyncFunction"===s.constructor.name?await s(...t):s(...t)}getNodeType(e){return this.getDefaultOutputNode().getNodeType(e)}refresh(e=null){null!==e?this.getOutput(e).refresh():this._refresh()}getObject(){if(this.needsUpdate&&this.dispose(),null!==this._object)return this._object;const e=new Jb(this),t=ex.get("THREE"),s=ex.get("TSL"),i=this.getMethod(),r=[e,this._local,ex,()=>this.refresh(),(e,t)=>this.setOutput(e,t),t,s];this._object=i(...r);const n=this._object.layout;if(n&&(!1===n.cache&&this._local.clear(),this._output.outputType=n.outputType||null,Array.isArray(n.elements)))for(const e of n.elements){const t=e.id||e.name;e.inputType&&(void 0===this.getParameter(t)&&this.setParameter(t,null),this.getParameter(t).inputType=e.inputType),e.outputType&&(void 0===this.getOutput(t)&&this.setOutput(t,null),this.getOutput(t).outputType=e.outputType)}return this._object}deserialize(e){super.deserialize(e);for(const e in this.parameters){let t=this.parameters[e];t.isScriptableNode&&(t=t.getDefaultOutput()),t.events.addEventListener("refresh",this.onRefresh)}}getLayout(){return this.getObject().layout}getDefaultOutputNode(){const e=this.getDefaultOutput().value;return e&&e.isNode?e:Ki2()}getDefaultOutput(){return this._exec()._output}getMethod(){if(this.needsUpdate&&this.dispose(),null!==this._method)return this._method;const e=["layout","init","main","dispose"].join(", "),t="\nreturn { ...output, "+e+" };",s="var "+e+"; var output = {};\n"+this.codeNode.code+t;return this._method=new Function(...["parameters","local","global","refresh","setOutput","THREE","TSL"],s),this._method}dispose(){null!==this._method&&(this._object&&"function"==typeof this._object.dispose&&this._object.dispose(),this._method=null,this._object=null,this._source=null,this._value=null,this._needsOutputUpdate=!0,this._output.value=null,this._outputs={})}setup(){return this.getDefaultOutputNode()}getCacheKey(e){const t=[xs2(this.source),this.getDefaultOutputNode().getCacheKey(e)];for(const s in this.parameters)t.push(this.parameters[s].getCacheKey(e));return Ts2(t)}set needsUpdate(e){!0===e&&this.dispose()}get needsUpdate(){return this.source!==this._source}_exec(){return null===this.codeNode||(!0===this._needsOutputUpdate&&(this._value=this.call("main"),this._needsOutputUpdate=!1),this._output.value=this._value),this}_refresh(){this.needsUpdate=!0,this._exec(),this._output.refresh()}},rx=Oi2(tx).setParameterLength(1,2);function sx(e){let t;const s=e.context.getViewZ;return void 0!==s&&(t=s(this)),(t||Kl2.z).negate()}var ix=Hi2(([e,t],s)=>{const i=sx(s);return Ho2(e,t,i)}),nx=Hi2(([e],t)=>{const s=sx(t);return e.mul(e,s,s).negate().exp().oneMinus()}),ax=Hi2(([e,t])=>un2(t.toFloat().mix(Un2.rgb,e.toVec3()),Un2.a)),ox=null,ux=null,lx=class extends js2{static get type(){return"RangeNode"}constructor(e=Ki2(),t=Ki2()){super(),this.minNode=e,this.maxNode=t}getVectorLength(e){const t=e.getTypeLength(Ps2(this.minNode.value)),s=e.getTypeLength(Ps2(this.maxNode.value));return t>s?t:s}getNodeType(e){return e.object.count>1?e.getTypeFromLength(this.getVectorLength(e)):"float"}setup(e){const t=e.object;let s=null;if(t.count>1){const i=this.minNode.value,r=this.maxNode.value,n=e.getTypeLength(Ps2(i)),a=e.getTypeLength(Ps2(r));ox=ox||new As,ux=ux||new As,ox.setScalar(0),ux.setScalar(0),1===n?ox.setScalar(i):i.isColor?ox.set(i.r,i.g,i.b,1):ox.set(i.x,i.y,i.z||0,i.w||0),1===a?ux.setScalar(r):r.isColor?ux.set(r.r,r.g,r.b,1):ux.set(r.x,r.y,r.z||0,r.w||0);const o=4,l=o*t.count,h=new Float32Array(l);for(let e=0;e<l;e++){const t=e%o,s=ox.getComponent(t),i=ux.getComponent(t);h[e]=Zi.lerp(s,i,Math.random())}const u=this.getNodeType(e);if(t.count<=4096)s=ll2(h,"vec4",t.count).element(eh2).convert(u);else{const t=new Ja(h,4);e.geometry.setAttribute("__range"+this.id,t),s=Pu2(t).convert(u)}}else s=Ki2(0);return s}},dx=Oi2(lx).setParameterLength(2),cx=class extends js2{static get type(){return"ComputeBuiltinNode"}constructor(e,t){super(t),this._builtinName=e}getHash(e){return this.getBuiltinName(e)}getNodeType(){return this.nodeType}setBuiltinName(e){return this._builtinName=e,this}getBuiltinName(){return this._builtinName}hasBuiltin(e){return e.hasBuiltin(this._builtinName)}generate(e,t){const s=this.getBuiltinName(e),i=this.getNodeType(e);return"compute"===e.shaderStage?e.format(s,i,t):(console.warn(`ComputeBuiltinNode: Compute built-in value ${s} can not be accessed in the ${e.shaderStage} stage`),e.generateConst(i))}serialize(e){super.serialize(e),e.global=this.global,e._builtinName=this._builtinName}deserialize(e){super.deserialize(e),this.global=e.global,this._builtinName=e._builtinName}},hx=(e,t)=>Ii2(new cx(e,t)),px=hx("numWorkgroups","uvec3"),gx=hx("workgroupId","uvec3"),mx=hx("globalId","uvec3"),fx=hx("localId","uvec3"),yx=hx("subgroupSize","uint"),bx=Oi2(class extends js2{constructor(e){super(),this.scope=e}generate(e){const{scope:t}=this,{renderer:s}=e;!0===s.backend.isWebGLBackend?e.addFlowCode(`\t// ${t}Barrier \n`):e.addLineFlowCode(`${t}Barrier()`,this)}}),xx=class extends Xs2{constructor(e,t){super(e,t),this.isWorkgroupInfoElementNode=!0}generate(e,t){let s;const i=e.context.assign;if(s=super.generate(e),!0!==i){const i=this.getNodeType(e);s=e.format(s,i,t)}return s}},Tx=class extends js2{constructor(e,t,s=0){super(t),this.bufferType=t,this.bufferCount=s,this.isWorkgroupInfoNode=!0,this.elementType=t,this.scope=e,this.name=""}setName(e){return this.name=e,this}label(e){return console.warn('THREE.TSL: "label()" has been deprecated. Use "setName()" instead.'),this.setName(e)}setScope(e){return this.scope=e,this}getElementType(){return this.elementType}getInputType(){return`${this.scope}Array`}element(e){return Ii2(new xx(this,e))}generate(e){const t=""!==this.name?this.name:`${this.scope}Array_${this.id}`;return e.getScopedArray(t,this.scope.toLowerCase(),this.bufferType,this.bufferCount)}},_x=class extends js2{static get type(){return"AtomicFunctionNode"}constructor(e,t,s){super("uint"),this.method=e,this.pointerNode=t,this.valueNode=s,this.parents=!0}getInputType(e){return this.pointerNode.getNodeType(e)}getNodeType(e){return this.getInputType(e)}generate(e){const t=e.getNodeProperties(this),s=t.parents,i=this.method,r=this.getNodeType(e),n=this.getInputType(e),a=this.pointerNode,o=this.valueNode,l=[];l.push(`&${a.build(e,n)}`),null!==o&&l.push(o.build(e,n));const h=`${e.getMethod(i,r)}( ${l.join(", ")} )`;if(!s||1!==s.length||!0!==s[0].isStackNode)return void 0===t.constNode&&(t.constNode=$u2(h,r).toConst()),t.constNode.build(e);e.addLineFlowCode(h,this)}};_x.ATOMIC_LOAD="atomicLoad",_x.ATOMIC_STORE="atomicStore",_x.ATOMIC_ADD="atomicAdd",_x.ATOMIC_SUB="atomicSub",_x.ATOMIC_MAX="atomicMax",_x.ATOMIC_MIN="atomicMin",_x.ATOMIC_AND="atomicAnd",_x.ATOMIC_OR="atomicOr",_x.ATOMIC_XOR="atomicXor";var vx=Oi2(_x),Nx=(e,t,s)=>vx(e,t,s).toStack(),Sx;function Ex(e){let t=(Sx=Sx||new WeakMap).get(e);return void 0===t&&Sx.set(e,t={}),t}function wx(e){const t=Ex(e);return t.shadowMatrix||(t.shadowMatrix=ta2("mat4").setGroup(Zn2).onRenderUpdate(t=>(!0===e.castShadow&&!1!==t.renderer.shadowMap.enabled||e.shadow.updateMatrices(e),e.shadow.matrix)))}function Ax(e,t=jl2){const s=wx(e).mul(t);return s.xyz.div(s.w)}function Rx(e){const t=Ex(e);return t.position||(t.position=ta2(new Qi).setGroup(Zn2).onRenderUpdate((t,s)=>s.value.setFromMatrixPosition(e.matrixWorld)))}function Cx(e){const t=Ex(e);return t.targetPosition||(t.targetPosition=ta2(new Qi).setGroup(Zn2).onRenderUpdate((t,s)=>s.value.setFromMatrixPosition(e.target.matrixWorld)))}function Mx(e){const t=Ex(e);return t.viewPosition||(t.viewPosition=ta2(new Qi).setGroup(Zn2).onRenderUpdate(({camera:t},s)=>{s.value=s.value||new Qi,s.value.setFromMatrixPosition(e.matrixWorld),s.value.applyMatrix4(t.matrixWorldInverse)}))}var Px=e=>xl2.transformDirection(Rx(e).sub(Cx(e))),Bx=(e,t)=>{for(const s of t)if(s.isAnalyticLightNode&&s.light.id===e)return s;return null},Lx=new WeakMap,Fx=[],Ix=class extends js2{static get type(){return"LightsNode"}constructor(){super("vec3"),this.totalDiffuseNode=bn2("vec3","totalDiffuse"),this.totalSpecularNode=bn2("vec3","totalSpecular"),this.outgoingLightNode=bn2("vec3","outgoingLight"),this._lights=[],this._lightNodes=null,this._lightNodesHash=null,this.global=!0}customCacheKey(){const e=this._lights;for(let t=0;t<e.length;t++){const s=e[t];if(Fx.push(s.id),Fx.push(s.castShadow?1:0),!0===s.isSpotLight){const e=null!==s.map?s.map.id:-1,t=s.colorNode?s.colorNode.getCacheKey():-1;Fx.push(e,t)}}const t=Ts2(Fx);return Fx.length=0,t}getHash(e){if(null===this._lightNodesHash){null===this._lightNodes&&this.setupLightsNode(e);const t=[];for(const e of this._lightNodes)t.push(e.getSelf().getHash());this._lightNodesHash="lights-"+t.join(",")}return this._lightNodesHash}analyze(e){const t=e.getNodeProperties(this);for(const s of t.nodes)s.build(e);t.outputNode.build(e)}setupLightsNode(e){const t=[],s=this._lightNodes,i=(()=>this._lights.sort((e,t)=>e.id-t.id))(),r=e.renderer.library;for(const e of i)if(e.isNode)t.push(Ii2(e));else{let i=null;if(null!==s&&(i=Bx(e.id,s)),null===i){const s=r.getLightNodeClass(e.constructor);if(null===s){console.warn(`LightsNode.setupNodeLights: Light node not found for ${e.constructor.name}`);continue}let i=null;Lx.has(e)?i=Lx.get(e):(i=Ii2(new s(e)),Lx.set(e,i)),t.push(i)}}this._lightNodes=t}setupDirectLight(e,t,s){const{lightingModel:i,reflectedLight:r}=e.context;i.direct({...s,lightNode:t,reflectedLight:r},e)}setupDirectRectAreaLight(e,t,s){const{lightingModel:i,reflectedLight:r}=e.context;i.directRectArea({...s,lightNode:t,reflectedLight:r},e)}setupLights(e,t){for(const s of t)s.build(e)}getLightNodes(e){return null===this._lightNodes&&this.setupLightsNode(e),this._lightNodes}setup(e){const t=e.lightsNode;e.lightsNode=this;let s=this.outgoingLightNode;const i=e.context,r=i.lightingModel,n=e.getNodeProperties(this);if(r){const{totalDiffuseNode:t,totalSpecularNode:a}=this;i.outgoingLight=s;const o=e.addStack();n.nodes=o.nodes,r.start(e);const{backdrop:l,backdropAlpha:h}=i,{directDiffuse:u,directSpecular:c,indirectDiffuse:d,indirectSpecular:p}=i.reflectedLight;let _=u.add(d);null!==l&&(_=sn2(null!==h?h.mix(_,l):l),i.material.transparent=!0),t.assign(_),a.assign(c.add(p)),s.assign(t.add(a)),r.finish(e),s=s.bypass(e.removeStack())}else n.nodes=[];return e.lightsNode=t,s}setLights(e){return this._lights=e,this._lightNodes=null,this._lightNodesHash=null,this}getLights(){return this._lights}get hasLights(){return this._lights.length>0}},Dx=class extends js2{static get type(){return"ShadowBaseNode"}constructor(e){super(),this.light=e,this.updateBeforeType=Us2.RENDER,this.isShadowBaseNode=!0}setupShadowPosition({context:e,material:t}){Vx.assign(t.receivedShadowPositionNode||e.shadowPositionWorld||jl2)}},Vx=bn2("vec3","shadowPositionWorld");function Ux(e,t={}){return t.toneMapping=e.toneMapping,t.toneMappingExposure=e.toneMappingExposure,t.outputColorSpace=e.outputColorSpace,t.renderTarget=e.getRenderTarget(),t.activeCubeFace=e.getActiveCubeFace(),t.activeMipmapLevel=e.getActiveMipmapLevel(),t.renderObjectFunction=e.getRenderObjectFunction(),t.pixelRatio=e.getPixelRatio(),t.mrt=e.getMRT(),t.clearColor=e.getClearColor(t.clearColor||new $r),t.clearAlpha=e.getClearAlpha(),t.autoClear=e.autoClear,t.scissorTest=e.getScissorTest(),t}function Ox(e,t){return t=Ux(e,t),e.setMRT(null),e.setRenderObjectFunction(null),e.setClearColor(0,1),e.autoClear=!0,t}function kx(e,t){e.toneMapping=t.toneMapping,e.toneMappingExposure=t.toneMappingExposure,e.outputColorSpace=t.outputColorSpace,e.setRenderTarget(t.renderTarget,t.activeCubeFace,t.activeMipmapLevel),e.setRenderObjectFunction(t.renderObjectFunction),e.setPixelRatio(t.pixelRatio),e.setMRT(t.mrt),e.setClearColor(t.clearColor,t.clearAlpha),e.autoClear=t.autoClear,e.setScissorTest(t.scissorTest)}function Gx(e,t={}){return t.background=e.background,t.backgroundNode=e.backgroundNode,t.overrideMaterial=e.overrideMaterial,t}function zx(e,t){return t=Gx(e,t),e.background=null,e.backgroundNode=null,e.overrideMaterial=null,t}function Hx(e,t){e.background=t.background,e.backgroundNode=t.backgroundNode,e.overrideMaterial=t.overrideMaterial}function $x(e,t,s){return zx(t,s=Ox(e,s))}function Wx(e,t,s){kx(e,s),Hx(t,s)}var qx=Object.freeze({__proto__:null,resetRendererAndSceneState:$x,resetRendererState:Ox,resetSceneState:zx,restoreRendererAndSceneState:Wx,restoreRendererState:kx,restoreSceneState:Hx,saveRendererAndSceneState:function(e,t,s={}){return Gx(t,s=Ux(e,s))},saveRendererState:Ux,saveSceneState:Gx}),jx=new WeakMap,Xx=Hi2(({depthTexture:e,shadowCoord:t,depthLayer:s})=>{let i=al2(e,t.xy).setName("t_basic");return e.isArrayTexture&&(i=i.depth(s)),i.compare(t.z)}),Kx=Hi2(({depthTexture:e,shadowCoord:t,shadow:s,depthLayer:i})=>{const r=(t,s)=>{let r=al2(e,t);return e.isArrayTexture&&(r=r.depth(i)),r.compare(s)},n=Cd2("mapSize","vec2",s).setGroup(Zn2),a=Cd2("radius","float",s).setGroup(Zn2),o=Ji2(1).div(n),l=o.x.negate().mul(a),h=o.y.negate().mul(a),u=o.x.mul(a),c=o.y.mul(a),d=l.div(2),p=h.div(2),_=u.div(2),m=c.div(2);return da2(r(t.xy.add(Ji2(l,h)),t.z),r(t.xy.add(Ji2(0,h)),t.z),r(t.xy.add(Ji2(u,h)),t.z),r(t.xy.add(Ji2(d,p)),t.z),r(t.xy.add(Ji2(0,p)),t.z),r(t.xy.add(Ji2(_,p)),t.z),r(t.xy.add(Ji2(l,0)),t.z),r(t.xy.add(Ji2(d,0)),t.z),r(t.xy,t.z),r(t.xy.add(Ji2(_,0)),t.z),r(t.xy.add(Ji2(u,0)),t.z),r(t.xy.add(Ji2(d,m)),t.z),r(t.xy.add(Ji2(0,m)),t.z),r(t.xy.add(Ji2(_,m)),t.z),r(t.xy.add(Ji2(l,c)),t.z),r(t.xy.add(Ji2(0,c)),t.z),r(t.xy.add(Ji2(u,c)),t.z)).mul(1/17)}),Yx=Hi2(({depthTexture:e,shadowCoord:t,shadow:s,depthLayer:i})=>{const r=(t,s)=>{let r=al2(e,t);return e.isArrayTexture&&(r=r.depth(i)),r.compare(s)},n=Cd2("mapSize","vec2",s).setGroup(Zn2),a=Ji2(1).div(n),o=a.x,l=a.y,h=t.xy,u=eo2(h.mul(n).add(.5));return h.subAssign(u.mul(a)),da2(r(h,t.z),r(h.add(Ji2(o,0)),t.z),r(h.add(Ji2(0,l)),t.z),r(h.add(a),t.z),Oo2(r(h.add(Ji2(o.negate(),0)),t.z),r(h.add(Ji2(o.mul(2),0)),t.z),u.x),Oo2(r(h.add(Ji2(o.negate(),l)),t.z),r(h.add(Ji2(o.mul(2),l)),t.z),u.x),Oo2(r(h.add(Ji2(0,l.negate())),t.z),r(h.add(Ji2(0,l.mul(2))),t.z),u.y),Oo2(r(h.add(Ji2(o,l.negate())),t.z),r(h.add(Ji2(o,l.mul(2))),t.z),u.y),Oo2(Oo2(r(h.add(Ji2(o.negate(),l.negate())),t.z),r(h.add(Ji2(o.mul(2),l.negate())),t.z),u.x),Oo2(r(h.add(Ji2(o.negate(),l.mul(2))),t.z),r(h.add(Ji2(o.mul(2),l.mul(2))),t.z),u.x),u.y)).mul(1/9)}),Qx=Hi2(({depthTexture:e,shadowCoord:t,depthLayer:s})=>{const i=Ki2(1).toVar();let r=al2(e).sample(t.xy);e.isArrayTexture&&(r=r.depth(s)),r=r.rg;const n=wo2(t.z,r.x);return qi2(n.notEqual(Ki2(1)),()=>{const e=t.z.sub(r.x),s=Eo2(0,r.y.mul(r.y));let a=s.div(s.add(e.mul(e)));a=ko2(ca2(a,.3).div(.95-.3)),i.assign(ko2(Eo2(n,a)))}),i}),Zx=Hi2(([e,t,s])=>{let i=jl2.sub(e).length();return i=i.sub(t).div(s.sub(t)),i=i.saturate(),i}),Jx=e=>{let t=jx.get(e);if(void 0===t){const s=e.isPointLight?(e=>{const t=e.shadow.camera,s=Cd2("near","float",t).setGroup(Zn2),i=Cd2("far","float",t).setGroup(Zn2),r=Al2(e);return Zx(r,s,i)})(e):null;t=new yp,t.colorNode=un2(0,0,0,1),t.depthNode=s,t.isShadowPassMaterial=!0,t.name="ShadowMaterial",t.fog=!1,jx.set(e,t)}return t},eT=new gf,tT=[],rT=(e,t,s,i)=>{tT[0]=e,tT[1]=t;let r=eT.get(tT);return void 0!==r&&r.shadowType===s&&r.useVelocity===i||(r=(r,n,a,o,l,h,...u)=>{(!0===r.castShadow||r.receiveShadow&&s===c2)&&(i&&(Ls2(r).useVelocity=!0),r.onBeforeShadow(e,r,a,t.camera,o,n.overrideMaterial,h),e.renderObject(r,n,a,o,l,h,...u),r.onAfterShadow(e,r,a,t.camera,o,n.overrideMaterial,h))},r.shadowType=s,r.useVelocity=i,eT.set(tT,r)),tT[0]=null,tT[1]=null,r},sT=Hi2(({samples:e,radius:t,size:s,shadowPass:i,depthLayer:r})=>{const n=Ki2(0).toVar("meanVertical"),a=Ki2(0).toVar("squareMeanVertical"),o=e.lessThanEqual(Ki2(1)).select(Ki2(0),Ki2(2).div(e.sub(1))),l=e.lessThanEqual(Ki2(1)).select(Ki2(0),Ki2(-1));xh2({start:Yi2(0),end:Yi2(e),type:"int",condition:"<"},({i:e})=>{const h=l.add(Ki2(e).mul(o));let u=i.sample(da2(Dh2.xy,Ji2(0,h).mul(t)).div(s));i.value.isArrayTexture&&(u=u.depth(r)),u=u.x,n.addAssign(u),a.addAssign(u.mul(u))}),n.divAssign(e),a.divAssign(e);const h=Ka2(a.sub(n.mul(n)));return Ji2(n,h)}),iT=Hi2(({samples:e,radius:t,size:s,shadowPass:i,depthLayer:r})=>{const n=Ki2(0).toVar("meanHorizontal"),a=Ki2(0).toVar("squareMeanHorizontal"),o=e.lessThanEqual(Ki2(1)).select(Ki2(0),Ki2(2).div(e.sub(1))),l=e.lessThanEqual(Ki2(1)).select(Ki2(0),Ki2(-1));xh2({start:Yi2(0),end:Yi2(e),type:"int",condition:"<"},({i:e})=>{const h=l.add(Ki2(e).mul(o));let u=i.sample(da2(Dh2.xy,Ji2(h,0).mul(t)).div(s));i.value.isArrayTexture&&(u=u.depth(r)),n.addAssign(u.x),a.addAssign(da2(u.y.mul(u.y),u.x.mul(u.x)))}),n.divAssign(e),a.divAssign(e);const h=Ka2(a.sub(n.mul(n)));return Ji2(n,h)}),nT=[Xx,Kx,Yx,Qx],aT,oT=new qy,uT=class extends Dx{static get type(){return"ShadowNode"}constructor(e,t=null){super(e),this.shadow=t||e.shadow,this.shadowMap=null,this.vsmShadowMapVertical=null,this.vsmShadowMapHorizontal=null,this.vsmMaterialVertical=null,this.vsmMaterialHorizontal=null,this._node=null,this._cameraFrameId=new WeakMap,this.isShadowNode=!0,this.depthLayer=0}setupShadowFilter(e,{filterFn:t,depthTexture:s,shadowCoord:i,shadow:r,depthLayer:n}){const a=i.x.greaterThanEqual(0).and(i.x.lessThanEqual(1)).and(i.y.greaterThanEqual(0)).and(i.y.lessThanEqual(1)).and(i.z.lessThanEqual(1)),o=t({depthTexture:s,shadowCoord:i,shadow:r,depthLayer:n});return a.select(o,Ki2(1))}setupShadowCoord(e,t){const{shadow:s}=this,{renderer:i}=e,r=Cd2("bias","float",s).setGroup(Zn2);let n,a=t;if(s.camera.isOrthographicCamera||!0!==i.logarithmicDepthBuffer)a=a.xyz.div(a.w),n=a.z,i.coordinateSystem===Pi&&(n=n.mul(2).sub(1));else{const e=a.w;a=a.xy.div(e);const t=Cd2("near","float",s.camera).setGroup(Zn2),i=Cd2("far","float",s.camera).setGroup(Zn2);n=Jh2(e.negate(),t,i)}return a=sn2(a.x,a.y.oneMinus(),n.add(r)),a}getShadowFilterFn(e){return nT[e]}setupRenderTarget(e,t){const s=new ah(e.mapSize.width,e.mapSize.height);s.name="ShadowDepthTexture",s.compareFunction=yi;const i=t.createRenderTarget(e.mapSize.width,e.mapSize.height);return i.texture.name="ShadowMap",i.texture.type=e.mapType,i.depthTexture=s,{shadowMap:i,depthTexture:s}}setupShadow(e){const{renderer:t}=e,{light:s,shadow:i}=this,r=t.shadowMap.type,{depthTexture:n,shadowMap:a}=this.setupRenderTarget(i,e);if(i.camera.updateProjectionMatrix(),r===c2&&!0!==i.isPointLightShadow){n.compareFunction=null,a.depth>1?(a._vsmShadowMapVertical||(a._vsmShadowMapVertical=e.createRenderTarget(i.mapSize.width,i.mapSize.height,{format:qt,type:Rt,depth:a.depth,depthBuffer:!1}),a._vsmShadowMapVertical.texture.name="VSMVertical"),this.vsmShadowMapVertical=a._vsmShadowMapVertical,a._vsmShadowMapHorizontal||(a._vsmShadowMapHorizontal=e.createRenderTarget(i.mapSize.width,i.mapSize.height,{format:qt,type:Rt,depth:a.depth,depthBuffer:!1}),a._vsmShadowMapHorizontal.texture.name="VSMHorizontal"),this.vsmShadowMapHorizontal=a._vsmShadowMapHorizontal):(this.vsmShadowMapVertical=e.createRenderTarget(i.mapSize.width,i.mapSize.height,{format:qt,type:Rt,depthBuffer:!1}),this.vsmShadowMapHorizontal=e.createRenderTarget(i.mapSize.width,i.mapSize.height,{format:qt,type:Rt,depthBuffer:!1}));let t=al2(n);n.isArrayTexture&&(t=t.depth(this.depthLayer));let s=al2(this.vsmShadowMapVertical.texture);n.isArrayTexture&&(s=s.depth(this.depthLayer));const r=Cd2("blurSamples","float",i).setGroup(Zn2),o=Cd2("radius","float",i).setGroup(Zn2),l=Cd2("mapSize","vec2",i).setGroup(Zn2);let h=this.vsmMaterialVertical||(this.vsmMaterialVertical=new yp);h.fragmentNode=sT({samples:r,radius:o,size:l,shadowPass:t,depthLayer:this.depthLayer}).context(e.getSharedContext()),h.name="VSMVertical",h=this.vsmMaterialHorizontal||(this.vsmMaterialHorizontal=new yp),h.fragmentNode=iT({samples:r,radius:o,size:l,shadowPass:s,depthLayer:this.depthLayer}).context(e.getSharedContext()),h.name="VSMHorizontal"}const o=Cd2("intensity","float",i).setGroup(Zn2),l=Cd2("normalBias","float",i).setGroup(Zn2),h=wx(s).mul(Vx.add(od2.mul(l))),u=this.setupShadowCoord(e,h),c=i.filterNode||this.getShadowFilterFn(t.shadowMap.type)||null;if(null===c)throw new Error("THREE.WebGPURenderer: Shadow map type not supported yet.");const d=r===c2&&!0!==i.isPointLightShadow?this.vsmShadowMapHorizontal.texture:n,p=this.setupShadowFilter(e,{filterFn:c,shadowTexture:a.texture,depthTexture:d,shadowCoord:u,shadow:i,depthLayer:this.depthLayer});let _=al2(a.texture,u);n.isArrayTexture&&(_=_.depth(this.depthLayer));const m=Oo2(1,p.rgb.mix(_,1),o.mul(_.a)).toVar();return this.shadowMap=a,this.shadow.map=a,m}setup(e){if(!1!==e.renderer.shadowMap.enabled)return Hi2(()=>{let t=this._node;return this.setupShadowPosition(e),null===t&&(this._node=t=this.setupShadow(e)),e.material.shadowNode&&console.warn('THREE.NodeMaterial: ".shadowNode" is deprecated. Use ".castShadowNode" instead.'),e.material.receivedShadowNode&&(t=e.material.receivedShadowNode(t)),t})()}renderShadow(e){const{shadow:t,shadowMap:s,light:i}=this,{renderer:r,scene:n}=e;t.updateMatrices(i),s.setSize(t.mapSize.width,t.mapSize.height,s.depth),r.render(n,t.camera)}updateShadow(e){const{shadowMap:t,light:s,shadow:i}=this,{renderer:r,scene:n,camera:a}=e,o=r.shadowMap.type,l=t.depthTexture.version;this._depthVersionCached=l;const h=i.camera.layers.mask;4294967294&i.camera.layers.mask||(i.camera.layers.mask=a.layers.mask);const u=r.getRenderObjectFunction(),c=r.getMRT(),d=!!c&&c.has("velocity");aT=$x(r,n,aT),n.overrideMaterial=Jx(s),r.setRenderObjectFunction(rT(r,i,o,d)),r.setClearColor(0,0),r.setRenderTarget(t),this.renderShadow(e),r.setRenderObjectFunction(u),o===c2&&!0!==i.isPointLightShadow&&this.vsmPass(r),i.camera.layers.mask=h,Wx(r,n,aT)}vsmPass(e){const{shadow:t}=this,s=this.shadowMap.depth;this.vsmShadowMapVertical.setSize(t.mapSize.width,t.mapSize.height,s),this.vsmShadowMapHorizontal.setSize(t.mapSize.width,t.mapSize.height,s),e.setRenderTarget(this.vsmShadowMapVertical),oT.material=this.vsmMaterialVertical,oT.render(e),e.setRenderTarget(this.vsmShadowMapHorizontal),oT.material=this.vsmMaterialHorizontal,oT.render(e)}dispose(){this.shadowMap.dispose(),this.shadowMap=null,null!==this.vsmShadowMapVertical&&(this.vsmShadowMapVertical.dispose(),this.vsmShadowMapVertical=null,this.vsmMaterialVertical.dispose(),this.vsmMaterialVertical=null),null!==this.vsmShadowMapHorizontal&&(this.vsmShadowMapHorizontal.dispose(),this.vsmShadowMapHorizontal=null,this.vsmMaterialHorizontal.dispose(),this.vsmMaterialHorizontal=null),super.dispose()}updateBefore(e){const{shadow:t}=this;let s=t.needsUpdate||t.autoUpdate;s&&(this._cameraFrameId[e.camera]===e.frameId&&(s=!1),this._cameraFrameId[e.camera]=e.frameId),s&&(this.updateShadow(e),this.shadowMap.depthTexture.version===this._depthVersionCached&&(t.needsUpdate=!1))}},lT=(e,t)=>Ii2(new uT(e,t)),dT=new $r,cT=Hi2(([e,t])=>{const s=e.toVar(),i=oo2(s),r=pa(1,Eo2(i.x,Eo2(i.y,i.z)));i.mulAssign(r),s.mulAssign(r.mul(t.mul(2).oneMinus()));const n=Ji2(s.xy).toVar(),a=t.mul(1.5).oneMinus();return qi2(i.z.greaterThanEqual(a),()=>{qi2(s.z.greaterThan(0),()=>{n.x.assign(ca2(4,s.x))})}).ElseIf(i.x.greaterThanEqual(a),()=>{const e=uo2(s.x);n.x.assign(s.z.mul(e).add(e.mul(2)))}).ElseIf(i.y.greaterThanEqual(a),()=>{const e=uo2(s.y);n.x.assign(s.x.add(e.mul(2)).add(2)),n.y.assign(s.z.mul(e).sub(2))}),Ji2(.125,.25).mul(n).add(Ji2(.375,.75)).flipY()}).setLayout({name:"cubeToUV",type:"vec2",inputs:[{name:"pos",type:"vec3"},{name:"texelSizeY",type:"float"}]}),hT=Hi2(({depthTexture:e,bd3D:t,dp:s,texelSize:i})=>al2(e,cT(t,i.y)).compare(s)),pT=Hi2(({depthTexture:e,bd3D:t,dp:s,texelSize:i,shadow:r})=>{const n=Cd2("radius","float",r).setGroup(Zn2),a=Ji2(-1,1).mul(n).mul(i.y);return al2(e,cT(t.add(a.xyy),i.y)).compare(s).add(al2(e,cT(t.add(a.yyy),i.y)).compare(s)).add(al2(e,cT(t.add(a.xyx),i.y)).compare(s)).add(al2(e,cT(t.add(a.yyx),i.y)).compare(s)).add(al2(e,cT(t,i.y)).compare(s)).add(al2(e,cT(t.add(a.xxy),i.y)).compare(s)).add(al2(e,cT(t.add(a.yxy),i.y)).compare(s)).add(al2(e,cT(t.add(a.xxx),i.y)).compare(s)).add(al2(e,cT(t.add(a.yxx),i.y)).compare(s)).mul(1/9)}),gT=Hi2(({filterFn:e,depthTexture:t,shadowCoord:s,shadow:i})=>{const r=s.xyz.toVar(),n=r.length(),a=ta2("float").setGroup(Zn2).onRenderUpdate(()=>i.camera.near),o=ta2("float").setGroup(Zn2).onRenderUpdate(()=>i.camera.far),l=Cd2("bias","float",i).setGroup(Zn2),h=ta2(i.mapSize).setGroup(Zn2),u=Ki2(1).toVar();return qi2(n.sub(o).lessThanEqual(0).and(n.sub(a).greaterThanEqual(0)),()=>{const s=n.sub(a).div(o.sub(a)).toVar();s.addAssign(l);const c=r.normalize(),d=Ji2(1).div(h.mul(Ji2(4,2)));u.assign(e({depthTexture:t,bd3D:c,dp:s,texelSize:d,shadow:i}))}),u}),mT=new As,fT=new Gi,yT=new Gi,bT=class extends uT{static get type(){return"PointShadowNode"}constructor(e,t=null){super(e,t)}getShadowFilterFn(e){return e===o2?hT:pT}setupShadowCoord(e,t){return t}setupShadowFilter(e,{filterFn:t,shadowTexture:s,depthTexture:i,shadowCoord:r,shadow:n}){return gT({filterFn:t,shadowTexture:s,depthTexture:i,shadowCoord:r,shadow:n})}renderShadow(e){const{shadow:t,shadowMap:s,light:i}=this,{renderer:r,scene:n}=e,a=t.getFrameExtents();yT.copy(t.mapSize),yT.multiply(a),s.setSize(yT.width,yT.height),fT.copy(t.mapSize);const o=r.autoClear,l=r.getClearColor(dT),h=r.getClearAlpha();r.autoClear=!1,r.setClearColor(t.clearColor,t.clearAlpha),r.clear();const u=t.getViewportCount();for(let e=0;e<u;e++){const a=t.getViewport(e),o=fT.x*a.x,l=yT.y-fT.y-fT.y*a.y;mT.set(o,l,fT.x*a.z,fT.y*a.w),s.viewport.copy(mT),t.updateMatrices(i,e),r.render(n,t.camera)}r.autoClear=o,r.setClearColor(l,h)}},xT=(e,t)=>Ii2(new bT(e,t)),TT=class extends wh2{static get type(){return"AnalyticLightNode"}constructor(e=null){super(),this.light=e,this.color=new $r,this.colorNode=e&&e.colorNode||ta2(this.color).setGroup(Zn2),this.baseColorNode=null,this.shadowNode=null,this.shadowColorNode=null,this.isAnalyticLightNode=!0,this.updateType=Us2.FRAME}getHash(){return this.light.uuid}getLightVector(e){return Mx(this.light).sub(e.context.positionView||Kl2)}setupDirect(){}setupDirectRectArea(){}setupShadowNode(){return lT(this.light)}setupShadow(e){const{renderer:t}=e;if(!1===t.shadowMap.enabled)return;let s=this.shadowColorNode;if(null===s){const e=this.light.shadow.shadowNode;let t;t=void 0!==e?Ii2(e):this.setupShadowNode(),this.shadowNode=t,this.shadowColorNode=s=this.colorNode.mul(t),this.baseColorNode=this.colorNode}this.colorNode=s}setup(e){this.colorNode=this.baseColorNode||this.colorNode,this.light.castShadow?e.object.receiveShadow&&this.setupShadow(e):null!==this.shadowNode&&(this.shadowNode.dispose(),this.shadowNode=null,this.shadowColorNode=null);const t=this.setupDirect(e),s=this.setupDirectRectArea(e);t&&e.lightsNode.setupDirectLight(e,this,t),s&&e.lightsNode.setupDirectRectAreaLight(e,this,s)}update(){const{light:e}=this;this.color.copy(e.color).multiplyScalar(e.intensity)}},_T=Hi2(({lightDistance:e,cutoffDistance:t,decayExponent:s})=>{const i=e.pow(s).max(.01).reciprocal();return t.greaterThan(0).select(i.mul(e.div(t).pow4().oneMinus().clamp().pow2()),i)}),vT=({color:e,lightVector:t,cutoffDistance:s,decayExponent:i})=>{const r=t.normalize(),n=t.length(),a=_T({lightDistance:n,cutoffDistance:s,decayExponent:i});return{lightDirection:r,lightColor:e.mul(a)}},NT=class extends TT{static get type(){return"PointLightNode"}constructor(e=null){super(e),this.cutoffDistanceNode=ta2(0).setGroup(Zn2),this.decayExponentNode=ta2(2).setGroup(Zn2)}update(e){const{light:t}=this;super.update(e),this.cutoffDistanceNode.value=t.distance,this.decayExponentNode.value=t.decay}setupShadowNode(){return xT(this.light)}setupDirect(e){return vT({color:this.colorNode,lightVector:this.getLightVector(e),cutoffDistance:this.cutoffDistanceNode,decayExponent:this.decayExponentNode})}},ST=Hi2(([e=Zu2()])=>{const t=e.mul(2),s=t.x.floor(),i=t.y.floor();return s.add(i).mod(2).sign()}),ET=Hi2(([e=Zu2()],{renderer:t,material:s})=>{const i=Uo2(e.mul(2).sub(1));let r;if(s.alphaToCoverage&&t.samples>1){const e=Ki2(i.fwidth()).toVar();r=Ho2(e.oneMinus(),e.add(1),i).oneMinus()}else r=Jo2(i.greaterThan(1),0,1);return r}),wT=Hi2(([e,t,s])=>{const i=Ki2(s).toVar(),r=Ki2(t).toVar(),n=Zi2(e).toVar();return Jo2(n,r,i)}).setLayout({name:"mx_select",type:"float",inputs:[{name:"b",type:"bool"},{name:"t",type:"float"},{name:"f",type:"float"}]}),AT=Hi2(([e,t])=>{const s=Zi2(t).toVar(),i=Ki2(e).toVar();return Jo2(s,i.negate(),i)}).setLayout({name:"mx_negate_if",type:"float",inputs:[{name:"val",type:"float"},{name:"b",type:"bool"}]}),RT=Hi2(([e])=>{const t=Ki2(e).toVar();return Yi2(Qa2(t))}).setLayout({name:"mx_floor",type:"int",inputs:[{name:"x",type:"float"}]}),CT=Hi2(([e,t])=>{const s=Ki2(e).toVar();return t.assign(RT(s)),s.sub(Ki2(t))}),MT=fy([Hi2(([e,t,s,i,r,n])=>{const a=Ki2(n).toVar(),o=Ki2(r).toVar(),l=Ki2(i).toVar(),h=Ki2(s).toVar(),u=Ki2(t).toVar(),c=Ki2(e).toVar(),d=Ki2(ca2(1,o)).toVar();return ca2(1,a).mul(c.mul(d).add(u.mul(o))).add(a.mul(h.mul(d).add(l.mul(o))))}).setLayout({name:"mx_bilerp_0",type:"float",inputs:[{name:"v0",type:"float"},{name:"v1",type:"float"},{name:"v2",type:"float"},{name:"v3",type:"float"},{name:"s",type:"float"},{name:"t",type:"float"}]}),Hi2(([e,t,s,i,r,n])=>{const a=Ki2(n).toVar(),o=Ki2(r).toVar(),l=sn2(i).toVar(),h=sn2(s).toVar(),u=sn2(t).toVar(),c=sn2(e).toVar(),d=Ki2(ca2(1,o)).toVar();return ca2(1,a).mul(c.mul(d).add(u.mul(o))).add(a.mul(h.mul(d).add(l.mul(o))))}).setLayout({name:"mx_bilerp_1",type:"vec3",inputs:[{name:"v0",type:"vec3"},{name:"v1",type:"vec3"},{name:"v2",type:"vec3"},{name:"v3",type:"vec3"},{name:"s",type:"float"},{name:"t",type:"float"}]})]),PT=fy([Hi2(([e,t,s,i,r,n,a,o,l,h,u])=>{const c=Ki2(u).toVar(),d=Ki2(h).toVar(),p=Ki2(l).toVar(),_=Ki2(o).toVar(),m=Ki2(a).toVar(),f=Ki2(n).toVar(),g=Ki2(r).toVar(),y=Ki2(i).toVar(),S=Ki2(s).toVar(),T=Ki2(t).toVar(),x=Ki2(e).toVar(),b=Ki2(ca2(1,p)).toVar(),G=Ki2(ca2(1,d)).toVar();return Ki2(ca2(1,c)).toVar().mul(G.mul(x.mul(b).add(T.mul(p))).add(d.mul(S.mul(b).add(y.mul(p))))).add(c.mul(G.mul(g.mul(b).add(f.mul(p))).add(d.mul(m.mul(b).add(_.mul(p))))))}).setLayout({name:"mx_trilerp_0",type:"float",inputs:[{name:"v0",type:"float"},{name:"v1",type:"float"},{name:"v2",type:"float"},{name:"v3",type:"float"},{name:"v4",type:"float"},{name:"v5",type:"float"},{name:"v6",type:"float"},{name:"v7",type:"float"},{name:"s",type:"float"},{name:"t",type:"float"},{name:"r",type:"float"}]}),Hi2(([e,t,s,i,r,n,a,o,l,h,u])=>{const c=Ki2(u).toVar(),d=Ki2(h).toVar(),p=Ki2(l).toVar(),_=sn2(o).toVar(),m=sn2(a).toVar(),f=sn2(n).toVar(),g=sn2(r).toVar(),y=sn2(i).toVar(),S=sn2(s).toVar(),T=sn2(t).toVar(),x=sn2(e).toVar(),b=Ki2(ca2(1,p)).toVar(),G=Ki2(ca2(1,d)).toVar();return Ki2(ca2(1,c)).toVar().mul(G.mul(x.mul(b).add(T.mul(p))).add(d.mul(S.mul(b).add(y.mul(p))))).add(c.mul(G.mul(g.mul(b).add(f.mul(p))).add(d.mul(m.mul(b).add(_.mul(p))))))}).setLayout({name:"mx_trilerp_1",type:"vec3",inputs:[{name:"v0",type:"vec3"},{name:"v1",type:"vec3"},{name:"v2",type:"vec3"},{name:"v3",type:"vec3"},{name:"v4",type:"vec3"},{name:"v5",type:"vec3"},{name:"v6",type:"vec3"},{name:"v7",type:"vec3"},{name:"s",type:"float"},{name:"t",type:"float"},{name:"r",type:"float"}]})]),BT=Hi2(([e,t,s])=>{const i=Ki2(s).toVar(),r=Ki2(t).toVar(),n=Qi2(e).toVar(),a=Qi2(n.bitAnd(Qi2(7))).toVar(),o=Ki2(wT(a.lessThan(Qi2(4)),r,i)).toVar(),l=Ki2(ha2(2,wT(a.lessThan(Qi2(4)),i,r))).toVar();return AT(o,Zi2(a.bitAnd(Qi2(1)))).add(AT(l,Zi2(a.bitAnd(Qi2(2)))))}).setLayout({name:"mx_gradient_float_0",type:"float",inputs:[{name:"hash",type:"uint"},{name:"x",type:"float"},{name:"y",type:"float"}]}),LT=Hi2(([e,t,s,i])=>{const r=Ki2(i).toVar(),n=Ki2(s).toVar(),a=Ki2(t).toVar(),o=Qi2(e).toVar(),l=Qi2(o.bitAnd(Qi2(15))).toVar(),h=Ki2(wT(l.lessThan(Qi2(8)),a,n)).toVar(),u=Ki2(wT(l.lessThan(Qi2(4)),n,wT(l.equal(Qi2(12)).or(l.equal(Qi2(14))),a,r))).toVar();return AT(h,Zi2(l.bitAnd(Qi2(1)))).add(AT(u,Zi2(l.bitAnd(Qi2(2)))))}).setLayout({name:"mx_gradient_float_1",type:"float",inputs:[{name:"hash",type:"uint"},{name:"x",type:"float"},{name:"y",type:"float"},{name:"z",type:"float"}]}),FT=fy([BT,LT]),IT=Hi2(([e,t,s])=>{const i=Ki2(s).toVar(),r=Ki2(t).toVar(),n=an2(e).toVar();return sn2(FT(n.x,r,i),FT(n.y,r,i),FT(n.z,r,i))}).setLayout({name:"mx_gradient_vec3_0",type:"vec3",inputs:[{name:"hash",type:"uvec3"},{name:"x",type:"float"},{name:"y",type:"float"}]}),DT=Hi2(([e,t,s,i])=>{const r=Ki2(i).toVar(),n=Ki2(s).toVar(),a=Ki2(t).toVar(),o=an2(e).toVar();return sn2(FT(o.x,a,n,r),FT(o.y,a,n,r),FT(o.z,a,n,r))}).setLayout({name:"mx_gradient_vec3_1",type:"vec3",inputs:[{name:"hash",type:"uvec3"},{name:"x",type:"float"},{name:"y",type:"float"},{name:"z",type:"float"}]}),VT=fy([IT,DT]),UT=Hi2(([e])=>{const t=Ki2(e).toVar();return ha2(.6616,t)}).setLayout({name:"mx_gradient_scale2d_0",type:"float",inputs:[{name:"v",type:"float"}]}),OT=Hi2(([e])=>{const t=Ki2(e).toVar();return ha2(.982,t)}).setLayout({name:"mx_gradient_scale3d_0",type:"float",inputs:[{name:"v",type:"float"}]}),kT=fy([UT,Hi2(([e])=>{const t=sn2(e).toVar();return ha2(.6616,t)}).setLayout({name:"mx_gradient_scale2d_1",type:"vec3",inputs:[{name:"v",type:"vec3"}]})]),GT=fy([OT,Hi2(([e])=>{const t=sn2(e).toVar();return ha2(.982,t)}).setLayout({name:"mx_gradient_scale3d_1",type:"vec3",inputs:[{name:"v",type:"vec3"}]})]),zT=Hi2(([e,t])=>{const s=Yi2(t).toVar(),i=Qi2(e).toVar();return i.shiftLeft(s).bitOr(i.shiftRight(Yi2(32).sub(s)))}).setLayout({name:"mx_rotl32",type:"uint",inputs:[{name:"x",type:"uint"},{name:"k",type:"int"}]}),HT=Hi2(([e,t,s])=>{e.subAssign(s),e.bitXorAssign(zT(s,Yi2(4))),s.addAssign(t),t.subAssign(e),t.bitXorAssign(zT(e,Yi2(6))),e.addAssign(s),s.subAssign(t),s.bitXorAssign(zT(t,Yi2(8))),t.addAssign(e),e.subAssign(s),e.bitXorAssign(zT(s,Yi2(16))),s.addAssign(t),t.subAssign(e),t.bitXorAssign(zT(e,Yi2(19))),e.addAssign(s),s.subAssign(t),s.bitXorAssign(zT(t,Yi2(4))),t.addAssign(e)}),$T=Hi2(([e,t,s])=>{const i=Qi2(s).toVar(),r=Qi2(t).toVar(),n=Qi2(e).toVar();return i.bitXorAssign(r),i.subAssign(zT(r,Yi2(14))),n.bitXorAssign(i),n.subAssign(zT(i,Yi2(11))),r.bitXorAssign(n),r.subAssign(zT(n,Yi2(25))),i.bitXorAssign(r),i.subAssign(zT(r,Yi2(16))),n.bitXorAssign(i),n.subAssign(zT(i,Yi2(4))),r.bitXorAssign(n),r.subAssign(zT(n,Yi2(14))),i.bitXorAssign(r),i.subAssign(zT(r,Yi2(24))),i}).setLayout({name:"mx_bjfinal",type:"uint",inputs:[{name:"a",type:"uint"},{name:"b",type:"uint"},{name:"c",type:"uint"}]}),WT=Hi2(([e])=>{const t=Qi2(e).toVar();return Ki2(t).div(Ki2(Qi2(Yi2(4294967295))))}).setLayout({name:"mx_bits_to_01",type:"float",inputs:[{name:"bits",type:"uint"}]}),qT=Hi2(([e])=>{const t=Ki2(e).toVar();return t.mul(t).mul(t).mul(t.mul(t.mul(6).sub(15)).add(10))}).setLayout({name:"mx_fade",type:"float",inputs:[{name:"t",type:"float"}]}),jT=fy([Hi2(([e])=>{const t=Yi2(e).toVar(),s=Qi2(Qi2(1)).toVar(),i=Qi2(Qi2(Yi2(3735928559)).add(s.shiftLeft(Qi2(2))).add(Qi2(13))).toVar();return $T(i.add(Qi2(t)),i,i)}).setLayout({name:"mx_hash_int_0",type:"uint",inputs:[{name:"x",type:"int"}]}),Hi2(([e,t])=>{const s=Yi2(t).toVar(),i=Yi2(e).toVar(),r=Qi2(Qi2(2)).toVar(),n=Qi2().toVar(),a=Qi2().toVar(),o=Qi2().toVar();return n.assign(a.assign(o.assign(Qi2(Yi2(3735928559)).add(r.shiftLeft(Qi2(2))).add(Qi2(13))))),n.addAssign(Qi2(i)),a.addAssign(Qi2(s)),$T(n,a,o)}).setLayout({name:"mx_hash_int_1",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"}]}),Hi2(([e,t,s])=>{const i=Yi2(s).toVar(),r=Yi2(t).toVar(),n=Yi2(e).toVar(),a=Qi2(Qi2(3)).toVar(),o=Qi2().toVar(),l=Qi2().toVar(),h=Qi2().toVar();return o.assign(l.assign(h.assign(Qi2(Yi2(3735928559)).add(a.shiftLeft(Qi2(2))).add(Qi2(13))))),o.addAssign(Qi2(n)),l.addAssign(Qi2(r)),h.addAssign(Qi2(i)),$T(o,l,h)}).setLayout({name:"mx_hash_int_2",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"}]}),Hi2(([e,t,s,i])=>{const r=Yi2(i).toVar(),n=Yi2(s).toVar(),a=Yi2(t).toVar(),o=Yi2(e).toVar(),l=Qi2(Qi2(4)).toVar(),h=Qi2().toVar(),u=Qi2().toVar(),c=Qi2().toVar();return h.assign(u.assign(c.assign(Qi2(Yi2(3735928559)).add(l.shiftLeft(Qi2(2))).add(Qi2(13))))),h.addAssign(Qi2(o)),u.addAssign(Qi2(a)),c.addAssign(Qi2(n)),HT(h,u,c),h.addAssign(Qi2(r)),$T(h,u,c)}).setLayout({name:"mx_hash_int_3",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"xx",type:"int"}]}),Hi2(([e,t,s,i,r])=>{const n=Yi2(r).toVar(),a=Yi2(i).toVar(),o=Yi2(s).toVar(),l=Yi2(t).toVar(),h=Yi2(e).toVar(),u=Qi2(Qi2(5)).toVar(),c=Qi2().toVar(),d=Qi2().toVar(),p=Qi2().toVar();return c.assign(d.assign(p.assign(Qi2(Yi2(3735928559)).add(u.shiftLeft(Qi2(2))).add(Qi2(13))))),c.addAssign(Qi2(h)),d.addAssign(Qi2(l)),p.addAssign(Qi2(o)),HT(c,d,p),c.addAssign(Qi2(a)),d.addAssign(Qi2(n)),$T(c,d,p)}).setLayout({name:"mx_hash_int_4",type:"uint",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"xx",type:"int"},{name:"yy",type:"int"}]})]),XT=fy([Hi2(([e,t])=>{const s=Yi2(t).toVar(),i=Yi2(e).toVar(),r=Qi2(jT(i,s)).toVar(),n=an2().toVar();return n.x.assign(r.bitAnd(Yi2(255))),n.y.assign(r.shiftRight(Yi2(8)).bitAnd(Yi2(255))),n.z.assign(r.shiftRight(Yi2(16)).bitAnd(Yi2(255))),n}).setLayout({name:"mx_hash_vec3_0",type:"uvec3",inputs:[{name:"x",type:"int"},{name:"y",type:"int"}]}),Hi2(([e,t,s])=>{const i=Yi2(s).toVar(),r=Yi2(t).toVar(),n=Yi2(e).toVar(),a=Qi2(jT(n,r,i)).toVar(),o=an2().toVar();return o.x.assign(a.bitAnd(Yi2(255))),o.y.assign(a.shiftRight(Yi2(8)).bitAnd(Yi2(255))),o.z.assign(a.shiftRight(Yi2(16)).bitAnd(Yi2(255))),o}).setLayout({name:"mx_hash_vec3_1",type:"uvec3",inputs:[{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"}]})]),KT=fy([Hi2(([e])=>{const t=Ji2(e).toVar(),s=Yi2().toVar(),i=Yi2().toVar(),r=Ki2(CT(t.x,s)).toVar(),n=Ki2(CT(t.y,i)).toVar(),a=Ki2(qT(r)).toVar(),o=Ki2(qT(n)).toVar(),l=Ki2(MT(FT(jT(s,i),r,n),FT(jT(s.add(Yi2(1)),i),r.sub(1),n),FT(jT(s,i.add(Yi2(1))),r,n.sub(1)),FT(jT(s.add(Yi2(1)),i.add(Yi2(1))),r.sub(1),n.sub(1)),a,o)).toVar();return kT(l)}).setLayout({name:"mx_perlin_noise_float_0",type:"float",inputs:[{name:"p",type:"vec2"}]}),Hi2(([e])=>{const t=sn2(e).toVar(),s=Yi2().toVar(),i=Yi2().toVar(),r=Yi2().toVar(),n=Ki2(CT(t.x,s)).toVar(),a=Ki2(CT(t.y,i)).toVar(),o=Ki2(CT(t.z,r)).toVar(),l=Ki2(qT(n)).toVar(),h=Ki2(qT(a)).toVar(),u=Ki2(qT(o)).toVar(),c=Ki2(PT(FT(jT(s,i,r),n,a,o),FT(jT(s.add(Yi2(1)),i,r),n.sub(1),a,o),FT(jT(s,i.add(Yi2(1)),r),n,a.sub(1),o),FT(jT(s.add(Yi2(1)),i.add(Yi2(1)),r),n.sub(1),a.sub(1),o),FT(jT(s,i,r.add(Yi2(1))),n,a,o.sub(1)),FT(jT(s.add(Yi2(1)),i,r.add(Yi2(1))),n.sub(1),a,o.sub(1)),FT(jT(s,i.add(Yi2(1)),r.add(Yi2(1))),n,a.sub(1),o.sub(1)),FT(jT(s.add(Yi2(1)),i.add(Yi2(1)),r.add(Yi2(1))),n.sub(1),a.sub(1),o.sub(1)),l,h,u)).toVar();return GT(c)}).setLayout({name:"mx_perlin_noise_float_1",type:"float",inputs:[{name:"p",type:"vec3"}]})]),YT=fy([Hi2(([e])=>{const t=Ji2(e).toVar(),s=Yi2().toVar(),i=Yi2().toVar(),r=Ki2(CT(t.x,s)).toVar(),n=Ki2(CT(t.y,i)).toVar(),a=Ki2(qT(r)).toVar(),o=Ki2(qT(n)).toVar(),l=sn2(MT(VT(XT(s,i),r,n),VT(XT(s.add(Yi2(1)),i),r.sub(1),n),VT(XT(s,i.add(Yi2(1))),r,n.sub(1)),VT(XT(s.add(Yi2(1)),i.add(Yi2(1))),r.sub(1),n.sub(1)),a,o)).toVar();return kT(l)}).setLayout({name:"mx_perlin_noise_vec3_0",type:"vec3",inputs:[{name:"p",type:"vec2"}]}),Hi2(([e])=>{const t=sn2(e).toVar(),s=Yi2().toVar(),i=Yi2().toVar(),r=Yi2().toVar(),n=Ki2(CT(t.x,s)).toVar(),a=Ki2(CT(t.y,i)).toVar(),o=Ki2(CT(t.z,r)).toVar(),l=Ki2(qT(n)).toVar(),h=Ki2(qT(a)).toVar(),u=Ki2(qT(o)).toVar(),c=sn2(PT(VT(XT(s,i,r),n,a,o),VT(XT(s.add(Yi2(1)),i,r),n.sub(1),a,o),VT(XT(s,i.add(Yi2(1)),r),n,a.sub(1),o),VT(XT(s.add(Yi2(1)),i.add(Yi2(1)),r),n.sub(1),a.sub(1),o),VT(XT(s,i,r.add(Yi2(1))),n,a,o.sub(1)),VT(XT(s.add(Yi2(1)),i,r.add(Yi2(1))),n.sub(1),a,o.sub(1)),VT(XT(s,i.add(Yi2(1)),r.add(Yi2(1))),n,a.sub(1),o.sub(1)),VT(XT(s.add(Yi2(1)),i.add(Yi2(1)),r.add(Yi2(1))),n.sub(1),a.sub(1),o.sub(1)),l,h,u)).toVar();return GT(c)}).setLayout({name:"mx_perlin_noise_vec3_1",type:"vec3",inputs:[{name:"p",type:"vec3"}]})]),QT=fy([Hi2(([e])=>{const t=Ki2(e).toVar(),s=Yi2(RT(t)).toVar();return WT(jT(s))}).setLayout({name:"mx_cell_noise_float_0",type:"float",inputs:[{name:"p",type:"float"}]}),Hi2(([e])=>{const t=Ji2(e).toVar(),s=Yi2(RT(t.x)).toVar(),i=Yi2(RT(t.y)).toVar();return WT(jT(s,i))}).setLayout({name:"mx_cell_noise_float_1",type:"float",inputs:[{name:"p",type:"vec2"}]}),Hi2(([e])=>{const t=sn2(e).toVar(),s=Yi2(RT(t.x)).toVar(),i=Yi2(RT(t.y)).toVar(),r=Yi2(RT(t.z)).toVar();return WT(jT(s,i,r))}).setLayout({name:"mx_cell_noise_float_2",type:"float",inputs:[{name:"p",type:"vec3"}]}),Hi2(([e])=>{const t=un2(e).toVar(),s=Yi2(RT(t.x)).toVar(),i=Yi2(RT(t.y)).toVar(),r=Yi2(RT(t.z)).toVar(),n=Yi2(RT(t.w)).toVar();return WT(jT(s,i,r,n))}).setLayout({name:"mx_cell_noise_float_3",type:"float",inputs:[{name:"p",type:"vec4"}]})]),ZT=fy([Hi2(([e])=>{const t=Ki2(e).toVar(),s=Yi2(RT(t)).toVar();return sn2(WT(jT(s,Yi2(0))),WT(jT(s,Yi2(1))),WT(jT(s,Yi2(2))))}).setLayout({name:"mx_cell_noise_vec3_0",type:"vec3",inputs:[{name:"p",type:"float"}]}),Hi2(([e])=>{const t=Ji2(e).toVar(),s=Yi2(RT(t.x)).toVar(),i=Yi2(RT(t.y)).toVar();return sn2(WT(jT(s,i,Yi2(0))),WT(jT(s,i,Yi2(1))),WT(jT(s,i,Yi2(2))))}).setLayout({name:"mx_cell_noise_vec3_1",type:"vec3",inputs:[{name:"p",type:"vec2"}]}),Hi2(([e])=>{const t=sn2(e).toVar(),s=Yi2(RT(t.x)).toVar(),i=Yi2(RT(t.y)).toVar(),r=Yi2(RT(t.z)).toVar();return sn2(WT(jT(s,i,r,Yi2(0))),WT(jT(s,i,r,Yi2(1))),WT(jT(s,i,r,Yi2(2))))}).setLayout({name:"mx_cell_noise_vec3_2",type:"vec3",inputs:[{name:"p",type:"vec3"}]}),Hi2(([e])=>{const t=un2(e).toVar(),s=Yi2(RT(t.x)).toVar(),i=Yi2(RT(t.y)).toVar(),r=Yi2(RT(t.z)).toVar(),n=Yi2(RT(t.w)).toVar();return sn2(WT(jT(s,i,r,n,Yi2(0))),WT(jT(s,i,r,n,Yi2(1))),WT(jT(s,i,r,n,Yi2(2))))}).setLayout({name:"mx_cell_noise_vec3_3",type:"vec3",inputs:[{name:"p",type:"vec4"}]})]),JT=Hi2(([e,t,s,i])=>{const r=Ki2(i).toVar(),n=Ki2(s).toVar(),a=Yi2(t).toVar(),o=sn2(e).toVar(),l=Ki2(0).toVar(),h=Ki2(1).toVar();return xh2(a,()=>{l.addAssign(h.mul(KT(o))),h.mulAssign(r),o.mulAssign(n)}),l}).setLayout({name:"mx_fractal_noise_float",type:"float",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),e_=Hi2(([e,t,s,i])=>{const r=Ki2(i).toVar(),n=Ki2(s).toVar(),a=Yi2(t).toVar(),o=sn2(e).toVar(),l=sn2(0).toVar(),h=Ki2(1).toVar();return xh2(a,()=>{l.addAssign(h.mul(YT(o))),h.mulAssign(r),o.mulAssign(n)}),l}).setLayout({name:"mx_fractal_noise_vec3",type:"vec3",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),t_=Hi2(([e,t,s,i])=>{const r=Ki2(i).toVar(),n=Ki2(s).toVar(),a=Yi2(t).toVar(),o=sn2(e).toVar();return Ji2(JT(o,a,n,r),JT(o.add(sn2(Yi2(19),Yi2(193),Yi2(17))),a,n,r))}).setLayout({name:"mx_fractal_noise_vec2",type:"vec2",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),r_=Hi2(([e,t,s,i])=>{const r=Ki2(i).toVar(),n=Ki2(s).toVar(),a=Yi2(t).toVar(),o=sn2(e).toVar(),l=sn2(e_(o,a,n,r)).toVar(),h=Ki2(JT(o.add(sn2(Yi2(19),Yi2(193),Yi2(17))),a,n,r)).toVar();return un2(l,h)}).setLayout({name:"mx_fractal_noise_vec4",type:"vec4",inputs:[{name:"p",type:"vec3"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),s_=fy([Hi2(([e,t,s,i,r,n,a])=>{const o=Yi2(a).toVar(),l=Ki2(n).toVar(),h=Yi2(r).toVar(),u=Yi2(i).toVar(),c=Yi2(s).toVar(),d=Yi2(t).toVar(),p=Ji2(e).toVar(),_=sn2(ZT(Ji2(d.add(u),c.add(h)))).toVar(),m=Ji2(_.x,_.y).toVar();m.subAssign(.5),m.mulAssign(l),m.addAssign(.5);const f=Ji2(Ji2(Ki2(d),Ki2(c)).add(m)).toVar(),g=Ji2(f.sub(p)).toVar();return qi2(o.equal(Yi2(2)),()=>oo2(g.x).add(oo2(g.y))),qi2(o.equal(Yi2(3)),()=>Eo2(oo2(g.x),oo2(g.y))),Mo2(g,g)}).setLayout({name:"mx_worley_distance_0",type:"float",inputs:[{name:"p",type:"vec2"},{name:"x",type:"int"},{name:"y",type:"int"},{name:"xoff",type:"int"},{name:"yoff",type:"int"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),Hi2(([e,t,s,i,r,n,a,o,l])=>{const h=Yi2(l).toVar(),u=Ki2(o).toVar(),c=Yi2(a).toVar(),d=Yi2(n).toVar(),p=Yi2(r).toVar(),_=Yi2(i).toVar(),m=Yi2(s).toVar(),f=Yi2(t).toVar(),g=sn2(e).toVar(),y=sn2(ZT(sn2(f.add(p),m.add(d),_.add(c)))).toVar();y.subAssign(.5),y.mulAssign(u),y.addAssign(.5);const S=sn2(sn2(Ki2(f),Ki2(m),Ki2(_)).add(y)).toVar(),T=sn2(S.sub(g)).toVar();return qi2(h.equal(Yi2(2)),()=>oo2(T.x).add(oo2(T.y)).add(oo2(T.z))),qi2(h.equal(Yi2(3)),()=>Eo2(oo2(T.x),oo2(T.y),oo2(T.z))),Mo2(T,T)}).setLayout({name:"mx_worley_distance_1",type:"float",inputs:[{name:"p",type:"vec3"},{name:"x",type:"int"},{name:"y",type:"int"},{name:"z",type:"int"},{name:"xoff",type:"int"},{name:"yoff",type:"int"},{name:"zoff",type:"int"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]})]),i_=Hi2(([e,t,s])=>{const i=Yi2(s).toVar(),r=Ki2(t).toVar(),n=Ji2(e).toVar(),a=Yi2().toVar(),o=Yi2().toVar(),l=Ji2(CT(n.x,a),CT(n.y,o)).toVar(),h=Ki2(1e6).toVar();return xh2({start:-1,end:Yi2(1),name:"x",condition:"<="},({x:e})=>{xh2({start:-1,end:Yi2(1),name:"y",condition:"<="},({y:t})=>{const s=Ki2(s_(l,e,t,a,o,r,i)).toVar();h.assign(So2(h,s))})}),qi2(i.equal(Yi2(0)),()=>{h.assign(Ka2(h))}),h}).setLayout({name:"mx_worley_noise_float_0",type:"float",inputs:[{name:"p",type:"vec2"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),n_=Hi2(([e,t,s])=>{const i=Yi2(s).toVar(),r=Ki2(t).toVar(),n=Ji2(e).toVar(),a=Yi2().toVar(),o=Yi2().toVar(),l=Ji2(CT(n.x,a),CT(n.y,o)).toVar(),h=Ji2(1e6,1e6).toVar();return xh2({start:-1,end:Yi2(1),name:"x",condition:"<="},({x:e})=>{xh2({start:-1,end:Yi2(1),name:"y",condition:"<="},({y:t})=>{const s=Ki2(s_(l,e,t,a,o,r,i)).toVar();qi2(s.lessThan(h.x),()=>{h.y.assign(h.x),h.x.assign(s)}).ElseIf(s.lessThan(h.y),()=>{h.y.assign(s)})})}),qi2(i.equal(Yi2(0)),()=>{h.assign(Ka2(h))}),h}).setLayout({name:"mx_worley_noise_vec2_0",type:"vec2",inputs:[{name:"p",type:"vec2"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),a_=Hi2(([e,t,s])=>{const i=Yi2(s).toVar(),r=Ki2(t).toVar(),n=Ji2(e).toVar(),a=Yi2().toVar(),o=Yi2().toVar(),l=Ji2(CT(n.x,a),CT(n.y,o)).toVar(),h=sn2(1e6,1e6,1e6).toVar();return xh2({start:-1,end:Yi2(1),name:"x",condition:"<="},({x:e})=>{xh2({start:-1,end:Yi2(1),name:"y",condition:"<="},({y:t})=>{const s=Ki2(s_(l,e,t,a,o,r,i)).toVar();qi2(s.lessThan(h.x),()=>{h.z.assign(h.y),h.y.assign(h.x),h.x.assign(s)}).ElseIf(s.lessThan(h.y),()=>{h.z.assign(h.y),h.y.assign(s)}).ElseIf(s.lessThan(h.z),()=>{h.z.assign(s)})})}),qi2(i.equal(Yi2(0)),()=>{h.assign(Ka2(h))}),h}).setLayout({name:"mx_worley_noise_vec3_0",type:"vec3",inputs:[{name:"p",type:"vec2"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]}),o_=fy([i_,Hi2(([e,t,s])=>{const i=Yi2(s).toVar(),r=Ki2(t).toVar(),n=sn2(e).toVar(),a=Yi2().toVar(),o=Yi2().toVar(),l=Yi2().toVar(),h=sn2(CT(n.x,a),CT(n.y,o),CT(n.z,l)).toVar(),u=Ki2(1e6).toVar();return xh2({start:-1,end:Yi2(1),name:"x",condition:"<="},({x:e})=>{xh2({start:-1,end:Yi2(1),name:"y",condition:"<="},({y:t})=>{xh2({start:-1,end:Yi2(1),name:"z",condition:"<="},({z:s})=>{const n=Ki2(s_(h,e,t,s,a,o,l,r,i)).toVar();u.assign(So2(u,n))})})}),qi2(i.equal(Yi2(0)),()=>{u.assign(Ka2(u))}),u}).setLayout({name:"mx_worley_noise_float_1",type:"float",inputs:[{name:"p",type:"vec3"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]})]),u_=fy([n_,Hi2(([e,t,s])=>{const i=Yi2(s).toVar(),r=Ki2(t).toVar(),n=sn2(e).toVar(),a=Yi2().toVar(),o=Yi2().toVar(),l=Yi2().toVar(),h=sn2(CT(n.x,a),CT(n.y,o),CT(n.z,l)).toVar(),u=Ji2(1e6,1e6).toVar();return xh2({start:-1,end:Yi2(1),name:"x",condition:"<="},({x:e})=>{xh2({start:-1,end:Yi2(1),name:"y",condition:"<="},({y:t})=>{xh2({start:-1,end:Yi2(1),name:"z",condition:"<="},({z:s})=>{const n=Ki2(s_(h,e,t,s,a,o,l,r,i)).toVar();qi2(n.lessThan(u.x),()=>{u.y.assign(u.x),u.x.assign(n)}).ElseIf(n.lessThan(u.y),()=>{u.y.assign(n)})})})}),qi2(i.equal(Yi2(0)),()=>{u.assign(Ka2(u))}),u}).setLayout({name:"mx_worley_noise_vec2_1",type:"vec2",inputs:[{name:"p",type:"vec3"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]})]),l_=fy([a_,Hi2(([e,t,s])=>{const i=Yi2(s).toVar(),r=Ki2(t).toVar(),n=sn2(e).toVar(),a=Yi2().toVar(),o=Yi2().toVar(),l=Yi2().toVar(),h=sn2(CT(n.x,a),CT(n.y,o),CT(n.z,l)).toVar(),u=sn2(1e6,1e6,1e6).toVar();return xh2({start:-1,end:Yi2(1),name:"x",condition:"<="},({x:e})=>{xh2({start:-1,end:Yi2(1),name:"y",condition:"<="},({y:t})=>{xh2({start:-1,end:Yi2(1),name:"z",condition:"<="},({z:s})=>{const n=Ki2(s_(h,e,t,s,a,o,l,r,i)).toVar();qi2(n.lessThan(u.x),()=>{u.z.assign(u.y),u.y.assign(u.x),u.x.assign(n)}).ElseIf(n.lessThan(u.y),()=>{u.z.assign(u.y),u.y.assign(n)}).ElseIf(n.lessThan(u.z),()=>{u.z.assign(n)})})})}),qi2(i.equal(Yi2(0)),()=>{u.assign(Ka2(u))}),u}).setLayout({name:"mx_worley_noise_vec3_1",type:"vec3",inputs:[{name:"p",type:"vec3"},{name:"jitter",type:"float"},{name:"metric",type:"int"}]})]),d_=Hi2(([e,t,s,i,r,n,a,o,l,h,u])=>{const c=Yi2(e).toVar(),d=Ji2(t).toVar(),p=Ji2(s).toVar(),_=Ji2(i).toVar(),m=Ki2(r).toVar(),f=Ki2(n).toVar(),g=Ki2(a).toVar(),y=Zi2(o).toVar(),S=Yi2(l).toVar(),T=Ki2(h).toVar(),x=Ki2(u).toVar(),b=d.mul(p).add(_),G=Ki2(0).toVar();return qi2(c.equal(Yi2(0)),()=>{G.assign(YT(b))}),qi2(c.equal(Yi2(1)),()=>{G.assign(ZT(b))}),qi2(c.equal(Yi2(2)),()=>{G.assign(l_(b,m,Yi2(0)))}),qi2(c.equal(Yi2(3)),()=>{G.assign(e_(sn2(b,0),S,T,x))}),G.assign(G.mul(g.sub(f)).add(f)),qi2(y,()=>{G.assign(ko2(G,f,g))}),G}).setLayout({name:"mx_unifiednoise2d",type:"float",inputs:[{name:"noiseType",type:"int"},{name:"texcoord",type:"vec2"},{name:"freq",type:"vec2"},{name:"offset",type:"vec2"},{name:"jitter",type:"float"},{name:"outmin",type:"float"},{name:"outmax",type:"float"},{name:"clampoutput",type:"bool"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),c_=Hi2(([e,t,s,i,r,n,a,o,l,h,u])=>{const c=Yi2(e).toVar(),d=sn2(t).toVar(),p=sn2(s).toVar(),_=sn2(i).toVar(),m=Ki2(r).toVar(),f=Ki2(n).toVar(),g=Ki2(a).toVar(),y=Zi2(o).toVar(),S=Yi2(l).toVar(),T=Ki2(h).toVar(),x=Ki2(u).toVar(),b=d.mul(p).add(_),G=Ki2(0).toVar();return qi2(c.equal(Yi2(0)),()=>{G.assign(YT(b))}),qi2(c.equal(Yi2(1)),()=>{G.assign(ZT(b))}),qi2(c.equal(Yi2(2)),()=>{G.assign(l_(b,m,Yi2(0)))}),qi2(c.equal(Yi2(3)),()=>{G.assign(e_(b,S,T,x))}),G.assign(G.mul(g.sub(f)).add(f)),qi2(y,()=>{G.assign(ko2(G,f,g))}),G}).setLayout({name:"mx_unifiednoise3d",type:"float",inputs:[{name:"noiseType",type:"int"},{name:"position",type:"vec3"},{name:"freq",type:"vec3"},{name:"offset",type:"vec3"},{name:"jitter",type:"float"},{name:"outmin",type:"float"},{name:"outmax",type:"float"},{name:"clampoutput",type:"bool"},{name:"octaves",type:"int"},{name:"lacunarity",type:"float"},{name:"diminish",type:"float"}]}),h_=Hi2(([e])=>{const t=e.y,s=e.z,i=sn2().toVar();return qi2(t.lessThan(1e-4),()=>{i.assign(sn2(s,s,s))}).Else(()=>{let r=e.x;r=r.sub(Qa2(r)).mul(6).toVar();const n=Yi2(yo(r)),a=r.sub(Ki2(n)),o=s.mul(t.oneMinus()),l=s.mul(t.mul(a).oneMinus()),h=s.mul(t.mul(a.oneMinus()).oneMinus());qi2(n.equal(Yi2(0)),()=>{i.assign(sn2(s,h,o))}).ElseIf(n.equal(Yi2(1)),()=>{i.assign(sn2(l,s,o))}).ElseIf(n.equal(Yi2(2)),()=>{i.assign(sn2(o,s,h))}).ElseIf(n.equal(Yi2(3)),()=>{i.assign(sn2(o,l,s))}).ElseIf(n.equal(Yi2(4)),()=>{i.assign(sn2(h,o,s))}).Else(()=>{i.assign(sn2(s,o,l))})}),i}).setLayout({name:"mx_hsvtorgb",type:"vec3",inputs:[{name:"hsv",type:"vec3"}]}),p_=Hi2(([e])=>{const t=sn2(e).toVar(),s=Ki2(t.x).toVar(),i=Ki2(t.y).toVar(),r=Ki2(t.z).toVar(),n=Ki2(So2(s,So2(i,r))).toVar(),a=Ki2(Eo2(s,Eo2(i,r))).toVar(),o=Ki2(a.sub(n)).toVar(),l=Ki2().toVar(),h=Ki2().toVar(),u=Ki2().toVar();return u.assign(a),qi2(a.greaterThan(0),()=>{h.assign(o.div(a))}).Else(()=>{h.assign(0)}),qi2(h.lessThanEqual(0),()=>{l.assign(0)}).Else(()=>{qi2(s.greaterThanEqual(a),()=>{l.assign(i.sub(r).div(o))}).ElseIf(i.greaterThanEqual(a),()=>{l.assign(da2(2,r.sub(s).div(o)))}).Else(()=>{l.assign(da2(4,s.sub(i).div(o)))}),l.mulAssign(1/6),qi2(l.lessThan(0),()=>{l.addAssign(1)})}),sn2(l,h,u)}).setLayout({name:"mx_rgbtohsv",type:"vec3",inputs:[{name:"c",type:"vec3"}]}),g_=Hi2(([e])=>{const t=sn2(e).toVar(),s=on2(ba2(t,sn2(.04045))).toVar(),i=sn2(t.div(12.92)).toVar(),r=sn2(Bo(Eo2(t.add(sn2(.055)),sn2(0)).div(1.055),sn2(2.4))).toVar();return Oo2(i,r,s)}).setLayout({name:"mx_srgb_texture_to_lin_rec709",type:"vec3",inputs:[{name:"color",type:"vec3"}]}),m_=(e,t)=>{e=Ki2(e),t=Ki2(t);const s=Ji2(t.dFdx(),t.dFdy()).length().mul(.7071067811865476);return Ho2(e.sub(s),e.add(s),t)},f_=(e,t,s,i)=>Oo2(e,t,s[i].clamp()),y_=(e,t,s,i,r)=>Oo2(e,t,m_(s,i[r])),b_=Hi2(([e,t,s])=>{const i=Ja2(e).toVar(),r=ca2(Ki2(.5).mul(t.sub(s)),jl2).div(i).toVar(),n=ca2(Ki2(-.5).mul(t.sub(s)),jl2).div(i).toVar(),a=sn2().toVar();a.x=i.x.greaterThan(Ki2(0)).select(r.x,n.x),a.y=i.y.greaterThan(Ki2(0)).select(r.y,n.y),a.z=i.z.greaterThan(Ki2(0)).select(r.z,n.z);const o=So2(a.x,a.y,a.z).toVar();return jl2.add(i.mul(o)).toVar().sub(s)}),x_=Hi2(([e,t])=>{const s=e.x,i=e.y,r=e.z;let n=t.element(0).mul(.886227);return n=n.add(t.element(1).mul(1.023328).mul(i)),n=n.add(t.element(2).mul(1.023328).mul(r)),n=n.add(t.element(3).mul(1.023328).mul(s)),n=n.add(t.element(4).mul(.858086).mul(s).mul(i)),n=n.add(t.element(5).mul(.858086).mul(i).mul(r)),n=n.add(t.element(6).mul(r.mul(r).mul(.743125).sub(.247708))),n=n.add(t.element(7).mul(.858086).mul(s).mul(r)),n=n.add(t.element(8).mul(.429043).mul(ha2(s,s).sub(ha2(i,i)))),n}),T_=Object.freeze({__proto__:null,BRDF_GGX:ng,BRDF_Lambert:$p,BasicPointShadowFilter:hT,BasicShadowFilter:Xx,Break:Th2,Const:ou2,Continue:()=>$u2("continue").toStack(),DFGApprox:ag,D_GGX:rg,Discard:Wu2,EPSILON:Va2,F_Schlick:Hp,Fn:Hi2,INFINITY:Ua2,If:qi2,Loop:xh2,NodeAccess:ks2,NodeShaderStage:Vs2,NodeType:Os2,NodeUpdateType:Us2,OnMaterialUpdate:e=>tb(eb.MATERIAL,e),OnObjectUpdate:e=>tb(eb.OBJECT,e),PCFShadowFilter:Kx,PCFSoftShadowFilter:Yx,PI:Oa2,PI2:ka2,PointShadowFilter:pT,Return:()=>$u2("return").toStack(),Schlick_to_F0:ug,ScriptableNodeResources:ex,ShaderNode:Fi2,Stack:ji2,Switch:(...e)=>ai2.Switch(...e),TBNViewMatrix:rc2,VSMShadowFilter:Qx,V_GGX_SmithCorrelated:eg,Var:au2,VarIntent:uu2,abs:oo2,acesFilmicToneMapping:kb,acos:no2,add:da2,addMethodChaining:ui2,addNodeElement:function(e){console.warn("THREE.TSL: AddNodeElement has been removed in favor of tree-shaking. Trying add",e)},agxToneMapping:$b,all:Ga2,alphaT:Pn2,and:_a2,anisotropy:Bn2,anisotropyB:Fn2,anisotropyT:Ln2,any:za,append:e=>(console.warn("THREE.TSL: append() has been renamed to Stack()."),ji2(e)),array:sa2,arrayBuffer:e=>Ii2(new ii2(e,"ArrayBuffer")),asin:io2,assign:na2,atan:ao2,atan2:Ko2,atomicAdd:(e,t)=>Nx(_x.ATOMIC_ADD,e,t),atomicAnd:(e,t)=>Nx(_x.ATOMIC_AND,e,t),atomicFunc:Nx,atomicLoad:e=>Nx(_x.ATOMIC_LOAD,e,null),atomicMax:(e,t)=>Nx(_x.ATOMIC_MAX,e,t),atomicMin:(e,t)=>Nx(_x.ATOMIC_MIN,e,t),atomicOr:(e,t)=>Nx(_x.ATOMIC_OR,e,t),atomicStore:(e,t)=>Nx(_x.ATOMIC_STORE,e,t),atomicSub:(e,t)=>Nx(_x.ATOMIC_SUB,e,t),atomicXor:(e,t)=>Nx(_x.ATOMIC_XOR,e,t),attenuationColor:qn,attenuationDistance:Wn2,attribute:Qu2,attributeArray:(e,t="float")=>{let s,i;!0===t.isStruct?(s=t.layout.getLength(),i=As2("float")):(s=Rs2(t),i=As2(t));const r=new sb(e,s,i);return gh2(r,t,e)},backgroundBlurriness:lb,backgroundIntensity:db,backgroundRotation:cb,batch:dh2,bentNormalView:ic2,billboarding:vy,bitAnd:Ea2,bitNot:wa2,bitOr:Aa2,bitXor:Ra2,bitangentGeometry:Zd,bitangentLocal:Jd,bitangentView:ec2,bitangentWorld:tc2,bitcast:vo2,blendBurn:dp,blendColor:gp,blendDodge:cp,blendOverlay:pp,blendScreen:hp,blur:um,bool:Zi2,buffer:ll2,bufferAttribute:Cu2,bumpMap:dc2,burn:(...e)=>(console.warn('THREE.TSL: "burn" has been renamed. Use "blendBurn" instead.'),dp(e)),bvec2:rn2,bvec3:on2,bvec4:cn2,bypass:Ou2,cache:Vu,call:oa2,cameraFar:fl2,cameraIndex:gl2,cameraNear:ml2,cameraNormalMatrix:_l2,cameraPosition:vl2,cameraProjectionMatrix:yl2,cameraProjectionMatrixInverse:bl2,cameraViewMatrix:xl2,cameraWorldMatrix:Tl2,cbrt:Vo2,cdl:Rb,ceil:Za2,checker:ST,cineonToneMapping:Ub,clamp:ko2,clearcoat:Sn2,clearcoatNormalView:ud2,clearcoatRoughness:En2,code:jb,color:Xi2,colorSpaceToWorking:Tu2,colorToDirection:e=>Ii2(e).mul(2).sub(1),compute:Iu2,computeKernel:Fu2,computeSkinning:(e,t=null)=>{const s=new fh2(e);return s.positionNode=gh2(new Ja(e.geometry.getAttribute("position").array,3),"vec3").setPBO(!0).toReadOnly().element(eh2).toVar(),s.skinIndexNode=gh2(new Ja(new Uint32Array(e.geometry.getAttribute("skinIndex").array),4),"uvec4").setPBO(!0).toReadOnly().element(eh2).toVar(),s.skinWeightNode=gh2(new Ja(e.geometry.getAttribute("skinWeight").array,4),"vec4").setPBO(!0).toReadOnly().element(eh2).toVar(),s.bindMatrixNode=ta2(e.bindMatrix,"mat4"),s.bindMatrixInverseNode=ta2(e.bindMatrixInverse,"mat4"),s.boneMatricesNode=ll2(e.skeleton.boneMatrices,"mat4",e.skeleton.bones.length),s.toPositionNode=t,Ii2(s)},context:tu2,convert:fn2,convertColorSpace:(e,t,s)=>Ii2(new bu2(Ii2(e),t,s)),convertToTexture:(e,...t)=>e.isTextureNode?e:e.isPassNode?e.getTextureNode():Ky(e,...t),cos:ro2,cross:Po2,cubeTexture:wd2,cubeTextureBase:Ed2,cubeToUV:cT,dFdx:po,dFdy:go2,dashSize:On2,debug:Ku2,decrement:Fa2,decrementBefore:Ba2,defaultBuildStages:zs2,defaultShaderStages:Gs2,defined:Bi2,degrees:$a2,deltaTime:by,densityFog:function(e,t){return console.warn('THREE.TSL: "densityFog( color, density )" is deprecated. Use "fog( color, densityFogFactor( density ) )" instead.'),ax(e,nx(t))},densityFogFactor:nx,depth:tp,depthPass:(e,t,s)=>Ii2(new Fb(Fb.DEPTH,e,t,s)),determinant:To2,difference:Co,diffuseColor:Tn2,directPointLight:vT,directionToColor:Ap,directionToFaceDirection:ed2,dispersion:jn2,distance:Ro2,div:pa,dodge:(...e)=>(console.warn('THREE.TSL: "dodge" has been renamed. Use "blendDodge" instead.'),cp(e)),dot:Mo2,drawIndex:ih2,dynamicBufferAttribute:Mu2,element:mn2,emissive:_n2,equal:ma2,equals:No2,equirectUV:Mp,exp:Wa2,exp2:qa2,expression:$u2,faceDirection:Jl2,faceForward:$o2,faceforward:Yo2,float:Ki2,floor:Qa2,fog:ax,fract:eo2,frameGroup:Qn2,frameId:xy,frontFacing:Zl2,fwidth:bo2,gain:(e,t)=>e.lessThan(.5)?dy(e.mul(2),t).div(2):ca2(1,dy(ha2(ca2(1,e),2),t).div(2)),gapSize:kn2,getConstNodeType:Li2,getCurrentStack:Wi2,getDirection:im,getDistanceAttenuation:_T,getGeometryRoughness:Zp,getNormalFromDepth:Zy,getParallaxCorrectNormal:b_,getRoughness:Jp,getScreenPosition:Qy,getShIrradianceAt:x_,getShadowMaterial:Jx,getShadowRenderObjectFunction:rT,getTextureIndex:ay,getViewPosition:Yy,globalId:mx,glsl:(e,t)=>jb(e,t,"glsl"),glslFn:(e,t)=>Kb(e,t,"glsl"),grayscale:Nb,greaterThan:ba2,greaterThanEqual:Ta2,hash:ly,highpModelNormalViewMatrix:Hl2,highpModelViewMatrix:zl2,hue:wb,increment:La2,incrementBefore:Pa2,instance:ah2,instanceIndex:eh2,instancedArray:(e,t="float")=>{let s,i;!0===t.isStruct?(s=t.layout.getLength(),i=As2("float")):(s=Rs2(t),i=As2(t));const r=new rb(e,s,i);return gh2(r,t,e)},instancedBufferAttribute:Pu2,instancedDynamicBufferAttribute:Bu2,instancedMesh:uh2,int:Yi2,inverse:_o2,inverseSqrt:Ya2,inversesqrt:Qo2,invocationLocalIndex:sh2,invocationSubgroupIndex:rh2,ior:zn2,iridescence:Rn2,iridescenceIOR:Cn2,iridescenceThickness:Mn2,ivec2:en2,ivec3:nn2,ivec4:ln3,js:(e,t)=>jb(e,t,"js"),label:su2,length:lo2,lengthSq:Uo2,lessThan:ya2,lessThanEqual:xa2,lightPosition:Rx,lightProjectionUV:Ax,lightShadowMatrix:wx,lightTargetDirection:Px,lightTargetPosition:Cx,lightViewPosition:Mx,lightingContext:Ch2,lights:(e=[])=>Ii2(new Ix).setLights(e),linearDepth:rp,linearToneMapping:Db,localId:fx,log:ja2,log2:Xa2,logarithmicDepthToViewZ:(e,t,s)=>{const i=e.mul(ja2(s.div(t)));return Ki2(Math.E).pow(i).mul(t).negate()},luminance:Ab,mat2:hn2,mat3:pn2,mat4:gn2,matcapUV:Km,materialAO:Kc2,materialAlphaTest:pc2,materialAnisotropy:Bc2,materialAnisotropyVector:Yc2,materialAttenuationColor:kc2,materialAttenuationDistance:Oc2,materialClearcoat:wc2,materialClearcoatNormal:Rc2,materialClearcoatRoughness:Ac2,materialColor:gc2,materialDispersion:jc2,materialEmissive:fc2,materialEnvIntensity:yd2,materialEnvRotation:bd2,materialIOR:Uc2,materialIridescence:Lc2,materialIridescenceIOR:Fc2,materialIridescenceThickness:Ic2,materialLightMap:Xc2,materialLineDashOffset:Wc2,materialLineDashSize:zc2,materialLineGapSize:Hc2,materialLineScale:Gc,materialLineWidth:$c,materialMetalness:Sc2,materialNormal:Ec2,materialOpacity:yc2,materialPointSize:qc2,materialReference:Bd2,materialReflectivity:vc2,materialRefractionRatio:fd2,materialRotation:Cc2,materialRoughness:Nc2,materialSheen:Mc2,materialSheenRoughness:Pc2,materialShininess:mc2,materialSpecular:bc2,materialSpecularColor:Tc2,materialSpecularIntensity:xc2,materialSpecularStrength:_c2,materialThickness:Vc2,materialTransmission:Dc2,max:Eo2,maxMipLevel:rl2,mediumpModelViewMatrix:Gl2,metalness:Nn2,min:So2,mix:Oo2,mixElement:qo2,mod:ga2,modInt:Ia2,modelDirection:Bl2,modelNormalMatrix:Ul2,modelPosition:Fl2,modelRadius:Vl2,modelScale:Il2,modelViewMatrix:kl2,modelViewPosition:Dl2,modelViewProjection:Qc,modelWorldMatrix:Ll2,modelWorldMatrixInverse:Ol2,morphReference:Eh2,mrt:uy,mul:ha2,mx_aastep:m_,mx_add:(e,t=Ki2(0))=>da2(e,t),mx_atan2:(e=Ki2(0),t=Ki2(1))=>ao2(e,t),mx_cell_noise_float:(e=Zu2())=>QT(e.convert("vec2|vec3")),mx_contrast:(e,t=1,s=.5)=>Ki2(e).sub(s).mul(t).add(s),mx_divide:(e,t=Ki2(1))=>pa(e,t),mx_fractal_noise_float:(e=Zu2(),t=3,s=2,i=.5,r=1)=>JT(e,Yi2(t),s,i).mul(r),mx_fractal_noise_vec2:(e=Zu2(),t=3,s=2,i=.5,r=1)=>t_(e,Yi2(t),s,i).mul(r),mx_fractal_noise_vec3:(e=Zu2(),t=3,s=2,i=.5,r=1)=>e_(e,Yi2(t),s,i).mul(r),mx_fractal_noise_vec4:(e=Zu2(),t=3,s=2,i=.5,r=1)=>r_(e,Yi2(t),s,i).mul(r),mx_frame:()=>xy,mx_heighttonormal:(e,t)=>(e=sn2(e),t=Ki2(t),dc2(e,t)),mx_hsvtorgb:h_,mx_ifequal:(e,t,s,i)=>e.equal(t).mix(s,i),mx_ifgreater:(e,t,s,i)=>e.greaterThan(t).mix(s,i),mx_ifgreatereq:(e,t,s,i)=>e.greaterThanEqual(t).mix(s,i),mx_invert:(e,t=Ki2(1))=>ca2(t,e),mx_modulo:(e,t=Ki2(1))=>ga2(e,t),mx_multiply:(e,t=Ki2(1))=>ha2(e,t),mx_noise_float:(e=Zu2(),t=1,s=0)=>KT(e.convert("vec2|vec3")).mul(t).add(s),mx_noise_vec3:(e=Zu2(),t=1,s=0)=>YT(e.convert("vec2|vec3")).mul(t).add(s),mx_noise_vec4:(e=Zu2(),t=1,s=0)=>(e=e.convert("vec2|vec3"),un2(YT(e),KT(e.add(Ji2(19,73)))).mul(t).add(s)),mx_place2d:(e,t=Ji2(.5,.5),s=Ji2(1,1),i=Ki2(0),r=Ji2(0,0))=>{let n=e;if(t&&(n=n.sub(t)),s&&(n=n.mul(s)),i){const e=i.mul(Math.PI/180),t=e.cos(),s=e.sin();n=Ji2(n.x.mul(t).sub(n.y.mul(s)),n.x.mul(s).add(n.y.mul(t)))}return t&&(n=n.add(t)),r&&(n=n.add(r)),n},mx_power:(e,t=Ki2(1))=>Bo(e,t),mx_ramp4:(e,t,s,i,r=Zu2())=>{const n=r.x.clamp(),a=r.y.clamp(),o=Oo2(e,t,n),l=Oo2(s,i,n);return Oo2(o,l,a)},mx_ramplr:(e,t,s=Zu2())=>f_(e,t,s,"x"),mx_ramptb:(e,t,s=Zu2())=>f_(e,t,s,"y"),mx_rgbtohsv:p_,mx_rotate2d:(e,t)=>{e=Ji2(e);const s=(t=Ki2(t)).mul(Math.PI/180);return Jm(e,s)},mx_rotate3d:(e,t,s)=>{e=sn2(e),t=Ki2(t),s=sn2(s);const i=t.mul(Math.PI/180),r=s.normalize(),n=i.cos(),a=i.sin(),o=Ki2(1).sub(n);return e.mul(n).add(r.cross(e).mul(a)).add(r.mul(r.dot(e)).mul(o))},mx_safepower:(e,t=1)=>(e=Ki2(e)).abs().pow(t).mul(e.sign()),mx_separate:(e,t=null)=>{if("string"==typeof t){const s={x:0,r:0,y:1,g:1,z:2,b:2,w:3,a:3},i=t.replace(/^out/,"").toLowerCase();if(void 0!==s[i])return e.element(s[i])}if("number"==typeof t)return e.element(t);if("string"==typeof t&&1===t.length){const s={x:0,r:0,y:1,g:1,z:2,b:2,w:3,a:3};if(void 0!==s[t])return e.element(s[t])}return e},mx_splitlr:(e,t,s,i=Zu2())=>y_(e,t,s,i,"x"),mx_splittb:(e,t,s,i=Zu2())=>y_(e,t,s,i,"y"),mx_srgb_texture_to_lin_rec709:g_,mx_subtract:(e,t=Ki2(0))=>ca2(e,t),mx_timer:()=>yy,mx_transform_uv:(e=1,t=0,s=Zu2())=>s.mul(e).add(t),mx_unifiednoise2d:(e,t=Zu2(),s=Ji2(1,1),i=Ji2(0,0),r=1,n=0,a=1,o=!1,l=1,h=2,u=.5)=>d_(e,t.convert("vec2|vec3"),s,i,r,n,a,o,l,h,u),mx_unifiednoise3d:(e,t=Zu2(),s=Ji2(1,1),i=Ji2(0,0),r=1,n=0,a=1,o=!1,l=1,h=2,u=.5)=>c_(e,t.convert("vec2|vec3"),s,i,r,n,a,o,l,h,u),mx_worley_noise_float:(e=Zu2(),t=1)=>o_(e.convert("vec2|vec3"),t,Yi2(1)),mx_worley_noise_vec2:(e=Zu2(),t=1)=>u_(e.convert("vec2|vec3"),t,Yi2(1)),mx_worley_noise_vec3:(e=Zu2(),t=1)=>l_(e.convert("vec2|vec3"),t,Yi2(1)),negate:co2,neutralToneMapping:Wb,nodeArray:Ui2,nodeImmutable:ki2,nodeObject:Ii2,nodeObjectIntent:Di2,nodeObjects:Vi2,nodeProxy:Oi2,nodeProxyIntent:Gi2,normalFlat:sd2,normalGeometry:td2,normalLocal:rd2,normalMap:ac2,normalView:ad2,normalViewGeometry:id2,normalWorld:od2,normalWorldGeometry:nd2,normalize:Ja2,not:Na2,notEqual:fa2,numWorkgroups:px,objectDirection:El2,objectGroup:Jn,objectPosition:Al2,objectRadius:Ml2,objectScale:Rl2,objectViewPosition:Cl2,objectWorldMatrix:wl2,oneMinus:ho2,or:va2,orthographicDepthToViewZ:(e,t,s)=>t.sub(s).mul(e).sub(t),oscSawtooth:(e=yy)=>e.fract(),oscSine:(e=yy)=>e.add(.75).mul(2*Math.PI).sin().mul(.5).add(.5),oscSquare:(e=yy)=>e.fract().round(),oscTriangle:(e=yy)=>e.add(.5).fract().mul(2).sub(1).abs(),output:Un2,outputStruct:ny,overlay:(...e)=>(console.warn('THREE.TSL: "overlay" has been renamed. Use "blendOverlay" instead.'),pp(e)),overloadingFn:fy,parabola:dy,parallaxDirection:sc2,parallaxUV:(e,t)=>e.sub(sc2.mul(t)),parameter:(e,t)=>Ii2(new Jf(e,t)),pass:(e,t,s)=>Ii2(new Fb(Fb.COLOR,e,t,s)),passTexture:(e,t)=>Ii2(new Bb(e,t)),pcurve:(e,t,s)=>Bo(pa(Bo(e,t),da2(Bo(e,t),Bo(ca2(1,e),s))),1/t),perspectiveDepthToViewZ:Zh2,pmremTexture:Fm,pointShadow:xT,pointUV:nb,pointWidth:Gn2,positionGeometry:$l2,positionLocal:Wl2,positionPrevious:ql2,positionView:Kl2,positionViewDirection:Yl2,positionWorld:jl2,positionWorldDirection:Xl2,posterize:Mb,pow:Bo,pow2:Lo2,pow3:Fo2,pow4:Io,premultiplyAlpha:mp,property:bn2,radians:Ha2,rand:Wo2,range:dx,rangeFog:function(e,t,s){return console.warn('THREE.TSL: "rangeFog( color, near, far )" is deprecated. Use "fog( color, rangeFogFactor( near, far ) )" instead.'),ax(e,ix(t,s))},rangeFogFactor:ix,reciprocal:fo2,reference:Cd2,referenceBuffer:Md2,reflect:Ao2,reflectVector:_d2,reflectView:xd2,reflector:e=>Ii2(new Gy(e)),refract:zo2,refractVector:vd2,refractView:Td2,reinhardToneMapping:Vb,remap:Gu2,remapClamp:zu2,renderGroup:Zn2,renderOutput:ju2,rendererReference:Su2,rotate:Jm,rotateUV:Ty,roughness:vn2,round:mo,rtt:Ky,sRGBTransferEOTF:mu2,sRGBTransferOETF:fu2,sample:e=>Ii2(new Jy(e)),sampler:e=>(!0===e.isNode?e:al2(e)).convert("sampler"),samplerComparison:e=>(!0===e.isNode?e:al2(e)).convert("samplerComparison"),saturate:Go2,saturation:Sb,screen:(...e)=>(console.warn('THREE.TSL: "screen" has been renamed. Use "blendScreen" instead.'),hp(e)),screenCoordinate:Dh2,screenSize:Ih2,screenUV:Fh2,scriptable:rx,scriptableValue:Qb,select:Jo2,setCurrentStack:$i2,setName:ru2,shaderStages:Hs2,shadow:lT,shadowPositionWorld:Vx,shapeCircle:ET,sharedUniformGroup:Yn2,sheen:wn2,sheenRoughness:An2,shiftLeft:Ca2,shiftRight:Ma2,shininess:Vn2,sign:uo2,sin:to2,sinc:(e,t)=>to2(Oa2.mul(t.mul(e).sub(1))).div(Oa2.mul(t.mul(e).sub(1))),skinning:yh2,smoothstep:Ho2,smoothstepElement:jo2,specularColor:In2,specularF90:Dn2,spherizeUV:_y,split:(e,t)=>Ii2(new Js2(Ii2(e),t)),spritesheetUV:Ey,sqrt:Ka2,stack:ty,step:wo2,stepElement:Xo2,storage:gh2,storageBarrier:()=>bx("storage").toStack(),storageObject:(e,t,s)=>(console.warn('THREE.TSL: "storageObject()" is deprecated. Use "storage().setPBO( true )" instead.'),gh2(e,t,s).setPBO(!0)),storageTexture:pb,string:(e="")=>Ii2(new ii2(e,"string")),struct:(e,t=null)=>{const s=new ry(e,t),i=(...t)=>{let i=null;if(t.length>0)if(t[0].isNode){i={};const s=Object.keys(e);for(let e=0;e<t.length;e++)i[s[e]]=t[e]}else i=t[0];return Ii2(new sy(s,i))};return i.layout=s,i.isStruct=!0,i},sub:ca2,subBuild:cu2,subgroupIndex:th2,subgroupSize:yx,tan:so2,tangentGeometry:jd2,tangentLocal:Xd,tangentView:Kd,tangentWorld:Yd,temp:lu2,texture:al2,texture3D:fb,textureBarrier:()=>bx("texture").toStack(),textureBicubic:Rg,textureBicubicLevel:Ag,textureCubeUV:nm,textureLoad:ol2,textureSize:el2,textureStore:(e,t,s)=>{const i=pb(e,t,s);return null!==s&&i.toStack(),i},thickness:$n2,time:yy,timerDelta:(e=1)=>(console.warn('TSL: timerDelta() is deprecated. Use "deltaTime" instead.'),by.mul(e)),timerGlobal:(e=1)=>(console.warn('TSL: timerGlobal() is deprecated. Use "time" instead.'),yy.mul(e)),timerLocal:(e=1)=>(console.warn('TSL: timerLocal() is deprecated. Use "time" instead.'),yy.mul(e)),toneMapping:wu2,toneMappingExposure:Au2,toonOutlinePass:(e,t,s=new $r(0,0,0),i=.003,r=1)=>Ii2(new Ib(e,t,Ii2(s),Ii2(i),Ii2(r))),transformDirection:Do2,transformNormal:ld2,transformNormalToView:dd,transformedClearcoatNormalView:pd2,transformedNormalView:cd2,transformedNormalWorld:hd2,transmission:Hn,transpose:xo2,triNoise3D:py,triplanarTexture:(...e)=>wy(...e),triplanarTextures:wy,trunc:yo,uint:Qi2,uniform:ta2,uniformArray:hl2,uniformCubeTexture:(e=Nd2)=>Ed2(e),uniformGroup:Kn2,uniformTexture:(e=sl2)=>al2(e),unpremultiplyAlpha:fp,userData:(e,t,s)=>Ii2(new yb(e,t,s)),uv:Zu2,uvec2:tn2,uvec3:an2,uvec4:dn2,varying:pu2,varyingProperty:xn2,vec2:Ji2,vec3:sn2,vec4:un2,vectorComponents:$s2,velocity:vb,vertexColor:lp,vertexIndex:Jc2,vertexStage:gu2,vibrance:Eb,viewZToLogarithmicDepth:Jh2,viewZToOrthographicDepth:Yh2,viewZToPerspectiveDepth:Qh2,viewport:Vh2,viewportCoordinate:Oh2,viewportDepthTexture:Xh2,viewportLinearDepth:sp,viewportMipTexture:Wh2,viewportResolution:Gh2,viewportSafeUV:Ny,viewportSharedTexture:Sp,viewportSize:Uh2,viewportTexture:$h2,viewportUV:kh2,wgsl:(e,t)=>jb(e,t,"wgsl"),wgslFn:(e,t)=>Kb(e,t,"wgsl"),workgroupArray:(e,t)=>Ii2(new Tx("Workgroup",e,t)),workgroupBarrier:()=>bx("workgroup").toStack(),workgroupId:gx,workingToColorSpace:xu2,xor:Sa2}),__=new Zf,v_=class extends xf{constructor(e,t){super(),this.renderer=e,this.nodes=t}update(e,t,s){const i=this.renderer,r=this.nodes.getBackgroundNode(e)||e.background;let n=!1;if(null===r)i._clearColor.getRGB(__),__.a=i._clearColor.a;else if(!0===r.isColor)r.getRGB(__),__.a=1,n=!0;else if(!0===r.isNode){const s=this.get(e),n=r;__.copy(i._clearColor);let a=s.backgroundMesh;if(void 0===a){let e=function(){r.removeEventListener("dispose",e),a.material.dispose(),a.geometry.dispose()};const t=tu2(un2(n).mul(db),{getUV:()=>cb.mul(nd2),getTextureLevel:()=>lb});let i=Qc;i=i.setZ(i.w);const o=new yp;o.name="Background.material",o.side=d2,o.depthTest=!1,o.depthWrite=!1,o.allowOverride=!1,o.fog=!1,o.lights=!1,o.vertexNode=i,o.colorNode=t,s.backgroundMeshNode=t,s.backgroundMesh=a=new jn(new Al(1,32,32),o),a.frustumCulled=!1,a.name="Background.mesh",a.onBeforeRender=function(e,t,s){this.matrixWorld.copyPosition(s.matrixWorld)},r.addEventListener("dispose",e)}const o=n.getCacheKey();s.backgroundCacheKey!==o&&(s.backgroundMeshNode.node=un2(n).mul(db),s.backgroundMeshNode.needsUpdate=!0,a.material.needsUpdate=!0,s.backgroundCacheKey=o),t.unshift(a,a.geometry,a.material,0,0,null,null)}else console.error("THREE.Renderer: Unsupported background configuration.",r);const a=i.xr.getEnvironmentBlendMode();if("additive"===a?__.set(0,0,0,1):"alpha-blend"===a&&__.set(0,0,0,0),!0===i.autoClear||!0===n){const e=s.clearColorValue;e.r=__.r,e.g=__.g,e.b=__.b,e.a=__.a,!0!==i.backend.isWebGLBackend&&!0!==i.alpha||(e.r*=e.a,e.g*=e.a,e.b*=e.a),s.depthClearValue=i._clearDepth,s.stencilClearValue=i._clearStencil,s.clearColor=!0===i.autoClearColor,s.clearDepth=!0===i.autoClearDepth,s.clearStencil=!0===i.autoClearStencil}else s.clearColor=!1,s.clearDepth=!1,s.clearStencil=!1}},N_=0,S_=class{constructor(e="",t=[],s=0,i=[]){this.name=e,this.bindings=t,this.index=s,this.bindingsReference=i,this.id=N_++}},E_=class{constructor(e,t,s,i,r,n,a,o,l,h=[]){this.vertexShader=e,this.fragmentShader=t,this.computeShader=s,this.transforms=h,this.nodeAttributes=i,this.bindings=r,this.updateNodes=n,this.updateBeforeNodes=a,this.updateAfterNodes=o,this.observer=l,this.usedTimes=0}createBindings(){const e=[];for(const t of this.bindings)if(!0!==t.bindings[0].groupNode.shared){const s=new S_(t.name,[],t.index,t);e.push(s);for(const e of t.bindings)s.bindings.push(e.clone())}else e.push(t);return e}},w_=class{constructor(e,t,s=null){this.isNodeAttribute=!0,this.name=e,this.type=t,this.node=s}},A_=class{constructor(e,t,s){this.isNodeUniform=!0,this.name=e,this.type=t,this.node=s.getSelf()}get value(){return this.node.value}set value(e){this.node.value=e}get id(){return this.node.id}get groupNode(){return this.node.groupNode}},R_=class{constructor(e,t,s=!1,i=null){this.isNodeVar=!0,this.name=e,this.type=t,this.readOnly=s,this.count=i}},C_=class extends R_{constructor(e,t,s=null,i=null){super(e,t),this.needsInterpolation=!1,this.isNodeVarying=!0,this.interpolationType=s,this.interpolationSampling=i}},M_=class{constructor(e,t,s=""){this.name=e,this.type=t,this.code=s,Object.defineProperty(this,"isNodeCode",{value:!0})}},P_=0,B_=class{constructor(e=null){this.id=P_++,this.nodesData=new WeakMap,this.parent=e}getData(e){let t=this.nodesData.get(e);return void 0===t&&null!==this.parent&&(t=this.parent.getData(e)),t}setData(e,t){this.nodesData.set(e,t)}},L_=class{constructor(e,t){this.name=e,this.members=t,this.output=!1}},F_=class{constructor(e,t){this.name=e,this.value=t,this.boundary=0,this.itemSize=0,this.offset=0}setValue(e){this.value=e}getValue(){return this.value}},I_=class extends F_{constructor(e,t=0){super(e,t),this.isNumberUniform=!0,this.boundary=4,this.itemSize=1}},D_=class extends F_{constructor(e,t=new Gi){super(e,t),this.isVector2Uniform=!0,this.boundary=8,this.itemSize=2}},V_=class extends F_{constructor(e,t=new Qi){super(e,t),this.isVector3Uniform=!0,this.boundary=16,this.itemSize=3}},U_=class extends F_{constructor(e,t=new As){super(e,t),this.isVector4Uniform=!0,this.boundary=16,this.itemSize=4}},O_=class extends F_{constructor(e,t=new $r){super(e,t),this.isColorUniform=!0,this.boundary=16,this.itemSize=3}},k_=class extends F_{constructor(e,t=new Zu){super(e,t),this.isMatrix2Uniform=!0,this.boundary=8,this.itemSize=4}},G_=class extends F_{constructor(e,t=new es){super(e,t),this.isMatrix3Uniform=!0,this.boundary=48,this.itemSize=12}},z_=class extends F_{constructor(e,t=new nr){super(e,t),this.isMatrix4Uniform=!0,this.boundary=64,this.itemSize=16}},H_=class extends I_{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}},$_=class extends D_{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}},W_=class extends V_{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}},q_=class extends U_{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}},j_=class extends O_{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}},X_=class extends k_{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}},K_=class extends G_{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}},Y_=class extends z_{constructor(e){super(e.name,e.value),this.nodeUniform=e}getValue(){return this.nodeUniform.value}getType(){return this.nodeUniform.type}},Q_=new WeakMap,Z_=new Map([[Int8Array,"int"],[Int16Array,"int"],[Int32Array,"int"],[Uint8Array,"uint"],[Uint16Array,"uint"],[Uint32Array,"uint"],[Float32Array,"float"]]),J_=e=>/e/g.test(e)?String(e).replace(/\+/g,""):(e=Number(e))+(e%1?"":".0"),ev=class{constructor(e,t,s){this.object=e,this.material=e&&e.material||null,this.geometry=e&&e.geometry||null,this.renderer=t,this.parser=s,this.scene=null,this.camera=null,this.nodes=[],this.sequentialNodes=[],this.updateNodes=[],this.updateBeforeNodes=[],this.updateAfterNodes=[],this.hashNodes={},this.observer=null,this.lightsNode=null,this.environmentNode=null,this.fogNode=null,this.clippingContext=null,this.vertexShader=null,this.fragmentShader=null,this.computeShader=null,this.flowNodes={vertex:[],fragment:[],compute:[]},this.flowCode={vertex:"",fragment:"",compute:""},this.uniforms={vertex:[],fragment:[],compute:[],index:0},this.structs={vertex:[],fragment:[],compute:[],index:0},this.bindings={vertex:{},fragment:{},compute:{}},this.bindingsIndexes={},this.bindGroups=null,this.attributes=[],this.bufferAttributes=[],this.varyings=[],this.codes={},this.vars={},this.declarations={},this.flow={code:""},this.chaining=[],this.stack=ty(),this.stacks=[],this.tab="\t",this.currentFunctionNode=null,this.context={material:this.material},this.cache=new B_,this.globalCache=this.cache,this.flowsData=new WeakMap,this.shaderStage=null,this.buildStage=null,this.subBuildLayers=[],this.currentStack=null,this.subBuildFn=null}getBindGroupsCache(){let e=Q_.get(this.renderer);return void 0===e&&(e=new gf,Q_.set(this.renderer,e)),e}createRenderTarget(e,t,s){return new Ts(e,t,s)}createCubeRenderTarget(e,t){return new Pp(e,t)}includes(e){return this.nodes.includes(e)}getOutputStructName(){}_getBindGroup(e,t){const s=this.getBindGroupsCache(),i=[];let r,n=!0;for(const e of t)i.push(e),n=n&&!0!==e.groupNode.shared;return n?(r=s.get(i),void 0===r&&(r=new S_(e,i,this.bindingsIndexes[e].group,i),s.set(i,r))):r=new S_(e,i,this.bindingsIndexes[e].group,i),r}getBindGroupArray(e,t){const s=this.bindings[t];let i=s[e];return void 0===i&&(void 0===this.bindingsIndexes[e]&&(this.bindingsIndexes[e]={binding:0,group:Object.keys(this.bindingsIndexes).length}),s[e]=i=[]),i}getBindings(){let e=this.bindGroups;if(null===e){const t={},s=this.bindings;for(const e of Hs2)for(const i in s[e]){const r=s[e][i];(t[i]||(t[i]=[])).push(...r)}e=[];for(const s in t){const i=t[s],r=this._getBindGroup(s,i);e.push(r)}this.bindGroups=e}return e}sortBindingGroups(){const e=this.getBindings();e.sort((e,t)=>e.bindings[0].groupNode.order-t.bindings[0].groupNode.order);for(let t=0;t<e.length;t++){const s=e[t];this.bindingsIndexes[s.name].group=t,s.index=t}}setHashNode(e,t){this.hashNodes[t]=e}addNode(e){!1===this.nodes.includes(e)&&(this.nodes.push(e),this.setHashNode(e,e.getHash(this)))}addSequentialNode(e){!1===this.sequentialNodes.includes(e)&&this.sequentialNodes.push(e)}buildUpdateNodes(){for(const e of this.nodes)e.getUpdateType()!==Us2.NONE&&this.updateNodes.push(e.getSelf());for(const e of this.sequentialNodes){const t=e.getUpdateBeforeType(),s=e.getUpdateAfterType();t!==Us2.NONE&&this.updateBeforeNodes.push(e.getSelf()),s!==Us2.NONE&&this.updateAfterNodes.push(e.getSelf())}}get currentNode(){return this.chaining[this.chaining.length-1]}isFilteredTexture(e){return e.magFilter===wt||e.magFilter===Mt||e.magFilter===bt||e.magFilter===_t||e.minFilter===wt||e.minFilter===Mt||e.minFilter===bt||e.minFilter===_t}addChain(e){this.chaining.push(e)}removeChain(e){if(this.chaining.pop()!==e)throw new Error("NodeBuilder: Invalid node chaining!")}getMethod(e){return e}getNodeFromHash(e){return this.hashNodes[e]}addFlow(e,t){return this.flowNodes[e].push(t),t}setContext(e){this.context=e}getContext(){return this.context}getSharedContext(){return this.context,this.context}setCache(e){this.cache=e}getCache(){return this.cache}getCacheFromNode(e,t=!0){const s=this.getDataFromNode(e);return void 0===s.cache&&(s.cache=new B_(t?this.getCache():null)),s.cache}isAvailable(){return!1}getVertexIndex(){console.warn("Abstract function.")}getInstanceIndex(){console.warn("Abstract function.")}getDrawIndex(){console.warn("Abstract function.")}getFrontFacing(){console.warn("Abstract function.")}getFragCoord(){console.warn("Abstract function.")}isFlipY(){return!1}increaseUsage(e){const t=this.getDataFromNode(e);return t.usageCount=void 0===t.usageCount?1:t.usageCount+1,t.usageCount}generateTexture(){console.warn("Abstract function.")}generateTextureLod(){console.warn("Abstract function.")}generateArrayDeclaration(e,t){return this.getType(e)+"[ "+t+" ]"}generateArray(e,t,s=null){let i=this.generateArrayDeclaration(e,t)+"( ";for(let r=0;r<t;r++){const n=s?s[r]:null;i+=null!==n?n.build(this,e):this.generateConst(e),r<t-1&&(i+=", ")}return i+=" )",i}generateStruct(e,t,s=null){const i=[];for(const e of t){const{name:t,type:r}=e;s&&s[t]&&s[t].isNode?i.push(s[t].build(this,r)):i.push(this.generateConst(r))}return e+"( "+i.join(", ")+" )"}generateConst(e,t=null){if(null===t&&("float"===e||"int"===e||"uint"===e?t=0:"bool"===e?t=!1:"color"===e?t=new $r:"vec2"===e?t=new Gi:"vec3"===e?t=new Qi:"vec4"===e&&(t=new As)),"float"===e)return J_(t);if("int"===e)return`${Math.round(t)}`;if("uint"===e)return t>=0?`${Math.round(t)}u`:"0u";if("bool"===e)return t?"true":"false";if("color"===e)return`${this.getType("vec3")}( ${J_(t.r)}, ${J_(t.g)}, ${J_(t.b)} )`;const s=this.getTypeLength(e),i=this.getComponentType(e),r=e=>this.generateConst(i,e);if(2===s)return`${this.getType(e)}( ${r(t.x)}, ${r(t.y)} )`;if(3===s)return`${this.getType(e)}( ${r(t.x)}, ${r(t.y)}, ${r(t.z)} )`;if(4===s&&"mat2"!==e)return`${this.getType(e)}( ${r(t.x)}, ${r(t.y)}, ${r(t.z)}, ${r(t.w)} )`;if(s>=4&&t&&(t.isMatrix2||t.isMatrix3||t.isMatrix4))return`${this.getType(e)}( ${t.elements.map(r).join(", ")} )`;if(s>4)return`${this.getType(e)}()`;throw new Error(`NodeBuilder: Type '${e}' not found in generate constant attempt.`)}getType(e){return"color"===e?"vec3":e}hasGeometryAttribute(e){return this.geometry&&void 0!==this.geometry.getAttribute(e)}getAttribute(e,t){const s=this.attributes;for(const t of s)if(t.name===e)return t;const i=new w_(e,t);return this.registerDeclaration(i),s.push(i),i}getPropertyName(e){return e.name}isVector(e){return/vec\d/.test(e)}isMatrix(e){return/mat\d/.test(e)}isReference(e){return"void"===e||"property"===e||"sampler"===e||"samplerComparison"===e||"texture"===e||"cubeTexture"===e||"storageTexture"===e||"depthTexture"===e||"texture3D"===e}needsToWorkingColorSpace(){return!1}getComponentTypeFromTexture(e){const t=e.type;if(e.isDataTexture){if(t===Bt)return"int";if(t===kt)return"uint"}return"float"}getElementType(e){return"mat2"===e?"vec2":"mat3"===e?"vec3":"mat4"===e?"vec4":this.getComponentType(e)}getComponentType(e){if("float"===(e=this.getVectorType(e))||"bool"===e||"int"===e||"uint"===e)return e;const t=/(b|i|u|)(vec|mat)([2-4])/.exec(e);return null===t?null:"b"===t[1]?"bool":"i"===t[1]?"int":"u"===t[1]?"uint":"float"}getVectorType(e){return"color"===e?"vec3":"texture"===e||"cubeTexture"===e||"storageTexture"===e||"texture3D"===e?"vec4":e}getTypeFromLength(e,t="float"){if(1===e)return t;let s=ws2(e);const i="float"===t?"":t[0];return!0===/mat2/.test(t)&&(s=s.replace("vec","mat")),i+s}getTypeFromArray(e){return Z_.get(e.constructor)}isInteger(e){return/int|uint|(i|u)vec/.test(e)}getTypeFromAttribute(e){let t=e;e.isInterleavedBufferAttribute&&(t=e.data);const s=t.array,i=e.itemSize,r=e.normalized;let n;return e instanceof bn||!0===r||(n=this.getTypeFromArray(s)),this.getTypeFromLength(i,n)}getTypeLength(e){const t=this.getVectorType(e),s=/vec([2-4])/.exec(t);return null!==s?Number(s[1]):"float"===t||"bool"===t||"int"===t||"uint"===t?1:!0===/mat2/.test(e)?4:!0===/mat3/.test(e)?9:!0===/mat4/.test(e)?16:0}getVectorFromMatrix(e){return e.replace("mat","vec")}changeComponentType(e,t){return this.getTypeFromLength(this.getTypeLength(e),t)}getIntegerType(e){const t=this.getComponentType(e);return"int"===t||"uint"===t?e:this.changeComponentType(e,"int")}addStack(){return this.stack=ty(this.stack),this.stacks.push(Wi2()||this.stack),$i2(this.stack),this.stack}removeStack(){const e=this.stack;return this.stack=e.parent,$i2(this.stacks.pop()),e}getDataFromNode(e,t=this.shaderStage,s=null){let i=(s=null===s?e.isGlobal(this)?this.globalCache:this.cache:s).getData(e);void 0===i&&(i={},s.setData(e,i)),void 0===i[t]&&(i[t]={});let r=i[t];const n=i.any?i.any.subBuilds:null,a=this.getClosestSubBuild(n);return a&&(void 0===r.subBuildsCache&&(r.subBuildsCache={}),r=r.subBuildsCache[a]||(r.subBuildsCache[a]={}),r.subBuilds=n),r}getNodeProperties(e,t="any"){const s=this.getDataFromNode(e,t);return s.properties||(s.properties={outputNode:null})}getBufferAttributeFromNode(e,t){const s=this.getDataFromNode(e);let i=s.bufferAttribute;if(void 0===i){const r=this.uniforms.index++;i=new w_("nodeAttribute"+r,t,e),this.bufferAttributes.push(i),s.bufferAttribute=i}return i}getStructTypeFromNode(e,t,s=null,i=this.shaderStage){const r=this.getDataFromNode(e,i,this.globalCache);let n=r.structType;if(void 0===n){const e=this.structs.index++;null===s&&(s="StructType"+e),n=new L_(s,t),this.structs[i].push(n),r.structType=n}return n}getOutputStructTypeFromNode(e,t){const s=this.getStructTypeFromNode(e,t,"OutputType","fragment");return s.output=!0,s}getUniformFromNode(e,t,s=this.shaderStage,i=null){const r=this.getDataFromNode(e,s,this.globalCache);let n=r.uniform;if(void 0===n){const a=this.uniforms.index++;n=new A_(i||"nodeUniform"+a,t,e),this.uniforms[s].push(n),this.registerDeclaration(n),r.uniform=n}return n}getVarFromNode(e,t=null,s=e.getNodeType(this),i=this.shaderStage,r=!1){const n=this.getDataFromNode(e,i),a=this.getSubBuildProperty("variable",n.subBuilds);let o=n[a];if(void 0===o){const l=r?"_const":"_var",h=this.vars[i]||(this.vars[i]=[]),u=this.vars[l]||(this.vars[l]=0);null===t&&(t=(r?"nodeConst":"nodeVar")+u,this.vars[l]++),"variable"!==a&&(t=this.getSubBuildProperty(t,n.subBuilds));const c=e.getArrayCount(this);o=new R_(t,s,r,c),r||h.push(o),this.registerDeclaration(o),n[a]=o}return o}isDeterministic(e){if(e.isMathNode)return this.isDeterministic(e.aNode)&&(!e.bNode||this.isDeterministic(e.bNode))&&(!e.cNode||this.isDeterministic(e.cNode));if(e.isOperatorNode)return this.isDeterministic(e.aNode)&&(!e.bNode||this.isDeterministic(e.bNode));if(e.isArrayNode){if(null!==e.values)for(const t of e.values)if(!this.isDeterministic(t))return!1;return!0}return!!e.isConstNode}getVaryingFromNode(e,t=null,s=e.getNodeType(this),i=null,r=null){const n=this.getDataFromNode(e,"any"),a=this.getSubBuildProperty("varying",n.subBuilds);let o=n[a];if(void 0===o){const e=this.varyings,l=e.length;null===t&&(t="nodeVarying"+l),"varying"!==a&&(t=this.getSubBuildProperty(t,n.subBuilds)),o=new C_(t,s,i,r),e.push(o),this.registerDeclaration(o),n[a]=o}return o}registerDeclaration(e){const t=this.shaderStage,s=this.declarations[t]||(this.declarations[t]={}),i=this.getPropertyName(e);let r=1,n=i;for(;void 0!==s[n];)n=i+"_"+r++;r>1&&(e.name=n,console.warn(`THREE.TSL: Declaration name '${i}' of '${e.type}' already in use. Renamed to '${n}'.`)),s[n]=e}getCodeFromNode(e,t,s=this.shaderStage){const i=this.getDataFromNode(e);let r=i.code;if(void 0===r){const e=this.codes[s]||(this.codes[s]=[]),n=e.length;r=new M_("nodeCode"+n,t),e.push(r),i.code=r}return r}addFlowCodeHierarchy(e,t){const{flowCodes:s,flowCodeBlock:i}=this.getDataFromNode(e);let r=!0,n=t;for(;n;){if(!0===i.get(n)){r=!1;break}n=this.getDataFromNode(n).parentNodeBlock}if(r)for(const e of s)this.addLineFlowCode(e)}addLineFlowCodeBlock(e,t,s){const i=this.getDataFromNode(e),r=i.flowCodes||(i.flowCodes=[]),n=i.flowCodeBlock||(i.flowCodeBlock=new WeakMap);r.push(t),n.set(s,!0)}addLineFlowCode(e,t=null){return""===e||(null!==t&&this.context.nodeBlock&&this.addLineFlowCodeBlock(t,e,this.context.nodeBlock),e=this.tab+e,/;\s*$/.test(e)||(e+=";\n"),this.flow.code+=e),this}addFlowCode(e){return this.flow.code+=e,this}addFlowTab(){return this.tab+="\t",this}removeFlowTab(){return this.tab=this.tab.slice(0,-1),this}getFlowData(e){return this.flowsData.get(e)}flowNode(e){const t=e.getNodeType(this),s=this.flowChildNode(e,t);return this.flowsData.set(e,s),s}addInclude(e){null!==this.currentFunctionNode&&this.currentFunctionNode.includes.push(e)}buildFunctionNode(e){const t=new Xb,s=this.currentFunctionNode;return this.currentFunctionNode=t,t.code=this.buildFunctionCode(e),this.currentFunctionNode=s,t}flowShaderNode(e){const t=e.layout,s={[Symbol.iterator](){let e=0;const t=Object.values(this);return{next:()=>({value:t[e],done:e++>=t.length})}}};for(const e of t.inputs)s[e.name]=new Jf(e.type,e.name);e.layout=null;const i=e.call(s),r=this.flowStagesNode(i,t.type);return e.layout=t,r}flowBuildStage(e,t,s=null){const i=this.getBuildStage();this.setBuildStage(t);const r=e.build(this,s);return this.setBuildStage(i),r}flowStagesNode(e,t=null){const s=this.flow,i=this.vars,r=this.declarations,n=this.cache,a=this.buildStage,o=this.stack,l={code:""};this.flow=l,this.vars={},this.declarations={},this.cache=new B_,this.stack=ty();for(const s of zs2)this.setBuildStage(s),l.result=e.build(this,t);return l.vars=this.getVars(this.shaderStage),this.flow=s,this.vars=i,this.declarations=r,this.cache=n,this.stack=o,this.setBuildStage(a),l}getFunctionOperator(){return null}buildFunctionCode(){console.warn("Abstract function.")}flowChildNode(e,t=null){const s=this.flow,i={code:""};return this.flow=i,i.result=e.build(this,t),this.flow=s,i}flowNodeFromShaderStage(e,t,s=null,i=null){const r=this.tab,n=this.cache,a=this.shaderStage,o=this.context;this.setShaderStage(e);const l={...this.context};delete l.nodeBlock,this.cache=this.globalCache,this.tab="\t",this.context=l;let h=null;if("generate"===this.buildStage){const r=this.flowChildNode(t,s);null!==i&&(r.code+=`${this.tab+i} = ${r.result};\n`),this.flowCode[e]=this.flowCode[e]+r.code,h=r}else h=t.build(this);return this.setShaderStage(a),this.cache=n,this.tab=r,this.context=o,h}getAttributesArray(){return this.attributes.concat(this.bufferAttributes)}getAttributes(){console.warn("Abstract function.")}getVaryings(){console.warn("Abstract function.")}getVar(e,t,s=null){return`${null!==s?this.generateArrayDeclaration(e,s):this.getType(e)} ${t}`}getVars(e){let t="";const s=this.vars[e];if(void 0!==s)for(const e of s)t+=`${this.getVar(e.type,e.name)}; `;return t}getUniforms(){console.warn("Abstract function.")}getCodes(e){const t=this.codes[e];let s="";if(void 0!==t)for(const e of t)s+=e.code+"\n";return s}getHash(){return this.vertexShader+this.fragmentShader+this.computeShader}setShaderStage(e){this.shaderStage=e}getShaderStage(){return this.shaderStage}setBuildStage(e){this.buildStage=e}getBuildStage(){return this.buildStage}buildCode(){console.warn("Abstract function.")}get subBuild(){return this.subBuildLayers[this.subBuildLayers.length-1]||null}addSubBuild(e){this.subBuildLayers.push(e)}removeSubBuild(){return this.subBuildLayers.pop()}getClosestSubBuild(e){let t;if(t=e&&e.isNode?e.isShaderCallNodeInternal?e.shaderNode.subBuilds:e.isStackNode?[e.subBuild]:this.getDataFromNode(e,"any").subBuilds:e instanceof Set?[...e]:e,!t)return null;const s=this.subBuildLayers;for(let e=t.length-1;e>=0;e--){const i=t[e];if(s.includes(i))return i}return null}getSubBuildOutput(e){return this.getSubBuildProperty("outputNode",e)}getSubBuildProperty(e="",t=null){let s,i;return s=null!==t?this.getClosestSubBuild(t):this.subBuildFn,i=s?e?s+"_"+e:s:e,i}build(){const{object:e,material:t,renderer:s}=this;if(null!==t){let e=s.library.fromMaterial(t);null===e&&(console.error(`NodeMaterial: Material "${t.type}" is not compatible.`),e=new yp),e.build(this)}else this.addFlow("compute",e);for(const e of zs2){this.setBuildStage(e),this.context.vertex&&this.context.vertex.isNode&&this.flowNodeFromShaderStage("vertex",this.context.vertex);for(const t of Hs2){this.setShaderStage(t);const s=this.flowNodes[t];for(const t of s)"generate"===e?this.flowNode(t):t.build(this)}}return this.setBuildStage(null),this.setShaderStage(null),this.buildCode(),this.buildUpdateNodes(),this}getNodeUniform(e,t){if("float"===t||"int"===t||"uint"===t)return new H_(e);if("vec2"===t||"ivec2"===t||"uvec2"===t)return new $_(e);if("vec3"===t||"ivec3"===t||"uvec3"===t)return new W_(e);if("vec4"===t||"ivec4"===t||"uvec4"===t)return new q_(e);if("color"===t)return new j_(e);if("mat2"===t)return new X_(e);if("mat3"===t)return new K_(e);if("mat4"===t)return new Y_(e);throw new Error(`Uniform "${t}" not declared.`)}format(e,t,s){if((t=this.getVectorType(t))===(s=this.getVectorType(s))||null===s||this.isReference(s))return e;const i=this.getTypeLength(t),r=this.getTypeLength(s);return 16===i&&9===r?`${this.getType(s)}( ${e}[ 0 ].xyz, ${e}[ 1 ].xyz, ${e}[ 2 ].xyz )`:9===i&&4===r?`${this.getType(s)}( ${e}[ 0 ].xy, ${e}[ 1 ].xy )`:i>4||r>4||0===r?e:i===r?`${this.getType(s)}( ${e} )`:i>r?(e="bool"===s?`all( ${e} )`:`${e}.${"xyz".slice(0,r)}`,this.format(e,this.getTypeFromLength(r,this.getComponentType(t)),s)):4===r&&i>1?`${this.getType(s)}( ${this.format(e,t,"vec3")}, 1.0 )`:2===i?`${this.getType(s)}( ${this.format(e,t,"vec2")}, 0.0 )`:(1===i&&r>1&&t!==this.getComponentType(s)&&(e=`${this.getType(this.getComponentType(s))}( ${e} )`),`${this.getType(s)}( ${e} )`)}getSignature(){return`// Three.js r${t} - Node System\n`}*[Symbol.iterator](){}},tv=class{constructor(){this.time=0,this.deltaTime=0,this.frameId=0,this.renderId=0,this.updateMap=new WeakMap,this.updateBeforeMap=new WeakMap,this.updateAfterMap=new WeakMap,this.renderer=null,this.material=null,this.camera=null,this.object=null,this.scene=null}_getMaps(e,t){let s=e.get(t);return void 0===s&&(s={renderMap:new WeakMap,frameMap:new WeakMap},e.set(t,s)),s}updateBeforeNode(e){const t=e.getUpdateBeforeType(),s=e.updateReference(this);if(t===Us2.FRAME){const{frameMap:t}=this._getMaps(this.updateBeforeMap,s);t.get(s)!==this.frameId&&!1!==e.updateBefore(this)&&t.set(s,this.frameId)}else if(t===Us2.RENDER){const{renderMap:t}=this._getMaps(this.updateBeforeMap,s);t.get(s)!==this.renderId&&!1!==e.updateBefore(this)&&t.set(s,this.renderId)}else t===Us2.OBJECT&&e.updateBefore(this)}updateAfterNode(e){const t=e.getUpdateAfterType(),s=e.updateReference(this);if(t===Us2.FRAME){const{frameMap:t}=this._getMaps(this.updateAfterMap,s);t.get(s)!==this.frameId&&!1!==e.updateAfter(this)&&t.set(s,this.frameId)}else if(t===Us2.RENDER){const{renderMap:t}=this._getMaps(this.updateAfterMap,s);t.get(s)!==this.renderId&&!1!==e.updateAfter(this)&&t.set(s,this.renderId)}else t===Us2.OBJECT&&e.updateAfter(this)}updateNode(e){const t=e.getUpdateType(),s=e.updateReference(this);if(t===Us2.FRAME){const{frameMap:t}=this._getMaps(this.updateMap,s);t.get(s)!==this.frameId&&!1!==e.update(this)&&t.set(s,this.frameId)}else if(t===Us2.RENDER){const{renderMap:t}=this._getMaps(this.updateMap,s);t.get(s)!==this.renderId&&!1!==e.update(this)&&t.set(s,this.renderId)}else t===Us2.OBJECT&&e.update(this)}update(){this.frameId++,void 0===this.lastTime&&(this.lastTime=performance.now()),this.deltaTime=(performance.now()-this.lastTime)/1e3,this.lastTime=performance.now(),this.time+=this.deltaTime}},rv=class{constructor(e,t,s=null,i="",r=!1){this.type=e,this.name=t,this.count=s,this.qualifier=i,this.isConst=r}};rv.isNodeFunctionInput=!0;var sv=class extends TT{static get type(){return"DirectionalLightNode"}constructor(e=null){super(e)}setupDirect(){const e=this.colorNode;return{lightDirection:Px(this.light),lightColor:e}}},iv=new nr,nv=new nr,av=null,ov=class extends TT{static get type(){return"RectAreaLightNode"}constructor(e=null){super(e),this.halfHeight=ta2(new Qi).setGroup(Zn2),this.halfWidth=ta2(new Qi).setGroup(Zn2),this.updateType=Us2.RENDER}update(e){super.update(e);const{light:t}=this,s=e.camera.matrixWorldInverse;nv.identity(),iv.copy(t.matrixWorld),iv.premultiply(s),nv.extractRotation(iv),this.halfWidth.value.set(.5*t.width,0,0),this.halfHeight.value.set(0,.5*t.height,0),this.halfWidth.value.applyMatrix4(nv),this.halfHeight.value.applyMatrix4(nv)}setupDirectRectArea(e){let t,s;e.isAvailable("float32Filterable")?(t=al2(av.LTC_FLOAT_1),s=al2(av.LTC_FLOAT_2)):(t=al2(av.LTC_HALF_1),s=al2(av.LTC_HALF_2));const{colorNode:i,light:r}=this;return{lightColor:i,lightPosition:Mx(r),halfWidth:this.halfWidth,halfHeight:this.halfHeight,ltc_1:t,ltc_2:s}}static setLTC(e){av=e}},uv=class extends TT{static get type(){return"SpotLightNode"}constructor(e=null){super(e),this.coneCosNode=ta2(0).setGroup(Zn2),this.penumbraCosNode=ta2(0).setGroup(Zn2),this.cutoffDistanceNode=ta2(0).setGroup(Zn2),this.decayExponentNode=ta2(0).setGroup(Zn2),this.colorNode=ta2(this.color).setGroup(Zn2)}update(e){super.update(e);const{light:t}=this;this.coneCosNode.value=Math.cos(t.angle),this.penumbraCosNode.value=Math.cos(t.angle*(1-t.penumbra)),this.cutoffDistanceNode.value=t.distance,this.decayExponentNode.value=t.decay}getSpotAttenuation(e,t){const{coneCosNode:s,penumbraCosNode:i}=this;return Ho2(s,i,t)}getLightCoord(e){const t=e.getNodeProperties(this);let s=t.projectionUV;return void 0===s&&(s=Ax(this.light,e.context.positionWorld),t.projectionUV=s),s}setupDirect(e){const{colorNode:t,cutoffDistanceNode:s,decayExponentNode:i,light:r}=this,n=this.getLightVector(e),a=n.normalize(),o=a.dot(Px(r)),l=this.getSpotAttenuation(e,o),h=n.length(),u=_T({lightDistance:h,cutoffDistance:s,decayExponent:i});let c,d,p=t.mul(l).mul(u);return r.colorNode?(d=this.getLightCoord(e),c=r.colorNode(d)):r.map&&(d=this.getLightCoord(e),c=al2(r.map,d.xy).onRenderUpdate(()=>r.map)),c&&(p=d.mul(2).sub(1).abs().lessThan(1).all().select(p.mul(c),p)),{lightColor:p,lightDirection:a}}},lv=class extends uv{static get type(){return"IESSpotLightNode"}getSpotAttenuation(e,t){const s=this.light.iesMap;let i=null;if(s&&!0===s.isTexture){const e=t.acos().mul(1/Math.PI);i=al2(s,Ji2(e,0),0).r}else i=super.getSpotAttenuation(t);return i}},dv=Hi2(([e,t])=>{const s=e.abs().sub(t);return lo2(Eo2(s,0)).add(So2(Eo2(s.x,s.y),0))}),cv=class extends uv{static get type(){return"ProjectorLightNode"}update(e){super.update(e);const t=this.light;if(this.penumbraCosNode.value=Math.min(Math.cos(t.angle*(1-t.penumbra)),.99999),null===t.aspect){let e=1;null!==t.map&&(e=t.map.width/t.map.height),t.shadow.aspect=e}else t.shadow.aspect=t.aspect}getSpotAttenuation(e){const t=Ki2(0),s=this.penumbraCosNode,i=wx(this.light).mul(e.context.positionWorld||jl2);return qi2(i.w.greaterThan(0),()=>{const e=i.xyz.div(i.w),r=dv(e.xy.sub(Ji2(.5)),Ji2(.5)),n=pa(-1,ca2(1,no2(s)).sub(1));t.assign(Go2(r.mul(-2).mul(n)))}),t}},hv=class extends TT{static get type(){return"AmbientLightNode"}constructor(e=null){super(e)}setup({context:e}){e.irradiance.addAssign(this.colorNode)}},pv=class extends TT{static get type(){return"HemisphereLightNode"}constructor(e=null){super(e),this.lightPositionNode=Rx(e),this.lightDirectionNode=this.lightPositionNode.normalize(),this.groundColorNode=ta2(new $r).setGroup(Zn2)}update(e){const{light:t}=this;super.update(e),this.lightPositionNode.object3d=t,this.groundColorNode.value.copy(t.groundColor).multiplyScalar(t.intensity)}setup(e){const{colorNode:t,groundColorNode:s,lightDirectionNode:i}=this,r=od2.dot(i).mul(.5).add(.5),n=Oo2(s,t,r);e.context.irradiance.addAssign(n)}},gv=class extends TT{static get type(){return"LightProbeNode"}constructor(e=null){super(e);const t=[];for(let e=0;e<9;e++)t.push(new Qi);this.lightProbe=hl2(t)}update(e){const{light:t}=this;super.update(e);for(let e=0;e<9;e++)this.lightProbe.array[e].copy(t.sh.coefficients[e]).multiplyScalar(t.intensity)}setup(e){const t=x_(od2,this.lightProbe);e.context.irradiance.addAssign(t)}},mv=class{parseFunction(){console.warn("Abstract function.")}},fv=class{constructor(e,t,s="",i=""){this.type=e,this.inputs=t,this.name=s,this.precision=i}getCode(){console.warn("Abstract function.")}};fv.isNodeFunction=!0;var yv=/^\s*(highp|mediump|lowp)?\s*([a-z_0-9]+)\s*([a-z_0-9]+)?\s*\(([\s\S]*?)\)/i,bv=/[a-z_0-9]+/gi,xv="#pragma main",Tv=class extends fv{constructor(e){const{type:t,inputs:s,name:i,precision:r,inputsCode:n,blockCode:a,headerCode:o}=(e=>{const t=(e=e.trim()).indexOf(xv),s=-1!==t?e.slice(t+12):e,i=s.match(yv);if(null!==i&&5===i.length){const r=i[4],n=[];let a=null;for(;null!==(a=bv.exec(r));)n.push(a);const o=[];let l=0;for(;l<n.length;){const e="const"===n[l][0];!0===e&&l++;let t=n[l][0];"in"===t||"out"===t||"inout"===t?l++:t="";const s=n[l++][0];let i=Number.parseInt(n[l][0]);!1===Number.isNaN(i)?l++:i=null;const r=n[l++][0];o.push(new rv(s,r,i,t,e))}const h=s.substring(i[0].length),u=void 0!==i[3]?i[3]:"";return{type:i[2],inputs:o,name:u,precision:void 0!==i[1]?i[1]:"",inputsCode:r,blockCode:h,headerCode:-1!==t?e.slice(0,t):""}}throw new Error("FunctionNode: Function is not a GLSL code.")})(e);super(t,s,i,r),this.inputsCode=n,this.blockCode=a,this.headerCode=o}getCode(e=this.name){let t;const s=this.blockCode;if(""!==s){const{type:i,inputsCode:r,headerCode:n,precision:a}=this;let o=`${i} ${e} ( ${r.trim()} )`;""!==a&&(o=`${a} ${o}`),t=n+o+s}else t="";return t}},_v=class extends mv{parseFunction(e){return new Tv(e)}},vv=new WeakMap,Nv=[],Sv=[],Ev=class extends xf{constructor(e,t){super(),this.renderer=e,this.backend=t,this.nodeFrame=new tv,this.nodeBuilderCache=new Map,this.callHashCache=new gf,this.groupsData=new gf,this.cacheLib={}}updateGroup(e){const t=e.groupNode,s=t.name;if(s===Jn.name)return!0;if(s===Zn2.name){const t=this.get(e),s=this.nodeFrame.renderId;return t.renderId!==s&&(t.renderId=s,!0)}if(s===Qn2.name){const t=this.get(e),s=this.nodeFrame.frameId;return t.frameId!==s&&(t.frameId=s,!0)}Nv[0]=t,Nv[1]=e;let i=this.groupsData.get(Nv);return void 0===i&&this.groupsData.set(Nv,i={}),Nv.length=0,i.version!==t.version&&(i.version=t.version,!0)}getForRenderCacheKey(e){return e.initialCacheKey}getForRender(e){const t=this.get(e);let s=t.nodeBuilderState;if(void 0===s){const{nodeBuilderCache:i}=this,r=this.getForRenderCacheKey(e);if(s=i.get(r),void 0===s){const t=this.backend.createNodeBuilder(e.object,this.renderer);t.scene=e.scene,t.material=e.material,t.camera=e.camera,t.context.material=e.material,t.lightsNode=e.lightsNode,t.environmentNode=this.getEnvironmentNode(e.scene),t.fogNode=this.getFogNode(e.scene),t.clippingContext=e.clippingContext,this.renderer.getOutputRenderTarget()&&this.renderer.getOutputRenderTarget().multiview&&t.enableMultiview(),t.build(),s=this._createNodeBuilderState(t),i.set(r,s)}s.usedTimes++,t.nodeBuilderState=s}return s}delete(e){if(e.isRenderObject){const t=this.get(e).nodeBuilderState;t.usedTimes--,0===t.usedTimes&&this.nodeBuilderCache.delete(this.getForRenderCacheKey(e))}return super.delete(e)}getForCompute(e){const t=this.get(e);let s=t.nodeBuilderState;if(void 0===s){const i=this.backend.createNodeBuilder(e,this.renderer);i.build(),s=this._createNodeBuilderState(i),t.nodeBuilderState=s}return s}_createNodeBuilderState(e){return new E_(e.vertexShader,e.fragmentShader,e.computeShader,e.getAttributesArray(),e.getBindings(),e.updateNodes,e.updateBeforeNodes,e.updateAfterNodes,e.observer,e.transforms)}getEnvironmentNode(e){this.updateEnvironment(e);let t=null;if(e.environmentNode&&e.environmentNode.isNode)t=e.environmentNode;else{const s=this.get(e);s.environmentNode&&(t=s.environmentNode)}return t}getBackgroundNode(e){this.updateBackground(e);let t=null;if(e.backgroundNode&&e.backgroundNode.isNode)t=e.backgroundNode;else{const s=this.get(e);s.backgroundNode&&(t=s.backgroundNode)}return t}getFogNode(e){return this.updateFog(e),e.fogNode||this.get(e).fogNode||null}getCacheKey(e,t){Nv[0]=e,Nv[1]=t;const s=this.renderer.info.calls,i=this.callHashCache.get(Nv)||{};if(i.callId!==s){const r=this.getEnvironmentNode(e),n=this.getFogNode(e);t&&Sv.push(t.getCacheKey(!0)),r&&Sv.push(r.getCacheKey()),n&&Sv.push(n.getCacheKey()),Sv.push(this.renderer.getOutputRenderTarget()&&this.renderer.getOutputRenderTarget().multiview?1:0),Sv.push(this.renderer.shadowMap.enabled?1:0),i.callId=s,i.cacheKey=Ts2(Sv),this.callHashCache.set(Nv,i),Sv.length=0}return Nv.length=0,i.cacheKey}get isToneMappingState(){return!this.renderer.getRenderTarget()}updateBackground(e){const t=this.get(e),s=e.background;if(s){const i=0===e.backgroundBlurriness&&t.backgroundBlurriness>0||e.backgroundBlurriness>0&&0===t.backgroundBlurriness;if(t.background!==s||i){const r=this.getCacheNode("background",s,()=>{if(!0===s.isCubeTexture||s.mapping===ct||s.mapping===ut||s.mapping===dt){if(e.backgroundBlurriness>0||s.mapping===dt)return Fm(s);{let e;return e=!0===s.isCubeTexture?wd2(s):al2(s),Dp(e)}}if(!0===s.isTexture)return al2(s,Fh2.flipY()).setUpdateMatrix(!0);!0!==s.isColor&&console.error("WebGPUNodes: Unsupported background configuration.",s)},i);t.backgroundNode=r,t.background=s,t.backgroundBlurriness=e.backgroundBlurriness}}else t.backgroundNode&&(delete t.backgroundNode,delete t.background)}getCacheNode(e,t,s,i=!1){const r=this.cacheLib[e]||(this.cacheLib[e]=new WeakMap);let n=r.get(t);return(void 0===n||i)&&(n=s(),r.set(t,n)),n}updateFog(e){const t=this.get(e),s=e.fog;if(s){if(t.fog!==s){const e=this.getCacheNode("fog",s,()=>{if(s.isFogExp2){const e=Cd2("color","color",s).setGroup(Zn2),t=Cd2("density","float",s).setGroup(Zn2);return ax(e,nx(t))}if(s.isFog){const e=Cd2("color","color",s).setGroup(Zn2),t=Cd2("near","float",s).setGroup(Zn2),i=Cd2("far","float",s).setGroup(Zn2);return ax(e,ix(t,i))}console.error("THREE.Renderer: Unsupported fog configuration.",s)});t.fogNode=e,t.fog=s}}else delete t.fogNode,delete t.fog}updateEnvironment(e){const t=this.get(e),s=e.environment;if(s){if(t.environment!==s){const e=this.getCacheNode("environment",s,()=>!0===s.isCubeTexture?wd2(s):!0===s.isTexture?al2(s):void console.error("Nodes: Unsupported environment configuration.",s));t.environmentNode=e,t.environment=s}}else t.environmentNode&&(delete t.environmentNode,delete t.environment)}getNodeFrame(e=this.renderer,t=null,s=null,i=null,r=null){const n=this.nodeFrame;return n.renderer=e,n.scene=t,n.object=s,n.camera=i,n.material=r,n}getNodeFrameForRender(e){return this.getNodeFrame(e.renderer,e.scene,e.object,e.camera,e.material)}getOutputCacheKey(){const e=this.renderer;return e.toneMapping+","+e.currentColorSpace+","+e.xr.isPresenting}hasOutputChange(e){return vv.get(e)!==this.getOutputCacheKey()}getOutputNode(e){const t=this.renderer,s=this.getOutputCacheKey(),i=e.isArrayTexture?fb(e,sn2(Fh2,pl2("gl_ViewID_OVR"))).renderOutput(t.toneMapping,t.currentColorSpace):al2(e,Fh2).renderOutput(t.toneMapping,t.currentColorSpace);return vv.set(e,s),i}updateBefore(e){const t=e.getNodeBuilderState();for(const s of t.updateBeforeNodes)this.getNodeFrameForRender(e).updateBeforeNode(s)}updateAfter(e){const t=e.getNodeBuilderState();for(const s of t.updateAfterNodes)this.getNodeFrameForRender(e).updateAfterNode(s)}updateForCompute(e){const t=this.getNodeFrame(),s=this.getForCompute(e);for(const e of s.updateNodes)t.updateNode(e)}updateForRender(e){const t=this.getNodeFrameForRender(e),s=e.getNodeBuilderState();for(const e of s.updateNodes)t.updateNode(e)}needsRefresh(e){const t=this.getNodeFrameForRender(e);return e.getMonitor().needsRefresh(e,t)}dispose(){super.dispose(),this.nodeFrame=new tv,this.nodeBuilderCache=new Map,this.cacheLib={}}},wv=new ro,Av=class e{constructor(e=null){this.version=0,this.clipIntersection=null,this.cacheKey="",this.shadowPass=!1,this.viewNormalMatrix=new es,this.clippingGroupContexts=new WeakMap,this.intersectionPlanes=[],this.unionPlanes=[],this.parentVersion=null,null!==e&&(this.viewNormalMatrix=e.viewNormalMatrix,this.clippingGroupContexts=e.clippingGroupContexts,this.shadowPass=e.shadowPass,this.viewMatrix=e.viewMatrix)}projectPlanes(e,t,s){const i=e.length;for(let r=0;r<i;r++){wv.copy(e[r]).applyMatrix4(this.viewMatrix,this.viewNormalMatrix);const i=t[s+r],n=wv.normal;i.x=-n.x,i.y=-n.y,i.z=-n.z,i.w=wv.constant}}updateGlobal(e,t){this.shadowPass=null!==e.overrideMaterial&&e.overrideMaterial.isShadowPassMaterial,this.viewMatrix=t.matrixWorldInverse,this.viewNormalMatrix.getNormalMatrix(this.viewMatrix)}update(e,t){let s=!1;e.version!==this.parentVersion&&(this.intersectionPlanes=Array.from(e.intersectionPlanes),this.unionPlanes=Array.from(e.unionPlanes),this.parentVersion=e.version),this.clipIntersection!==t.clipIntersection&&(this.clipIntersection=t.clipIntersection,this.clipIntersection?this.unionPlanes.length=e.unionPlanes.length:this.intersectionPlanes.length=e.intersectionPlanes.length);const i=t.clippingPlanes,r=i.length;let n,a;if(this.clipIntersection?(n=this.intersectionPlanes,a=e.intersectionPlanes.length):(n=this.unionPlanes,a=e.unionPlanes.length),n.length!==a+r){n.length=a+r;for(let e=0;e<r;e++)n[a+e]=new As;s=!0}this.projectPlanes(i,n,a),s&&(this.version++,this.cacheKey=`${this.intersectionPlanes.length}:${this.unionPlanes.length}`)}getGroupContext(t){if(this.shadowPass&&!t.clipShadows)return this;let s=this.clippingGroupContexts.get(t);return void 0===s&&(s=new e(this),this.clippingGroupContexts.set(t,s)),s.update(this,t),s}get unionClippingCount(){return this.unionPlanes.length}},Rv=class{constructor(e,t){this.bundleGroup=e,this.camera=t}},Cv=[],Mv=class{constructor(){this.bundles=new gf}get(e,t){const s=this.bundles;Cv[0]=e,Cv[1]=t;let i=s.get(Cv);return void 0===i&&(i=new Rv(e,t),s.set(Cv,i)),Cv.length=0,i}dispose(){this.bundles=new gf}},Pv=class{constructor(){this.lightNodes=new WeakMap,this.materialNodes=new Map,this.toneMappingNodes=new Map}fromMaterial(e){if(e.isNodeMaterial)return e;let t=null;const s=this.getMaterialNodeClass(e.type);if(null!==s){t=new s;for(const s in e)t[s]=e[s]}return t}addToneMapping(e,t){this.addType(e,t,this.toneMappingNodes)}getToneMappingFunction(e){return this.toneMappingNodes.get(e)||null}getMaterialNodeClass(e){return this.materialNodes.get(e)||null}addMaterial(e,t){this.addType(e,t,this.materialNodes)}getLightNodeClass(e){return this.lightNodes.get(e)||null}addLight(e,t){this.addClass(e,t,this.lightNodes)}addType(e,t,s){if(s.has(t))console.warn(`Redefinition of node ${t}`);else{if("function"!=typeof e)throw new Error(`Node class ${e.name} is not a class.`);if("function"==typeof t||"object"==typeof t)throw new Error(`Base class ${t} is not a class.`);s.set(t,e)}}addClass(e,t,s){if(s.has(t))console.warn(`Redefinition of node ${t.name}`);else{if("function"!=typeof e)throw new Error(`Node class ${e.name} is not a class.`);if("function"!=typeof t)throw new Error(`Base class ${t.name} is not a class.`);s.set(t,e)}}},Bv=new Ix,Lv=[],Fv=class extends gf{constructor(){super()}createNode(e=[]){return(new Ix).setLights(e)}getNode(e,t){if(e.isQuadMesh)return Bv;Lv[0]=e,Lv[1]=t;let s=this.get(Lv);return void 0===s&&(s=this.createNode(),this.set(Lv,s)),Lv.length=0,s}},Iv=class extends Ts{constructor(e=1,t=1,s={}){super(e,t,s),this.isXRRenderTarget=!0,this._hasExternalTextures=!1,this._autoAllocateDepthBuffer=!0,this._isOpaqueFramebuffer=!1}copy(e){return super.copy(e),this._hasExternalTextures=e._hasExternalTextures,this._autoAllocateDepthBuffer=e._autoAllocateDepthBuffer,this._isOpaqueFramebuffer=e._isOpaqueFramebuffer,this}},Dv=new Qi,Vv=new Qi,Uv=class extends Fi{constructor(e,t=!1){super(),this.enabled=!1,this.isPresenting=!1,this.cameraAutoUpdate=!0,this._renderer=e,this._cameraL=new Qn,this._cameraL.viewport=new As,this._cameraR=new Qn,this._cameraR.viewport=new As,this._cameras=[this._cameraL,this._cameraR],this._cameraXR=new hu,this._currentDepthNear=null,this._currentDepthFar=null,this._controllers=[],this._controllerInputSources=[],this._xrRenderTarget=null,this._layers=[],this._supportsLayers=!1,this._supportsGlBinding="undefined"!=typeof XRWebGLBinding,this._frameBufferTargets=null,this._createXRLayer=Hv.bind(this),this._gl=null,this._currentAnimationContext=null,this._currentAnimationLoop=null,this._currentPixelRatio=null,this._currentSize=new Gi,this._onSessionEvent=kv.bind(this),this._onSessionEnd=Gv.bind(this),this._onInputSourcesChange=zv.bind(this),this._onAnimationFrame=$v.bind(this),this._referenceSpace=null,this._referenceSpaceType="local-floor",this._customReferenceSpace=null,this._framebufferScaleFactor=1,this._foveation=1,this._session=null,this._glBaseLayer=null,this._glBinding=null,this._glProjLayer=null,this._xrFrame=null,this._useLayers=this._supportsGlBinding&&"createProjectionLayer"in XRWebGLBinding.prototype,this._useMultiviewIfPossible=t,this._useMultiview=!1}getController(e){return this._getController(e).getTargetRaySpace()}getControllerGrip(e){return this._getController(e).getGripSpace()}getHand(e){return this._getController(e).getHandSpace()}getFoveation(){if(null!==this._glProjLayer||null!==this._glBaseLayer)return this._foveation}setFoveation(e){this._foveation=e,null!==this._glProjLayer&&(this._glProjLayer.fixedFoveation=e),null!==this._glBaseLayer&&void 0!==this._glBaseLayer.fixedFoveation&&(this._glBaseLayer.fixedFoveation=e)}getFramebufferScaleFactor(){return this._framebufferScaleFactor}setFramebufferScaleFactor(e){this._framebufferScaleFactor=e,!0===this.isPresenting&&console.warn("THREE.XRManager: Cannot change framebuffer scale while presenting.")}getReferenceSpaceType(){return this._referenceSpaceType}setReferenceSpaceType(e){this._referenceSpaceType=e,!0===this.isPresenting&&console.warn("THREE.XRManager: Cannot change reference space type while presenting.")}getReferenceSpace(){return this._customReferenceSpace||this._referenceSpace}setReferenceSpace(e){this._customReferenceSpace=e}getCamera(){return this._cameraXR}getEnvironmentBlendMode(){if(null!==this._session)return this._session.environmentBlendMode}getFrame(){return this._xrFrame}useMultiview(){return this._useMultiview}createQuadLayer(e,t,s,i,r,n,a,o={}){const l=new Ml(e,t),h=new Iv(r,n,{format:jt,type:Tt,depthTexture:new ah(r,n,o.stencil?Nt:kt,void 0,void 0,void 0,void 0,void 0,void 0,o.stencil?Dt:Wt),stencilBuffer:o.stencil,resolveDepthBuffer:!1,resolveStencilBuffer:!1});h._autoAllocateDepthBuffer=!0;const c=new en({color:16777215,side:u});c.map=h.texture,c.map.offset.y=1,c.map.repeat.y=-1;const d=new jn(l,c);d.position.copy(s),d.quaternion.copy(i);const p={type:"quad",width:e,height:t,translation:s,quaternion:i,pixelwidth:r,pixelheight:n,plane:d,material:c,rendercall:a,renderTarget:h};if(this._layers.push(p),null!==this._session){p.plane.material=new en({color:16777215,side:u}),p.plane.material.blending=b,p.plane.material.blendEquation=v,p.plane.material.blendSrc=A,p.plane.material.blendDst=A,p.xrlayer=this._createXRLayer(p);const e=this._session.renderState.layers;e.unshift(p.xrlayer),this._session.updateRenderState({layers:e})}else h.isXRRenderTarget=!1;return d}createCylinderLayer(e,t,s,i,r,n,a,o,l={}){const h=new lh(e,e,e*t/s,64,64,!0,Math.PI-t/2,t),u=new Iv(n,a,{format:jt,type:Tt,depthTexture:new ah(n,a,l.stencil?Nt:kt,void 0,void 0,void 0,void 0,void 0,void 0,l.stencil?Dt:Wt),stencilBuffer:l.stencil,resolveDepthBuffer:!1,resolveStencilBuffer:!1});u._autoAllocateDepthBuffer=!0;const c=new en({color:16777215,side:d2});c.map=u.texture,c.map.offset.y=1,c.map.repeat.y=-1;const d=new jn(h,c);d.position.copy(i),d.quaternion.copy(r);const p={type:"cylinder",radius:e,centralAngle:t,aspectratio:s,translation:i,quaternion:r,pixelwidth:n,pixelheight:a,plane:d,material:c,rendercall:o,renderTarget:u};if(this._layers.push(p),null!==this._session){p.plane.material=new en({color:16777215,side:d2}),p.plane.material.blending=b,p.plane.material.blendEquation=v,p.plane.material.blendSrc=A,p.plane.material.blendDst=A,p.xrlayer=this._createXRLayer(p);const e=this._session.renderState.layers;e.unshift(p.xrlayer),this._session.updateRenderState({layers:e})}else u.isXRRenderTarget=!1;return d}renderLayers(){const e=new Qi,t=new $i,s=this._renderer,i=this.isPresenting,r=s.getOutputRenderTarget(),n=s._frameBufferTarget;this.isPresenting=!1;const a=new Gi;s.getSize(a);const o=s._quad;for(const i of this._layers)if(i.renderTarget.isXRRenderTarget=null!==this._session,i.renderTarget._hasExternalTextures=i.renderTarget.isXRRenderTarget,i.renderTarget.isXRRenderTarget&&this._supportsLayers){i.xrlayer.transform=new XRRigidTransform(i.plane.getWorldPosition(e),i.plane.getWorldQuaternion(t));const r=this._glBinding.getSubImage(i.xrlayer,this._xrFrame);s.backend.setXRRenderTargetTextures(i.renderTarget,r.colorTexture,void 0),s._setXRLayerSize(i.renderTarget.width,i.renderTarget.height),s.setOutputRenderTarget(i.renderTarget),s.setRenderTarget(null),s._frameBufferTarget=null,this._frameBufferTargets||(this._frameBufferTargets=new WeakMap);const{frameBufferTarget:n,quad:a}=this._frameBufferTargets.get(i.renderTarget)||{frameBufferTarget:null,quad:null};n?(s._frameBufferTarget=n,s._quad=a):(s._quad=new qy(new yp),this._frameBufferTargets.set(i.renderTarget,{frameBufferTarget:s._getFrameBufferTarget(),quad:s._quad})),i.rendercall(),s._frameBufferTarget=null}else s.setRenderTarget(i.renderTarget),i.rendercall();s.setRenderTarget(null),s.setOutputRenderTarget(r),s._frameBufferTarget=n,s._setXRLayerSize(a.x,a.y),s._quad=o,this.isPresenting=i}getSession(){return this._session}async setSession(e){const t=this._renderer,s=t.backend;this._gl=t.getContext();const i=this._gl,r=i.getContextAttributes();if(this._session=e,null!==e){if(!0===s.isWebGPUBackend)throw new Error('THREE.XRManager: XR is currently not supported with a WebGPU backend. Use WebGL by passing "{ forceWebGL: true }" to the constructor of the renderer.');if(e.addEventListener("select",this._onSessionEvent),e.addEventListener("selectstart",this._onSessionEvent),e.addEventListener("selectend",this._onSessionEvent),e.addEventListener("squeeze",this._onSessionEvent),e.addEventListener("squeezestart",this._onSessionEvent),e.addEventListener("squeezeend",this._onSessionEvent),e.addEventListener("end",this._onSessionEnd),e.addEventListener("inputsourceschange",this._onInputSourcesChange),await s.makeXRCompatible(),this._currentPixelRatio=t.getPixelRatio(),t.getSize(this._currentSize),this._currentAnimationContext=t._animation.getContext(),this._currentAnimationLoop=t._animation.getAnimationLoop(),t._animation.stop(),this._supportsGlBinding){const t=new XRWebGLBinding(e,i);this._glBinding=t}if(!0===this._useLayers){let s=null,n=null,a=null;t.depth&&(a=t.stencil?i.DEPTH24_STENCIL8:i.DEPTH_COMPONENT24,s=t.stencil?Dt:Wt,n=t.stencil?Nt:kt);const o={colorFormat:i.RGBA8,depthFormat:a,scaleFactor:this._framebufferScaleFactor,clearOnAccess:!1};this._useMultiviewIfPossible&&t.hasFeature("OVR_multiview2")&&(o.textureType="texture-array",this._useMultiview=!0);const l=this._glBinding.createProjectionLayer(o),h=[l];this._glProjLayer=l,t.setPixelRatio(1),t._setXRLayerSize(l.textureWidth,l.textureHeight);const c=this._useMultiview?2:1,d=new ah(l.textureWidth,l.textureHeight,n,void 0,void 0,void 0,void 0,void 0,void 0,s,c);if(this._xrRenderTarget=new Iv(l.textureWidth,l.textureHeight,{format:jt,type:Tt,colorSpace:t.outputColorSpace,depthTexture:d,stencilBuffer:t.stencil,samples:r.antialias?4:0,resolveDepthBuffer:!1===l.ignoreDepthValues,resolveStencilBuffer:!1===l.ignoreDepthValues,depth:this._useMultiview?2:1,multiview:this._useMultiview}),this._xrRenderTarget._hasExternalTextures=!0,this._xrRenderTarget.depth=this._useMultiview?2:1,this._supportsLayers=e.enabledFeatures.includes("layers"),this._referenceSpace=await e.requestReferenceSpace(this.getReferenceSpaceType()),this._supportsLayers)for(const e of this._layers)e.plane.material=new en({color:16777215,side:"cylinder"===e.type?d2:u}),e.plane.material.blending=b,e.plane.material.blendEquation=v,e.plane.material.blendSrc=A,e.plane.material.blendDst=A,e.xrlayer=this._createXRLayer(e),h.unshift(e.xrlayer);e.updateRenderState({layers:h})}else{const s={antialias:t.samples>0,alpha:!0,depth:t.depth,stencil:t.stencil,framebufferScaleFactor:this.getFramebufferScaleFactor()},r=new XRWebGLLayer(e,i,s);this._glBaseLayer=r,e.updateRenderState({baseLayer:r}),t.setPixelRatio(1),t._setXRLayerSize(r.framebufferWidth,r.framebufferHeight),this._xrRenderTarget=new Iv(r.framebufferWidth,r.framebufferHeight,{format:jt,type:Tt,colorSpace:t.outputColorSpace,stencilBuffer:t.stencil,resolveDepthBuffer:!1===r.ignoreDepthValues,resolveStencilBuffer:!1===r.ignoreDepthValues}),this._xrRenderTarget._isOpaqueFramebuffer=!0,this._referenceSpace=await e.requestReferenceSpace(this.getReferenceSpaceType())}this.setFoveation(this.getFoveation()),t._animation.setAnimationLoop(this._onAnimationFrame),t._animation.setContext(e),t._animation.start(),this.isPresenting=!0,this.dispatchEvent({type:"sessionstart"})}}updateCamera(e){const t=this._session;if(null===t)return;const s=e.near,i=e.far,r=this._cameraXR,n=this._cameraL,a=this._cameraR;r.near=a.near=n.near=s,r.far=a.far=n.far=i,r.isMultiViewCamera=this._useMultiview,this._currentDepthNear===r.near&&this._currentDepthFar===r.far||(t.updateRenderState({depthNear:r.near,depthFar:r.far}),this._currentDepthNear=r.near,this._currentDepthFar=r.far),r.layers.mask=6|e.layers.mask,n.layers.mask=3&r.layers.mask,a.layers.mask=5&r.layers.mask;const o=e.parent,l=r.cameras;Ov(r,o);for(let e=0;e<l.length;e++)Ov(l[e],o);var h,u,c;2===l.length?function(e,t,s){Dv.setFromMatrixPosition(t.matrixWorld),Vv.setFromMatrixPosition(s.matrixWorld);const i=Dv.distanceTo(Vv),r=t.projectionMatrix.elements,n=s.projectionMatrix.elements,a=r[14]/(r[10]-1),o=r[14]/(r[10]+1),l=(r[9]+1)/r[5],h=(r[9]-1)/r[5],u=(r[8]-1)/r[0],c=(n[8]+1)/n[0],d=a*u,p=a*c,_=i/(-u+c),m=_*-u;if(t.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(m),e.translateZ(_),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.copy(e.matrixWorld).invert(),-1===r[10])e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse);else{const t=a+_,s=o+_,r=d-m,n=p+(i-m),u=l*o/s*t,c=h*o/s*t;e.projectionMatrix.makePerspective(r,n,u,c,t,s),e.projectionMatrixInverse.copy(e.projectionMatrix).invert()}}(r,n,a):r.projectionMatrix.copy(n.projectionMatrix),h=e,u=r,null===(c=o)?h.matrix.copy(u.matrixWorld):(h.matrix.copy(c.matrixWorld),h.matrix.invert(),h.matrix.multiply(u.matrixWorld)),h.matrix.decompose(h.position,h.quaternion,h.scale),h.updateMatrixWorld(!0),h.projectionMatrix.copy(u.projectionMatrix),h.projectionMatrixInverse.copy(u.projectionMatrixInverse),h.isPerspectiveCamera&&(h.fov=2*Di*Math.atan(1/h.projectionMatrix.elements[5]),h.zoom=1)}_getController(e){let t=this._controllers[e];return void 0===t&&(t=new na,this._controllers[e]=t),t}};function Ov(e,t){null===t?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(t.matrixWorld,e.matrix),e.matrixWorldInverse.copy(e.matrixWorld).invert()}function kv(e){const t=this._controllerInputSources.indexOf(e.inputSource);if(-1===t)return;const s=this._controllers[t];if(void 0!==s){const t=this.getReferenceSpace();s.update(e.inputSource,e.frame,t),s.dispatchEvent({type:e.type,data:e.inputSource})}}function Gv(){const e=this._session,t=this._renderer;e.removeEventListener("select",this._onSessionEvent),e.removeEventListener("selectstart",this._onSessionEvent),e.removeEventListener("selectend",this._onSessionEvent),e.removeEventListener("squeeze",this._onSessionEvent),e.removeEventListener("squeezestart",this._onSessionEvent),e.removeEventListener("squeezeend",this._onSessionEvent),e.removeEventListener("end",this._onSessionEnd),e.removeEventListener("inputsourceschange",this._onInputSourcesChange);for(let e=0;e<this._controllers.length;e++){const t=this._controllerInputSources[e];null!==t&&(this._controllerInputSources[e]=null,this._controllers[e].disconnect(t))}if(this._currentDepthNear=null,this._currentDepthFar=null,t._resetXRState(),this._session=null,this._xrRenderTarget=null,!0===this._supportsLayers)for(const e of this._layers)e.renderTarget=new Iv(e.pixelwidth,e.pixelheight,{format:jt,type:Tt,depthTexture:new ah(e.pixelwidth,e.pixelheight,e.stencilBuffer?Nt:kt,void 0,void 0,void 0,void 0,void 0,void 0,e.stencilBuffer?Dt:Wt),stencilBuffer:e.stencilBuffer,resolveDepthBuffer:!1,resolveStencilBuffer:!1}),e.renderTarget.isXRRenderTarget=!1,e.plane.material=e.material,e.material.map=e.renderTarget.texture,e.material.map.offset.y=1,e.material.map.repeat.y=-1,delete e.xrlayer;this.isPresenting=!1,this._useMultiview=!1,t._animation.stop(),t._animation.setAnimationLoop(this._currentAnimationLoop),t._animation.setContext(this._currentAnimationContext),t._animation.start(),t.setPixelRatio(this._currentPixelRatio),t.setSize(this._currentSize.width,this._currentSize.height,!1),this.dispatchEvent({type:"sessionend"})}function zv(e){const t=this._controllers,s=this._controllerInputSources;for(let i=0;i<e.removed.length;i++){const r=e.removed[i],n=s.indexOf(r);n>=0&&(s[n]=null,t[n].disconnect(r))}for(let i=0;i<e.added.length;i++){const r=e.added[i];let n=s.indexOf(r);if(-1===n){for(let e=0;e<t.length;e++){if(e>=s.length){s.push(r),n=e;break}if(null===s[e]){s[e]=r,n=e;break}}if(-1===n)break}const a=t[n];a&&a.connect(r)}}function Hv(e){return"quad"===e.type?this._glBinding.createQuadLayer({transform:new XRRigidTransform(e.translation,e.quaternion),width:e.width/2,height:e.height/2,space:this._referenceSpace,viewPixelWidth:e.pixelwidth,viewPixelHeight:e.pixelheight,clearOnAccess:!1}):this._glBinding.createCylinderLayer({transform:new XRRigidTransform(e.translation,e.quaternion),radius:e.radius,centralAngle:e.centralAngle,aspectRatio:e.aspectRatio,space:this._referenceSpace,viewPixelWidth:e.pixelwidth,viewPixelHeight:e.pixelheight,clearOnAccess:!1})}function $v(e,t){if(void 0===t)return;const s=this._cameraXR,i=this._renderer,r=i.backend,n=this._glBaseLayer,a=this.getReferenceSpace(),o=t.getViewerPose(a);if(this._xrFrame=t,null!==o){const e=o.views;null!==this._glBaseLayer&&r.setXRTarget(n.framebuffer);let t=!1;e.length!==s.cameras.length&&(s.cameras.length=0,t=!0);for(let i=0;i<e.length;i++){const a=e[i];let o;if(!0===this._useLayers){const e=this._glBinding.getViewSubImage(this._glProjLayer,a);o=e.viewport,0===i&&r.setXRRenderTargetTextures(this._xrRenderTarget,e.colorTexture,this._glProjLayer.ignoreDepthValues&&!this._useMultiview?void 0:e.depthStencilTexture)}else o=n.getViewport(a);let l=this._cameras[i];void 0===l&&(l=new Qn,l.layers.enable(i),l.viewport=new As,this._cameras[i]=l),l.matrix.fromArray(a.transform.matrix),l.matrix.decompose(l.position,l.quaternion,l.scale),l.projectionMatrix.fromArray(a.projectionMatrix),l.projectionMatrixInverse.copy(l.projectionMatrix).invert(),l.viewport.set(o.x,o.y,o.width,o.height),0===i&&(s.matrix.copy(l.matrix),s.matrix.decompose(s.position,s.quaternion,s.scale)),!0===t&&s.cameras.push(l)}i.setOutputRenderTarget(this._xrRenderTarget)}for(let e=0;e<this._controllers.length;e++){const s=this._controllerInputSources[e],i=this._controllers[e];null!==s&&void 0!==i&&i.update(s,t,a)}this._currentAnimationLoop&&this._currentAnimationLoop(e,t),t.detectedPlanes&&this.dispatchEvent({type:"planesdetected",data:t}),this._xrFrame=null}var Wv=new ha,qv=new Gi,jv=new As,Xv=new ho,Kv=new uo,Yv=new nr,Qv=new As,Zv=class{constructor(e,t={}){this.isRenderer=!0;const{logarithmicDepthBuffer:s=!1,alpha:i=!0,depth:r=!0,stencil:n=!1,antialias:a=!1,samples:o=0,getFallback:l=null,colorBufferType:u=Rt,multiview:c=!1}=t;this.domElement=e.getDomElement(),this.backend=e,this.samples=o||!0===a?4:0,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.alpha=i,this.logarithmicDepthBuffer=s,this.outputColorSpace=Ye,this.toneMapping=$,this.toneMappingExposure=1,this.sortObjects=!0,this.depth=r,this.stencil=n,this.info=new Cf,this.overrideNodes={modelViewMatrix:null,modelNormalViewMatrix:null},this.library=new Pv,this.lighting=new Fv,this._getFallback=l,this._pixelRatio=1,this._width=this.domElement.width,this._height=this.domElement.height,this._viewport=new As(0,0,this._width,this._height),this._scissor=new As(0,0,this._width,this._height),this._scissorTest=!1,this._attributes=null,this._geometries=null,this._nodes=null,this._animation=null,this._bindings=null,this._objects=null,this._pipelines=null,this._bundles=null,this._renderLists=null,this._renderContexts=null,this._textures=null,this._background=null,this._quad=new qy(new yp),this._quad.material.name="Renderer_output",this._currentRenderContext=null,this._opaqueSort=null,this._transparentSort=null,this._frameBufferTarget=null;const d=!0===this.alpha?0:1;this._clearColor=new Zf(0,0,0,d),this._clearDepth=1,this._clearStencil=0,this._renderTarget=null,this._activeCubeFace=0,this._activeMipmapLevel=0,this._outputRenderTarget=null,this._mrt=null,this._renderObjectFunction=null,this._currentRenderObjectFunction=null,this._currentRenderBundle=null,this._handleObjectFunction=this._renderObjectDirect,this._isDeviceLost=!1,this.onDeviceLost=this._onDeviceLost,this._colorBufferType=u,this._initialized=!1,this._initPromise=null,this._compilationPromises=null,this.transparent=!0,this.opaque=!0,this.shadowMap={enabled:!1,type:h},this.xr=new Uv(this,c),this.debug={checkShaderErrors:!0,onShaderError:null,getShaderAsync:async(e,t,s)=>{await this.compileAsync(e,t);const i=this._renderLists.get(e,t),r=this._renderContexts.get(e,t,this._renderTarget),n=e.overrideMaterial||s.material,a=this._objects.get(s,n,e,t,i.lightsNode,r,r.clippingContext),{fragmentShader:o,vertexShader:l}=a.getNodeBuilderState();return{fragmentShader:o,vertexShader:l}}}}async init(){if(this._initialized)throw new Error("Renderer: Backend has already been initialized.");return null!==this._initPromise||(this._initPromise=new Promise(async(e,t)=>{let s=this.backend;try{await s.init(this)}catch(e){if(null===this._getFallback)return void t(e);try{this.backend=s=this._getFallback(e),await s.init(this)}catch(e){return void t(e)}}this._nodes=new Ev(this,s),this._animation=new pf(this._nodes,this.info),this._attributes=new Ef(s),this._background=new v_(this,this._nodes),this._geometries=new Rf(this._attributes,this.info),this._textures=new Qf(this,s,this.info),this._pipelines=new If(s,this._nodes),this._bindings=new Df(s,this._nodes,this._textures,this._attributes,this._pipelines,this.info),this._objects=new bf(this,this._nodes,this._geometries,this._pipelines,this._bindings,this.info),this._renderLists=new zf(this.lighting),this._bundles=new Mv,this._renderContexts=new Kf,this._animation.start(),this._initialized=!0,e(this)})),this._initPromise}get coordinateSystem(){return this.backend.coordinateSystem}async compileAsync(e,t,s=null){if(!0===this._isDeviceLost)return;!1===this._initialized&&await this.init();const i=this._nodes.nodeFrame,r=i.renderId,n=this._currentRenderContext,a=this._currentRenderObjectFunction,o=this._compilationPromises,l=!0===e.isScene?e:Wv;null===s&&(s=e);const h=this._renderTarget,u=this._renderContexts.get(s,t,h),c=this._activeMipmapLevel,d=[];this._currentRenderContext=u,this._currentRenderObjectFunction=this.renderObject,this._handleObjectFunction=this._createObjectPipeline,this._compilationPromises=d,i.renderId++,i.update(),u.depth=this.depth,u.stencil=this.stencil,u.clippingContext||(u.clippingContext=new Av),u.clippingContext.updateGlobal(l,t),l.onBeforeRender(this,e,t,h);const p=this._renderLists.get(e,t);if(p.begin(),this._projectObject(e,t,0,p,u.clippingContext),s!==e&&s.traverseVisible(function(e){e.isLight&&e.layers.test(t.layers)&&p.pushLight(e)}),p.finish(),null!==h){this._textures.updateRenderTarget(h,c);const e=this._textures.get(h);u.textures=e.textures,u.depthTexture=e.depthTexture}else u.textures=null,u.depthTexture=null;this._background.update(l,p,u);const _=p.opaque,m=p.transparent,f=p.transparentDoublePass,g=p.lightsNode;!0===this.opaque&&_.length>0&&this._renderObjects(_,t,l,g),!0===this.transparent&&m.length>0&&this._renderTransparents(m,f,t,l,g),i.renderId=r,this._currentRenderContext=n,this._currentRenderObjectFunction=a,this._compilationPromises=o,this._handleObjectFunction=this._renderObjectDirect,await Promise.all(d)}async renderAsync(e,t){!1===this._initialized&&await this.init(),this._renderScene(e,t)}async waitForGPU(){await this.backend.waitForGPU()}set highPrecision(e){!0===e?(this.overrideNodes.modelViewMatrix=zl2,this.overrideNodes.modelNormalViewMatrix=Hl2):this.highPrecision&&(this.overrideNodes.modelViewMatrix=null,this.overrideNodes.modelNormalViewMatrix=null)}get highPrecision(){return this.overrideNodes.modelViewMatrix===zl2&&this.overrideNodes.modelNormalViewMatrix===Hl2}setMRT(e){return this._mrt=e,this}getMRT(){return this._mrt}getColorBufferType(){return this._colorBufferType}_onDeviceLost(e){let t=`THREE.WebGPURenderer: ${e.api} Device Lost:\n\nMessage: ${e.message}`;e.reason&&(t+=`\nReason: ${e.reason}`),console.error(t),this._isDeviceLost=!0}_renderBundle(e,t,s){const{bundleGroup:i,camera:r,renderList:n}=e,a=this._currentRenderContext,o=this._bundles.get(i,r),l=this.backend.get(o);void 0===l.renderContexts&&(l.renderContexts=new Set);const h=i.version!==l.version,u=!1===l.renderContexts.has(a)||h;if(l.renderContexts.add(a),u){this.backend.beginBundle(a),(void 0===l.renderObjects||h)&&(l.renderObjects=[]),this._currentRenderBundle=o;const{transparentDoublePass:e,transparent:u,opaque:c}=n;!0===this.opaque&&c.length>0&&this._renderObjects(c,r,t,s),!0===this.transparent&&u.length>0&&this._renderTransparents(u,e,r,t,s),this._currentRenderBundle=null,this.backend.finishBundle(a,o),l.version=i.version}else{const{renderObjects:e}=l;for(let t=0,s=e.length;t<s;t++){const s=e[t];this._nodes.needsRefresh(s)&&(this._nodes.updateBefore(s),this._nodes.updateForRender(s),this._bindings.updateForRender(s),this._nodes.updateAfter(s))}}this.backend.addBundle(a,o)}render(e,t){if(!1===this._initialized)return console.warn("THREE.Renderer: .render() called before the backend is initialized. Try using .renderAsync() instead."),this.renderAsync(e,t);this._renderScene(e,t)}_getFrameBufferTarget(){const{currentToneMapping:e,currentColorSpace:t}=this,s=e!==$,i=t!==ms.workingColorSpace;if(!1===s&&!1===i)return null;const{width:r,height:n}=this.getDrawingBufferSize(qv),{depth:a,stencil:o}=this;let l=this._frameBufferTarget;null===l&&(l=new Ts(r,n,{depthBuffer:a,stencilBuffer:o,type:this._colorBufferType,format:jt,colorSpace:ms.workingColorSpace,generateMipmaps:!1,minFilter:wt,magFilter:wt,samples:this.samples}),l.isPostProcessingRenderTarget=!0,this._frameBufferTarget=l);const h=this.getOutputRenderTarget();return l.depthBuffer=a,l.stencilBuffer=o,null!==h?l.setSize(h.width,h.height,h.depth):l.setSize(r,n,1),l.viewport.copy(this._viewport),l.scissor.copy(this._scissor),l.viewport.multiplyScalar(this._pixelRatio),l.scissor.multiplyScalar(this._pixelRatio),l.scissorTest=this._scissorTest,l.multiview=null!==h&&h.multiview,l.resolveDepthBuffer=null===h||h.resolveDepthBuffer,l._autoAllocateDepthBuffer=null!==h&&h._autoAllocateDepthBuffer,l}_renderScene(e,t,s=!0){if(!0===this._isDeviceLost)return;const i=s?this._getFrameBufferTarget():null,r=this._nodes.nodeFrame,n=r.renderId,a=this._currentRenderContext,o=this._currentRenderObjectFunction,l=!0===e.isScene?e:Wv,h=this._renderTarget||this._outputRenderTarget,u=this._activeCubeFace,c=this._activeMipmapLevel;let d;null!==i?(d=i,this.setRenderTarget(d)):d=h;const p=this._renderContexts.get(e,t,d);this._currentRenderContext=p,this._currentRenderObjectFunction=this._renderObjectFunction||this.renderObject,this.info.calls++,this.info.render.calls++,this.info.render.frameCalls++,r.renderId=this.info.calls;const _=this.coordinateSystem,m=this.xr;if(t.coordinateSystem!==_&&!1===m.isPresenting&&(t.coordinateSystem=_,t.updateProjectionMatrix(),t.isArrayCamera))for(const e of t.cameras)e.coordinateSystem=_,e.updateProjectionMatrix();!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),null===t.parent&&!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld(),!0===m.enabled&&!0===m.isPresenting&&(!0===m.cameraAutoUpdate&&m.updateCamera(t),t=m.getCamera());let f=this._viewport,g=this._scissor,y=this._pixelRatio;null!==d&&(f=d.viewport,g=d.scissor,y=1),this.getDrawingBufferSize(qv),jv.set(0,0,qv.width,qv.height);const S=void 0===f.minDepth?0:f.minDepth,T=void 0===f.maxDepth?1:f.maxDepth;p.viewportValue.copy(f).multiplyScalar(y).floor(),p.viewportValue.width>>=c,p.viewportValue.height>>=c,p.viewportValue.minDepth=S,p.viewportValue.maxDepth=T,p.viewport=!1===p.viewportValue.equals(jv),p.scissorValue.copy(g).multiplyScalar(y).floor(),p.scissor=this._scissorTest&&!1===p.scissorValue.equals(jv),p.scissorValue.width>>=c,p.scissorValue.height>>=c,p.clippingContext||(p.clippingContext=new Av),p.clippingContext.updateGlobal(l,t),l.onBeforeRender(this,e,t,d);const x=t.isArrayCamera?Kv:Xv;t.isArrayCamera||(Yv.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),x.setFromProjectionMatrix(Yv,t.coordinateSystem,t.reversedDepth));const b=this._renderLists.get(e,t);if(b.begin(),this._projectObject(e,t,0,b,p.clippingContext),b.finish(),!0===this.sortObjects&&b.sort(this._opaqueSort,this._transparentSort),null!==d){this._textures.updateRenderTarget(d,c);const e=this._textures.get(d);p.textures=e.textures,p.depthTexture=e.depthTexture,p.width=e.width,p.height=e.height,p.renderTarget=d,p.depth=d.depthBuffer,p.stencil=d.stencilBuffer}else p.textures=null,p.depthTexture=null,p.width=this.domElement.width,p.height=this.domElement.height,p.depth=this.depth,p.stencil=this.stencil;p.width>>=c,p.height>>=c,p.activeCubeFace=u,p.activeMipmapLevel=c,p.occlusionQueryCount=b.occlusionQueryCount,this._background.update(l,b,p),p.camera=t,this.backend.beginRender(p);const{bundles:G,lightsNode:I,transparentDoublePass:v,transparent:C,opaque:w}=b;return G.length>0&&this._renderBundles(G,l,I),!0===this.opaque&&w.length>0&&this._renderObjects(w,t,l,I),!0===this.transparent&&C.length>0&&this._renderTransparents(C,v,t,l,I),this.backend.finishRender(p),r.renderId=n,this._currentRenderContext=a,this._currentRenderObjectFunction=o,null!==i&&(this.setRenderTarget(h,u,c),this._renderOutput(d)),l.onAfterRender(this,e,t,d),p}_setXRLayerSize(e,t){this._width=e,this._height=t,this.setViewport(0,0,e,t)}_renderOutput(e){const t=this._quad;this._nodes.hasOutputChange(e.texture)&&(t.material.fragmentNode=this._nodes.getOutputNode(e.texture),t.material.needsUpdate=!0);const s=this.autoClear,i=this.xr.enabled;this.autoClear=!1,this.xr.enabled=!1,this._renderScene(t,t.camera,!1),this.autoClear=s,this.xr.enabled=i}getMaxAnisotropy(){return this.backend.getMaxAnisotropy()}getActiveCubeFace(){return this._activeCubeFace}getActiveMipmapLevel(){return this._activeMipmapLevel}async setAnimationLoop(e){!1===this._initialized&&await this.init(),this._animation.setAnimationLoop(e)}async getArrayBufferAsync(e){return await this.backend.getArrayBufferAsync(e)}getContext(){return this.backend.getContext()}getPixelRatio(){return this._pixelRatio}getDrawingBufferSize(e){return e.set(this._width*this._pixelRatio,this._height*this._pixelRatio).floor()}getSize(e){return e.set(this._width,this._height)}setPixelRatio(e=1){this._pixelRatio!==e&&(this._pixelRatio=e,this.setSize(this._width,this._height,!1))}setDrawingBufferSize(e,t,s){this.xr&&this.xr.isPresenting||(this._width=e,this._height=t,this._pixelRatio=s,this.domElement.width=Math.floor(e*s),this.domElement.height=Math.floor(t*s),this.setViewport(0,0,e,t),this._initialized&&this.backend.updateSize())}setSize(e,t,s=!0){this.xr&&this.xr.isPresenting||(this._width=e,this._height=t,this.domElement.width=Math.floor(e*this._pixelRatio),this.domElement.height=Math.floor(t*this._pixelRatio),!0===s&&(this.domElement.style.width=e+"px",this.domElement.style.height=t+"px"),this.setViewport(0,0,e,t),this._initialized&&this.backend.updateSize())}setOpaqueSort(e){this._opaqueSort=e}setTransparentSort(e){this._transparentSort=e}getScissor(e){const t=this._scissor;return e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,e}setScissor(e,t,s,i){const r=this._scissor;e.isVector4?r.copy(e):r.set(e,t,s,i)}getScissorTest(){return this._scissorTest}setScissorTest(e){this._scissorTest=e,this.backend.setScissorTest(e)}getViewport(e){return e.copy(this._viewport)}setViewport(e,t,s,i,r=0,n=1){const a=this._viewport;e.isVector4?a.copy(e):a.set(e,t,s,i),a.minDepth=r,a.maxDepth=n}getClearColor(e){return e.copy(this._clearColor)}setClearColor(e,t=1){this._clearColor.set(e),this._clearColor.a=t}getClearAlpha(){return this._clearColor.a}setClearAlpha(e){this._clearColor.a=e}getClearDepth(){return this._clearDepth}setClearDepth(e){this._clearDepth=e}getClearStencil(){return this._clearStencil}setClearStencil(e){this._clearStencil=e}isOccluded(e){const t=this._currentRenderContext;return t&&this.backend.isOccluded(t,e)}clear(e=!0,t=!0,s=!0){if(!1===this._initialized)return console.warn("THREE.Renderer: .clear() called before the backend is initialized. Try using .clearAsync() instead."),this.clearAsync(e,t,s);const i=this._renderTarget||this._getFrameBufferTarget();let r=null;if(null!==i){this._textures.updateRenderTarget(i);const e=this._textures.get(i);r=this._renderContexts.getForClear(i),r.textures=e.textures,r.depthTexture=e.depthTexture,r.width=e.width,r.height=e.height,r.renderTarget=i,r.depth=i.depthBuffer,r.stencil=i.stencilBuffer,r.clearColorValue=this.backend.getClearColor(),r.activeCubeFace=this.getActiveCubeFace(),r.activeMipmapLevel=this.getActiveMipmapLevel()}this.backend.clear(e,t,s,r),null!==i&&null===this._renderTarget&&this._renderOutput(i)}clearColor(){return this.clear(!0,!1,!1)}clearDepth(){return this.clear(!1,!0,!1)}clearStencil(){return this.clear(!1,!1,!0)}async clearAsync(e=!0,t=!0,s=!0){!1===this._initialized&&await this.init(),this.clear(e,t,s)}async clearColorAsync(){this.clearAsync(!0,!1,!1)}async clearDepthAsync(){this.clearAsync(!1,!0,!1)}async clearStencilAsync(){this.clearAsync(!1,!1,!0)}get currentToneMapping(){return this.isOutputTarget?this.toneMapping:$}get currentColorSpace(){return this.isOutputTarget?this.outputColorSpace:ms.workingColorSpace}get isOutputTarget(){return this._renderTarget===this._outputRenderTarget||null===this._renderTarget}dispose(){this.info.dispose(),this.backend.dispose(),this._animation.dispose(),this._objects.dispose(),this._pipelines.dispose(),this._nodes.dispose(),this._bindings.dispose(),this._renderLists.dispose(),this._renderContexts.dispose(),this._textures.dispose(),null!==this._frameBufferTarget&&this._frameBufferTarget.dispose(),Object.values(this.backend.timestampQueryPool).forEach(e=>{null!==e&&e.dispose()}),this.setRenderTarget(null),this.setAnimationLoop(null)}setRenderTarget(e,t=0,s=0){this._renderTarget=e,this._activeCubeFace=t,this._activeMipmapLevel=s}getRenderTarget(){return this._renderTarget}setOutputRenderTarget(e){this._outputRenderTarget=e}getOutputRenderTarget(){return this._outputRenderTarget}_resetXRState(){this.backend.setXRTarget(null),this.setOutputRenderTarget(null),this.setRenderTarget(null),this._frameBufferTarget.dispose(),this._frameBufferTarget=null}setRenderObjectFunction(e){this._renderObjectFunction=e}getRenderObjectFunction(){return this._renderObjectFunction}compute(e,t=null){if(!0===this._isDeviceLost)return;if(!1===this._initialized)return console.warn("THREE.Renderer: .compute() called before the backend is initialized. Try using .computeAsync() instead."),this.computeAsync(e);const s=this._nodes.nodeFrame,i=s.renderId;this.info.calls++,this.info.compute.calls++,this.info.compute.frameCalls++,s.renderId=this.info.calls;const r=this.backend,n=this._pipelines,a=this._bindings,o=this._nodes,l=Array.isArray(e)?e:[e];if(void 0===l[0]||!0!==l[0].isComputeNode)throw new Error("THREE.Renderer: .compute() expects a ComputeNode.");r.beginCompute(e);for(const s of l){if(!1===n.has(s)){const e=()=>{s.removeEventListener("dispose",e),n.delete(s),a.delete(s),o.delete(s)};s.addEventListener("dispose",e);const t=s.onInitFunction;null!==t&&t.call(s,{renderer:this})}o.updateForCompute(s),a.updateForCompute(s);const i=a.getForCompute(s),l=n.getForCompute(s,i);r.compute(e,s,i,l,t)}r.finishCompute(e),s.renderId=i}async computeAsync(e,t=null){!1===this._initialized&&await this.init(),this.compute(e,t)}async hasFeatureAsync(e){return!1===this._initialized&&await this.init(),this.backend.hasFeature(e)}async resolveTimestampsAsync(e="render"){return!1===this._initialized&&await this.init(),this.backend.resolveTimestampsAsync(e)}hasFeature(e){return!1===this._initialized?(console.warn("THREE.Renderer: .hasFeature() called before the backend is initialized. Try using .hasFeatureAsync() instead."),!1):this.backend.hasFeature(e)}hasInitialized(){return this._initialized}async initTextureAsync(e){!1===this._initialized&&await this.init(),this._textures.updateTexture(e)}initTexture(e){!1===this._initialized&&console.warn("THREE.Renderer: .initTexture() called before the backend is initialized. Try using .initTextureAsync() instead."),this._textures.updateTexture(e)}copyFramebufferToTexture(e,t=null){if(null!==t)if(t.isVector2)t=Qv.set(t.x,t.y,e.image.width,e.image.height).floor();else{if(!t.isVector4)return void console.error("THREE.Renderer.copyFramebufferToTexture: Invalid rectangle.");t=Qv.copy(t).floor()}else t=Qv.set(0,0,e.image.width,e.image.height);let s,i=this._currentRenderContext;null!==i?s=i.renderTarget:(s=this._renderTarget||this._getFrameBufferTarget(),null!==s&&(this._textures.updateRenderTarget(s),i=this._textures.get(s))),this._textures.updateTexture(e,{renderTarget:s}),this.backend.copyFramebufferToTexture(e,i,t)}copyTextureToTexture(e,t,s=null,i=null,r=0,n=0){this._textures.updateTexture(e),this._textures.updateTexture(t),this.backend.copyTextureToTexture(e,t,s,i,r,n)}async readRenderTargetPixelsAsync(e,t,s,i,r,n=0,a=0){return this.backend.copyTextureToBuffer(e.textures[n],t,s,i,r,a)}_projectObject(e,t,s,i,r){if(!1===e.visible)return;if(e.layers.test(t.layers))if(e.isGroup)s=e.renderOrder,e.isClippingGroup&&e.enabled&&(r=r.getGroupContext(e));else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)i.pushLight(e);else if(e.isSprite){const n=t.isArrayCamera?Kv:Xv;if(!e.frustumCulled||n.intersectsSprite(e,t)){!0===this.sortObjects&&Qv.setFromMatrixPosition(e.matrixWorld).applyMatrix4(Yv);const{geometry:t,material:n}=e;n.visible&&i.push(e,t,n,s,Qv.z,null,r)}}else if(e.isLineLoop)console.error("THREE.Renderer: Objects of type THREE.LineLoop are not supported. Please use THREE.Line or THREE.LineSegments.");else if(e.isMesh||e.isLine||e.isPoints){const n=t.isArrayCamera?Kv:Xv;if(!e.frustumCulled||n.intersectsObject(e,t)){const{geometry:t,material:n}=e;if(!0===this.sortObjects&&(null===t.boundingSphere&&t.computeBoundingSphere(),Qv.copy(t.boundingSphere.center).applyMatrix4(e.matrixWorld).applyMatrix4(Yv)),Array.isArray(n)){const a=t.groups;for(let o=0,l=a.length;o<l;o++){const l=a[o],h=n[l.materialIndex];h&&h.visible&&i.push(e,t,h,s,Qv.z,l,r)}}else n.visible&&i.push(e,t,n,s,Qv.z,null,r)}}if(!0===e.isBundleGroup&&void 0!==this.backend.beginBundle){const s=i;(i=this._renderLists.get(e,t)).begin(),s.pushBundle({bundleGroup:e,camera:t,renderList:i}),i.finish()}const n=e.children;for(let e=0,a=n.length;e<a;e++)this._projectObject(n[e],t,s,i,r)}_renderBundles(e,t,s){for(const i of e)this._renderBundle(i,t,s)}_renderTransparents(e,t,s,i,r){if(t.length>0){for(const{material:e}of t)e.side=d2;this._renderObjects(t,s,i,r,"backSide");for(const{material:e}of t)e.side=u;this._renderObjects(e,s,i,r);for(const{material:e}of t)e.side=p}else this._renderObjects(e,s,i,r)}_renderObjects(e,t,s,i,r=null){for(let n=0,a=e.length;n<a;n++){const{object:a,geometry:o,material:l,group:h,clippingContext:u}=e[n];this._currentRenderObjectFunction(a,s,t,o,l,h,i,u,r)}}renderObject(e,t,s,i,r,n,a,o=null,l=null){let h,c,d;if(e.onBeforeRender(this,t,s,i,r,n),!0===r.allowOverride&&null!==t.overrideMaterial){const e=t.overrideMaterial;r.positionNode&&r.positionNode.isNode&&(h=e.positionNode,e.positionNode=r.positionNode),e.alphaTest=r.alphaTest,e.alphaMap=r.alphaMap,e.transparent=r.transparent||r.transmission>0,e.isShadowPassMaterial&&(e.side=null===r.shadowSide?r.side:r.shadowSide,r.depthNode&&r.depthNode.isNode&&(d=e.depthNode,e.depthNode=r.depthNode),r.castShadowNode&&r.castShadowNode.isNode&&(c=e.colorNode,e.colorNode=r.castShadowNode),r.castShadowPositionNode&&r.castShadowPositionNode.isNode&&(h=e.positionNode,e.positionNode=r.castShadowPositionNode)),r=e}!0===r.transparent&&r.side===p&&!1===r.forceSinglePass?(r.side=d2,this._handleObjectFunction(e,r,t,s,a,n,o,"backSide"),r.side=u,this._handleObjectFunction(e,r,t,s,a,n,o,l),r.side=p):this._handleObjectFunction(e,r,t,s,a,n,o,l),void 0!==h&&(t.overrideMaterial.positionNode=h),void 0!==d&&(t.overrideMaterial.depthNode=d),void 0!==c&&(t.overrideMaterial.colorNode=c),e.onAfterRender(this,t,s,i,r,n)}_renderObjectDirect(e,t,s,i,r,n,a,o){const l=this._objects.get(e,t,s,i,r,this._currentRenderContext,a,o);l.drawRange=e.geometry.drawRange,l.group=n;const h=this._nodes.needsRefresh(l);h&&(this._nodes.updateBefore(l),this._geometries.updateForRender(l),this._nodes.updateForRender(l),this._bindings.updateForRender(l)),this._pipelines.updateForRender(l),null!==this._currentRenderBundle&&(this.backend.get(this._currentRenderBundle).renderObjects.push(l),l.bundle=this._currentRenderBundle.bundleGroup),this.backend.draw(l,this.info),h&&this._nodes.updateAfter(l)}_createObjectPipeline(e,t,s,i,r,n,a,o){const l=this._objects.get(e,t,s,i,r,this._currentRenderContext,a,o);l.drawRange=e.geometry.drawRange,l.group=n,this._nodes.updateBefore(l),this._geometries.updateForRender(l),this._nodes.updateForRender(l),this._bindings.updateForRender(l),this._pipelines.getForRender(l,this._compilationPromises),this._nodes.updateAfter(l)}get compile(){return this.compileAsync}},Jv=class{constructor(e=""){this.name=e,this.visibility=0}setVisibility(e){this.visibility|=e}clone(){return Object.assign(new this.constructor,this)}},eN=class extends Jv{constructor(e,t=null){super(e),this.isBuffer=!0,this.bytesPerElement=Float32Array.BYTES_PER_ELEMENT,this._buffer=t}get byteLength(){return(e=this._buffer.byteLength)+(Sf-e%Sf)%Sf;var e}get buffer(){return this._buffer}update(){return!0}},tN=class extends eN{constructor(e,t=null){super(e,t),this.isUniformBuffer=!0}},rN=0,sN=class extends tN{constructor(e,t){super("UniformBuffer_"+rN++,e?e.value:null),this.nodeUniform=e,this.groupNode=t}get buffer(){return this.nodeUniform.value}},iN=class extends tN{constructor(e){super(e),this.isUniformsGroup=!0,this._values=null,this.uniforms=[]}addUniform(e){return this.uniforms.push(e),this}removeUniform(e){const t=this.uniforms.indexOf(e);return-1!==t&&this.uniforms.splice(t,1),this}get values(){return null===this._values&&(this._values=Array.from(this.buffer)),this._values}get buffer(){let e=this._buffer;if(null===e){const t=this.byteLength;e=new Float32Array(new ArrayBuffer(t)),this._buffer=e}return e}get byteLength(){const e=this.bytesPerElement;let t=0;for(let s=0,i=this.uniforms.length;s<i;s++){const i=this.uniforms[s],r=i.boundary,n=i.itemSize*e,a=t%Sf,o=a%r,l=a+o;t+=o,0!==l&&Sf-l<n&&(t+=Sf-l),i.offset=t/e,t+=n}return Math.ceil(t/Sf)*Sf}update(){let e=!1;for(const t of this.uniforms)!0===this.updateByType(t)&&(e=!0);return e}updateByType(e){return e.isNumberUniform?this.updateNumber(e):e.isVector2Uniform?this.updateVector2(e):e.isVector3Uniform?this.updateVector3(e):e.isVector4Uniform?this.updateVector4(e):e.isColorUniform?this.updateColor(e):e.isMatrix3Uniform?this.updateMatrix3(e):e.isMatrix4Uniform?this.updateMatrix4(e):void console.error("THREE.WebGPUUniformsGroup: Unsupported uniform type.",e)}updateNumber(e){let t=!1;const s=this.values,i=e.getValue(),r=e.offset,n=e.getType();return s[r]!==i&&(this._getBufferForType(n)[r]=s[r]=i,t=!0),t}updateVector2(e){let t=!1;const s=this.values,i=e.getValue(),r=e.offset,n=e.getType();if(s[r+0]!==i.x||s[r+1]!==i.y){const e=this._getBufferForType(n);e[r+0]=s[r+0]=i.x,e[r+1]=s[r+1]=i.y,t=!0}return t}updateVector3(e){let t=!1;const s=this.values,i=e.getValue(),r=e.offset,n=e.getType();if(s[r+0]!==i.x||s[r+1]!==i.y||s[r+2]!==i.z){const e=this._getBufferForType(n);e[r+0]=s[r+0]=i.x,e[r+1]=s[r+1]=i.y,e[r+2]=s[r+2]=i.z,t=!0}return t}updateVector4(e){let t=!1;const s=this.values,i=e.getValue(),r=e.offset,n=e.getType();if(s[r+0]!==i.x||s[r+1]!==i.y||s[r+2]!==i.z||s[r+4]!==i.w){const e=this._getBufferForType(n);e[r+0]=s[r+0]=i.x,e[r+1]=s[r+1]=i.y,e[r+2]=s[r+2]=i.z,e[r+3]=s[r+3]=i.w,t=!0}return t}updateColor(e){let t=!1;const s=this.values,i=e.getValue(),r=e.offset;if(s[r+0]!==i.r||s[r+1]!==i.g||s[r+2]!==i.b){const e=this.buffer;e[r+0]=s[r+0]=i.r,e[r+1]=s[r+1]=i.g,e[r+2]=s[r+2]=i.b,t=!0}return t}updateMatrix3(e){let t=!1;const s=this.values,i=e.getValue().elements,r=e.offset;if(s[r+0]!==i[0]||s[r+1]!==i[1]||s[r+2]!==i[2]||s[r+4]!==i[3]||s[r+5]!==i[4]||s[r+6]!==i[5]||s[r+8]!==i[6]||s[r+9]!==i[7]||s[r+10]!==i[8]){const e=this.buffer;e[r+0]=s[r+0]=i[0],e[r+1]=s[r+1]=i[1],e[r+2]=s[r+2]=i[2],e[r+4]=s[r+4]=i[3],e[r+5]=s[r+5]=i[4],e[r+6]=s[r+6]=i[5],e[r+8]=s[r+8]=i[6],e[r+9]=s[r+9]=i[7],e[r+10]=s[r+10]=i[8],t=!0}return t}updateMatrix4(e){let t=!1;const s=this.values,i=e.getValue().elements,r=e.offset;return!1===function(e,t,s){for(let i=0,r=t.length;i<r;i++)if(e[s+i]!==t[i])return!1;return!0}(s,i,r)&&(this.buffer.set(i,r),function(e,t,s){for(let i=0,r=t.length;i<r;i++)e[s+i]=t[i]}(s,i,r),t=!0),t}_getBufferForType(e){return"int"===e||"ivec2"===e||"ivec3"===e||"ivec4"===e?new Int32Array(this.buffer.buffer):"uint"===e||"uvec2"===e||"uvec3"===e||"uvec4"===e?new Uint32Array(this.buffer.buffer):this.buffer}},nN=0,aN=class extends iN{constructor(e,t){super(e),this.id=nN++,this.groupNode=t,this.isNodeUniformsGroup=!0}},oN=class extends Jv{constructor(e,t){super(e),this._onDisposeTexture=()=>{this.texture=null},this.texture=t,this.version=t?t.version:0,this.generation=null,this.isSampler=!0}set texture(e){this._texture!==e&&(this._texture&&this._texture.removeEventListener("dispose",this._onDisposeTexture),this._texture=e,this.generation=null,this.version=0,this._texture&&this._texture.addEventListener("dispose",this._onDisposeTexture))}get texture(){return this._texture}update(){const{texture:e,version:t}=this;return t!==e.version&&(this.version=e.version,!0)}},uN=0,lN=class extends oN{constructor(e,t){super(e,t),this.id=uN++,this.store=!1,this.isSampledTexture=!0}},dN=class extends lN{constructor(e,t,s,i=null){super(e,t?t.value:null),this.textureNode=t,this.groupNode=s,this.access=i}update(){const{textureNode:e}=this;return this.texture!==e.value?(this.texture=e.value,!0):super.update()}},cN=class extends dN{constructor(e,t,s,i=null){super(e,t,s,i),this.isSampledCubeTexture=!0}},hN=class extends dN{constructor(e,t,s,i=null){super(e,t,s,i),this.isSampledTexture3D=!0}},pN={textureDimensions:"textureSize",equals:"equal"},gN={low:"lowp",medium:"mediump",high:"highp"},mN={swizzleAssign:!0,storageBuffer:!1},fN={perspective:"smooth",linear:"noperspective"},yN={centroid:"centroid"},bN="\nprecision highp float;\nprecision highp int;\nprecision highp sampler2D;\nprecision highp sampler3D;\nprecision highp samplerCube;\nprecision highp sampler2DArray;\n\nprecision highp usampler2D;\nprecision highp usampler3D;\nprecision highp usamplerCube;\nprecision highp usampler2DArray;\n\nprecision highp isampler2D;\nprecision highp isampler3D;\nprecision highp isamplerCube;\nprecision highp isampler2DArray;\n\nprecision lowp sampler2DShadow;\nprecision lowp sampler2DArrayShadow;\nprecision lowp samplerCubeShadow;\n",xN=class extends ev{constructor(e,t){super(e,t,new _v),this.uniformGroups={},this.transforms=[],this.extensions={},this.builtins={vertex:[],fragment:[],compute:[]}}needsToWorkingColorSpace(e){return!0===e.isVideoTexture&&e.colorSpace!==Xe}getMethod(e){return pN[e]||e}getOutputStructName(){return""}buildFunctionCode(e){const t=e.layout,s=this.flowShaderNode(e),i=[];for(const e of t.inputs)i.push(this.getType(e.type)+" "+e.name);return`${this.getType(t.type)} ${t.name}( ${i.join(", ")} ) {\n\n\t${s.vars}\n\n${s.code}\n\treturn ${s.result};\n\n}`}setupPBO(e){const t=e.value;if(void 0===t.pbo){const e=t.array,s=t.count*t.itemSize,{itemSize:i}=t,r=t.array.constructor.name.toLowerCase().includes("int");let n=r?Ht:Ut;2===i?n=r?Jt:qt:3===i?n=r?Xt:Lt:4===i&&(n=r?Yt:jt);const a={Float32Array:Et,Uint8Array:Tt,Uint16Array:It,Uint32Array:kt,Int8Array:zt,Int16Array:Ct,Int32Array:Bt,Uint8ClampedArray:Tt},o=Math.pow(2,Math.ceil(Math.log2(Math.sqrt(s/i))));let l=Math.ceil(s/i/o);o*l*i<s&&l++;const h=o*l*i,u=new e.constructor(h);u.set(e,0),t.array=u;const c=new Da(t.array,o,l,n,a[t.array.constructor.name]||Et);c.needsUpdate=!0,c.isPBOTexture=!0;const d=new il2(c,null,null);d.setPrecision("high"),t.pboNode=d,t.pbo=d.value,this.getUniformFromNode(t.pboNode,"texture",this.shaderStage,this.context.nodeName)}}getPropertyName(e,t=this.shaderStage){return e.isNodeUniform&&!0!==e.node.isTextureNode&&!0!==e.node.isBufferNode?t.charAt(0)+"_"+e.name:super.getPropertyName(e,t)}generatePBO(e){const{node:t,indexNode:s}=e,i=t.value;this.renderer.backend.has(i)&&(this.renderer.backend.get(i).pbo=i.pbo);const r=this.getUniformFromNode(i.pboNode,"texture",this.shaderStage,this.context.nodeName),n=this.getPropertyName(r);this.increaseUsage(s);const a=s.build(this,"uint"),o=this.getDataFromNode(e);let l=o.propertyName;if(void 0===l){const s=this.getVarFromNode(e);l=this.getPropertyName(s);const r=this.getDataFromNode(t);let h=r.propertySizeName;void 0===h&&(h=l+"Size",this.getVarFromNode(t,h,"uint"),this.addLineFlowCode(`${h} = uint( textureSize( ${n}, 0 ).x )`,e),r.propertySizeName=h);const{itemSize:u}=i,c="."+$s2.join("").slice(0,u),d=`ivec2(${a} % ${h}, ${a} / ${h})`,p=this.generateTextureLoad(null,n,d,null,"0");let _="vec4";i.pbo.type===kt?_="uvec4":i.pbo.type===Bt&&(_="ivec4"),this.addLineFlowCode(`${l} = ${_}(${p})${c}`,e),o.propertyName=l}return l}generateTextureLoad(e,t,s,i,r="0"){return i?`texelFetch( ${t}, ivec3( ${s}, ${i} ), ${r} )`:`texelFetch( ${t}, ${s}, ${r} )`}generateTexture(e,t,s,i){return e.isDepthTexture?(i&&(s=`vec4( ${s}, ${i} )`),`texture( ${t}, ${s} ).x`):(i&&(s=`vec3( ${s}, ${i} )`),`texture( ${t}, ${s} )`)}generateTextureLevel(e,t,s,i){return`textureLod( ${t}, ${s}, ${i} )`}generateTextureBias(e,t,s,i){return`texture( ${t}, ${s}, ${i} )`}generateTextureGrad(e,t,s,i){return`textureGrad( ${t}, ${s}, ${i[0]}, ${i[1]} )`}generateTextureCompare(e,t,s,i,r,n=this.shaderStage){if("fragment"===n)return r?`texture( ${t}, vec4( ${s}, ${r}, ${i} ) )`:`texture( ${t}, vec3( ${s}, ${i} ) )`;console.error(`WebGPURenderer: THREE.DepthTexture.compareFunction() does not support ${n} shader.`)}getVars(e){const t=[],s=this.vars[e];if(void 0!==s)for(const e of s)t.push(`${this.getVar(e.type,e.name,e.count)};`);return t.join("\n\t")}getUniforms(e){const t=this.uniforms[e],s=[],i={};for(const r of t){let t=null,n=!1;if("texture"===r.type||"texture3D"===r.type){const e=r.node.value;let s="";!0!==e.isDataTexture&&!0!==e.isData3DTexture||(e.type===kt?s="u":e.type===Bt&&(s="i")),t="texture3D"===r.type&&!1===e.isArrayTexture?`${s}sampler3D ${r.name};`:e.compareFunction?!0===e.isArrayTexture?`sampler2DArrayShadow ${r.name};`:`sampler2DShadow ${r.name};`:!0===e.isArrayTexture||!0===e.isDataArrayTexture||!0===e.isCompressedArrayTexture?`${s}sampler2DArray ${r.name};`:`${s}sampler2D ${r.name};`}else if("cubeTexture"===r.type)t=`samplerCube ${r.name};`;else if("buffer"===r.type){const e=r.node,s=this.getType(e.bufferType),i=e.bufferCount,n=i>0?i:"";t=`${e.name} {\n\t${s} ${r.name}[${n}];\n};\n`}else t=`${this.getVectorType(r.type)} ${this.getPropertyName(r,e)};`,n=!0;const a=r.node.precision;if(null!==a&&(t=gN[a]+" "+t),n){t="\t"+t;const e=r.groupNode.name;(i[e]||(i[e]=[])).push(t)}else t="uniform "+t,s.push(t)}let r="";for(const t in i){const s=i[t];r+=this._getGLSLUniformStruct(e+"_"+t,s.join("\n"))+"\n"}return r+=s.join("\n"),r}getTypeFromAttribute(e){let t=super.getTypeFromAttribute(e);if(/^[iu]/.test(t)&&e.gpuType!==Bt){let s=e;e.isInterleavedBufferAttribute&&(s=e.data);const i=s.array;0==(i instanceof Uint32Array||i instanceof Int32Array)&&(t=t.slice(1))}return t}getAttributes(e){let t="";if("vertex"===e||"compute"===e){const e=this.getAttributesArray();let s=0;for(const i of e)t+=`layout( location = ${s++} ) in ${i.type} ${i.name};\n`}return t}getStructMembers(e){const t=[];for(const s of e.members)t.push(`\t${s.type} ${s.name};`);return t.join("\n")}getStructs(e){const t=[],s=this.structs[e],i=[];for(const e of s)if(e.output)for(const t of e.members)i.push(`layout( location = ${t.index} ) out ${t.type} ${t.name};`);else{let s="struct "+e.name+" {\n";s+=this.getStructMembers(e),s+="\n};\n",t.push(s)}return 0===i.length&&i.push("layout( location = 0 ) out vec4 fragColor;"),"\n"+i.join("\n")+"\n\n"+t.join("\n")}getVaryings(e){let t="";const s=this.varyings;if("vertex"===e||"compute"===e)for(const i of s){"compute"===e&&(i.needsInterpolation=!0);const s=this.getType(i.type);i.needsInterpolation?i.interpolationType?t+=`${fN[i.interpolationType]||i.interpolationType} ${yN[i.interpolationSampling]||""} out ${s} ${i.name};\n`:t+=`${s.includes("int")||s.includes("uv")||s.includes("iv")?"flat ":""}out ${s} ${i.name};\n`:t+=`${s} ${i.name};\n`}else if("fragment"===e)for(const e of s)if(e.needsInterpolation){const s=this.getType(e.type);e.interpolationType?t+=`${fN[e.interpolationType]||e.interpolationType} ${yN[e.interpolationSampling]||""} in ${s} ${e.name};\n`:t+=`${s.includes("int")||s.includes("uv")||s.includes("iv")?"flat ":""}in ${s} ${e.name};\n`}for(const s of this.builtins[e])t+=`${s};\n`;return t}getVertexIndex(){return"uint( gl_VertexID )"}getInstanceIndex(){return"uint( gl_InstanceID )"}getInvocationLocalIndex(){return`uint( gl_InstanceID ) % ${this.object.workgroupSize.reduce((e,t)=>e*t,1)}u`}getDrawIndex(){return this.renderer.backend.extensions.has("WEBGL_multi_draw")?"uint( gl_DrawID )":null}getFrontFacing(){return"gl_FrontFacing"}getFragCoord(){return"gl_FragCoord.xy"}getFragDepth(){return"gl_FragDepth"}enableExtension(e,t,s=this.shaderStage){const i=this.extensions[s]||(this.extensions[s]=new Map);!1===i.has(e)&&i.set(e,{name:e,behavior:t})}getExtensions(e){const t=[];if("vertex"===e){const t=this.renderer.backend.extensions;this.object.isBatchedMesh&&t.has("WEBGL_multi_draw")&&this.enableExtension("GL_ANGLE_multi_draw","require",e)}const s=this.extensions[e];if(void 0!==s)for(const{name:e,behavior:i}of s.values())t.push(`#extension ${e} : ${i}`);return t.join("\n")}getClipDistance(){return"gl_ClipDistance"}isAvailable(e){let t=mN[e];if(void 0===t){let s;switch(t=!1,e){case"float32Filterable":s="OES_texture_float_linear";break;case"clipDistance":s="WEBGL_clip_cull_distance"}if(void 0!==s){const e=this.renderer.backend.extensions;e.has(s)&&(e.get(s),t=!0)}mN[e]=t}return t}isFlipY(){return!0}enableHardwareClipping(e){this.enableExtension("GL_ANGLE_clip_cull_distance","require"),this.builtins.vertex.push(`out float gl_ClipDistance[ ${e} ]`)}enableMultiview(){this.enableExtension("GL_OVR_multiview2","require","fragment"),this.enableExtension("GL_OVR_multiview2","require","vertex"),this.builtins.vertex.push("layout(num_views = 2) in")}registerTransform(e,t){this.transforms.push({varyingName:e,attributeNode:t})}getTransforms(){const e=this.transforms;let t="";for(let s=0;s<e.length;s++){const i=e[s],r=this.getPropertyName(i.attributeNode);r&&(t+=`${i.varyingName} = ${r};\n\t`)}return t}_getGLSLUniformStruct(e,t){return`\nlayout( std140 ) uniform ${e} {\n${t}\n};`}_getGLSLVertexCode(e){return`#version 300 es\n\n${this.getSignature()}\n\n// extensions\n${e.extensions}\n\n// precision\n${bN}\n\n// uniforms\n${e.uniforms}\n\n// varyings\n${e.varyings}\n\n// attributes\n${e.attributes}\n\n// codes\n${e.codes}\n\nvoid main() {\n\n\t// vars\n\t${e.vars}\n\n\t// transforms\n\t${e.transforms}\n\n\t// flow\n\t${e.flow}\n\n\tgl_PointSize = 1.0;\n\n}\n`}_getGLSLFragmentCode(e){return`#version 300 es\n\n${this.getSignature()}\n\n// extensions\n${e.extensions}\n\n// precision\n${bN}\n\n// uniforms\n${e.uniforms}\n\n// varyings\n${e.varyings}\n\n// codes\n${e.codes}\n\n// structs\n${e.structs}\n\nvoid main() {\n\n\t// vars\n\t${e.vars}\n\n\t// flow\n\t${e.flow}\n\n}\n`}buildCode(){const e=null!==this.material?{fragment:{},vertex:{}}:{compute:{}};this.sortBindingGroups();for(const t in e){let s="// code\n\n";s+=this.flowCode[t];const i=this.flowNodes[t],r=i[i.length-1];for(const e of i){const i=this.getFlowData(e),n=e.name;n&&(s.length>0&&(s+="\n"),s+=`\t// flow -> ${n}\n\t`),s+=`${i.code}\n\t`,e===r&&"compute"!==t&&(s+="// result\n\t","vertex"===t?(s+="gl_Position = ",s+=`${i.result};`):"fragment"===t&&(e.outputNode.isOutputStructNode||(s+="fragColor = ",s+=`${i.result};`)))}const n=e[t];n.extensions=this.getExtensions(t),n.uniforms=this.getUniforms(t),n.attributes=this.getAttributes(t),n.varyings=this.getVaryings(t),n.vars=this.getVars(t),n.structs=this.getStructs(t),n.codes=this.getCodes(t),n.transforms=this.getTransforms(t),n.flow=s}null!==this.material?(this.vertexShader=this._getGLSLVertexCode(e.vertex),this.fragmentShader=this._getGLSLFragmentCode(e.fragment)):this.computeShader=this._getGLSLVertexCode(e.compute)}getUniformFromNode(e,t,s,i=null){const r=super.getUniformFromNode(e,t,s,i),n=this.getDataFromNode(e,s,this.globalCache);let a=n.uniformGPU;if(void 0===a){const i=e.groupNode,o=i.name,l=this.getBindGroupArray(o,s);if("texture"===t)a=new dN(r.name,r.node,i),l.push(a);else if("cubeTexture"===t)a=new cN(r.name,r.node,i),l.push(a);else if("texture3D"===t)a=new hN(r.name,r.node,i),l.push(a);else if("buffer"===t){e.name=`NodeBuffer_${e.id}`,r.name=`buffer${e.id}`;const t=new sN(e,i);t.name=e.name,l.push(t),a=t}else{const e=this.uniformGroups[s]||(this.uniformGroups[s]={});let n=e[o];void 0===n&&(n=new aN(s+"_"+o,i),e[o]=n,l.push(n)),a=this.getNodeUniform(r,t),n.addUniform(a)}n.uniformGPU=a}return r}},TN=null,_N=null,vN=class{constructor(e={}){this.parameters=Object.assign({},e),this.data=new WeakMap,this.renderer=null,this.domElement=null,this.timestampQueryPool={render:null,compute:null},this.trackTimestamp=!0===e.trackTimestamp}async init(e){this.renderer=e}get coordinateSystem(){}beginRender(){}finishRender(){}beginCompute(){}finishCompute(){}draw(){}compute(){}createProgram(){}destroyProgram(){}createBindings(){}updateBindings(){}updateBinding(){}createRenderPipeline(){}createComputePipeline(){}needsRenderUpdate(){}getRenderCacheKey(){}createNodeBuilder(){}createSampler(){}destroySampler(){}createDefaultTexture(){}createTexture(){}updateTexture(){}generateMipmaps(){}destroyTexture(){}async copyTextureToBuffer(){}copyTextureToTexture(){}copyFramebufferToTexture(){}createAttribute(){}createIndexAttribute(){}createStorageAttribute(){}updateAttribute(){}destroyAttribute(){}getContext(){}updateSize(){}updateViewport(){}isOccluded(){}async resolveTimestampsAsync(e="render"){if(!this.trackTimestamp)return void ls("WebGPURenderer: Timestamp tracking is disabled.");const t=this.timestampQueryPool[e];if(!t)return void ls(`WebGPURenderer: No timestamp query pool for type '${e}' found.`);const s=await t.resolveQueriesAsync();return this.renderer.info[e].timestamp=s,s}async waitForGPU(){}async getArrayBufferAsync(){}async hasFeatureAsync(){}hasFeature(){}getMaxAnisotropy(){}getDrawingBufferSize(){return TN=TN||new Gi,this.renderer.getDrawingBufferSize(TN)}setScissorTest(){}getClearColor(){const e=this.renderer;return _N=_N||new Zf,e.getClearColor(_N),_N.getRGB(_N),_N}getDomElement(){let e=this.domElement;return null===e&&(e=void 0!==this.parameters.canvas?this.parameters.canvas:os(),"setAttribute"in e&&e.setAttribute("data-engine",`three.js r${t} webgpu`),this.domElement=e),e}set(e,t){this.data.set(e,t)}get(e){let t=this.data.get(e);return void 0===t&&(t={},this.data.set(e,t)),t}has(e){return this.data.has(e)}delete(e){this.data.delete(e)}dispose(){}},NN,SN,EN=0,wN=class{constructor(e,t){this.buffers=[e.bufferGPU,t],this.type=e.type,this.bufferType=e.bufferType,this.pbo=e.pbo,this.byteLength=e.byteLength,this.bytesPerElement=e.BYTES_PER_ELEMENT,this.version=e.version,this.isInteger=e.isInteger,this.activeBufferIndex=0,this.baseId=e.id}get id(){return`${this.baseId}|${this.activeBufferIndex}`}get bufferGPU(){return this.buffers[this.activeBufferIndex]}get transformBuffer(){return this.buffers[1^this.activeBufferIndex]}switchBuffers(){this.activeBufferIndex^=1}},AN=class{constructor(e){this.backend=e}createAttribute(e,t){const s=this.backend,{gl:i}=s,r=e.array,n=e.usage||i.STATIC_DRAW,a=e.isInterleavedBufferAttribute?e.data:e,o=s.get(a);let l,h=o.bufferGPU;if(void 0===h&&(h=this._createBuffer(i,t,r,n),o.bufferGPU=h,o.bufferType=t,o.version=a.version),r instanceof Float32Array)l=i.FLOAT;else if("undefined"!=typeof Float16Array&&r instanceof Float16Array)l=i.HALF_FLOAT;else if(r instanceof Uint16Array)l=e.isFloat16BufferAttribute?i.HALF_FLOAT:i.UNSIGNED_SHORT;else if(r instanceof Int16Array)l=i.SHORT;else if(r instanceof Uint32Array)l=i.UNSIGNED_INT;else if(r instanceof Int32Array)l=i.INT;else if(r instanceof Int8Array)l=i.BYTE;else if(r instanceof Uint8Array)l=i.UNSIGNED_BYTE;else{if(!(r instanceof Uint8ClampedArray))throw new Error("THREE.WebGLBackend: Unsupported buffer data format: "+r);l=i.UNSIGNED_BYTE}let u={bufferGPU:h,bufferType:t,type:l,byteLength:r.byteLength,bytesPerElement:r.BYTES_PER_ELEMENT,version:e.version,pbo:e.pbo,isInteger:l===i.INT||l===i.UNSIGNED_INT||e.gpuType===Bt,id:EN++};if(e.isStorageBufferAttribute||e.isStorageInstancedBufferAttribute){const e=this._createBuffer(i,t,r,n);u=new wN(u,e)}s.set(e,u)}updateAttribute(e){const t=this.backend,{gl:s}=t,i=e.array,r=e.isInterleavedBufferAttribute?e.data:e,n=t.get(r),a=n.bufferType,o=e.isInterleavedBufferAttribute?e.data.updateRanges:e.updateRanges;if(s.bindBuffer(a,n.bufferGPU),0===o.length)s.bufferSubData(a,0,i);else{for(let e=0,t=o.length;e<t;e++){const t=o[e];s.bufferSubData(a,t.start*i.BYTES_PER_ELEMENT,i,t.start,t.count)}r.clearUpdateRanges()}s.bindBuffer(a,null),n.version=r.version}destroyAttribute(e){const t=this.backend,{gl:s}=t;e.isInterleavedBufferAttribute&&t.delete(e.data);const i=t.get(e);s.deleteBuffer(i.bufferGPU),t.delete(e)}async getArrayBufferAsync(e){const t=this.backend,{gl:s}=t,i=e.isInterleavedBufferAttribute?e.data:e,{bufferGPU:r}=t.get(i),n=e.array,a=n.byteLength;s.bindBuffer(s.COPY_READ_BUFFER,r);const o=s.createBuffer();s.bindBuffer(s.COPY_WRITE_BUFFER,o),s.bufferData(s.COPY_WRITE_BUFFER,a,s.STREAM_READ),s.copyBufferSubData(s.COPY_READ_BUFFER,s.COPY_WRITE_BUFFER,0,0,a),await t.utils._clientWaitAsync();const l=new e.array.constructor(n.length);return s.bindBuffer(s.COPY_WRITE_BUFFER,o),s.getBufferSubData(s.COPY_WRITE_BUFFER,0,l),s.deleteBuffer(o),s.bindBuffer(s.COPY_READ_BUFFER,null),s.bindBuffer(s.COPY_WRITE_BUFFER,null),l.buffer}_createBuffer(e,t,s,i){const r=e.createBuffer();return e.bindBuffer(t,r),e.bufferData(t,s,i),e.bindBuffer(t,null),r}},RN=class{constructor(e){this.backend=e,this.gl=this.backend.gl,this.enabled={},this.currentFlipSided=null,this.currentCullFace=null,this.currentProgram=null,this.currentBlendingEnabled=!1,this.currentBlending=null,this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null,this.currentPremultipledAlpha=null,this.currentPolygonOffsetFactor=null,this.currentPolygonOffsetUnits=null,this.currentColorMask=null,this.currentDepthFunc=null,this.currentDepthMask=null,this.currentStencilFunc=null,this.currentStencilRef=null,this.currentStencilFuncMask=null,this.currentStencilFail=null,this.currentStencilZFail=null,this.currentStencilZPass=null,this.currentStencilMask=null,this.currentLineWidth=null,this.currentClippingPlanes=0,this.currentVAO=null,this.currentIndex=null,this.currentBoundFramebuffers={},this.currentDrawbuffers=new WeakMap,this.maxTextures=this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),this.currentTextureSlot=null,this.currentBoundTextures={},this.currentBoundBufferBases={},this._init()}_init(){const e=this.gl;NN={[v]:e.FUNC_ADD,[w]:e.FUNC_SUBTRACT,[M]:e.FUNC_REVERSE_SUBTRACT},SN={[A]:e.ZERO,[T]:e.ONE,[z]:e.SRC_COLOR,[I]:e.SRC_ALPHA,[O]:e.SRC_ALPHA_SATURATE,[R]:e.DST_COLOR,[k]:e.DST_ALPHA,[C]:e.ONE_MINUS_SRC_COLOR,[B]:e.ONE_MINUS_SRC_ALPHA,[P]:e.ONE_MINUS_DST_COLOR,[E]:e.ONE_MINUS_DST_ALPHA};const t=e.getParameter(e.SCISSOR_BOX),s=e.getParameter(e.VIEWPORT);this.currentScissor=(new As).fromArray(t),this.currentViewport=(new As).fromArray(s),this._tempVec4=new As}enable(e){const{enabled:t}=this;!0!==t[e]&&(this.gl.enable(e),t[e]=!0)}disable(e){const{enabled:t}=this;!1!==t[e]&&(this.gl.disable(e),t[e]=!1)}setFlipSided(e){if(this.currentFlipSided!==e){const{gl:t}=this;e?t.frontFace(t.CW):t.frontFace(t.CCW),this.currentFlipSided=e}}setCullFace(e){const{gl:t}=this;e!==s2?(this.enable(t.CULL_FACE),e!==this.currentCullFace&&(e===r2?t.cullFace(t.BACK):e===n?t.cullFace(t.FRONT):t.cullFace(t.FRONT_AND_BACK))):this.disable(t.CULL_FACE),this.currentCullFace=e}setLineWidth(e){const{currentLineWidth:t,gl:s}=this;e!==t&&(s.lineWidth(e),this.currentLineWidth=e)}setBlending(e,t,s,i,r,n,a,o){const{gl:l}=this;if(e!==m){if(!1===this.currentBlendingEnabled&&(this.enable(l.BLEND),this.currentBlendingEnabled=!0),e===b)r=r||t,n=n||s,a=a||i,t===this.currentBlendEquation&&r===this.currentBlendEquationAlpha||(l.blendEquationSeparate(NN[t],NN[r]),this.currentBlendEquation=t,this.currentBlendEquationAlpha=r),s===this.currentBlendSrc&&i===this.currentBlendDst&&n===this.currentBlendSrcAlpha&&a===this.currentBlendDstAlpha||(l.blendFuncSeparate(SN[s],SN[i],SN[n],SN[a]),this.currentBlendSrc=s,this.currentBlendDst=i,this.currentBlendSrcAlpha=n,this.currentBlendDstAlpha=a),this.currentBlending=e,this.currentPremultipledAlpha=!1;else if(e!==this.currentBlending||o!==this.currentPremultipledAlpha){if(this.currentBlendEquation===v&&this.currentBlendEquationAlpha===v||(l.blendEquation(l.FUNC_ADD),this.currentBlendEquation=v,this.currentBlendEquationAlpha=v),o)switch(e){case y:l.blendFuncSeparate(l.ONE,l.ONE_MINUS_SRC_ALPHA,l.ONE,l.ONE_MINUS_SRC_ALPHA);break;case g:l.blendFunc(l.ONE,l.ONE);break;case f2:l.blendFuncSeparate(l.ZERO,l.ONE_MINUS_SRC_COLOR,l.ZERO,l.ONE);break;case x:l.blendFuncSeparate(l.DST_COLOR,l.ONE_MINUS_SRC_ALPHA,l.ZERO,l.ONE);break;default:console.error("THREE.WebGLState: Invalid blending: ",e)}else switch(e){case y:l.blendFuncSeparate(l.SRC_ALPHA,l.ONE_MINUS_SRC_ALPHA,l.ONE,l.ONE_MINUS_SRC_ALPHA);break;case g:l.blendFuncSeparate(l.SRC_ALPHA,l.ONE,l.ONE,l.ONE);break;case f2:console.error("THREE.WebGLState: SubtractiveBlending requires material.premultipliedAlpha = true");break;case x:console.error("THREE.WebGLState: MultiplyBlending requires material.premultipliedAlpha = true");break;default:console.error("THREE.WebGLState: Invalid blending: ",e)}this.currentBlendSrc=null,this.currentBlendDst=null,this.currentBlendSrcAlpha=null,this.currentBlendDstAlpha=null,this.currentBlending=e,this.currentPremultipledAlpha=o}}else!0===this.currentBlendingEnabled&&(this.disable(l.BLEND),this.currentBlendingEnabled=!1)}setColorMask(e){this.currentColorMask!==e&&(this.gl.colorMask(e,e,e,e),this.currentColorMask=e)}setDepthTest(e){const{gl:t}=this;e?this.enable(t.DEPTH_TEST):this.disable(t.DEPTH_TEST)}setDepthMask(e){this.currentDepthMask!==e&&(this.gl.depthMask(e),this.currentDepthMask=e)}setDepthFunc(e){if(this.currentDepthFunc!==e){const{gl:t}=this;switch(e){case j:t.depthFunc(t.NEVER);break;case W:t.depthFunc(t.ALWAYS);break;case D:t.depthFunc(t.LESS);break;case U:t.depthFunc(t.LEQUAL);break;case H:t.depthFunc(t.EQUAL);break;case q:t.depthFunc(t.GEQUAL);break;case J:t.depthFunc(t.GREATER);break;case X:t.depthFunc(t.NOTEQUAL);break;default:t.depthFunc(t.LEQUAL)}this.currentDepthFunc=e}}scissor(e,t,s,i){const r=this._tempVec4.set(e,t,s,i);if(!1===this.currentScissor.equals(r)){const{gl:e}=this;e.scissor(r.x,r.y,r.z,r.w),this.currentScissor.copy(r)}}viewport(e,t,s,i){const r=this._tempVec4.set(e,t,s,i);if(!1===this.currentViewport.equals(r)){const{gl:e}=this;e.viewport(r.x,r.y,r.z,r.w),this.currentViewport.copy(r)}}setScissorTest(e){const t=this.gl;e?t.enable(t.SCISSOR_TEST):t.disable(t.SCISSOR_TEST)}setStencilTest(e){const{gl:t}=this;e?this.enable(t.STENCIL_TEST):this.disable(t.STENCIL_TEST)}setStencilMask(e){this.currentStencilMask!==e&&(this.gl.stencilMask(e),this.currentStencilMask=e)}setStencilFunc(e,t,s){this.currentStencilFunc===e&&this.currentStencilRef===t&&this.currentStencilFuncMask===s||(this.gl.stencilFunc(e,t,s),this.currentStencilFunc=e,this.currentStencilRef=t,this.currentStencilFuncMask=s)}setStencilOp(e,t,s){this.currentStencilFail===e&&this.currentStencilZFail===t&&this.currentStencilZPass===s||(this.gl.stencilOp(e,t,s),this.currentStencilFail=e,this.currentStencilZFail=t,this.currentStencilZPass=s)}setMaterial(e,t,s){const{gl:i}=this;e.side===p?this.disable(i.CULL_FACE):this.enable(i.CULL_FACE);let r=e.side===d2;t&&(r=!r),this.setFlipSided(r),e.blending===y&&!1===e.transparent?this.setBlending(m):this.setBlending(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.premultipliedAlpha),this.setDepthFunc(e.depthFunc),this.setDepthTest(e.depthTest),this.setDepthMask(e.depthWrite),this.setColorMask(e.colorWrite);const n=e.stencilWrite;if(this.setStencilTest(n),n&&(this.setStencilMask(e.stencilWriteMask),this.setStencilFunc(e.stencilFunc,e.stencilRef,e.stencilFuncMask),this.setStencilOp(e.stencilFail,e.stencilZFail,e.stencilZPass)),this.setPolygonOffset(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits),!0===e.alphaToCoverage&&this.backend.renderer.samples>1?this.enable(i.SAMPLE_ALPHA_TO_COVERAGE):this.disable(i.SAMPLE_ALPHA_TO_COVERAGE),s>0&&this.currentClippingPlanes!==s){const e=12288;for(let t=0;t<8;t++)t<s?this.enable(e+t):this.disable(e+t)}}setPolygonOffset(e,t,s){const{gl:i}=this;e?(this.enable(i.POLYGON_OFFSET_FILL),this.currentPolygonOffsetFactor===t&&this.currentPolygonOffsetUnits===s||(i.polygonOffset(t,s),this.currentPolygonOffsetFactor=t,this.currentPolygonOffsetUnits=s)):this.disable(i.POLYGON_OFFSET_FILL)}useProgram(e){return this.currentProgram!==e&&(this.gl.useProgram(e),this.currentProgram=e,!0)}setVertexState(e,t=null){const s=this.gl;return(this.currentVAO!==e||this.currentIndex!==t)&&(s.bindVertexArray(e),null!==t&&s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,t),this.currentVAO=e,this.currentIndex=t,!0)}resetVertexState(){const e=this.gl;e.bindVertexArray(null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),this.currentVAO=null,this.currentIndex=null}bindFramebuffer(e,t){const{gl:s,currentBoundFramebuffers:i}=this;return i[e]!==t&&(s.bindFramebuffer(e,t),i[e]=t,e===s.DRAW_FRAMEBUFFER&&(i[s.FRAMEBUFFER]=t),e===s.FRAMEBUFFER&&(i[s.DRAW_FRAMEBUFFER]=t),!0)}drawBuffers(e,t){const{gl:s}=this;let i=[],r=!1;if(null!==e.textures){i=this.currentDrawbuffers.get(t),void 0===i&&(i=[],this.currentDrawbuffers.set(t,i));const n=e.textures;if(i.length!==n.length||i[0]!==s.COLOR_ATTACHMENT0){for(let e=0,t=n.length;e<t;e++)i[e]=s.COLOR_ATTACHMENT0+e;i.length=n.length,r=!0}}else i[0]!==s.BACK&&(i[0]=s.BACK,r=!0);r&&s.drawBuffers(i)}activeTexture(e){const{gl:t,currentTextureSlot:s,maxTextures:i}=this;void 0===e&&(e=t.TEXTURE0+i-1),s!==e&&(t.activeTexture(e),this.currentTextureSlot=e)}bindTexture(e,t,s){const{gl:i,currentTextureSlot:r,currentBoundTextures:n,maxTextures:a}=this;void 0===s&&(s=null===r?i.TEXTURE0+a-1:r);let o=n[s];void 0===o&&(o={type:void 0,texture:void 0},n[s]=o),o.type===e&&o.texture===t||(r!==s&&(i.activeTexture(s),this.currentTextureSlot=s),i.bindTexture(e,t),o.type=e,o.texture=t)}bindBufferBase(e,t,s){const{gl:i}=this,r=`${e}-${t}`;return this.currentBoundBufferBases[r]!==s&&(i.bindBufferBase(e,t,s),this.currentBoundBufferBases[r]=s,!0)}unbindTexture(){const{gl:e,currentTextureSlot:t,currentBoundTextures:s}=this,i=s[t];void 0!==i&&void 0!==i.type&&(e.bindTexture(i.type,null),i.type=void 0,i.texture=void 0)}},CN=class{constructor(e){this.backend=e,this.gl=this.backend.gl,this.extensions=e.extensions}convert(e,t=Xe){const{gl:s,extensions:i}=this;let r;const n=ms.getTransfer(t);if(e===Tt)return s.UNSIGNED_BYTE;if(e===Pt)return s.UNSIGNED_SHORT_4_4_4_4;if(e===Ot)return s.UNSIGNED_SHORT_5_5_5_1;if(e===Vt)return s.UNSIGNED_INT_5_9_9_9_REV;if(e===zt)return s.BYTE;if(e===Ct)return s.SHORT;if(e===It)return s.UNSIGNED_SHORT;if(e===Bt)return s.INT;if(e===kt)return s.UNSIGNED_INT;if(e===Et)return s.FLOAT;if(e===Rt)return s.HALF_FLOAT;if(e===Ft)return s.ALPHA;if(e===Lt)return s.RGB;if(e===jt)return s.RGBA;if(e===Wt)return s.DEPTH_COMPONENT;if(e===Dt)return s.DEPTH_STENCIL;if(e===Ut)return s.RED;if(e===Ht)return s.RED_INTEGER;if(e===qt)return s.RG;if(e===Jt)return s.RG_INTEGER;if(e===Yt)return s.RGBA_INTEGER;if(e===Zt||e===Gt||e===$t||e===Qt)if(n===$e){if(r=i.get("WEBGL_compressed_texture_s3tc_srgb"),null===r)return null;if(e===Zt)return r.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(e===Gt)return r.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(e===$t)return r.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(e===Qt)return r.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(r=i.get("WEBGL_compressed_texture_s3tc"),null===r)return null;if(e===Zt)return r.COMPRESSED_RGB_S3TC_DXT1_EXT;if(e===Gt)return r.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(e===$t)return r.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(e===Qt)return r.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(e===Kt||e===te||e===ee||e===ie){if(r=i.get("WEBGL_compressed_texture_pvrtc"),null===r)return null;if(e===Kt)return r.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(e===te)return r.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(e===ee)return r.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(e===ie)return r.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(e===se||e===re||e===ne){if(r=i.get("WEBGL_compressed_texture_etc"),null===r)return null;if(e===se||e===re)return n===$e?r.COMPRESSED_SRGB8_ETC2:r.COMPRESSED_RGB8_ETC2;if(e===ne)return n===$e?r.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:r.COMPRESSED_RGBA8_ETC2_EAC}if(e===ae||e===oe||e===he||e===le||e===ce||e===ue||e===de||e===pe||e===me||e===ye||e===ge||e===fe||e===xe||e===be){if(r=i.get("WEBGL_compressed_texture_astc"),null===r)return null;if(e===ae)return n===$e?r.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:r.COMPRESSED_RGBA_ASTC_4x4_KHR;if(e===oe)return n===$e?r.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:r.COMPRESSED_RGBA_ASTC_5x4_KHR;if(e===he)return n===$e?r.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:r.COMPRESSED_RGBA_ASTC_5x5_KHR;if(e===le)return n===$e?r.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:r.COMPRESSED_RGBA_ASTC_6x5_KHR;if(e===ce)return n===$e?r.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:r.COMPRESSED_RGBA_ASTC_6x6_KHR;if(e===ue)return n===$e?r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:r.COMPRESSED_RGBA_ASTC_8x5_KHR;if(e===de)return n===$e?r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:r.COMPRESSED_RGBA_ASTC_8x6_KHR;if(e===pe)return n===$e?r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:r.COMPRESSED_RGBA_ASTC_8x8_KHR;if(e===me)return n===$e?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:r.COMPRESSED_RGBA_ASTC_10x5_KHR;if(e===ye)return n===$e?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:r.COMPRESSED_RGBA_ASTC_10x6_KHR;if(e===ge)return n===$e?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:r.COMPRESSED_RGBA_ASTC_10x8_KHR;if(e===fe)return n===$e?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:r.COMPRESSED_RGBA_ASTC_10x10_KHR;if(e===xe)return n===$e?r.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:r.COMPRESSED_RGBA_ASTC_12x10_KHR;if(e===be)return n===$e?r.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:r.COMPRESSED_RGBA_ASTC_12x12_KHR}if(e===ve){if(r=i.get("EXT_texture_compression_bptc"),null===r)return null;if(e===ve)return n===$e?r.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:r.COMPRESSED_RGBA_BPTC_UNORM_EXT}if(e===Se||e===_e||e===Ae||e===Te){if(r=i.get("EXT_texture_compression_rgtc"),null===r)return null;if(e===ve)return r.COMPRESSED_RED_RGTC1_EXT;if(e===_e)return r.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(e===Ae)return r.COMPRESSED_RED_GREEN_RGTC2_EXT;if(e===Te)return r.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return e===Nt?s.UNSIGNED_INT_24_8:void 0!==s[e]?s[e]:null}_clientWaitAsync(){const{gl:e}=this,t=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0);return e.flush(),new Promise((s,i)=>{!function r(){const n=e.clientWaitSync(t,e.SYNC_FLUSH_COMMANDS_BIT,0);if(n===e.WAIT_FAILED)return e.deleteSync(t),void i();n!==e.TIMEOUT_EXPIRED?(e.deleteSync(t),s()):requestAnimationFrame(r)}()})}},MN,PN,BN,LN=!1,FN=class{constructor(e){this.backend=e,this.gl=e.gl,this.extensions=e.extensions,this.defaultTextures={},!1===LN&&(this._init(),LN=!0)}_init(){const e=this.gl;MN={[pt]:e.REPEAT,[mt]:e.CLAMP_TO_EDGE,[yt]:e.MIRRORED_REPEAT},PN={[gt]:e.NEAREST,[ft]:e.NEAREST_MIPMAP_NEAREST,[bt]:e.NEAREST_MIPMAP_LINEAR,[wt]:e.LINEAR,[Mt]:e.LINEAR_MIPMAP_NEAREST,[_t]:e.LINEAR_MIPMAP_LINEAR},BN={[mi]:e.NEVER,[wi]:e.ALWAYS,[yi]:e.LESS,[fi]:e.LEQUAL,[gi]:e.EQUAL,[vi]:e.GEQUAL,[xi]:e.GREATER,[bi]:e.NOTEQUAL}}getGLTextureType(e){const{gl:t}=this;let s;return s=!0===e.isCubeTexture?t.TEXTURE_CUBE_MAP:!0===e.isArrayTexture||!0===e.isDataArrayTexture||!0===e.isCompressedArrayTexture?t.TEXTURE_2D_ARRAY:!0===e.isData3DTexture?t.TEXTURE_3D:t.TEXTURE_2D,s}getInternalFormat(e,t,s,i,r=!1){const{gl:n,extensions:a}=this;if(null!==e){if(void 0!==n[e])return n[e];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+e+"'")}let o=t;if(t===n.RED&&(s===n.FLOAT&&(o=n.R32F),s===n.HALF_FLOAT&&(o=n.R16F),s===n.UNSIGNED_BYTE&&(o=n.R8),s===n.UNSIGNED_SHORT&&(o=n.R16),s===n.UNSIGNED_INT&&(o=n.R32UI),s===n.BYTE&&(o=n.R8I),s===n.SHORT&&(o=n.R16I),s===n.INT&&(o=n.R32I)),t===n.RED_INTEGER&&(s===n.UNSIGNED_BYTE&&(o=n.R8UI),s===n.UNSIGNED_SHORT&&(o=n.R16UI),s===n.UNSIGNED_INT&&(o=n.R32UI),s===n.BYTE&&(o=n.R8I),s===n.SHORT&&(o=n.R16I),s===n.INT&&(o=n.R32I)),t===n.RG&&(s===n.FLOAT&&(o=n.RG32F),s===n.HALF_FLOAT&&(o=n.RG16F),s===n.UNSIGNED_BYTE&&(o=n.RG8),s===n.UNSIGNED_SHORT&&(o=n.RG16),s===n.UNSIGNED_INT&&(o=n.RG32UI),s===n.BYTE&&(o=n.RG8I),s===n.SHORT&&(o=n.RG16I),s===n.INT&&(o=n.RG32I)),t===n.RG_INTEGER&&(s===n.UNSIGNED_BYTE&&(o=n.RG8UI),s===n.UNSIGNED_SHORT&&(o=n.RG16UI),s===n.UNSIGNED_INT&&(o=n.RG32UI),s===n.BYTE&&(o=n.RG8I),s===n.SHORT&&(o=n.RG16I),s===n.INT&&(o=n.RG32I)),t===n.RGB){const e=r?Ge:ms.getTransfer(i);s===n.FLOAT&&(o=n.RGB32F),s===n.HALF_FLOAT&&(o=n.RGB16F),s===n.UNSIGNED_BYTE&&(o=n.RGB8),s===n.UNSIGNED_SHORT&&(o=n.RGB16),s===n.UNSIGNED_INT&&(o=n.RGB32UI),s===n.BYTE&&(o=n.RGB8I),s===n.SHORT&&(o=n.RGB16I),s===n.INT&&(o=n.RGB32I),s===n.UNSIGNED_BYTE&&(o=e===$e?n.SRGB8:n.RGB8),s===n.UNSIGNED_SHORT_5_6_5&&(o=n.RGB565),s===n.UNSIGNED_SHORT_5_5_5_1&&(o=n.RGB5_A1),s===n.UNSIGNED_SHORT_4_4_4_4&&(o=n.RGB4),s===n.UNSIGNED_INT_5_9_9_9_REV&&(o=n.RGB9_E5)}if(t===n.RGB_INTEGER&&(s===n.UNSIGNED_BYTE&&(o=n.RGB8UI),s===n.UNSIGNED_SHORT&&(o=n.RGB16UI),s===n.UNSIGNED_INT&&(o=n.RGB32UI),s===n.BYTE&&(o=n.RGB8I),s===n.SHORT&&(o=n.RGB16I),s===n.INT&&(o=n.RGB32I)),t===n.RGBA){const e=r?Ge:ms.getTransfer(i);s===n.FLOAT&&(o=n.RGBA32F),s===n.HALF_FLOAT&&(o=n.RGBA16F),s===n.UNSIGNED_BYTE&&(o=n.RGBA8),s===n.UNSIGNED_SHORT&&(o=n.RGBA16),s===n.UNSIGNED_INT&&(o=n.RGBA32UI),s===n.BYTE&&(o=n.RGBA8I),s===n.SHORT&&(o=n.RGBA16I),s===n.INT&&(o=n.RGBA32I),s===n.UNSIGNED_BYTE&&(o=e===$e?n.SRGB8_ALPHA8:n.RGBA8),s===n.UNSIGNED_SHORT_4_4_4_4&&(o=n.RGBA4),s===n.UNSIGNED_SHORT_5_5_5_1&&(o=n.RGB5_A1)}return t===n.RGBA_INTEGER&&(s===n.UNSIGNED_BYTE&&(o=n.RGBA8UI),s===n.UNSIGNED_SHORT&&(o=n.RGBA16UI),s===n.UNSIGNED_INT&&(o=n.RGBA32UI),s===n.BYTE&&(o=n.RGBA8I),s===n.SHORT&&(o=n.RGBA16I),s===n.INT&&(o=n.RGBA32I)),t===n.DEPTH_COMPONENT&&(s===n.UNSIGNED_SHORT&&(o=n.DEPTH_COMPONENT16),s===n.UNSIGNED_INT&&(o=n.DEPTH_COMPONENT24),s===n.FLOAT&&(o=n.DEPTH_COMPONENT32F)),t===n.DEPTH_STENCIL&&s===n.UNSIGNED_INT_24_8&&(o=n.DEPTH24_STENCIL8),o!==n.R16F&&o!==n.R32F&&o!==n.RG16F&&o!==n.RG32F&&o!==n.RGBA16F&&o!==n.RGBA32F||a.get("EXT_color_buffer_float"),o}setTextureParameters(e,t){const{gl:s,extensions:i,backend:r}=this,n=ms.getPrimaries(ms.workingColorSpace),a=t.colorSpace===Xe?null:ms.getPrimaries(t.colorSpace),o=t.colorSpace===Xe||n===a?s.NONE:s.BROWSER_DEFAULT_WEBGL;s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,t.flipY),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),s.pixelStorei(s.UNPACK_ALIGNMENT,t.unpackAlignment),s.pixelStorei(s.UNPACK_COLORSPACE_CONVERSION_WEBGL,o),s.texParameteri(e,s.TEXTURE_WRAP_S,MN[t.wrapS]),s.texParameteri(e,s.TEXTURE_WRAP_T,MN[t.wrapT]),e!==s.TEXTURE_3D&&e!==s.TEXTURE_2D_ARRAY||t.isArrayTexture||s.texParameteri(e,s.TEXTURE_WRAP_R,MN[t.wrapR]),s.texParameteri(e,s.TEXTURE_MAG_FILTER,PN[t.magFilter]);const l=void 0!==t.mipmaps&&t.mipmaps.length>0,h=t.minFilter===wt&&l?_t:t.minFilter;if(s.texParameteri(e,s.TEXTURE_MIN_FILTER,PN[h]),t.compareFunction&&(s.texParameteri(e,s.TEXTURE_COMPARE_MODE,s.COMPARE_REF_TO_TEXTURE),s.texParameteri(e,s.TEXTURE_COMPARE_FUNC,BN[t.compareFunction])),!0===i.has("EXT_texture_filter_anisotropic")){if(t.magFilter===gt)return;if(t.minFilter!==bt&&t.minFilter!==_t)return;if(t.type===Et&&!1===i.has("OES_texture_float_linear"))return;if(t.anisotropy>1){const n=i.get("EXT_texture_filter_anisotropic");s.texParameterf(e,n.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(t.anisotropy,r.getMaxAnisotropy()))}}}createDefaultTexture(e){const{gl:t,backend:s,defaultTextures:i}=this,r=this.getGLTextureType(e);let n=i[r];void 0===n&&(n=t.createTexture(),s.state.bindTexture(r,n),t.texParameteri(r,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(r,t.TEXTURE_MAG_FILTER,t.NEAREST),i[r]=n),s.set(e,{textureGPU:n,glTextureType:r,isDefault:!0})}createTexture(e,t){const{gl:s,backend:i}=this,{levels:r,width:n,height:a,depth:o}=t,l=i.utils.convert(e.format,e.colorSpace),h=i.utils.convert(e.type),u=this.getInternalFormat(e.internalFormat,l,h,e.colorSpace,e.isVideoTexture),c=s.createTexture(),d=this.getGLTextureType(e);i.state.bindTexture(d,c),this.setTextureParameters(d,e),e.isArrayTexture||e.isDataArrayTexture||e.isCompressedArrayTexture?s.texStorage3D(s.TEXTURE_2D_ARRAY,r,u,n,a,o):e.isData3DTexture?s.texStorage3D(s.TEXTURE_3D,r,u,n,a,o):e.isVideoTexture||s.texStorage2D(d,r,u,n,a),i.set(e,{textureGPU:c,glTextureType:d,glFormat:l,glType:h,glInternalFormat:u})}copyBufferToTexture(e,t){const{gl:s,backend:i}=this,{textureGPU:r,glTextureType:n,glFormat:a,glType:o}=i.get(t),{width:l,height:h}=t.source.data;s.bindBuffer(s.PIXEL_UNPACK_BUFFER,e),i.state.bindTexture(n,r),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!1),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),s.texSubImage2D(n,0,0,0,l,h,a,o,0),s.bindBuffer(s.PIXEL_UNPACK_BUFFER,null),i.state.unbindTexture()}updateTexture(e,t){const{gl:s}=this,{width:i,height:r}=t,{textureGPU:n,glTextureType:a,glFormat:o,glType:l,glInternalFormat:h}=this.backend.get(e);if(!e.isRenderTargetTexture&&void 0!==n)if(this.backend.state.bindTexture(a,n),this.setTextureParameters(a,e),e.isCompressedTexture){const i=e.mipmaps,r=t.image;for(let t=0;t<i.length;t++){const n=i[t];e.isCompressedArrayTexture?e.format!==s.RGBA?null!==o?s.compressedTexSubImage3D(s.TEXTURE_2D_ARRAY,t,0,0,0,n.width,n.height,r.depth,o,n.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):s.texSubImage3D(s.TEXTURE_2D_ARRAY,t,0,0,0,n.width,n.height,r.depth,o,l,n.data):null!==o?s.compressedTexSubImage2D(s.TEXTURE_2D,t,0,0,n.width,n.height,o,n.data):console.warn("Unsupported compressed texture format")}}else if(e.isCubeTexture){const e=t.images;for(let t=0;t<6;t++){const n=IN(e[t]);s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,i,r,o,l,n)}}else if(e.isDataArrayTexture||e.isArrayTexture){const e=t.image;s.texSubImage3D(s.TEXTURE_2D_ARRAY,0,0,0,0,e.width,e.height,e.depth,o,l,e.data)}else if(e.isData3DTexture){const e=t.image;s.texSubImage3D(s.TEXTURE_3D,0,0,0,0,e.width,e.height,e.depth,o,l,e.data)}else if(e.isVideoTexture)e.update(),s.texImage2D(a,0,h,o,l,t.image);else{const e=IN(t.image);s.texSubImage2D(a,0,0,0,i,r,o,l,e)}}generateMipmaps(e){const{gl:t,backend:s}=this,{textureGPU:i,glTextureType:r}=s.get(e);s.state.bindTexture(r,i),t.generateMipmap(r)}deallocateRenderBuffers(e){const{gl:t,backend:s}=this;if(e){const i=s.get(e);if(i.renderBufferStorageSetup=void 0,i.framebuffers){for(const e in i.framebuffers)t.deleteFramebuffer(i.framebuffers[e]);delete i.framebuffers}if(i.depthRenderbuffer&&(t.deleteRenderbuffer(i.depthRenderbuffer),delete i.depthRenderbuffer),i.stencilRenderbuffer&&(t.deleteRenderbuffer(i.stencilRenderbuffer),delete i.stencilRenderbuffer),i.msaaFrameBuffer&&(t.deleteFramebuffer(i.msaaFrameBuffer),delete i.msaaFrameBuffer),i.msaaRenderbuffers){for(let e=0;e<i.msaaRenderbuffers.length;e++)t.deleteRenderbuffer(i.msaaRenderbuffers[e]);delete i.msaaRenderbuffers}}}destroyTexture(e){const{gl:t,backend:s}=this,{textureGPU:i,renderTarget:r}=s.get(e);this.deallocateRenderBuffers(r),t.deleteTexture(i),s.delete(e)}copyTextureToTexture(e,t,s=null,i=null,r=0,n=0){const{gl:a,backend:o}=this,{state:l}=this.backend,{textureGPU:h,glTextureType:u,glType:c,glFormat:d}=o.get(t);let p,_,m,f,g,y,S,T,x;l.bindTexture(u,h);const b=e.isCompressedTexture?e.mipmaps[n]:e.image;if(null!==s)p=s.max.x-s.min.x,_=s.max.y-s.min.y,m=s.isBox3?s.max.z-s.min.z:1,f=s.min.x,g=s.min.y,y=s.isBox3?s.min.z:0;else{const t=Math.pow(2,-r);p=Math.floor(b.width*t),_=Math.floor(b.height*t),m=e.isDataArrayTexture||e.isArrayTexture?b.depth:e.isData3DTexture?Math.floor(b.depth*t):1,f=0,g=0,y=0}null!==i?(S=i.x,T=i.y,x=i.z):(S=0,T=0,x=0),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,t.flipY),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),a.pixelStorei(a.UNPACK_ALIGNMENT,t.unpackAlignment);const G=a.getParameter(a.UNPACK_ROW_LENGTH),I=a.getParameter(a.UNPACK_IMAGE_HEIGHT),v=a.getParameter(a.UNPACK_SKIP_PIXELS),C=a.getParameter(a.UNPACK_SKIP_ROWS),w=a.getParameter(a.UNPACK_SKIP_IMAGES);a.pixelStorei(a.UNPACK_ROW_LENGTH,b.width),a.pixelStorei(a.UNPACK_IMAGE_HEIGHT,b.height),a.pixelStorei(a.UNPACK_SKIP_PIXELS,f),a.pixelStorei(a.UNPACK_SKIP_ROWS,g),a.pixelStorei(a.UNPACK_SKIP_IMAGES,y);const A=t.isDataArrayTexture||t.isData3DTexture||t.isArrayTexture;if(e.isRenderTargetTexture||e.isDepthTexture){const s=o.get(e),i=o.get(t),r=o.get(s.renderTarget),n=o.get(i.renderTarget),h=r.framebuffers[s.cacheKey],u=n.framebuffers[i.cacheKey];l.bindFramebuffer(a.READ_FRAMEBUFFER,h),l.bindFramebuffer(a.DRAW_FRAMEBUFFER,u);let c=a.COLOR_BUFFER_BIT;e.isDepthTexture&&(c=a.DEPTH_BUFFER_BIT),a.blitFramebuffer(f,g,p,_,S,T,p,_,c,a.NEAREST),l.bindFramebuffer(a.READ_FRAMEBUFFER,null),l.bindFramebuffer(a.DRAW_FRAMEBUFFER,null)}else A?e.isDataTexture||e.isData3DTexture?a.texSubImage3D(u,n,S,T,x,p,_,m,d,c,b.data):t.isCompressedArrayTexture?a.compressedTexSubImage3D(u,n,S,T,x,p,_,m,d,b.data):a.texSubImage3D(u,n,S,T,x,p,_,m,d,c,b):e.isDataTexture?a.texSubImage2D(u,n,S,T,p,_,d,c,b.data):e.isCompressedTexture?a.compressedTexSubImage2D(u,n,S,T,b.width,b.height,d,b.data):a.texSubImage2D(u,n,S,T,p,_,d,c,b);a.pixelStorei(a.UNPACK_ROW_LENGTH,G),a.pixelStorei(a.UNPACK_IMAGE_HEIGHT,I),a.pixelStorei(a.UNPACK_SKIP_PIXELS,v),a.pixelStorei(a.UNPACK_SKIP_ROWS,C),a.pixelStorei(a.UNPACK_SKIP_IMAGES,w),0===n&&t.generateMipmaps&&a.generateMipmap(u),l.unbindTexture()}copyFramebufferToTexture(e,t,s){const{gl:i}=this,{state:r}=this.backend,{textureGPU:n}=this.backend.get(e),{x:a,y:o,z:l,w:h}=s,u=!0===e.isDepthTexture||t.renderTarget&&t.renderTarget.samples>0,c=t.renderTarget?t.renderTarget.height:this.backend.getDrawingBufferSize().y;if(u){const s=0!==a||0!==o;let u,d;if(!0===e.isDepthTexture?(u=i.DEPTH_BUFFER_BIT,d=i.DEPTH_ATTACHMENT,t.stencil&&(u|=i.STENCIL_BUFFER_BIT)):(u=i.COLOR_BUFFER_BIT,d=i.COLOR_ATTACHMENT0),s){const e=this.backend.get(t.renderTarget),s=e.framebuffers[t.getCacheKey()],d=e.msaaFrameBuffer;r.bindFramebuffer(i.DRAW_FRAMEBUFFER,s),r.bindFramebuffer(i.READ_FRAMEBUFFER,d);const p=c-o-h;i.blitFramebuffer(a,p,a+l,p+h,a,p,a+l,p+h,u,i.NEAREST),r.bindFramebuffer(i.READ_FRAMEBUFFER,s),r.bindTexture(i.TEXTURE_2D,n),i.copyTexSubImage2D(i.TEXTURE_2D,0,0,0,a,p,l,h),r.unbindTexture()}else{const e=i.createFramebuffer();r.bindFramebuffer(i.DRAW_FRAMEBUFFER,e),i.framebufferTexture2D(i.DRAW_FRAMEBUFFER,d,i.TEXTURE_2D,n,0),i.blitFramebuffer(0,0,l,h,0,0,l,h,u,i.NEAREST),i.deleteFramebuffer(e)}}else r.bindTexture(i.TEXTURE_2D,n),i.copyTexSubImage2D(i.TEXTURE_2D,0,0,0,a,c-h-o,l,h),r.unbindTexture();e.generateMipmaps&&this.generateMipmaps(e),this.backend._setFramebuffer(t)}setupRenderBufferStorage(e,t,s,i=!1){const{gl:r}=this,n=t.renderTarget,{depthTexture:a,depthBuffer:o,stencilBuffer:l,width:h,height:u}=n;if(r.bindRenderbuffer(r.RENDERBUFFER,e),o&&!l){let t=r.DEPTH_COMPONENT24;!0===i?this.extensions.get("WEBGL_multisampled_render_to_texture").renderbufferStorageMultisampleEXT(r.RENDERBUFFER,n.samples,t,h,u):s>0?(a&&a.isDepthTexture&&a.type===r.FLOAT&&(t=r.DEPTH_COMPONENT32F),r.renderbufferStorageMultisample(r.RENDERBUFFER,s,t,h,u)):r.renderbufferStorage(r.RENDERBUFFER,t,h,u),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,e)}else o&&l&&(s>0?r.renderbufferStorageMultisample(r.RENDERBUFFER,s,r.DEPTH24_STENCIL8,h,u):r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_STENCIL,h,u),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.RENDERBUFFER,e));r.bindRenderbuffer(r.RENDERBUFFER,null)}async copyTextureToBuffer(e,t,s,i,r,n){const{backend:a,gl:o}=this,{textureGPU:l,glFormat:h,glType:u}=this.backend.get(e),c=o.createFramebuffer();o.bindFramebuffer(o.READ_FRAMEBUFFER,c);const d=e.isCubeTexture?o.TEXTURE_CUBE_MAP_POSITIVE_X+n:o.TEXTURE_2D;o.framebufferTexture2D(o.READ_FRAMEBUFFER,o.COLOR_ATTACHMENT0,d,l,0);const p=this._getTypedArrayType(u),_=i*r*this._getBytesPerTexel(u,h),m=o.createBuffer();o.bindBuffer(o.PIXEL_PACK_BUFFER,m),o.bufferData(o.PIXEL_PACK_BUFFER,_,o.STREAM_READ),o.readPixels(t,s,i,r,h,u,0),o.bindBuffer(o.PIXEL_PACK_BUFFER,null),await a.utils._clientWaitAsync();const f=new p(_/p.BYTES_PER_ELEMENT);return o.bindBuffer(o.PIXEL_PACK_BUFFER,m),o.getBufferSubData(o.PIXEL_PACK_BUFFER,0,f),o.bindBuffer(o.PIXEL_PACK_BUFFER,null),o.deleteFramebuffer(c),f}_getTypedArrayType(e){const{gl:t}=this;if(e===t.UNSIGNED_BYTE)return Uint8Array;if(e===t.UNSIGNED_SHORT_4_4_4_4)return Uint16Array;if(e===t.UNSIGNED_SHORT_5_5_5_1)return Uint16Array;if(e===t.UNSIGNED_SHORT_5_6_5)return Uint16Array;if(e===t.UNSIGNED_SHORT)return Uint16Array;if(e===t.UNSIGNED_INT)return Uint32Array;if(e===t.HALF_FLOAT)return Uint16Array;if(e===t.FLOAT)return Float32Array;throw new Error(`Unsupported WebGL type: ${e}`)}_getBytesPerTexel(e,t){const{gl:s}=this;let i=0;return e===s.UNSIGNED_BYTE&&(i=1),e!==s.UNSIGNED_SHORT_4_4_4_4&&e!==s.UNSIGNED_SHORT_5_5_5_1&&e!==s.UNSIGNED_SHORT_5_6_5&&e!==s.UNSIGNED_SHORT&&e!==s.HALF_FLOAT||(i=2),e!==s.UNSIGNED_INT&&e!==s.FLOAT||(i=4),t===s.RGBA?4*i:t===s.RGB?3*i:t===s.ALPHA?i:void 0}};function IN(e){return e.isDataTexture?e.image.data:"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas?e:e.data}var DN=class{constructor(e){this.backend=e,this.gl=this.backend.gl,this.availableExtensions=this.gl.getSupportedExtensions(),this.extensions={}}get(e){let t=this.extensions[e];return void 0===t&&(t=this.gl.getExtension(e),this.extensions[e]=t),t}has(e){return this.availableExtensions.includes(e)}},VN=class{constructor(e){this.backend=e,this.maxAnisotropy=null}getMaxAnisotropy(){if(null!==this.maxAnisotropy)return this.maxAnisotropy;const e=this.backend.gl,t=this.backend.extensions;if(!0===t.has("EXT_texture_filter_anisotropic")){const s=t.get("EXT_texture_filter_anisotropic");this.maxAnisotropy=e.getParameter(s.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else this.maxAnisotropy=0;return this.maxAnisotropy}},UN={WEBGL_multi_draw:"WEBGL_multi_draw",WEBGL_compressed_texture_astc:"texture-compression-astc",WEBGL_compressed_texture_etc:"texture-compression-etc2",WEBGL_compressed_texture_etc1:"texture-compression-etc1",WEBGL_compressed_texture_pvrtc:"texture-compression-pvrtc",WEBKIT_WEBGL_compressed_texture_pvrtc:"texture-compression-pvrtc",WEBGL_compressed_texture_s3tc:"texture-compression-bc",EXT_texture_compression_bptc:"texture-compression-bptc",EXT_disjoint_timer_query_webgl2:"timestamp-query",OVR_multiview2:"OVR_multiview2"},ON=class{constructor(e){this.gl=e.gl,this.extensions=e.extensions,this.info=e.renderer.info,this.mode=null,this.index=0,this.type=null,this.object=null}render(e,t){const{gl:s,mode:i,object:r,type:n,info:a,index:o}=this;0!==o?s.drawElements(i,t,n,e):s.drawArrays(i,e,t),a.update(r,t,1)}renderInstances(e,t,s){const{gl:i,mode:r,type:n,index:a,object:o,info:l}=this;0!==s&&(0!==a?i.drawElementsInstanced(r,t,n,e,s):i.drawArraysInstanced(r,e,t,s),l.update(o,t,s))}renderMultiDraw(e,t,s){const{extensions:i,mode:r,object:n,info:a}=this;if(0===s)return;const o=i.get("WEBGL_multi_draw");if(null===o)for(let i=0;i<s;i++)this.render(e[i],t[i]);else{0!==this.index?o.multiDrawElementsWEBGL(r,t,0,this.type,e,0,s):o.multiDrawArraysWEBGL(r,e,0,t,0,s);let i=0;for(let e=0;e<s;e++)i+=t[e];a.update(n,i,1)}}renderMultiDrawInstances(e,t,s,i){const{extensions:r,mode:n,object:a,info:o}=this;if(0===s)return;const l=r.get("WEBGL_multi_draw");if(null===l)for(let r=0;r<s;r++)this.renderInstances(e[r],t[r],i[r]);else{0!==this.index?l.multiDrawElementsInstancedWEBGL(n,t,0,this.type,e,0,i,0,s):l.multiDrawArraysInstancedWEBGL(n,e,0,t,0,i,0,s);let r=0;for(let e=0;e<s;e++)r+=t[e]*i[e];o.update(a,r,1)}}},kN=class{constructor(e=256){this.trackTimestamp=!0,this.maxQueries=e,this.currentQueryIndex=0,this.queryOffsets=new Map,this.isDisposed=!1,this.lastValue=0,this.pendingResolve=!1}allocateQueriesForContext(){}async resolveQueriesAsync(){}dispose(){}},GN=class extends kN{constructor(e,t,s=2048){if(super(s),this.gl=e,this.type=t,this.ext=e.getExtension("EXT_disjoint_timer_query_webgl2")||e.getExtension("EXT_disjoint_timer_query"),!this.ext)return console.warn("EXT_disjoint_timer_query not supported; timestamps will be disabled."),void(this.trackTimestamp=!1);this.queries=[];for(let t=0;t<this.maxQueries;t++)this.queries.push(e.createQuery());this.activeQuery=null,this.queryStates=new Map}allocateQueriesForContext(e){if(!this.trackTimestamp)return null;if(this.currentQueryIndex+2>this.maxQueries)return ls(`WebGPUTimestampQueryPool [${this.type}]: Maximum number of queries exceeded, when using trackTimestamp it is necessary to resolves the queries via renderer.resolveTimestampsAsync( THREE.TimestampQuery.${this.type.toUpperCase()} ).`),null;const t=this.currentQueryIndex;return this.currentQueryIndex+=2,this.queryStates.set(t,"inactive"),this.queryOffsets.set(e.id,t),t}beginQuery(e){if(!this.trackTimestamp||this.isDisposed)return;const t=this.queryOffsets.get(e.id);if(null==t)return;if(null!==this.activeQuery)return;const s=this.queries[t];if(s)try{"inactive"===this.queryStates.get(t)&&(this.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,s),this.activeQuery=t,this.queryStates.set(t,"started"))}catch(e){console.error("Error in beginQuery:",e),this.activeQuery=null,this.queryStates.set(t,"inactive")}}endQuery(e){if(!this.trackTimestamp||this.isDisposed)return;const t=this.queryOffsets.get(e.id);if(null!=t&&this.activeQuery===t)try{this.gl.endQuery(this.ext.TIME_ELAPSED_EXT),this.queryStates.set(t,"ended"),this.activeQuery=null}catch(e){console.error("Error in endQuery:",e),this.queryStates.set(t,"inactive"),this.activeQuery=null}}async resolveQueriesAsync(){if(!this.trackTimestamp||this.pendingResolve)return this.lastValue;this.pendingResolve=!0;try{const e=[];for(const[t,s]of this.queryStates)if("ended"===s){const s=this.queries[t];e.push(this.resolveQuery(s))}if(0===e.length)return this.lastValue;const t=(await Promise.all(e)).reduce((e,t)=>e+t,0);return this.lastValue=t,this.currentQueryIndex=0,this.queryOffsets.clear(),this.queryStates.clear(),this.activeQuery=null,t}catch(e){return console.error("Error resolving queries:",e),this.lastValue}finally{this.pendingResolve=!1}}async resolveQuery(e){return new Promise(t=>{if(this.isDisposed)return void t(this.lastValue);let s,i=!1;const r=e=>{i||(i=!0,s&&(clearTimeout(s),s=null),t(e))},n=()=>{if(this.isDisposed)r(this.lastValue);else try{if(this.gl.getParameter(this.ext.GPU_DISJOINT_EXT))return void r(this.lastValue);if(!this.gl.getQueryParameter(e,this.gl.QUERY_RESULT_AVAILABLE))return void(s=setTimeout(n,1));const i=this.gl.getQueryParameter(e,this.gl.QUERY_RESULT);t(Number(i)/1e6)}catch(e){console.error("Error checking query:",e),t(this.lastValue)}};n()})}dispose(){if(!this.isDisposed&&(this.isDisposed=!0,this.trackTimestamp)){for(const e of this.queries)this.gl.deleteQuery(e);this.queries=[],this.queryStates.clear(),this.queryOffsets.clear(),this.lastValue=0,this.activeQuery=null}}},zN=class extends vN{constructor(e={}){super(e),this.isWebGLBackend=!0,this.attributeUtils=null,this.extensions=null,this.capabilities=null,this.textureUtils=null,this.bufferRenderer=null,this.gl=null,this.state=null,this.utils=null,this.vaoCache={},this.transformFeedbackCache={},this.discard=!1,this.disjoint=null,this.parallel=null,this._currentContext=null,this._knownBindings=new WeakSet,this._supportsInvalidateFramebuffer="undefined"!=typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),this._xrFramebuffer=null}init(e){super.init(e);const t=this.parameters,s={antialias:e.samples>0,alpha:!0,depth:e.depth,stencil:e.stencil},i=void 0!==t.context?t.context:e.domElement.getContext("webgl2",s);function r(t){t.preventDefault();const s={api:"WebGL",message:t.statusMessage||"Unknown reason",reason:null,originalEvent:t};e.onDeviceLost(s)}this._onContextLost=r,e.domElement.addEventListener("webglcontextlost",r,!1),this.gl=i,this.extensions=new DN(this),this.capabilities=new VN(this),this.attributeUtils=new AN(this),this.textureUtils=new FN(this),this.bufferRenderer=new ON(this),this.state=new RN(this),this.utils=new CN(this),this.extensions.get("EXT_color_buffer_float"),this.extensions.get("WEBGL_clip_cull_distance"),this.extensions.get("OES_texture_float_linear"),this.extensions.get("EXT_color_buffer_half_float"),this.extensions.get("WEBGL_multisampled_render_to_texture"),this.extensions.get("WEBGL_render_shared_exponent"),this.extensions.get("WEBGL_multi_draw"),this.extensions.get("OVR_multiview2"),this.disjoint=this.extensions.get("EXT_disjoint_timer_query_webgl2"),this.parallel=this.extensions.get("KHR_parallel_shader_compile")}get coordinateSystem(){return Ri}async getArrayBufferAsync(e){return await this.attributeUtils.getArrayBufferAsync(e)}async waitForGPU(){await this.utils._clientWaitAsync()}async makeXRCompatible(){!0!==this.gl.getContextAttributes().xrCompatible&&await this.gl.makeXRCompatible()}setXRTarget(e){this._xrFramebuffer=e}setXRRenderTargetTextures(e,t,s=null){const i=this.gl;if(this.set(e.texture,{textureGPU:t,glInternalFormat:i.RGBA8}),null!==s){const t=e.stencilBuffer?i.DEPTH24_STENCIL8:i.DEPTH_COMPONENT24;this.set(e.depthTexture,{textureGPU:s,glInternalFormat:t}),!0===this.extensions.has("WEBGL_multisampled_render_to_texture")&&!0===e._autoAllocateDepthBuffer&&!1===e.multiview&&console.warn("THREE.WebGLBackend: Render-to-texture extension was disabled because an external texture was provided"),e._autoAllocateDepthBuffer=!1}}initTimestampQuery(e){if(!this.disjoint||!this.trackTimestamp)return;const t=e.isComputeNode?"compute":"render";this.timestampQueryPool[t]||(this.timestampQueryPool[t]=new GN(this.gl,t,2048));const s=this.timestampQueryPool[t];null!==s.allocateQueriesForContext(e)&&s.beginQuery(e)}prepareTimestampBuffer(e){if(!this.disjoint||!this.trackTimestamp)return;const t=e.isComputeNode?"compute":"render";this.timestampQueryPool[t].endQuery(e)}getContext(){return this.gl}beginRender(e){const{state:t}=this,s=this.get(e);if(e.viewport)this.updateViewport(e);else{const{width:e,height:s}=this.getDrawingBufferSize();t.viewport(0,0,e,s)}if(e.scissor){const{x:s,y:i,width:r,height:n}=e.scissorValue;t.scissor(s,e.height-n-i,r,n)}this.initTimestampQuery(e),s.previousContext=this._currentContext,this._currentContext=e,this._setFramebuffer(e),this.clear(e.clearColor,e.clearDepth,e.clearStencil,e,!1);const i=e.occlusionQueryCount;i>0&&(s.currentOcclusionQueries=s.occlusionQueries,s.currentOcclusionQueryObjects=s.occlusionQueryObjects,s.lastOcclusionObject=null,s.occlusionQueries=new Array(i),s.occlusionQueryObjects=new Array(i),s.occlusionQueryIndex=0)}finishRender(e){const{gl:t,state:s}=this,i=this.get(e),r=i.previousContext;s.resetVertexState();const n=e.occlusionQueryCount;n>0&&(n>i.occlusionQueryIndex&&t.endQuery(t.ANY_SAMPLES_PASSED),this.resolveOccludedAsync(e));const a=e.textures;if(null!==a)for(let e=0;e<a.length;e++){const t=a[e];t.generateMipmaps&&this.generateMipmaps(t)}this._currentContext=r;const o=e.renderTarget;if(null!==e.textures&&o){const i=this.get(o);if(o.samples>0&&!1===this._useMultisampledExtension(o)){const r=i.framebuffers[e.getCacheKey()];let n=t.COLOR_BUFFER_BIT;o.resolveDepthBuffer&&(o.depthBuffer&&(n|=t.DEPTH_BUFFER_BIT),o.stencilBuffer&&o.resolveStencilBuffer&&(n|=t.STENCIL_BUFFER_BIT));const a=i.msaaFrameBuffer,l=i.msaaRenderbuffers,h=e.textures,u=h.length>1;if(s.bindFramebuffer(t.READ_FRAMEBUFFER,a),s.bindFramebuffer(t.DRAW_FRAMEBUFFER,r),u)for(let e=0;e<h.length;e++)t.framebufferRenderbuffer(t.READ_FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.RENDERBUFFER,null),t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,null,0);for(let s=0;s<h.length;s++){if(u){const{textureGPU:e}=this.get(h[s]);t.framebufferRenderbuffer(t.READ_FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,l[s]),t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,0)}if(e.scissor){const{x:s,y:i,width:r,height:a}=e.scissorValue,o=e.height-a-i;t.blitFramebuffer(s,o,s+r,o+a,s,o,s+r,o+a,n,t.NEAREST)}else t.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,n,t.NEAREST)}if(u)for(let e=0;e<h.length;e++){const{textureGPU:s}=this.get(h[e]);t.framebufferRenderbuffer(t.READ_FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.RENDERBUFFER,l[e]),t.framebufferTexture2D(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0+e,t.TEXTURE_2D,s,0)}!0===this._supportsInvalidateFramebuffer&&t.invalidateFramebuffer(t.READ_FRAMEBUFFER,i.invalidationArray)}else if(!1===o.resolveDepthBuffer&&i.framebuffers){const r=i.framebuffers[e.getCacheKey()];s.bindFramebuffer(t.DRAW_FRAMEBUFFER,r),t.invalidateFramebuffer(t.DRAW_FRAMEBUFFER,i.depthInvalidationArray)}}if(null!==r)if(this._setFramebuffer(r),r.viewport)this.updateViewport(r);else{const{width:e,height:t}=this.getDrawingBufferSize();s.viewport(0,0,e,t)}this.prepareTimestampBuffer(e)}resolveOccludedAsync(e){const t=this.get(e),{currentOcclusionQueries:s,currentOcclusionQueryObjects:i}=t;if(s&&i){const e=new WeakSet,{gl:r}=this;t.currentOcclusionQueryObjects=null,t.currentOcclusionQueries=null;const n=()=>{let a=0;for(let t=0;t<s.length;t++){const n=s[t];null!==n&&r.getQueryParameter(n,r.QUERY_RESULT_AVAILABLE)&&(0===r.getQueryParameter(n,r.QUERY_RESULT)&&e.add(i[t]),s[t]=null,r.deleteQuery(n),a++)}a<s.length?requestAnimationFrame(n):t.occluded=e};n()}}isOccluded(e,t){const s=this.get(e);return s.occluded&&s.occluded.has(t)}updateViewport(e){const{state:t}=this,{x:s,y:i,width:r,height:n}=e.viewportValue;t.viewport(s,e.height-n-i,r,n)}setScissorTest(e){this.state.setScissorTest(e)}getClearColor(){const e=super.getClearColor();return e.r*=e.a,e.g*=e.a,e.b*=e.a,e}clear(e,t,s,i=null,r=!0){const{gl:n,renderer:a}=this;null===i&&(i={textures:null,clearColorValue:this.getClearColor()});let o=0;if(e&&(o|=n.COLOR_BUFFER_BIT),t&&(o|=n.DEPTH_BUFFER_BIT),s&&(o|=n.STENCIL_BUFFER_BIT),0!==o){let l;l=i.clearColorValue?i.clearColorValue:this.getClearColor();const h=a.getClearDepth(),u=a.getClearStencil();if(t&&this.state.setDepthMask(!0),null===i.textures)n.clearColor(l.r,l.g,l.b,l.a),n.clear(o);else{if(r&&this._setFramebuffer(i),e)for(let e=0;e<i.textures.length;e++)0===e?n.clearBufferfv(n.COLOR,e,[l.r,l.g,l.b,l.a]):n.clearBufferfv(n.COLOR,e,[0,0,0,1]);t&&s?n.clearBufferfi(n.DEPTH_STENCIL,0,h,u):t?n.clearBufferfv(n.DEPTH,0,[h]):s&&n.clearBufferiv(n.STENCIL,0,[u])}}}beginCompute(e){const{state:t,gl:s}=this;t.bindFramebuffer(s.FRAMEBUFFER,null),this.initTimestampQuery(e)}compute(e,t,s,i,r=null){const{state:n,gl:a}=this;!1===this.discard&&(a.enable(a.RASTERIZER_DISCARD),this.discard=!0);const{programGPU:o,transformBuffers:l,attributes:h}=this.get(i),u=this._getVaoKey(h),c=this.vaoCache[u];void 0===c?this.vaoCache[u]=this._createVao(h):n.setVertexState(c),n.useProgram(o),this._bindUniforms(s);const d=this._getTransformFeedback(l);a.bindTransformFeedback(a.TRANSFORM_FEEDBACK,d),a.beginTransformFeedback(a.POINTS),r=null!==r?r:t.count,Array.isArray(r)&&(ls("WebGLBackend.compute(): The count parameter must be a single number, not an array."),r=r[0]),h[0].isStorageInstancedBufferAttribute?a.drawArraysInstanced(a.POINTS,0,1,r):a.drawArrays(a.POINTS,0,r),a.endTransformFeedback(),a.bindTransformFeedback(a.TRANSFORM_FEEDBACK,null);for(let e=0;e<l.length;e++){const t=l[e];t.pbo&&this.has(t.pbo)&&this.textureUtils.copyBufferToTexture(t.transformBuffer,t.pbo),t.switchBuffers()}}finishCompute(e){const t=this.gl;this.discard=!1,t.disable(t.RASTERIZER_DISCARD),this.prepareTimestampBuffer(e),this._currentContext&&this._setFramebuffer(this._currentContext)}_isRenderCameraDepthArray(e){return e.depthTexture&&e.depthTexture.isArrayTexture&&e.camera.isArrayCamera}draw(e){const{object:t,pipeline:s,material:i,context:r,hardwareClippingPlanes:n}=e,{programGPU:a}=this.get(s),{gl:o,state:l}=this,h=this.get(r),u=e.getDrawParameters();if(null===u)return;this._bindUniforms(e.getBindings());const c=t.isMesh&&t.matrixWorld.determinant()<0;l.setMaterial(i,c,n),l.useProgram(a);const d=e.getAttributes(),p=this.get(d);let _=p.vaoGPU;if(void 0===_){const e=this._getVaoKey(d);_=this.vaoCache[e],void 0===_&&(_=this._createVao(d),this.vaoCache[e]=_,p.vaoGPU=_)}const m=e.getIndex(),f=null!==m?this.get(m).bufferGPU:null;l.setVertexState(_,f);const g=h.lastOcclusionObject;if(g!==t&&void 0!==g){if(null!==g&&!0===g.occlusionTest&&(o.endQuery(o.ANY_SAMPLES_PASSED),h.occlusionQueryIndex++),!0===t.occlusionTest){const e=o.createQuery();o.beginQuery(o.ANY_SAMPLES_PASSED,e),h.occlusionQueries[h.occlusionQueryIndex]=e,h.occlusionQueryObjects[h.occlusionQueryIndex]=t}h.lastOcclusionObject=t}const y=this.bufferRenderer;t.isPoints?y.mode=o.POINTS:t.isLineSegments?y.mode=o.LINES:t.isLine?y.mode=o.LINE_STRIP:t.isLineLoop?y.mode=o.LINE_LOOP:!0===i.wireframe?(l.setLineWidth(i.wireframeLinewidth*this.renderer.getPixelRatio()),y.mode=o.LINES):y.mode=o.TRIANGLES;const{vertexCount:S,instanceCount:T}=u;let{firstVertex:x}=u;if(y.object=t,null!==m){x*=m.array.BYTES_PER_ELEMENT;const e=this.get(m);y.index=m.count,y.type=e.type}else y.index=0;const b=()=>{t.isBatchedMesh?null!==t._multiDrawInstances?(ls("THREE.WebGLBackend: renderMultiDrawInstances has been deprecated and will be removed in r184. Append to renderMultiDraw arguments and use indirection."),y.renderMultiDrawInstances(t._multiDrawStarts,t._multiDrawCounts,t._multiDrawCount,t._multiDrawInstances)):this.hasFeature("WEBGL_multi_draw")?y.renderMultiDraw(t._multiDrawStarts,t._multiDrawCounts,t._multiDrawCount):ls("THREE.WebGLRenderer: WEBGL_multi_draw not supported."):T>1?y.renderInstances(x,S,T):y.render(x,S)};if(!0===e.camera.isArrayCamera&&e.camera.cameras.length>0&&!1===e.camera.isMultiViewCamera){const s=this.get(e.camera),i=e.camera.cameras,r=e.getBindingGroup("cameraIndex").bindings[0];if(void 0===s.indexesGPU||s.indexesGPU.length!==i.length){const e=new Uint32Array([0,0,0,0]),t=[];for(let s=0,r=i.length;s<r;s++){const i=o.createBuffer();e[0]=s,o.bindBuffer(o.UNIFORM_BUFFER,i),o.bufferData(o.UNIFORM_BUFFER,e,o.STATIC_DRAW),t.push(i)}s.indexesGPU=t}const n=this.get(r),a=this.renderer.getPixelRatio(),h=this._currentContext.renderTarget,u=this._isRenderCameraDepthArray(this._currentContext),c=this._currentContext.activeCubeFace;if(u){const e=this.get(h.depthTexture);if(e.clearedRenderId!==this.renderer._nodes.nodeFrame.renderId){e.clearedRenderId=this.renderer._nodes.nodeFrame.renderId;const{stencilBuffer:t}=h;for(let e=0,s=i.length;e<s;e++)this.renderer._activeCubeFace=e,this._currentContext.activeCubeFace=e,this._setFramebuffer(this._currentContext),this.clear(!1,!0,t,this._currentContext,!1);this.renderer._activeCubeFace=c,this._currentContext.activeCubeFace=c}}for(let r=0,h=i.length;r<h;r++){const h=i[r];if(t.layers.test(h.layers)){u&&(this.renderer._activeCubeFace=r,this._currentContext.activeCubeFace=r,this._setFramebuffer(this._currentContext));const t=h.viewport;if(void 0!==t){const s=t.x*a,i=t.y*a,r=t.width*a,n=t.height*a;l.viewport(Math.floor(s),Math.floor(e.context.height-n-i),Math.floor(r),Math.floor(n))}l.bindBufferBase(o.UNIFORM_BUFFER,n.index,s.indexesGPU[r]),b()}this._currentContext.activeCubeFace=c,this.renderer._activeCubeFace=c}}else b()}needsRenderUpdate(){return!1}getRenderCacheKey(){return""}createDefaultTexture(e){this.textureUtils.createDefaultTexture(e)}createTexture(e,t){this.textureUtils.createTexture(e,t)}updateTexture(e,t){this.textureUtils.updateTexture(e,t)}generateMipmaps(e){this.textureUtils.generateMipmaps(e)}destroyTexture(e){this.textureUtils.destroyTexture(e)}async copyTextureToBuffer(e,t,s,i,r,n){return this.textureUtils.copyTextureToBuffer(e,t,s,i,r,n)}createSampler(){}destroySampler(){}createNodeBuilder(e,t){return new xN(e,t)}createProgram(e){const t=this.gl,{stage:s,code:i}=e,r="fragment"===s?t.createShader(t.FRAGMENT_SHADER):t.createShader(t.VERTEX_SHADER);t.shaderSource(r,i),t.compileShader(r),this.set(e,{shaderGPU:r})}destroyProgram(e){this.delete(e)}createRenderPipeline(e,t){const s=this.gl,i=e.pipeline,{fragmentProgram:r,vertexProgram:n}=i,a=s.createProgram(),o=this.get(r).shaderGPU,l=this.get(n).shaderGPU;if(s.attachShader(a,o),s.attachShader(a,l),s.linkProgram(a),this.set(i,{programGPU:a,fragmentShader:o,vertexShader:l}),null!==t&&this.parallel){const r=new Promise(t=>{const r=this.parallel,n=()=>{s.getProgramParameter(a,r.COMPLETION_STATUS_KHR)?(this._completeCompile(e,i),t()):requestAnimationFrame(n)};n()});return void t.push(r)}this._completeCompile(e,i)}_handleSource(e,t){const s=e.split("\n"),i=[],r=Math.max(t-6,0),n=Math.min(t+6,s.length);for(let e=r;e<n;e++){const r=e+1;i.push(`${r===t?">":" "} ${r}: ${s[e]}`)}return i.join("\n")}_getShaderErrors(e,t,s){const i=e.getShaderParameter(t,e.COMPILE_STATUS),r=(e.getShaderInfoLog(t)||"").trim();if(i&&""===r)return"";const n=/ERROR: 0:(\d+)/.exec(r);if(n){const i=parseInt(n[1]);return s.toUpperCase()+"\n\n"+r+"\n\n"+this._handleSource(e.getShaderSource(t),i)}return r}_logProgramError(e,t,s){if(this.renderer.debug.checkShaderErrors){const i=this.gl,r=(i.getProgramInfoLog(e)||"").trim();if(!1===i.getProgramParameter(e,i.LINK_STATUS))if("function"==typeof this.renderer.debug.onShaderError)this.renderer.debug.onShaderError(i,e,s,t);else{const n=this._getShaderErrors(i,s,"vertex"),a=this._getShaderErrors(i,t,"fragment");console.error("THREE.WebGLProgram: Shader Error "+i.getError()+" - VALIDATE_STATUS "+i.getProgramParameter(e,i.VALIDATE_STATUS)+"\n\nProgram Info Log: "+r+"\n"+n+"\n"+a)}else""!==r&&console.warn("THREE.WebGLProgram: Program Info Log:",r)}}_completeCompile(e,t){const{state:s,gl:i}=this,r=this.get(t),{programGPU:n,fragmentShader:a,vertexShader:o}=r;!1===i.getProgramParameter(n,i.LINK_STATUS)&&this._logProgramError(n,a,o),s.useProgram(n);const l=e.getBindings();this._setupBindings(l,n),this.set(t,{programGPU:n})}createComputePipeline(e,t){const{state:s,gl:i}=this,r={stage:"fragment",code:"#version 300 es\nprecision highp float;\nvoid main() {}"};this.createProgram(r);const{computeProgram:n}=e,a=i.createProgram(),o=this.get(r).shaderGPU,l=this.get(n).shaderGPU,h=n.transforms,u=[],c=[];for(let e=0;e<h.length;e++){const t=h[e];u.push(t.varyingName),c.push(t.attributeNode)}i.attachShader(a,o),i.attachShader(a,l),i.transformFeedbackVaryings(a,u,i.SEPARATE_ATTRIBS),i.linkProgram(a),!1===i.getProgramParameter(a,i.LINK_STATUS)&&this._logProgramError(a,o,l),s.useProgram(a),this._setupBindings(t,a);const d=n.attributes,p=[],_=[];for(let e=0;e<d.length;e++){const t=d[e].node.attribute;p.push(t),this.has(t)||this.attributeUtils.createAttribute(t,i.ARRAY_BUFFER)}for(let e=0;e<c.length;e++){const t=c[e].attribute;this.has(t)||this.attributeUtils.createAttribute(t,i.ARRAY_BUFFER);const s=this.get(t);_.push(s)}this.set(e,{programGPU:a,transformBuffers:_,attributes:p})}createBindings(e,t){if(!1===this._knownBindings.has(t)){this._knownBindings.add(t);let e=0,s=0;for(const i of t){this.set(i,{textures:s,uniformBuffers:e});for(const t of i.bindings)t.isUniformBuffer&&e++,t.isSampledTexture&&s++}}this.updateBindings(e,t)}updateBindings(e){const{gl:t}=this,s=this.get(e);let i=s.uniformBuffers,r=s.textures;for(const s of e.bindings)if(s.isUniformsGroup||s.isUniformBuffer){const e=s.buffer,r=t.createBuffer();t.bindBuffer(t.UNIFORM_BUFFER,r),t.bufferData(t.UNIFORM_BUFFER,e,t.DYNAMIC_DRAW),this.set(s,{index:i++,bufferGPU:r})}else if(s.isSampledTexture){const{textureGPU:e,glTextureType:t}=this.get(s.texture);this.set(s,{index:r++,textureGPU:e,glTextureType:t})}}updateBinding(e){const t=this.gl;if(e.isUniformsGroup||e.isUniformBuffer){const s=this.get(e).bufferGPU,i=e.buffer;t.bindBuffer(t.UNIFORM_BUFFER,s),t.bufferData(t.UNIFORM_BUFFER,i,t.DYNAMIC_DRAW)}}createIndexAttribute(e){const t=this.gl;this.attributeUtils.createAttribute(e,t.ELEMENT_ARRAY_BUFFER)}createAttribute(e){if(this.has(e))return;const t=this.gl;this.attributeUtils.createAttribute(e,t.ARRAY_BUFFER)}createStorageAttribute(e){if(this.has(e))return;const t=this.gl;this.attributeUtils.createAttribute(e,t.ARRAY_BUFFER)}updateAttribute(e){this.attributeUtils.updateAttribute(e)}destroyAttribute(e){this.attributeUtils.destroyAttribute(e)}hasFeature(e){const t=Object.keys(UN).filter(t=>UN[t]===e),s=this.extensions;for(let e=0;e<t.length;e++)if(s.has(t[e]))return!0;return!1}getMaxAnisotropy(){return this.capabilities.getMaxAnisotropy()}copyTextureToTexture(e,t,s=null,i=null,r=0,n=0){this.textureUtils.copyTextureToTexture(e,t,s,i,r,n)}copyFramebufferToTexture(e,t,s){this.textureUtils.copyFramebufferToTexture(e,t,s)}_setFramebuffer(e){const{gl:t,state:s}=this;let i=null;if(null!==e.textures){const r=e.renderTarget,n=this.get(r),{samples:a,depthBuffer:o,stencilBuffer:l}=r,h=!0===r.isWebGLCubeRenderTarget,u=!0===r.isRenderTarget3D,c=r.depth>1,d=!0===r.isXRRenderTarget,p=!0===d&&!0===r._hasExternalTextures;let _=n.msaaFrameBuffer,m=n.depthRenderbuffer;const f=this.extensions.get("WEBGL_multisampled_render_to_texture"),g=this.extensions.get("OVR_multiview2"),y=this._useMultisampledExtension(r),S=Wf(e);let T;if(h?(n.cubeFramebuffers||(n.cubeFramebuffers={}),T=n.cubeFramebuffers[S]):d&&!1===p?T=this._xrFramebuffer:(n.framebuffers||(n.framebuffers={}),T=n.framebuffers[S]),void 0===T){T=t.createFramebuffer(),s.bindFramebuffer(t.FRAMEBUFFER,T);const i=e.textures,o=[];if(h){n.cubeFramebuffers[S]=T;const{textureGPU:e}=this.get(i[0]),s=this.renderer._activeCubeFace;t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+s,e,0)}else{n.framebuffers[S]=T;for(let s=0;s<i.length;s++){const n=i[s],o=this.get(n);o.renderTarget=e.renderTarget,o.cacheKey=S;const l=t.COLOR_ATTACHMENT0+s;if(r.multiview)g.framebufferTextureMultisampleMultiviewOVR(t.FRAMEBUFFER,l,o.textureGPU,0,a,0,2);else if(u||c){const e=this.renderer._activeCubeFace;t.framebufferTextureLayer(t.FRAMEBUFFER,l,o.textureGPU,0,e)}else y?f.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,l,t.TEXTURE_2D,o.textureGPU,0,a):t.framebufferTexture2D(t.FRAMEBUFFER,l,t.TEXTURE_2D,o.textureGPU,0)}}const d=l?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;if(!0===r._autoAllocateDepthBuffer){const s=t.createRenderbuffer();this.textureUtils.setupRenderBufferStorage(s,e,0,y),n.xrDepthRenderbuffer=s,o.push(l?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT),t.bindRenderbuffer(t.RENDERBUFFER,s),t.framebufferRenderbuffer(t.FRAMEBUFFER,d,t.RENDERBUFFER,s)}else if(null!==e.depthTexture){o.push(l?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT);const s=this.get(e.depthTexture);if(s.renderTarget=e.renderTarget,s.cacheKey=S,r.multiview)g.framebufferTextureMultisampleMultiviewOVR(t.FRAMEBUFFER,d,s.textureGPU,0,a,0,2);else if(p&&y)f.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,d,t.TEXTURE_2D,s.textureGPU,0,a);else if(e.depthTexture.isArrayTexture){const e=this.renderer._activeCubeFace;t.framebufferTextureLayer(t.FRAMEBUFFER,d,s.textureGPU,0,e)}else t.framebufferTexture2D(t.FRAMEBUFFER,d,t.TEXTURE_2D,s.textureGPU,0)}n.depthInvalidationArray=o}else{if(this._isRenderCameraDepthArray(e)){s.bindFramebuffer(t.FRAMEBUFFER,T);const i=this.renderer._activeCubeFace,r=this.get(e.depthTexture),n=l?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;t.framebufferTextureLayer(t.FRAMEBUFFER,n,r.textureGPU,0,i)}if((d||y||r.multiview)&&!0!==r._isOpaqueFramebuffer){s.bindFramebuffer(t.FRAMEBUFFER,T);const i=this.get(e.textures[0]);r.multiview?g.framebufferTextureMultisampleMultiviewOVR(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,i.textureGPU,0,a,0,2):y?f.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i.textureGPU,0,a):t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i.textureGPU,0);const o=l?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;if(!0===r._autoAllocateDepthBuffer){const e=n.xrDepthRenderbuffer;t.bindRenderbuffer(t.RENDERBUFFER,e),t.framebufferRenderbuffer(t.FRAMEBUFFER,o,t.RENDERBUFFER,e)}else{const s=this.get(e.depthTexture);r.multiview?g.framebufferTextureMultisampleMultiviewOVR(t.FRAMEBUFFER,o,s.textureGPU,0,a,0,2):y?f.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,o,t.TEXTURE_2D,s.textureGPU,0,a):t.framebufferTexture2D(t.FRAMEBUFFER,o,t.TEXTURE_2D,s.textureGPU,0)}}}if(a>0&&!1===y&&!r.multiview){if(void 0===_){const i=[];_=t.createFramebuffer(),s.bindFramebuffer(t.FRAMEBUFFER,_);const r=[],h=e.textures;for(let s=0;s<h.length;s++){r[s]=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,r[s]),i.push(t.COLOR_ATTACHMENT0+s);const n=e.textures[s],o=this.get(n);t.renderbufferStorageMultisample(t.RENDERBUFFER,a,o.glInternalFormat,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+s,t.RENDERBUFFER,r[s])}if(t.bindRenderbuffer(t.RENDERBUFFER,null),n.msaaFrameBuffer=_,n.msaaRenderbuffers=r,o&&void 0===m){m=t.createRenderbuffer(),this.textureUtils.setupRenderBufferStorage(m,e,a),n.depthRenderbuffer=m;const s=l?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;i.push(s)}n.invalidationArray=i}i=n.msaaFrameBuffer}else i=T;s.drawBuffers(e,T)}s.bindFramebuffer(t.FRAMEBUFFER,i)}_getVaoKey(e){let t="";for(let s=0;s<e.length;s++)t+=":"+this.get(e[s]).id;return t}_createVao(e){const{gl:t}=this,s=t.createVertexArray();t.bindVertexArray(s);for(let s=0;s<e.length;s++){const i=e[s],r=this.get(i);let n,a;t.bindBuffer(t.ARRAY_BUFFER,r.bufferGPU),t.enableVertexAttribArray(s),!0===i.isInterleavedBufferAttribute?(n=i.data.stride*r.bytesPerElement,a=i.offset*r.bytesPerElement):(n=0,a=0),r.isInteger?t.vertexAttribIPointer(s,i.itemSize,r.type,n,a):t.vertexAttribPointer(s,i.itemSize,r.type,i.normalized,n,a),i.isInstancedBufferAttribute&&!i.isInterleavedBufferAttribute?t.vertexAttribDivisor(s,i.meshPerAttribute):i.isInterleavedBufferAttribute&&i.data.isInstancedInterleavedBuffer&&t.vertexAttribDivisor(s,i.data.meshPerAttribute)}return t.bindBuffer(t.ARRAY_BUFFER,null),s}_getTransformFeedback(e){let t="";for(let s=0;s<e.length;s++)t+=":"+e[s].id;let s=this.transformFeedbackCache[t];if(void 0!==s)return s;const{gl:i}=this;s=i.createTransformFeedback(),i.bindTransformFeedback(i.TRANSFORM_FEEDBACK,s);for(let t=0;t<e.length;t++){const s=e[t];i.bindBufferBase(i.TRANSFORM_FEEDBACK_BUFFER,t,s.transformBuffer)}return i.bindTransformFeedback(i.TRANSFORM_FEEDBACK,null),this.transformFeedbackCache[t]=s,s}_setupBindings(e,t){const s=this.gl;for(const i of e)for(const e of i.bindings){const i=this.get(e).index;if(e.isUniformsGroup||e.isUniformBuffer){const r=s.getUniformBlockIndex(t,e.name);s.uniformBlockBinding(t,r,i)}else if(e.isSampledTexture){const r=s.getUniformLocation(t,e.name);s.uniform1i(r,i)}}}_bindUniforms(e){const{gl:t,state:s}=this;for(const i of e)for(const e of i.bindings){const i=this.get(e),r=i.index;e.isUniformsGroup||e.isUniformBuffer?s.bindBufferBase(t.UNIFORM_BUFFER,r,i.bufferGPU):e.isSampledTexture&&s.bindTexture(i.glTextureType,i.textureGPU,t.TEXTURE0+r)}}_useMultisampledExtension(e){return!0===e.multiview||e.samples>0&&!0===this.extensions.has("WEBGL_multisampled_render_to_texture")&&!1!==e._autoAllocateDepthBuffer}dispose(){const e=this.extensions.get("WEBGL_lose_context");e&&e.loseContext(),this.renderer.domElement.removeEventListener("webglcontextlost",this._onContextLost)}},HN="point-list",$N="line-list",WN="line-strip",qN="triangle-list",jN="triangle-strip",XN="never",KN="less",YN="equal",QN="less-equal",ZN="greater",JN="not-equal",eS="greater-equal",tS="always",rS="store",sS="load",iS="clear",nS="ccw",aS="none",oS="front",uS="back",lS="uint16",dS="uint32",cS="r8unorm",hS="r8snorm",pS="r8uint",gS="r8sint",mS="r16uint",fS="r16sint",yS="r16float",bS="rg8unorm",xS="rg8snorm",TS="rg8uint",_S="rg8sint",vS="r32uint",NS="r32sint",SS="r32float",ES="rg16uint",wS="rg16sint",AS="rg16float",RS="rgba8unorm",CS="rgba8unorm-srgb",MS="rgba8snorm",PS="rgba8uint",BS="rgba8sint",LS="bgra8unorm",FS="bgra8unorm-srgb",IS="rgb9e5ufloat",DS="rgb10a2unorm",VS="rgb10a2unorm",US="rg32uint",OS="rg32sint",kS="rg32float",GS="rgba16uint",zS="rgba16sint",HS="rgba16float",$S="rgba32uint",WS="rgba32sint",qS="rgba32float",jS="depth16unorm",XS="depth24plus",KS="depth24plus-stencil8",YS="depth32float",QS="depth32float-stencil8",ZS="bc1-rgba-unorm",JS="bc1-rgba-unorm-srgb",eE="bc2-rgba-unorm",tE="bc2-rgba-unorm-srgb",rE="bc3-rgba-unorm",sE="bc3-rgba-unorm-srgb",iE="bc4-r-unorm",nE="bc4-r-snorm",aE="bc5-rg-unorm",oE="bc5-rg-snorm",uE="bc6h-rgb-ufloat",lE="bc6h-rgb-float",dE="bc7-rgba-unorm",cE="bc7-rgba-srgb",hE="etc2-rgb8unorm",pE="etc2-rgb8unorm-srgb",gE="etc2-rgb8a1unorm",mE="etc2-rgb8a1unorm-srgb",fE="etc2-rgba8unorm",yE="etc2-rgba8unorm-srgb",bE="eac-r11unorm",xE="eac-r11snorm",TE="eac-rg11unorm",_E="eac-rg11snorm",vE="astc-4x4-unorm",NE="astc-4x4-unorm-srgb",SE="astc-5x4-unorm",EE="astc-5x4-unorm-srgb",wE="astc-5x5-unorm",AE="astc-5x5-unorm-srgb",RE="astc-6x5-unorm",CE="astc-6x5-unorm-srgb",ME="astc-6x6-unorm",PE="astc-6x6-unorm-srgb",BE="astc-8x5-unorm",LE="astc-8x5-unorm-srgb",FE="astc-8x6-unorm",IE="astc-8x6-unorm-srgb",DE="astc-8x8-unorm",VE="astc-8x8-unorm-srgb",UE="astc-10x5-unorm",OE="astc-10x5-unorm-srgb",kE="astc-10x6-unorm",GE="astc-10x6-unorm-srgb",zE="astc-10x8-unorm",HE="astc-10x8-unorm-srgb",$E="astc-10x10-unorm",WE="astc-10x10-unorm-srgb",qE="astc-12x10-unorm",jE="astc-12x10-unorm-srgb",XE="astc-12x12-unorm",KE="astc-12x12-unorm-srgb",YE="clamp-to-edge",QE="repeat",ZE="mirror-repeat",JE="linear",ew="nearest",tw="zero",rw="one",sw="src",iw="one-minus-src",nw2="src-alpha",aw="one-minus-src-alpha",ow="dst",uw="one-minus-dst",lw="dst-alpha",dw="one-minus-dst-alpha",cw="src-alpha-saturated",hw="constant",pw="one-minus-constant",gw="add",mw="subtract",fw="reverse-subtract",yw="min",bw="max",xw=0,Tw=15,_w="keep",vw="zero",Nw="replace",Sw="invert",Ew="increment-clamp",ww="decrement-clamp",Aw="increment-wrap",Rw="decrement-wrap",Cw="storage",Mw="read-only-storage",Pw="write-only",Bw="read-only",Lw="read-write",Fw="non-filtering",Iw="comparison",Dw="float",Vw="unfilterable-float",Uw="depth",Ow="sint",kw="uint",Gw="2d",zw="3d",Hw="2d",$w="2d-array",Ww="cube",qw="3d",jw="all",Xw="vertex",Kw="instance",Yw={CoreFeaturesAndLimits:"core-features-and-limits",DepthClipControl:"depth-clip-control",Depth32FloatStencil8:"depth32float-stencil8",TextureCompressionBC:"texture-compression-bc",TextureCompressionBCSliced3D:"texture-compression-bc-sliced-3d",TextureCompressionETC2:"texture-compression-etc2",TextureCompressionASTC:"texture-compression-astc",TextureCompressionASTCSliced3D:"texture-compression-astc-sliced-3d",TimestampQuery:"timestamp-query",IndirectFirstInstance:"indirect-first-instance",ShaderF16:"shader-f16",RG11B10UFloat:"rg11b10ufloat-renderable",BGRA8UNormStorage:"bgra8unorm-storage",Float32Filterable:"float32-filterable",Float32Blendable:"float32-blendable",ClipDistances:"clip-distances",DualSourceBlending:"dual-source-blending",Subgroups:"subgroups",TextureFormatsTier1:"texture-formats-tier1",TextureFormatsTier2:"texture-formats-tier2"},Qw=class extends oN{constructor(e,t,s){super(e,t?t.value:null),this.textureNode=t,this.groupNode=s}update(){this.texture=this.textureNode.value}},Zw=class extends eN{constructor(e,t){super(e,t?t.array:null),this.attribute=t,this.isStorageBuffer=!0}},Jw=0,eA=class extends Zw{constructor(e,t){super("StorageBuffer_"+Jw++,e?e.value:null),this.nodeUniform=e,this.access=e?e.access:ks2.READ_WRITE,this.groupNode=t}get buffer(){return this.nodeUniform.value}},tA=class extends xf{constructor(e){super(),this.device=e,this.mipmapSampler=e.createSampler({minFilter:JE}),this.flipYSampler=e.createSampler({minFilter:ew}),this.transferPipelines={},this.flipYPipelines={},this.mipmapVertexShaderModule=e.createShaderModule({label:"mipmapVertex",code:"\nstruct VarysStruct {\n\t@builtin( position ) Position: vec4<f32>,\n\t@location( 0 ) vTex : vec2<f32>\n};\n\n@vertex\nfn main( @builtin( vertex_index ) vertexIndex : u32 ) -> VarysStruct {\n\n\tvar Varys : VarysStruct;\n\n\tvar pos = array< vec2<f32>, 4 >(\n\t\tvec2<f32>( -1.0,  1.0 ),\n\t\tvec2<f32>(  1.0,  1.0 ),\n\t\tvec2<f32>( -1.0, -1.0 ),\n\t\tvec2<f32>(  1.0, -1.0 )\n\t);\n\n\tvar tex = array< vec2<f32>, 4 >(\n\t\tvec2<f32>( 0.0, 0.0 ),\n\t\tvec2<f32>( 1.0, 0.0 ),\n\t\tvec2<f32>( 0.0, 1.0 ),\n\t\tvec2<f32>( 1.0, 1.0 )\n\t);\n\n\tVarys.vTex = tex[ vertexIndex ];\n\tVarys.Position = vec4<f32>( pos[ vertexIndex ], 0.0, 1.0 );\n\n\treturn Varys;\n\n}\n"}),this.mipmapFragmentShaderModule=e.createShaderModule({label:"mipmapFragment",code:"\n@group( 0 ) @binding( 0 )\nvar imgSampler : sampler;\n\n@group( 0 ) @binding( 1 )\nvar img : texture_2d<f32>;\n\n@fragment\nfn main( @location( 0 ) vTex : vec2<f32> ) -> @location( 0 ) vec4<f32> {\n\n\treturn textureSample( img, imgSampler, vTex );\n\n}\n"}),this.flipYFragmentShaderModule=e.createShaderModule({label:"flipYFragment",code:"\n@group( 0 ) @binding( 0 )\nvar imgSampler : sampler;\n\n@group( 0 ) @binding( 1 )\nvar img : texture_2d<f32>;\n\n@fragment\nfn main( @location( 0 ) vTex : vec2<f32> ) -> @location( 0 ) vec4<f32> {\n\n\treturn textureSample( img, imgSampler, vec2( vTex.x, 1.0 - vTex.y ) );\n\n}\n"})}getTransferPipeline(e){let t=this.transferPipelines[e];return void 0===t&&(t=this.device.createRenderPipeline({label:`mipmap-${e}`,vertex:{module:this.mipmapVertexShaderModule,entryPoint:"main"},fragment:{module:this.mipmapFragmentShaderModule,entryPoint:"main",targets:[{format:e}]},primitive:{topology:jN,stripIndexFormat:dS},layout:"auto"}),this.transferPipelines[e]=t),t}getFlipYPipeline(e){let t=this.flipYPipelines[e];return void 0===t&&(t=this.device.createRenderPipeline({label:`flipY-${e}`,vertex:{module:this.mipmapVertexShaderModule,entryPoint:"main"},fragment:{module:this.flipYFragmentShaderModule,entryPoint:"main",targets:[{format:e}]},primitive:{topology:jN,stripIndexFormat:dS},layout:"auto"}),this.flipYPipelines[e]=t),t}flipY(e,t,s=0){const i=t.format,{width:r,height:n}=t.size,a=this.getTransferPipeline(i),o=this.getFlipYPipeline(i),l=this.device.createTexture({size:{width:r,height:n,depthOrArrayLayers:1},format:i,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING}),h=e.createView({baseMipLevel:0,mipLevelCount:1,dimension:Hw,baseArrayLayer:s}),u=l.createView({baseMipLevel:0,mipLevelCount:1,dimension:Hw,baseArrayLayer:0}),c=this.device.createCommandEncoder({}),d=(e,t,s)=>{const i=e.getBindGroupLayout(0),r=this.device.createBindGroup({layout:i,entries:[{binding:0,resource:this.flipYSampler},{binding:1,resource:t}]}),n=c.beginRenderPass({colorAttachments:[{view:s,loadOp:iS,storeOp:rS,clearValue:[0,0,0,0]}]});n.setPipeline(e),n.setBindGroup(0,r),n.draw(4,1,0,0),n.end()};d(a,h,u),d(o,u,h),this.device.queue.submit([c.finish()]),l.destroy()}generateMipmaps(e,t,s=0){const i=this.get(e);void 0===i.useCount&&(i.useCount=0,i.layers=[]);const r=i.layers[s]||this._mipmapCreateBundles(e,t,s),n=this.device.createCommandEncoder({});this._mipmapRunBundles(n,r),this.device.queue.submit([n.finish()]),0!==i.useCount&&(i.layers[s]=r),i.useCount++}_mipmapCreateBundles(e,t,s){const i=this.getTransferPipeline(t.format),r=i.getBindGroupLayout(0);let n=e.createView({baseMipLevel:0,mipLevelCount:1,dimension:Hw,baseArrayLayer:s});const a=[];for(let o=1;o<t.mipLevelCount;o++){const l=this.device.createBindGroup({layout:r,entries:[{binding:0,resource:this.mipmapSampler},{binding:1,resource:n}]}),h=e.createView({baseMipLevel:o,mipLevelCount:1,dimension:Hw,baseArrayLayer:s}),u={colorAttachments:[{view:h,loadOp:iS,storeOp:rS,clearValue:[0,0,0,0]}]},c=this.device.createRenderBundleEncoder({colorFormats:[t.format]});c.setPipeline(i),c.setBindGroup(0,l),c.draw(4,1,0,0),a.push({renderBundles:[c.finish()],passDescriptor:u}),n=h}return a}_mipmapRunBundles(e,t){const s=t.length;for(let i=0;i<s;i++){const s=t[i],r=e.beginRenderPass(s.passDescriptor);r.executeBundles(s.renderBundles),r.end()}}},rA={[mi]:"never",[yi]:"less",[gi]:"equal",[fi]:"less-equal",[xi]:"greater",[vi]:"greater-equal",[wi]:"always",[bi]:"not-equal"},sA=[0,1,3,2,4,5],iA=class{constructor(e){this.backend=e,this._passUtils=null,this.defaultTexture={},this.defaultCubeTexture={},this.defaultVideoFrame=null,this.colorBuffer=null,this.depthTexture=new ah,this.depthTexture.name="depthBuffer"}createSampler(e){const t=this.backend,s=t.device,i=t.get(e),r={addressModeU:this._convertAddressMode(e.wrapS),addressModeV:this._convertAddressMode(e.wrapT),addressModeW:this._convertAddressMode(e.wrapR),magFilter:this._convertFilterMode(e.magFilter),minFilter:this._convertFilterMode(e.minFilter),mipmapFilter:this._convertFilterMode(e.minFilter),maxAnisotropy:1};r.magFilter===JE&&r.minFilter===JE&&r.mipmapFilter===JE&&(r.maxAnisotropy=e.anisotropy),e.isDepthTexture&&null!==e.compareFunction&&(r.compare=rA[e.compareFunction]),i.sampler=s.createSampler(r)}createDefaultTexture(e){let t;const s=nA(e);t=e.isCubeTexture?this._getDefaultCubeTextureGPU(s):this._getDefaultTextureGPU(s),this.backend.get(e).texture=t}createTexture(e,t={}){const s=this.backend,i=s.get(e);if(i.initialized)throw new Error("WebGPUTextureUtils: Texture already initialized.");void 0===t.needsMipmaps&&(t.needsMipmaps=!1),void 0===t.levels&&(t.levels=1),void 0===t.depth&&(t.depth=1);const{width:r,height:n,depth:a,levels:o}=t;e.isFramebufferTexture&&(t.renderTarget?t.format=this.backend.utils.getCurrentColorFormat(t.renderTarget):t.format=this.backend.utils.getPreferredCanvasFormat());const l=this._getDimension(e),h=e.internalFormat||t.format||nA(e,s.device);i.format=h;const{samples:u,primarySamples:c,isMSAA:d}=s.utils.getTextureSampleData(e);let p=GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.COPY_SRC;!0===e.isStorageTexture&&(p|=GPUTextureUsage.STORAGE_BINDING),!0!==e.isCompressedTexture&&!0!==e.isCompressedArrayTexture&&(p|=GPUTextureUsage.RENDER_ATTACHMENT);const _={label:e.name,size:{width:r,height:n,depthOrArrayLayers:a},mipLevelCount:o,sampleCount:c,dimension:l,format:h,usage:p};if(void 0===h)return console.warn("WebGPURenderer: Texture format not supported."),void this.createDefaultTexture(e);if(e.isCubeTexture&&(_.textureBindingViewDimension=Ww),i.texture=s.device.createTexture(_),d){const e=Object.assign({},_);e.label=e.label+"-msaa",e.sampleCount=u,i.msaaTexture=s.device.createTexture(e)}i.initialized=!0,i.textureDescriptorGPU=_}destroyTexture(e){const t=this.backend,s=t.get(e);void 0!==s.texture&&s.texture.destroy(),void 0!==s.msaaTexture&&s.msaaTexture.destroy(),t.delete(e)}destroySampler(e){delete this.backend.get(e).sampler}generateMipmaps(e){const t=this.backend.get(e);if(e.isCubeTexture)for(let e=0;e<6;e++)this._generateMipmaps(t.texture,t.textureDescriptorGPU,e);else{const s=e.image.depth||1;for(let e=0;e<s;e++)this._generateMipmaps(t.texture,t.textureDescriptorGPU,e)}}getColorBuffer(){this.colorBuffer&&this.colorBuffer.destroy();const e=this.backend,{width:t,height:s}=e.getDrawingBufferSize();return this.colorBuffer=e.device.createTexture({label:"colorBuffer",size:{width:t,height:s,depthOrArrayLayers:1},sampleCount:e.utils.getSampleCount(e.renderer.samples),format:e.utils.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC}),this.colorBuffer}getDepthBuffer(e=!0,t=!1){const s=this.backend,{width:i,height:r}=s.getDrawingBufferSize(),n=this.depthTexture,a=s.get(n).texture;let o,l;if(t?(o=Dt,l=Nt):e&&(o=Wt,l=kt),void 0!==a){if(n.image.width===i&&n.image.height===r&&n.format===o&&n.type===l)return a;this.destroyTexture(n)}return n.name="depthBuffer",n.format=o,n.type=l,n.image.width=i,n.image.height=r,this.createTexture(n,{width:i,height:r}),s.get(n).texture}updateTexture(e,t){const s=this.backend.get(e),{textureDescriptorGPU:i}=s;if(!e.isRenderTargetTexture&&void 0!==i){if(e.isDataTexture)this._copyBufferToTexture(t.image,s.texture,i,0,e.flipY);else if(e.isArrayTexture||e.isDataArrayTexture||e.isData3DTexture)for(let r=0;r<t.image.depth;r++)this._copyBufferToTexture(t.image,s.texture,i,r,e.flipY,r);else e.isCompressedTexture||e.isCompressedArrayTexture?this._copyCompressedBufferToTexture(e.mipmaps,s.texture,i):e.isCubeTexture?this._copyCubeMapToTexture(t.images,s.texture,i,e.flipY,e.premultiplyAlpha):this._copyImageToTexture(t.image,s.texture,i,0,e.flipY,e.premultiplyAlpha);s.version=e.version,e.onUpdate&&e.onUpdate(e)}}async copyTextureToBuffer(e,t,s,i,r,n){const a=this.backend.device,o=this.backend.get(e),l=o.texture,h=o.textureDescriptorGPU.format,u=this._getBytesPerTexel(h);let c=i*u;c=256*Math.ceil(c/256);const d=a.createBuffer({size:i*r*u,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),p=a.createCommandEncoder();p.copyTextureToBuffer({texture:l,origin:{x:t,y:s,z:n}},{buffer:d,bytesPerRow:c},{width:i,height:r});const _=this._getTypedArrayType(h);return a.queue.submit([p.finish()]),await d.mapAsync(GPUMapMode.READ),new _(d.getMappedRange())}_getDefaultTextureGPU(e){let t=this.defaultTexture[e];if(void 0===t){const s=new _s;s.minFilter=gt,s.magFilter=gt,this.createTexture(s,{width:1,height:1,format:e}),this.defaultTexture[e]=t=s}return this.backend.get(t).texture}_getDefaultCubeTextureGPU(e){let t=this.defaultTexture[e];if(void 0===t){const s=new ea;s.minFilter=gt,s.magFilter=gt,this.createTexture(s,{width:1,height:1,depth:6}),this.defaultCubeTexture[e]=t=s}return this.backend.get(t).texture}_copyCubeMapToTexture(e,t,s,i,r){for(let n=0;n<6;n++){const a=e[n],o=!0===i?sA[n]:n;a.isDataTexture?this._copyBufferToTexture(a.image,t,s,o,i):this._copyImageToTexture(a,t,s,o,i,r)}}_copyImageToTexture(e,t,s,i,r,n){this.backend.device.queue.copyExternalImageToTexture({source:e,flipY:r},{texture:t,mipLevel:0,origin:{x:0,y:0,z:i},premultipliedAlpha:n},{width:s.size.width,height:s.size.height,depthOrArrayLayers:1})}_getPassUtils(){let e=this._passUtils;return null===e&&(this._passUtils=e=new tA(this.backend.device)),e}_generateMipmaps(e,t,s=0){this._getPassUtils().generateMipmaps(e,t,s)}_flipY(e,t,s=0){this._getPassUtils().flipY(e,t,s)}_copyBufferToTexture(e,t,s,i,r,n=0){const a=this.backend.device,o=e.data,l=this._getBytesPerTexel(s.format),h=e.width*l;a.queue.writeTexture({texture:t,mipLevel:0,origin:{x:0,y:0,z:i}},o,{offset:e.width*e.height*l*n,bytesPerRow:h},{width:e.width,height:e.height,depthOrArrayLayers:1}),!0===r&&this._flipY(t,s,i)}_copyCompressedBufferToTexture(e,t,s){const i=this.backend.device,r=this._getBlockData(s.format),n=s.size.depthOrArrayLayers>1;for(let a=0;a<e.length;a++){const o=e[a],l=o.width,h=o.height,u=n?s.size.depthOrArrayLayers:1,c=Math.ceil(l/r.width)*r.byteLength,d=c*Math.ceil(h/r.height);for(let e=0;e<u;e++)i.queue.writeTexture({texture:t,mipLevel:a,origin:{x:0,y:0,z:e}},o.data,{offset:e*d,bytesPerRow:c,rowsPerImage:Math.ceil(h/r.height)},{width:Math.ceil(l/r.width)*r.width,height:Math.ceil(h/r.height)*r.height,depthOrArrayLayers:1})}}_getBlockData(e){return e===ZS||e===JS?{byteLength:8,width:4,height:4}:e===eE||e===tE||e===rE||e===sE?{byteLength:16,width:4,height:4}:e===iE||e===nE?{byteLength:8,width:4,height:4}:e===aE||e===oE||e===uE||e===lE||e===dE||e===cE?{byteLength:16,width:4,height:4}:e===hE||e===pE||e===gE||e===mE?{byteLength:8,width:4,height:4}:e===fE||e===yE?{byteLength:16,width:4,height:4}:e===bE||e===xE?{byteLength:8,width:4,height:4}:e===TE||e===_E||e===vE||e===NE?{byteLength:16,width:4,height:4}:e===SE||e===EE?{byteLength:16,width:5,height:4}:e===wE||e===AE?{byteLength:16,width:5,height:5}:e===RE||e===CE?{byteLength:16,width:6,height:5}:e===ME||e===PE?{byteLength:16,width:6,height:6}:e===BE||e===LE?{byteLength:16,width:8,height:5}:e===FE||e===IE?{byteLength:16,width:8,height:6}:e===DE||e===VE?{byteLength:16,width:8,height:8}:e===UE||e===OE?{byteLength:16,width:10,height:5}:e===kE||e===GE?{byteLength:16,width:10,height:6}:e===zE||e===HE?{byteLength:16,width:10,height:8}:e===$E||e===WE?{byteLength:16,width:10,height:10}:e===qE||e===jE?{byteLength:16,width:12,height:10}:e===XE||e===KE?{byteLength:16,width:12,height:12}:void 0}_convertAddressMode(e){let t=YE;return e===pt?t=QE:e===yt&&(t=ZE),t}_convertFilterMode(e){let t=JE;return e!==gt&&e!==ft&&e!==bt||(t=ew),t}_getBytesPerTexel(e){return e===cS||e===hS||e===pS||e===gS?1:e===mS||e===fS||e===yS||e===bS||e===xS||e===TS||e===_S?2:e===vS||e===NS||e===SS||e===ES||e===wS||e===AS||e===RS||e===CS||e===MS||e===PS||e===BS||e===LS||e===FS||e===IS||e===DS||e===VS||e===YS||e===XS||e===KS||e===QS?4:e===US||e===OS||e===kS||e===GS||e===zS||e===HS?8:e===$S||e===WS||e===qS?16:void 0}_getTypedArrayType(e){return e===pS?Uint8Array:e===gS?Int8Array:e===cS?Uint8Array:e===hS?Int8Array:e===TS?Uint8Array:e===_S?Int8Array:e===bS?Uint8Array:e===xS?Int8Array:e===PS?Uint8Array:e===BS?Int8Array:e===RS?Uint8Array:e===MS?Int8Array:e===mS?Uint16Array:e===fS?Int16Array:e===ES?Uint16Array:e===wS?Int16Array:e===GS?Uint16Array:e===zS?Int16Array:e===yS||e===AS||e===HS?Uint16Array:e===vS?Uint32Array:e===NS?Int32Array:e===SS?Float32Array:e===US?Uint32Array:e===OS?Int32Array:e===kS?Float32Array:e===$S?Uint32Array:e===WS?Int32Array:e===qS?Float32Array:e===LS||e===FS?Uint8Array:e===DS||e===IS||e===VS?Uint32Array:e===YS?Float32Array:e===XS||e===KS?Uint32Array:e===QS?Float32Array:void 0}_getDimension(e){let t;return t=e.is3DTexture||e.isData3DTexture?zw:Gw,t}};function nA(e,t=null){const s=e.format,i=e.type,r=e.colorSpace,n=ms.getTransfer(r);let a;if(!0===e.isCompressedTexture||!0===e.isCompressedArrayTexture)switch(s){case Gt:a=n===$e?JS:ZS;break;case $t:a=n===$e?tE:eE;break;case Qt:a=n===$e?sE:rE;break;case re:a=n===$e?pE:hE;break;case ne:a=n===$e?yE:fE;break;case ae:a=n===$e?NE:vE;break;case oe:a=n===$e?EE:SE;break;case he:a=n===$e?AE:wE;break;case le:a=n===$e?CE:RE;break;case ce:a=n===$e?PE:ME;break;case ue:a=n===$e?LE:BE;break;case de:a=n===$e?IE:FE;break;case pe:a=n===$e?VE:DE;break;case me:a=n===$e?OE:UE;break;case ye:a=n===$e?GE:kE;break;case ge:a=n===$e?HE:zE;break;case fe:a=n===$e?WE:$E;break;case xe:a=n===$e?jE:qE;break;case be:a=n===$e?KE:XE;break;case jt:a=n===$e?CS:RS;break;default:console.error("WebGPURenderer: Unsupported texture format.",s)}else switch(s){case jt:switch(i){case zt:a=MS;break;case Ct:a=zS;break;case It:a=GS;break;case kt:a=$S;break;case Bt:a=WS;break;case Tt:a=n===$e?CS:RS;break;case Rt:a=HS;break;case Et:a=qS;break;default:console.error("WebGPURenderer: Unsupported texture type with RGBAFormat.",i)}break;case Lt:i===Vt?a=IS:console.error("WebGPURenderer: Unsupported texture type with RGBFormat.",i);break;case Ut:switch(i){case zt:a=hS;break;case Ct:a=fS;break;case It:a=mS;break;case kt:a=vS;break;case Bt:a=NS;break;case Tt:a=cS;break;case Rt:a=yS;break;case Et:a=SS;break;default:console.error("WebGPURenderer: Unsupported texture type with RedFormat.",i)}break;case qt:switch(i){case zt:a=xS;break;case Ct:a=wS;break;case It:a=ES;break;case kt:a=US;break;case Bt:a=OS;break;case Tt:a=bS;break;case Rt:a=AS;break;case Et:a=kS;break;default:console.error("WebGPURenderer: Unsupported texture type with RGFormat.",i)}break;case Wt:switch(i){case It:a=jS;break;case kt:a=XS;break;case Et:a=YS;break;default:console.error("WebGPURenderer: Unsupported texture type with DepthFormat.",i)}break;case Dt:switch(i){case Nt:a=KS;break;case Et:t&&!1===t.features.has(Yw.Depth32FloatStencil8)&&console.error('WebGPURenderer: Depth textures with DepthStencilFormat + FloatType can only be used with the "depth32float-stencil8" GPU feature.'),a=QS;break;default:console.error("WebGPURenderer: Unsupported texture type with DepthStencilFormat.",i)}break;case Ht:switch(i){case Bt:a=NS;break;case kt:a=vS;break;default:console.error("WebGPURenderer: Unsupported texture type with RedIntegerFormat.",i)}break;case Jt:switch(i){case Bt:a=OS;break;case kt:a=US;break;default:console.error("WebGPURenderer: Unsupported texture type with RGIntegerFormat.",i)}break;case Yt:switch(i){case Bt:a=WS;break;case kt:a=$S;break;default:console.error("WebGPURenderer: Unsupported texture type with RGBAIntegerFormat.",i)}break;default:console.error("WebGPURenderer: Unsupported texture format.",s)}return a}var aA=/^[fn]*\s*([a-z_0-9]+)?\s*\(([\s\S]*?)\)\s*[\-\>]*\s*([a-z_0-9]+(?:<[\s\S]+?>)?)/i,oA=/([a-z_0-9]+)\s*:\s*([a-z_0-9]+(?:<[\s\S]+?>)?)/gi,uA={f32:"float",i32:"int",u32:"uint",bool:"bool","vec2<f32>":"vec2","vec2<i32>":"ivec2","vec2<u32>":"uvec2","vec2<bool>":"bvec2",vec2f:"vec2",vec2i:"ivec2",vec2u:"uvec2",vec2b:"bvec2","vec3<f32>":"vec3","vec3<i32>":"ivec3","vec3<u32>":"uvec3","vec3<bool>":"bvec3",vec3f:"vec3",vec3i:"ivec3",vec3u:"uvec3",vec3b:"bvec3","vec4<f32>":"vec4","vec4<i32>":"ivec4","vec4<u32>":"uvec4","vec4<bool>":"bvec4",vec4f:"vec4",vec4i:"ivec4",vec4u:"uvec4",vec4b:"bvec4","mat2x2<f32>":"mat2",mat2x2f:"mat2","mat3x3<f32>":"mat3",mat3x3f:"mat3","mat4x4<f32>":"mat4",mat4x4f:"mat4",sampler:"sampler",texture_1d:"texture",texture_2d:"texture",texture_2d_array:"texture",texture_multisampled_2d:"cubeTexture",texture_depth_2d:"depthTexture",texture_depth_2d_array:"depthTexture",texture_depth_multisampled_2d:"depthTexture",texture_depth_cube:"depthTexture",texture_depth_cube_array:"depthTexture",texture_3d:"texture3D",texture_cube:"cubeTexture",texture_cube_array:"cubeTexture",texture_storage_1d:"storageTexture",texture_storage_2d:"storageTexture",texture_storage_2d_array:"storageTexture",texture_storage_3d:"storageTexture"},lA=class extends fv{constructor(e){const{type:t,inputs:s,name:i,inputsCode:r,blockCode:n,outputType:a}=(e=>{const t=(e=e.trim()).match(aA);if(null!==t&&4===t.length){const s=t[2],i=[];let r=null;for(;null!==(r=oA.exec(s));)i.push({name:r[1],type:r[2]});const n=[];for(let e=0;e<i.length;e++){const{name:t,type:s}=i[e];let r=s;r.startsWith("ptr")?r="pointer":(r.startsWith("texture")&&(r=s.split("<")[0]),r=uA[r]),n.push(new rv(r,t))}const a=e.substring(t[0].length),o=t[3]||"void",l=void 0!==t[1]?t[1]:"";return{type:uA[o]||o,inputs:n,name:l,inputsCode:s,blockCode:a,outputType:o}}throw new Error("FunctionNode: Function is not a WGSL code.")})(e);super(t,s,i),this.inputsCode=r,this.blockCode=n,this.outputType=a}getCode(e=this.name){const t="void"!==this.outputType?"-> "+this.outputType:"";return`fn ${e} ( ${this.inputsCode.trim()} ) ${t}`+this.blockCode}},dA=class extends mv{parseFunction(e){return new lA(e)}},cA="undefined"!=typeof self?self.GPUShaderStage:{VERTEX:1,FRAGMENT:2,COMPUTE:4},hA={[ks2.READ_ONLY]:"read",[ks2.WRITE_ONLY]:"write",[ks2.READ_WRITE]:"read_write"},pA={[pt]:"repeat",[mt]:"clamp",[yt]:"mirror"},gA={vertex:cA?cA.VERTEX:1,fragment:cA?cA.FRAGMENT:2,compute:cA?cA.COMPUTE:4},mA={instance:!0,swizzleAssign:!1,storageBuffer:!0},fA={"^^":"tsl_xor"},yA={float:"f32",int:"i32",uint:"u32",bool:"bool",color:"vec3<f32>",vec2:"vec2<f32>",ivec2:"vec2<i32>",uvec2:"vec2<u32>",bvec2:"vec2<bool>",vec3:"vec3<f32>",ivec3:"vec3<i32>",uvec3:"vec3<u32>",bvec3:"vec3<bool>",vec4:"vec4<f32>",ivec4:"vec4<i32>",uvec4:"vec4<u32>",bvec4:"vec4<bool>",mat2:"mat2x2<f32>",mat3:"mat3x3<f32>",mat4:"mat4x4<f32>"},bA={},xA={tsl_xor:new qb("fn tsl_xor( a : bool, b : bool ) -> bool { return ( a || b ) && !( a && b ); }"),mod_float:new qb("fn tsl_mod_float( x : f32, y : f32 ) -> f32 { return x - y * floor( x / y ); }"),mod_vec2:new qb("fn tsl_mod_vec2( x : vec2f, y : vec2f ) -> vec2f { return x - y * floor( x / y ); }"),mod_vec3:new qb("fn tsl_mod_vec3( x : vec3f, y : vec3f ) -> vec3f { return x - y * floor( x / y ); }"),mod_vec4:new qb("fn tsl_mod_vec4( x : vec4f, y : vec4f ) -> vec4f { return x - y * floor( x / y ); }"),equals_bool:new qb("fn tsl_equals_bool( a : bool, b : bool ) -> bool { return a == b; }"),equals_bvec2:new qb("fn tsl_equals_bvec2( a : vec2f, b : vec2f ) -> vec2<bool> { return vec2<bool>( a.x == b.x, a.y == b.y ); }"),equals_bvec3:new qb("fn tsl_equals_bvec3( a : vec3f, b : vec3f ) -> vec3<bool> { return vec3<bool>( a.x == b.x, a.y == b.y, a.z == b.z ); }"),equals_bvec4:new qb("fn tsl_equals_bvec4( a : vec4f, b : vec4f ) -> vec4<bool> { return vec4<bool>( a.x == b.x, a.y == b.y, a.z == b.z, a.w == b.w ); }"),repeatWrapping_float:new qb("fn tsl_repeatWrapping_float( coord: f32 ) -> f32 { return fract( coord ); }"),mirrorWrapping_float:new qb("fn tsl_mirrorWrapping_float( coord: f32 ) -> f32 { let mirrored = fract( coord * 0.5 ) * 2.0; return 1.0 - abs( 1.0 - mirrored ); }"),clampWrapping_float:new qb("fn tsl_clampWrapping_float( coord: f32 ) -> f32 { return clamp( coord, 0.0, 1.0 ); }"),biquadraticTexture:new qb("\nfn tsl_biquadraticTexture( map : texture_2d<f32>, coord : vec2f, iRes : vec2u, level : u32 ) -> vec4f {\n\n\tlet res = vec2f( iRes );\n\n\tlet uvScaled = coord * res;\n\tlet uvWrapping = ( ( uvScaled % res ) + res ) % res;\n\n\t// https://www.shadertoy.com/view/WtyXRy\n\n\tlet uv = uvWrapping - 0.5;\n\tlet iuv = floor( uv );\n\tlet f = fract( uv );\n\n\tlet rg1 = textureLoad( map, vec2u( iuv + vec2( 0.5, 0.5 ) ) % iRes, level );\n\tlet rg2 = textureLoad( map, vec2u( iuv + vec2( 1.5, 0.5 ) ) % iRes, level );\n\tlet rg3 = textureLoad( map, vec2u( iuv + vec2( 0.5, 1.5 ) ) % iRes, level );\n\tlet rg4 = textureLoad( map, vec2u( iuv + vec2( 1.5, 1.5 ) ) % iRes, level );\n\n\treturn mix( mix( rg1, rg2, f.x ), mix( rg3, rg4, f.x ), f.y );\n\n}\n")},TA={dFdx:"dpdx",dFdy:"- dpdy",mod_float:"tsl_mod_float",mod_vec2:"tsl_mod_vec2",mod_vec3:"tsl_mod_vec3",mod_vec4:"tsl_mod_vec4",equals_bool:"tsl_equals_bool",equals_bvec2:"tsl_equals_bvec2",equals_bvec3:"tsl_equals_bvec3",equals_bvec4:"tsl_equals_bvec4",inversesqrt:"inverseSqrt",bitcast:"bitcast<f32>"};"undefined"!=typeof navigator&&/Windows/g.test(navigator.userAgent)&&(xA.pow_float=new qb("fn tsl_pow_float( a : f32, b : f32 ) -> f32 { return select( -pow( -a, b ), pow( a, b ), a > 0.0 ); }"),xA.pow_vec2=new qb("fn tsl_pow_vec2( a : vec2f, b : vec2f ) -> vec2f { return vec2f( tsl_pow_float( a.x, b.x ), tsl_pow_float( a.y, b.y ) ); }",[xA.pow_float]),xA.pow_vec3=new qb("fn tsl_pow_vec3( a : vec3f, b : vec3f ) -> vec3f { return vec3f( tsl_pow_float( a.x, b.x ), tsl_pow_float( a.y, b.y ), tsl_pow_float( a.z, b.z ) ); }",[xA.pow_float]),xA.pow_vec4=new qb("fn tsl_pow_vec4( a : vec4f, b : vec4f ) -> vec4f { return vec4f( tsl_pow_float( a.x, b.x ), tsl_pow_float( a.y, b.y ), tsl_pow_float( a.z, b.z ), tsl_pow_float( a.w, b.w ) ); }",[xA.pow_float]),TA.pow_float="tsl_pow_float",TA.pow_vec2="tsl_pow_vec2",TA.pow_vec3="tsl_pow_vec3",TA.pow_vec4="tsl_pow_vec4");var _A="";!0!==("undefined"!=typeof navigator&&/Firefox|Deno/g.test(navigator.userAgent))&&(_A+="diagnostic( off, derivative_uniformity );\n");var vA=class extends ev{constructor(e,t){super(e,t,new dA),this.uniformGroups={},this.builtins={},this.directives={},this.scopedArrays=new Map}_generateTextureSample(e,t,s,i,r=this.shaderStage){return"fragment"===r?i?`textureSample( ${t}, ${t}_sampler, ${s}, ${i} )`:`textureSample( ${t}, ${t}_sampler, ${s} )`:this.generateTextureSampleLevel(e,t,s,"0",i)}generateTextureSampleLevel(e,t,s,i,r){return!1===this.isUnfilterable(e)?`textureSampleLevel( ${t}, ${t}_sampler, ${s}, ${i} )`:this.isFilteredTexture(e)?this.generateFilteredTexture(e,t,s,i):this.generateTextureLod(e,t,s,r,i)}generateWrapFunction(e){const t=`tsl_coord_${pA[e.wrapS]}S_${pA[e.wrapT]}_${e.isData3DTexture?"3d":"2d"}T`;let s=bA[t];if(void 0===s){const i=[],r=e.isData3DTexture?"vec3f":"vec2f";let n=`fn ${t}( coord : ${r} ) -> ${r} {\n\n\treturn ${r}(\n`;const a=(e,t)=>{e===pt?(i.push(xA.repeatWrapping_float),n+=`\t\ttsl_repeatWrapping_float( coord.${t} )`):e===mt?(i.push(xA.clampWrapping_float),n+=`\t\ttsl_clampWrapping_float( coord.${t} )`):e===yt?(i.push(xA.mirrorWrapping_float),n+=`\t\ttsl_mirrorWrapping_float( coord.${t} )`):(n+=`\t\tcoord.${t}`,console.warn(`WebGPURenderer: Unsupported texture wrap type "${e}" for vertex shader.`))};a(e.wrapS,"x"),n+=",\n",a(e.wrapT,"y"),e.isData3DTexture&&(n+=",\n",a(e.wrapR,"z")),n+="\n\t);\n\n}\n",bA[t]=s=new qb(n,i)}return s.build(this),t}generateArrayDeclaration(e,t){return`array< ${this.getType(e)}, ${t} >`}generateTextureDimension(e,t,s){const i=this.getDataFromNode(e,this.shaderStage,this.globalCache);void 0===i.dimensionsSnippet&&(i.dimensionsSnippet={});let r=i.dimensionsSnippet[s];if(void 0===i.dimensionsSnippet[s]){let n,a;const{primarySamples:o}=this.renderer.backend.utils.getTextureSampleData(e),l=o>1;a=e.isData3DTexture?"vec3<u32>":"vec2<u32>",n=l||e.isStorageTexture?t:`${t}${s?`, u32( ${s} )`:""}`,r=new iu2(new Hu2(`textureDimensions( ${n} )`,a)),i.dimensionsSnippet[s]=r,(e.isArrayTexture||e.isDataArrayTexture||e.isData3DTexture)&&(i.arrayLayerCount=new iu2(new Hu2(`textureNumLayers(${t})`,"u32"))),e.isTextureCube&&(i.cubeFaceCount=new iu2(new Hu2("6u","u32")))}return r.build(this)}generateFilteredTexture(e,t,s,i="0u"){return this._include("biquadraticTexture"),`tsl_biquadraticTexture( ${t}, ${this.generateWrapFunction(e)}( ${s} ), ${this.generateTextureDimension(e,t,i)}, u32( ${i} ) )`}generateTextureLod(e,t,s,i,r="0u"){const n=this.generateWrapFunction(e),a=this.generateTextureDimension(e,t,r),o=e.isData3DTexture?"vec3":"vec2",l=`${o}<u32>( ${n}( ${s} ) * ${o}<f32>( ${a} ) )`;return this.generateTextureLoad(e,t,l,i,r)}generateTextureLoad(e,t,s,i,r="0u"){let n;return i?n=`textureLoad( ${t}, ${s}, ${i}, u32( ${r} ) )`:(n=`textureLoad( ${t}, ${s}, u32( ${r} ) )`,this.renderer.backend.compatibilityMode&&e.isDepthTexture&&(n+=".x")),n}generateTextureStore(e,t,s,i,r){let n;return n=i?`textureStore( ${t}, ${s}, ${i}, ${r} )`:`textureStore( ${t}, ${s}, ${r} )`,n}isSampleCompare(e){return!0===e.isDepthTexture&&null!==e.compareFunction}isUnfilterable(e){return"float"!==this.getComponentTypeFromTexture(e)||!this.isAvailable("float32Filterable")&&!0===e.isDataTexture&&e.type===Et||!1===this.isSampleCompare(e)&&e.minFilter===gt&&e.magFilter===gt||this.renderer.backend.utils.getTextureSampleData(e).primarySamples>1}generateTexture(e,t,s,i,r=this.shaderStage){let n=null;return n=this.isUnfilterable(e)?this.generateTextureLod(e,t,s,i,"0",r):this._generateTextureSample(e,t,s,i,r),n}generateTextureGrad(e,t,s,i,r,n=this.shaderStage){if("fragment"===n)return`textureSampleGrad( ${t}, ${t}_sampler, ${s},  ${i[0]}, ${i[1]} )`;console.error(`WebGPURenderer: THREE.TextureNode.gradient() does not support ${n} shader.`)}generateTextureCompare(e,t,s,i,r,n=this.shaderStage){if("fragment"===n)return!0===e.isDepthTexture&&!0===e.isArrayTexture?`textureSampleCompare( ${t}, ${t}_sampler, ${s}, ${r}, ${i} )`:`textureSampleCompare( ${t}, ${t}_sampler, ${s}, ${i} )`;console.error(`WebGPURenderer: THREE.DepthTexture.compareFunction() does not support ${n} shader.`)}generateTextureLevel(e,t,s,i,r){return!1===this.isUnfilterable(e)?`textureSampleLevel( ${t}, ${t}_sampler, ${s}, ${i} )`:this.isFilteredTexture(e)?this.generateFilteredTexture(e,t,s,i):this.generateTextureLod(e,t,s,r,i)}generateTextureBias(e,t,s,i,r,n=this.shaderStage){if("fragment"===n)return`textureSampleBias( ${t}, ${t}_sampler, ${s}, ${i} )`;console.error(`WebGPURenderer: THREE.TextureNode.biasNode does not support ${n} shader.`)}getPropertyName(e,t=this.shaderStage){if(!0===e.isNodeVarying&&!0===e.needsInterpolation){if("vertex"===t)return`varyings.${e.name}`}else if(!0===e.isNodeUniform){const t=e.name,s=e.type;return"texture"===s||"cubeTexture"===s||"storageTexture"===s||"texture3D"===s?t:"buffer"===s||"storageBuffer"===s||"indirectStorageBuffer"===s?this.isCustomStruct(e)?t:t+".value":e.groupNode.name+"."+t}return super.getPropertyName(e)}getOutputStructName(){return"output"}getFunctionOperator(e){const t=fA[e];return void 0!==t?(this._include(t),t):null}getNodeAccess(e,t){return"compute"!==t?!0===e.isAtomic?(console.warn("WebGPURenderer: Atomic operations are only supported in compute shaders."),ks2.READ_WRITE):ks2.READ_ONLY:e.access}getStorageAccess(e,t){return hA[this.getNodeAccess(e,t)]}getUniformFromNode(e,t,s,i=null){const r=super.getUniformFromNode(e,t,s,i),n=this.getDataFromNode(e,s,this.globalCache);if(void 0===n.uniformGPU){let a;const o=e.groupNode,l=o.name,h=this.getBindGroupArray(l,s);if("texture"===t||"cubeTexture"===t||"storageTexture"===t||"texture3D"===t){let i=null;const n=this.getNodeAccess(e,s);if("texture"===t||"storageTexture"===t?i=!0===e.value.is3DTexture?new hN(r.name,r.node,o,n):new dN(r.name,r.node,o,n):"cubeTexture"===t?i=new cN(r.name,r.node,o,n):"texture3D"===t&&(i=new hN(r.name,r.node,o,n)),i.store=!0===e.isStorageTextureNode,i.setVisibility(gA[s]),!1===this.isUnfilterable(e.value)&&!1===i.store){const e=new Qw(`${r.name}_sampler`,r.node,o);e.setVisibility(gA[s]),h.push(e,i),a=[e,i]}else h.push(i),a=[i]}else if("buffer"===t||"storageBuffer"===t||"indirectStorageBuffer"===t){const n=new("buffer"===t?sN:eA)(e,o);n.setVisibility(gA[s]),h.push(n),a=n,r.name=i||"NodeBuffer_"+r.id}else{const e=this.uniformGroups[s]||(this.uniformGroups[s]={});let i=e[l];void 0===i&&(i=new aN(l,o),i.setVisibility(gA[s]),e[l]=i,h.push(i)),a=this.getNodeUniform(r,t),i.addUniform(a)}n.uniformGPU=a}return r}getBuiltin(e,t,s,i=this.shaderStage){const r=this.builtins[i]||(this.builtins[i]=new Map);return!1===r.has(e)&&r.set(e,{name:e,property:t,type:s}),t}hasBuiltin(e,t=this.shaderStage){return void 0!==this.builtins[t]&&this.builtins[t].has(e)}getVertexIndex(){return"vertex"===this.shaderStage?this.getBuiltin("vertex_index","vertexIndex","u32","attribute"):"vertexIndex"}buildFunctionCode(e){const t=e.layout,s=this.flowShaderNode(e),i=[];for(const e of t.inputs)i.push(e.name+" : "+this.getType(e.type));let r=`fn ${t.name}( ${i.join(", ")} ) -> ${this.getType(t.type)} {\n${s.vars}\n${s.code}\n`;return s.result&&(r+=`\treturn ${s.result};\n`),r+="\n}\n",r}getInstanceIndex(){return"vertex"===this.shaderStage?this.getBuiltin("instance_index","instanceIndex","u32","attribute"):"instanceIndex"}getInvocationLocalIndex(){return this.getBuiltin("local_invocation_index","invocationLocalIndex","u32","attribute")}getSubgroupSize(){return this.enableSubGroups(),this.getBuiltin("subgroup_size","subgroupSize","u32","attribute")}getInvocationSubgroupIndex(){return this.enableSubGroups(),this.getBuiltin("subgroup_invocation_id","invocationSubgroupIndex","u32","attribute")}getSubgroupIndex(){return this.enableSubGroups(),this.getBuiltin("subgroup_id","subgroupIndex","u32","attribute")}getDrawIndex(){return null}getFrontFacing(){return this.getBuiltin("front_facing","isFront","bool")}getFragCoord(){return this.getBuiltin("position","fragCoord","vec4<f32>")+".xy"}getFragDepth(){return"output."+this.getBuiltin("frag_depth","depth","f32","output")}getClipDistance(){return"varyings.hw_clip_distances"}isFlipY(){return!1}enableDirective(e,t=this.shaderStage){(this.directives[t]||(this.directives[t]=new Set)).add(e)}getDirectives(e){const t=[],s=this.directives[e];if(void 0!==s)for(const e of s)t.push(`enable ${e};`);return t.join("\n")}enableSubGroups(){this.enableDirective("subgroups")}enableSubgroupsF16(){this.enableDirective("subgroups-f16")}enableClipDistances(){this.enableDirective("clip_distances")}enableShaderF16(){this.enableDirective("f16")}enableDualSourceBlending(){this.enableDirective("dual_source_blending")}enableHardwareClipping(e){this.enableClipDistances(),this.getBuiltin("clip_distances","hw_clip_distances",`array<f32, ${e} >`,"vertex")}getBuiltins(e){const t=[],s=this.builtins[e];if(void 0!==s)for(const{name:e,property:i,type:r}of s.values())t.push(`@builtin( ${e} ) ${i} : ${r}`);return t.join(",\n\t")}getScopedArray(e,t,s,i){return!1===this.scopedArrays.has(e)&&this.scopedArrays.set(e,{name:e,scope:t,bufferType:s,bufferCount:i}),e}getScopedArrays(e){if("compute"!==e)return;const t=[];for(const{name:e,scope:s,bufferType:i,bufferCount:r}of this.scopedArrays.values()){const n=this.getType(i);t.push(`var<${s}> ${e}: array< ${n}, ${r} >;`)}return t.join("\n")}getAttributes(e){const t=[];if("compute"===e&&(this.getBuiltin("global_invocation_id","globalId","vec3<u32>","attribute"),this.getBuiltin("workgroup_id","workgroupId","vec3<u32>","attribute"),this.getBuiltin("local_invocation_id","localId","vec3<u32>","attribute"),this.getBuiltin("num_workgroups","numWorkgroups","vec3<u32>","attribute"),this.renderer.hasFeature("subgroups")&&(this.enableDirective("subgroups",e),this.getBuiltin("subgroup_size","subgroupSize","u32","attribute"))),"vertex"===e||"compute"===e){const e=this.getBuiltins("attribute");e&&t.push(e);const s=this.getAttributesArray();for(let e=0,i=s.length;e<i;e++){const i=s[e],r=i.name,n=this.getType(i.type);t.push(`@location( ${e} ) ${r} : ${n}`)}}return t.join(",\n\t")}getStructMembers(e){const t=[];for(const s of e.members){const i=e.output?"@location( "+s.index+" ) ":"";let r=this.getType(s.type);s.atomic&&(r="atomic< "+r+" >"),t.push(`\t${i+s.name} : ${r}`)}return e.output&&t.push(`\t${this.getBuiltins("output")}`),t.join(",\n")}getStructs(e){let t="";const s=this.structs[e];if(s.length>0){const e=[];for(const t of s){let s=`struct ${t.name} {\n`;s+=this.getStructMembers(t),s+="\n};",e.push(s)}t="\n"+e.join("\n\n")+"\n"}return t}getVar(e,t,s=null){let i=`var ${t} : `;return i+=null!==s?this.generateArrayDeclaration(e,s):this.getType(e),i}getVars(e){const t=[],s=this.vars[e];if(void 0!==s)for(const e of s)t.push(`\t${this.getVar(e.type,e.name,e.count)};`);return`\n${t.join("\n")}\n`}getVaryings(e){const t=[];if("vertex"===e&&this.getBuiltin("position","Vertex","vec4<f32>","vertex"),"vertex"===e||"fragment"===e){const s=this.varyings,i=this.vars[e];for(let r=0;r<s.length;r++){const n=s[r];if(n.needsInterpolation){let e=`@location( ${r} )`;if(n.interpolationType){const t=null!==n.interpolationSampling?`, ${n.interpolationSampling} )`:" )";e+=` @interpolate( ${n.interpolationType}${t}`}else/^(int|uint|ivec|uvec)/.test(n.type)&&(e+=` @interpolate( ${this.renderer.backend.compatibilityMode?"flat, either":"flat"} )`);t.push(`${e} ${n.name} : ${this.getType(n.type)}`)}else"vertex"===e&&!1===i.includes(n)&&i.push(n)}}const s=this.getBuiltins(e);s&&t.push(s);const i=t.join(",\n\t");return"vertex"===e?this._getWGSLStruct("VaryingsStruct","\t"+i):i}isCustomStruct(e){const t=e.value,s=e.node,i=(t.isBufferAttribute||t.isInstancedBufferAttribute)&&null!==s.structTypeNode,r=s.value&&s.value.array&&"number"==typeof s.value.itemSize&&s.value.array.length>s.value.itemSize;return i&&!r}getUniforms(e){const t=this.uniforms[e],s=[],i=[],r=[],n={};for(const r of t){const t=r.groupNode.name,a=this.bindingsIndexes[t];if("texture"===r.type||"cubeTexture"===r.type||"storageTexture"===r.type||"texture3D"===r.type){const t=r.node.value;let i;!1===this.isUnfilterable(t)&&!0!==r.node.isStorageTextureNode&&(this.isSampleCompare(t)?s.push(`@binding( ${a.binding++} ) @group( ${a.group} ) var ${r.name}_sampler : sampler_comparison;`):s.push(`@binding( ${a.binding++} ) @group( ${a.group} ) var ${r.name}_sampler : sampler;`));let n="";const{primarySamples:o}=this.renderer.backend.utils.getTextureSampleData(t);if(o>1&&(n="_multisampled"),!0===t.isCubeTexture)i="texture_cube<f32>";else if(!0===t.isDepthTexture)i=this.renderer.backend.compatibilityMode&&null===t.compareFunction?`texture${n}_2d<f32>`:`texture_depth${n}_2d${!0===t.isArrayTexture?"_array":""}`;else if(!0===r.node.isStorageTextureNode){const s=nA(t),n=this.getStorageAccess(r.node,e),a=r.node.value.is3DTexture,o=r.node.value.isArrayTexture;i=`texture_storage_${a?"3d":"2d"+(o?"_array":"")}<${s}, ${n}>`}else i=!0===t.isArrayTexture||!0===t.isDataArrayTexture||!0===t.isCompressedArrayTexture?"texture_2d_array<f32>":!0===t.is3DTexture||!0===t.isData3DTexture?"texture_3d<f32>":`texture${n}_2d<${this.getComponentTypeFromTexture(t).charAt(0)}32>`;s.push(`@binding( ${a.binding++} ) @group( ${a.group} ) var ${r.name} : ${i};`)}else if("buffer"===r.type||"storageBuffer"===r.type||"indirectStorageBuffer"===r.type){const t=r.node,s=this.getType(t.getNodeType(this)),n=t.bufferCount,o=n>0&&"buffer"===r.type?", "+n:"",l=t.isStorageBufferNode?`storage, ${this.getStorageAccess(t,e)}`:"uniform";if(this.isCustomStruct(r))i.push(`@binding( ${a.binding++} ) @group( ${a.group} ) var<${l}> ${r.name} : ${s};`);else{const e=`\tvalue : array< ${t.isAtomic?`atomic<${s}>`:`${s}`}${o} >`;i.push(this._getWGSLStructBinding(r.name,e,l,a.binding++,a.group))}}else{const e=this.getType(this.getVectorType(r.type)),t=r.groupNode.name;(n[t]||(n[t]={index:a.binding++,id:a.group,snippets:[]})).snippets.push(`\t${r.name} : ${e}`)}}for(const e in n){const t=n[e];r.push(this._getWGSLStructBinding(e,t.snippets.join(",\n"),"uniform",t.index,t.id))}let a=s.join("\n");return a+=i.join("\n"),a+=r.join("\n"),a}buildCode(){const e=null!==this.material?{fragment:{},vertex:{}}:{compute:{}};this.sortBindingGroups();for(const t in e){this.shaderStage=t;const s=e[t];s.uniforms=this.getUniforms(t),s.attributes=this.getAttributes(t),s.varyings=this.getVaryings(t),s.structs=this.getStructs(t),s.vars=this.getVars(t),s.codes=this.getCodes(t),s.directives=this.getDirectives(t),s.scopedArrays=this.getScopedArrays(t);let i="// code\n\n";i+=this.flowCode[t];const r=this.flowNodes[t],n=r[r.length-1],a=n.outputNode,o=void 0!==a&&!0===a.isOutputStructNode;for(const e of r){const r=this.getFlowData(e),l=e.name;if(l&&(i.length>0&&(i+="\n"),i+=`\t// flow -> ${l}\n`),i+=`${r.code}\n\t`,e===n&&"compute"!==t)if(i+="// result\n\n\t","vertex"===t)i+=`varyings.Vertex = ${r.result};`;else if("fragment"===t)if(o)s.returnType=a.getNodeType(this),s.structs+="var<private> output : "+s.returnType+";",i+=`return ${r.result};`;else{let e="\t@location(0) color: vec4<f32>";const t=this.getBuiltins("output");t&&(e+=",\n\t"+t),s.returnType="OutputStruct",s.structs+=this._getWGSLStruct("OutputStruct",e),s.structs+="\nvar<private> output : OutputStruct;",i+=`output.color = ${r.result};\n\n\treturn output;`}}s.flow=i}if(this.shaderStage=null,null!==this.material)this.vertexShader=this._getWGSLVertexCode(e.vertex),this.fragmentShader=this._getWGSLFragmentCode(e.fragment);else{const t=this.object.workgroupSize;this.computeShader=this._getWGSLComputeCode(e.compute,t)}}getMethod(e,t=null){let s;return null!==t&&(s=this._getWGSLMethod(e+"_"+t)),void 0===s&&(s=this._getWGSLMethod(e)),s||e}getType(e){return yA[e]||e}isAvailable(e){let t=mA[e];return void 0===t&&("float32Filterable"===e?t=this.renderer.hasFeature("float32-filterable"):"clipDistance"===e&&(t=this.renderer.hasFeature("clip-distances")),mA[e]=t),t}_getWGSLMethod(e){return void 0!==xA[e]&&this._include(e),TA[e]}_include(e){const t=xA[e];return t.build(this),null!==this.currentFunctionNode&&this.currentFunctionNode.includes.push(t),t}_getWGSLVertexCode(e){return`${this.getSignature()}\n// directives\n${e.directives}\n\n// structs\n${e.structs}\n\n// uniforms\n${e.uniforms}\n\n// varyings\n${e.varyings}\nvar<private> varyings : VaryingsStruct;\n\n// codes\n${e.codes}\n\n@vertex\nfn main( ${e.attributes} ) -> VaryingsStruct {\n\n\t// vars\n\t${e.vars}\n\n\t// flow\n\t${e.flow}\n\n\treturn varyings;\n\n}\n`}_getWGSLFragmentCode(e){return`${this.getSignature()}\n// global\n${_A}\n\n// structs\n${e.structs}\n\n// uniforms\n${e.uniforms}\n\n// codes\n${e.codes}\n\n@fragment\nfn main( ${e.varyings} ) -> ${e.returnType} {\n\n\t// vars\n\t${e.vars}\n\n\t// flow\n\t${e.flow}\n\n}\n`}_getWGSLComputeCode(e,t){const[s,i,r]=t;return`${this.getSignature()}\n// directives\n${e.directives}\n\n// system\nvar<private> instanceIndex : u32;\n\n// locals\n${e.scopedArrays}\n\n// structs\n${e.structs}\n\n// uniforms\n${e.uniforms}\n\n// codes\n${e.codes}\n\n@compute @workgroup_size( ${s}, ${i}, ${r} )\nfn main( ${e.attributes} ) {\n\n\t// system\n\tinstanceIndex = globalId.x\n\t\t+ globalId.y * ( ${s} * numWorkgroups.x )\n\t\t+ globalId.z * ( ${s} * numWorkgroups.x ) * ( ${i} * numWorkgroups.y );\n\n\t// vars\n\t${e.vars}\n\n\t// flow\n\t${e.flow}\n\n}\n`}_getWGSLStruct(e,t){return`\nstruct ${e} {\n${t}\n};`}_getWGSLStructBinding(e,t,s,i=0,r=0){const n=e+"Struct";return`${this._getWGSLStruct(n,t)}\n@binding( ${i} ) @group( ${r} )\nvar<${s}> ${e} : ${n};`}},NA=class{constructor(e){this.backend=e}getCurrentDepthStencilFormat(e){let t;return null!==e.depthTexture?t=this.getTextureFormatGPU(e.depthTexture):e.depth&&e.stencil?t=KS:e.depth&&(t=XS),t}getTextureFormatGPU(e){return this.backend.get(e).format}getTextureSampleData(e){let t;if(e.isFramebufferTexture)t=1;else if(e.isDepthTexture&&!e.renderTarget){const e=this.backend.renderer,s=e.getRenderTarget();t=s?s.samples:e.samples}else e.renderTarget&&(t=e.renderTarget.samples);t=t||1;const s=t>1&&null!==e.renderTarget&&!0!==e.isDepthTexture&&!0!==e.isFramebufferTexture;return{samples:t,primarySamples:s?1:t,isMSAA:s}}getCurrentColorFormat(e){let t;return t=null!==e.textures?this.getTextureFormatGPU(e.textures[0]):this.getPreferredCanvasFormat(),t}getCurrentColorSpace(e){return null!==e.textures?e.textures[0].colorSpace:this.backend.renderer.outputColorSpace}getPrimitiveTopology(e,t){return e.isPoints?HN:e.isLineSegments||e.isMesh&&!0===t.wireframe?$N:e.isLine?WN:e.isMesh?qN:void 0}getSampleCount(e){return e>=4?4:1}getSampleCountRenderContext(e){return null!==e.textures?this.getSampleCount(e.sampleCount):this.getSampleCount(this.backend.renderer.samples)}getPreferredCanvasFormat(){const e=this.backend.parameters.outputType;if(void 0===e)return navigator.gpu.getPreferredCanvasFormat();if(e===Tt)return LS;if(e===Rt)return HS;throw new Error("Unsupported outputType")}},SA=new Map([[Int8Array,["sint8","snorm8"]],[Uint8Array,["uint8","unorm8"]],[Int16Array,["sint16","snorm16"]],[Uint16Array,["uint16","unorm16"]],[Int32Array,["sint32","snorm32"]],[Uint32Array,["uint32","unorm32"]],[Float32Array,["float32"]]]);"undefined"!=typeof Float16Array&&SA.set(Float16Array,["float16"]);var EA=new Map([[bn,["float16"]]]),wA=new Map([[Int32Array,"sint32"],[Int16Array,"sint32"],[Uint32Array,"uint32"],[Uint16Array,"uint32"],[Float32Array,"float32"]]),AA=class{constructor(e){this.backend=e}createAttribute(e,t){const s=this._getBufferAttribute(e),i=this.backend,r=i.get(s);let n=r.buffer;if(void 0===n){const a=i.device;let o=s.array;if(!1===e.normalized)if(o.constructor===Int16Array||o.constructor===Int8Array)o=new Int32Array(o);else if((o.constructor===Uint16Array||o.constructor===Uint8Array)&&(o=new Uint32Array(o),t&GPUBufferUsage.INDEX))for(let e=0;e<o.length;e++)65535===o[e]&&(o[e]=4294967295);if(s.array=o,(s.isStorageBufferAttribute||s.isStorageInstancedBufferAttribute)&&3===s.itemSize){o=new o.constructor(4*s.count);for(let e=0;e<s.count;e++)o.set(s.array.subarray(3*e,3*e+3),4*e);s.itemSize=4,s.array=o,r._force3to4BytesAlignment=!0}const l=o.byteLength,h=l+(4-l%4)%4;n=a.createBuffer({label:s.name,size:h,usage:t,mappedAtCreation:!0}),new o.constructor(n.getMappedRange()).set(o),n.unmap(),r.buffer=n}}updateAttribute(e){const t=this._getBufferAttribute(e),s=this.backend,i=s.device,r=s.get(t),n=s.get(t).buffer;let a=t.array;if(!0===r._force3to4BytesAlignment){a=new a.constructor(4*t.count);for(let e=0;e<t.count;e++)a.set(t.array.subarray(3*e,3*e+3),4*e);t.array=a}const o=this._isTypedArray(a),l=t.updateRanges;if(0===l.length)i.queue.writeBuffer(n,0,a,0);else{const e=o?1:a.BYTES_PER_ELEMENT;for(let t=0,s=l.length;t<s;t++){const s=l[t];let h,u;!0===r._force3to4BytesAlignment?(h=4*Math.floor(s.start/3)*e,u=4*Math.ceil(s.count/3)*e):(h=s.start*e,u=s.count*e);const c=h*(o?a.BYTES_PER_ELEMENT:1);i.queue.writeBuffer(n,c,a,h,u)}t.clearUpdateRanges()}}createShaderVertexBuffers(e){const t=e.getAttributes(),s=new Map;for(let e=0;e<t.length;e++){const i=t[e],r=i.array.BYTES_PER_ELEMENT,n=this._getBufferAttribute(i);let a=s.get(n);if(void 0===a){let e,t;!0===i.isInterleavedBufferAttribute?(e=i.data.stride*r,t=i.data.isInstancedInterleavedBuffer?Kw:Xw):(e=i.itemSize*r,t=i.isInstancedBufferAttribute?Kw:Xw),!1!==i.normalized||i.array.constructor!==Int16Array&&i.array.constructor!==Uint16Array||(e=4),a={arrayStride:e,attributes:[],stepMode:t},s.set(n,a)}const o=this._getVertexFormat(i),l=!0===i.isInterleavedBufferAttribute?i.offset*r:0;a.attributes.push({shaderLocation:e,offset:l,format:o})}return Array.from(s.values())}destroyAttribute(e){const t=this.backend;t.get(this._getBufferAttribute(e)).buffer.destroy(),t.delete(e)}async getArrayBufferAsync(e){const t=this.backend,s=t.device,i=t.get(this._getBufferAttribute(e)).buffer,r=i.size,n=s.createBuffer({label:`${e.name}_readback`,size:r,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),a=s.createCommandEncoder({label:`readback_encoder_${e.name}`});a.copyBufferToBuffer(i,0,n,0,r);const o=a.finish();s.queue.submit([o]),await n.mapAsync(GPUMapMode.READ);const l=n.getMappedRange(),h=new e.array.constructor(l.slice(0));return n.unmap(),h.buffer}_getVertexFormat(e){const{itemSize:t,normalized:s}=e,i=e.array.constructor,r=e.constructor;let n;if(1===t)n=wA.get(i);else{const e=(EA.get(r)||SA.get(i))[s?1:0];if(e){const s=i.BYTES_PER_ELEMENT*t,r=4*Math.floor((s+3)/4)/i.BYTES_PER_ELEMENT;if(r%1)throw new Error("THREE.WebGPUAttributeUtils: Bad vertex format item size.");n=`${e}x${r}`}}return n||console.error("THREE.WebGPUAttributeUtils: Vertex format not supported yet."),n}_isTypedArray(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)}_getBufferAttribute(e){return e.isInterleavedBufferAttribute&&(e=e.data),e}},RA=class{constructor(e){this.backend=e,this.bindGroupLayoutCache=new WeakMap}createBindingsLayout(e){const t=this.backend,s=t.device,i=[];let r=0;for(const s of e.bindings){const e={binding:r++,visibility:s.visibility};if(s.isUniformBuffer||s.isStorageBuffer){const t={};s.isStorageBuffer&&(4&s.visibility&&(s.access===ks2.READ_WRITE||s.access===ks2.WRITE_ONLY)?t.type=Cw:t.type=Mw),e.buffer=t}else if(s.isSampledTexture&&s.store){const t={};t.format=this.backend.get(s.texture).texture.format;const i=s.access;t.access=i===ks2.READ_WRITE?Lw:i===ks2.WRITE_ONLY?Pw:Bw,s.texture.isArrayTexture?t.viewDimension=$w:s.texture.is3DTexture&&(t.viewDimension=qw),e.storageTexture=t}else if(s.isSampledTexture){const i={},{primarySamples:r}=t.utils.getTextureSampleData(s.texture);if(r>1&&(i.multisampled=!0,s.texture.isDepthTexture||(i.sampleType=Vw)),s.texture.isDepthTexture)t.compatibilityMode&&null===s.texture.compareFunction?i.sampleType=Vw:i.sampleType=Uw;else if(s.texture.isDataTexture||s.texture.isDataArrayTexture||s.texture.isData3DTexture){const e=s.texture.type;e===Bt?i.sampleType=Ow:e===kt?i.sampleType=kw:e===Et&&(this.backend.hasFeature("float32-filterable")?i.sampleType=Dw:i.sampleType=Vw)}s.isSampledCubeTexture?i.viewDimension=Ww:s.texture.isArrayTexture||s.texture.isDataArrayTexture||s.texture.isCompressedArrayTexture?i.viewDimension=$w:s.isSampledTexture3D&&(i.viewDimension=qw),e.texture=i}else if(s.isSampler){const i={};s.texture.isDepthTexture&&(null!==s.texture.compareFunction?i.type=Iw:t.compatibilityMode&&(i.type=Fw)),e.sampler=i}else console.error(`WebGPUBindingUtils: Unsupported binding "${s}".`);i.push(e)}return s.createBindGroupLayout({entries:i})}createBindings(e,t,s,i=0){const{backend:r,bindGroupLayoutCache:n}=this,a=r.get(e);let o,l=n.get(e.bindingsReference);void 0===l&&(l=this.createBindingsLayout(e),n.set(e.bindingsReference,l)),s>0&&(void 0===a.groups&&(a.groups=[],a.versions=[]),a.versions[s]===i&&(o=a.groups[s])),void 0===o&&(o=this.createBindGroup(e,l),s>0&&(a.groups[s]=o,a.versions[s]=i)),a.group=o,a.layout=l}updateBinding(e){const t=this.backend,s=t.device,i=e.buffer,r=t.get(e).buffer;s.queue.writeBuffer(r,0,i,0)}createBindGroupIndex(e,t){const s=this.backend.device,i=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,r=e[0],n=s.createBuffer({label:"bindingCameraIndex_"+r,size:16,usage:i});s.queue.writeBuffer(n,0,e,0);const a=[{binding:0,resource:{buffer:n}}];return s.createBindGroup({label:"bindGroupCameraIndex_"+r,layout:t,entries:a})}createBindGroup(e,t){const s=this.backend,i=s.device;let r=0;const n=[];for(const t of e.bindings){if(t.isUniformBuffer){const e=s.get(t);if(void 0===e.buffer){const s=t.byteLength,r=GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,n=i.createBuffer({label:"bindingBuffer_"+t.name,size:s,usage:r});e.buffer=n}n.push({binding:r,resource:{buffer:e.buffer}})}else if(t.isStorageBuffer){const e=s.get(t);if(void 0===e.buffer){const i=t.attribute;e.buffer=s.get(i).buffer}n.push({binding:r,resource:{buffer:e.buffer}})}else if(t.isSampledTexture){const e=s.get(t.texture);let a;if(void 0!==e.externalTexture)a=i.importExternalTexture({source:e.externalTexture});else{const s=t.store?1:e.texture.mipLevelCount;let i=`view-${e.texture.width}-${e.texture.height}`;if(e.texture.depthOrArrayLayers>1&&(i+=`-${e.texture.depthOrArrayLayers}`),i+=`-${s}`,a=e[i],void 0===a){const r=jw;let n;n=t.isSampledCubeTexture?Ww:t.isSampledTexture3D?qw:t.texture.isArrayTexture||t.texture.isDataArrayTexture||t.texture.isCompressedArrayTexture?$w:Hw,a=e[i]=e.texture.createView({aspect:r,dimension:n,mipLevelCount:s})}}n.push({binding:r,resource:a})}else if(t.isSampler){const e=s.get(t.texture);n.push({binding:r,resource:e.sampler})}r++}return i.createBindGroup({label:"bindGroup_"+e.name,layout:t,entries:n})}},CA=class{constructor(e){this.backend=e,this._activePipelines=new WeakMap}setPipeline(e,t){this._activePipelines.get(e)!==t&&(e.setPipeline(t),this._activePipelines.set(e,t))}_getSampleCount(e){return this.backend.utils.getSampleCountRenderContext(e)}createRenderPipeline(e,t){const{object:s,material:i,geometry:r,pipeline:n}=e,{vertexProgram:a,fragmentProgram:o}=n,l=this.backend,h=l.device,u=l.utils,c=l.get(n),d=[];for(const t of e.getBindings()){const e=l.get(t);d.push(e.layout)}const p=l.attributeUtils.createShaderVertexBuffers(e);let _;i.blending===m||i.blending===y&&!1===i.transparent||(_=this._getBlending(i));let f={};!0===i.stencilWrite&&(f={compare:this._getStencilCompare(i),failOp:this._getStencilOperation(i.stencilFail),depthFailOp:this._getStencilOperation(i.stencilZFail),passOp:this._getStencilOperation(i.stencilZPass)});const g=this._getColorWriteMask(i),S=[];if(null!==e.context.textures){const t=e.context.textures;for(let e=0;e<t.length;e++){const s=u.getTextureFormatGPU(t[e]);S.push({format:s,blend:_,writeMask:g})}}else{const t=u.getCurrentColorFormat(e.context);S.push({format:t,blend:_,writeMask:g})}const T=l.get(a).module,x=l.get(o).module,b=this._getPrimitiveState(s,r,i),G=this._getDepthCompare(i),I=u.getCurrentDepthStencilFormat(e.context),v=this._getSampleCount(e.context),C={label:`renderPipeline_${i.name||i.type}_${i.id}`,vertex:Object.assign({},T,{buffers:p}),fragment:Object.assign({},x,{targets:S}),primitive:b,multisample:{count:v,alphaToCoverageEnabled:i.alphaToCoverage&&v>1},layout:h.createPipelineLayout({bindGroupLayouts:d})},w={},A=e.context.depth,R=e.context.stencil;if(!0!==A&&!0!==R||(!0===A&&(w.format=I,w.depthWriteEnabled=i.depthWrite,w.depthCompare=G),!0===R&&(w.stencilFront=f,w.stencilBack={},w.stencilReadMask=i.stencilFuncMask,w.stencilWriteMask=i.stencilWriteMask),!0===i.polygonOffset&&(w.depthBias=i.polygonOffsetUnits,w.depthBiasSlopeScale=i.polygonOffsetFactor,w.depthBiasClamp=0),C.depthStencil=w),null===t)c.pipeline=h.createRenderPipeline(C);else{const e=new Promise(e=>{h.createRenderPipelineAsync(C).then(t=>{c.pipeline=t,e()})});t.push(e)}}createBundleEncoder(e,t="renderBundleEncoder"){const s=this.backend,{utils:i,device:r}=s,n=i.getCurrentDepthStencilFormat(e),a={label:t,colorFormats:[i.getCurrentColorFormat(e)],depthStencilFormat:n,sampleCount:this._getSampleCount(e)};return r.createRenderBundleEncoder(a)}createComputePipeline(e,t){const s=this.backend,i=s.device,r=s.get(e.computeProgram).module,n=s.get(e),a=[];for(const e of t){const t=s.get(e);a.push(t.layout)}n.pipeline=i.createComputePipeline({compute:r,layout:i.createPipelineLayout({bindGroupLayouts:a})})}_getBlending(e){let t,s;const i=e.blending,r=e.blendSrc,n=e.blendDst,a=e.blendEquation;if(i===b){const i=null!==e.blendSrcAlpha?e.blendSrcAlpha:r,o=null!==e.blendDstAlpha?e.blendDstAlpha:n,l=null!==e.blendEquationAlpha?e.blendEquationAlpha:a;t={srcFactor:this._getBlendFactor(r),dstFactor:this._getBlendFactor(n),operation:this._getBlendOperation(a)},s={srcFactor:this._getBlendFactor(i),dstFactor:this._getBlendFactor(o),operation:this._getBlendOperation(l)}}else{const r=(e,i,r,n)=>{t={srcFactor:e,dstFactor:i,operation:gw},s={srcFactor:r,dstFactor:n,operation:gw}};if(e.premultipliedAlpha)switch(i){case y:r(rw,aw,rw,aw);break;case g:r(rw,rw,rw,rw);break;case f2:r(tw,iw,tw,rw);break;case x:r(ow,aw,tw,rw)}else switch(i){case y:r(nw2,aw,rw,aw);break;case g:r(nw2,rw,rw,rw);break;case f2:console.error("THREE.WebGPURenderer: SubtractiveBlending requires material.premultipliedAlpha = true");break;case x:console.error("THREE.WebGPURenderer: MultiplyBlending requires material.premultipliedAlpha = true")}}if(void 0!==t&&void 0!==s)return{color:t,alpha:s};console.error("THREE.WebGPURenderer: Invalid blending: ",i)}_getBlendFactor(e){let t;switch(e){case A:t=tw;break;case T:t=rw;break;case z:t=sw;break;case C:t=iw;break;case I:t=nw2;break;case B:t=aw;break;case R:t=ow;break;case P:t=uw;break;case k:t=lw;break;case E:t=dw;break;case O:t=cw;break;case 211:t=hw;break;case 212:t=pw;break;default:console.error("THREE.WebGPURenderer: Blend factor not supported.",e)}return t}_getStencilCompare(e){let t;const s=e.stencilFunc;switch(s){case ai:t=XN;break;case pi:t=tS;break;case oi:t=KN;break;case li:t=QN;break;case hi:t=YN;break;case di:t=eS;break;case ci:t=ZN;break;case ui:t=JN;break;default:console.error("THREE.WebGPURenderer: Invalid stencil function.",s)}return t}_getStencilOperation(e){let t;switch(e){case Ke:t=_w;break;case Qe:t=vw;break;case ti:t=Nw;break;case ni:t=Sw;break;case ei:t=Ew;break;case ii:t=ww;break;case si:t=Aw;break;case ri:t=Rw;break;default:console.error("THREE.WebGPURenderer: Invalid stencil operation.",t)}return t}_getBlendOperation(e){let t;switch(e){case v:t=gw;break;case w:t=mw;break;case M:t=fw;break;case S:t=yw;break;case _:t=bw;break;default:console.error("THREE.WebGPUPipelineUtils: Blend equation not supported.",e)}return t}_getPrimitiveState(e,t,s){const i={},r=this.backend.utils;switch(i.topology=r.getPrimitiveTopology(e,s),null!==t.index&&!0===e.isLine&&!0!==e.isLineSegments&&(i.stripIndexFormat=t.index.array instanceof Uint16Array?lS:dS),s.side){case u:i.frontFace=nS,i.cullMode=uS;break;case d2:i.frontFace=nS,i.cullMode=oS;break;case p:i.frontFace=nS,i.cullMode=aS;break;default:console.error("THREE.WebGPUPipelineUtils: Unknown material.side value.",s.side)}return i}_getColorWriteMask(e){return!0===e.colorWrite?Tw:xw}_getDepthCompare(e){let t;if(!1===e.depthTest)t=tS;else{const s=e.depthFunc;switch(s){case j:t=XN;break;case W:t=tS;break;case D:t=KN;break;case U:t=QN;break;case H:t=YN;break;case q:t=eS;break;case J:t=ZN;break;case X:t=JN;break;default:console.error("THREE.WebGPUPipelineUtils: Invalid depth function.",s)}}return t}},MA=class extends kN{constructor(e,t,s=2048){super(s),this.device=e,this.type=t,this.querySet=this.device.createQuerySet({type:"timestamp",count:this.maxQueries,label:`queryset_global_timestamp_${t}`});const i=8*this.maxQueries;this.resolveBuffer=this.device.createBuffer({label:`buffer_timestamp_resolve_${t}`,size:i,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.resultBuffer=this.device.createBuffer({label:`buffer_timestamp_result_${t}`,size:i,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})}allocateQueriesForContext(e){if(!this.trackTimestamp||this.isDisposed)return null;if(this.currentQueryIndex+2>this.maxQueries)return ls(`WebGPUTimestampQueryPool [${this.type}]: Maximum number of queries exceeded, when using trackTimestamp it is necessary to resolves the queries via renderer.resolveTimestampsAsync( THREE.TimestampQuery.${this.type.toUpperCase()} ).`),null;const t=this.currentQueryIndex;return this.currentQueryIndex+=2,this.queryOffsets.set(e.id,t),t}async resolveQueriesAsync(){if(!this.trackTimestamp||0===this.currentQueryIndex||this.isDisposed)return this.lastValue;if(this.pendingResolve)return this.pendingResolve;this.pendingResolve=this._resolveQueries();try{return await this.pendingResolve}finally{this.pendingResolve=null}}async _resolveQueries(){if(this.isDisposed)return this.lastValue;try{if("unmapped"!==this.resultBuffer.mapState)return this.lastValue;const e=new Map(this.queryOffsets),t=this.currentQueryIndex,s=8*t;this.currentQueryIndex=0,this.queryOffsets.clear();const i=this.device.createCommandEncoder();i.resolveQuerySet(this.querySet,0,t,this.resolveBuffer,0),i.copyBufferToBuffer(this.resolveBuffer,0,this.resultBuffer,0,s);const r=i.finish();if(this.device.queue.submit([r]),"unmapped"!==this.resultBuffer.mapState)return this.lastValue;if(await this.resultBuffer.mapAsync(GPUMapMode.READ,0,s),this.isDisposed)return"mapped"===this.resultBuffer.mapState&&this.resultBuffer.unmap(),this.lastValue;const n=new BigUint64Array(this.resultBuffer.getMappedRange(0,s));let a=0;for(const[,t]of e){const e=n[t],s=n[t+1];a+=Number(s-e)/1e6}return this.resultBuffer.unmap(),this.lastValue=a,a}catch(e){return console.error("Error resolving queries:",e),"mapped"===this.resultBuffer.mapState&&this.resultBuffer.unmap(),this.lastValue}}async dispose(){if(!this.isDisposed){if(this.isDisposed=!0,this.pendingResolve)try{await this.pendingResolve}catch(e){console.error("Error waiting for pending resolve:",e)}if(this.resultBuffer&&"mapped"===this.resultBuffer.mapState)try{this.resultBuffer.unmap()}catch(e){console.error("Error unmapping buffer:",e)}this.querySet&&(this.querySet.destroy(),this.querySet=null),this.resolveBuffer&&(this.resolveBuffer.destroy(),this.resolveBuffer=null),this.resultBuffer&&(this.resultBuffer.destroy(),this.resultBuffer=null),this.queryOffsets.clear(),this.pendingResolve=null}}},PA=class extends vN{constructor(e={}){super(e),this.isWebGPUBackend=!0,this.parameters.alpha=void 0===e.alpha||e.alpha,this.parameters.compatibilityMode=void 0!==e.compatibilityMode&&e.compatibilityMode,this.parameters.requiredLimits=void 0===e.requiredLimits?{}:e.requiredLimits,this.compatibilityMode=this.parameters.compatibilityMode,this.device=null,this.context=null,this.colorBuffer=null,this.defaultRenderPassdescriptor=null,this.utils=new NA(this),this.attributeUtils=new AA(this),this.bindingUtils=new RA(this),this.pipelineUtils=new CA(this),this.textureUtils=new iA(this),this.occludedResolveCache=new Map}async init(e){await super.init(e);const t=this.parameters;let s;if(void 0===t.device){const e={powerPreference:t.powerPreference,featureLevel:t.compatibilityMode?"compatibility":void 0},i="undefined"!=typeof navigator?await navigator.gpu.requestAdapter(e):null;if(null===i)throw new Error("WebGPUBackend: Unable to create WebGPU adapter.");const r=Object.values(Yw),n=[];for(const e of r)i.features.has(e)&&n.push(e);const a={requiredFeatures:n,requiredLimits:t.requiredLimits};s=await i.requestDevice(a)}else s=t.device;s.lost.then(t=>{const s={api:"WebGPU",message:t.message||"Unknown reason",reason:t.reason||null,originalEvent:t};e.onDeviceLost(s)});const i=void 0!==t.context?t.context:e.domElement.getContext("webgpu");this.device=s,this.context=i;const r=t.alpha?"premultiplied":"opaque";this.trackTimestamp=this.trackTimestamp&&this.hasFeature(Yw.TimestampQuery),this.context.configure({device:this.device,format:this.utils.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC,alphaMode:r}),this.updateSize()}get coordinateSystem(){return Pi}async getArrayBufferAsync(e){return await this.attributeUtils.getArrayBufferAsync(e)}getContext(){return this.context}_getDefaultRenderPassDescriptor(){let e=this.defaultRenderPassdescriptor;if(null===e){const t=this.renderer;e={colorAttachments:[{view:null}]},!0!==this.renderer.depth&&!0!==this.renderer.stencil||(e.depthStencilAttachment={view:this.textureUtils.getDepthBuffer(t.depth,t.stencil).createView()});const s=e.colorAttachments[0];this.renderer.samples>0?s.view=this.colorBuffer.createView():s.resolveTarget=void 0,this.defaultRenderPassdescriptor=e}const t=e.colorAttachments[0];return this.renderer.samples>0?t.resolveTarget=this.context.getCurrentTexture().createView():t.view=this.context.getCurrentTexture().createView(),e}_isRenderCameraDepthArray(e){return e.depthTexture&&e.depthTexture.image.depth>1&&e.camera.isArrayCamera}_getRenderPassDescriptor(e,t={}){const s=e.renderTarget,i=this.get(s);let r=i.descriptors;if(void 0===r||i.width!==s.width||i.height!==s.height||i.dimensions!==s.dimensions||i.activeMipmapLevel!==e.activeMipmapLevel||i.activeCubeFace!==e.activeCubeFace||i.samples!==s.samples){r={},i.descriptors=r;const e=()=>{s.removeEventListener("dispose",e),this.delete(s)};!1===s.hasEventListener("dispose",e)&&s.addEventListener("dispose",e)}const n=e.getCacheKey();let a=r[n];if(void 0===a){const t=e.textures,o=[];let l;const h=this._isRenderCameraDepthArray(e);for(let i=0;i<t.length;i++){const r=this.get(t[i]),n={label:`colorAttachment_${i}`,baseMipLevel:e.activeMipmapLevel,mipLevelCount:1,baseArrayLayer:e.activeCubeFace,arrayLayerCount:1,dimension:Hw};if(s.isRenderTarget3D)l=e.activeCubeFace,n.baseArrayLayer=0,n.dimension=qw,n.depthOrArrayLayers=t[i].image.depth;else if(s.isRenderTarget&&t[i].image.depth>1)if(!0===h){const t=e.camera.cameras;for(let e=0;e<t.length;e++){const t={...n,baseArrayLayer:e,arrayLayerCount:1,dimension:Hw},s=r.texture.createView(t);o.push({view:s,resolveTarget:void 0,depthSlice:void 0})}}else n.dimension=$w,n.depthOrArrayLayers=t[i].image.depth;if(!0!==h){const e=r.texture.createView(n);let t,s;void 0!==r.msaaTexture?(t=r.msaaTexture.createView(),s=e):(t=e,s=void 0),o.push({view:t,resolveTarget:s,depthSlice:l})}}if(a={textureViews:o},e.depth){const t=this.get(e.depthTexture),s={};e.depthTexture.isArrayTexture&&(s.dimension=Hw,s.arrayLayerCount=1,s.baseArrayLayer=e.activeCubeFace),a.depthStencilView=t.texture.createView(s)}r[n]=a,i.width=s.width,i.height=s.height,i.samples=s.samples,i.activeMipmapLevel=e.activeMipmapLevel,i.activeCubeFace=e.activeCubeFace,i.dimensions=s.dimensions}const o={colorAttachments:[]};for(let e=0;e<a.textureViews.length;e++){const s=a.textureViews[e];let i={r:0,g:0,b:0,a:1};0===e&&t.clearValue&&(i=t.clearValue),o.colorAttachments.push({view:s.view,depthSlice:s.depthSlice,resolveTarget:s.resolveTarget,loadOp:t.loadOp||sS,storeOp:t.storeOp||rS,clearValue:i})}return a.depthStencilView&&(o.depthStencilAttachment={view:a.depthStencilView}),o}beginRender(e){const t=this.get(e),s=this.device,i=e.occlusionQueryCount;let r,n;i>0&&(t.currentOcclusionQuerySet&&t.currentOcclusionQuerySet.destroy(),t.currentOcclusionQueryBuffer&&t.currentOcclusionQueryBuffer.destroy(),t.currentOcclusionQuerySet=t.occlusionQuerySet,t.currentOcclusionQueryBuffer=t.occlusionQueryBuffer,t.currentOcclusionQueryObjects=t.occlusionQueryObjects,r=s.createQuerySet({type:"occlusion",count:i,label:`occlusionQuerySet_${e.id}`}),t.occlusionQuerySet=r,t.occlusionQueryIndex=0,t.occlusionQueryObjects=new Array(i),t.lastOcclusionObject=null),n=null===e.textures?this._getDefaultRenderPassDescriptor():this._getRenderPassDescriptor(e,{loadOp:sS}),this.initTimestampQuery(e,n),n.occlusionQuerySet=r;const a=n.depthStencilAttachment;if(null!==e.textures){const t=n.colorAttachments;for(let s=0;s<t.length;s++){const i=t[s];e.clearColor?(i.clearValue=0===s?e.clearColorValue:{r:0,g:0,b:0,a:1},i.loadOp=iS):i.loadOp=sS,i.storeOp=rS}}else{const t=n.colorAttachments[0];e.clearColor?(t.clearValue=e.clearColorValue,t.loadOp=iS):t.loadOp=sS,t.storeOp=rS}e.depth&&(e.clearDepth?(a.depthClearValue=e.clearDepthValue,a.depthLoadOp=iS):a.depthLoadOp=sS,a.depthStoreOp=rS),e.stencil&&(e.clearStencil?(a.stencilClearValue=e.clearStencilValue,a.stencilLoadOp=iS):a.stencilLoadOp=sS,a.stencilStoreOp=rS);const o=s.createCommandEncoder({label:"renderContext_"+e.id});if(!0===this._isRenderCameraDepthArray(e)){const s=e.camera.cameras;t.layerDescriptors&&t.layerDescriptors.length===s.length?this._updateDepthLayerDescriptors(e,t,s):this._createDepthLayerDescriptors(e,t,n,s),t.bundleEncoders=[],t.bundleSets=[];for(let i=0;i<s.length;i++){const s=this.pipelineUtils.createBundleEncoder(e,"renderBundleArrayCamera_"+i),r={attributes:{},bindingGroups:[],pipeline:null,index:null};t.bundleEncoders.push(s),t.bundleSets.push(r)}t.currentPass=null}else{const s=o.beginRenderPass(n);if(t.currentPass=s,e.viewport&&this.updateViewport(e),e.scissor){const{x:t,y:i,width:r,height:n}=e.scissorValue;s.setScissorRect(t,i,r,n)}}t.descriptor=n,t.encoder=o,t.currentSets={attributes:{},bindingGroups:[],pipeline:null,index:null},t.renderBundles=[]}_createDepthLayerDescriptors(e,t,s,i){const r=s.depthStencilAttachment;t.layerDescriptors=[];const n=this.get(e.depthTexture);n.viewCache||(n.viewCache=[]);for(let a=0;a<i.length;a++){const i={...s,colorAttachments:[{...s.colorAttachments[0],view:s.colorAttachments[a].view}]};if(s.depthStencilAttachment){const t=a;n.viewCache[t]||(n.viewCache[t]=n.texture.createView({dimension:Hw,baseArrayLayer:a,arrayLayerCount:1})),i.depthStencilAttachment={view:n.viewCache[t],depthLoadOp:r.depthLoadOp||iS,depthStoreOp:r.depthStoreOp||rS,depthClearValue:r.depthClearValue||1},e.stencil&&(i.depthStencilAttachment.stencilLoadOp=r.stencilLoadOp,i.depthStencilAttachment.stencilStoreOp=r.stencilStoreOp,i.depthStencilAttachment.stencilClearValue=r.stencilClearValue)}else i.depthStencilAttachment={...r};t.layerDescriptors.push(i)}}_updateDepthLayerDescriptors(e,t,s){for(let i=0;i<s.length;i++){const s=t.layerDescriptors[i];if(s.depthStencilAttachment){const t=s.depthStencilAttachment;e.depth&&(e.clearDepth?(t.depthClearValue=e.clearDepthValue,t.depthLoadOp=iS):t.depthLoadOp=sS),e.stencil&&(e.clearStencil?(t.stencilClearValue=e.clearStencilValue,t.stencilLoadOp=iS):t.stencilLoadOp=sS)}}}finishRender(e){const t=this.get(e),s=e.occlusionQueryCount;t.renderBundles.length>0&&t.currentPass.executeBundles(t.renderBundles),s>t.occlusionQueryIndex&&t.currentPass.endOcclusionQuery();const i=t.encoder;if(!0===this._isRenderCameraDepthArray(e)){const s=[];for(let e=0;e<t.bundleEncoders.length;e++){const i=t.bundleEncoders[e];s.push(i.finish())}for(let r=0;r<t.layerDescriptors.length;r++)if(r<s.length){const n=t.layerDescriptors[r],a=i.beginRenderPass(n);if(e.viewport){const{x:t,y:s,width:i,height:r,minDepth:n,maxDepth:o}=e.viewportValue;a.setViewport(t,s,i,r,n,o)}if(e.scissor){const{x:t,y:s,width:i,height:r}=e.scissorValue;a.setScissorRect(t,s,i,r)}a.executeBundles([s[r]]),a.end()}}else t.currentPass&&t.currentPass.end();if(s>0){const i=8*s;let r=this.occludedResolveCache.get(i);void 0===r&&(r=this.device.createBuffer({size:i,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),this.occludedResolveCache.set(i,r));const n=this.device.createBuffer({size:i,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ});t.encoder.resolveQuerySet(t.occlusionQuerySet,0,s,r,0),t.encoder.copyBufferToBuffer(r,0,n,0,i),t.occlusionQueryBuffer=n,this.resolveOccludedAsync(e)}if(this.device.queue.submit([t.encoder.finish()]),null!==e.textures){const t=e.textures;for(let e=0;e<t.length;e++){const s=t[e];!0===s.generateMipmaps&&this.textureUtils.generateMipmaps(s)}}}isOccluded(e,t){const s=this.get(e);return s.occluded&&s.occluded.has(t)}async resolveOccludedAsync(e){const t=this.get(e),{currentOcclusionQueryBuffer:s,currentOcclusionQueryObjects:i}=t;if(s&&i){const e=new WeakSet;t.currentOcclusionQueryObjects=null,t.currentOcclusionQueryBuffer=null,await s.mapAsync(GPUMapMode.READ);const r=s.getMappedRange(),n=new BigUint64Array(r);for(let t=0;t<i.length;t++)n[t]===BigInt(0)&&e.add(i[t]);s.destroy(),t.occluded=e}}updateViewport(e){const{currentPass:t}=this.get(e),{x:s,y:i,width:r,height:n,minDepth:a,maxDepth:o}=e.viewportValue;t.setViewport(s,i,r,n,a,o)}getClearColor(){const e=super.getClearColor();return!0===this.renderer.alpha&&(e.r*=e.a,e.g*=e.a,e.b*=e.a),e}clear(e,t,s,i=null){const r=this.device,n=this.renderer;let a,o,l,h,u=[];if(e){const e=this.getClearColor();o={r:e.r,g:e.g,b:e.b,a:e.a}}if(null===i){l=n.depth,h=n.stencil;const t=this._getDefaultRenderPassDescriptor();if(e){u=t.colorAttachments;const e=u[0];e.clearValue=o,e.loadOp=iS,e.storeOp=rS}(l||h)&&(a=t.depthStencilAttachment)}else{l=i.depth,h=i.stencil;const r={loadOp:e?iS:sS,clearValue:e?o:void 0};l&&(r.depthLoadOp=t?iS:sS,r.depthClearValue=t?n.getClearDepth():void 0,r.depthStoreOp=rS),h&&(r.stencilLoadOp=s?iS:sS,r.stencilClearValue=s?n.getClearStencil():void 0,r.stencilStoreOp=rS);const c=this._getRenderPassDescriptor(i,r);u=c.colorAttachments,a=c.depthStencilAttachment}l&&a&&(t?(a.depthLoadOp=iS,a.depthClearValue=n.getClearDepth(),a.depthStoreOp=rS):(a.depthLoadOp=sS,a.depthStoreOp=rS)),h&&a&&(s?(a.stencilLoadOp=iS,a.stencilClearValue=n.getClearStencil(),a.stencilStoreOp=rS):(a.stencilLoadOp=sS,a.stencilStoreOp=rS));const c=r.createCommandEncoder({label:"clear"});c.beginRenderPass({colorAttachments:u,depthStencilAttachment:a}).end(),r.queue.submit([c.finish()])}beginCompute(e){const t=this.get(e),s={label:"computeGroup_"+e.id};this.initTimestampQuery(e,s),t.cmdEncoderGPU=this.device.createCommandEncoder({label:"computeGroup_"+e.id}),t.passEncoderGPU=t.cmdEncoderGPU.beginComputePass(s)}compute(e,t,s,i,r=null){const n=this.get(t),{passEncoderGPU:a}=this.get(e),o=this.get(i).pipeline;this.pipelineUtils.setPipeline(a,o);for(let e=0,t=s.length;e<t;e++){const t=s[e],i=this.get(t);a.setBindGroup(e,i.group)}let l;if(null===r&&(r=t.count),"number"==typeof r){const e=r;if(void 0===n.dispatchSize||n.count!==e){n.dispatchSize=[0,1,1],n.count=e;const s=t.workgroupSize;let i=s[0];for(let e=1;e<s.length;e++)i*=s[e];const r=Math.ceil(e/i),a=this.device.limits.maxComputeWorkgroupsPerDimension;l=[r,1,1],r>a&&(l[0]=Math.min(r,a),l[1]=Math.ceil(r/a)),n.dispatchSize=l}l=n.dispatchSize}else l=r;a.dispatchWorkgroups(l[0],l[1]||1,l[2]||1)}finishCompute(e){const t=this.get(e);t.passEncoderGPU.end(),this.device.queue.submit([t.cmdEncoderGPU.finish()])}async waitForGPU(){await this.device.queue.onSubmittedWorkDone()}draw(e,t){const{object:s,material:i,context:r,pipeline:n}=e,a=e.getBindings(),o=this.get(r),l=this.get(n).pipeline,h=e.getIndex(),u=null!==h,c=e.getDrawParameters();if(null===c)return;const d=(t,s)=>{this.pipelineUtils.setPipeline(t,l),s.pipeline=l;const n=s.bindingGroups;for(let e=0,s=a.length;e<s;e++){const s=a[e],i=this.get(s);n[s.index]!==s.id&&(t.setBindGroup(s.index,i.group),n[s.index]=s.id)}if(!0===u&&s.index!==h){const e=this.get(h).buffer,i=h.array instanceof Uint16Array?lS:dS;t.setIndexBuffer(e,i),s.index=h}const c=e.getVertexBuffers();for(let e=0,i=c.length;e<i;e++){const i=c[e];if(s.attributes[e]!==i){const r=this.get(i).buffer;t.setVertexBuffer(e,r),s.attributes[e]=i}}!0===r.stencil&&!0===i.stencilWrite&&o.currentStencilRef!==i.stencilRef&&(t.setStencilReference(i.stencilRef),o.currentStencilRef=i.stencilRef)},p=(i,r)=>{if(d(i,r),!0===s.isBatchedMesh){const e=s._multiDrawStarts,r=s._multiDrawCounts,n=s._multiDrawCount,a=s._multiDrawInstances;null!==a&&ls("THREE.WebGPUBackend: renderMultiDrawInstances has been deprecated and will be removed in r184. Append to renderMultiDraw arguments and use indirection.");for(let o=0;o<n;o++){const n=a?a[o]:1,l=n>1?0:o;!0===u?i.drawIndexed(r[o],n,e[o]/h.array.BYTES_PER_ELEMENT,0,l):i.draw(r[o],n,e[o],l),t.update(s,r[o],n)}}else if(!0===u){const{vertexCount:r,instanceCount:n,firstVertex:a}=c,o=e.getIndirect();if(null!==o){const e=this.get(o).buffer;i.drawIndexedIndirect(e,0)}else i.drawIndexed(r,n,a,0,0);t.update(s,r,n)}else{const{vertexCount:r,instanceCount:n,firstVertex:a}=c,o=e.getIndirect();if(null!==o){const e=this.get(o).buffer;i.drawIndirect(e,0)}else i.draw(r,n,a,0);t.update(s,r,n)}};if(e.camera.isArrayCamera&&e.camera.cameras.length>0){const t=this.get(e.camera),i=e.camera.cameras,n=e.getBindingGroup("cameraIndex");if(void 0===t.indexesGPU||t.indexesGPU.length!==i.length){const e=this.get(n),s=[],r=new Uint32Array([0,0,0,0]);for(let t=0,n=i.length;t<n;t++){r[0]=t;const i=this.bindingUtils.createBindGroupIndex(r,e.layout);s.push(i)}t.indexesGPU=s}const a=this.renderer.getPixelRatio();for(let e=0,l=i.length;e<l;e++){const l=i[e];if(s.layers.test(l.layers)){const s=l.viewport;let i=o.currentPass,h=o.currentSets;o.bundleEncoders&&(i=o.bundleEncoders[e],h=o.bundleSets[e]),s&&i.setViewport(Math.floor(s.x*a),Math.floor(s.y*a),Math.floor(s.width*a),Math.floor(s.height*a),r.viewportValue.minDepth,r.viewportValue.maxDepth),n&&t.indexesGPU&&(i.setBindGroup(n.index,t.indexesGPU[e]),h.bindingGroups[n.index]=n.id),p(i,h)}}}else if(o.currentPass){if(void 0!==o.occlusionQuerySet){const e=o.lastOcclusionObject;e!==s&&(null!==e&&!0===e.occlusionTest&&(o.currentPass.endOcclusionQuery(),o.occlusionQueryIndex++),!0===s.occlusionTest&&(o.currentPass.beginOcclusionQuery(o.occlusionQueryIndex),o.occlusionQueryObjects[o.occlusionQueryIndex]=s),o.lastOcclusionObject=s)}p(o.currentPass,o.currentSets)}}needsRenderUpdate(e){const t=this.get(e),{object:s,material:i}=e,r=this.utils,n=r.getSampleCountRenderContext(e.context),a=r.getCurrentColorSpace(e.context),o=r.getCurrentColorFormat(e.context),l=r.getCurrentDepthStencilFormat(e.context),h=r.getPrimitiveTopology(s,i);let u=!1;return t.material===i&&t.materialVersion===i.version&&t.transparent===i.transparent&&t.blending===i.blending&&t.premultipliedAlpha===i.premultipliedAlpha&&t.blendSrc===i.blendSrc&&t.blendDst===i.blendDst&&t.blendEquation===i.blendEquation&&t.blendSrcAlpha===i.blendSrcAlpha&&t.blendDstAlpha===i.blendDstAlpha&&t.blendEquationAlpha===i.blendEquationAlpha&&t.colorWrite===i.colorWrite&&t.depthWrite===i.depthWrite&&t.depthTest===i.depthTest&&t.depthFunc===i.depthFunc&&t.stencilWrite===i.stencilWrite&&t.stencilFunc===i.stencilFunc&&t.stencilFail===i.stencilFail&&t.stencilZFail===i.stencilZFail&&t.stencilZPass===i.stencilZPass&&t.stencilFuncMask===i.stencilFuncMask&&t.stencilWriteMask===i.stencilWriteMask&&t.side===i.side&&t.alphaToCoverage===i.alphaToCoverage&&t.sampleCount===n&&t.colorSpace===a&&t.colorFormat===o&&t.depthStencilFormat===l&&t.primitiveTopology===h&&t.clippingContextCacheKey===e.clippingContextCacheKey||(t.material=i,t.materialVersion=i.version,t.transparent=i.transparent,t.blending=i.blending,t.premultipliedAlpha=i.premultipliedAlpha,t.blendSrc=i.blendSrc,t.blendDst=i.blendDst,t.blendEquation=i.blendEquation,t.blendSrcAlpha=i.blendSrcAlpha,t.blendDstAlpha=i.blendDstAlpha,t.blendEquationAlpha=i.blendEquationAlpha,t.colorWrite=i.colorWrite,t.depthWrite=i.depthWrite,t.depthTest=i.depthTest,t.depthFunc=i.depthFunc,t.stencilWrite=i.stencilWrite,t.stencilFunc=i.stencilFunc,t.stencilFail=i.stencilFail,t.stencilZFail=i.stencilZFail,t.stencilZPass=i.stencilZPass,t.stencilFuncMask=i.stencilFuncMask,t.stencilWriteMask=i.stencilWriteMask,t.side=i.side,t.alphaToCoverage=i.alphaToCoverage,t.sampleCount=n,t.colorSpace=a,t.colorFormat=o,t.depthStencilFormat=l,t.primitiveTopology=h,t.clippingContextCacheKey=e.clippingContextCacheKey,u=!0),u}getRenderCacheKey(e){const{object:t,material:s}=e,i=this.utils,r=e.context;return[s.transparent,s.blending,s.premultipliedAlpha,s.blendSrc,s.blendDst,s.blendEquation,s.blendSrcAlpha,s.blendDstAlpha,s.blendEquationAlpha,s.colorWrite,s.depthWrite,s.depthTest,s.depthFunc,s.stencilWrite,s.stencilFunc,s.stencilFail,s.stencilZFail,s.stencilZPass,s.stencilFuncMask,s.stencilWriteMask,s.side,i.getSampleCountRenderContext(r),i.getCurrentColorSpace(r),i.getCurrentColorFormat(r),i.getCurrentDepthStencilFormat(r),i.getPrimitiveTopology(t,s),e.getGeometryCacheKey(),e.clippingContextCacheKey].join()}createSampler(e){this.textureUtils.createSampler(e)}destroySampler(e){this.textureUtils.destroySampler(e)}createDefaultTexture(e){this.textureUtils.createDefaultTexture(e)}createTexture(e,t){this.textureUtils.createTexture(e,t)}updateTexture(e,t){this.textureUtils.updateTexture(e,t)}generateMipmaps(e){this.textureUtils.generateMipmaps(e)}destroyTexture(e){this.textureUtils.destroyTexture(e)}async copyTextureToBuffer(e,t,s,i,r,n){return this.textureUtils.copyTextureToBuffer(e,t,s,i,r,n)}initTimestampQuery(e,t){if(!this.trackTimestamp)return;const s=e.isComputeNode?"compute":"render";this.timestampQueryPool[s]||(this.timestampQueryPool[s]=new MA(this.device,s,2048));const i=this.timestampQueryPool[s],r=i.allocateQueriesForContext(e);t.timestampWrites={querySet:i.querySet,beginningOfPassWriteIndex:r,endOfPassWriteIndex:r+1}}createNodeBuilder(e,t){return new vA(e,t)}createProgram(e){this.get(e).module={module:this.device.createShaderModule({code:e.code,label:e.stage+(""!==e.name?`_${e.name}`:"")}),entryPoint:"main"}}destroyProgram(e){this.delete(e)}createRenderPipeline(e,t){this.pipelineUtils.createRenderPipeline(e,t)}createComputePipeline(e,t){this.pipelineUtils.createComputePipeline(e,t)}beginBundle(e){const t=this.get(e);t._currentPass=t.currentPass,t._currentSets=t.currentSets,t.currentSets={attributes:{},bindingGroups:[],pipeline:null,index:null},t.currentPass=this.pipelineUtils.createBundleEncoder(e)}finishBundle(e,t){const s=this.get(e),i=s.currentPass.finish();this.get(t).bundleGPU=i,s.currentSets=s._currentSets,s.currentPass=s._currentPass}addBundle(e,t){this.get(e).renderBundles.push(this.get(t).bundleGPU)}createBindings(e,t,s,i){this.bindingUtils.createBindings(e,t,s,i)}updateBindings(e,t,s,i){this.bindingUtils.createBindings(e,t,s,i)}updateBinding(e){this.bindingUtils.updateBinding(e)}createIndexAttribute(e){let t=GPUBufferUsage.INDEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST;(e.isStorageBufferAttribute||e.isStorageInstancedBufferAttribute)&&(t|=GPUBufferUsage.STORAGE),this.attributeUtils.createAttribute(e,t)}createAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}createStorageAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.STORAGE|GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}createIndirectStorageAttribute(e){this.attributeUtils.createAttribute(e,GPUBufferUsage.STORAGE|GPUBufferUsage.INDIRECT|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST)}updateAttribute(e){this.attributeUtils.updateAttribute(e)}destroyAttribute(e){this.attributeUtils.destroyAttribute(e)}updateSize(){this.colorBuffer=this.textureUtils.getColorBuffer(),this.defaultRenderPassdescriptor=null}getMaxAnisotropy(){return 16}hasFeature(e){return this.device.features.has(e)}copyTextureToTexture(e,t,s=null,i=null,r=0,n=0){let a=0,o=0,l=0,h=0,u=0,c=0,d=e.image.width,p=e.image.height,_=1;null!==s&&(!0===s.isBox3?(h=s.min.x,u=s.min.y,c=s.min.z,d=s.max.x-s.min.x,p=s.max.y-s.min.y,_=s.max.z-s.min.z):(h=s.min.x,u=s.min.y,d=s.max.x-s.min.x,p=s.max.y-s.min.y,_=1)),null!==i&&(a=i.x,o=i.y,l=i.z||0);const m=this.device.createCommandEncoder({label:"copyTextureToTexture_"+e.id+"_"+t.id}),f=this.get(e).texture,g=this.get(t).texture;m.copyTextureToTexture({texture:f,mipLevel:r,origin:{x:h,y:u,z:c}},{texture:g,mipLevel:n,origin:{x:a,y:o,z:l}},[d,p,_]),this.device.queue.submit([m.finish()]),0===n&&t.generateMipmaps&&this.textureUtils.generateMipmaps(t)}copyFramebufferToTexture(e,t,s){const i=this.get(t);let r=null;r=t.renderTarget?e.isDepthTexture?this.get(t.depthTexture).texture:this.get(t.textures[0]).texture:e.isDepthTexture?this.textureUtils.getDepthBuffer(t.depth,t.stencil):this.context.getCurrentTexture();const n=this.get(e).texture;if(r.format!==n.format)return void console.error("WebGPUBackend: copyFramebufferToTexture: Source and destination formats do not match.",r.format,n.format);let a;if(i.currentPass?(i.currentPass.end(),a=i.encoder):a=this.device.createCommandEncoder({label:"copyFramebufferToTexture_"+e.id}),a.copyTextureToTexture({texture:r,origin:[s.x,s.y,0]},{texture:n},[s.z,s.w]),i.currentPass){const{descriptor:e}=i;for(let t=0;t<e.colorAttachments.length;t++)e.colorAttachments[t].loadOp=sS;if(t.depth&&(e.depthStencilAttachment.depthLoadOp=sS),t.stencil&&(e.depthStencilAttachment.stencilLoadOp=sS),i.currentPass=a.beginRenderPass(e),i.currentSets={attributes:{},bindingGroups:[],pipeline:null,index:null},t.viewport&&this.updateViewport(t),t.scissor){const{x:e,y:s,width:r,height:n}=t.scissorValue;i.currentPass.setScissorRect(e,s,r,n)}}else this.device.queue.submit([a.finish()]);e.generateMipmaps&&this.textureUtils.generateMipmaps(e)}},BA=class extends Ec{constructor(e,t,s,i,r,n){super(e,t,s,i,r,n),this.iesMap=null}copy(e,t){return super.copy(e,t),this.iesMap=e.iesMap,this}},LA=class extends Ec{constructor(e,t,s,i,r,n){super(e,t,s,i,r,n),this.aspect=null}copy(e,t){return super.copy(e,t),this.aspect=e.aspect,this}},FA=class extends Pv{constructor(){super(),this.addMaterial(Qp,"MeshPhongMaterial"),this.addMaterial(km,"MeshStandardMaterial"),this.addMaterial(zm,"MeshPhysicalMaterial"),this.addMaterial(Xm,"MeshToonMaterial"),this.addMaterial(zp,"MeshBasicMaterial"),this.addMaterial(Kp,"MeshLambertMaterial"),this.addMaterial(Cp,"MeshNormalMaterial"),this.addMaterial(Qm,"MeshMatcapMaterial"),this.addMaterial(xp,"LineBasicMaterial"),this.addMaterial(_p,"LineDashedMaterial"),this.addMaterial(sf,"PointsMaterial"),this.addMaterial(tf,"SpriteMaterial"),this.addMaterial(of,"ShadowMaterial"),this.addLight(NT,Vc),this.addLight(sv,jc),this.addLight(ov,Dc),this.addLight(uv,Ec),this.addLight(hv,Wc),this.addLight(pv,Tc),this.addLight(gv,Hc),this.addLight(lv,BA),this.addLight(cv,LA),this.addToneMapping(Db,Q),this.addToneMapping(Vb,K),this.addToneMapping(Ub,tt),this.addToneMapping(kb,et),this.addToneMapping($b,st),this.addToneMapping(Wb,rt)}},IA=class extends Zv{constructor(e={}){let t;e.forceWebGL?t=zN:(t=PA,e.getFallback=()=>(console.warn("THREE.WebGPURenderer: WebGPU is not available, running under WebGL2 backend."),new zN(e))),super(new t(e),e),this.library=new FA,this.isWebGPURenderer=!0,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}},_changeEvent={type:"change"},_startEvent={type:"start"},_endEvent={type:"end"},_EPS=1e-6,_STATE={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4},_v2=new Gi,_mouseChange=new Gi,_objectUp=new Qi,_pan=new Qi,_axis=new Qi,_quaternion=new $i,_eyeDirection=new Qi,_objectUpDirection=new Qi,_objectSidewaysDirection=new Qi,_moveDirection=new Qi,TrackballControls=class extends Fd{constructor(t,s=null){super(t,s),this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.keys=["KeyA","KeyS","KeyD"],this.mouseButtons={LEFT:e.ROTATE,MIDDLE:e.DOLLY,RIGHT:e.PAN},this.target=new Qi,this.state=_STATE.NONE,this.keyState=_STATE.NONE,this._lastPosition=new Qi,this._lastZoom=1,this._touchZoomDistanceStart=0,this._touchZoomDistanceEnd=0,this._lastAngle=0,this._eye=new Qi,this._movePrev=new Gi,this._moveCurr=new Gi,this._lastAxis=new Qi,this._zoomStart=new Gi,this._zoomEnd=new Gi,this._panStart=new Gi,this._panEnd=new Gi,this._pointers=[],this._pointerPositions={},this._onPointerMove=onPointerMove.bind(this),this._onPointerDown=onPointerDown.bind(this),this._onPointerUp=onPointerUp.bind(this),this._onPointerCancel=onPointerCancel.bind(this),this._onContextMenu=onContextMenu.bind(this),this._onMouseWheel=onMouseWheel.bind(this),this._onKeyDown=onKeyDown.bind(this),this._onKeyUp=onKeyUp.bind(this),this._onTouchStart=onTouchStart.bind(this),this._onTouchMove=onTouchMove.bind(this),this._onTouchEnd=onTouchEnd.bind(this),this._onMouseDown=onMouseDown.bind(this),this._onMouseMove=onMouseMove.bind(this),this._onMouseUp=onMouseUp.bind(this),this._target0=this.target.clone(),this._position0=this.object.position.clone(),this._up0=this.object.up.clone(),this._zoom0=this.object.zoom,null!==s&&(this.connect(s),this.handleResize()),this.update()}connect(e){super.connect(e),window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerCancel),this.domElement.addEventListener("wheel",this._onMouseWheel,{passive:!1}),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.style.touchAction="none"}disconnect(){window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp),this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerCancel),this.domElement.removeEventListener("wheel",this._onMouseWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.domElement.style.touchAction="auto"}dispose(){this.disconnect()}handleResize(){const e=this.domElement.getBoundingClientRect(),t=this.domElement.ownerDocument.documentElement;this.screen.left=e.left+window.pageXOffset-t.clientLeft,this.screen.top=e.top+window.pageYOffset-t.clientTop,this.screen.width=e.width,this.screen.height=e.height}update(){this._eye.subVectors(this.object.position,this.target),this.noRotate||this._rotateCamera(),this.noZoom||this._zoomCamera(),this.noPan||this._panCamera(),this.object.position.addVectors(this.target,this._eye),this.object.isPerspectiveCamera?(this._checkDistances(),this.object.lookAt(this.target),this._lastPosition.distanceToSquared(this.object.position)>_EPS&&(this.dispatchEvent(_changeEvent),this._lastPosition.copy(this.object.position))):this.object.isOrthographicCamera?(this.object.lookAt(this.target),(this._lastPosition.distanceToSquared(this.object.position)>_EPS||this._lastZoom!==this.object.zoom)&&(this.dispatchEvent(_changeEvent),this._lastPosition.copy(this.object.position),this._lastZoom=this.object.zoom)):console.warn("THREE.TrackballControls: Unsupported camera type.")}reset(){this.state=_STATE.NONE,this.keyState=_STATE.NONE,this.target.copy(this._target0),this.object.position.copy(this._position0),this.object.up.copy(this._up0),this.object.zoom=this._zoom0,this.object.updateProjectionMatrix(),this._eye.subVectors(this.object.position,this.target),this.object.lookAt(this.target),this.dispatchEvent(_changeEvent),this._lastPosition.copy(this.object.position),this._lastZoom=this.object.zoom}_panCamera(){if(_mouseChange.copy(this._panEnd).sub(this._panStart),_mouseChange.lengthSq()){if(this.object.isOrthographicCamera){const e=(this.object.right-this.object.left)/this.object.zoom/this.domElement.clientWidth,t=(this.object.top-this.object.bottom)/this.object.zoom/this.domElement.clientWidth;_mouseChange.x*=e,_mouseChange.y*=t}_mouseChange.multiplyScalar(this._eye.length()*this.panSpeed),_pan.copy(this._eye).cross(this.object.up).setLength(_mouseChange.x),_pan.add(_objectUp.copy(this.object.up).setLength(_mouseChange.y)),this.object.position.add(_pan),this.target.add(_pan),this.staticMoving?this._panStart.copy(this._panEnd):this._panStart.add(_mouseChange.subVectors(this._panEnd,this._panStart).multiplyScalar(this.dynamicDampingFactor))}}_rotateCamera(){_moveDirection.set(this._moveCurr.x-this._movePrev.x,this._moveCurr.y-this._movePrev.y,0);let e=_moveDirection.length();e?(this._eye.copy(this.object.position).sub(this.target),_eyeDirection.copy(this._eye).normalize(),_objectUpDirection.copy(this.object.up).normalize(),_objectSidewaysDirection.crossVectors(_objectUpDirection,_eyeDirection).normalize(),_objectUpDirection.setLength(this._moveCurr.y-this._movePrev.y),_objectSidewaysDirection.setLength(this._moveCurr.x-this._movePrev.x),_moveDirection.copy(_objectUpDirection.add(_objectSidewaysDirection)),_axis.crossVectors(_moveDirection,this._eye).normalize(),e*=this.rotateSpeed,_quaternion.setFromAxisAngle(_axis,e),this._eye.applyQuaternion(_quaternion),this.object.up.applyQuaternion(_quaternion),this._lastAxis.copy(_axis),this._lastAngle=e):!this.staticMoving&&this._lastAngle&&(this._lastAngle*=Math.sqrt(1-this.dynamicDampingFactor),this._eye.copy(this.object.position).sub(this.target),_quaternion.setFromAxisAngle(this._lastAxis,this._lastAngle),this._eye.applyQuaternion(_quaternion),this.object.up.applyQuaternion(_quaternion)),this._movePrev.copy(this._moveCurr)}_zoomCamera(){let e;this.state===_STATE.TOUCH_ZOOM_PAN?(e=this._touchZoomDistanceStart/this._touchZoomDistanceEnd,this._touchZoomDistanceStart=this._touchZoomDistanceEnd,this.object.isPerspectiveCamera?this._eye.multiplyScalar(e):this.object.isOrthographicCamera?(this.object.zoom=Zi.clamp(this.object.zoom/e,this.minZoom,this.maxZoom),this._lastZoom!==this.object.zoom&&this.object.updateProjectionMatrix()):console.warn("THREE.TrackballControls: Unsupported camera type")):(e=1+(this._zoomEnd.y-this._zoomStart.y)*this.zoomSpeed,1!==e&&e>0&&(this.object.isPerspectiveCamera?this._eye.multiplyScalar(e):this.object.isOrthographicCamera?(this.object.zoom=Zi.clamp(this.object.zoom/e,this.minZoom,this.maxZoom),this._lastZoom!==this.object.zoom&&this.object.updateProjectionMatrix()):console.warn("THREE.TrackballControls: Unsupported camera type")),this.staticMoving?this._zoomStart.copy(this._zoomEnd):this._zoomStart.y+=(this._zoomEnd.y-this._zoomStart.y)*this.dynamicDampingFactor)}_getMouseOnScreen(e,t){return _v2.set((e-this.screen.left)/this.screen.width,(t-this.screen.top)/this.screen.height),_v2}_getMouseOnCircle(e,t){return _v2.set((e-.5*this.screen.width-this.screen.left)/(.5*this.screen.width),(this.screen.height+2*(this.screen.top-t))/this.screen.width),_v2}_addPointer(e){this._pointers.push(e)}_removePointer(e){delete this._pointerPositions[e.pointerId];for(let t=0;t<this._pointers.length;t++)if(this._pointers[t].pointerId==e.pointerId)return void this._pointers.splice(t,1)}_trackPointer(e){let t=this._pointerPositions[e.pointerId];void 0===t&&(t=new Gi,this._pointerPositions[e.pointerId]=t),t.set(e.pageX,e.pageY)}_getSecondPointerPosition(e){const t=e.pointerId===this._pointers[0].pointerId?this._pointers[1]:this._pointers[0];return this._pointerPositions[t.pointerId]}_checkDistances(){this.noZoom&&this.noPan||(this._eye.lengthSq()>this.maxDistance*this.maxDistance&&(this.object.position.addVectors(this.target,this._eye.setLength(this.maxDistance)),this._zoomStart.copy(this._zoomEnd)),this._eye.lengthSq()<this.minDistance*this.minDistance&&(this.object.position.addVectors(this.target,this._eye.setLength(this.minDistance)),this._zoomStart.copy(this._zoomEnd)))}};function onPointerDown(e){!1!==this.enabled&&(0===this._pointers.length&&(this.domElement.setPointerCapture(e.pointerId),this.domElement.addEventListener("pointermove",this._onPointerMove),this.domElement.addEventListener("pointerup",this._onPointerUp)),this._addPointer(e),"touch"===e.pointerType?this._onTouchStart(e):this._onMouseDown(e))}function onPointerMove(e){!1!==this.enabled&&("touch"===e.pointerType?this._onTouchMove(e):this._onMouseMove(e))}function onPointerUp(e){!1!==this.enabled&&("touch"===e.pointerType?this._onTouchEnd(e):this._onMouseUp(),this._removePointer(e),0===this._pointers.length&&(this.domElement.releasePointerCapture(e.pointerId),this.domElement.removeEventListener("pointermove",this._onPointerMove),this.domElement.removeEventListener("pointerup",this._onPointerUp)))}function onPointerCancel(e){this._removePointer(e)}function onKeyUp(){!1!==this.enabled&&(this.keyState=_STATE.NONE,window.addEventListener("keydown",this._onKeyDown))}function onKeyDown(e){!1!==this.enabled&&(window.removeEventListener("keydown",this._onKeyDown),this.keyState===_STATE.NONE&&(e.code!==this.keys[_STATE.ROTATE]||this.noRotate?e.code!==this.keys[_STATE.ZOOM]||this.noZoom?e.code!==this.keys[_STATE.PAN]||this.noPan||(this.keyState=_STATE.PAN):this.keyState=_STATE.ZOOM:this.keyState=_STATE.ROTATE))}function onMouseDown(t){let s;switch(t.button){case 0:s=this.mouseButtons.LEFT;break;case 1:s=this.mouseButtons.MIDDLE;break;case 2:s=this.mouseButtons.RIGHT;break;default:s=-1}switch(s){case e.DOLLY:this.state=_STATE.ZOOM;break;case e.ROTATE:this.state=_STATE.ROTATE;break;case e.PAN:this.state=_STATE.PAN;break;default:this.state=_STATE.NONE}const i=this.keyState!==_STATE.NONE?this.keyState:this.state;i!==_STATE.ROTATE||this.noRotate?i!==_STATE.ZOOM||this.noZoom?i!==_STATE.PAN||this.noPan||(this._panStart.copy(this._getMouseOnScreen(t.pageX,t.pageY)),this._panEnd.copy(this._panStart)):(this._zoomStart.copy(this._getMouseOnScreen(t.pageX,t.pageY)),this._zoomEnd.copy(this._zoomStart)):(this._moveCurr.copy(this._getMouseOnCircle(t.pageX,t.pageY)),this._movePrev.copy(this._moveCurr)),this.dispatchEvent(_startEvent)}function onMouseMove(e){const t=this.keyState!==_STATE.NONE?this.keyState:this.state;t!==_STATE.ROTATE||this.noRotate?t!==_STATE.ZOOM||this.noZoom?t!==_STATE.PAN||this.noPan||this._panEnd.copy(this._getMouseOnScreen(e.pageX,e.pageY)):this._zoomEnd.copy(this._getMouseOnScreen(e.pageX,e.pageY)):(this._movePrev.copy(this._moveCurr),this._moveCurr.copy(this._getMouseOnCircle(e.pageX,e.pageY)))}function onMouseUp(){this.state=_STATE.NONE,this.dispatchEvent(_endEvent)}function onMouseWheel(e){if(!1!==this.enabled&&!0!==this.noZoom){switch(e.preventDefault(),e.deltaMode){case 2:this._zoomStart.y-=.025*e.deltaY;break;case 1:this._zoomStart.y-=.01*e.deltaY;break;default:this._zoomStart.y-=25e-5*e.deltaY}this.dispatchEvent(_startEvent),this.dispatchEvent(_endEvent)}}function onContextMenu(e){!1!==this.enabled&&e.preventDefault()}function onTouchStart(e){if(this._trackPointer(e),1===this._pointers.length)this.state=_STATE.TOUCH_ROTATE,this._moveCurr.copy(this._getMouseOnCircle(this._pointers[0].pageX,this._pointers[0].pageY)),this._movePrev.copy(this._moveCurr);else{this.state=_STATE.TOUCH_ZOOM_PAN;const e=this._pointers[0].pageX-this._pointers[1].pageX,t=this._pointers[0].pageY-this._pointers[1].pageY;this._touchZoomDistanceEnd=this._touchZoomDistanceStart=Math.sqrt(e*e+t*t);const s=(this._pointers[0].pageX+this._pointers[1].pageX)/2,i=(this._pointers[0].pageY+this._pointers[1].pageY)/2;this._panStart.copy(this._getMouseOnScreen(s,i)),this._panEnd.copy(this._panStart)}this.dispatchEvent(_startEvent)}function onTouchMove(e){if(this._trackPointer(e),1===this._pointers.length)this._movePrev.copy(this._moveCurr),this._moveCurr.copy(this._getMouseOnCircle(e.pageX,e.pageY));else{const t=this._getSecondPointerPosition(e),s=e.pageX-t.x,i=e.pageY-t.y;this._touchZoomDistanceEnd=Math.sqrt(s*s+i*i);const r=(e.pageX+t.x)/2,n=(e.pageY+t.y)/2;this._panEnd.copy(this._getMouseOnScreen(r,n))}}function onTouchEnd(e){switch(this._pointers.length){case 0:this.state=_STATE.NONE;break;case 1:this.state=_STATE.TOUCH_ROTATE,this._moveCurr.copy(this._getMouseOnCircle(e.pageX,e.pageY)),this._movePrev.copy(this._moveCurr);break;case 2:this.state=_STATE.TOUCH_ZOOM_PAN;for(let t=0;t<this._pointers.length;t++)if(this._pointers[t].pointerId!==e.pointerId){const e=this._pointerPositions[this._pointers[t].pointerId];this._moveCurr.copy(this._getMouseOnCircle(e.x,e.y)),this._movePrev.copy(this._moveCurr);break}}this.dispatchEvent(_endEvent)}var RoomEnvironment=class extends ha{constructor(){super();const e=new Dn;e.deleteAttribute("uv");const t=new Ol({side:d2}),s=new Ol,i=new Vc(16777215,900,28,2);i.position.set(.418,16.199,.3),this.add(i);const r=new jn(e,t);r.position.set(-.757,13.219,.717),r.scale.set(31.713,28.305,28.591),this.add(r);const n=new to(e,s,6),a=new Er;a.position.set(-10.906,2.009,1.846),a.rotation.set(0,-.195,0),a.scale.set(2.328,7.905,4.651),a.updateMatrix(),n.setMatrixAt(0,a.matrix),a.position.set(-5.607,-.754,-.758),a.rotation.set(0,.994,0),a.scale.set(1.97,1.534,3.955),a.updateMatrix(),n.setMatrixAt(1,a.matrix),a.position.set(6.167,.857,7.803),a.rotation.set(0,.561,0),a.scale.set(3.927,6.285,3.687),a.updateMatrix(),n.setMatrixAt(2,a.matrix),a.position.set(-2.017,.018,6.124),a.rotation.set(0,.333,0),a.scale.set(2.002,4.566,2.064),a.updateMatrix(),n.setMatrixAt(3,a.matrix),a.position.set(2.291,-.756,-2.621),a.rotation.set(0,-.286,0),a.scale.set(1.546,1.552,1.496),a.updateMatrix(),n.setMatrixAt(4,a.matrix),a.position.set(-2.193,-.369,-5.547),a.rotation.set(0,.516,0),a.scale.set(3.875,3.487,2.986),a.updateMatrix(),n.setMatrixAt(5,a.matrix),this.add(n);const o=new jn(e,createAreaLightMaterial(50));o.position.set(-16.116,14.37,8.208),o.scale.set(.1,2.428,2.739),this.add(o);const l=new jn(e,createAreaLightMaterial(50));l.position.set(-16.109,18.021,-8.207),l.scale.set(.1,2.425,2.751),this.add(l);const h=new jn(e,createAreaLightMaterial(17));h.position.set(14.904,12.198,-1.832),h.scale.set(.15,4.265,6.331),this.add(h);const u=new jn(e,createAreaLightMaterial(43));u.position.set(-.462,8.89,14.52),u.scale.set(4.38,5.441,.088),this.add(u);const c=new jn(e,createAreaLightMaterial(20));c.position.set(3.235,11.486,-12.541),c.scale.set(2.5,2,.1),this.add(c);const d=new jn(e,createAreaLightMaterial(100));d.position.set(0,20,0),d.scale.set(1,.1,1),this.add(d)}dispose(){const e=new Set;this.traverse(t=>{t.isMesh&&(e.add(t.geometry),e.add(t.material))});for(const t of e)t.dispose()}};function createAreaLightMaterial(e){const t=new en;return t.color.setScalar(e),t}function toTrianglesDrawMode(e,t){if(t===Fe)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t===je||t===Le){let s=e.getIndex();if(null===s){const t=[],i=e.getAttribute("position");if(void 0===i)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<i.count;e++)t.push(e);e.setIndex(t),s=e.getIndex()}const i=s.count-2,r=[];if(t===je)for(let e=1;e<=i;e++)r.push(s.getX(0)),r.push(s.getX(e)),r.push(s.getX(e+1));else for(let e=0;e<i;e++)e%2==0?(r.push(s.getX(e)),r.push(s.getX(e+1)),r.push(s.getX(e+2))):(r.push(s.getX(e+2)),r.push(s.getX(e+1)),r.push(s.getX(e)));r.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const n=e.clone();return n.setIndex(r),n.clearGroups(),n}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e}var GLTFLoader=class extends mc{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(e){return new GLTFMaterialsClearcoatExtension(e)}),this.register(function(e){return new GLTFMaterialsDispersionExtension(e)}),this.register(function(e){return new GLTFTextureBasisUExtension(e)}),this.register(function(e){return new GLTFTextureWebPExtension(e)}),this.register(function(e){return new GLTFTextureAVIFExtension(e)}),this.register(function(e){return new GLTFMaterialsSheenExtension(e)}),this.register(function(e){return new GLTFMaterialsTransmissionExtension(e)}),this.register(function(e){return new GLTFMaterialsVolumeExtension(e)}),this.register(function(e){return new GLTFMaterialsIorExtension(e)}),this.register(function(e){return new GLTFMaterialsEmissiveStrengthExtension(e)}),this.register(function(e){return new GLTFMaterialsSpecularExtension(e)}),this.register(function(e){return new GLTFMaterialsIridescenceExtension(e)}),this.register(function(e){return new GLTFMaterialsAnisotropyExtension(e)}),this.register(function(e){return new GLTFMaterialsBumpExtension(e)}),this.register(function(e){return new GLTFLightsExtension(e)}),this.register(function(e){return new GLTFMeshoptCompression(e)}),this.register(function(e){return new GLTFMeshGpuInstancing(e)})}load(e,t,s,i){const r=this;let n;if(""!==this.resourcePath)n=this.resourcePath;else if(""!==this.path){const t=Jc.extractUrlBase(e);n=Jc.resolveURL(t,this.path)}else n=Jc.extractUrlBase(e);this.manager.itemStart(e);const a=function(t){i?i(t):console.error(t),r.manager.itemError(e),r.manager.itemEnd(e)},o=new fc(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,function(s){try{r.parse(s,n,function(s){t(s),r.manager.itemEnd(e)},a)}catch(e){a(e)}},s,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,i){let r;const n={},a={},o=new TextDecoder;if("string"==typeof e)r=JSON.parse(e);else if(e instanceof ArrayBuffer){if(o.decode(new Uint8Array(e,0,4))===BINARY_EXTENSION_HEADER_MAGIC){try{n[EXTENSIONS.KHR_BINARY_GLTF]=new GLTFBinaryExtension(e)}catch(e){return void(i&&i(e))}r=JSON.parse(n[EXTENSIONS.KHR_BINARY_GLTF].content)}else r=JSON.parse(o.decode(e))}else r=e;if(void 0===r.asset||r.asset.version[0]<2)return void(i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new GLTFParser(r,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](l);t.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),a[t.name]=t,n[t.name]=!0}if(r.extensionsUsed)for(let e=0;e<r.extensionsUsed.length;++e){const t=r.extensionsUsed[e],s=r.extensionsRequired||[];switch(t){case EXTENSIONS.KHR_MATERIALS_UNLIT:n[t]=new GLTFMaterialsUnlitExtension;break;case EXTENSIONS.KHR_DRACO_MESH_COMPRESSION:n[t]=new GLTFDracoMeshCompressionExtension(r,this.dracoLoader);break;case EXTENSIONS.KHR_TEXTURE_TRANSFORM:n[t]=new GLTFTextureTransformExtension;break;case EXTENSIONS.KHR_MESH_QUANTIZATION:n[t]=new GLTFMeshQuantizationExtension;break;default:s.indexOf(t)>=0&&void 0===a[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}l.setExtensions(n),l.setPlugins(a),l.parse(s,i)}parseAsync(e,t){const s=this;return new Promise(function(i,r){s.parse(e,t,i,r)})}};function GLTFRegistry(){let e={};return{get:function(t){return e[t]},add:function(t,s){e[t]=s},remove:function(t){delete e[t]},removeAll:function(){e={}}}}var EXTENSIONS={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"},GLTFLightsExtension=class{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,i=t.length;s<i;s++){const i=t[s];i.extensions&&i.extensions[this.name]&&void 0!==i.extensions[this.name].light&&e._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let i=t.cache.get(s);if(i)return i;const r=t.json,n=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e];let a;const o=new $r(16777215);void 0!==n.color&&o.setRGB(n.color[0],n.color[1],n.color[2],Ze);const l=void 0!==n.range?n.range:0;switch(n.type){case"directional":a=new jc(o),a.target.position.set(0,0,-1),a.add(a.target);break;case"point":a=new Vc(o),a.distance=l;break;case"spot":a=new Ec(o),a.distance=l,n.spot=n.spot||{},n.spot.innerConeAngle=void 0!==n.spot.innerConeAngle?n.spot.innerConeAngle:0,n.spot.outerConeAngle=void 0!==n.spot.outerConeAngle?n.spot.outerConeAngle:Math.PI/4,a.angle=n.spot.outerConeAngle,a.penumbra=1-n.spot.innerConeAngle/n.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+n.type)}return a.position.set(0,0,0),assignExtrasToUserData(a,n),void 0!==n.intensity&&(a.intensity=n.intensity),a.name=t.createUniqueName(n.name||"light_"+e),i=Promise.resolve(a),t.cache.add(s,i),i}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,s=this.parser,i=s.json.nodes[e],r=(i.extensions&&i.extensions[this.name]||{}).light;return void 0===r?null:this._loadLight(r).then(function(e){return s._getNodeRef(t.cache,r,e)})}},GLTFMaterialsUnlitExtension=class{constructor(){this.name=EXTENSIONS.KHR_MATERIALS_UNLIT}getMaterialType(){return en}extendParams(e,t,s){const i=[];e.color=new $r(1,1,1),e.opacity=1;const r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const t=r.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],Ze),e.opacity=t[3]}void 0!==r.baseColorTexture&&i.push(s.assignTexture(e,"map",r.baseColorTexture,Ye))}return Promise.all(i)}},GLTFMaterialsEmissiveStrengthExtension=class{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name].emissiveStrength;return void 0!==i&&(t.emissiveIntensity=i),Promise.resolve()}},GLTFMaterialsClearcoatExtension=class{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Nl:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];if(void 0!==n.clearcoatFactor&&(t.clearcoat=n.clearcoatFactor),void 0!==n.clearcoatTexture&&r.push(s.assignTexture(t,"clearcoatMap",n.clearcoatTexture)),void 0!==n.clearcoatRoughnessFactor&&(t.clearcoatRoughness=n.clearcoatRoughnessFactor),void 0!==n.clearcoatRoughnessTexture&&r.push(s.assignTexture(t,"clearcoatRoughnessMap",n.clearcoatRoughnessTexture)),void 0!==n.clearcoatNormalTexture&&(r.push(s.assignTexture(t,"clearcoatNormalMap",n.clearcoatNormalTexture)),void 0!==n.clearcoatNormalTexture.scale)){const e=n.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new Gi(e,e)}return Promise.all(r)}},GLTFMaterialsDispersionExtension=class{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_DISPERSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Nl:null}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name];return t.dispersion=void 0!==i.dispersion?i.dispersion:0,Promise.resolve()}},GLTFMaterialsIridescenceExtension=class{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Nl:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];return void 0!==n.iridescenceFactor&&(t.iridescence=n.iridescenceFactor),void 0!==n.iridescenceTexture&&r.push(s.assignTexture(t,"iridescenceMap",n.iridescenceTexture)),void 0!==n.iridescenceIor&&(t.iridescenceIOR=n.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==n.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=n.iridescenceThicknessMinimum),void 0!==n.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=n.iridescenceThicknessMaximum),void 0!==n.iridescenceThicknessTexture&&r.push(s.assignTexture(t,"iridescenceThicknessMap",n.iridescenceThicknessTexture)),Promise.all(r)}},GLTFMaterialsSheenExtension=class{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Nl:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[];t.sheenColor=new $r(0,0,0),t.sheenRoughness=0,t.sheen=1;const n=i.extensions[this.name];if(void 0!==n.sheenColorFactor){const e=n.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],Ze)}return void 0!==n.sheenRoughnessFactor&&(t.sheenRoughness=n.sheenRoughnessFactor),void 0!==n.sheenColorTexture&&r.push(s.assignTexture(t,"sheenColorMap",n.sheenColorTexture,Ye)),void 0!==n.sheenRoughnessTexture&&r.push(s.assignTexture(t,"sheenRoughnessMap",n.sheenRoughnessTexture)),Promise.all(r)}},GLTFMaterialsTransmissionExtension=class{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Nl:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];return void 0!==n.transmissionFactor&&(t.transmission=n.transmissionFactor),void 0!==n.transmissionTexture&&r.push(s.assignTexture(t,"transmissionMap",n.transmissionTexture)),Promise.all(r)}},GLTFMaterialsVolumeExtension=class{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Nl:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];t.thickness=void 0!==n.thicknessFactor?n.thicknessFactor:0,void 0!==n.thicknessTexture&&r.push(s.assignTexture(t,"thicknessMap",n.thicknessTexture)),t.attenuationDistance=n.attenuationDistance||1/0;const a=n.attenuationColor||[1,1,1];return t.attenuationColor=(new $r).setRGB(a[0],a[1],a[2],Ze),Promise.all(r)}},GLTFMaterialsIorExtension=class{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Nl:null}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name];return t.ior=void 0!==i.ior?i.ior:1.5,Promise.resolve()}},GLTFMaterialsSpecularExtension=class{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Nl:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];t.specularIntensity=void 0!==n.specularFactor?n.specularFactor:1,void 0!==n.specularTexture&&r.push(s.assignTexture(t,"specularIntensityMap",n.specularTexture));const a=n.specularColorFactor||[1,1,1];return t.specularColor=(new $r).setRGB(a[0],a[1],a[2],Ze),void 0!==n.specularColorTexture&&r.push(s.assignTexture(t,"specularColorMap",n.specularColorTexture,Ye)),Promise.all(r)}},GLTFMaterialsBumpExtension=class{constructor(e){this.parser=e,this.name=EXTENSIONS.EXT_MATERIALS_BUMP}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Nl:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];return t.bumpScale=void 0!==n.bumpFactor?n.bumpFactor:1,void 0!==n.bumpTexture&&r.push(s.assignTexture(t,"bumpMap",n.bumpTexture)),Promise.all(r)}},GLTFMaterialsAnisotropyExtension=class{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Nl:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],n=i.extensions[this.name];return void 0!==n.anisotropyStrength&&(t.anisotropy=n.anisotropyStrength),void 0!==n.anisotropyRotation&&(t.anisotropyRotation=n.anisotropyRotation),void 0!==n.anisotropyTexture&&r.push(s.assignTexture(t,"anisotropyMap",n.anisotropyTexture)),Promise.all(r)}},GLTFTextureBasisUExtension=class{constructor(e){this.parser=e,this.name=EXTENSIONS.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,i=s.textures[e];if(!i.extensions||!i.extensions[this.name])return null;const r=i.extensions[this.name],n=t.options.ktx2Loader;if(!n){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r.source,n)}},GLTFTextureWebPExtension=class{constructor(e){this.parser=e,this.name=EXTENSIONS.EXT_TEXTURE_WEBP}loadTexture(e){const t=this.name,s=this.parser,i=s.json,r=i.textures[e];if(!r.extensions||!r.extensions[t])return null;const n=r.extensions[t],a=i.images[n.source];let o=s.textureLoader;if(a.uri){const e=s.options.manager.getHandler(a.uri);null!==e&&(o=e)}return s.loadTextureImage(e,n.source,o)}},GLTFTextureAVIFExtension=class{constructor(e){this.parser=e,this.name=EXTENSIONS.EXT_TEXTURE_AVIF}loadTexture(e){const t=this.name,s=this.parser,i=s.json,r=i.textures[e];if(!r.extensions||!r.extensions[t])return null;const n=r.extensions[t],a=i.images[n.source];let o=s.textureLoader;if(a.uri){const e=s.options.manager.getHandler(a.uri);null!==e&&(o=e)}return s.loadTextureImage(e,n.source,o)}},GLTFMeshoptCompression=class{constructor(e){this.name=EXTENSIONS.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const e=s.extensions[this.name],i=this.parser.getDependency("buffer",e.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return i.then(function(t){const s=e.byteOffset||0,i=e.byteLength||0,n=e.count,a=e.byteStride,o=new Uint8Array(t,s,i);return r.decodeGltfBufferAsync?r.decodeGltfBufferAsync(n,a,o,e.mode,e.filter).then(function(e){return e.buffer}):r.ready.then(function(){const t=new ArrayBuffer(n*a);return r.decodeGltfBuffer(new Uint8Array(t),n,a,o,e.mode,e.filter),t})})}return null}},GLTFMeshGpuInstancing=class{constructor(e){this.name=EXTENSIONS.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,s=t.nodes[e];if(!s.extensions||!s.extensions[this.name]||void 0===s.mesh)return null;const i=t.meshes[s.mesh];for(const e of i.primitives)if(e.mode!==WEBGL_CONSTANTS.TRIANGLES&&e.mode!==WEBGL_CONSTANTS.TRIANGLE_STRIP&&e.mode!==WEBGL_CONSTANTS.TRIANGLE_FAN&&void 0!==e.mode)return null;const r=s.extensions[this.name].attributes,n=[],a={};for(const e in r)n.push(this.parser.getDependency("accessor",r[e]).then(t=>(a[e]=t,a[e])));return n.length<1?null:(n.push(this.parser.createNodeMesh(e)),Promise.all(n).then(e=>{const t=e.pop(),s=t.isGroup?t.children:[t],i=e[0].count,r=[];for(const e of s){const t=new nr,s=new Qi,n=new $i,o=new Qi(1,1,1),l=new to(e.geometry,e.material,i);for(let e=0;e<i;e++)a.TRANSLATION&&s.fromBufferAttribute(a.TRANSLATION,e),a.ROTATION&&n.fromBufferAttribute(a.ROTATION,e),a.SCALE&&o.fromBufferAttribute(a.SCALE,e),l.setMatrixAt(e,t.compose(s,n,o));for(const t in a)if("_COLOR_0"===t){const e=a[t];l.instanceColor=new Ja(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,a[t]);Er.prototype.copy.call(l,e),this.parser.assignFinalMaterial(l),r.push(l)}return t.isGroup?(t.clear(),t.add(...r),t):r[0]}))}},BINARY_EXTENSION_HEADER_MAGIC="glTF",BINARY_EXTENSION_HEADER_LENGTH=12,BINARY_EXTENSION_CHUNK_TYPES={JSON:1313821514,BIN:5130562},GLTFBinaryExtension=class{constructor(e){this.name=EXTENSIONS.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,BINARY_EXTENSION_HEADER_LENGTH),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==BINARY_EXTENSION_HEADER_MAGIC)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-BINARY_EXTENSION_HEADER_LENGTH,r=new DataView(e,BINARY_EXTENSION_HEADER_LENGTH);let n=0;for(;n<i;){const t=r.getUint32(n,!0);n+=4;const i=r.getUint32(n,!0);if(n+=4,i===BINARY_EXTENSION_CHUNK_TYPES.JSON){const i=new Uint8Array(e,BINARY_EXTENSION_HEADER_LENGTH+n,t);this.content=s.decode(i)}else if(i===BINARY_EXTENSION_CHUNK_TYPES.BIN){const s=BINARY_EXTENSION_HEADER_LENGTH+n;this.body=e.slice(s,s+t)}n+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}},GLTFDracoMeshCompressionExtension=class{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=EXTENSIONS.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,i=this.dracoLoader,r=e.extensions[this.name].bufferView,n=e.extensions[this.name].attributes,a={},o={},l={};for(const e in n){const t=ATTRIBUTES[e]||e.toLowerCase();a[t]=n[e]}for(const t in e.attributes){const i=ATTRIBUTES[t]||t.toLowerCase();if(void 0!==n[t]){const r=s.accessors[e.attributes[t]],n=WEBGL_COMPONENT_TYPES[r.componentType];l[i]=n.name,o[i]=!0===r.normalized}}return t.getDependency("bufferView",r).then(function(e){return new Promise(function(t,s){i.decodeDracoFile(e,function(e){for(const t in e.attributes){const s=e.attributes[t],i=o[t];void 0!==i&&(s.normalized=i)}t(e)},a,l,Ze,s)})})}},GLTFTextureTransformExtension=class{constructor(){this.name=EXTENSIONS.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}},GLTFMeshQuantizationExtension=class{constructor(){this.name=EXTENSIONS.KHR_MESH_QUANTIZATION}},GLTFCubicSplineInterpolant=class extends $l{constructor(e,t,s,i){super(e,t,s,i)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,i=this.valueSize,r=e*i*3+i;for(let e=0;e!==i;e++)t[e]=s[r+e];return t}interpolate_(e,t,s,i){const r=this.resultBuffer,n=this.sampleValues,a=this.valueSize,o=2*a,l=3*a,h=i-t,u=(s-t)/h,c=u*u,d=c*u,p=e*l,_=p-l,m=-2*d+3*c,f=d-c,g=1-m,y=f-c+u;for(let e=0;e!==a;e++){const t=n[_+e+a],s=n[_+e+o]*h,i=n[p+e+a],l=n[p+e]*h;r[e]=g*t+y*s+m*i+f*l}return r}},_quaternion2=new $i,GLTFCubicSplineQuaternionInterpolant=class extends GLTFCubicSplineInterpolant{interpolate_(e,t,s,i){const r=super.interpolate_(e,t,s,i);return _quaternion2.fromArray(r).normalize().toArray(r),r}},WEBGL_CONSTANTS={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},WEBGL_COMPONENT_TYPES={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},WEBGL_FILTERS={9728:gt,9729:wt,9984:ft,9985:Mt,9986:bt,9987:_t},WEBGL_WRAPPINGS={33071:mt,33648:yt,10497:pt},WEBGL_TYPE_SIZES={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ATTRIBUTES={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},PATH_PROPERTIES={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},INTERPOLATION={CUBICSPLINE:void 0,LINEAR:ke,STEP:Be},ALPHA_MODES={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function createDefaultMaterial(e){return void 0===e.DefaultMaterial&&(e.DefaultMaterial=new Ol({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:u})),e.DefaultMaterial}function addUnknownExtensionsToUserData(e,t,s){for(const i in s.extensions)void 0===e[i]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[i]=s.extensions[i])}function assignExtrasToUserData(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function addMorphTargets(e,t,s){let i=!1,r=!1,n=!1;for(let e=0,s=t.length;e<s;e++){const s=t[e];if(void 0!==s.POSITION&&(i=!0),void 0!==s.NORMAL&&(r=!0),void 0!==s.COLOR_0&&(n=!0),i&&r&&n)break}if(!i&&!r&&!n)return Promise.resolve(e);const a=[],o=[],l=[];for(let h=0,u=t.length;h<u;h++){const u=t[h];if(i){const t=void 0!==u.POSITION?s.getDependency("accessor",u.POSITION):e.attributes.position;a.push(t)}if(r){const t=void 0!==u.NORMAL?s.getDependency("accessor",u.NORMAL):e.attributes.normal;o.push(t)}if(n){const t=void 0!==u.COLOR_0?s.getDependency("accessor",u.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(a),Promise.all(o),Promise.all(l)]).then(function(t){const s=t[0],a=t[1],o=t[2];return i&&(e.morphAttributes.position=s),r&&(e.morphAttributes.normal=a),n&&(e.morphAttributes.color=o),e.morphTargetsRelative=!0,e})}function updateMorphTargets(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let s=0,i=t.weights.length;s<i;s++)e.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){const s=t.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(let t=0,i=s.length;t<i;t++)e.morphTargetDictionary[s[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function createPrimitiveKey(e){let t;const s=e.extensions&&e.extensions[EXTENSIONS.KHR_DRACO_MESH_COMPRESSION];if(t=s?"draco:"+s.bufferView+":"+s.indices+":"+createAttributesKey(s.attributes):e.indices+":"+createAttributesKey(e.attributes)+":"+e.mode,void 0!==e.targets)for(let s=0,i=e.targets.length;s<i;s++)t+=":"+createAttributesKey(e.targets[s]);return t}function createAttributesKey(e){let t="";const s=Object.keys(e).sort();for(let i=0,r=s.length;i<r;i++)t+=s[i]+":"+e[s[i]]+";";return t}function getNormalizedComponentScale(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function getImageURIMimeType(e){return e.search(/\.jpe?g($|\?)/i)>0||0===e.search(/^data\:image\/jpeg/)?"image/jpeg":e.search(/\.webp($|\?)/i)>0||0===e.search(/^data\:image\/webp/)?"image/webp":e.search(/\.ktx2($|\?)/i)>0||0===e.search(/^data\:image\/ktx2/)?"image/ktx2":"image/png"}var _identityMatrix=new nr,GLTFParser=class{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new GLTFRegistry,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,i=-1,r=!1,n=-1;if("undefined"!=typeof navigator){const e=navigator.userAgent;s=!0===/^((?!chrome|android).)*safari/i.test(e);const t=e.match(/Version\/(\d+)/);i=s&&t?parseInt(t[1],10):-1,r=e.indexOf("Firefox")>-1,n=r?e.match(/Firefox\/([0-9]+)\./)[1]:-1}"undefined"==typeof createImageBitmap||s&&i<17||r&&n<98?this.textureLoader=new _c(this.options.manager):this.textureLoader=new tu(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new fc(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,i=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(e){return e._markDefs&&e._markDefs()}),Promise.all(this._invokeAll(function(e){return e.beforeRoot&&e.beforeRoot()})).then(function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])}).then(function(t){const n={scene:t[0][i.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:i.asset,parser:s,userData:{}};return addUnknownExtensionsToUserData(r,n,i),assignExtrasToUserData(n,i),Promise.all(s._invokeAll(function(e){return e.afterRoot&&e.afterRoot(n)})).then(function(){for(const e of n.scenes)e.updateMatrixWorld();e(n)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let s=0,i=t.length;s<i;s++){const i=t[s].joints;for(let t=0,s=i.length;t<s;t++)e[i[t]].isBone=!0}for(let t=0,i=e.length;t<i;t++){const i=e[t];void 0!==i.mesh&&(this._addNodeRef(this.meshCache,i.mesh),void 0!==i.skin&&(s[i.mesh].isSkinnedMesh=!0)),void 0!==i.camera&&this._addNodeRef(this.cameraCache,i.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const i=s.clone(),r=(e,t)=>{const s=this.associations.get(e);null!=s&&this.associations.set(t,s);for(const[s,i]of e.children.entries())r(i,t.children[s])};return r(s,i),i.name+="_instance_"+e.uses[t]++,i}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const i=e(t[s]);if(i)return i}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let i=0;i<t.length;i++){const r=e(t[i]);r&&s.push(r)}return s}getDependency(e,t){const s=e+":"+t;let i=this.cache.get(s);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this._invokeOne(function(e){return e.loadNode&&e.loadNode(t)});break;case"mesh":i=this._invokeOne(function(e){return e.loadMesh&&e.loadMesh(t)});break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne(function(e){return e.loadBufferView&&e.loadBufferView(t)});break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne(function(e){return e.loadMaterial&&e.loadMaterial(t)});break;case"texture":i=this._invokeOne(function(e){return e.loadTexture&&e.loadTexture(t)});break;case"skin":i=this.loadSkin(t);break;case"animation":i=this._invokeOne(function(e){return e.loadAnimation&&e.loadAnimation(t)});break;case"camera":i=this.loadCamera(t);break;default:if(i=this._invokeOne(function(s){return s!=this&&s.getDependency&&s.getDependency(e,t)}),!i)throw new Error("Unknown type: "+e)}this.cache.add(s,i)}return i}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,i=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(i.map(function(t,i){return s.getDependency(e,i)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[EXTENSIONS.KHR_BINARY_GLTF].body);const i=this.options;return new Promise(function(e,r){s.load(Jc.resolveURL(t.uri,i.path),e,void 0,function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(e){const s=t.byteLength||0,i=t.byteOffset||0;return e.slice(i,i+s)})}loadAccessor(e){const t=this,s=this.json,i=this.json.accessors[e];if(void 0===i.bufferView&&void 0===i.sparse){const e=WEBGL_TYPE_SIZES[i.type],t=WEBGL_COMPONENT_TYPES[i.componentType],s=!0===i.normalized,r=new t(i.count*e);return Promise.resolve(new un(r,e,s))}const r=[];return void 0!==i.bufferView?r.push(this.getDependency("bufferView",i.bufferView)):r.push(null),void 0!==i.sparse&&(r.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(r).then(function(e){const r=e[0],n=WEBGL_TYPE_SIZES[i.type],a=WEBGL_COMPONENT_TYPES[i.componentType],o=a.BYTES_PER_ELEMENT,l=o*n,h=i.byteOffset||0,u=void 0!==i.bufferView?s.bufferViews[i.bufferView].byteStride:void 0,c=!0===i.normalized;let d,p;if(u&&u!==l){const e=Math.floor(h/u),s="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+e+":"+i.count;let l=t.cache.get(s);l||(d=new a(r,e*u,i.count*u/o),l=new la(d,u/o),t.cache.add(s,l)),p=new ua(l,n,h%u/o,c)}else d=null===r?new a(i.count*n):new a(r,h,i.count*n),p=new un(d,n,c);if(void 0!==i.sparse){const t=WEBGL_TYPE_SIZES.SCALAR,s=WEBGL_COMPONENT_TYPES[i.sparse.indices.componentType],o=i.sparse.indices.byteOffset||0,l=i.sparse.values.byteOffset||0,h=new s(e[1],o,i.sparse.count*t),u=new a(e[2],l,i.sparse.count*n);null!==r&&(p=new un(p.array.slice(),p.itemSize,p.normalized)),p.normalized=!1;for(let e=0,t=h.length;e<t;e++){const t=h[e];if(p.setX(t,u[e*n]),n>=2&&p.setY(t,u[e*n+1]),n>=3&&p.setZ(t,u[e*n+2]),n>=4&&p.setW(t,u[e*n+3]),n>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}p.normalized=c}return p})}loadTexture(e){const t=this.json,s=this.options,i=t.textures[e].source,r=t.images[i];let n=this.textureLoader;if(r.uri){const e=s.manager.getHandler(r.uri);null!==e&&(n=e)}return this.loadTextureImage(e,i,n)}loadTextureImage(e,t,s){const i=this,r=this.json,n=r.textures[e],a=r.images[t],o=(a.uri||a.bufferView)+":"+n.sampler;if(this.textureCache[o])return this.textureCache[o];const l=this.loadImageSource(t,s).then(function(t){t.flipY=!1,t.name=n.name||a.name||"",""===t.name&&"string"==typeof a.uri&&!1===a.uri.startsWith("data:image/")&&(t.name=a.uri);const s=(r.samplers||{})[n.sampler]||{};return t.magFilter=WEBGL_FILTERS[s.magFilter]||wt,t.minFilter=WEBGL_FILTERS[s.minFilter]||_t,t.wrapS=WEBGL_WRAPPINGS[s.wrapS]||pt,t.wrapT=WEBGL_WRAPPINGS[s.wrapT]||pt,t.generateMipmaps=!t.isCompressedTexture&&t.minFilter!==gt&&t.minFilter!==wt,i.associations.set(t,{textures:e}),t}).catch(function(){return null});return this.textureCache[o]=l,l}loadImageSource(e,t){const s=this,i=this.json,r=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then(e=>e.clone());const n=i.images[e],a=self.URL||self.webkitURL;let o=n.uri||"",l=!1;if(void 0!==n.bufferView)o=s.getDependency("bufferView",n.bufferView).then(function(e){l=!0;const t=new Blob([e],{type:n.mimeType});return o=a.createObjectURL(t),o});else if(void 0===n.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const h=Promise.resolve(o).then(function(e){return new Promise(function(s,i){let n=s;!0===t.isImageBitmapLoader&&(n=function(e){const t=new _s(e);t.needsUpdate=!0,s(t)}),t.load(Jc.resolveURL(e,r.path),n,void 0,i)})}).then(function(e){return!0===l&&a.revokeObjectURL(o),assignExtrasToUserData(e,n),e.userData.mimeType=n.mimeType||getImageURIMimeType(n.uri),e}).catch(function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",o),e});return this.sourceCache[e]=h,h}assignTexture(e,t,s,i){const r=this;return this.getDependency("texture",s.index).then(function(n){if(!n)return null;if(void 0!==s.texCoord&&s.texCoord>0&&((n=n.clone()).channel=s.texCoord),r.extensions[EXTENSIONS.KHR_TEXTURE_TRANSFORM]){const e=void 0!==s.extensions?s.extensions[EXTENSIONS.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=r.associations.get(n);n=r.extensions[EXTENSIONS.KHR_TEXTURE_TRANSFORM].extendTexture(n,e),r.associations.set(n,t)}}return void 0!==i&&(n.colorSpace=i),e[t]=n,n})}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const i=void 0===t.attributes.tangent,r=void 0!==t.attributes.color,n=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new Jo,tn.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,t.sizeAttenuation=!1,this.cache.add(e,t)),s=t}else if(e.isLine){const e="LineBasicMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new Eo,tn.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,this.cache.add(e,t)),s=t}if(i||r||n){let e="ClonedMaterial:"+s.uuid+":";i&&(e+="derivative-tangents:"),r&&(e+="vertex-colors:"),n&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=s.clone(),r&&(t.vertexColors=!0),n&&(t.flatShading=!0),i&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(s))),s=t}e.material=s}getMaterialType(){return Ol}loadMaterial(e){const t=this,s=this.json,i=this.extensions,r=s.materials[e];let n;const a={},o=[];if((r.extensions||{})[EXTENSIONS.KHR_MATERIALS_UNLIT]){const e=i[EXTENSIONS.KHR_MATERIALS_UNLIT];n=e.getMaterialType(),o.push(e.extendParams(a,r,t))}else{const s=r.pbrMetallicRoughness||{};if(a.color=new $r(1,1,1),a.opacity=1,Array.isArray(s.baseColorFactor)){const e=s.baseColorFactor;a.color.setRGB(e[0],e[1],e[2],Ze),a.opacity=e[3]}void 0!==s.baseColorTexture&&o.push(t.assignTexture(a,"map",s.baseColorTexture,Ye)),a.metalness=void 0!==s.metallicFactor?s.metallicFactor:1,a.roughness=void 0!==s.roughnessFactor?s.roughnessFactor:1,void 0!==s.metallicRoughnessTexture&&(o.push(t.assignTexture(a,"metalnessMap",s.metallicRoughnessTexture)),o.push(t.assignTexture(a,"roughnessMap",s.metallicRoughnessTexture))),n=this._invokeOne(function(t){return t.getMaterialType&&t.getMaterialType(e)}),o.push(Promise.all(this._invokeAll(function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,a)})))}!0===r.doubleSided&&(a.side=p);const l=r.alphaMode||ALPHA_MODES.OPAQUE;if(l===ALPHA_MODES.BLEND?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,l===ALPHA_MODES.MASK&&(a.alphaTest=void 0!==r.alphaCutoff?r.alphaCutoff:.5)),void 0!==r.normalTexture&&n!==en&&(o.push(t.assignTexture(a,"normalMap",r.normalTexture)),a.normalScale=new Gi(1,1),void 0!==r.normalTexture.scale)){const e=r.normalTexture.scale;a.normalScale.set(e,e)}if(void 0!==r.occlusionTexture&&n!==en&&(o.push(t.assignTexture(a,"aoMap",r.occlusionTexture)),void 0!==r.occlusionTexture.strength&&(a.aoMapIntensity=r.occlusionTexture.strength)),void 0!==r.emissiveFactor&&n!==en){const e=r.emissiveFactor;a.emissive=(new $r).setRGB(e[0],e[1],e[2],Ze)}return void 0!==r.emissiveTexture&&n!==en&&o.push(t.assignTexture(a,"emissiveMap",r.emissiveTexture,Ye)),Promise.all(o).then(function(){const s=new n(a);return r.name&&(s.name=r.name),assignExtrasToUserData(s,r),t.associations.set(s,{materials:e}),r.extensions&&addUnknownExtensionsToUserData(i,s,r),s})}createUniqueName(e){const t=Bu.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,s=this.extensions,i=this.primitiveCache;function r(e){return s[EXTENSIONS.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(s){return addPrimitiveAttributes(s,e,t)})}const n=[];for(let s=0,a=e.length;s<a;s++){const a=e[s],o=createPrimitiveKey(a),l=i[o];if(l)n.push(l.promise);else{let e;e=a.extensions&&a.extensions[EXTENSIONS.KHR_DRACO_MESH_COMPRESSION]?r(a):addPrimitiveAttributes(new Cn,a,t),i[o]={primitive:a,promise:e},n.push(e)}}return Promise.all(n)}loadMesh(e){const t=this,s=this.json,i=this.extensions,r=s.meshes[e],n=r.primitives,a=[];for(let e=0,t=n.length;e<t;e++){const t=void 0===n[e].material?createDefaultMaterial(this.cache):this.getDependency("material",n[e].material);a.push(t)}return a.push(t.loadGeometries(n)),Promise.all(a).then(function(s){const a=s.slice(0,s.length-1),o=s[s.length-1],l=[];for(let s=0,h=o.length;s<h;s++){const h=o[s],u=n[s];let c;const d=a[s];if(u.mode===WEBGL_CONSTANTS.TRIANGLES||u.mode===WEBGL_CONSTANTS.TRIANGLE_STRIP||u.mode===WEBGL_CONSTANTS.TRIANGLE_FAN||void 0===u.mode)c=!0===r.isSkinnedMesh?new ja(h,d):new jn(h,d),!0===c.isSkinnedMesh&&c.normalizeSkinWeights(),u.mode===WEBGL_CONSTANTS.TRIANGLE_STRIP?c.geometry=toTrianglesDrawMode(c.geometry,Le):u.mode===WEBGL_CONSTANTS.TRIANGLE_FAN&&(c.geometry=toTrianglesDrawMode(c.geometry,je));else if(u.mode===WEBGL_CONSTANTS.LINES)c=new Ho(h,d);else if(u.mode===WEBGL_CONSTANTS.LINE_STRIP)c=new jo(h,d);else if(u.mode===WEBGL_CONSTANTS.LINE_LOOP)c=new qo(h,d);else{if(u.mode!==WEBGL_CONSTANTS.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+u.mode);c=new $o(h,d)}Object.keys(c.geometry.morphAttributes).length>0&&updateMorphTargets(c,r),c.name=t.createUniqueName(r.name||"mesh_"+e),assignExtrasToUserData(c,r),u.extensions&&addUnknownExtensionsToUserData(i,c,u),t.assignFinalMaterial(c),l.push(c)}for(let s=0,i=l.length;s<i;s++)t.associations.set(l[s],{meshes:e,primitives:s});if(1===l.length)return r.extensions&&addUnknownExtensionsToUserData(i,l[0],r),l[0];const h=new sa;r.extensions&&addUnknownExtensionsToUserData(i,h,r),t.associations.set(h,{meshes:e});for(let e=0,t=l.length;e<t;e++)h.add(l[e]);return h})}loadCamera(e){let t;const s=this.json.cameras[e],i=s[s.type];if(i)return"perspective"===s.type?t=new Qn(Zi.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===s.type&&(t=new Fc(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),assignExtrasToUserData(t,s),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const t=this.json.skins[e],s=[];for(let e=0,i=t.joints.length;e<i;e++)s.push(this._loadNodeShallow(t.joints[e]));return void 0!==t.inverseBindMatrices?s.push(this.getDependency("accessor",t.inverseBindMatrices)):s.push(null),Promise.all(s).then(function(e){const s=e.pop(),i=e,r=[],n=[];for(let e=0,a=i.length;e<a;e++){const a=i[e];if(a){r.push(a);const t=new nr;null!==s&&t.fromArray(s.array,16*e),n.push(t)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[e])}return new qa(r,n)})}loadAnimation(e){const t=this.json,s=this,i=t.animations[e],r=i.name?i.name:"animation_"+e,n=[],a=[],o=[],l=[],h=[];for(let e=0,t=i.channels.length;e<t;e++){const t=i.channels[e],s=i.samplers[t.sampler],r=t.target,u=r.node,c=void 0!==i.parameters?i.parameters[s.input]:s.input,d=void 0!==i.parameters?i.parameters[s.output]:s.output;void 0!==r.node&&(n.push(this.getDependency("node",u)),a.push(this.getDependency("accessor",c)),o.push(this.getDependency("accessor",d)),l.push(s),h.push(r))}return Promise.all([Promise.all(n),Promise.all(a),Promise.all(o),Promise.all(l),Promise.all(h)]).then(function(e){const t=e[0],i=e[1],n=e[2],a=e[3],o=e[4],l=[];for(let e=0,r=t.length;e<r;e++){const r=t[e],h=i[e],u=n[e],c=a[e],d=o[e];if(void 0===r)continue;r.updateMatrix&&r.updateMatrix();const p=s._createAnimationTracks(r,h,u,c,d);if(p)for(let e=0;e<p.length;e++)l.push(p[e])}return new lc(r,void 0,l)})}createNodeMesh(e){const t=this.json,s=this,i=t.nodes[e];return void 0===i.mesh?null:s.getDependency("mesh",i.mesh).then(function(e){const t=s._getNodeRef(s.meshCache,i.mesh,e);return void 0!==i.weights&&t.traverse(function(e){if(e.isMesh)for(let t=0,s=i.weights.length;t<s;t++)e.morphTargetInfluences[t]=i.weights[t]}),t})}loadNode(e){const t=this,s=this.json.nodes[e],i=t._loadNodeShallow(e),r=[],n=s.children||[];for(let e=0,s=n.length;e<s;e++)r.push(t.getDependency("node",n[e]));const a=void 0===s.skin?Promise.resolve(null):t.getDependency("skin",s.skin);return Promise.all([i,Promise.all(r),a]).then(function(e){const t=e[0],s=e[1],i=e[2];null!==i&&t.traverse(function(e){e.isSkinnedMesh&&e.bind(i,_identityMatrix)});for(let e=0,i=s.length;e<i;e++)t.add(s[e]);return t})}_loadNodeShallow(e){const t=this.json,s=this.extensions,i=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const r=t.nodes[e],n=r.name?i.createUniqueName(r.name):"",a=[],o=i._invokeOne(function(t){return t.createNodeMesh&&t.createNodeMesh(e)});return o&&a.push(o),void 0!==r.camera&&a.push(i.getDependency("camera",r.camera).then(function(e){return i._getNodeRef(i.cameraCache,r.camera,e)})),i._invokeAll(function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)}).forEach(function(e){a.push(e)}),this.nodeCache[e]=Promise.all(a).then(function(t){let a;if(a=!0===r.isBone?new Wa:t.length>1?new sa:1===t.length?t[0]:new Er,a!==t[0])for(let e=0,s=t.length;e<s;e++)a.add(t[e]);if(r.name&&(a.userData.name=r.name,a.name=n),assignExtrasToUserData(a,r),r.extensions&&addUnknownExtensionsToUserData(s,a,r),void 0!==r.matrix){const e=new nr;e.fromArray(r.matrix),a.applyMatrix4(e)}else void 0!==r.translation&&a.position.fromArray(r.translation),void 0!==r.rotation&&a.quaternion.fromArray(r.rotation),void 0!==r.scale&&a.scale.fromArray(r.scale);if(i.associations.has(a)){if(void 0!==r.mesh&&i.meshCache.refs[r.mesh]>1){const e=i.associations.get(a);i.associations.set(a,{...e})}}else i.associations.set(a,{});return i.associations.get(a).nodes=e,a}),this.nodeCache[e]}loadScene(e){const t=this.extensions,s=this.json.scenes[e],i=this,r=new sa;s.name&&(r.name=i.createUniqueName(s.name)),assignExtrasToUserData(r,s),s.extensions&&addUnknownExtensionsToUserData(t,r,s);const n=s.nodes||[],a=[];for(let e=0,t=n.length;e<t;e++)a.push(i.getDependency("node",n[e]));return Promise.all(a).then(function(e){for(let t=0,s=e.length;t<s;t++)r.add(e[t]);return i.associations=(e=>{const t=new Map;for(const[e,s]of i.associations)(e instanceof tn||e instanceof _s)&&t.set(e,s);return e.traverse(e=>{const s=i.associations.get(e);null!=s&&t.set(e,s)}),t})(r),r})}_createAnimationTracks(e,t,s,i,r){const n=[],a=e.name?e.name:e.uuid,o=[];let l;switch(PATH_PROPERTIES[r.path]===PATH_PROPERTIES.weights?e.traverse(function(e){e.morphTargetInfluences&&o.push(e.name?e.name:e.uuid)}):o.push(a),PATH_PROPERTIES[r.path]){case PATH_PROPERTIES.weights:l=rc;break;case PATH_PROPERTIES.rotation:l=ac;break;case PATH_PROPERTIES.translation:case PATH_PROPERTIES.scale:l=hc;break;default:if(1===s.itemSize)l=rc;else l=hc}const h=void 0!==i.interpolation?INTERPOLATION[i.interpolation]:ke,u=this._getArrayFromAccessor(s);for(let e=0,s=o.length;e<s;e++){const s=new l(o[e]+"."+PATH_PROPERTIES[r.path],t.array,u,h);"CUBICSPLINE"===i.interpolation&&this._createCubicSplineTrackInterpolant(s),n.push(s)}return n}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=getNormalizedComponentScale(t.constructor),s=new Float32Array(t.length);for(let i=0,r=t.length;i<r;i++)s[i]=t[i]*e;t=s}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof ac?GLTFCubicSplineQuaternionInterpolant:GLTFCubicSplineInterpolant)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}};function computeBounds(e,t,s){const i=t.attributes,r=new Es;if(void 0===i.POSITION)return;{const e=s.json.accessors[i.POSITION],t=e.min,n=e.max;if(void 0===t||void 0===n)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(r.set(new Qi(t[0],t[1],t[2]),new Qi(n[0],n[1],n[2])),e.normalized){const t=getNormalizedComponentScale(WEBGL_COMPONENT_TYPES[e.componentType]);r.min.multiplyScalar(t),r.max.multiplyScalar(t)}}const n=t.targets;if(void 0!==n){const e=new Qi,t=new Qi;for(let i=0,r=n.length;i<r;i++){const r=n[i];if(void 0!==r.POSITION){const i=s.json.accessors[r.POSITION],n=i.min,a=i.max;if(void 0!==n&&void 0!==a){if(t.setX(Math.max(Math.abs(n[0]),Math.abs(a[0]))),t.setY(Math.max(Math.abs(n[1]),Math.abs(a[1]))),t.setZ(Math.max(Math.abs(n[2]),Math.abs(a[2]))),i.normalized){const e=getNormalizedComponentScale(WEBGL_COMPONENT_TYPES[i.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}r.expandByVector(e)}e.boundingBox=r;const a=new Gs;r.getCenter(a.center),a.radius=r.min.distanceTo(r.max)/2,e.boundingSphere=a}function addPrimitiveAttributes(e,t,s){const i=t.attributes,r=[];function n(t,i){return s.getDependency("accessor",t).then(function(t){e.setAttribute(i,t)})}for(const t in i){const s=ATTRIBUTES[t]||t.toLowerCase();s in e.attributes||r.push(n(i[t],s))}if(void 0!==t.indices&&!e.index){const i=s.getDependency("accessor",t.indices).then(function(t){e.setIndex(t)});r.push(i)}return ms.workingColorSpace!==Ze&&"COLOR_0"in i&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${ms.workingColorSpace}" not supported.`),assignExtrasToUserData(e,t),computeBounds(e,t,s),Promise.all(r).then(function(){return void 0!==t.targets?addMorphTargets(e,t.targets,s):e})}var threeRenderer=null,threeCamera=null,threeMixer=null,threeControls=null,threeScene=null,raycaster=null,mouse=null,nodeUnderMouse=null,isRotating=!1,pulseClock=new lu,spacing=.1,cubeSize=7,adjustedCubeSize=Math.floor(cubeSize/2),orange=new $r(16753920),red=new $r(16711680),none=new $r(16777215),lightRed=new $r(16764108),runtime=null;runOnStartup(async e=>{(runtime=e).addEventListener("beforeprojectstart",()=>OnBeforeProjectStart(runtime))});var OnBeforeProjectStart=async e=>{await InitThreeJs(e),e.addEventListener("resize",e=>OnResize(e)),e.addEventListener("tick",()=>OnTick(e)),window.addEventListener("pointerdown",pointerDown),e.addEventListener("pointermove",pointerMove),e.addEventListener("keydown",keyDown)},pointerDown=e=>{if(2===e.button){let t=nodeUnderMouse?.parent.parent;t?.userData?.canBeAllocated&&!t?.userData?.isAllocated&&runtime.objects.player.getFirstInstance().instVars.unspentPassivePoints>0?(t.userData.isAllocated=!0,t.userData.canBeAllocated=!1,t.userData.canBeDeallocated=!0,runtime.objects.player.getFirstInstance().instVars.unspentPassivePoints--,runtime.objects.player.getFirstInstance().instVars.allocatedPassivePoints++,runtime.callFunction("manageNodeMods",t.userData.isAllocated,t.userData.Row,t.userData.Column,t.userData.Depth),scanAllNodes(t),pointerMove(e)):t?.userData?.canBeDeallocated&&t?.userData?.isAllocated&&(t.userData.isAllocated=!1,t.userData.canBeAllocated=!0,t.userData.canBeDeallocated=!1,runtime.objects.player.getFirstInstance().instVars.unspentPassivePoints++,runtime.objects.player.getFirstInstance().instVars.allocatedPassivePoints--,runtime.callFunction("manageNodeMods",t.userData.isAllocated,t.userData.Row,t.userData.Column,t.userData.Depth),scanAllNodes(t),pointerMove(e))}},pointerMove=e=>{mouse.x=e.clientX/window.innerWidth*2-1,mouse.y=-e.clientY/window.innerHeight*2+1},keyDown=e=>{const t=runtime.layout.getLayer("passives");let s=null,i=null;if(t?.isVisible){if(e.ctrlKey&&e.key>="1"&&e.key<=cubeSize.toString())s="Row",i=parseInt(e.key)-1;else if(e.altKey&&e.key>="1"&&e.key<=cubeSize.toString())s="Column",i=parseInt(e.key)-1;else if(e.shiftKey&&e.code.startsWith("Digit")){const t=parseInt(e.code.replace("Digit",""));t>=1&&t<=cubeSize&&(s="Depth",i=t-1)}else e.key>="1"&&e.key<=cubeSize.toString()&&(s="Layer",i=parseInt(e.key)-1);s&&null!==i&&threeScene.children.forEach(e=>{if(e.userData[s]===i){const t=`opacitySetVia${s}`;e.userData[t]=!e.userData[t],e.userData.opacitySetViaRow||e.userData.opacitySetViaColumn||e.userData.opacitySetViaDepth||e.userData.opacitySetViaLayer?e.children[0].children[0].material.opacity=0:e.children[0].children[0].material.opacity=1}})}},scanAllNodes=e=>{const t=[],s=[],i=[{Row:1,Column:0,Depth:0},{Row:-1,Column:0,Depth:0},{Row:0,Column:1,Depth:0},{Row:0,Column:-1,Depth:0},{Row:0,Column:0,Depth:1},{Row:0,Column:0,Depth:-1}];threeScene.children.forEach(e=>{if(!e.userData.isAllocated){i.some(t=>void 0!==threeScene.children.find(s=>s.userData.Row===e.userData.Row+t.Row&&s.userData.Column===e.userData.Column+t.Column&&s.userData.Depth===e.userData.Depth+t.Depth&&s.userData.isAllocated))?t.push(e):s.push(e)}});const r=threeScene.children.filter(e=>e.userData.isAllocated);r.forEach(e=>{if("knight"===e.userData.startingPointForClass)return void(e.userData.canBeDeallocated=!1);e.userData.isAllocated=!1;const t=threeScene.children.find(e=>e.userData.isAllocated);let s=!1;if(t){const e=new Set,n=[t];for(;n.length>0;){const t=n.pop();e.has(t.userData.nodeId)||(e.add(t.userData.nodeId),i.forEach(s=>{const i=threeScene.children.find(e=>e.userData.Row===t.userData.Row+s.Row&&e.userData.Column===t.userData.Column+s.Column&&e.userData.Depth===t.userData.Depth+s.Depth&&e.userData.isAllocated);i&&!e.has(i.userData.nodeId)&&n.push(i)}))}s=e.size===r.length-1}else s=!0;e.userData.canBeDeallocated=s,e.userData.isAllocated=!0}),t.forEach(e=>e.userData.canBeAllocated=!0),s.forEach(e=>{e.userData.canBeAllocated=!1})},InitThreeJs=async t=>{const s=t.platformInfo,i=t.getHTMLLayer(0),r=(threeRenderer=new IA({antialias:!0,alpha:!0})).domElement;threeRenderer.setPixelRatio(s.devicePixelRatio),threeRenderer.setSize(s.canvasCssWidth,s.canvasCssHeight),i.appendChild(r);const n=new Em(threeRenderer);threeScene=new ha;const a=console.warn;console.warn=function(e,...t){"string"==typeof e&&e.includes("THREE.PMREMGenerator: .fromScene() called before the backend is initialized")||a.call(console,e,...t)},threeScene.environment=n.fromScene(new RoomEnvironment(threeRenderer),.04).texture,console.warn=a,(threeCamera=new Qn(40,s.canvasCssWidth/s.canvasCssHeight,1,100)).position.set(10,4,16),(threeControls=new TrackballControls(threeCamera,r)).mouseButtons={LEFT:e.ROTATE,MIDDLE:null,RIGHT:null},threeControls.addEventListener("start",()=>{isRotating=!0}),threeControls.addEventListener("end",()=>{mouse.x=window.innerWidth,mouse.y=window.innerHeight,isRotating=!1}),threeControls.target.set(0,0,0),threeControls.update(),threeControls.rotateSpeed=5,raycaster=new Du,mouse=new Gi;const o=new GLTFLoader,l=(await LoadGLTF(o,"node.glb")).scene;let h=0;const u=new Array(cubeSize).fill(null).map((e,t)=>new Array(cubeSize).fill(null).map((e,s)=>new Array(cubeSize).fill(null).map((e,i)=>{const r=h++,n=Math.floor(cubeSize/2);return{nodeId:r,Layer:Math.max(Math.abs(t-n),Math.abs(s-n),Math.abs(i-n)),isAllocated:!1,canBeAllocated:!1,canBeDeallocated:!1,startingPointForClass:null,Row:t,Column:s,Depth:i}}))),c=["knight","rogue","barbarian","paladin","cleric","ranger","wizard","monk"];for(let e=-adjustedCubeSize;e<=adjustedCubeSize;e++)for(let t=-adjustedCubeSize;t<=adjustedCubeSize;t++)for(let s=-adjustedCubeSize;s<=adjustedCubeSize;s++){const i=l.clone();i.children[0].children[0].material=l.children[0].children[0].material.clone(),i.position.set(e+e*spacing,t+t*spacing,s+s*spacing),i.userData=u[e+adjustedCubeSize][t+adjustedCubeSize][s+adjustedCubeSize],Math.abs(e)===adjustedCubeSize&&Math.abs(t)===adjustedCubeSize&&Math.abs(s)===adjustedCubeSize&&(i.userData.startingPointForClass=c.shift()),threeScene.add(i)}document.evaluate("//canvas[@data-engine]",document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue.style.display="none"},LoadGLTF=(e,t)=>new Promise((s,i)=>{e.load(t,s,void 0,i)}),OnResize=e=>{threeCamera.aspect=e.cssWidth/e.cssHeight,threeCamera.updateProjectionMatrix(),threeRenderer.setSize(e.cssWidth,e.cssHeight)},OnTick=e=>{const t=e.layout.getLayer("passives");if(t?.isVisible&&(threeMixer?.update(e.dt),threeControls.update(),threeRenderer.render(threeScene,threeCamera),threeScene.children.forEach(t=>{let s=e?.objects?.player?.getFirstInstance();if(0===s?.instVars.allocatedPassivePoints&&"knight"===t.userData.startingPointForClass&&(t.userData.canBeAllocated=!0,OnTick.cameraSetForZeroPoints||(threeCamera.position.set(-11,-11,-11),OnTick.cameraSetForZeroPoints=!0)),t.userData.isAllocated?t.children[0].children[0].material.color.set(red):t.children[0].children[0].material.color.set(none),t.userData.canBeAllocated&&!t.userData.isAllocated&&1==t.children[0].children[0].material.opacity&&s?.instVars.unspentPassivePoints>0){const e=.5*Math.sin(5*pulseClock.getElapsedTime())+.5;t.children[0].children[0].material.color.lerp(lightRed,e)}}),!isRotating)){raycaster.setFromCamera(mouse,threeCamera),nodeUnderMouse=null,raycaster.intersectObjects(threeScene.children,!0).slice().reverse().forEach(e=>{1==e.object.material.opacity&&(nodeUnderMouse=e.object)}),nodeUnderMouse?.material.color.set(orange);let t=nodeUnderMouse?.parent.parent;const s=e.layout.getLayer("passives");s&&(nodeUnderMouse&&s.isVisible?e.callFunction("Show node tooltip",t.userData.Row,t.userData.Column,t.userData.Depth):e.callFunction("Hide node tooltip"))}},getDefaultsFromPostinstall=()=>{},stringToByteArray$1=function(e){const t=[];let s=0;for(let i=0;i<e.length;i++){let r=e.charCodeAt(i);r<128?t[s++]=r:r<2048?(t[s++]=r>>6|192,t[s++]=63&r|128):55296==(64512&r)&&i+1<e.length&&56320==(64512&e.charCodeAt(i+1))?(r=65536+((1023&r)<<10)+(1023&e.charCodeAt(++i)),t[s++]=r>>18|240,t[s++]=r>>12&63|128,t[s++]=r>>6&63|128,t[s++]=63&r|128):(t[s++]=r>>12|224,t[s++]=r>>6&63|128,t[s++]=63&r|128)}return t},byteArrayToString=function(e){const t=[];let s=0,i=0;for(;s<e.length;){const r=e[s++];if(r<128)t[i++]=String.fromCharCode(r);else if(r>191&&r<224){const n=e[s++];t[i++]=String.fromCharCode((31&r)<<6|63&n)}else if(r>239&&r<365){const n=((7&r)<<18|(63&e[s++])<<12|(63&e[s++])<<6|63&e[s++])-65536;t[i++]=String.fromCharCode(55296+(n>>10)),t[i++]=String.fromCharCode(56320+(1023&n))}else{const n=e[s++],a=e[s++];t[i++]=String.fromCharCode((15&r)<<12|(63&n)<<6|63&a)}}return t.join("")},base64={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(e,t){if(!Array.isArray(e))throw Error("encodeByteArray takes an array as a parameter");this.init_();const s=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,i=[];for(let t=0;t<e.length;t+=3){const r=e[t],n=t+1<e.length,a=n?e[t+1]:0,o=t+2<e.length,l=o?e[t+2]:0,h=r>>2,u=(3&r)<<4|a>>4;let c=(15&a)<<2|l>>6,d=63&l;o||(d=64,n||(c=64)),i.push(s[h],s[u],s[c],s[d])}return i.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(stringToByteArray$1(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):byteArrayToString(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();const s=t?this.charToByteMapWebSafe_:this.charToByteMap_,i=[];for(let t=0;t<e.length;){const r=s[e.charAt(t++)],n=t<e.length?s[e.charAt(t)]:0;++t;const a=t<e.length?s[e.charAt(t)]:64;++t;const o=t<e.length?s[e.charAt(t)]:64;if(++t,null==r||null==n||null==a||null==o)throw new DecodeBase64StringError;const l=r<<2|n>>4;if(i.push(l),64!==a){const e=n<<4&240|a>>2;if(i.push(e),64!==o){const e=a<<6&192|o;i.push(e)}}}return i},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}},DecodeBase64StringError=class extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}},base64Encode=function(e){const t=stringToByteArray$1(e);return base64.encodeByteArray(t,!0)},base64urlEncodeWithoutPadding=function(e){return base64Encode(e).replace(/\./g,"")},base64Decode=function(e){try{return base64.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null};function getGlobal(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to locate global object.")}var getDefaultsFromGlobal=()=>getGlobal().__FIREBASE_DEFAULTS__,getDefaultsFromEnvVariable=()=>{if("undefined"==typeof process||void 0===process.env)return;const e=process.env.__FIREBASE_DEFAULTS__;return e?JSON.parse(e):void 0},getDefaultsFromCookie=()=>{if("undefined"==typeof document)return;let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}const t=e&&base64Decode(e[1]);return t&&JSON.parse(t)},getDefaults=()=>{try{return getDefaultsFromPostinstall()||getDefaultsFromGlobal()||getDefaultsFromEnvVariable()||getDefaultsFromCookie()}catch(e){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`)}},getDefaultAppConfig=()=>{var e;return null===(e=getDefaults())||void 0===e?void 0:e.config},Deferred=class{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}wrapCallback(e){return(t,s)=>{t?this.reject(t):this.resolve(s),"function"==typeof e&&(this.promise.catch(()=>{}),1===e.length?e(t):e(t,s))}}};function isIndexedDBAvailable(){try{return"object"==typeof indexedDB}catch(e){return!1}}function validateIndexedDBOpenable(){return new Promise((e,t)=>{try{let s=!0;const i="validate-browser-context-for-indexeddb-analytics-module",r=self.indexedDB.open(i);r.onsuccess=()=>{r.result.close(),s||self.indexedDB.deleteDatabase(i),e(!0)},r.onupgradeneeded=()=>{s=!1},r.onerror=()=>{var e;t((null===(e=r.error)||void 0===e?void 0:e.message)||"")}}catch(e){t(e)}})}var ERROR_NAME="FirebaseError",FirebaseError=class e extends Error{constructor(t,s,i){super(s),this.code=t,this.customData=i,this.name=ERROR_NAME,Object.setPrototypeOf(this,e.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,ErrorFactory.prototype.create)}},ErrorFactory=class{constructor(e,t,s){this.service=e,this.serviceName=t,this.errors=s}create(e,...t){const s=t[0]||{},i=`${this.service}/${e}`,r=this.errors[e],n=r?replaceTemplate(r,s):"Error",a=`${this.serviceName}: ${n} (${i}).`;return new FirebaseError(i,a,s)}};function replaceTemplate(e,t){return e.replace(PATTERN,(e,s)=>{const i=t[s];return null!=i?String(i):`<${s}?>`})}var PATTERN=/\{\$([^}]+)}/g;function deepEqual(e,t){if(e===t)return!0;const s=Object.keys(e),i=Object.keys(t);for(const r of s){if(!i.includes(r))return!1;const s=e[r],n=t[r];if(isObject(s)&&isObject(n)){if(!deepEqual(s,n))return!1}else if(s!==n)return!1}for(const e of i)if(!s.includes(e))return!1;return!0}function isObject(e){return null!==e&&"object"==typeof e}var Component=class{constructor(e,t,s){this.name=e,this.instanceFactory=t,this.type=s,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}},DEFAULT_ENTRY_NAME$1="[DEFAULT]",Provider=class{constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){const t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){const e=new Deferred;if(this.instancesDeferred.set(t,e),this.isInitialized(t)||this.shouldAutoInitialize())try{const s=this.getOrInitializeService({instanceIdentifier:t});s&&e.resolve(s)}catch(e){}}return this.instancesDeferred.get(t).promise}getImmediate(e){var t;const s=this.normalizeInstanceIdentifier(null==e?void 0:e.identifier),i=null!==(t=null==e?void 0:e.optional)&&void 0!==t&&t;if(!this.isInitialized(s)&&!this.shouldAutoInitialize()){if(i)return null;throw Error(`Service ${this.name} is not available`)}try{return this.getOrInitializeService({instanceIdentifier:s})}catch(e){if(i)return null;throw e}}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,this.shouldAutoInitialize()){if(isComponentEager(e))try{this.getOrInitializeService({instanceIdentifier:DEFAULT_ENTRY_NAME$1})}catch(e){}for(const[e,t]of this.instancesDeferred.entries()){const s=this.normalizeInstanceIdentifier(e);try{const e=this.getOrInitializeService({instanceIdentifier:s});t.resolve(e)}catch(e){}}}}clearInstance(e=DEFAULT_ENTRY_NAME$1){this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){const e=Array.from(this.instances.values());await Promise.all([...e.filter(e=>"INTERNAL"in e).map(e=>e.INTERNAL.delete()),...e.filter(e=>"_delete"in e).map(e=>e._delete())])}isComponentSet(){return null!=this.component}isInitialized(e=DEFAULT_ENTRY_NAME$1){return this.instances.has(e)}getOptions(e=DEFAULT_ENTRY_NAME$1){return this.instancesOptions.get(e)||{}}initialize(e={}){const{options:t={}}=e,s=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(s))throw Error(`${this.name}(${s}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const i=this.getOrInitializeService({instanceIdentifier:s,options:t});for(const[e,t]of this.instancesDeferred.entries()){s===this.normalizeInstanceIdentifier(e)&&t.resolve(i)}return i}onInit(e,t){var s;const i=this.normalizeInstanceIdentifier(t),r=null!==(s=this.onInitCallbacks.get(i))&&void 0!==s?s:new Set;r.add(e),this.onInitCallbacks.set(i,r);const n=this.instances.get(i);return n&&e(n,i),()=>{r.delete(e)}}invokeOnInitCallbacks(e,t){const s=this.onInitCallbacks.get(t);if(s)for(const i of s)try{i(e,t)}catch(e){}}getOrInitializeService({instanceIdentifier:e,options:t={}}){let s=this.instances.get(e);if(!s&&this.component&&(s=this.component.instanceFactory(this.container,{instanceIdentifier:normalizeIdentifierForFactory(e),options:t}),this.instances.set(e,s),this.instancesOptions.set(e,t),this.invokeOnInitCallbacks(s,e),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,e,s)}catch(e){}return s||null}normalizeInstanceIdentifier(e=DEFAULT_ENTRY_NAME$1){return this.component?this.component.multipleInstances?e:DEFAULT_ENTRY_NAME$1:e}shouldAutoInitialize(){return!!this.component&&"EXPLICIT"!==this.component.instantiationMode}};function normalizeIdentifierForFactory(e){return e===DEFAULT_ENTRY_NAME$1?void 0:e}function isComponentEager(e){return"EAGER"===e.instantiationMode}var ComponentContainer=class{constructor(e){this.name=e,this.providers=new Map}addComponent(e){const t=this.getProvider(e.name);if(t.isComponentSet())throw new Error(`Component ${e.name} has already been registered with ${this.name}`);t.setComponent(e)}addOrOverwriteComponent(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);const t=new Provider(e,this);return this.providers.set(e,t),t}getProviders(){return Array.from(this.providers.values())}},instances=[],LogLevel,LogLevel2;LogLevel2=LogLevel||(LogLevel={}),LogLevel2[LogLevel2.DEBUG=0]="DEBUG",LogLevel2[LogLevel2.VERBOSE=1]="VERBOSE",LogLevel2[LogLevel2.INFO=2]="INFO",LogLevel2[LogLevel2.WARN=3]="WARN",LogLevel2[LogLevel2.ERROR=4]="ERROR",LogLevel2[LogLevel2.SILENT=5]="SILENT";var levelStringToEnum={debug:LogLevel.DEBUG,verbose:LogLevel.VERBOSE,info:LogLevel.INFO,warn:LogLevel.WARN,error:LogLevel.ERROR,silent:LogLevel.SILENT},defaultLogLevel=LogLevel.INFO,ConsoleMethod={[LogLevel.DEBUG]:"log",[LogLevel.VERBOSE]:"log",[LogLevel.INFO]:"info",[LogLevel.WARN]:"warn",[LogLevel.ERROR]:"error"},defaultLogHandler=(e,t,...s)=>{if(t<e.logLevel)return;const i=(new Date).toISOString(),r=ConsoleMethod[t];if(!r)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[r](`[${i}]  ${e.name}:`,...s)},Logger=class{constructor(e){this.name=e,this._logLevel=defaultLogLevel,this._logHandler=defaultLogHandler,this._userLogHandler=null,instances.push(this)}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in LogLevel))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?levelStringToEnum[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,LogLevel.DEBUG,...e),this._logHandler(this,LogLevel.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,LogLevel.VERBOSE,...e),this._logHandler(this,LogLevel.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,LogLevel.INFO,...e),this._logHandler(this,LogLevel.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,LogLevel.WARN,...e),this._logHandler(this,LogLevel.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,LogLevel.ERROR,...e),this._logHandler(this,LogLevel.ERROR,...e)}},instanceOfAny=(e,t)=>t.some(t=>e instanceof t),idbProxyableTypes,cursorAdvanceMethods;function getIdbProxyableTypes(){return idbProxyableTypes||(idbProxyableTypes=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function getCursorAdvanceMethods(){return cursorAdvanceMethods||(cursorAdvanceMethods=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var cursorRequestMap=new WeakMap,transactionDoneMap=new WeakMap,transactionStoreNamesMap=new WeakMap,transformCache=new WeakMap,reverseTransformCache=new WeakMap;function promisifyRequest(e){const t=new Promise((t,s)=>{const i=()=>{e.removeEventListener("success",r),e.removeEventListener("error",n)},r=()=>{t(wrap(e.result)),i()},n=()=>{s(e.error),i()};e.addEventListener("success",r),e.addEventListener("error",n)});return t.then(t=>{t instanceof IDBCursor&&cursorRequestMap.set(t,e)}).catch(()=>{}),reverseTransformCache.set(t,e),t}function cacheDonePromiseForTransaction(e){if(transactionDoneMap.has(e))return;const t=new Promise((t,s)=>{const i=()=>{e.removeEventListener("complete",r),e.removeEventListener("error",n),e.removeEventListener("abort",n)},r=()=>{t(),i()},n=()=>{s(e.error||new DOMException("AbortError","AbortError")),i()};e.addEventListener("complete",r),e.addEventListener("error",n),e.addEventListener("abort",n)});transactionDoneMap.set(e,t)}var idbProxyTraps={get(e,t,s){if(e instanceof IDBTransaction){if("done"===t)return transactionDoneMap.get(e);if("objectStoreNames"===t)return e.objectStoreNames||transactionStoreNamesMap.get(e);if("store"===t)return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return wrap(e[t])},set:(e,t,s)=>(e[t]=s,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function replaceTraps(e){idbProxyTraps=e(idbProxyTraps)}function wrapFunction(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?getCursorAdvanceMethods().includes(e)?function(...t){return e.apply(unwrap(this),t),wrap(cursorRequestMap.get(this))}:function(...t){return wrap(e.apply(unwrap(this),t))}:function(t,...s){const i=e.call(unwrap(this),t,...s);return transactionStoreNamesMap.set(i,t.sort?t.sort():[t]),wrap(i)}}function transformCachableValue(e){return"function"==typeof e?wrapFunction(e):(e instanceof IDBTransaction&&cacheDonePromiseForTransaction(e),instanceOfAny(e,getIdbProxyableTypes())?new Proxy(e,idbProxyTraps):e)}function wrap(e){if(e instanceof IDBRequest)return promisifyRequest(e);if(transformCache.has(e))return transformCache.get(e);const t=transformCachableValue(e);return t!==e&&(transformCache.set(e,t),reverseTransformCache.set(t,e)),t}var unwrap=e=>reverseTransformCache.get(e);function openDB(e,t,{blocked:s,upgrade:i,blocking:r,terminated:n}={}){const a=indexedDB.open(e,t),o=wrap(a);return i&&a.addEventListener("upgradeneeded",e=>{i(wrap(a.result),e.oldVersion,e.newVersion,wrap(a.transaction),e)}),s&&a.addEventListener("blocked",e=>s(e.oldVersion,e.newVersion,e)),o.then(e=>{n&&e.addEventListener("close",()=>n()),r&&e.addEventListener("versionchange",e=>r(e.oldVersion,e.newVersion,e))}).catch(()=>{}),o}var readMethods=["get","getKey","getAll","getAllKeys","count"],writeMethods=["put","add","delete","clear"],cachedMethods=new Map;function getMethod(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(cachedMethods.get(t))return cachedMethods.get(t);const s=t.replace(/FromIndex$/,""),i=t!==s,r=writeMethods.includes(s);if(!(s in(i?IDBIndex:IDBObjectStore).prototype)||!r&&!readMethods.includes(s))return;const n=async function(e,...t){const n=this.transaction(e,r?"readwrite":"readonly");let a=n.store;return i&&(a=a.index(t.shift())),(await Promise.all([a[s](...t),r&&n.done]))[0]};return cachedMethods.set(t,n),n}replaceTraps(e=>Object.assign(Object.assign({},e),{get:(t,s,i)=>getMethod(t,s)||e.get(t,s,i),has:(t,s)=>!!getMethod(t,s)||e.has(t,s)}));var PlatformLoggerServiceImpl=class{constructor(e){this.container=e}getPlatformInfoString(){return this.container.getProviders().map(e=>{if(isVersionServiceProvider(e)){const t=e.getImmediate();return`${t.library}/${t.version}`}return null}).filter(e=>e).join(" ")}};function isVersionServiceProvider(e){const t=e.getComponent();return"VERSION"===(null==t?void 0:t.type)}var name$q="https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js",version$1="0.13.2",logger=new Logger("https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js"),name$p="@firebase/app-compat",name$o="@firebase/analytics-compat",name$n="@firebase/analytics",name$m="@firebase/app-check-compat",name$l="@firebase/app-check",name$k="@firebase/auth",name$j="@firebase/auth-compat",name$i="@firebase/database",name$h="@firebase/data-connect",name$g="@firebase/database-compat",name$f="@firebase/functions",name$e="@firebase/functions-compat",name$d="@firebase/installations",name$c="@firebase/installations-compat",name$b="@firebase/messaging",name$a="@firebase/messaging-compat",name$9="@firebase/performance",name$8="@firebase/performance-compat",name$7="@firebase/remote-config",name$6="@firebase/remote-config-compat",name$5="@firebase/storage",name$4="@firebase/storage-compat",name$3="@firebase/firestore",name$2="@firebase/ai",name$1="@firebase/firestore-compat",name$r="firebase",DEFAULT_ENTRY_NAME="[DEFAULT]",PLATFORM_LOG_STRING={[name$q]:"fire-core",[name$p]:"fire-core-compat",[name$n]:"fire-analytics",[name$o]:"fire-analytics-compat",[name$l]:"fire-app-check",[name$m]:"fire-app-check-compat",[name$k]:"fire-auth",[name$j]:"fire-auth-compat",[name$i]:"fire-rtdb",[name$h]:"fire-data-connect",[name$g]:"fire-rtdb-compat",[name$f]:"fire-fn",[name$e]:"fire-fn-compat",[name$d]:"fire-iid",[name$c]:"fire-iid-compat",[name$b]:"fire-fcm",[name$a]:"fire-fcm-compat",[name$9]:"fire-perf",[name$8]:"fire-perf-compat",[name$7]:"fire-rc",[name$6]:"fire-rc-compat",[name$5]:"fire-gcs",[name$4]:"fire-gcs-compat",[name$3]:"fire-fst",[name$1]:"fire-fst-compat",[name$2]:"fire-vertex","fire-js":"fire-js",[name$r]:"fire-js-all"},_apps=new Map,_serverApps=new Map,_components=new Map;function _addComponent(e,t){try{e.container.addComponent(t)}catch(s){logger.debug(`Component ${t.name} failed to register with FirebaseApp ${e.name}`,s)}}function _registerComponent(e){const t=e.name;if(_components.has(t))return logger.debug(`There were multiple attempts to register component ${t}.`),!1;_components.set(t,e);for(const t of _apps.values())_addComponent(t,e);for(const t of _serverApps.values())_addComponent(t,e);return!0}var ERRORS={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},ERROR_FACTORY=new ErrorFactory("app","Firebase",ERRORS),FirebaseAppImpl=class{constructor(e,t,s){this._isDeleted=!1,this._options=Object.assign({},e),this._config=Object.assign({},t),this._name=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled,this._container=s,this.container.addComponent(new Component("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw ERROR_FACTORY.create("app-deleted",{appName:this._name})}};function initializeApp(e,t={}){let s=e;if("object"!=typeof t){t={name:t}}const i=Object.assign({name:DEFAULT_ENTRY_NAME,automaticDataCollectionEnabled:!0},t),r=i.name;if("string"!=typeof r||!r)throw ERROR_FACTORY.create("bad-app-name",{appName:String(r)});if(s||(s=getDefaultAppConfig()),!s)throw ERROR_FACTORY.create("no-options");const n=_apps.get(r);if(n){if(deepEqual(s,n.options)&&deepEqual(i,n.config))return n;throw ERROR_FACTORY.create("duplicate-app",{appName:r})}const a=new ComponentContainer(r);for(const e of _components.values())a.addComponent(e);const o=new FirebaseAppImpl(s,i,a);return _apps.set(r,o),o}function registerVersion(e,t,s){var i;let r=null!==(i=PLATFORM_LOG_STRING[e])&&void 0!==i?i:e;s&&(r+=`-${s}`);const n=r.match(/\s|\//),a=t.match(/\s|\//);if(n||a){const e=[`Unable to register library "${r}" with version "${t}":`];return n&&e.push(`library name "${r}" contains illegal characters (whitespace or "/")`),n&&a&&e.push("and"),a&&e.push(`version name "${t}" contains illegal characters (whitespace or "/")`),void logger.warn(e.join(" "))}_registerComponent(new Component(`${r}-version`,()=>({library:r,version:t}),"VERSION"))}var DB_NAME="firebase-heartbeat-database",DB_VERSION=1,STORE_NAME="firebase-heartbeat-store",dbPromise=null;function getDbPromise(){return dbPromise||(dbPromise=openDB(DB_NAME,DB_VERSION,{upgrade:(e,t)=>{if(0===t)try{e.createObjectStore(STORE_NAME)}catch(e){console.warn(e)}}}).catch(e=>{throw ERROR_FACTORY.create("idb-open",{originalErrorMessage:e.message})})),dbPromise}async function readHeartbeatsFromIndexedDB(e){try{const t=(await getDbPromise()).transaction(STORE_NAME),s=await t.objectStore(STORE_NAME).get(computeKey(e));return await t.done,s}catch(e){if(e instanceof FirebaseError)logger.warn(e.message);else{const t=ERROR_FACTORY.create("idb-get",{originalErrorMessage:null==e?void 0:e.message});logger.warn(t.message)}}}async function writeHeartbeatsToIndexedDB(e,t){try{const s=(await getDbPromise()).transaction(STORE_NAME,"readwrite"),i=s.objectStore(STORE_NAME);await i.put(t,computeKey(e)),await s.done}catch(e){if(e instanceof FirebaseError)logger.warn(e.message);else{const t=ERROR_FACTORY.create("idb-set",{originalErrorMessage:null==e?void 0:e.message});logger.warn(t.message)}}}function computeKey(e){return`${e.name}!${e.options.appId}`}var MAX_HEADER_BYTES=1024,MAX_NUM_STORED_HEARTBEATS=30,HeartbeatServiceImpl=class{constructor(e){this.container=e,this._heartbeatsCache=null;const t=this.container.getProvider("app").getImmediate();this._storage=new HeartbeatStorageImpl(t),this._heartbeatsCachePromise=this._storage.read().then(e=>(this._heartbeatsCache=e,e))}async triggerHeartbeat(){var e,t;try{const s=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),i=getUTCDateString();if(null==(null===(e=this._heartbeatsCache)||void 0===e?void 0:e.heartbeats)&&(this._heartbeatsCache=await this._heartbeatsCachePromise,null==(null===(t=this._heartbeatsCache)||void 0===t?void 0:t.heartbeats)))return;if(this._heartbeatsCache.lastSentHeartbeatDate===i||this._heartbeatsCache.heartbeats.some(e=>e.date===i))return;if(this._heartbeatsCache.heartbeats.push({date:i,agent:s}),this._heartbeatsCache.heartbeats.length>MAX_NUM_STORED_HEARTBEATS){const e=getEarliestHeartbeatIdx(this._heartbeatsCache.heartbeats);this._heartbeatsCache.heartbeats.splice(e,1)}return this._storage.overwrite(this._heartbeatsCache)}catch(e){logger.warn(e)}}async getHeartbeatsHeader(){var e;try{if(null===this._heartbeatsCache&&await this._heartbeatsCachePromise,null==(null===(e=this._heartbeatsCache)||void 0===e?void 0:e.heartbeats)||0===this._heartbeatsCache.heartbeats.length)return"";const t=getUTCDateString(),{heartbeatsToSend:s,unsentEntries:i}=extractHeartbeatsForHeader(this._heartbeatsCache.heartbeats),r=base64urlEncodeWithoutPadding(JSON.stringify({version:2,heartbeats:s}));return this._heartbeatsCache.lastSentHeartbeatDate=t,i.length>0?(this._heartbeatsCache.heartbeats=i,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),r}catch(e){return logger.warn(e),""}}};function getUTCDateString(){return(new Date).toISOString().substring(0,10)}function extractHeartbeatsForHeader(e,t=MAX_HEADER_BYTES){const s=[];let i=e.slice();for(const r of e){const e=s.find(e=>e.agent===r.agent);if(e){if(e.dates.push(r.date),countBytes(s)>t){e.dates.pop();break}}else if(s.push({agent:r.agent,dates:[r.date]}),countBytes(s)>t){s.pop();break}i=i.slice(1)}return{heartbeatsToSend:s,unsentEntries:i}}var HeartbeatStorageImpl=class{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return!!isIndexedDBAvailable()&&validateIndexedDBOpenable().then(()=>!0).catch(()=>!1)}async read(){if(await this._canUseIndexedDBPromise){const e=await readHeartbeatsFromIndexedDB(this.app);return(null==e?void 0:e.heartbeats)?e:{heartbeats:[]}}return{heartbeats:[]}}async overwrite(e){var t;if(await this._canUseIndexedDBPromise){const s=await this.read();return writeHeartbeatsToIndexedDB(this.app,{lastSentHeartbeatDate:null!==(t=e.lastSentHeartbeatDate)&&void 0!==t?t:s.lastSentHeartbeatDate,heartbeats:e.heartbeats})}}async add(e){var t;if(await this._canUseIndexedDBPromise){const s=await this.read();return writeHeartbeatsToIndexedDB(this.app,{lastSentHeartbeatDate:null!==(t=e.lastSentHeartbeatDate)&&void 0!==t?t:s.lastSentHeartbeatDate,heartbeats:[...s.heartbeats,...e.heartbeats]})}}};function countBytes(e){return base64urlEncodeWithoutPadding(JSON.stringify({version:2,heartbeats:e})).length}function getEarliestHeartbeatIdx(e){if(0===e.length)return-1;let t=0,s=e[0].date;for(let i=1;i<e.length;i++)e[i].date<s&&(s=e[i].date,t=i);return t}function registerCoreComponents(e){_registerComponent(new Component("platform-logger",e=>new PlatformLoggerServiceImpl(e),"PRIVATE")),_registerComponent(new Component("heartbeat",e=>new HeartbeatServiceImpl(e),"PRIVATE")),registerVersion(name$q,version$1,e),registerVersion(name$q,version$1,"esm2017"),registerVersion("fire-js","")}registerCoreComponents("");var name="firebase",version="11.10.0";registerVersion(name,version,"cdn");var firebaseConfig={apiKey:"AIzaSyDTMt7UZzgjWD87LS_9dpfAa7-Y2g2-N-E",authDomain:"daggerquest-a791b.firebaseapp.com",databaseURL:"https://daggerquest-a791b-default-rtdb.firebaseio.com",projectId:"daggerquest-a791b",storageBucket:"daggerquest-a791b.firebasestorage.app",messagingSenderId:"101978886912",appId:"1:101978886912:web:684bc49b0bc1788fff19e5"},firebase=initializeApp(firebaseConfig),scriptsInEvents={async Farm_Event2_Act1(e,t){"https://daggerquest.com/"===window.location.href&&(window.parent&&"function"==typeof window.parent.gtag?(window.parent.gtag("event","loaded_into_tutorial",{notsure:"tutorial_start"}),console.log('Google Analytics event sent: loaded_into_tutorial with parameter "notsure"')):console.warn("Could not access gtag on parent window. Same-origin policy might be preventing direct access, or gtag is not loaded."))},async Splashscreen_Event11_Act1(e,t){},async Splashscreen_Event12_Act5(e,t){}};globalThis.C3.JavaScriptInEvents=scriptsInEvents;
/*!
@fileoverview gl-matrix - High performance matrix and vector operations
@author Brandon Jones
@author Colin MacKenzie IV
@version 3.4.1

Copyright (c) 2015-2021, Brandon Jones, Colin MacKenzie IV.

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.

*/
/**
 * @license
 * Copyright 2010-2025 Three.js Authors
 * SPDX-License-Identifier: MIT
 */
/**
 * @license
 * Copyright 2025 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */